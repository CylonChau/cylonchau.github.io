<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>expect使用案例 | Cylon's Collection</title>
<meta name=keywords content="Linux,ssh,expect使用案例"><meta name=description content="什么是Expect Expent是基于tcl的相对简单的一个免费的脚本编程工具语言，用来实现自动和交互任务程序进行通信，无需人的手工干预。比如SSH、FTP等，这些程序正常情况都需要手工与它们进行交互，而使用Expect就可以模拟人手工交互的过程，实现自动的和远程的程序交互，从而达到自动化运维的目的。
Expect程序工作流程 Expect的工作流程可以理解为，spawn启动进程 ==> expect期待关键字 ==> send向进程发送字符 ==> 退出结束。
安装Expect软件 首先，配置好yum安装源，并且确保机器可以上网，然后执行yum install expect -y即可安装Expect软件。
安装完后查看结果：
sh 1 2 $ rpm -qa|grep expect expect-5.44.1.15-5.el6_4.x86_64 先看一个Expect小实例 首先准备3台虚拟机：
sh 1 2 3 4 192.168.252.60 client 192.168.252.62 client 192.168.252.63 client 192.168.252.64 server 再执行下面例子前，我们先手工执行如下命令
sh 1 ssh -p52113 root@192.168.252.64 ifconfig 执行结果：
sh 1 2 $ ssh -p52113 root@192.168.252.64 ifconfig root@192.168.252.64's password: Expect 例子脚本内容：
sh 1 2 3 4 5 6 7 #!/usr/bin/expect spawn ssh -p52113 root@192."><meta name=author content="cylon"><link rel=canonical href=https://www.oomkill.com/2016/07/expect/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://www.oomkill.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.oomkill.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.oomkill.com/favicon-32x32.png><link rel=apple-touch-icon href=https://www.oomkill.com/favicon.ico><link rel=mask-icon href=https://www.oomkill.com/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://www.oomkill.com/2016/07/expect/><noscript><style>#theme-toggle,#top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link crossorigin=anonymous href=/assets/css/pe.min.css rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/pe.min.js></script><link rel=stylesheet href=https://cdn.staticfile.net/font-awesome/6.5.1/css/all.min.css><link rel=stylesheet href=https://cdn.staticfile.net/font-awesome/6.5.1/css/v4-shims.min.css><script id=MathJax-script async src=https://cdn.staticfile.net/mathjax/3.2.2/es5/tex-chtml.js></script><script>MathJax={tex:{displayMath:[["$$","$$"]],inlineMath:[["\\$","\\$"]]}}</script><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><meta name=referrer content="no-referrer-when-downgrade"><meta property="og:title" content="expect使用案例"><meta property="og:description" content="什么是Expect Expent是基于tcl的相对简单的一个免费的脚本编程工具语言，用来实现自动和交互任务程序进行通信，无需人的手工干预。比如SSH、FTP等，这些程序正常情况都需要手工与它们进行交互，而使用Expect就可以模拟人手工交互的过程，实现自动的和远程的程序交互，从而达到自动化运维的目的。
Expect程序工作流程 Expect的工作流程可以理解为，spawn启动进程 ==> expect期待关键字 ==> send向进程发送字符 ==> 退出结束。
安装Expect软件 首先，配置好yum安装源，并且确保机器可以上网，然后执行yum install expect -y即可安装Expect软件。
安装完后查看结果：
sh 1 2 $ rpm -qa|grep expect expect-5.44.1.15-5.el6_4.x86_64 先看一个Expect小实例 首先准备3台虚拟机：
sh 1 2 3 4 192.168.252.60 client 192.168.252.62 client 192.168.252.63 client 192.168.252.64 server 再执行下面例子前，我们先手工执行如下命令
sh 1 ssh -p52113 root@192.168.252.64 ifconfig 执行结果：
sh 1 2 $ ssh -p52113 root@192.168.252.64 ifconfig root@192.168.252.64's password: Expect 例子脚本内容：
sh 1 2 3 4 5 6 7 #!/usr/bin/expect spawn ssh -p52113 root@192."><meta property="og:type" content="article"><meta property="og:url" content="https://www.oomkill.com/2016/07/expect/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2016-07-23T00:00:00+00:00"><meta property="article:modified_time" content="2023-03-22T23:00:36+08:00"><meta property="og:site_name" content="Cylon's Collection"><meta name=twitter:card content="summary"><meta name=twitter:title content="expect使用案例"><meta name=twitter:description content="什么是Expect Expent是基于tcl的相对简单的一个免费的脚本编程工具语言，用来实现自动和交互任务程序进行通信，无需人的手工干预。比如SSH、FTP等，这些程序正常情况都需要手工与它们进行交互，而使用Expect就可以模拟人手工交互的过程，实现自动的和远程的程序交互，从而达到自动化运维的目的。
Expect程序工作流程 Expect的工作流程可以理解为，spawn启动进程 ==> expect期待关键字 ==> send向进程发送字符 ==> 退出结束。
安装Expect软件 首先，配置好yum安装源，并且确保机器可以上网，然后执行yum install expect -y即可安装Expect软件。
安装完后查看结果：
sh 1 2 $ rpm -qa|grep expect expect-5.44.1.15-5.el6_4.x86_64 先看一个Expect小实例 首先准备3台虚拟机：
sh 1 2 3 4 192.168.252.60 client 192.168.252.62 client 192.168.252.63 client 192.168.252.64 server 再执行下面例子前，我们先手工执行如下命令
sh 1 ssh -p52113 root@192.168.252.64 ifconfig 执行结果：
sh 1 2 $ ssh -p52113 root@192.168.252.64 ifconfig root@192.168.252.64's password: Expect 例子脚本内容：
sh 1 2 3 4 5 6 7 #!/usr/bin/expect spawn ssh -p52113 root@192."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://www.oomkill.com/posts/"},{"@type":"ListItem","position":2,"name":"expect使用案例","item":"https://www.oomkill.com/2016/07/expect/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"expect使用案例","name":"expect使用案例","description":"什么是Expect Expent是基于tcl的相对简单的一个免费的脚本编程工具语言，用来实现自动和交互任务程序进行通信，无需人的手工干预。比如SSH、FTP等，这些程序正常情况都需要手工与它们进行交互，而使用Expect就可以模拟人手工交互的过程，实现自动的和远程的程序交互，从而达到自动化运维的目的。\nExpect程序工作流程 Expect的工作流程可以理解为，spawn启动进程 ==\u0026gt; expect期待关键字 ==\u0026gt; send向进程发送字符 ==\u0026gt; 退出结束。\n安装Expect软件 首先，配置好yum安装源，并且确保机器可以上网，然后执行yum install expect -y即可安装Expect软件。\n安装完后查看结果：\nsh 1 2 $ rpm -qa|grep expect expect-5.44.1.15-5.el6_4.x86_64 先看一个Expect小实例 首先准备3台虚拟机：\nsh 1 2 3 4 192.168.252.60 client 192.168.252.62 client 192.168.252.63 client 192.168.252.64 server 再执行下面例子前，我们先手工执行如下命令\nsh 1 ssh -p52113 root@192.168.252.64 ifconfig 执行结果：\nsh 1 2 $ ssh -p52113 root@192.168.252.64 ifconfig root@192.168.252.64\u0026#39;s password: Expect 例子脚本内容：\nsh 1 2 3 4 5 6 7 #!/usr/bin/expect spawn ssh -p52113 root@192.","keywords":["Linux","ssh","expect使用案例"],"articleBody":"什么是Expect Expent是基于tcl的相对简单的一个免费的脚本编程工具语言，用来实现自动和交互任务程序进行通信，无需人的手工干预。比如SSH、FTP等，这些程序正常情况都需要手工与它们进行交互，而使用Expect就可以模拟人手工交互的过程，实现自动的和远程的程序交互，从而达到自动化运维的目的。\nExpect程序工作流程 Expect的工作流程可以理解为，spawn启动进程 ==\u003e expect期待关键字 ==\u003e send向进程发送字符 ==\u003e 退出结束。\n安装Expect软件 首先，配置好yum安装源，并且确保机器可以上网，然后执行yum install expect -y即可安装Expect软件。\n安装完后查看结果：\nsh 1 2 $ rpm -qa|grep expect expect-5.44.1.15-5.el6_4.x86_64 先看一个Expect小实例 首先准备3台虚拟机：\nsh 1 2 3 4 192.168.252.60 client 192.168.252.62 client 192.168.252.63 client 192.168.252.64 server 再执行下面例子前，我们先手工执行如下命令\nsh 1 ssh -p52113 root@192.168.252.64 ifconfig 执行结果：\nsh 1 2 $ ssh -p52113 root@192.168.252.64 ifconfig root@192.168.252.64's password: Expect 例子脚本内容：\nsh 1 2 3 4 5 6 7 #!/usr/bin/expect spawn ssh -p52113 root@192.168.252.62 /sbin/ifconfig eth0 set timeout 60 expect \"*password:\" send \"111111\\n\" expect eof exit 执行结果：问题：\nsh 1 2 3 4 5 6 7 8 9 10 11 $ ./a.exp spawn ssh -p52113 root@192.168.252.62 /sbin/ifconfig eth0 root@192.168.252.62's password: eth0 Link encap:Ethernet HWaddr 00:0C:29:C3:48:CB inet addr:192.168.252.62 Bcast:192.168.252.255 Mask:255.255.255.0 inet6 addr: fe80::20c:29ff:fec3:48cb/64 Scope:Link UP BROADCAST RUNNING MULTICAST MTU:1500 Metric:1 RX packets:3027 errors:0 dropped:0 overruns:0 frame:0 TX packets:1632 errors:0 dropped:0 overruns:0 carrier:0 collisions:0 txqueuelen:1000 RX bytes:268416 (262.1 KiB) TX bytes:175473 (171.3 KiB) 问题：\nsh 1 2 3 4 5 $ ./a.exp ./a.exp: line 8: spawn: command not found couldn't read file \"*password:\": no such file or directory ./a.exp: line 11: send: command not found couldn't read file \"eof\": no such file or directory 原因：\n含有expect的脚本不能用bash执行，bash无法解析。添加可执行权限后，直接./your_script即可 这个代码是expect的代码，不由bash解释。 spawn可以看作expect脚本的内部函数。要第一行改成 #!/usr/bin/expect Expect语法 Expect中的命令是最重要的部分了，命令的使用语法如下：\nsh 1 命令 [选项] 参数 spawn spawn命令是Expect的初始命令，它用于启动一个进程，之后所有expect操作都在这个进程中进行，如果没有spawn语句，整个expect就无法执行了，spawn使用方法如下：\nsh 1 spawn ssh root@192.168.252.62 在spawn命令后面直接加上要启动的进程、命令等信息，除此之外，spawn还支持其他选项如：\n-open\t启动文件进程，具体说明省略。 -ignore\t忽略某些信号，具体说明省略。 expect 使用方法：\nsh 1 expect 表达式 动作 表达式 动作 expect命令用于等候一个相匹配内容的输出，一旦匹配上就执行expect后面的动作或命令。这个命令接受几个特有的参数，用的最多的就是-re，表示使用正则表达式的方式匹配，使用起来就像这样：\nsh 1 2 spawn ssh root@192.168.252.64 expect \"password:\" {send \"111111\\r\"} 从上面的例子可以看出，expect是依附与spawn命令的，当执行ssh命令后，expect就匹配命令执行后的关键字：“password：”，如果匹配到关键字就会执行后面包含在“{}”中的send或exp_send动作，匹配的动作可以放在二行，这样就不需要使用“{}”了，就像下面这样，实际完成的功能与上面是一样的：\nsh 1 2 3 spawn ssh root@192.168.252.64 expect \"password:\" send \"111111\\r\" expect命令还有一种用法，他可以在一个expect匹配中多次匹配关键字，并给出处理动作，只需要将关键字放在一个大括号中就可以了，当然还要有exp_continue。\nsh 1 2 3 4 5 spawn ssh root@192.168.252.64 expect { \"yes/no\"\t{ exp_send \"yes\\r\"; exp_continue } \"*password:\"\t{ exp_send \"111111\\r\" } } exp_send和send 在上面的介绍中，我们已经看到exp_send命令的使用，exp_send命令是expect中的动作命令，它还有一个完成同样工作的同胞：send，exp_send命令可以发送一些特殊符号，我们看到了\\r（回车），还有一些其他的比如：\\n、\\t等等，这些都与TCL中的特殊符号相同。\nsh 1 2 3 4 5 spawn ssh root@192.168.252.64 expect { \"yes/no\"\t{ exp_send \"yes\\r\"; exp_continue } \"*password:\"\t{ exp_send \"111111\\r\" } } send命令有几个可用参数：\n-i 制定spawn_id，这个参数用来向不同spawn_id的进程发送命令，是进行多程序控制的关键参数。 -s s代表slowly，也就是控制发送的速度，这个参数使用的时候要与expect中的变量send_slow相关联。 exp_continue 这个命令一般用在动作中，它被使用的条件比较苛刻，看看下面的例子：\nsh 1 2 3 4 5 6 7 8 9 10 11 #!/usr/bin/expect spawn ssh root@192.168.252.64 /sbin/ifconfig eth0 set timeout 60 expect { -timeout 1 \"yes/no\"\t{ exp_send \"yes\\r\"; exp_continue } \"*password:\"\t{ exp_send \"111111\\r\" } timeout { puts \"expect was timeout by oldboy.\"; return} } expect eof exit 在这个例子中，可以发现exp_continue命令的使用方法，首先它要处于一个expect命令中，然后它属于一种动作命令，完成的工作就是从头开始遍历，也就是说如果没有这个命令，匹配第一个关键字以后就会继续匹配第二个关键字，但有了这个命令后，匹配第一个关键字以后，第二次匹配仍然从第一个关键字开始。\nsend_user send_user命令用来把后面的参数输出到标准输出中去，默认的send、exp_send命令都是将参数输出到程序中去的，用起来就像这样：\nsh 1 send_user \"please input password:\" 这个语句就可以在标准输出中打印Please input password：字符了。\nsh 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 #!/usr/bin/expect if { $argc != 2 } { send_user \"usage: expect scp-expect.exp file host dir\\n\" exit } #define var set file [lindex $argv 0] set host [lindex $argv 1] set password \"111111\" #spawn scp /etc/hosts root@10.0.0.142:/etc/hosts spawn ssh-copy-id -i $file \"-p 52113 root@$host\" expect { \"yes/no\" {send \"yes\\r\";exp_continue} \"*password\" {send \"$password\\r\"} } expect eof exit -onexit { send_user \"Oldboy say good bye to you!\\n\" } #script usage #expect oldboy-6.exp file host dir #example #./oldboy-6.exp /etc/hosts 10.0.0.179 /etc/hosts exit exit命令功能很简单，就是直接退出脚本，但是你可以利用这个命令对脚本做一些扫尾工作，比如下面这样：\nsh 1 2 3 4 exit -onexit { exec rm $tmpfile send_user \"Good bye\\n\" } sh 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 #!/usr/bin/expect if { $argc != 2 } { send_user \"usage: expect scp-expect.exp file host dir\\n\" exit } #define var set file [lindex $argv 0] set host [lindex $argv 1] set password \"111111\" #spawn scp /etc/hosts root@10.0.0.142:/etc/hosts spawn ssh-copy-id -i $file \"-p 52113 root@$host\" expect { \"yes/no\" {send \"yes\\r\";exp_continue} \"*password\" {send \"$password\\r\"} } expect eof exit -onexit { send_user \"Oldboy say good bye to you!\\n\" } #script usage #expect oldboy-6.exp file host dir #example #./oldboy-6.exp /etc/hosts 10.0.0.179 /etc/hosts Except变量 expect中有很多有用的变量，它们使用方法与TCL语言中的变量相同，比如： set 变量名 变量名 # 设置变量的方法 set $变量名 # 读取变量的方法\nsh 1 2 3 4 5 #define var set file [lindex $argv 0] set file [lindex $argv 1] set file [lindex $argv 2] set password \"123456\" Expect关键字 expect中的特殊关键字用于匹配过程，代表某些特殊含义或状态，一般用于expect族命令中不能在外面单独使用，也可以理解为事件，使用上类似于expect eof {}\neof eof (end-of-file)关键字用于匹配 结束符，比如文件的结束符、FTP传输停止等情况，在这个关键字后跟上动作来做进一步的控制，特别是FTP交互操作方面，它的动作很大。用一个例子来看看：\nsh 1 2 3 4 5 6 spawn ftp anonymous@10.11.105.110 expect { \"password:\" {exp_send \"who I’m I\"} eof {ftp connect close} } interact { } timeout timeout是expect中的一个重要变量，它是一个全局性的时间控制开关，你可以通过为这个变量赋值来规定整个expect操作时间，注意这个变量是服务于expect全局的，它不会纠缠于某一条命令，即使命令没有任何错误，到时见仍然会激活这个变量，但这个时间到达以后除了激活一个开关之外不会做其他的事情，如何处理是脚本编写人员的事情，看看它的实际使用方法：\nsh 1 2 3 4 set timeout 60 spawn ssh root@192.168.2.1 expect \"password:\" {send \"word\\r\"} expect timeout { puts \"Expect was timeout\"; return } 上面的处理中，首先将timeout变量设置为60秒，当出现问题的时候程序可能会停止下来，只要到60秒。就会激活下面的timeout动作，这里我们打印一个信息并且停止了脚步的运行–你可以做更多其他的事情，看自己的意思。\n在另一种expect格式中，我们还有一种设置timeout变量的方法，看看下面的例子：\nsh 1 2 3 4 5 6 7 8 9 spawn ssh root@192.168.1.1 expect { -timeout 60 -re \"password:\" {exp_send \"word\\r\"} -re \"TopsecOS#\" { } timeout { puts \"Expect was timeout\"; return } -re \"TopsecOS#\" { } timeout { puts \"Expecr was timeout\"; return } } 生产场景Expect实战 sh 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 $ cat fenfa.exp #!/usr/bin/expect if { $argc != 3 } { send_user \"usage: expect scp-expect.exp file host dir\\n\" exit } #define var set file [lindex $argv 0] set host [lindex $argv 1] set dir [lindex $argv 2] set password \"111111\" spawn scp -P 52113 -p $file root@$host:$dir #spawn ssh-copy-id -i $file \"-p 52113 root@$host\" expect { \"yes/no\" {send \"yes\\r\";exp_continue} \"*password\" {send \"$password\\r\"} } expect eof exit -onexit { send_user \"Oldboy say good bye to you!\\n\" } #script usage #expect oldboy-6.exp file host dir #example #./oldboy-6.exp /etc/hosts 10.0.0.179 /etc/hosts 实战1：使用expect实现批量分发/etc/hosts文件 sh 1 2 3 4 5 6 7 8 9 10 11 12 $ cat hosts.sh #!/bin/sh . /etc/init.d/functions for ip in 192.168.252.60 192.168.252.64 192.168.252.62 do expect fenfa.exp /etc/hosts/ $ip ~/ \u003e/dev/null 2\u003e\u00261 if [ $? -eq 0 ];then action \"$ip\" /bin/true else action \"$ip\" /bin/false fi done 如果ip很多写循环列表\nsh 1 for ip in `cat ip_list` 测试结果：\nsh 1 2 3 4 $ sh hosts.sh 192.168.252.60 [确定] 192.168.252.64 [确定] 192.168.252.62 [确定] 实战2：使用expect批量分发SSH密钥文件 首先准备4台机器：\nIP hostname- 192.168.252.60 lamp_client 192.168.252.62 rsync_client 192.168.252.63 nfs_server 192.168.252.64 mysql_client 1 在server端创建公钥与私钥\nsh 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 $ ssh-keygen -t dsa Generating public/private dsa key pair. Enter file in which to save the key (/root/.ssh/id_dsa): Created directory '/root/.ssh'. Enter passphrase (empty for no passphrase): Enter same passphrase again: Your identification has been saved in /root/.ssh/id_dsa. Your public key has been saved in /root/.ssh/id_dsa.pub. The key fingerprint is: 85:c5:f0:88:31:ed:a6:e6:9f:54:61:1e:68:ee:b2:c7 root@server-nfs The key's randomart image is: +--[ DSA 1024]----+ | o..o. | | +.*. | | ..= * | | oo+ o | | oS o | | o. . | | o..o | | .+E. | | .oo | +-----------------+ 2 查看密钥\nsh 1 2 3 $ ll ~/.ssh/ id_dsa id_dsa.pub 3 写批量拷贝脚本\nsh 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 #!/usr/bin/expect if { $argc != 2 } { send_user \"usage: expect scp-expect.exp file host dir\\n\" exit } #define var set file [lindex $argv 0] set host [lindex $argv 1] set password \"111111\" #spawn scp /etc/hosts root@10.0.0.142:/etc/hosts spawn ssh-copy-id -i $file \"-p 52113 root@$host\" expect { \"yes/no\" {send \"yes\\r\";exp_continue} \"*password\" {send \"$password\\r\"} } expect eof exit -onexit { send_user \"Oldboy say good bye to you!\\n\" } #script usage #expect oldboy-6.exp file host dir #example #./oldboy-6.exp /etc/hosts 10.0.0.179 /etc/hosts sh 1 2 3 4 5 6 7 8 9 10 11 12 13 $ ll ~/.ssh/ authorized_keys $ ll ~/.ssh/ id_dsa id_dsa.pub known_hosts $ ll ~/.ssh/ authorized_keys $ ll ~/.ssh/ authorized_keys sh 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 $ ssh -p52113 root@192.168.252.60 ifconfig eth0 Link encap:Ethernet HWaddr 00:0C:29:A7:DB:43 inet addr:192.168.252.60 Bcast:192.168.252.255 Mask:255.255.255.0 inet6 addr: fe80::20c:29ff:fea7:db43/64 Scope:Link UP BROADCAST RUNNING MULTICAST MTU:1500 Metric:1 RX packets:1187 errors:0 dropped:0 overruns:0 frame:0 TX packets:792 errors:0 dropped:0 overruns:0 carrier:0 collisions:0 txqueuelen:1000 RX bytes:105294 (102.8 KiB) TX bytes:73135 (71.4 KiB) lo Link encap:Local Loopback inet addr:127.0.0.1 Mask:255.0.0.0 inet6 addr: ::1/128 Scope:Host UP LOOPBACK RUNNING MTU:65536 Metric:1 RX packets:40 errors:0 dropped:0 overruns:0 frame:0 TX packets:40 errors:0 dropped:0 overruns:0 carrier:0 collisions:0 txqueuelen:0 RX bytes:3520 (3.4 KiB) TX bytes:3520 (3.4 KiB) 大功告成。\n特别提示：如果是禁止了ROOT远程连接，那么就使用普通用户加sudo的方式结合在expect大量分发。有的同学们问，既然做密钥认证了，为什么还要expect分发呢。在做认证期间，第一次的密钥分发，如果机器数量多，比如1000台，就可以expect分发，比ssh-copy-id方式或http的方式都会好一点。\n当然从例一可以看出来，即使不用密钥认证，expect依然可以实现分发数据及文件及批量管理部署服务。\n","wordCount":"1311","inLanguage":"zh","datePublished":"2016-07-23T00:00:00Z","dateModified":"2023-03-22T23:00:36+08:00","author":{"@type":"Person","name":"cylon"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.oomkill.com/2016/07/expect/"},"publisher":{"@type":"Organization","name":"Cylon's Collection","logo":{"@type":"ImageObject","url":"https://www.oomkill.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.oomkill.com/><img src=https://www.oomkill.com/favicon.ico alt aria-label=logo height=20>Cylon's Collection</a><div class=logo-switches><button id=theme-toggle><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://www.oomkill.com/archives><span>归档</span></a></li><li><a href=https://www.oomkill.com/tags><span>标签</span></a></li><li><a href=https://www.oomkill.com/search><span>搜索</span></a></li><li><a href=https://www.oomkill.com/about accesskey=/><span>关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">expect使用案例</h1><div class=post-meta><span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar" style="user-select:text"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" style="user-select:text"/><line x1="16" y1="2" x2="16" y2="6" style="user-select:text"/><line x1="8" y1="2" x2="8" y2="6" style="user-select:text"/><line x1="3" y1="10" x2="21" y2="10" style="user-select:text"/></svg><span>2016-07-23</span></span>&nbsp;·&nbsp;<span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text" style="user-select:text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z" style="user-select:text"/><polyline points="14 2 14 8 20 8" style="user-select:text"/><line x1="16" y1="13" x2="8" y2="13" style="user-select:text"/><line x1="16" y1="17" x2="8" y2="17" style="user-select:text"/><polyline points="10 9 9 9 8 9" style="user-select:text"/></svg><span>1311 字</span></span>&nbsp;·&nbsp;<span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><span>7 分钟</span></span>
<span class=pe-post-meta-item>&nbsp;·&nbsp;<svg t="1714036239378" fill="currentcolor" class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="6659" width="256" height="256"><path d="M690 78.2c-18.6-18.8-49-19-67.8-.4s-19 49-.4 67.8l255.4 258.6c67.8 68.6 67.8 178.8.0 247.4L653.4 878.2c-18.6 18.8-18.4 49.2.4 67.8s49.2 18.4 67.8-.4l224-226.4c104.8-106 104.8-276.4.0-382.4L690 78.2zM485.4 101.4c-24-24-56.6-37.4-90.6-37.4H96C43 64 0 107 0 160v299c0 34 13.4 66.6 37.4 90.6l336 336c50 50 131 50 181 0l267-267c50-50 50-131 0-181l-336-336zM96 160h299c8.4.0 16.6 3.4 22.6 9.4l336 336c12.4 12.4 12.4 32.8.0 45.2l-267 267c-12.4 12.4-32.8 12.4-45.2.0l-336-336c-6-6-9.4-14.2-9.4-22.6V160zm192 128a64 64 0 10-128 0 64 64 0 10128 0z" p-id="6660"/></svg></span><ul class=pe-post-meta-item><a href=https://www.oomkill.com/tags/linux/>#Linux</a></ul>&nbsp;·&nbsp;<span id=busuanzi_container_page_pv>本文阅读量 <span id=busuanzi_value_page_pv></span> 次</span></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details><summary><span class=details>目录</span></summary><div class=inner><ul><li><a href=#%e4%bb%80%e4%b9%88%e6%98%afexpect aria-label=什么是Expect>什么是Expect</a><li><a href=#expect%e7%a8%8b%e5%ba%8f%e5%b7%a5%e4%bd%9c%e6%b5%81%e7%a8%8b aria-label=Expect程序工作流程>Expect程序工作流程</a><li><a href=#%e5%ae%89%e8%a3%85expect%e8%bd%af%e4%bb%b6 aria-label=安装Expect软件>安装Expect软件</a><li><a href=#%e5%85%88%e7%9c%8b%e4%b8%80%e4%b8%aaexpect%e5%b0%8f%e5%ae%9e%e4%be%8b aria-label=先看一个Expect小实例>先看一个Expect小实例</a><li><a href=#expect%e8%af%ad%e6%b3%95 aria-label=Expect语法>Expect语法</a><ul><li><a href=#spawn aria-label=spawn>spawn</a><li><a href=#expect aria-label=expect>expect</a><li><a href=#exp_send%e5%92%8csend aria-label=exp_send和send>exp_send和send</a><li><a href=#exp_continue aria-label=exp_continue>exp_continue</a><li><a href=#send_user aria-label=send_user>send_user</a><li><a href=#exit aria-label=exit>exit</a></ul><li><a href=#except%e5%8f%98%e9%87%8f aria-label=Except变量>Except变量</a><li><a href=#expect%e5%85%b3%e9%94%ae%e5%ad%97 aria-label=Expect关键字>Expect关键字</a><ul><li><a href=#eof aria-label=eof>eof</a><li><a href=#timeout aria-label=timeout>timeout</a></ul><li><a href=#%e7%94%9f%e4%ba%a7%e5%9c%ba%e6%99%afexpect%e5%ae%9e%e6%88%98 aria-label=生产场景Expect实战>生产场景Expect实战</a><ul><li><a href=#%e5%ae%9e%e6%88%981%e4%bd%bf%e7%94%a8expect%e5%ae%9e%e7%8e%b0%e6%89%b9%e9%87%8f%e5%88%86%e5%8f%91etchosts%e6%96%87%e4%bb%b6 aria-label=实战1：使用expect实现批量分发/etc/hosts文件>实战1：使用expect实现批量分发/etc/hosts文件</a><li><a href=#%e5%ae%9e%e6%88%982%e4%bd%bf%e7%94%a8expect%e6%89%b9%e9%87%8f%e5%88%86%e5%8f%91ssh%e5%af%86%e9%92%a5%e6%96%87%e4%bb%b6 aria-label=实战2：使用expect批量分发SSH密钥文件>实战2：使用expect批量分发SSH密钥文件</a></li></div></details></div></aside><script src=/js/pe-toc.min.445eb1bfc5e85dd13b9519fcc2a806522e9629b6224a2974052789ba00ab78af.js integrity="sha256-RF6xv8XoXdE7lRn8wqgGUi6WKbYiSil0BSeJugCreK8="></script><div class=post-content><h2 id=什么是expect>什么是Expect<a hidden class=anchor aria-hidden=true href=#什么是expect>#</a></h2><p>Expent是基于tcl的相对简单的一个免费的脚本编程工具语言，用来实现自动和交互任务程序进行通信，无需人的手工干预。比如SSH、FTP等，这些程序正常情况都需要手工与它们进行交互，而使用Expect就可以模拟人手工交互的过程，实现自动的和远程的程序交互，从而达到自动化运维的目的。</p><h2 id=expect程序工作流程>Expect程序工作流程<a hidden class=anchor aria-hidden=true href=#expect程序工作流程>#</a></h2><p>Expect的工作流程可以理解为，spawn启动进程 ==> expect期待关键字 ==> send向进程发送字符 ==> 退出结束。</p><h2 id=安装expect软件>安装Expect软件<a hidden class=anchor aria-hidden=true href=#安装expect软件>#</a></h2><p>首先，配置好yum安装源，并且确保机器可以上网，然后执行<font color=#f8070d size=3><code>yum install expect -y</code></font>即可安装Expect软件。</p><p>安装完后查看结果：</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>sh</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ rpm -qa<span class=p>|</span>grep expect
</span></span><span class=line><span class=cl>expect-5.44.1.15-5.el6_4.x86_64</span></span></code></pre></td></tr></table></div></div></div></div><h2 id=先看一个expect小实例>先看一个Expect小实例<a hidden class=anchor aria-hidden=true href=#先看一个expect小实例>#</a></h2><p>首先准备3台虚拟机：</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>sh</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>192.168.252.60 client
</span></span><span class=line><span class=cl>192.168.252.62 client
</span></span><span class=line><span class=cl>192.168.252.63 client
</span></span><span class=line><span class=cl>192.168.252.64 server</span></span></code></pre></td></tr></table></div></div></div></div><p>再执行下面例子前，我们先手工执行如下命令</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>sh</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>ssh -p52113 root@192.168.252.64 ifconfig</span></span></code></pre></td></tr></table></div></div></div></div><p>执行结果：</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>sh</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ ssh -p52113 root@192.168.252.64 ifconfig
</span></span><span class=line><span class=cl>root@192.168.252.64<span class=err>&#39;</span>s password: </span></span></code></pre></td></tr></table></div></div></div></div><blockquote><blockquote><p><strong>Expect 例子脚本内容</strong>：</p></blockquote></blockquote><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>sh</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=cp>#!/usr/bin/expect
</span></span></span><span class=line><span class=cl><span class=cp></span>spawn ssh -p52113 root@192.168.252.62 /sbin/ifconfig eth0
</span></span><span class=line><span class=cl><span class=nb>set</span> timeout <span class=m>60</span>
</span></span><span class=line><span class=cl>expect <span class=s2>&#34;*password:&#34;</span>
</span></span><span class=line><span class=cl>send <span class=s2>&#34;111111\n&#34;</span>
</span></span><span class=line><span class=cl>expect eof
</span></span><span class=line><span class=cl>exit</span></span></code></pre></td></tr></table></div></div></div></div><blockquote><p><strong>执行结果</strong>：问题：</p></blockquote><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>sh</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ ./a.exp  
</span></span><span class=line><span class=cl>spawn ssh -p52113 root@192.168.252.62 /sbin/ifconfig eth0
</span></span><span class=line><span class=cl>root@192.168.252.62<span class=err>&#39;</span>s password: 
</span></span><span class=line><span class=cl>eth0      Link encap:Ethernet  HWaddr 00:0C:29:C3:48:CB  
</span></span><span class=line><span class=cl>          inet addr:192.168.252.62  Bcast:192.168.252.255  Mask:255.255.255.0
</span></span><span class=line><span class=cl>          inet6 addr: fe80::20c:29ff:fec3:48cb/64 Scope:Link
</span></span><span class=line><span class=cl>          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
</span></span><span class=line><span class=cl>          RX packets:3027 errors:0 dropped:0 overruns:0 frame:0
</span></span><span class=line><span class=cl>          TX packets:1632 errors:0 dropped:0 overruns:0 carrier:0
</span></span><span class=line><span class=cl>          collisions:0 txqueuelen:1000 
</span></span><span class=line><span class=cl>          RX bytes:268416 <span class=o>(</span>262.1 KiB<span class=o>)</span>  TX bytes:175473 <span class=o>(</span>171.3 KiB<span class=o>)</span></span></span></code></pre></td></tr></table></div></div></div></div><blockquote><p><strong>问题</strong>：</p></blockquote><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>sh</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ ./a.exp 
</span></span><span class=line><span class=cl>./a.exp: line 8: spawn: <span class=nb>command</span> not found
</span></span><span class=line><span class=cl>couldn<span class=s1>&#39;t read file &#34;*password:&#34;: no such file or directory
</span></span></span><span class=line><span class=cl><span class=s1>./a.exp: line 11: send: command not found
</span></span></span><span class=line><span class=cl><span class=s1>couldn&#39;</span>t <span class=nb>read</span> file <span class=s2>&#34;eof&#34;</span>: no such file or directory</span></span></code></pre></td></tr></table></div></div></div></div><p>原因：</p><ul><li>含有expect的脚本不能用bash执行，bash无法解析。添加可执行权限后，直接./your_script即可</li><li>这个代码是expect的代码，不由bash解释。</li><li>spawn可以看作expect脚本的内部函数。要第一行改成 #!/usr/bin/expect</li></ul><h2 id=expect语法>Expect语法<a hidden class=anchor aria-hidden=true href=#expect语法>#</a></h2><p>Expect中的命令是最重要的部分了，命令的使用语法如下：</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>sh</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>命令 <span class=o>[</span>选项<span class=o>]</span> 参数</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=spawn>spawn<a hidden class=anchor aria-hidden=true href=#spawn>#</a></h3><p>spawn命令是Expect的初始命令，它用于启动一个进程，之后所有expect操作都在这个进程中进行，如果没有spawn语句，整个expect就无法执行了，spawn使用方法如下：</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>sh</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>spawn ssh root@192.168.252.62</span></span></code></pre></td></tr></table></div></div></div></div><p>在spawn命令后面直接加上要启动的进程、命令等信息，除此之外，spawn还支持其他选项如：</p><ul><li>-open 启动文件进程，具体说明省略。</li><li>-ignore 忽略某些信号，具体说明省略。</li></ul><h3 id=expect>expect<a hidden class=anchor aria-hidden=true href=#expect>#</a></h3><p>使用方法：</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>sh</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>expect  表达式  动作  表达式  动作</span></span></code></pre></td></tr></table></div></div></div></div><p>expect命令用于等候一个相匹配内容的输出，一旦匹配上就执行expect后面的动作或命令。这个命令接受几个特有的参数，用的最多的就是-re，表示使用正则表达式的方式匹配，使用起来就像这样：</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>sh</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>spawn  ssh  root@192.168.252.64
</span></span><span class=line><span class=cl>expect  <span class=s2>&#34;password:&#34;</span> <span class=o>{</span>send <span class=s2>&#34;111111\r&#34;</span><span class=o>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>从上面的例子可以看出，expect是依附与spawn命令的，当执行ssh命令后，expect就匹配命令执行后的关键字：“password：”，如果匹配到关键字就会执行后面包含在“{}”中的send或exp_send动作，匹配的动作可以放在二行，这样就不需要使用“{}”了，就像下面这样，实际完成的功能与上面是一样的：</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>sh</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>spawn  ssh  root@192.168.252.64
</span></span><span class=line><span class=cl>expect  <span class=s2>&#34;password:&#34;</span> 
</span></span><span class=line><span class=cl>send <span class=s2>&#34;111111\r&#34;</span></span></span></code></pre></td></tr></table></div></div></div></div><p>expect命令还有一种用法，他可以在一个expect匹配中多次匹配关键字，并给出处理动作，只需要将关键字放在一个大括号中就可以了，当然还要有exp_continue。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>sh</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>spawn ssh root@192.168.252.64
</span></span><span class=line><span class=cl>expect <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;yes/no&#34;</span>		<span class=o>{</span> exp_send <span class=s2>&#34;yes\r&#34;</span><span class=p>;</span> exp_continue <span class=o>}</span>
</span></span><span class=line><span class=cl>   <span class=s2>&#34;*password:&#34;</span>	<span class=o>{</span> exp_send <span class=s2>&#34;111111\r&#34;</span> <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span></span></span></code></pre></td></tr></table></div></div></div></div><h3 id=exp_send和send>exp_send和send<a hidden class=anchor aria-hidden=true href=#exp_send和send>#</a></h3><p>在上面的介绍中，我们已经看到exp_send命令的使用，<font color=#f8070d size=3><code>exp_send</code></font>命令是<font color=#f8070d size=3><code>expect</code></font>中的动作命令，它还有一个完成同样工作的同胞：send，exp_send命令可以发送一些特殊符号，我们看到了\r（回车），还有一些其他的比如：\n、\t等等，这些都与TCL中的特殊符号相同。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>sh</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>spawn ssh root@192.168.252.64
</span></span><span class=line><span class=cl>expect <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;yes/no&#34;</span>		<span class=o>{</span> exp_send <span class=s2>&#34;yes\r&#34;</span><span class=p>;</span> exp_continue <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;*password:&#34;</span>	<span class=o>{</span> exp_send <span class=s2>&#34;111111\r&#34;</span> <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>send命令有几个可用参数：</p><ul><li>-i 制定spawn_id，这个参数用来向不同spawn_id的进程发送命令，是进行多程序控制的关键参数。</li><li>-s s代表slowly，也就是控制发送的速度，这个参数使用的时候要与expect中的变量send_slow相关联。</li></ul><h3 id=exp_continue>exp_continue<a hidden class=anchor aria-hidden=true href=#exp_continue>#</a></h3><p>这个命令一般用在动作中，它被使用的条件比较苛刻，看看下面的例子：</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>sh</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=cp>#!/usr/bin/expect
</span></span></span><span class=line><span class=cl><span class=cp></span>spawn ssh root@192.168.252.64 /sbin/ifconfig eth0
</span></span><span class=line><span class=cl><span class=nb>set</span> timeout <span class=m>60</span>
</span></span><span class=line><span class=cl>expect <span class=o>{</span>
</span></span><span class=line><span class=cl>    -timeout <span class=m>1</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;yes/no&#34;</span>		<span class=o>{</span> exp_send <span class=s2>&#34;yes\r&#34;</span><span class=p>;</span> exp_continue <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;*password:&#34;</span>	<span class=o>{</span> exp_send <span class=s2>&#34;111111\r&#34;</span> <span class=o>}</span>
</span></span><span class=line><span class=cl>    timeout 		<span class=o>{</span> puts  <span class=s2>&#34;expect was timeout by oldboy.&#34;</span><span class=p>;</span>  <span class=k>return</span><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>expect eof
</span></span><span class=line><span class=cl>exit</span></span></code></pre></td></tr></table></div></div></div></div><p>在这个例子中，可以发现exp_continue命令的使用方法，首先它要处于一个expect命令中，然后它属于一种动作命令，完成的工作就是从头开始遍历，也就是说如果没有这个命令，匹配第一个关键字以后就会继续匹配第二个关键字，但有了这个命令后，匹配第一个关键字以后，第二次匹配仍然从第一个关键字开始。</p><h3 id=send_user>send_user<a hidden class=anchor aria-hidden=true href=#send_user>#</a></h3><p>send_user命令用来把后面的参数输出到标准输出中去，默认的send、exp_send命令都是将参数输出到程序中去的，用起来就像这样：</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>sh</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>send_user <span class=s2>&#34;please input password:&#34;</span></span></span></code></pre></td></tr></table></div></div></div></div><p>这个语句就可以在标准输出中打印Please input password：字符了。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>sh</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=cp>#!/usr/bin/expect
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=k>if</span> <span class=o>{</span> <span class=nv>$argc</span> !<span class=o>=</span> <span class=m>2</span> <span class=o>}</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>send_user <span class=s2>&#34;usage: expect scp-expect.exp file host dir\n&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>exit</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#define var</span>
</span></span><span class=line><span class=cl><span class=nb>set</span> file <span class=o>[</span>lindex <span class=nv>$argv</span> 0<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nb>set</span> host <span class=o>[</span>lindex <span class=nv>$argv</span> 1<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nb>set</span> password <span class=s2>&#34;111111&#34;</span>
</span></span><span class=line><span class=cl><span class=c1>#spawn scp /etc/hosts root@10.0.0.142:/etc/hosts</span>
</span></span><span class=line><span class=cl>spawn ssh-copy-id -i <span class=nv>$file</span> <span class=s2>&#34;-p 52113 root@</span><span class=nv>$host</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>expect <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;yes/no&#34;</span>    <span class=o>{</span>send <span class=s2>&#34;yes\r&#34;</span><span class=p>;</span>exp_continue<span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;*password&#34;</span> <span class=o>{</span>send <span class=s2>&#34;</span><span class=nv>$password</span><span class=s2>\r&#34;</span><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>expect eof
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>exit</span> -onexit <span class=o>{</span>
</span></span><span class=line><span class=cl>send_user <span class=s2>&#34;Oldboy say good bye to you!\n&#34;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#script usage</span>
</span></span><span class=line><span class=cl><span class=c1>#expect oldboy-6.exp file host dir</span>
</span></span><span class=line><span class=cl><span class=c1>#example</span>
</span></span><span class=line><span class=cl><span class=c1>#./oldboy-6.exp /etc/hosts 10.0.0.179 /etc/hosts</span></span></span></code></pre></td></tr></table></div></div></div></div><h3 id=exit>exit<a hidden class=anchor aria-hidden=true href=#exit>#</a></h3><p>exit命令功能很简单，就是直接退出脚本，但是你可以利用这个命令对脚本做一些扫尾工作，比如下面这样：</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>sh</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=nb>exit</span> -onexit <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>exec</span>  rm  <span class=nv>$tmpfile</span>
</span></span><span class=line><span class=cl>    send_user <span class=s2>&#34;Good bye\n&#34;</span>
</span></span><span class=line><span class=cl><span class=o>}</span></span></span></code></pre></td></tr></table></div></div></div></div><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>sh</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=cp>#!/usr/bin/expect
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=k>if</span> <span class=o>{</span> <span class=nv>$argc</span> !<span class=o>=</span> <span class=m>2</span> <span class=o>}</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>	send_user <span class=s2>&#34;usage: expect scp-expect.exp file host dir\n&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nb>exit</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#define var</span>
</span></span><span class=line><span class=cl><span class=nb>set</span> file <span class=o>[</span>lindex <span class=nv>$argv</span> 0<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nb>set</span> host <span class=o>[</span>lindex <span class=nv>$argv</span> 1<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nb>set</span> password <span class=s2>&#34;111111&#34;</span>
</span></span><span class=line><span class=cl><span class=c1>#spawn scp /etc/hosts root@10.0.0.142:/etc/hosts</span>
</span></span><span class=line><span class=cl>spawn ssh-copy-id -i <span class=nv>$file</span> <span class=s2>&#34;-p 52113 root@</span><span class=nv>$host</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>expect <span class=o>{</span>
</span></span><span class=line><span class=cl> 	<span class=s2>&#34;yes/no&#34;</span>    <span class=o>{</span>send <span class=s2>&#34;yes\r&#34;</span><span class=p>;</span>exp_continue<span class=o>}</span>
</span></span><span class=line><span class=cl> 	<span class=s2>&#34;*password&#34;</span> <span class=o>{</span>send <span class=s2>&#34;</span><span class=nv>$password</span><span class=s2>\r&#34;</span><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>expect eof
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>exit</span> -onexit <span class=o>{</span>
</span></span><span class=line><span class=cl> 	send_user <span class=s2>&#34;Oldboy say good bye to you!\n&#34;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#script usage</span>
</span></span><span class=line><span class=cl><span class=c1>#expect oldboy-6.exp file host dir</span>
</span></span><span class=line><span class=cl><span class=c1>#example</span>
</span></span><span class=line><span class=cl><span class=c1>#./oldboy-6.exp /etc/hosts 10.0.0.179 /etc/hosts</span></span></span></code></pre></td></tr></table></div></div></div></div><h2 id=except变量>Except变量<a hidden class=anchor aria-hidden=true href=#except变量>#</a></h2><p>expect中有很多有用的变量，它们使用方法与TCL语言中的变量相同，比如：
set 变量名 变量名 # 设置变量的方法
set $变量名 # 读取变量的方法</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>sh</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1>#define var</span>
</span></span><span class=line><span class=cl><span class=nb>set</span> file <span class=o>[</span>lindex <span class=nv>$argv</span> 0<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nb>set</span> file <span class=o>[</span>lindex <span class=nv>$argv</span> 1<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nb>set</span> file <span class=o>[</span>lindex <span class=nv>$argv</span> 2<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nb>set</span> password <span class=s2>&#34;123456&#34;</span></span></span></code></pre></td></tr></table></div></div></div></div><h2 id=expect关键字>Expect关键字<a hidden class=anchor aria-hidden=true href=#expect关键字>#</a></h2><p>expect中的特殊关键字用于匹配过程，代表某些特殊含义或状态，一般用于expect族命令中不能在外面单独使用，也可以理解为事件，使用上类似于<code>expect eof {}</code></p><h3 id=eof>eof<a hidden class=anchor aria-hidden=true href=#eof>#</a></h3><p>eof (end-of-file)关键字用于匹配 结束符，比如文件的结束符、FTP传输停止等情况，在这个关键字后跟上动作来做进一步的控制，特别是FTP交互操作方面，它的动作很大。用一个例子来看看：</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>sh</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>spawn ftp anonymous@10.11.105.110
</span></span><span class=line><span class=cl>expect <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;password:&#34;</span>  <span class=o>{</span>exp_send <span class=s2>&#34;who I’m I&#34;</span><span class=o>}</span>
</span></span><span class=line><span class=cl>   eof <span class=o>{</span>ftp connect close<span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>interact <span class=o>{</span> <span class=o>}</span></span></span></code></pre></td></tr></table></div></div></div></div><h3 id=timeout>timeout<a hidden class=anchor aria-hidden=true href=#timeout>#</a></h3><p>timeout是expect中的一个重要变量，它是一个全局性的时间控制开关，你可以通过为这个变量赋值来规定整个expect操作时间，注意这个变量是服务于expect全局的，它不会纠缠于某一条命令，即使命令没有任何错误，到时见仍然会激活这个变量，但这个时间到达以后除了激活一个开关之外不会做其他的事情，如何处理是脚本编写人员的事情，看看它的实际使用方法：</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>sh</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=nb>set</span> timeout <span class=m>60</span>
</span></span><span class=line><span class=cl>spawn ssh root@192.168.2.1
</span></span><span class=line><span class=cl>expect <span class=s2>&#34;password:&#34;</span>  <span class=o>{</span>send <span class=s2>&#34;word\r&#34;</span><span class=o>}</span>
</span></span><span class=line><span class=cl>expect timeout  <span class=o>{</span> puts <span class=s2>&#34;Expect was timeout&#34;</span><span class=p>;</span> <span class=k>return</span> <span class=o>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>上面的处理中，首先将timeout变量设置为60秒，当出现问题的时候程序可能会停止下来，只要到60秒。就会激活下面的timeout动作，这里我们打印一个信息并且停止了脚步的运行&ndash;你可以做更多其他的事情，看自己的意思。</p><p>在另一种expect格式中，我们还有一种设置timeout变量的方法，看看下面的例子：</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>sh</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>spawn ssh root@192.168.1.1
</span></span><span class=line><span class=cl>expect <span class=o>{</span>
</span></span><span class=line><span class=cl>    -timeout <span class=m>60</span>
</span></span><span class=line><span class=cl>    -re <span class=s2>&#34;password:&#34;</span> <span class=o>{</span>exp_send <span class=s2>&#34;word\r&#34;</span><span class=o>}</span>
</span></span><span class=line><span class=cl>    -re <span class=s2>&#34;TopsecOS#&#34;</span> <span class=o>{</span>  <span class=o>}</span>
</span></span><span class=line><span class=cl>    timeout <span class=o>{</span> puts <span class=s2>&#34;Expect was timeout&#34;</span><span class=p>;</span> <span class=k>return</span> <span class=o>}</span>
</span></span><span class=line><span class=cl>    -re <span class=s2>&#34;TopsecOS#&#34;</span> <span class=o>{</span>  <span class=o>}</span>
</span></span><span class=line><span class=cl>    timeout  <span class=o>{</span> puts <span class=s2>&#34;Expecr was timeout&#34;</span><span class=p>;</span> <span class=k>return</span> <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span></span></span></code></pre></td></tr></table></div></div></div></div><h2 id=生产场景expect实战>生产场景Expect实战<a hidden class=anchor aria-hidden=true href=#生产场景expect实战>#</a></h2><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>sh</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ cat fenfa.exp
</span></span><span class=line><span class=cl><span class=c1>#!/usr/bin/expect</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>{</span> <span class=nv>$argc</span> !<span class=o>=</span> <span class=m>3</span> <span class=o>}</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>         send_user <span class=s2>&#34;usage: expect scp-expect.exp file host dir\n&#34;</span>
</span></span><span class=line><span class=cl>         <span class=nb>exit</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#define var</span>
</span></span><span class=line><span class=cl><span class=nb>set</span> file <span class=o>[</span>lindex <span class=nv>$argv</span> 0<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nb>set</span> host <span class=o>[</span>lindex <span class=nv>$argv</span> 1<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nb>set</span> dir  <span class=o>[</span>lindex <span class=nv>$argv</span> 2<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nb>set</span> password <span class=s2>&#34;111111&#34;</span>
</span></span><span class=line><span class=cl>spawn scp -P <span class=m>52113</span> -p <span class=nv>$file</span> root@<span class=nv>$host</span>:<span class=nv>$dir</span>
</span></span><span class=line><span class=cl><span class=c1>#spawn ssh-copy-id -i $file &#34;-p 52113 root@$host&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>expect <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;yes/no&#34;</span>    <span class=o>{</span>send <span class=s2>&#34;yes\r&#34;</span><span class=p>;</span>exp_continue<span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;*password&#34;</span> <span class=o>{</span>send <span class=s2>&#34;</span><span class=nv>$password</span><span class=s2>\r&#34;</span><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>expect eof
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>exit</span> -onexit <span class=o>{</span>
</span></span><span class=line><span class=cl>    send_user <span class=s2>&#34;Oldboy say good bye to you!\n&#34;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#script usage</span>
</span></span><span class=line><span class=cl><span class=c1>#expect oldboy-6.exp file host dir</span>
</span></span><span class=line><span class=cl><span class=c1>#example</span>
</span></span><span class=line><span class=cl><span class=c1>#./oldboy-6.exp /etc/hosts 10.0.0.179 /etc/hosts</span></span></span></code></pre></td></tr></table></div></div></div></div><h3 id=实战1使用expect实现批量分发etchosts文件>实战1：使用expect实现批量分发/etc/hosts文件<a hidden class=anchor aria-hidden=true href=#实战1使用expect实现批量分发etchosts文件>#</a></h3><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>sh</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ cat hosts.sh 
</span></span><span class=line><span class=cl><span class=c1>#!/bin/sh</span>
</span></span><span class=line><span class=cl>. /etc/init.d/functions
</span></span><span class=line><span class=cl><span class=k>for</span> ip in 192.168.252.60 192.168.252.64  192.168.252.62
</span></span><span class=line><span class=cl><span class=k>do</span>
</span></span><span class=line><span class=cl>expect fenfa.exp /etc/hosts/ <span class=nv>$ip</span> ~/ &gt;/dev/null 2&gt;<span class=p>&amp;</span><span class=m>1</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> <span class=nv>$?</span> -eq <span class=m>0</span> <span class=o>]</span><span class=p>;</span><span class=k>then</span>
</span></span><span class=line><span class=cl>    action <span class=s2>&#34;</span><span class=nv>$ip</span><span class=s2>&#34;</span> /bin/true
</span></span><span class=line><span class=cl><span class=k>else</span> 
</span></span><span class=line><span class=cl>    action <span class=s2>&#34;</span><span class=nv>$ip</span><span class=s2>&#34;</span> /bin/false
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=k>done</span></span></span></code></pre></td></tr></table></div></div></div></div><p>如果ip很多写循环列表</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>sh</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=k>for</span> ip in <span class=sb>`</span>cat ip_list<span class=sb>`</span></span></span></code></pre></td></tr></table></div></div></div></div><p>测试结果：</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>sh</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ sh hosts.sh   
</span></span><span class=line><span class=cl>192.168.252.60                                             <span class=o>[</span>确定<span class=o>]</span>
</span></span><span class=line><span class=cl>192.168.252.64                                             <span class=o>[</span>确定<span class=o>]</span>
</span></span><span class=line><span class=cl>192.168.252.62                                             <span class=o>[</span>确定<span class=o>]</span></span></span></code></pre></td></tr></table></div></div></div></div><h3 id=实战2使用expect批量分发ssh密钥文件>实战2：使用expect批量分发SSH密钥文件<a hidden class=anchor aria-hidden=true href=#实战2使用expect批量分发ssh密钥文件>#</a></h3><p>首先准备4台机器：</p><table><thead><tr><th>IP</th><th>hostname-</th></tr></thead><tbody><tr><td>192.168.252.60</td><td>lamp_client</td></tr><tr><td>192.168.252.62</td><td>rsync_client</td></tr><tr><td>192.168.252.63</td><td>nfs_server</td></tr><tr><td>192.168.252.64</td><td>mysql_client</td></tr></tbody></table><blockquote><p><strong>1 在server端创建公钥与私钥</strong></p></blockquote><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>sh</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ ssh-keygen -t dsa
</span></span><span class=line><span class=cl>Generating public/private dsa key pair.
</span></span><span class=line><span class=cl>Enter file in which to save the key <span class=o>(</span>/root/.ssh/id_dsa<span class=o>)</span>: 
</span></span><span class=line><span class=cl>Created directory <span class=s1>&#39;/root/.ssh&#39;</span>.
</span></span><span class=line><span class=cl>Enter passphrase <span class=o>(</span>empty <span class=k>for</span> no passphrase<span class=o>)</span>: 
</span></span><span class=line><span class=cl>Enter same passphrase again: 
</span></span><span class=line><span class=cl>Your identification has been saved in /root/.ssh/id_dsa.
</span></span><span class=line><span class=cl>Your public key has been saved in /root/.ssh/id_dsa.pub.
</span></span><span class=line><span class=cl>The key fingerprint is:
</span></span><span class=line><span class=cl>85:c5:f0:88:31:ed:a6:e6:9f:54:61:1e:68:ee:b2:c7 root@server-nfs
</span></span><span class=line><span class=cl>The key<span class=err>&#39;</span>s randomart image is:
</span></span><span class=line><span class=cl>+--<span class=o>[</span> DSA 1024<span class=o>]</span>----+
</span></span><span class=line><span class=cl><span class=p>|</span>      o..o.      <span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span>       +.*.      <span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span>      ..<span class=o>=</span> *      <span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span>       oo+ o     <span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span>       oS o      <span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span>      o. .       <span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span>     o..o        <span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span>      .+E.       <span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span>      .oo        <span class=p>|</span>
</span></span><span class=line><span class=cl>+-----------------+</span></span></code></pre></td></tr></table></div></div></div></div><blockquote><p><strong>2 查看密钥</strong></p></blockquote><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>sh</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ ll ~/.ssh/
</span></span><span class=line><span class=cl>id_dsa
</span></span><span class=line><span class=cl>id_dsa.pub</span></span></code></pre></td></tr></table></div></div></div></div><blockquote><p><strong>3 写批量拷贝脚本</strong></p></blockquote><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>sh</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=cp>#!/usr/bin/expect
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=k>if</span> <span class=o>{</span> <span class=nv>$argc</span> !<span class=o>=</span> <span class=m>2</span> <span class=o>}</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    send_user <span class=s2>&#34;usage: expect scp-expect.exp file host dir\n&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>exit</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=c1>#define var</span>
</span></span><span class=line><span class=cl><span class=nb>set</span> file <span class=o>[</span>lindex <span class=nv>$argv</span> 0<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nb>set</span> host <span class=o>[</span>lindex <span class=nv>$argv</span> 1<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nb>set</span> password <span class=s2>&#34;111111&#34;</span>
</span></span><span class=line><span class=cl><span class=c1>#spawn scp /etc/hosts root@10.0.0.142:/etc/hosts</span>
</span></span><span class=line><span class=cl>spawn ssh-copy-id -i <span class=nv>$file</span> <span class=s2>&#34;-p 52113 root@</span><span class=nv>$host</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>expect <span class=o>{</span>
</span></span><span class=line><span class=cl>     <span class=s2>&#34;yes/no&#34;</span>    <span class=o>{</span>send <span class=s2>&#34;yes\r&#34;</span><span class=p>;</span>exp_continue<span class=o>}</span>
</span></span><span class=line><span class=cl>     <span class=s2>&#34;*password&#34;</span> <span class=o>{</span>send <span class=s2>&#34;</span><span class=nv>$password</span><span class=s2>\r&#34;</span><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>expect eof
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>exit</span> -onexit <span class=o>{</span>
</span></span><span class=line><span class=cl>     send_user <span class=s2>&#34;Oldboy say good bye to you!\n&#34;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#script usage</span>
</span></span><span class=line><span class=cl><span class=c1>#expect oldboy-6.exp file host dir</span>
</span></span><span class=line><span class=cl><span class=c1>#example</span>
</span></span><span class=line><span class=cl><span class=c1>#./oldboy-6.exp /etc/hosts 10.0.0.179 /etc/hosts</span></span></span></code></pre></td></tr></table></div></div></div></div><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>sh</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ ll ~/.ssh/
</span></span><span class=line><span class=cl>authorized_keys
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ ll ~/.ssh/
</span></span><span class=line><span class=cl>id_dsa
</span></span><span class=line><span class=cl>id_dsa.pub
</span></span><span class=line><span class=cl>known_hosts
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ ll ~/.ssh/
</span></span><span class=line><span class=cl>authorized_keys
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ ll ~/.ssh/
</span></span><span class=line><span class=cl>authorized_keys</span></span></code></pre></td></tr></table></div></div></div></div><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>sh</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ ssh -p52113 root@192.168.252.60 ifconfig
</span></span><span class=line><span class=cl>eth0      Link encap:Ethernet  HWaddr 00:0C:29:A7:DB:43  
</span></span><span class=line><span class=cl>          inet addr:192.168.252.60  Bcast:192.168.252.255  Mask:255.255.255.0
</span></span><span class=line><span class=cl>          inet6 addr: fe80::20c:29ff:fea7:db43/64 Scope:Link
</span></span><span class=line><span class=cl>          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
</span></span><span class=line><span class=cl>          RX packets:1187 errors:0 dropped:0 overruns:0 frame:0
</span></span><span class=line><span class=cl>          TX packets:792 errors:0 dropped:0 overruns:0 carrier:0
</span></span><span class=line><span class=cl>          collisions:0 txqueuelen:1000 
</span></span><span class=line><span class=cl>          RX bytes:105294 <span class=o>(</span>102.8 KiB<span class=o>)</span>  TX bytes:73135 <span class=o>(</span>71.4 KiB<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>lo        Link encap:Local Loopback  
</span></span><span class=line><span class=cl>          inet addr:127.0.0.1  Mask:255.0.0.0
</span></span><span class=line><span class=cl>          inet6 addr: ::1/128 Scope:Host
</span></span><span class=line><span class=cl>          UP LOOPBACK RUNNING  MTU:65536  Metric:1
</span></span><span class=line><span class=cl>          RX packets:40 errors:0 dropped:0 overruns:0 frame:0
</span></span><span class=line><span class=cl>          TX packets:40 errors:0 dropped:0 overruns:0 carrier:0
</span></span><span class=line><span class=cl>          collisions:0 txqueuelen:0 
</span></span><span class=line><span class=cl>          RX bytes:3520 <span class=o>(</span>3.4 KiB<span class=o>)</span>  TX bytes:3520 <span class=o>(</span>3.4 KiB<span class=o>)</span></span></span></code></pre></td></tr></table></div></div></div></div><p>大功告成。</p><p><strong><font color=#0215cd size=2>特别提示</font></strong>：如果是禁止了ROOT远程连接，那么就使用普通用户加sudo的方式结合在expect大量分发。有的同学们问，既然做密钥认证了，为什么还要expect分发呢。在做认证期间，第一次的密钥分发，如果机器数量多，比如1000台，就可以expect分发，比ssh-copy-id方式或http的方式都会好一点。</p><p>当然从例一可以看出来，即使不用密钥认证，expect依然可以实现分发数据及文件及批量管理部署服务。</p></div><div class=pe-copyright><hr><blockquote><p>本文为原创内容，版权归作者所有。如需转载，请在文章中声明本文标题及链接。</p><p>文章标题：expect使用案例</p><p>文章链接：<a href=https://www.oomkill.com/2016/07/expect/ target=_blank>https://www.oomkill.com/2016/07/expect/</a></p><p>许可协议：<a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></p></blockquote></div><div class=comments-separator></div><h3 class=relatedContentTitle>相关阅读</h3><ul class=relatedContent><li><a href=/2016/04/syslog/><span>Linux日志管理 - syslog</span></a></li><li><a href=/2016/04/systemd/><span>Linux服务管理 - systemd</span></a></li></ul><div class=comments-separator></div><footer class=post-footer><ul class=post-tags><li><a href=https://www.oomkill.com/tags/linux/>Linux</a></li></ul><nav class=paginav><a class=prev href=https://www.oomkill.com/2016/07/scp/><span class=title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left" style="user-select:text"><line x1="19" y1="12" x2="5" y2="12" style="user-select:text"/><polyline points="12 19 5 12 12 5" style="user-select:text"/></polyline></svg>&nbsp;</span>
<span>使用SSH协议来传输文件</span>
</a><a class=next href=https://www.oomkill.com/2016/06/php-installtation/><span class=title></span>
<span>编译安装PHP&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right" style="user-select:text"><line x1="5" y1="12" x2="19" y2="12" style="user-select:text"/><polyline points="12 5 19 12 12 19" style="user-select:text"/></svg></span></a></nav></footer><div class=pe-comments-decoration><p class=pe-comments-title></p><p class=pe-comments-subtitle></p></div><div id=pe-comments></div><script src=/js/pe-go-comment.min.86a214102576ba5f9b7bdc29eed8d58dd56e34aef80b3c65c73ea9cc88443696.js integrity="sha256-hqIUECV2ul+be9wp7tjVjdVuNK74Czxlxz6pzIhENpY="></script><script>const getStoredTheme=()=>localStorage.getItem("pref-theme")==="dark"?"dark":"light",setGiscusTheme=()=>{const e=e=>{const t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:e},"https://giscus.app")};e({setConfig:{theme:getStoredTheme()}})};document.addEventListener("DOMContentLoaded",()=>{const s={src:"https://giscus.app/client.js","data-repo":"cylonchau/cylonchau.github.io","data-repo-id":"R_kgDOIRlNSQ","data-category":"Announcements","data-category-id":"DIC_kwDOIRlNSc4CXy1U","data-mapping":"pathname","data-term":"posts/expect","data-strict":"0","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"top","data-theme":getStoredTheme(),"data-lang":"zh-TW","data-loading":"lazy",crossorigin:"anonymous",async:""},e=document.createElement("script");Object.entries(s).forEach(([t,n])=>e.setAttribute(t,n)),document.querySelector("#pe-comments").appendChild(e);const t=document.querySelector("#theme-toggle");t&&t.addEventListener("click",setGiscusTheme);const n=document.querySelector("#theme-toggle-float");n&&n.addEventListener("click",setGiscusTheme)})</script></article></main><footer class=footer><span>&copy; 2024 <a href=https://www.oomkill.com/>Cylon's Collection</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> on
<a href=https://pages.github.com/ rel=noopener target=_blank>GitHub Pages</a> & Theme
        <a href=https://github.com/tofuwine/PaperMod-PE rel=noopener target=_blank>PaperMod-PE</a></span><div class=busuanzi-footer style="font-family:helvetica neue,Helvetica,Arial,sans-serif;text-align:center;padding:4px 0;color:#999"><span id=busuanzi_container_site_pv style=margin-right:8px;font-size:.85em>本站总访问量<span id=busuanzi_value_site_pv style=font-weight:500>0</span>次
</span><span id=busuanzi_container_site_uv style=font-size:.85em>本站访客数<span id=busuanzi_value_site_uv style=font-weight:500>0</span>人次</span></div></footer><div class=pe-right-sidebar><a href=javascript:void(0); id=theme-toggle-float class=pe-float-btn><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</a><a href=#top class=pe-float-btn id=top-link><span id=pe-read-progress></span></a></div><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>