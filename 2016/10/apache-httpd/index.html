<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Apache httpd配置集锦 | Cylon&#39;s Collection</title>
<meta name="keywords" content="httpd, apache httpd, httpd 配置">
<meta name="description" content="Apache httpd配置集锦 - Cylon&#39;s Collection">
<meta name="author" content="cylon">
<link rel="canonical" href="https://www.oomkill.com/2016/10/apache-httpd/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.41a8706089174fae1769fc26da4d1d354fa88083db604a95688ff58852dd9006.css" integrity="sha256-QahwYIkXT64Xafwm2k0dNU&#43;ogIPbYEqVaI/1iFLdkAY=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://www.oomkill.com/favicon.ico">
<link rel="apple-touch-icon" href="https://www.oomkill.com/apple-touch-icon.png">

<meta name="twitter:title" content="Apache httpd配置集锦 | Cylon&#39;s Collection" />
<meta name="twitter:description" content="" />
<meta property="og:title" content="Apache httpd配置集锦 | Cylon&#39;s Collection" />
<meta property="og:description" content="" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.oomkill.com/2016/10/apache-httpd/" />
<meta property="article:section" content="posts" />
  <meta property="article:published_time" content="2016-10-16T00:00:00&#43;00:00" />
  <meta property="article:modified_time" content="2022-12-02T23:00:36&#43;08:00" />


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Posts",
      "item": "https://www.oomkill.com/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "Apache httpd配置集锦",
      "item": "https://www.oomkill.com/2016/10/apache-httpd/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Apache httpd配置集锦 | Cylon's Collection",
  "name": "Apache httpd配置集锦",
  "description": "",
  "keywords": [
    "httpd", "apache httpd", "httpd 配置"
  ],
  "wordCount" : "12936",
  "inLanguage": "zh",
  "datePublished": "2016-10-16T00:00:00Z",
  "dateModified": "2022-12-02T23:00:36+08:00",
  "author":{
    "@type": "Person",
    "name": "cylon"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://www.oomkill.com/2016/10/apache-httpd/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Cylon's Collection",
    "logo": {
      "@type": "ImageObject",
      "url": "https://www.oomkill.com/favicon.ico"
    }
  }
}
</script><script type="text/javascript"
        async
        src="https://cdn.bootcss.com/mathjax/2.7.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\[\[','\]\]']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
});

MathJax.Hub.Queue(function() {
    
    
    
    var all = MathJax.Hub.getAllJax(), i;
    for(i = 0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
});
</script>

<style>
code.has-jax {
    font: inherit;
    font-size: 100%;
    background: inherit;
    border: inherit;
    color: #515151;
}
</style>
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary-bg: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list-page {
                background: var(--theme);
            }

            .list-page:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list-page:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>

</head>

<body class=" type-posts kind-page layout-" id="top"><script data-no-instant>
function switchTheme(theme) {
  switch (theme) {
    case 'light':
      document.body.classList.remove('dark');
      break;
    case 'dark':
      document.body.classList.add('dark');
      break;
    
    default:
      if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
      }
  }
}

function isDarkTheme() {
  return document.body.className.includes("dark");
}

function getPrefTheme() {
  return localStorage.getItem("pref-theme");
}

function setPrefTheme(theme) {
  switchTheme(theme)
  localStorage.setItem("pref-theme", theme);
}

const toggleThemeCallbacks = {}
toggleThemeCallbacks['main'] = (isDark) => {
  
  if (isDark) {
    setPrefTheme('light');
  } else {
    setPrefTheme('dark');
  }
}




window.addEventListener('toggle-theme', function() {
  
  const isDark = isDarkTheme()
  for (const key in toggleThemeCallbacks) {
    toggleThemeCallbacks[key](isDark)
  }
});


function toggleThemeListener() {
  
  window.dispatchEvent(new CustomEvent('toggle-theme'));
}

</script>
<script>
  
  (function() {
    const defaultTheme = 'auto';
    const prefTheme = getPrefTheme();
    const theme = prefTheme ? prefTheme : defaultTheme;

    switchTheme(theme);
  })();
</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://www.oomkill.com" accesskey="h" title="Cylon&#39;s Collection (Alt + H)">Cylon&#39;s Collection</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="https://www.oomkill.com/archives/" title="归档"
                >归档
                </a>
            </li>
            <li>
                <a href="https://www.oomkill.com/tags/" title="标签"
                >标签
                </a>
            </li>
            <li>
                <a href="https://www.oomkill.com/search/" title="搜索 (Alt &#43; /)"data-no-instant accesskey=/
                >搜索
                </a>
            </li>
            <li>
                <a href="https://www.oomkill.com/about/" title="关于"
                >关于
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main post">

<article class="post-single">
  <header class="post-header"><h1 class="post-title">Apache httpd配置集锦</h1>
    <div class="post-meta"><span class="meta-item">
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar" style="user-select: text;"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" style="user-select: text;"></rect><line x1="16" y1="2" x2="16" y2="6" style="user-select: text;"></line><line x1="8" y1="2" x2="8" y2="6" style="user-select: text;"></line><line x1="3" y1="10" x2="21" y2="10" style="user-select: text;"></line></svg>
  <span>2016-10-16</span></span><span class="meta-item">
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar" style="user-select: text;"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" style="user-select: text;"></rect><line x1="16" y1="2" x2="16" y2="6" style="user-select: text;"></line><line x1="8" y1="2" x2="8" y2="6" style="user-select: text;"></line><line x1="3" y1="10" x2="21" y2="10" style="user-select: text;"></line></svg>
  <span>Edited on 2022-12-02</span></span><span class="meta-item">
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon" style="user-select: text;"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z" style="user-select: text;"></path><line x1="7" y1="7" x2="7" y2="7" style="user-select: text;"></line></svg>
  <span class="post-tags"><a href="https://www.oomkill.com/tags/web-middleware/">web middleware</a></span></span><span class="meta-item">
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><circle cx="12" cy="12" r="9"></circle><polyline points="12 7 12 12 15 15"></polyline></svg>
  <span>26 分钟</span></span>

      
      
    </div>
  </header> <div class="toc side right">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">目录</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e5%ae%89%e8%a3%85httpd" aria-label="安装httpd">安装httpd</a><ul>
                        
                <li>
                    <a href="#httpd-%e7%bc%96%e8%af%91%e5%8f%82%e6%95%b0" aria-label="httpd 编译参数">httpd 编译参数</a></li>
                <li>
                    <a href="#%e5%bc%80%e5%a7%8b%e5%ae%89%e8%a3%85httpd" aria-label="开始安装httpd">开始安装httpd</a></li>
                <li>
                    <a href="#troubleshooting" aria-label="Troubleshooting">Troubleshooting</a><ul>
                        
                <li>
                    <a href="#configure-error-bundled-apr-requested-but-not-found" aria-label="configure: error: Bundled APR requested but not found">configure: error: Bundled APR requested but not found</a></li>
                <li>
                    <a href="#error-pcre_dupnames-undeclared-first-use-in-this-function" aria-label="error: &amp;lsquo;PCRE_DUPNAMES&amp;rsquo; undeclared (first use in this function)">error: &lsquo;PCRE_DUPNAMES&rsquo; undeclared (first use in this function)</a></li>
                <li>
                    <a href="#cannot-restore-segment-prot-after-reloc-permission-denied" aria-label="cannot restore segment prot after reloc: Permission denied">cannot restore segment prot after reloc: Permission denied</a></li>
                <li>
                    <a href="#configure-warning-openssl-version-is-too-old" aria-label="configure: WARNING: OpenSSL version is too old">configure: WARNING: OpenSSL version is too old</a></li>
                <li>
                    <a href="#zlib-location-not-found" aria-label="zlib location&amp;hellip; not found">zlib location&hellip; not found</a></li>
                <li>
                    <a href="#no-acceptable-c-compiler-found-in-path" aria-label="no acceptable C compiler found in $PATH">no acceptable C compiler found in $PATH</a></li>
                <li>
                    <a href="#httpd-could-not-reliably-determine-the-servers-fully-qualified-domain-name" aria-label="httpd: Could not reliably determine the server&amp;rsquo;s fully qualified domain name,">httpd: Could not reliably determine the server&rsquo;s fully qualified domain name,</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%90%af%e5%8a%a8%e5%8f%82%e6%95%b0" aria-label="启动参数">启动参数</a></li>
                <li>
                    <a href="#httpd%e7%9b%ae%e5%bd%95%e7%bb%93%e6%9e%84" aria-label="httpd目录结构">httpd目录结构</a></li>
                <li>
                    <a href="#httpd%e4%b8%bb%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6%e8%af%b4%e6%98%8e" aria-label="httpd主配置文件说明">httpd主配置文件说明</a></li>
                <li>
                    <a href="#httpd%e7%9a%84%e6%89%a9%e5%b1%95%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6" aria-label="httpd的扩展配置文件">httpd的扩展配置文件</a></li></ul>
                </li>
                <li>
                    <a href="#%e8%99%9a%e6%8b%9f%e4%b8%bb%e6%9c%ba" aria-label="虚拟主机">虚拟主机</a><ul>
                        
                <li>
                    <a href="#%e5%9f%ba%e4%ba%8e%e5%9f%9f%e5%90%8d%e7%9a%84%e8%99%9a%e6%8b%9f%e4%b8%bb%e6%9c%ba" aria-label="基于域名的虚拟主机★★★★★">基于域名的虚拟主机★★★★★</a></li>
                <li>
                    <a href="#%e5%9f%ba%e4%ba%8e%e7%ab%af%e5%8f%a3%e7%9a%84%e8%99%9a%e6%8b%9f%e4%b8%bb%e6%9c%ba" aria-label="基于端口的虚拟主机">基于端口的虚拟主机</a></li>
                <li>
                    <a href="#%e5%9f%ba%e4%ba%8eip%e7%9a%84%e8%99%9a%e6%8b%9f%e4%b8%bb%e6%9c%ba" aria-label="基于IP的虚拟主机">基于IP的虚拟主机</a></li>
                <li>
                    <a href="#%e6%b7%b7%e5%90%88%e8%99%9a%e6%8b%9f%e4%b8%bb%e6%9c%ba" aria-label="混合虚拟主机">混合虚拟主机</a></li></ul>
                </li>
                <li>
                    <a href="#%e6%97%a5%e5%bf%97%e6%a0%bc%e5%bc%8f" aria-label="日志格式">日志格式</a><ul>
                        
                <li>
                    <a href="#%e6%97%a5%e5%bf%97%e8%bd%ae%e8%af%a2" aria-label="日志轮询">日志轮询</a></li>
                <li>
                    <a href="#%e4%b8%8d%e8%ae%b0%e5%bd%95%e6%97%a5%e5%bf%97" aria-label="不记录日志">不记录日志</a></li></ul>
                </li>
                <li>
                    <a href="#%e9%9a%90%e8%97%8fhttpd%e7%89%88%e6%9c%ac%e5%8f%b7" aria-label="隐藏httpd版本号">隐藏httpd版本号</a><ul>
                        
                <li>
                    <a href="#%e9%9a%90%e8%97%8fphp%e7%89%88%e6%9c%ac%e5%8f%b7" aria-label="隐藏php版本号">隐藏php版本号</a></li></ul>
                </li>
                <li>
                    <a href="#http-fastcgi%e6%a8%a1%e5%bc%8f%e5%90%af%e5%8a%a8" aria-label="HTTP fastcgi模式启动">HTTP fastcgi模式启动</a></li>
                <li>
                    <a href="#httpd%e7%9a%84%e5%b7%a5%e4%bd%9c%e6%a8%a1%e5%bc%8f" aria-label="httpd的工作模式">httpd的工作模式</a><ul>
                        
                <li>
                    <a href="#workerperfor%e6%a8%a1%e5%bc%8f" aria-label="worker/perfor模式">worker/perfor模式</a></li>
                <li>
                    <a href="#prefork%e6%a8%a1%e5%bc%8f" aria-label="prefork模式">prefork模式</a><ul>
                        
                <li>
                    <a href="#%e5%b7%a5%e4%bd%9c%e5%8e%9f%e7%90%86" aria-label="工作原理">工作原理</a></li>
                <li>
                    <a href="#prefork%e9%85%8d%e7%bd%ae%e5%8f%82%e6%95%b0%e8%af%b4%e6%98%8e" aria-label="prefork配置参数说明">prefork配置参数说明</a></li></ul>
                </li>
                <li>
                    <a href="#worker%e6%a8%a1%e5%bc%8f" aria-label="worker模式">worker模式</a></li>
                <li>
                    <a href="#worker-%e6%a8%a1%e5%bc%8f%e9%85%8d%e7%bd%ae%e5%8f%82%e6%95%b0%e8%af%b4%e6%98%8e" aria-label="worker 模式配置参数说明">worker 模式配置参数说明</a></li></ul>
                </li>
                <li>
                    <a href="#%e9%85%8d%e7%bd%aehttpd%e5%af%b9%e7%ab%99%e7%82%b9%e6%96%87%e4%bb%b6%e5%8e%8b%e7%bc%a9" aria-label="配置httpd对站点文件压缩">配置httpd对站点文件压缩</a><ul>
                        
                <li>
                    <a href="#mod_deflate%e6%a8%a1%e5%9d%97%e4%bb%8b%e7%bb%8d" aria-label="mod_deflate模块介绍">mod_deflate模块介绍</a></li>
                <li>
                    <a href="#%e5%b8%b8%e8%a7%84%e6%96%b9%e6%b3%95%e5%ae%89%e8%a3%85" aria-label="常规方法安装">常规方法安装</a></li>
                <li>
                    <a href="#mod_deflate-dso%e5%ae%89%e8%a3%85%e6%96%b9%e6%b3%95" aria-label="mod_deflate DSO安装方法">mod_deflate DSO安装方法</a></li>
                <li>
                    <a href="#mod_deflate%e6%b5%8b%e8%af%95" aria-label="mod_deflate测试">mod_deflate测试</a></li></ul>
                </li>
                <li>
                    <a href="#mod_expires-%e7%bc%93%e5%ad%98%e5%8a%9f%e8%83%bd" aria-label="mod_expires 缓存功能">mod_expires 缓存功能</a><ul>
                        
                <li>
                    <a href="#%e5%b8%b8%e8%a7%84%e6%96%b9%e6%b3%95%e5%ae%89%e8%a3%85-1" aria-label="常规方法安装">常规方法安装</a></li>
                <li>
                    <a href="#mod_expires%e5%9c%a8httpd%e4%b8%ad%e5%ba%94%e7%94%a8" aria-label="mod_expires在httpd中应用">mod_expires在httpd中应用</a></li></ul>
                </li>
                <li>
                    <a href="#%e9%85%8d%e7%bd%aehttpd%e9%98%b2%e7%9b%97%e9%93%be%e5%8a%9f%e8%83%bd" aria-label="配置httpd防盗链功能">配置httpd防盗链功能</a><ul>
                        
                <li>
                    <a href="#httpd-web%e6%9c%8d%e5%8a%a1%e5%ae%9e%e7%8e%b0%e9%98%b2%e7%9b%97%e9%93%be" aria-label="httpd Web服务实现防盗链">httpd Web服务实现防盗链</a></li>
                <li>
                    <a href="#httpd%e5%b8%b8%e7%94%a8rewrite%e6%a0%87%e5%bf%97" aria-label="httpd常用Rewrite标志">httpd常用Rewrite标志</a></li></ul>
                </li>
                <li>
                    <a href="#%e7%a6%81%e6%ad%a2%e8%b5%84%e6%ba%90%e7%9b%ae%e5%bd%95%e8%a7%a3%e6%9e%90php%e7%a8%8b%e5%ba%8f" aria-label="禁止资源目录解析PHP程序">禁止资源目录解析PHP程序</a></li>
                <li>
                    <a href="#%e7%a6%81%e6%ad%a2%e7%9b%ae%e5%bd%95%e7%b4%a2%e5%bc%95%e6%b5%8f%e8%a7%88%e5%8a%9f%e8%83%bd" aria-label="禁止目录索引浏览功能">禁止目录索引浏览功能</a></li>
                <li>
                    <a href="#%e5%85%b3%e9%97%ad%e6%97%a0%e7%94%a8%e7%9a%84cgi%e5%8a%9f%e8%83%bd%e9%85%8d%e7%bd%ae" aria-label="关闭无用的CGI功能配置">关闭无用的CGI功能配置</a></li>
                <li>
                    <a href="#%e7%a6%81%e6%ad%a2httpd%e7%94%a8%e6%88%b7%e9%87%8d%e8%bd%bd%e5%8a%9f%e8%83%bd" aria-label="禁止httpd用户重载功能">禁止httpd用户重载功能</a></li>
                <li>
                    <a href="#%e9%81%bf%e5%85%8d%e4%bd%bf%e7%94%a8htaccess%e6%96%87%e4%bb%b6" aria-label="避免使用.htaccess文件">避免使用.htaccess文件</a></li>
                <li>
                    <a href="#%e5%a6%82%e4%bd%95%e5%af%b9httpd%e9%85%8d%e7%bd%ae%e4%bc%98%e5%8c%96" aria-label="如何对httpd配置优化？">如何对httpd配置优化？</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content">
    





<div class="copyrightTopBlock">
    <p>本文发布于<a href="https://www.oomkill.com/about" target="_blank">Cylon的收藏册</a>，转载请著名原文链接~</p>
    <div class="articleSuffix-bg"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 147.78 155.96"> <path d="M10.5,99.81a1.9,1.9,0,0,0-.53-.09,1.66,1.66,0,0,0-1.64,1.65A1.64,1.64,0,0,0,10,103a1.57,1.57,0,0,0,.87-.25l26.76,26.82.45-1.08L11.52,101.91A1.65,1.65,0,0,0,10.5,99.81Zm-.13,2a.57.57,0,0,1-.8,0,.58.58,0,0,1-.17-.41.58.58,0,0,1,.57-.57h0a.57.57,0,0,1,.56.58A.55.55,0,0,1,10.37,101.77Z" style="fill:#c5c9e0"></path><path d="M56.15,117.58H39.06l0-.09a1.65,1.65,0,0,0-1.36-1H37.5a1.65,1.65,0,1,0,1.56,2.19H55.7L92.92,156h41.44v-1.08h-41Zm-18.25.94a.56.56,0,0,1-.79,0,.58.58,0,0,1-.17-.41.57.57,0,0,1,.56-.57h0a.58.58,0,0,1,.57.58A.54.54,0,0,1,37.9,118.52Z" style="fill:#c5c9e0"></path><path d="M23.52,50.32a1.65,1.65,0,0,0,1.55-1.11H55.28l48-48.13h31.06V0H102.85l-48,48.13H25.07a1.64,1.64,0,0,0-2.09-1,1.64,1.64,0,0,0,.54,3.2Zm0-2.21a.57.57,0,0,1,0,1.13.57.57,0,1,1,0-1.13Z" style="fill:#c5c9e0"></path><polygon points="102.86 0 102.86 0 102.86 0 102.86 0" style="fill:#c5c9e0"></polygon><path d="M107.72,12.14h26.64V11.07H107.27L57.4,61H3.09a1.66,1.66,0,0,0-1.45-.86H1.52A1.65,1.65,0,1,0,2.81,63a1.59,1.59,0,0,0,.45-.87H57.85ZM2.05,62.23a.57.57,0,0,1-.8,0,.58.58,0,0,1-.17-.41.57.57,0,0,1,.56-.57h.09a.57.57,0,0,1,.32,1Z" style="fill:#c5c9e0"></path><path d="M134.36,43.22V42.14h-22.3l-9.62,9.63a1.64,1.64,0,0,0-2.19.77,1.61,1.61,0,0,0-.17.71,1.65,1.65,0,1,0,3.29,0,1.61,1.61,0,0,0-.16-.72l9.3-9.32Zm-32.64,10.6a.57.57,0,0,1,0-1.13.57.57,0,0,1,0,1.13Z" style="fill:#c5c9e0"></path><path d="M147,52.3l-9,9H111.48a1.64,1.64,0,0,0-1.61-1.33h-.14a1.65,1.65,0,1,0,1.6,2.41h27.19l9.26-9.29L147,52.3Zm-37.15,9.85a.56.56,0,0,1-.56-.57h0a.56.56,0,0,1,.56-.56h0a.57.57,0,1,1,0,1.13Z" style="fill:#c5c9e0"></path><path d="M66.79,75.35l11,11.06h56.53V85.33H78.27l-11-11.06H49.49L37.12,86.67a1.64,1.64,0,0,0-2.09,1,1.61,1.61,0,0,0-.09.54,1.65,1.65,0,0,0,3.29,0,1.68,1.68,0,0,0-.26-.89l12-12ZM36.58,88.79a.57.57,0,1,1,.57-.56A.57.57,0,0,1,36.58,88.79Z" style="fill:#c5c9e0"></path><path d="M110.61,95.55,92.8,113.4a1.62,1.62,0,1,0,.77.76l17.49-17.53h23.31V95.55ZM92.49,115.28a.56.56,0,0,1-.8,0,.58.58,0,0,1-.17-.41.57.57,0,0,1,.57-.57h0a.58.58,0,0,1,.56.58A.55.55,0,0,1,92.49,115.28Z" style="fill:#c5c9e0"></path><path d="M97.89,122.3H76.62L64.2,109.85a1.65,1.65,0,0,0-.77-2.2,1.77,1.77,0,0,0-.72-.17h-.14a1.65,1.65,0,0,0,.15,3.29,1.58,1.58,0,0,0,.71-.17l12.74,12.77H98.34l17.48-17.52h18.54v-1.08h-19ZM63.12,109.53a.56.56,0,0,1-.8,0,.58.58,0,0,1-.17-.41.57.57,0,0,1,1.14,0A.54.54,0,0,1,63.12,109.53Z" style="fill:#c5c9e0"></path> </svg> </div>
</div>
<br><p>httpd下载地址：<a href="https://archive.apache.org/dist/httpd/" target="_blank"
   rel="noopener nofollow noreferrer" >Historical releases</a></p>
<h2 id="安装httpd">安装httpd<a hidden class="anchor" aria-hidden="true" href="#安装httpd">¶</a></h2>
<pre><code class="language-bash">$ ls
ABOUT_APACHE  buildconf	emacs-style  INSTALL			LICENSE			os		srclib
acinclude.m4  CHANGES		httpd.dep    InstallBin.dsp  	Makefile.in    README 	support
Apache.dsw    config.layout  httpd.dsp LAYOUT          	Makefile.win   README.platforms test
build    configure  httpd.mak  libhttpd.dep  modules    README-win32.txt  VERSIONING
BuildAll.dsp  configure.in   httpd.spec   libhttpd.dsp    NOTICE   ROADMAP
BuildBin.dsp  docs            include      libhttpd.mak    NWGNUmakefile  server
</code></pre>
<h3 id="httpd-编译参数">httpd 编译参数<a hidden class="anchor" aria-hidden="true" href="#httpd-编译参数">¶</a></h3>
<table>
<thead>
<tr>
<th>参数选项</th>
<th>注释说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>./configure</td>
<td>配置源代码树</td>
</tr>
<tr>
<td>–prefix=/usr/local/apache2</td>
<td>体系无关文件的顶级安装目录PREFIX，也就Apache的安装目录。</td>
</tr>
<tr>
<td>–enable-module=so [-enable-deflate]</td>
<td>打开so模块，so模块是用来提DSO支持的apache核心模块</td>
</tr>
<tr>
<td>–enable-deflate=shared  [-enable-expires]</td>
<td>支持网页压缩</td>
</tr>
<tr>
<td>–enable-expires=shared  [-enable-rewrite]</td>
<td>支持缓存过期控制</td>
</tr>
<tr>
<td>–enable-rewrite=shared</td>
<td>支持URL重写</td>
</tr>
<tr>
<td>–enable-cache</td>
<td>支持缓存</td>
</tr>
<tr>
<td>–enable-file-cache</td>
<td>支持文件缓存</td>
</tr>
<tr>
<td>–enable-mem-cache</td>
<td>支持记忆缓存</td>
</tr>
<tr>
<td>–enable-disk-cache</td>
<td>支持磁盘缓存</td>
</tr>
<tr>
<td>–enable-static-support</td>
<td>支持静态连接(默认为动态连接)</td>
</tr>
<tr>
<td>–enable-static-htpasswd</td>
<td>使用静态连接编译htpasswd–管理用于基本认证的用户文件</td>
</tr>
<tr>
<td>–enable-static-htdigest</td>
<td>使用静态连接编译htdigest–管理用于摘要认证的用户文件</td>
</tr>
<tr>
<td>–enable-static-rotatelogs</td>
<td>使用静态连接编译rotatelogs–滚动Apache日志的管道日志程序</td>
</tr>
<tr>
<td>–enable-static-logresolve</td>
<td>使用静态连接编译logresolve–解析Apache日志中的IP地址为主机名</td>
</tr>
<tr>
<td>–enable-static-htdbm</td>
<td>使用静态连接编译htdbm–操作DBM密码数据库</td>
</tr>
<tr>
<td>–enable-static-ab</td>
<td>使用静态连接编译ab–Apache服务器性能测试工具</td>
</tr>
<tr>
<td>–enable-static-checkgid</td>
<td>使用静态连接编译checkgid</td>
</tr>
<tr>
<td>–disable-cgid</td>
<td>禁止用一个外部CGI守护进程执行CGI脚本</td>
</tr>
<tr>
<td>–disable-cgi</td>
<td>禁止编译CGI版本的PHP</td>
</tr>
<tr>
<td>–disable-userdir</td>
<td>禁止用户从自己的主目录中提供页面</td>
</tr>
<tr>
<td>–with-mpm=worker</td>
<td>让apache以worker方式运行</td>
</tr>
<tr>
<td>–enable-authn-dbm=shared</td>
<td>对动态数据库进行操作。Rewrite时需要。</td>
</tr>
<tr>
<td><strong>以下是分门别类的更多参数注解，与上面的会有重复</strong></td>
<td></td>
</tr>
<tr>
<td><strong>用于apr的configure脚本的选项</strong>：</td>
<td></td>
</tr>
<tr>
<td><strong>可选特性</strong></td>
<td></td>
</tr>
<tr>
<td>&ndash;enable-experimental-libtool</td>
<td>启用试验性质的自定义libtool</td>
</tr>
<tr>
<td>&ndash;disable-libtool-lock</td>
<td>取消锁定(可能导致并行编译崩溃)</td>
</tr>
<tr>
<td>&ndash;enable-debug</td>
<td>启用调试编译，仅供开发人员使用。</td>
</tr>
<tr>
<td>&ndash;enable-maintainer-mode</td>
<td>打开调试和编译时警告，仅供开发人员使用。</td>
</tr>
<tr>
<td>&ndash;enable-profile</td>
<td>打开编译profiling(GCC)</td>
</tr>
<tr>
<td>&ndash;enable-pool-debug[=yes|no|verbose|verbose-alloc|lifetime|owner|all]</td>
<td>打开pools调试</td>
</tr>
<tr>
<td>&ndash;enable-malloc-debug</td>
<td>打开BeOS平台上的malloc_debug</td>
</tr>
<tr>
<td>&ndash;disable-lfs</td>
<td>在32-bit平台上禁用大文件支持(large file support)</td>
</tr>
<tr>
<td>&ndash;enable-nonportable-atomics</td>
<td>若只打算在486以上的CPU上运行Apache，那么使用该选项可以启用更加高效的基于互斥执行 的原子操作。</td>
</tr>
<tr>
<td>&ndash;enable-threads</td>
<td>启用线程支持在线程型的MPM上必须打开它</td>
</tr>
<tr>
<td>&ndash;disable-threads</td>
<td>禁用线程支持，如果不使用线程化的MPM，可以关闭它以减少系统开销。</td>
</tr>
<tr>
<td>&ndash;disable-dso</td>
<td>禁用DSO支持</td>
</tr>
<tr>
<td>&ndash;enable-other-child</td>
<td>启用可靠子进程支持</td>
</tr>
<tr>
<td>&ndash;disable-ipv6</td>
<td>禁用IPv6支持</td>
</tr>
<tr>
<td>*<strong>*<em>可选的额外程序包*</em>*</strong></td>
<td></td>
</tr>
<tr>
<td>&ndash;with-gnu-ld</td>
<td>指定C编译器使用GNU ld</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td>&ndash;with-pic</td>
<td>只使PIC/non-PIC对象[默认为两者都使用]</td>
</tr>
<tr>
<td>&ndash;with-tags[=TAGS]</td>
<td>包含额外的配置</td>
</tr>
<tr>
<td>&ndash;with-installbuilddir=DIR</td>
<td>指定APR编译文件的存放位置(默认值为：’${datadir}/build’)</td>
</tr>
<tr>
<td>&ndash;without-libtool</td>
<td>禁止使用libtool连接库文件</td>
</tr>
<tr>
<td>&ndash;with-efence[=DIR]</td>
<td>指定Electric Fence的安装目录</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td>&ndash;with-sendfile</td>
<td>强制使用sendfile(译者注：Linux2.4/2.6内核都支持)</td>
</tr>
<tr>
<td>&ndash;with-egd[=DIR]</td>
<td>使用EDG兼容的socket</td>
</tr>
<tr>
<td>&ndash;with-devrandom[=DEV]</td>
<td>指定随机设备[默认为：/dev/random]</td>
</tr>
<tr>
<td><em><strong>用于apr-util的configure脚本的选项</strong></em> ：</td>
<td></td>
</tr>
<tr>
<td><strong>可选的额外程序包</strong></td>
<td></td>
</tr>
<tr>
<td>&ndash;with-apr=PATH</td>
<td>指定APR的安装目录(–prefix选项值或apr-config的路径)</td>
</tr>
<tr>
<td>&ndash;with-ldap-include=PATH</td>
<td>ldap包含文件目录(带结尾斜线)</td>
</tr>
<tr>
<td>&ndash;with-ldap-lib=PATH</td>
<td>ldap库文件路径</td>
</tr>
<tr>
<td>&ndash;with-ldap=library</td>
<td>使用的ldap库</td>
</tr>
<tr>
<td>&ndash;with-dbm=DBM</td>
<td>选择使用的DBM类型DBM={sdbm,gdbm,ndbm,db,db1,db185,db2,db3,db4,db41,db42,db43,db44}</td>
</tr>
<tr>
<td>&ndash;with-gdbm=PATH</td>
<td>指定GDBM的位置</td>
</tr>
<tr>
<td>&ndash;with-ndbm=PATH</td>
<td>指定NDBM的位置</td>
</tr>
<tr>
<td>&ndash;with-berkeley-db=PATH</td>
<td>指定Berkeley DB的位置</td>
</tr>
<tr>
<td>&ndash;with-pgsql=PATH</td>
<td>指定PostgreSQL的位置</td>
</tr>
<tr>
<td>&ndash;with-mysql=PATH</td>
<td>参看INSTALL.MySQL文件的内容</td>
</tr>
<tr>
<td>&ndash;with-sqlite3=PATH</td>
<td>指定sqlite3的位置</td>
</tr>
<tr>
<td>&ndash;with-sqlite2=PATH</td>
<td>指定sqlite2的位置</td>
</tr>
<tr>
<td>&ndash;with-expat=PATH</td>
<td>指定Expat的位置或builtin</td>
</tr>
<tr>
<td>&ndash;with-iconv=PATH</td>
<td>iconv的安装目录</td>
</tr>
</tbody>
</table>
<p>关于 2.2 编译参数</p>
<pre><code class="language-bash"> ./configure \
    --prefix=/app/apache2.4.28 \
    --enable-deflate \
    --enable-expires \
    --enable-headers \
    --enable-modules=most \
    --enable-so \
    --with-mpm=worker \
    --enable-rewrite
</code></pre>
<p>关于 2.4 编译参数</p>
<pre><code class="language-BASH">./configure \
    --prefix=/app/apache-2.4.25.1 \
    --enable-so \
    --enable-deflate=shared \
    --enable-ssl=shared \
    --enable-expires=shared \
    --enable-headers=shared \
    --enable-rewrite=shared \
    --enable-static-support \
    --with-included-apr \
    --with-mpm=worker
</code></pre>
<h3 id="开始安装httpd">开始安装httpd<a hidden class="anchor" aria-hidden="true" href="#开始安装httpd">¶</a></h3>
<p>先安装依赖包</p>
<pre><code class="language-bash">yum -y install \
	gcc \
	gcc-c++ \
	openssl-devel \
	zlib-devel \
	pcre-devel 
</code></pre>
<h3 id="troubleshooting">Troubleshooting<a hidden class="anchor" aria-hidden="true" href="#troubleshooting">¶</a></h3>
<h4 id="configure-error-bundled-apr-requested-but-not-found">configure: error: Bundled APR requested but not found<a hidden class="anchor" aria-hidden="true" href="#configure-error-bundled-apr-requested-but-not-found">¶</a></h4>
<pre><code class="language-bash">configure: error: Bundled APR requested but not found at ./srclib/. Download and unpack the corresponding apr and apr-util packages to ./srclib/.
</code></pre>
<p>编译时需要下载 <code>apr</code> 和 <code>apr-util</code> 解压到 <code>httpd/srclib/</code> 目录里 <a href="http://apr.apache.org/download" target="_blank"
   rel="noopener nofollow noreferrer" >http://apr.apache.org/download</a></p>
<h4 id="error-pcre_dupnames-undeclared-first-use-in-this-function">error: &lsquo;PCRE_DUPNAMES&rsquo; undeclared (first use in this function)<a hidden class="anchor" aria-hidden="true" href="#error-pcre_dupnames-undeclared-first-use-in-this-function">¶</a></h4>
<p>网上搜了下说是yum安装的pcre的版本太老了，不支持PCRE_DUPNAMES 和 PCRE_JAVASCRIPT_COMPAT 这样的PCRE特性。好吧，我去下个最新版的pcre来编译安装。</p>
<p>解决方法：编译安装pcre后，我们重新对httpd-2.4.9执行编译,这下就不会继续报错.</p>
<pre><code class="language-bash">wget ftp://ftp.csx.cam.ac.uk/pub/software/programming/pcre/pcre-8.35.tar.gz
tar zxf pcre-8.35.tar.gz &amp;&amp; cd pcre-8.35
./configure
make &amp;&amp; make install
</code></pre>
<h4 id="cannot-restore-segment-prot-after-reloc-permission-denied">cannot restore segment prot after reloc: Permission denied<a hidden class="anchor" aria-hidden="true" href="#cannot-restore-segment-prot-after-reloc-permission-denied">¶</a></h4>
<p>错误如下：</p>
<pre><code class="language-bash">httpd: Syntax error on line 149 of /usr/local/apache/conf/httpd.conf: Cannot load modules/libphp5.so into server: /usr/local/apache/modules/libphp5.so: cannot restore segment prot after reloc: Permission denied
</code></pre>
<p>解决方法：很明显的selinux的权限问题</p>
<pre><code class="language-bash">chown -R apache:apache /usr/local/apache
setenforce 0
chcon -c -v -R -u system_u -r object_r -t textrel_shlib_t /usr/local/apache/modules/libphp5.so
</code></pre>
<h4 id="configure-warning-openssl-version-is-too-old">configure: WARNING: OpenSSL version is too old<a hidden class="anchor" aria-hidden="true" href="#configure-warning-openssl-version-is-too-old">¶</a></h4>
<p>错误现象：CentOS 6.x</p>
<pre><code class="language-bash">checking for OpenSSL version &gt;= 0.9.8a... FAILED
configure: WARNING: OpenSSL version is too old
no
checking whether to enable mod_ssl... configure: error: mod_ssl has been requested but can not be built due to prerequisite failures
</code></pre>
<p>解决方法：</p>
<pre><code class="language-bash">yum install openssl openssl-devel
</code></pre>
<h4 id="zlib-location-not-found">zlib location&hellip; not found<a hidden class="anchor" aria-hidden="true" href="#zlib-location-not-found">¶</a></h4>
<p>错误现象：</p>
<pre><code class="language-bash">checking for zlib location... not found
checking whether to enable mod_deflate... configure: error: mod_deflate has been requested but can not be built due to prerequisite failures
</code></pre>
<p>解决方法</p>
<pre><code class="language-bash">yum install zlib zlib-devel -y
</code></pre>
<h4 id="no-acceptable-c-compiler-found-in-path">no acceptable C compiler found in $PATH<a hidden class="anchor" aria-hidden="true" href="#no-acceptable-c-compiler-found-in-path">¶</a></h4>
<p>错误现象：</p>
<pre><code class="language-bash">configure: error: no acceptable C compiler found in $PATH
</code></pre>
<p>解决方法：gcc工具没安装，或开发工具包没安装 [CentOS 6.x]</p>
<pre><code class="language-bash">yum groupinstall &quot;Development tools&quot; -y
yum install gcc -y
</code></pre>
<h4 id="httpd-could-not-reliably-determine-the-servers-fully-qualified-domain-name">httpd: Could not reliably determine the server&rsquo;s fully qualified domain name,<a hidden class="anchor" aria-hidden="true" href="#httpd-could-not-reliably-determine-the-servers-fully-qualified-domain-name">¶</a></h4>
<p>错误现象：</p>
<pre><code class="language-bash">$ ./bin/apachectl graceful
httpd: apr_sockaddr_info_get() failed for web-lamp01
httpd: Could not reliably determine the server's fully qualified domain name, using 127.0.0.1 for ServerName
</code></pre>
<p>错误原因：找不到完整的 <code>fqdn www.etiantian.com</code> 为一个完整的 fqdn 使用 127.0.0.1 替代</p>
<p>解决方法：在 <code>httpd.conf</code> 如果没有注册的DNS域名，用IP地址替换它</p>
<h3 id="启动参数">启动参数<a hidden class="anchor" aria-hidden="true" href="#启动参数">¶</a></h3>
<p>apachectl参数</p>
<table>
<thead>
<tr>
<th>选项参数</th>
<th>注释说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>configtest</td>
<td>检查设置文件中的语法是否正确。</td>
</tr>
<tr>
<td>fullstatus</td>
<td>显示服务器完整的状态信息。</td>
</tr>
<tr>
<td>graceful</td>
<td>重新启动Apache服务器，但不会中断原有的连接。</td>
</tr>
<tr>
<td>help</td>
<td>显示帮助信息。</td>
</tr>
<tr>
<td>restart</td>
<td>重新启动Apache服务器。</td>
</tr>
<tr>
<td>start</td>
<td>启动Apache服务器。</td>
</tr>
<tr>
<td>status</td>
<td>显示服务器摘要的状态信息。</td>
</tr>
<tr>
<td>stop</td>
<td>停止Apache服务器。</td>
</tr>
</tbody>
</table>
<p>httpd参数</p>
<table>
<thead>
<tr>
<th>参数选项</th>
<th>注释说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>-c</td>
<td>&lt;httpd指令&gt;  在读取配置文件前，先执行选项中的指令。</td>
</tr>
<tr>
<td>-C</td>
<td>&lt;httpd指令&gt;  在读取配置文件后，再执行选项中的指令。</td>
</tr>
<tr>
<td>-d</td>
<td>&lt;服务器根目录&gt;  指定服务器的根目录。</td>
</tr>
<tr>
<td>-D</td>
<td>&lt;设定文件参数&gt;  指定要传入配置文件的参数。</td>
</tr>
<tr>
<td>-f</td>
<td>&lt;设定文件&gt;  指定配置文件。</td>
</tr>
<tr>
<td>-h</td>
<td>显示帮助。</td>
</tr>
<tr>
<td>-l</td>
<td>显示服务器编译时所包含的模块。</td>
</tr>
<tr>
<td>-L</td>
<td>显示httpd指令的说明。</td>
</tr>
<tr>
<td>-S</td>
<td>显示配置文件中的设定。</td>
</tr>
<tr>
<td>-t</td>
<td>测试配置文件的语法是否正确。</td>
</tr>
<tr>
<td>-v</td>
<td>显示版本信息。</td>
</tr>
<tr>
<td>-V</td>
<td>显示版本信息以及建立环境。</td>
</tr>
<tr>
<td>-X</td>
<td>以单一程序的方式来启动服务器。</td>
</tr>
</tbody>
</table>
<pre><code class="language-bash">$ /app/apache/bin/apachectl start

$ lsof -i:80
COMMAND  PID   USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
httpd   5871   root    4u  IPv6  69297      0t0  TCP *:http (LISTEN)
httpd   5873 daemon    4u  IPv6  69297      0t0  TCP *:http (LISTEN)
httpd   5874 daemon    4u  IPv6  69297      0t0  TCP *:http (LISTEN)
httpd   5875 daemon    4u  IPv6  69297      0t0  TCP *:http (LISTEN)

$ ps -ef|grep httpd
root      5871     1  0 03:12 ?        00:00:00 /app/apache2.2.27/bin/httpd -k start
daemon    5872  5871  0 03:12 ?        00:00:00 /app/apache2.2.27/bin/httpd -k start
daemon    5873  5871  0 03:12 ?        00:00:00 /app/apache2.2.27/bin/httpd -k start
daemon    5874  5871  0 03:12 ?        00:00:00 /app/apache2.2.27/bin/httpd -k start
daemon    5875  5871  0 03:12 ?        00:00:00 /app/apache2.2.27/bin/httpd -k start
root      5960  2056  0 03:12 pts/0    00:00:00 grep --color=auto httpd
</code></pre>
<h3 id="httpd目录结构">httpd目录结构<a hidden class="anchor" aria-hidden="true" href="#httpd目录结构">¶</a></h3>
<pre><code class="language-bash">$ tree -L 1

.
├── bin #这是apache命令目录，如apache启动命令apachectl
      ├── ab #压力测试工具 同类软件还有jmeter loadrunner webench等
  ├── apachectl  #apache启动命令，需重点掌握，apachectl是一个脚本
      ├── apxs # apxs是一个为Apache HTTP服务器编译和安装扩展模块的工具，在进行DOS当时编译模块时会用到 
      ├── htcacheclean #这是清理磁盘缓冲区的命令，需要在编译时指定相关参数才可以使用，一般很少用
      ├── htpasswd # 建立和更新基本认证文件，如：配置nagios等监控服务时会用到
      ├── httpd #httpd为apache的控制命令程序，apachectl执行时会调用httpd
      └── rotatelogs #apache自带的日志轮询命令，其他未使用过的略过未提级，以便大家学习主要的命令
├── build
├── cgi-bin
├── conf # apache所有配置文件的目录
  ├── extra # 额外的apache配置目录，这个目录里的文件我们会经常访问修改，如：httpd-vhosts.conf默认就在此目录
  ├── httpd.conf #apache的主配置文件，这个文件我们会经常访问修改，其中的每一行的参数作用都应该闹明白
  ├── magic
  ├── mime.types
  └── original

├── error
├── htdocs # 默认的apache的站点目录
├── icons
├── include
├── lib
├── logs # 这个时apache的日志默认路径，包括错误日志及访问日志
  ├── access_log #这是apache的默认访问日志
  ├── cgisock.5871
  ├── error_log # apache的错误日志
  └── httpd.pid # httpd的pid文件，httpd进程启动后，会把所有的进程号ID写到此文件
├── man
├── manual
└── modules # apache模块的目录，如memcache
</code></pre>
<h3 id="httpd主配置文件说明">httpd主配置文件说明<a hidden class="anchor" aria-hidden="true" href="#httpd主配置文件说明">¶</a></h3>
<pre><code class="language-bash">grep -Ev &quot;#|^$&quot; httpd.conf &gt;httpd.conf.ori
</code></pre>
<pre><code class="language-bash"># 服务的根目录 软件安装到哪
ServerRoot &quot;/app/apache2.2.27&quot;

# web服务监听的端口 监听的ip默认为本机的所有ip地址 listen可以为多个，也可以指定ip
# 没有listen端口是开启不了的
Listen 80
Listen 8000
Listen 192.168.59.1:90 # 如不加默认为所有

&lt;IfModule !mpm_netware_module&gt;
&lt;IfModule !mpm_winnt_module&gt;

User daemon # 编译安装软件默认用户是daemon 用户
Group daemon #组
&lt;/IfModule&gt;
&lt;/IfModule&gt;

#管理员的邮箱 当前网站出问题了，会在页面显示
ServerAdmin you@example.com

# 默认的站点目录
DocumentRoot &quot;/app/apache2.2.27/htdocs&quot;

# 权限控制 表示根目录拒绝其他人访问
&lt;Directory /&gt;
    Options FollowSymLinks #带符号连接
    AllowOverride None #禁止相关的功能 如.htaccess
    Order deny,allow #不让任何人访问这个目录
    Deny from all 
&lt;/Directory&gt;

# 如果新增加一个站点目录必须增加这6行，否则网站打不开
&lt;Directory &quot;/app/apache2.2.27/htdocs&quot;&gt;
    Options Indexes FollowSymLinks #Indexs 没有index展示所有目录
    AllowOverride None
    Order allow,deny
    Allow from all
&lt;/Directory&gt;

# 指定访问的首页 如果有多个用空格分开
&lt;IfModule dir_module&gt;
    DirectoryIndex index.html index.php
&lt;/IfModule&gt;


&lt;FilesMatch &quot;^\.ht&quot;&gt;
    Order allow,deny
    Deny from all
    Satisfy All
&lt;/FilesMatch&gt;

#错误日志
ErrorLog &quot;logs/error_log&quot;

#日志级别 警告
LogLevel warn

#访问日志的类型
&lt;IfModule log_config_module&gt;
    LogFormat &quot;%h %l %u %t \&quot;%r\&quot; %&gt;s %b \&quot;%{Referer}i\&quot; \&quot;%{User-Agent}i\&quot;&quot; combined
    LogFormat &quot;%h %l %u %t \&quot;%r\&quot; %&gt;s %b&quot; common
    &lt;IfModule logio_module&gt;
      LogFormat &quot;%h %l %u %t \&quot;%r\&quot; %&gt;s %b \&quot;%{Referer}i\&quot; \&quot;%{User-Agent}i\&quot; %I %O&quot; combinedio
    &lt;/IfModule&gt;
    CustomLog &quot;logs/access_log&quot; common
&lt;/IfModule&gt;

# cgi的配置 现在已经过时了，工作中应该删掉
&lt;IfModule alias_module&gt;
    ScriptAlias /cgi-bin/ &quot;/app/apache2.2.27/cgi-bin/&quot;
&lt;/IfModule&gt;
&lt;IfModule cgid_module&gt;
&lt;/IfModule&gt;
&lt;Directory &quot;/app/apache2.2.27/cgi-bin&quot;&gt;
    AllowOverride None
    Options None
    Order allow,deny
    Allow from all
&lt;/Directory&gt;

# 缺省的类型
DefaultType text/plain

#添加的类型，对什么类型做什么控制
&lt;IfModule mime_module&gt;
    TypesConfig conf/mime.types
     AddType application/x-compress .Z
    AddType application/x-gzip .gz .tgz
&lt;/IfModule&gt;
&lt;IfModule ssl_module&gt;
SSLRandomSeed startup builtin
SSLRandomSeed connect builtin
&lt;/IfModule&gt;
</code></pre>
<h3 id="httpd的扩展配置文件">httpd的扩展配置文件<a hidden class="anchor" aria-hidden="true" href="#httpd的扩展配置文件">¶</a></h3>
<pre><code class="language-bash">$ ll
总用量 56
-rw-r--r--. 1 root root  2843 4月   8 03:03 httpd-autoindex.conf
-rw-r--r--. 1 root root  1713 4月   8 03:03 httpd-dav.conf
-rw-r--r--. 1 root root  2344 4月   8 03:03 httpd-default.conf
-rw-r--r--. 1 root root  1103 4月   8 03:03 httpd-info.conf
-rw-r--r--. 1 root root  5078 4月   8 03:03 httpd-languages.conf
-rw-r--r--. 1 root root   933 4月   8 03:03 httpd-manual.conf
-rw-r--r--. 1 root root  3789 4月   8 03:03 httpd-mpm.conf
-rw-r--r--. 1 root root  2183 4月   8 03:03 httpd-multilang-errordoc.conf
-rw-r--r--. 1 root root 11378 4月   8 03:03 httpd-ssl.conf
-rw-r--r--. 1 root root   817 4月   8 03:03 httpd-userdir.conf
-rw-r--r--. 1 root root  1491 4月   8 03:03 httpd-vhosts.conf
</code></pre>
<p>mpm</p>
<pre><code class="language-bash">--with-mpm=worker \
&lt;IfModule mpm_prefork_module&gt;
    StartServers          5
    MinSpareServers       5
    MaxSpareServers      10
    MaxClients          150
    MaxRequestsPerChild   0
&lt;/IfModule&gt;
# 如果指定了worker就是woker，否则是prefork
&lt;IfModule mpm_worker_module&gt;
    StartServers          2
    MaxClients          150
    MinSpareThreads      25
    MaxSpareThreads      75
    ThreadsPerChild      25
    MaxRequestsPerChild   0
&lt;/IfModule&gt;
</code></pre>
<p>defalut配置文件</p>
<pre><code class="language-bash">$ grep -Ev &quot;#|^$&quot; httpd-default.conf 
# 连接超时
Timeout 300
#保持连接的状态
KeepAlive On
#最大接受多少个永久连接
MaxKeepAliveRequests 100
#在同一个连接上，等待下一个请求的时间
KeepAliveTimeout 5
UseCanonicalName Off
#将伪静态的语法写在这个里面
AccessFileName .htaccess
#隐藏apache版本号，不同意被攻击
ServerTokens Full
ServerSignature On
HostnameLookups Off
</code></pre>
<h2 id="虚拟主机">虚拟主机<a hidden class="anchor" aria-hidden="true" href="#虚拟主机">¶</a></h2>
<p>所谓基于 ”x“ 的虚拟主机，就是靠 ”x“ 来区分不同的站点。支持各种混合，N多个虚拟主机</p>
<h3 id="基于域名的虚拟主机">基于域名的虚拟主机★★★★★<a hidden class="anchor" aria-hidden="true" href="#基于域名的虚拟主机">¶</a></h3>
<p>建立三个站点</p>
<ul>
<li><code>www.etiantian.com</code>	 &mdash;&mdash;    <code>/var/html/www</code></li>
<li><code>blog.etiantian.com</code>   &mdash;&mdash;   <code>/var/html/blog</code></li>
<li><code>bbs.etiantian.com</code>     &mdash;&mdash;  <code>/var/html/bbs</code></li>
</ul>
<p>步骤1：在 <code>httpd.conf</code> 中打开 <code>Include conf/extra/httpd-vhosts.conf</code></p>
<p>步骤2：在 <code>extra</code> 中的 <code>vhost </code> 中添加三个虚拟主机</p>
<pre><code class="language-conf">&lt;VirtualHost *:80&gt;
    ServerAdmin test.com@gmail.com
    DocumentRoot &quot;/var/html/www&quot;
    ServerName www.etiantian.com
    ErrorLog &quot;logs/www_error_log&quot;
    CustomLog &quot;logs/www_access_log&quot; common
&lt;/VirtualHost&gt;

&lt;VirtualHost *:80&gt;
    ServerAdmin test.com@gmail.com
    DocumentRoot &quot;/var/html/blog&quot;
    ServerName blog.etiantian.com
    ErrorLog &quot;logs/blog_error_log&quot;
    CustomLog &quot;logs/blog_access_log&quot; common
&lt;/VirtualHost&gt;

&lt;VirtualHost *:80&gt;
    ServerAdmin test.com@gmail.com
    DocumentRoot &quot;/var/html/bbs&quot;
    ServerName bbs.etiantian.com
    ErrorLog &quot;logs/bbs_error_log&quot;
    CustomLog &quot;logs/bbs_access_log&quot; common
&lt;/VirtualHost&gt;
</code></pre>
<p>步骤3：在主配置文件，或在 <code>&lt;VirtualHost&gt;</code> 里配置权限</p>
<pre><code class="language-conf">&lt;Directory &quot;/var/html&quot;&gt;
    Options FollowSymLinks
    AllowOverride None
    Order allow,deny
    Allow from all
&lt;/Directory&gt;
</code></pre>
<p>如果配置为 <code>Options Indexes FollowSymLinks</code> 则显示为下图所示</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed//img/image-20221202162523234.png" alt="image-20221202162523234" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<p>如果配置为 <code>Options -Indexes FollowSymLinks</code> 则显示为下图所示</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed//img/wps65.tmp.jpg" alt="img" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<h3 id="基于端口的虚拟主机">基于端口的虚拟主机<a hidden class="anchor" aria-hidden="true" href="#基于端口的虚拟主机">¶</a></h3>
<p>一般来讲是内部网站</p>
<ul>
<li>优点：安全一些，别人找不到</li>
</ul>
<p>步骤1：在 <code>httpd.conf</code> 中增加监听端口</p>
<pre><code class="language-conf">Listen 80
Listen 8000
Listen 9000
</code></pre>
<p>步骤1：在 <code>vhost</code> 文件中增加</p>
<pre><code class="language-conf">NameVirtualHost *:80
NameVirtualHost *:8000

&lt;VirtualHost *:8000&gt;
</code></pre>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed//img/image-20221202162815605.png" alt="image-20221202162815605" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<h3 id="基于ip的虚拟主机">基于IP的虚拟主机<a hidden class="anchor" aria-hidden="true" href="#基于ip的虚拟主机">¶</a></h3>
<p>步骤1：配置别名ip</p>
<pre><code class="language-bash">ifconfig eth0:0 192.168.59.140/24
</code></pre>
<p>步骤2：1.修改 <code>vhost</code> 文件虚拟主机配置</p>
<pre><code class="language-conf">&lt;VirtualHost 192.168.59.140:80&gt;
    ServerAdmin test.com@gmail.com
    DocumentRoot &quot;/var/html/blog&quot;
    ServerName 192.168.59.140
    ErrorLog &quot;logs/blog_error_log&quot;
    CustomLog &quot;logs/blog_access_log&quot; common
&lt;/VirtualHost&gt;
</code></pre>
<h3 id="混合虚拟主机">混合虚拟主机<a hidden class="anchor" aria-hidden="true" href="#混合虚拟主机">¶</a></h3>
<pre><code class="language-conf">&lt;VirtualHost 192.168.59.140:900&gt;
    ServerAdmin test.com@gmail.com
    DocumentRoot &quot;/var/html/blog&quot;
    ServerName 192.168.59.140
    ErrorLog &quot;logs/blog_error_log&quot;
    CustomLog &quot;logs/blog_access_log&quot; common
&lt;/VirtualHost&gt;
</code></pre>
<h2 id="日志格式">日志格式<a hidden class="anchor" aria-hidden="true" href="#日志格式">¶</a></h2>
<ul>
<li>通用日志格式Common Log Format</li>
<li>组合日志格式Combinded Log Format</li>
</ul>
<pre><code class="language-conf">LogFormat &quot;%h %l %u %t \&quot;%r\&quot; %&gt;s %b \&quot;%{Referer}i\&quot; \&quot;%{User-Agent}i\&quot;&quot; combined
LogFormat &quot;%h %l %u %t \&quot;%r\&quot; %&gt;s %b&quot; common
</code></pre>
<p>如何使用combined或common呢？</p>
<p>答：在虚拟主机配置中更改格式</p>
<pre><code class="language-conf">&lt;VirtualHost *:80&gt;
    ServerAdmin test.com@gmail.com
    DocumentRoot &quot;/var/html/www&quot;
    ServerName www.etiantian.com
    ErrorLog &quot;logs/www_error_log&quot;
    CustomLog &quot;logs/www_access_log&quot; common/combind
&lt;/VirtualHost&gt;
</code></pre>
<h3 id="日志轮询">日志轮询<a hidden class="anchor" aria-hidden="true" href="#日志轮询">¶</a></h3>
<ul>
<li>rotatelog</li>
<li>cronolog ☆☆☆</li>
</ul>
<p>安装 cronolog</p>
<pre><code class="language-bash">./configure
make  
make install

$ which cronolog
/usr/local/sbin/cronolog
</code></pre>
<p><strong>如果用cronolog轮询的的话最好用全路径</strong></p>
<pre><code class="language-bash">CustomLog &quot;|/usr/local/sbin/cronolog  /app/logs/access_bbs_%Y%m%d.log&quot; combined

$ mkdir /app/logs -p
$ ../bin/apachectl graceful
</code></pre>
<p>日志轮询除了可以使用年月日还可以使用周</p>
<pre><code class="language-bash">CustomLog &quot;|/usr/local/sbin/cronolog  /app/logs/access_bbs_%w.log&quot; combined
</code></pre>
<p><strong>时间格式串</strong>：</p>
<table>
<thead>
<tr>
<th>时间格式串</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>%H</td>
<td>24小时制小时(00..23)</td>
</tr>
<tr>
<td>%I</td>
<td>12小时制小时(01..12)</td>
</tr>
<tr>
<td>%p</td>
<td>本地AM/PM指示符</td>
</tr>
<tr>
<td>%M</td>
<td>分钟(00..59)</td>
</tr>
<tr>
<td>%S</td>
<td>秒(00..61)</td>
</tr>
<tr>
<td>%X</td>
<td>本地时间(e.g.:“15:12:47″)</td>
</tr>
<tr>
<td>%Z</td>
<td>时区(e.g.GMT)，如果不能检测出时区，值为空</td>
</tr>
<tr>
<td></td>
<td><strong>日期格式串</strong></td>
</tr>
<tr>
<td>%a</td>
<td>本地简短星期名(e.g.: Sun..Sat)</td>
</tr>
<tr>
<td>%A</td>
<td>本地完整星期名(e.g.: Sunday .. Saturday)</td>
</tr>
<tr>
<td>%b</td>
<td>本地简短月名(e.g.: Jan .. Dec)</td>
</tr>
<tr>
<td>%B</td>
<td>本地完整月名(e.g.: January .. December)</td>
</tr>
<tr>
<td>%c</td>
<td>本地日期与时间(e.g.: “Sun Dec 15 14:12:47 GMT 1996″)</td>
</tr>
<tr>
<td>%d</td>
<td>一月中的第几日(01 .. 31)</td>
</tr>
<tr>
<td>%j</td>
<td>一年中的第几天 (001 .. 366)</td>
</tr>
<tr>
<td>%m</td>
<td>月名的数字表示 (01 .. 12)</td>
</tr>
<tr>
<td>%U</td>
<td>一年中以星期日为每周第一天计算的星期数(00..53, 第一周包括新年的第一个星期日)</td>
</tr>
<tr>
<td>%W</td>
<td>一年中以星期一为每周第一天计算的星期数(00..53, 第一周包括新年的第一个星期一)</td>
</tr>
<tr>
<td>%w</td>
<td>星期名的数字表示 (0 .. 6, 0为星期日)</td>
</tr>
<tr>
<td>%x</td>
<td>本地日期 (e.g. 今天在北京是: “15/12/96″)</td>
</tr>
<tr>
<td>%y</td>
<td>不带世纪的年(00 .. 99)</td>
</tr>
<tr>
<td>%Y</td>
<td>带世纪的年(1970 .. 2038)</td>
</tr>
</tbody>
</table>
<p><strong>错误写法</strong>：</p>
<p><strong>提示：cronolog轮询日志的正确写法，被轮询的日志路径要写全路径</strong></p>
<p><strong>按天轮询（生产环境常见用法，推荐使用）</strong></p>
<pre><code class="language-bash"># 错误写法
CustomLog &quot;|usr/local/sbin/cronolog logs/access_www_%w.log&quot; combined
# 正确写法
CustomLog &quot;|usr/local/sbin/cronolog /app/logs/access_www_%Y%m%d.log&quot; combined
</code></pre>
<p><strong>提示：这是大多数网站的常规配置方法（按天记录日志，日志不会自动覆盖）</strong></p>
<p><strong>按小时轮询（生产环境较常见用法）</strong>：</p>
<pre><code class="language-bash"># 按小时轮询（生产环境较常见用法）
CustomLog &quot;|usr/local/sbin/cronolog /app/logs/access_www_%Y%m%d%H.log&quot; combined
# 按天轮询（生产环境较常见用法）
CustomLog &quot;|usr/local/sbin/cronolog /app/logs/access_www_%Y%m%d.log&quot; combined
</code></pre>
<p>完整配置如下</p>
<pre><code class="language-bash">&lt;VirtualHost *:80&gt;
    ServerAdmin test.com@gmail.com
    DocumentRoot &quot;/var/html/blog&quot;
    ServerName blog.etiantian.com
    ErrorLog &quot;logs/blog_error_log&quot;
    CustomLog &quot;|/usr/local/sbin/cronolog  /app/logs/access_blog_%w.log&quot; combined
&lt;/VirtualHost&gt;
</code></pre>
<p><strong>配置定时任务</strong></p>
<pre><code class="language-bash"># 创建脚本目录
mkdir /server/script/web/ -p

# 创建脚本文件
touch /server/script/web/apache_log.sh

# 编辑脚本内容
cd /app/apache/logs
mv www_access_log /app/logs/www_access_$(date +%F -d '-1day').log
www_access_log
&gt;www_access_log
/app/apache/bin/apachectl graceful
# 添加定时任务
00 00 * * * /bin/sh /server/script/web/apache_log.sh &gt;/dev/null 2&gt;&amp;1

# 测试脚本是否可执行成功
# 如果脚本没有执行权限
$ /server/script/web/apache_log.sh         
-bash: /server/script/web/apache_log.sh: 权限不够

$ /bin/sh /server/script/web/apache_log.sh

# 查看执行结果
$ ll
总用量 0
# 将时间设置为0时
$ date -s '2017-04-20 23:59:00'

# 这时候时23:59查看当天日志是有内容的，并且/app/logs/下面没有文件
$ cat /app/apache/logs/www_access_log 
192.168.59.1 - - [20/Apr/2017:23:59:19 +0800] &quot;GET / HTTP/1.1&quot; 304 - &quot;-&quot; &quot;Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:45.0) Gecko/20100101 Firefox/45.0&quot;

# 0时这个时候发现目录生成新日志文件了
$ ll
总用量 4
-rw-r--r--. 1 root root 153 4月  20 23:59 www_access_2017-04-21.log
</code></pre>
<h3 id="不记录日志">不记录日志<a hidden class="anchor" aria-hidden="true" href="#不记录日志">¶</a></h3>
<p>正如下列配置所示</p>
<pre><code class="language-conf">&lt;FilesMatch '\. (css|js|gif|jpg|ico|swf|png)'&gt;
 	SetEnv IMAG 1
&lt;/FilesMatch&gt;
</code></pre>
<p>实际日志配置</p>
<pre><code class="language-conf">CustomLog &quot;|/usr/local/sbin/cronolog  /app/logs/access_bbs_%w.log&quot; combined evn=!IMAG
</code></pre>
<p>查询日志</p>
<pre><code class="language-conf">awk '{print $1}' www-access_2014-09-18log |sort|uniq -c|sort -rn -k1|head -10
</code></pre>
<h2 id="隐藏httpd版本号">隐藏httpd版本号<a hidden class="anchor" aria-hidden="true" href="#隐藏httpd版本号">¶</a></h2>
<p>步骤1：编译前隐藏版本信息</p>
<pre><code class="language-bash">cat /home/tools/httpd-2.2.27/include/ap_release.h 
</code></pre>
<p>找到 <code>#define AP_SERVER_BASEPRODUCT &quot;Apache&quot;</code></p>
<pre><code class="language-conf">#define AP_SERVER_BASEPRODUCT &quot;Apache&quot;
# 修改为
#define AP_SERVER_BASEPRODUCT &quot;Microsoft-IIS/5.0&quot;

#define AP_SERVER_BASEVENDOR &quot;Apache Software Foundation&quot;
#define AP_SERVER_BASEPROJECT &quot;Apache HTTP Server&quot;
#define AP_SERVER_BASEPRODUCT &quot;Apache&quot;

#define AP_SERVER_MAJORVERSION_NUMBER 2
#define AP_SERVER_MINORVERSION_NUMBER 2
#define AP_SERVER_PATCHLEVEL_NUMBER   27
#define AP_SERVER_DEVBUILD_BOOLEAN    0
</code></pre>
<p>找到 <code>cat /home/tools/httpd-2.2.27/os/unix/os.h</code>，修改 <code>#define PLATFORM &quot;Unix&quot; 修改为 #define PLATFORM &quot;Win32&quot; </code></p>
<p>**步骤3：最后修改 /etc/httpd/conf/httpd.conf **</p>
<pre><code class="language-conf">ServerTokens Prod        # Prod 同 ProductOnly
ServerSignature Off
</code></pre>
<p>配置前的响应头</p>
<pre><code class="language-bash">$ curl 127.0.0.1 -I
HTTP/1.1 200 OK
Date: Thu, 20 Apr 2017 16:18:24 GMT
Server: Apache/2.2.27 (Unix) DAV/2
</code></pre>
<p>配置如下参数</p>
<pre><code class="language-bash">vi /app/apache/conf/extra/httpd-default.conf
ServerTokens Prod
ServerSignature Off
</code></pre>
<p>配置后的响应头</p>
<pre><code class="language-bash">$ curl 127.0.0.1 -I                            
HTTP/1.1 200 OK
Date: Thu, 20 Apr 2017 16:22:19 GMT
Server: Apache
</code></pre>
<p>附：</p>
<ul>
<li><em><strong>ServerSignature</strong></em> 三个选项，分别是 On | Off | EMail</li>
<li><em><strong>ServerTokens</strong></em> 的取值如下，其分别隐藏信息依次增加，推荐： ServerTokens ProductOnly</li>
</ul>
<p>未经修改的请求头如下</p>
<pre><code class="language-bash">$ curl –head 127.0.0.1
HTTP/1.1 200 OK
Date: Thu, 22 Jan 2015 15:39:00 GMT
Server: Apache/2.2.26 (CentOS)
X-Powered-By: PHP/5.5.9
Vary: Cookie,Accept-Encoding,User-Agent
X-Pingback: http://blog.mimvp.com/xmlrpc.php
Cache-Control: max-age=600
Expires: Thu, 22 Jan 2015 15:49:00 GMT
Content-Type: text/html; charset=UTF-8
</code></pre>
<p>上面头信息中，会显示服务器类型和版本(Apache/2.2.26)，以及操作系统(CentOS)</p>
<p>修改 ServerTokens</p>
<p>修改 ServerTokens OS 为 ServerTokens productonly</p>
<p>再次返回头信息如下：</p>
<pre><code class="language-bash">$ curl –head 127.0.0.1
HTTP/1.1 200 OK
Date: Thu, 22 Jan 2015 15:40:53 GMT
Server: Apache
X-Powered-By: PHP/5.5.9
Vary: Cookie,Accept-Encoding,User-Agent
X-Pingback: http://blog.mimvp.com/xmlrpc.php
Cache-Control: max-age=600
Expires: Thu, 22 Jan 2015 15:50:53 GMT
Content-Type: text/html; charset=UTF-8
</code></pre>
<h3 id="隐藏php版本号">隐藏php版本号<a hidden class="anchor" aria-hidden="true" href="#隐藏php版本号">¶</a></h3>
<p>php.ini</p>
<p>expose_php On 改成 expose_php Off</p>
<h2 id="http-fastcgi模式启动">HTTP fastcgi模式启动<a hidden class="anchor" aria-hidden="true" href="#http-fastcgi模式启动">¶</a></h2>
<p>编译PHP时候不要使用aspx</p>
<p>注释掉以下，fpm安装方式。不用管，例如下面配置</p>
<pre><code class="language-conf">LoadModule php5_module modules/libphp5.so
&lt;FilesMatch \.php$&gt;
    SetHandler application/x-httpd-php
&lt;/FilesMatch&gt;
</code></pre>
<p>然后去掉 <code>mod_proxy.so</code> 和 <code>mod_proxy_fcgi.so</code> 之前的注解，确保他们被apache加载。</p>
<p>如果php-fpm使用的是TCP socket，那么在httpd.conf末尾加上：</p>
<pre><code class="language-conf">&lt;FilesMatch \.php$&gt;   正则匹配文件，如果文件名为.php结尾
         SetHandler &quot;proxy:fcgi://127.0.0.1:9000&quot;
&lt;/FilesMatch&gt;
</code></pre>
<h2 id="httpd的工作模式">httpd的工作模式<a hidden class="anchor" aria-hidden="true" href="#httpd的工作模式">¶</a></h2>
<h3 id="workerperfor模式">worker/perfor模式<a hidden class="anchor" aria-hidden="true" href="#workerperfor模式">¶</a></h3>
<p>在linux中，我们可以使用 <code>http-l</code> 查看安装的模块是 prefork 模式还是 worker 模式</p>
<pre><code class="language-bash">$ /app/apache/bin/apachectl -l|sed -n '/worker\|prefork/p'
  prefork.c		#&lt;== 默认为prefork（预派生）模式5个进程
482 Include conf/extra/httpd-mpm.conf  	#&lt;==在httpd.conf中打开mpm配置文件.
</code></pre>
<h3 id="prefork模式">prefork模式<a hidden class="anchor" aria-hidden="true" href="#prefork模式">¶</a></h3>
<p>prefork使用的是多个子进程，而每个子进程只有一个线程，每个进程在某个确定的时间只能维持一个连接.</p>
<h4 id="工作原理">工作原理<a hidden class="anchor" aria-hidden="true" href="#工作原理">¶</a></h4>
<p>控制进程最初简历若干个子进程，为了不在请求到来时再生成子进程，所以要根据需求不断的创建新的子进程，最大可以达到每秒32个知道满足需求为止.</p>
<p>安装方法：在编译的过程中，加入参数 <code>--with-mpm=prefork</code>  如果不加也可以，因为默认的话，会采用 prefork模式。</p>
<ul>
<li>优点：效率高，稳定，安全。对于线程调试困难的平台来说，调试更加容易些.</li>
<li>缺点：和work模式比消耗资源多.</li>
</ul>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed//img/image-20221202173701200.png" alt="image-20221202173701200" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<h4 id="prefork配置参数说明">prefork配置参数说明<a hidden class="anchor" aria-hidden="true" href="#prefork配置参数说明">¶</a></h4>
<pre><code class="language-conf"># prefork MPM
# StartServers: number of server processes to start
# MinSpareServers: minimum number of server processes which are kept spare
# MaxSpareServers: maximum number of server processes which are kept spare
# MaxRequestWorkers: maximum number of server processes allowed to start
# MaxConnectionsPerChild: maximum number of connections a server process serves
#                         before terminating
&lt;IfModule mpm_prefork_module&gt;
    StartServers           	1 	#&lt;==最初建立的子进程
    MinSpareServers          	1	#&lt;==最小空闲进程数，如果空闲进程小于设定值，apache会自动建立进程，如果服务器并发及负载大的话，可以考虑加大。
    MaxSpareServers          	2	#&lt;==最大空闲进程，如果空闲的进程大于设定值，apache会自动kill掉多余的进程，如果服务器负载大的话，可以考虑加大
    MaxRequestWorkers        	20	#&lt;==设定apache可以同时处理的请求，是对apache性能影响最大的参数，就是apache可以同时处理的请求数，就是说，如果有150个用户在访问，那么第151个用户就要等之前的访问结束后才能访问
    MaxConnectionsPerChild   	0	#&lt;==每个子进程可处理的请求数。每个子进程在处理了[max requests perchild] 个请求后将自动销毁。0意味着无限，即子进程永不销毁，虽然缺省值为0,可以使每个子进程处理更多的请求，但如果设成非0值也有两点重要好处1.可防止意外的内存泄露2.在服务器负载下降的时候会自动减少子进程数
&lt;/IfModule&gt;
</code></pre>
<h3 id="worker模式">worker模式<a hidden class="anchor" aria-hidden="true" href="#worker模式">¶</a></h3>
<p>worker模式是 Apache2.X 新引进来的模式，是线程与进程的结合，在worker模式下会有多个子进程，每个进程又会有多个线程。每个线程在某个确定的时间只能维持一个连接。</p>
<p>工作原理</p>
<p>由主控制进程生成若干个子进程，而每个子进程中又包含固定的线程数，各个线程独立处理请求，同样为了不在请求到来时再生成线程，再配置文件中设置了最小和最大的空闲线程数及所有子进程中的线程总数，如果现有子进程中的线程总数不能满足并发及负载，控制进程将派生新的子进程。</p>
<p>在配置编译的过程中，加入参数 <code>--with-mpm-worker</code>，如果不加的话系统会采用默认prefork模式。</p>
<ul>
<li>优点：内存占用比prefork模式低，适合高并发高流量HTTP服务。</li>
<li>缺点：假如一个线程崩溃，整个进程就会连同其任何线程一起 “死掉”。由于线程贡献内存空间，所以一个程序在运行时必须被系统识别为“每个线程都是安全的”服务稳定性不如prefork模式。</li>
</ul>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed//img/image-20221202174118478.png" alt="image-20221202174118478" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<h3 id="worker-模式配置参数说明">worker 模式配置参数说明<a hidden class="anchor" aria-hidden="true" href="#worker-模式配置参数说明">¶</a></h3>
<pre><code class="language-conf"># worker MPM
# StartServers: initial number of server processes to start
# MinSpareThreads: minimum number of worker threads which are kept spare
# MaxSpareThreads: maximum number of worker threads which are kept spare
# ThreadsPerChild: constant number of worker threads in each server process
# MaxRequestWorkers: maximum number of worker threads
# MaxConnectionsPerChild: maximum number of connections a server process serves
#                         before terminating
&lt;IfModule mpm_worker_module&gt;
    StartServers             	3	#&lt;==最初建立的子进程
MinSpareThreads         	75	#&lt;==最小空闲线程数，如果空闲的线程小于设定值，apache会自动建立线程，如果服务器负载大的话，可以考虑加大此参数值。
MaxClients #&lt;==所有子进程中的线程总数。如果现有子进程中的线程总数不能满足负载，控制进程将派生新的子进程。
MaxSpareThreads        	250  #&lt;==最大空闲线程数，如果空闲的线程大于设定值，apache会自动kill掉多余的线程，如果服务器负载过大的话，可以考虑加大此参数值。   
ThreadsPerChild         	25	#&lt;==每个进程包含固定的线程数，此参数再worker模式中，是影响最大的参数
MaxRequestWorkers      	400	    
MaxConnectionsPerChild   	0Threads
&lt;/IfModule&gt;
</code></pre>
<p>worker模式下所能同时处理的请求总数是由子进程总数乘Threadsperchild值决定的，应该大于等于maxcliens。如果负载很大，现有的子进程数不能满足时，控制进程会派生新的子进程。</p>
<p>默认最大的子进程总数是16，如需加大时，也需要显式声明serverlimit的值（最大值是20000）</p>
<blockquote>
<p>特别说明</p>
<p>如果显式生命了serverLimit，那么它乘 ThreadPreChild 的值必须大于等于MaxClients,而且MaxClients必须是ThreadPerChild的整数倍，否则Apache将会自动调节Apache将会自动调节到一个相应的值（可能是个非常期望值）</p>
<p>通过数学表达</p>
<p>MaxClient &lt;= 总的进程（ServerLimit）* 线程数（ThreadsPerChild）、</p>
<p>MaxClient % ThreadsPerChild = 0</p>
</blockquote>
<p>注意：worker MPM也有不完善的地方，如果一个线程崩溃，整个进程就会连同其所有线程一起 “死掉”</p>
<h2 id="配置httpd对站点文件压缩">配置httpd对站点文件压缩<a hidden class="anchor" aria-hidden="true" href="#配置httpd对站点文件压缩">¶</a></h2>
<h3 id="mod_deflate模块介绍">mod_deflate模块介绍<a hidden class="anchor" aria-hidden="true" href="#mod_deflate模块介绍">¶</a></h3>
<p>Apache的 <code>mod_deflate</code> 模块提供了 <code>Deflate</code> 输出过滤器，允许httpd服务器将输出内容在发送到客户端之前根据具体的策略进行压缩，以节约网络带宽，同时提升用户访问体验。</p>
<p><code>mod_deflate</code> 模块安装方法</p>
<p>检查是否安装了模块 <code>mod_deflate</code></p>
<pre><code class="language-bash">$ /app/apache/bin/apachectl -l
Compiled in modules:
  core.c
  mod_so.c
  http_core.c
  prefork.c
</code></pre>
<h3 id="常规方法安装">常规方法安装<a hidden class="anchor" aria-hidden="true" href="#常规方法安装">¶</a></h3>
<p><code>--enable-deflate</code> 提供对内容的亚索传输编码支持，一般html js css等内容站点，使用此参数功能会大大提高传输速度，提升访问者访问体验。在生产环境中，这是 httpd 调优的一个重要选项之一。</p>
<h3 id="mod_deflate-dso安装方法">mod_deflate DSO安装方法<a hidden class="anchor" aria-hidden="true" href="#mod_deflate-dso安装方法">¶</a></h3>
<p>以DSO动态模块加载mod_deflate配置的全部命令为</p>
<pre><code class="language-bash">cd /root/tools/httpd-2.4.18/modules/filters	#&lt;==切换到apache软件目录mod_deflate程序下
/app/apache/bin/apxs  -c -i -a mod_deflate.c #&lt;==以dso的方式编译入到apache中
</code></pre>
<p>出现如下错误</p>
<pre><code class="language-bash">httpd: Syntax error on line 103 of /app/apache2.4/conf/httpd.conf: Cannot load modules/mod_deflate.so into server: /app/apache2.4/modules/mod_deflate.so: undefined symbol: inflateEnd
</code></pre>
<p>解决方法：</p>
<p>出现这个错误其实时因为 <code>mod_deflate</code> 模块没有找到 <code>zlib</code> 库。解决办法就是找到 <code>apr-config</code> 文件中的<code>LDFLAGS=&quot;&quot;</code>，把他改成 <code>LDFLAGS=&quot;-lz&quot;</code> ，然后在运行 <code>/usr/local/apache2/bin/apxs -i -c -a mod_deflate.c</code> 一般就可以了。</p>
<p>方法1：在apr的主配置文件 <code>apr-1-config</code>（老版本可能是apr-conf）里面将 <code>LDFLAGS=&quot;&quot;</code> 修改为 <code>LDFLAGS=&quot;-lz&quot;</code>，然后用 apxs 从新编译 <code>mod_deflate.c</code> 后，httpd 服务就正常了，并且也可以正常压缩文件了。</p>
<p>方法2：需要在 <code>LoadModule deflate_module  modules/mod_deflate.so</code> 的前面加载 <code>zlib.so64</code> 操作系统就在 <code>LoadModule deflate_module   modules/mod_deflate.so</code> 这行的上一行添加 <code>LoadFile /usr/lib64/libz.so</code>即可。</p>
<p>上述参数选项说明</p>
<table>
<thead>
<tr>
<th>参数 </th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>-c             </td>
<td>需要执行编译操作。他首先会编译C源码程序(.c)files为对应的目标代码文件(.o)，然后连接这些目标代码和files中其余的目标代码文件(.o和.a)，以生成动态共享对象dsofile。如果没有指定-o选项，则此输出文件名由files中的第一个文件名推测得到，也就是默认为mod_name.so</td>
</tr>
<tr>
<td>-i                                          </td>
<td>需要执行安装操作，以安装一个或多个共享对象到服务器的modules目录中。</td>
</tr>
<tr>
<td>-a</td>
<td>增加一个LoadMoudule行到httpd.conf文件中，以激活此模块</td>
</tr>
</tbody>
</table>
<h3 id="mod_deflate测试">mod_deflate测试<a hidden class="anchor" aria-hidden="true" href="#mod_deflate测试">¶</a></h3>
<p>mod_deflate模块可以在主配置文件中配置，也可以在虚拟主机中配置</p>
<p>在主http.conf配置中配置如下：</p>
<pre><code class="language-conf">&lt;ifmodule mod_deflate.c&gt; # &lt;==开始标签标记 判断模块是否开启
    DeflateCompressionLevel 6 # &lt;==压缩级别 1-9
    SetOutputFilter DEFLATE	# &lt;==启用deflate模块对本站点的所有输出进行GZIP压缩
    AddOutputFilterByType Deflate text/html test/pain text/xml text/css 	
    AddOutputFilterByType Deflate application/javascript
&lt;/ifmodule&gt; # &lt;==判断结束标记
</code></pre>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed//img/image-20221202180518764.png" alt="image-20221202180518764" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<h2 id="mod_expires-缓存功能">mod_expires 缓存功能<a hidden class="anchor" aria-hidden="true" href="#mod_expires-缓存功能">¶</a></h2>
<p>mod_expires允许通过apache配置文件控制 HTTP “Expires:” 和 “Cache-Control:” 头内容，这个模块控制服务器应答时的Expires头内容和Cache-Control头的max-age指令。有效期可以设置为相对于源文件的最后修改时刻或者客户端的访问时刻。</p>
<p>这些HTTP头向客户端表明了内容的有效性和持久性。如果客户端本地有缓存，则内容就可以从缓存（除非过期）而不是从服务器读取。人后客户端会检查缓存中的副本，看看是否过期或者失效，以决定是否重新从服务器获得内容更新。</p>
<h3 id="常规方法安装-1">常规方法安装<a hidden class="anchor" aria-hidden="true" href="#常规方法安装-1">¶</a></h3>
<p>&ndash;enable-deflate</p>
<p>提供对内容的亚索传输编码支持，一般html js css等内容站点，使用此参数功能会大大提高传输速度，提升访问者访问体验。在生产环境中，这是Apache调优的一个重要选项之一。</p>
<p>以DSO动态模块加载mod_deflate配置的全部命令为：</p>
<pre><code class="language-bash">cd /root/tools/httpd-2.4.18/modules/metadata#&lt;==切换到apache软件目录mod_expires程序下
/app/apache/bin/apxs  -c -i -a mod_expires.c #&lt;==以dso的方式编译入到apache中
</code></pre>
<h3 id="mod_expires在httpd中应用">mod_expires在httpd中应用<a hidden class="anchor" aria-hidden="true" href="#mod_expires在httpd中应用">¶</a></h3>
<p>在主配置文件中配置，所有的虚拟主机都生效，在对应的虚拟主机上配置，只有对应的虚拟主机生效</p>
<pre><code class="language-conf">&lt;ifmodule expires_module&gt;
    ExpiresActive on
    ExpiresDefault &quot;access plus 12 months&quot;
    ExpiresByType test/html &quot;access plus 1 years&quot;
    ExpiresByType test/css &quot;access plus 1 years&quot;
    ExpiresByType test/xml &quot;access plus 1 years&quot;
    ExpiresByType test/php &quot;access plus 1 years&quot;
    ExpiresByType image/gif &quot;access plus 30 days&quot;
    #ExpiresByType image/jpeg &quot;access plus 30 days&quot;
    #ExpiresByType image/jpg &quot;access plus 30 days&quot;
    ExpiresByType image/jpeg A7200000
	ExpiresByType image/png &quot;access plus 30 days&quot;
    ExpiresByType application/javascript &quot;access plus 30 days&quot;
    ExpiresByType application/x-javascript &quot;access plus 30 days&quot;
    ExpiresByType image/png &quot;access plus 30 days&quot;
&lt;/ifmodule&gt;
</code></pre>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed//img/image-20221202180534378.png" alt="image-20221202180534378" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<h2 id="配置httpd防盗链功能">配置httpd防盗链功能<a hidden class="anchor" aria-hidden="true" href="#配置httpd防盗链功能">¶</a></h2>
<h3 id="httpd-web服务实现防盗链">httpd Web服务实现防盗链<a hidden class="anchor" aria-hidden="true" href="#httpd-web服务实现防盗链">¶</a></h3>
<p>利用referer和rewrite实现Apache防盗链调用，在主配置文件 <code>httpd.conf</code> 或者在虚拟主机 <code>httpd-vhosts.conf</code> 中配置如下</p>
<pre><code class="language-conf">RewriteEngine ON	
RewriteCond %{HTTP_REFERER} !^http://www.test.com/.*$ [NC] #&lt;==此处，如果加http://就必须加^,否则直接写servername即可 如下
RewriteCond %{HTTP_REFERER} !http://www.test.com [NC]
RewriteCond %{HTTP_REFERER} !^http://www.test.com$ [NC]
RewriteCond %{SCRIPT_FILENAME} !nolink.png [NC]#&lt;==为防止无限302，文件名如果为nolink.png即不重写
RewriteRule .*\.(gif|jpg|swf|png)$ img/nolink.png [R,NC,L] #&lt;==重写时，必须加R
</code></pre>
<p>访问查看结果</p>
<img src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed//img/image-20221202174359240.png" alt="image-20221202174359240" style="zoom: 67%;" />
<p>用原本的域名访问，可直接访问</p>
<img src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed//img/image-20221202174426073.png" alt="image-20221202174426073" style="zoom:80%;" />
<h3 id="httpd常用rewrite标志">httpd常用Rewrite标志<a hidden class="anchor" aria-hidden="true" href="#httpd常用rewrite标志">¶</a></h3>
<table>
<thead>
<tr>
<th>flag</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>Chain|C</td>
<td>如果当前规则被匹配，则继续处理其后继规则，如果当前规则不被匹配， 则其后继规则将被跳过。</td>
</tr>
<tr>
<td>forbidden|F</td>
<td>强制禁止当前URL的响应，并向客户端发送一个403的HTTP响应代码。</td>
</tr>
<tr>
<td>gone|G</td>
<td>强制废弃当前URL,向客户端发送一个410的HTTP响应代码，来表明此URL是已被废弃的。</td>
</tr>
<tr>
<td>handler|H=Content-handler</td>
<td>为需要处理的目标文件强制指定一个内容处理器。</td>
</tr>
<tr>
<td>last|L</td>
<td>停止标志，当mod_rewrite模块处理到此标志时会停止重写搡作，并不再应用其他重写规则。此标志通常用于跳出规则处理。</td>
</tr>
<tr>
<td>next|N</td>
<td>循环重写规则，从第一个规则开始再次执行重写规则，但此时处理的URL己经不是原始的URL.它相当于Perl语言中的next命令。</td>
</tr>
<tr>
<td>nocase|NC</td>
<td>忽略Pattern中的大小写。</td>
</tr>
<tr>
<td>Noescape|NE</td>
<td>使用此标记可以让URL中允许使用一些特殊字符，例如，‘T’、‘%’、‘;’等，如果不使用此标记则是将这些特殊字符转换成等值的16进制编码如‘%25’、‘%24’、‘%3B’等。</td>
</tr>
<tr>
<td>nosubreq|NS</td>
<td>不对内部子请求进行处理，使用此标记如果是内部子请求，则跳过当前规则。通常使用CGI脚本的子请求会出现一些问题，因此可以使用些标记来 禁止子请求。</td>
</tr>
<tr>
<td>proxy|P</td>
<td>强制重写的URL在内部由代理服务器模块来处理，并中断重写过程。使用这个标记要注意的是需要保证代理模块已经被加载，同时替换的字串是一个能被代理模块处理的有效的URL,否则代理模块将会返回一个错误的信息。</td>
</tr>
<tr>
<td>Passthiough|PT</td>
<td>将此URL强制交给下一个处理器来进行处理，而在转交之前， mod_rewrite模块会将内部request_rec结构中的URL字段设置为filename字段的值，这使得RewriteRule指令的输出能够被（从URL转换到文件名的）Alias、 ScriptAlias、Redirect等指令进行后续处理。</td>
</tr>
<tr>
<td>Qsappend|QSA</td>
<td>你可以通过此标记在现有的替换字符串中增加一个査询字符串， 注意：是增加而不是替换。</td>
</tr>
<tr>
<td></td>
<td>将重写的URL作为一个重定向处理，在使用这个标记时，必须确保该替换字段是一个有效的URL。否则，它会指向一个无效的位置，并且此 标记本身只是对URL加上http://thishost[:thisport]/前缀。如果没有在此标记后面指 定HTTP响应代码则会使用302 (临时性移动）这个响应代码来进行处理。用户可指定的响应代码范围为300〜400,或是使用符号化的名称，例如，temp、seeother 等。</td>
</tr>
<tr>
<td>redirect|R[=code]</td>
<td>将重写的URL作为一个重定向处理，在使用这个标记时，必须确保该替换字段是一个有效的URL。否则，它会指向一个无效的位置，并且此 标记本身只是对URL加上 <code>http://thishost[:thisport]/</code> 前缀。如果没有在此标记后面指 定HTTP响应代码则会使用302 (临时性移动）这个响应代码来进行处理。用户可指定的响应代码范围为300〜400,或是使用符号化的名称，例如，temp、seeother 等。</td>
</tr>
<tr>
<td>skip|S=num</td>
<td>与chain|C标记不同，使用此标记将强制跳过后继的规则，用户可以通过此标记来模拟if-then-else结构，最后一个规则是then从句，而被跳过的skip=N 个规则是else从句。</td>
</tr>
<tr>
<td>type|T=MIME-type</td>
<td>强制目标文件的MIME类型为MIME-type所指定的类型。</td>
</tr>
</tbody>
</table>
<h2 id="禁止资源目录解析php程序">禁止资源目录解析PHP程序<a hidden class="anchor" aria-hidden="true" href="#禁止资源目录解析php程序">¶</a></h2>
<p>方案1：提示下载不解析</p>
<pre><code class="language-conf">&lt;Directory &quot;/app/apache-2.4.18/htdocs/php&quot;&gt;
AllowOverride None
Options None
Require all granted
php_admin_flag engine off #&lt;==禁止解析php文件，此参数必须apex方式安装才存在。反之报错
&lt;/Directory&gt;
</code></pre>
<img src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed//img/image-20221202175111862.png" alt="image-20221202175111862" style="zoom: 80%;" />
<p><code>php_admin_flag engine off</code> 这个语句就是禁止解析 php 的控制语句，但只这样配置还不够，因为这样配置后用户依然可以访问 php 文件，只不过不解析了，但可以下载，用户下载 php 文件也是不合适的，所以有必要再禁止一下。</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed//img/image-20221202175148577.png" alt="image-20221202175148577" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<h2 id="禁止目录索引浏览功能">禁止目录索引浏览功能<a hidden class="anchor" aria-hidden="true" href="#禁止目录索引浏览功能">¶</a></h2>
<p>默认配置当网站没有首页文件时，httpd会把整个目录结构展示给网站用户，这是非常大的隐患，必须要屏蔽掉。</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed//img/image-20221202175604755.png" alt="image-20221202175604755" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<p>在主配置文件 <code>httpd.conf</code> 或者虚拟主机的配置文件 <code>httpd-vhost.conf</code> 文件配置如下内容即可</p>
<pre><code class="language-conf">&lt;Directory &quot;/app/apache-2.4.18/htdocs&quot;&gt;
    Options FollowSymLinks
    AllowOverride None
    Require all granted
    Allow from all
&lt;/Directory&gt;
</code></pre>
<p>或</p>
<pre><code class="language-conf">&lt;Directory &quot;/app/apache-2.4.18/htdocs&quot;&gt;
    Options -Indexes FollowSymLinks
    AllowOverride None
    Require all granted
    Allow from all
&lt;/Directory&gt;
</code></pre>
<p>更改之后出现403权限问题，说明禁止了目录索引功能</p>
<h2 id="关闭无用的cgi功能配置">关闭无用的CGI功能配置<a hidden class="anchor" aria-hidden="true" href="#关闭无用的cgi功能配置">¶</a></h2>
<pre><code class="language-conf">304 &lt;IfModule alias_module&gt;
305     #
306     # Redirect: Allows you to tell clients about documents that used to 
307     # exist in your server's namespace, but do not anymore. The client 
308     # will make a new request for the document at its new location.
309     # Example:
310     # Redirect permanent /foo http://www.example.com/bar
311 
312     #
313     # Alias: Maps web paths into filesystem paths and is used to
314     # access content that does not live under the DocumentRoot.
315     # Example:
316     # Alias /webpath /full/filesystem/path
317     #
318     # If you include a trailing / on /webpath then the server will
319     # require it to be present in the URL.  You will also likely
320     # need to provide a &lt;Directory&gt; section to allow access to
321     # the filesystem path.
322 
323     #
324     # ScriptAlias: This controls which directories contain server scripts. 
325     # ScriptAliases are essentially the same as Aliases, except that
326     # documents in the target directory are treated as applications and
327     # run by the server when requested rather than as documents sent to the
328     # client.  The same rules about trailing &quot;/&quot; apply to ScriptAlias
329     # directives as to Alias.
330     #
331     ScriptAlias /cgi-bin/ &quot;/app/apache-2.4.18/cgi-bin/&quot;
332 
333 &lt;/IfModule&gt;

&lt;Directory &quot;/app/apache-2.4.18/htdocs/bbs&quot;&gt;
    Options FollowSymLinks
    AllowOverride None
 	Order allow,deny
    Allow form all
 &lt;/Directory&gt;
</code></pre>
<h2 id="禁止httpd用户重载功能">禁止httpd用户重载功能<a hidden class="anchor" aria-hidden="true" href="#禁止httpd用户重载功能">¶</a></h2>
<pre><code class="language-conf">&lt;Directory &quot;/app/apache-2.4.18/htdocs&quot;&gt;
    Options -Indexes FollowSymLinks
    AllowOverride None		#&lt;==禁止用户重载
    Require all granted
    Allow from all
&lt;/Directory&gt;
</code></pre>
<p>禁止用户重载会加快服务器响应速度，因为它不在为每个请求寻找每个目录访问控制文件(.htaccess)。也杜绝了开发人员变相修改配置的安全隐患</p>
<h2 id="避免使用htaccess文件">避免使用.htaccess文件<a hidden class="anchor" aria-hidden="true" href="#避免使用htaccess文件">¶</a></h2>
<p>在Apache中，AllowOvCTride 指令来设置是否启用 <code>.htaccess</code> 文件功能。但是对于一些管理员来说，更简单更精细化的控制目录可以为他们节省很多的时间，于是 <code>.htaccess</code> 文件提供了一个这样的功能，你可以使用默认AllowOverride指令是使用None参数来禁止使用.htaccess文件功能。</p>
<p>可使用参数：</p>
<pre><code class="language-conf">* All：使用所有能在.htaccess文件中使用的指令.
* AuthConfig：使用鉴权指令，例如，AuthName、AuthType 等.
* FileInfo：使用控制文件类型的指令，例如，ErrorDocument、SetOutputFilter等. 
* Indexes:使用目录索引指令.
* Options：使用控制目录功能指令.
* Limit：使用主机访问控制指令.
</code></pre>
<p>注意：</p>
<p><code>.htaccess</code> 文件会导致服务器性能的急速（如果服务器上有很多目录，且每层目录下都有.haccess文件）下降，在使用了AllowOverride指令允许使用 <code>.htaccess </code>文件后，无论是否使用 <code>.htaccess</code> 文件，httpd都会在每个目录下查找 <code>.htaccess</code> 文件。其次，当每个请求链接到来时，httpd 会查找链接所请求目录下的 <code>.htaccess</code> 文件，并且再査找它的上级目录中的 <code>.htaccess</code> 文件以使 <code>.htaccess </code>文件内的设置都能生效。这些査找会让httpd 性能降低很多。另外还有安全方面的问题，<code>.htaccess</code> 文件可以修改和覆盖服务器的指令，因此会产生一些未被限制的修改，而这些修改将会导致一些安全问题的出现。</p>
<h2 id="如何对httpd配置优化">如何对httpd配置优化？<a hidden class="anchor" aria-hidden="true" href="#如何对httpd配置优化">¶</a></h2>
<ul>
<li>配置软件软件轮训Apache访问日志</li>
<li>优化访问日志记录的信息</li>
<li>配置HTTP错误页面优雅显示</li>
<li>配置 httpd 对站点文件压缩</li>
<li>Mod_Expires缓存功能</li>
<li>更改 httpd 默认用户</li>
<li>调整 httpd 的工作模式</li>
<li>屏蔽 httpd 对外显示的版本等敏感信息</li>
<li>屏蔽 httpd 对外显示的版本等敏感信息</li>
<li>最小化 httpd 目录及文件权限设置</li>
<li>最小化 httpd 日志目录权限</li>
<li>加大 httpd 并发连接数</li>
<li>配置 httpd 防盗链功能</li>
<li>禁止 httpd 目录索引浏览功能</li>
<li>禁止 httpd 用户重载功能</li>
<li>避免使用.htaccess文件</li>
<li>关闭无用的CGI功能配置</li>
<li>禁止资源目录解析PHP程序</li>
<li>使用TMPFS文件系统替代频繁访问的目录</li>
<li>尽可能减少HTTP请求</li>
<li>使用CDN左网站加速</li>
<li>httpd 程序架构优化</li>
<li>httpd 的安全模块</li>
<li>正确途径取得源代码，勤打 httpd 补丁</li>
<li>系统内核参数优化</li>
<li>配置Mod_Pagespeed优化Web性能</li>
<li>防止用户请求跳出Web站点目录</li>
</ul>


    
    


<div class="copyrightBlock" >
    <div class="articleSuffix-bg"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 147.78 155.96"> <path d="M10.5,99.81a1.9,1.9,0,0,0-.53-.09,1.66,1.66,0,0,0-1.64,1.65A1.64,1.64,0,0,0,10,103a1.57,1.57,0,0,0,.87-.25l26.76,26.82.45-1.08L11.52,101.91A1.65,1.65,0,0,0,10.5,99.81Zm-.13,2a.57.57,0,0,1-.8,0,.58.58,0,0,1-.17-.41.58.58,0,0,1,.57-.57h0a.57.57,0,0,1,.56.58A.55.55,0,0,1,10.37,101.77Z" style="fill:#c5c9e0"></path><path d="M56.15,117.58H39.06l0-.09a1.65,1.65,0,0,0-1.36-1H37.5a1.65,1.65,0,1,0,1.56,2.19H55.7L92.92,156h41.44v-1.08h-41Zm-18.25.94a.56.56,0,0,1-.79,0,.58.58,0,0,1-.17-.41.57.57,0,0,1,.56-.57h0a.58.58,0,0,1,.57.58A.54.54,0,0,1,37.9,118.52Z" style="fill:#c5c9e0"></path><path d="M23.52,50.32a1.65,1.65,0,0,0,1.55-1.11H55.28l48-48.13h31.06V0H102.85l-48,48.13H25.07a1.64,1.64,0,0,0-2.09-1,1.64,1.64,0,0,0,.54,3.2Zm0-2.21a.57.57,0,0,1,0,1.13.57.57,0,1,1,0-1.13Z" style="fill:#c5c9e0"></path><polygon points="102.86 0 102.86 0 102.86 0 102.86 0" style="fill:#c5c9e0"></polygon><path d="M107.72,12.14h26.64V11.07H107.27L57.4,61H3.09a1.66,1.66,0,0,0-1.45-.86H1.52A1.65,1.65,0,1,0,2.81,63a1.59,1.59,0,0,0,.45-.87H57.85ZM2.05,62.23a.57.57,0,0,1-.8,0,.58.58,0,0,1-.17-.41.57.57,0,0,1,.56-.57h.09a.57.57,0,0,1,.32,1Z" style="fill:#c5c9e0"></path><path d="M134.36,43.22V42.14h-22.3l-9.62,9.63a1.64,1.64,0,0,0-2.19.77,1.61,1.61,0,0,0-.17.71,1.65,1.65,0,1,0,3.29,0,1.61,1.61,0,0,0-.16-.72l9.3-9.32Zm-32.64,10.6a.57.57,0,0,1,0-1.13.57.57,0,0,1,0,1.13Z" style="fill:#c5c9e0"></path><path d="M147,52.3l-9,9H111.48a1.64,1.64,0,0,0-1.61-1.33h-.14a1.65,1.65,0,1,0,1.6,2.41h27.19l9.26-9.29L147,52.3Zm-37.15,9.85a.56.56,0,0,1-.56-.57h0a.56.56,0,0,1,.56-.56h0a.57.57,0,1,1,0,1.13Z" style="fill:#c5c9e0"></path><path d="M66.79,75.35l11,11.06h56.53V85.33H78.27l-11-11.06H49.49L37.12,86.67a1.64,1.64,0,0,0-2.09,1,1.61,1.61,0,0,0-.09.54,1.65,1.65,0,0,0,3.29,0,1.68,1.68,0,0,0-.26-.89l12-12ZM36.58,88.79a.57.57,0,1,1,.57-.56A.57.57,0,0,1,36.58,88.79Z" style="fill:#c5c9e0"></path><path d="M110.61,95.55,92.8,113.4a1.62,1.62,0,1,0,.77.76l17.49-17.53h23.31V95.55ZM92.49,115.28a.56.56,0,0,1-.8,0,.58.58,0,0,1-.17-.41.57.57,0,0,1,.57-.57h0a.58.58,0,0,1,.56.58A.55.55,0,0,1,92.49,115.28Z" style="fill:#c5c9e0"></path><path d="M97.89,122.3H76.62L64.2,109.85a1.65,1.65,0,0,0-.77-2.2,1.77,1.77,0,0,0-.72-.17h-.14a1.65,1.65,0,0,0,.15,3.29,1.58,1.58,0,0,0,.71-.17l12.74,12.77H98.34l17.48-17.52h18.54v-1.08h-19ZM63.12,109.53a.56.56,0,0,1-.8,0,.58.58,0,0,1-.17-.41.57.57,0,0,1,1.14,0A.54.54,0,0,1,63.12,109.53Z" style="fill:#c5c9e0"></path> </svg> </div>
    <p>本文发布于<a href="https://www.oomkill.com/about" target="_blank">Cylon的收藏册</a>，转载请著名原文链接~</p>
    <p>链接：<a href="https://www.oomkill.com/2016/10/apache-httpd/" target="_blank">https://www.oomkill.com/2016/10/apache-httpd/</a></p>
    <p style="margin-bottom: 0px;">版权：本作品采用<a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">「署名-非商业性使用-相同方式共享 4.0 国际」</a> 许可协议进行许可。</p>
    </div>
</div>
  </div>

  <footer class="post-footer">
    
<nav class="paginav">
  <a class="prev" href="https://www.oomkill.com/2016/10/ch7-iptables-kernel-parameter/">
    <span class="title"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left" style="user-select: text;"><line x1="19" y1="12" x2="5" y2="12" style="user-select: text;"></line><polyline points="12 19 5 12 12 5" style="user-select: text;"></polyline>
      </polyline></svg>&nbsp; </span>
    
    <span>ch7 关于iptables的内核参数</span>
  </a>
  <a class="next" href="https://www.oomkill.com/2016/10/php-ini/" >
    <span class="title"> </span>
    
    <span>php.ini优化&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right" style="user-select: text;"><line x1="5" y1="12" x2="19" y2="12" style="user-select: text;"></line><polyline points="12 5 19 12 12 19" style="user-select: text;"></polyline></svg></span>
  </a>
</nav>

  </footer>

  
  <div class="pagination__title">
    <span class="pagination__title-h"></span>
  </div>
  
  
  
  
    <div class="comments-separator"></div>
    

  

  
    
      <div class="comments-separator"></div>
<div class="comments">
    <script>
    function loadComment() {
        let theme = localStorage.getItem('pref-theme') === 'dark' ? 'dark' : 'light';
        let s = document.createElement('script');
        s.src = 'https://giscus.app/client.js';
        s.setAttribute('data-repo', 'cylonchau\/cylonchau.github.io');
        s.setAttribute('data-repo-id', 'R_kgDOIRlNSQ');
        s.setAttribute('data-category', 'Announcements');
        s.setAttribute('data-category-id', 'DIC_kwDOIRlNSc4CXy1U');
        s.setAttribute('data-mapping', 'title');
        s.setAttribute('data-reactions-enabled', '1');
        s.setAttribute('data-emit-metadata', '1');
        s.setAttribute('data-input-position', 'top');
        s.setAttribute('data-lang', 'zh-TW');
        s.setAttribute('data-theme', theme);
        s.setAttribute('crossorigin', 'anonymous');
        s.setAttribute('async', '');
        document.querySelector('div.comments').innerHTML = '';
        document.querySelector('div.comments').appendChild(s);
    }
    loadComment();
    </script>
</div>
</article>
    </main>
    
<footer class="footer">
  <p>
  Copyright
  <span>&copy; 2024 <a href="https://www.oomkill.com">Cylon&#39;s Collection</a></span></p>
  <span style="display: inline-block; margin-left: 1em;">
    Powered by
    <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> on github-page & Theme
    <a href="https://github.com/reorx/hugo-PaperModX/" rel="noopener" target="_blank">PaperModX</a>
  </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <span class="topInner">
        <svg class="topSvg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z"/>
        </svg>
        <span id="read_progress"></span>
    </span>
</a>

<script>
  (function() {
     
    const disableThemeToggle = '' == '1';
    if (disableThemeToggle) {
      return;
    }

    let button = document.getElementById("theme-toggle")
    
    button.removeEventListener('click', toggleThemeListener)
    
    button.addEventListener('click', toggleThemeListener)
  })();
</script>

<script>
  (function () {
    let menu = document.getElementById('menu')
    if (menu) {
      menu.scrollLeft = localStorage.getItem("menu-scroll-position");
      menu.onscroll = function () {
        localStorage.setItem("menu-scroll-position", menu.scrollLeft);
      }
    }

    const disableSmoothScroll = '' == '1';
    const enableInstantClick = '1' == '1';
    
    if (window.matchMedia('(prefers-reduced-motion: reduce)').matches || disableSmoothScroll || enableInstantClick) {
      return;
    }
    
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
      anchor.addEventListener("click", function (e) {
        e.preventDefault();
        var id = this.getAttribute("href").substr(1);
        document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
          behavior: "smooth"
        });
        if (id === "top") {
          history.replaceState(null, null, " ");
        } else {
          history.pushState(null, null, `#${id}`);
        }
      });
    });
  })();
</script>

<script>
  document.addEventListener('scroll', function (e) {
      const readProgress = document.getElementById("read_progress");
      const scrollHeight = document.documentElement.scrollHeight;
      const clientHeight = document.documentElement.clientHeight;
      const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
      readProgress.innerText = ((scrollTop / (scrollHeight - clientHeight)).toFixed(2) * 100).toFixed(0);
  })
</script>

<script>
  var menu = document.getElementById('menu')
  if (menu) {
      menu.scrollLeft = localStorage.getItem("menu-scroll-position");
      menu.onscroll = function () {
          localStorage.setItem("menu-scroll-position", menu.scrollLeft);
      }
  }

  document.querySelectorAll('a[href^="#"]').forEach(anchor => {
      anchor.addEventListener("click", function (e) {
          e.preventDefault();
          var id = this.getAttribute("href").substr(1);
          if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
              document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                  behavior: "smooth"
              });
          } else {
              document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
          }
          if (id === "top") {
              history.replaceState(null, null, " ");
          } else {
              history.pushState(null, null, `#${id}`);
          }
      });
  });
</script>
<script>
  var mybutton = document.getElementById("top-link");
  window.onscroll = function () {
      if (document.body.scrollTop > 200 || document.documentElement.scrollTop > 200) {
          mybutton.style.visibility = "visible";
          mybutton.style.opacity = "1";
      } else {
          mybutton.style.visibility = "hidden";
          mybutton.style.opacity = "0";
      }
  };
</script>
<script>
  if (window.scrollListeners) {
    
    for (const listener of scrollListeners) {
      window.removeEventListener('scroll', listener)
    }
  }
  window.scrollListeners = []
</script>



<script src="/js/medium-zoom.min.js" data-no-instant
></script>
<script>
  document.querySelectorAll('pre > code').forEach((codeblock) => {
    const container = codeblock.parentNode.parentNode;

    const copybutton = document.createElement('button');
    copybutton.classList.add('copy-code');
    copybutton.innerText = 'copy';

    function copyingDone() {
      copybutton.innerText = 'copied';
      setTimeout(() => {
        copybutton.innerText = 'copy';
      }, 2000);
    }

    copybutton.addEventListener('click', (cb) => {
      if ('clipboard' in navigator) {
        navigator.clipboard.writeText(codeblock.textContent);
        copyingDone();
        return;
      }

      const range = document.createRange();
      range.selectNodeContents(codeblock);
      const selection = window.getSelection();
      selection.removeAllRanges();
      selection.addRange(range);
      try {
        document.execCommand('copy');
        copyingDone();
      } catch (e) { };
      selection.removeRange(range);
    });

    if (container.classList.contains("highlight")) {
      container.appendChild(copybutton);
    } else if (container.parentNode.firstChild == container) {
      
    } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
      
      codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
    } else {
      
      codeblock.parentNode.appendChild(copybutton);
    }
  });
</script>




<script>
  
  
  (function() {
    const enableTocScroll = '1' == '1'
    if (!enableTocScroll) {
      return
    }
    if (!document.querySelector('.toc')) {
      console.log('no toc found, ignore toc scroll')
      return
    }
    

    
    const scrollListeners = window.scrollListeners
    const headings = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id]');
    const activeClass = 'active';

    
    let activeHeading = headings[0];
    getLinkByHeading(activeHeading).classList.add(activeClass);

    const onScroll = () => {
      const passedHeadings = [];
      for (const h of headings) {
        
        if (getOffsetTop(h) < 5) {
          passedHeadings.push(h)
        } else {
          break;
        }
      }
      if (passedHeadings.length > 0) {
        newActiveHeading = passedHeadings[passedHeadings.length - 1];
      } else {
        newActiveHeading = headings[0];
      }
      if (activeHeading != newActiveHeading) {
        getLinkByHeading(activeHeading).classList.remove(activeClass);
        activeHeading = newActiveHeading;
        getLinkByHeading(activeHeading).classList.add(activeClass);
      }
    }

    let timer = null;
    const scrollListener = () => {
      if (timer !== null) {
        clearTimeout(timer)
      }
      timer = setTimeout(onScroll, 50)
    }
    window.addEventListener('scroll', scrollListener, false);
    scrollListeners.push(scrollListener)

    function getLinkByHeading(heading) {
      const id = encodeURI(heading.getAttribute('id')).toLowerCase();
      return document.querySelector(`.toc ul li a[href="#${id}"]`);
    }

    function getOffsetTop(heading) {
      if (!heading.getClientRects().length) {
        return 0;
      }
      let rect = heading.getBoundingClientRect();
      return rect.top
    }
  })();
  </script>

<script src="/js/instantclick.min.js" data-no-instant
></script>
<script data-no-instant>
  
  
  
  
  
  
  InstantClick.init();
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/8.6.0/mermaid.min.js" crossorigin="anonymous"></script>
<script>
    mermaid.init(undefined, '.language-mermaid');
</script>
</body>

</html>
