<!doctype html><html lang=zh dir=auto><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>同步工具rsync使用指南 | Cylon's Collection</title><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NP3JNCPR" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><meta name=keywords content="linux,rsync,synchronize"><meta name=description content="Overview 官方网站：https://www.samba.org/ftp/rsync/rsync.html
rsync特性
rsync类似于scp的功能
rsync还可以在本地的不同分区和目录之间进行全量及增量的复制数据，类似cp又优于cp
rsync可以实现文件的删除
一个rsync相当于 scp cp rm，但是还优于他们每一个
支持拷贝特殊文件如链接文件，设备等 可以有排除指定文件或目录的权限、时间、软硬链接、属主、组所有属性均不改变-p 可以有排除指定文件或目录的功能，相当于打包命令tar的排除功能 可以实现增量同步，即只同步发生变化的数据，因此数据传输效率很高tar。 可以使用rcp rsh ssh等方式来配合传输文件（rsync本身不对数据加密） 可以通过socket（进程方式）传输文件和数据 支持匿名的或认证（无须系统用户）的进程模式传输，可实现方便安全的进行数据备份及镜像 安装rsync linux上安装rsync Platform Command Debian/Ubuntu & Mint sudo apt-get install rsync Arch Linux pacman -S rsync Gentoo emerge sys-apps/rsync Fedora/CentOS/RHEL and Rocky Linux/AlmaLinux sudo yum install rsync openSUSE sudo zypper install rsync windows安装rsync 官网下载cwRsync的服务端和客户端软件，cwRsync官网为：www.itefix.net/cwrsync
Notes：由于伟大的 people‘s leader president xi 网站已经无法中国地区访问（点击测试），伟大的俄罗斯因为俄乌战争，也不对俄罗斯访问了（俄乌战争开始后，西方大量学术网站禁止了俄罗斯地区的访问）
所以目前只能下载到一些镜像站上4.x版本，截止到2022年11月的6.2.7相差很多，windows客户端版本可以通过chocolate 安装
rsync使用说明 rsync命令语法
选项 注释说明 rsync rsync同步命令 option 为同步时的选项参数 src 为源，及待拷贝的分区、文件或目录等 dest 为目标分区、文件或目录等 rsync参数说明"><meta name=author content="cylon"><link rel=canonical href=http://localhost:1313/2017/05/rsync/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=http://localhost:1313/favicon.ico><link rel=icon type=image/png sizes=16x16 href=http://localhost:1313/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=http://localhost:1313/favicon-32x32.png><link rel=apple-touch-icon href=http://localhost:1313/favicon.ico><link rel=mask-icon href=http://localhost:1313/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=http://localhost:1313/2017/05/rsync/><noscript><style>#theme-toggle,#top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link crossorigin=anonymous href=/assets/css/pe.min.css rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/pe.min.js></script><link rel=stylesheet href=https://cdn.staticfile.net/font-awesome/6.5.1/css/all.min.css><link rel=stylesheet href=https://cdn.staticfile.net/font-awesome/6.5.1/css/v4-shims.min.css><script id=MathJax-script async src=https://cdn.staticfile.net/mathjax/3.2.2/es5/tex-chtml.js></script><script>MathJax={tex:{displayMath:[["$$","$$"]],inlineMath:[["\\$","\\$"]]}}</script><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><meta name=referrer content="no-referrer-when-downgrade"><script>(function(e,t,n,s,o){e[s]=e[s]||[],e[s].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var a=t.getElementsByTagName(n)[0],i=t.createElement(n),r=s!="dataLayer"?"&l="+s:"";i.async=!0,i.src="https://www.googletagmanager.com/gtm.js?id="+o+r,a.parentNode.insertBefore(i,a)})(window,document,"script","dataLayer","GTM-NP3JNCPR")</script><meta property="og:title" content="同步工具rsync使用指南"><meta property="og:description" content="Overview 官方网站：https://www.samba.org/ftp/rsync/rsync.html
rsync特性
rsync类似于scp的功能
rsync还可以在本地的不同分区和目录之间进行全量及增量的复制数据，类似cp又优于cp
rsync可以实现文件的删除
一个rsync相当于 scp cp rm，但是还优于他们每一个
支持拷贝特殊文件如链接文件，设备等 可以有排除指定文件或目录的权限、时间、软硬链接、属主、组所有属性均不改变-p 可以有排除指定文件或目录的功能，相当于打包命令tar的排除功能 可以实现增量同步，即只同步发生变化的数据，因此数据传输效率很高tar。 可以使用rcp rsh ssh等方式来配合传输文件（rsync本身不对数据加密） 可以通过socket（进程方式）传输文件和数据 支持匿名的或认证（无须系统用户）的进程模式传输，可实现方便安全的进行数据备份及镜像 安装rsync linux上安装rsync Platform Command Debian/Ubuntu & Mint sudo apt-get install rsync Arch Linux pacman -S rsync Gentoo emerge sys-apps/rsync Fedora/CentOS/RHEL and Rocky Linux/AlmaLinux sudo yum install rsync openSUSE sudo zypper install rsync windows安装rsync 官网下载cwRsync的服务端和客户端软件，cwRsync官网为：www.itefix.net/cwrsync
Notes：由于伟大的 people‘s leader president xi 网站已经无法中国地区访问（点击测试），伟大的俄罗斯因为俄乌战争，也不对俄罗斯访问了（俄乌战争开始后，西方大量学术网站禁止了俄罗斯地区的访问）
所以目前只能下载到一些镜像站上4.x版本，截止到2022年11月的6.2.7相差很多，windows客户端版本可以通过chocolate 安装
rsync使用说明 rsync命令语法
选项 注释说明 rsync rsync同步命令 option 为同步时的选项参数 src 为源，及待拷贝的分区、文件或目录等 dest 为目标分区、文件或目录等 rsync参数说明"><meta property="og:type" content="article"><meta property="og:url" content="http://localhost:1313/2017/05/rsync/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2017-05-07T00:00:00+00:00"><meta property="article:modified_time" content="2022-11-29T23:00:36+08:00"><meta property="og:site_name" content="Cylon's Collection"><meta name=twitter:card content="summary"><meta name=twitter:title content="同步工具rsync使用指南"><meta name=twitter:description content="Overview 官方网站：https://www.samba.org/ftp/rsync/rsync.html
rsync特性
rsync类似于scp的功能
rsync还可以在本地的不同分区和目录之间进行全量及增量的复制数据，类似cp又优于cp
rsync可以实现文件的删除
一个rsync相当于 scp cp rm，但是还优于他们每一个
支持拷贝特殊文件如链接文件，设备等 可以有排除指定文件或目录的权限、时间、软硬链接、属主、组所有属性均不改变-p 可以有排除指定文件或目录的功能，相当于打包命令tar的排除功能 可以实现增量同步，即只同步发生变化的数据，因此数据传输效率很高tar。 可以使用rcp rsh ssh等方式来配合传输文件（rsync本身不对数据加密） 可以通过socket（进程方式）传输文件和数据 支持匿名的或认证（无须系统用户）的进程模式传输，可实现方便安全的进行数据备份及镜像 安装rsync linux上安装rsync Platform Command Debian/Ubuntu & Mint sudo apt-get install rsync Arch Linux pacman -S rsync Gentoo emerge sys-apps/rsync Fedora/CentOS/RHEL and Rocky Linux/AlmaLinux sudo yum install rsync openSUSE sudo zypper install rsync windows安装rsync 官网下载cwRsync的服务端和客户端软件，cwRsync官网为：www.itefix.net/cwrsync
Notes：由于伟大的 people‘s leader president xi 网站已经无法中国地区访问（点击测试），伟大的俄罗斯因为俄乌战争，也不对俄罗斯访问了（俄乌战争开始后，西方大量学术网站禁止了俄罗斯地区的访问）
所以目前只能下载到一些镜像站上4.x版本，截止到2022年11月的6.2.7相差很多，windows客户端版本可以通过chocolate 安装
rsync使用说明 rsync命令语法
选项 注释说明 rsync rsync同步命令 option 为同步时的选项参数 src 为源，及待拷贝的分区、文件或目录等 dest 为目标分区、文件或目录等 rsync参数说明"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"http://localhost:1313/posts/"},{"@type":"ListItem","position":2,"name":"同步工具rsync使用指南","item":"http://localhost:1313/2017/05/rsync/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"同步工具rsync使用指南","name":"同步工具rsync使用指南","description":"Overview 官方网站：https://www.samba.org/ftp/rsync/rsync.html\nrsync特性\nrsync类似于scp的功能\nrsync还可以在本地的不同分区和目录之间进行全量及增量的复制数据，类似cp又优于cp\nrsync可以实现文件的删除\n一个rsync相当于 scp cp rm，但是还优于他们每一个\n支持拷贝特殊文件如链接文件，设备等 可以有排除指定文件或目录的权限、时间、软硬链接、属主、组所有属性均不改变-p 可以有排除指定文件或目录的功能，相当于打包命令tar的排除功能 可以实现增量同步，即只同步发生变化的数据，因此数据传输效率很高tar。 可以使用rcp rsh ssh等方式来配合传输文件（rsync本身不对数据加密） 可以通过socket（进程方式）传输文件和数据 支持匿名的或认证（无须系统用户）的进程模式传输，可实现方便安全的进行数据备份及镜像 安装rsync linux上安装rsync Platform Command Debian/Ubuntu \u0026amp; Mint sudo apt-get install rsync Arch Linux pacman -S rsync Gentoo emerge sys-apps/rsync Fedora/CentOS/RHEL and Rocky Linux/AlmaLinux sudo yum install rsync openSUSE sudo zypper install rsync windows安装rsync 官网下载cwRsync的服务端和客户端软件，cwRsync官网为：www.itefix.net/cwrsync\nNotes：由于伟大的 people‘s leader president xi 网站已经无法中国地区访问（点击测试），伟大的俄罗斯因为俄乌战争，也不对俄罗斯访问了（俄乌战争开始后，西方大量学术网站禁止了俄罗斯地区的访问）\n所以目前只能下载到一些镜像站上4.x版本，截止到2022年11月的6.2.7相差很多，windows客户端版本可以通过chocolate 安装\nrsync使用说明 rsync命令语法\n选项 注释说明 rsync rsync同步命令 option 为同步时的选项参数 src 为源，及待拷贝的分区、文件或目录等 dest 为目标分区、文件或目录等 rsync参数说明","keywords":["linux","rsync","synchronize"],"articleBody":"Overview 官方网站：https://www.samba.org/ftp/rsync/rsync.html\nrsync特性\nrsync类似于scp的功能\nrsync还可以在本地的不同分区和目录之间进行全量及增量的复制数据，类似cp又优于cp\nrsync可以实现文件的删除\n一个rsync相当于 scp cp rm，但是还优于他们每一个\n支持拷贝特殊文件如链接文件，设备等 可以有排除指定文件或目录的权限、时间、软硬链接、属主、组所有属性均不改变-p 可以有排除指定文件或目录的功能，相当于打包命令tar的排除功能 可以实现增量同步，即只同步发生变化的数据，因此数据传输效率很高tar。 可以使用rcp rsh ssh等方式来配合传输文件（rsync本身不对数据加密） 可以通过socket（进程方式）传输文件和数据 支持匿名的或认证（无须系统用户）的进程模式传输，可实现方便安全的进行数据备份及镜像 安装rsync linux上安装rsync Platform Command Debian/Ubuntu \u0026 Mint sudo apt-get install rsync Arch Linux pacman -S rsync Gentoo emerge sys-apps/rsync Fedora/CentOS/RHEL and Rocky Linux/AlmaLinux sudo yum install rsync openSUSE sudo zypper install rsync windows安装rsync 官网下载cwRsync的服务端和客户端软件，cwRsync官网为：www.itefix.net/cwrsync\nNotes：由于伟大的 people‘s leader president xi 网站已经无法中国地区访问（点击测试），伟大的俄罗斯因为俄乌战争，也不对俄罗斯访问了（俄乌战争开始后，西方大量学术网站禁止了俄罗斯地区的访问）\n所以目前只能下载到一些镜像站上4.x版本，截止到2022年11月的6.2.7相差很多，windows客户端版本可以通过chocolate 安装\nrsync使用说明 rsync命令语法\n选项 注释说明 rsync rsync同步命令 option 为同步时的选项参数 src 为源，及待拷贝的分区、文件或目录等 dest 为目标分区、文件或目录等 rsync参数说明\n参数选项 注释说明 -v –verbose 详细模式输出，传输时的进度信息 -z –compress 传输时进行压缩以提高传输效率，--compress-level=NUM 可按级别压缩 -a –archive 归档模式，表示以递归方式传输文件，并保持所有文件属性，等于-rtopgDl r –recursive 对子目录进行递归模式，即目录下的所有目录都同样传输 t –times 保持文件时间信息 o –owner 保持文件属主信息 p –perms 保持文件权限 g –group 保持文件属主信息 P –progress 显示同步的过程及传输时的进度等信息 D –devices 爆出设备文件信息 l –links 保留软连接 -e –rsh=COMMAND 使用的信道协议，制定替代rsh的shell程序，例如ssh -exclude=PATTERN 制定排除不需要传输的文件模式 –bwlimit=RATE 限制socket I/O带宽 –password-file=PATH 指定密码文件，可避免多次输入密码 –delete 如果服务器端为空，而客户端有文件，加上这个参数就会删除客户端目录下所有文件，相当于rm –exclude 排除单/多个文件 –timeout=秒 超时参数 –port 指定端口 -R –relative 使用相对路径信息 -u –update 仅仅进行更新，也就是跳过所有已经存在于DST，并且文件时间晚于要备份的文件。(不覆盖更新的文件) rsync配置文件说明 conf # 每一个程序的进程都要依赖一个用户，默认为nobody，给默认为rsync uid = rsync gid = rsync # 防止出现安全问题的，一般为局域网 use chroot = no # 有多少个客户端可以连接服务器 同时连接的客户端 max connections = 200 # 客户端连接多少时间超时（如连接了不穿数据，多少时间踢掉） timeout = 300 # linux中每个进程都对应一个进程号pid ，pid所在的文件就是pidfile，将来处理进程的时候不用再找了，直接杀pid文件就行 pid file = /var/run/rsyncd.pid # rsync 在传输数据时，双方都在穿可能出错，在一个用户改的时候，其他用户不能改 lock file = /var/run/rsync.lock # 日志，出错 log file = /var/log/rsyncd.log # 模块 相当于nfs共享的目录 可以理解为nfs的 [oldboy] path = /oldboy/ # 在传输过程中遇到错误自动忽略 ignore errors # 可读可写 read only = false # 允不允许你列表 false不允许 list = false # 允许的主机 hosts allow = 10.0.0.0/24 # 拒绝 rsync支持虚拟用户，不是系统用户，这 hosts deny = 0.0.0.0/32 # 传输时验证的用户 auth users = rsync_backup # 用户对应的密码文件，如果指定密码文件，就得来回输入密码，在内网中不需要重复输入密码，就将密码写入文件 secrets file = /etc/rsync.password rsync的工作模式 rsync提供了三种同步模式：\nRsync over SSH Rsync Daemon Local Local rsync如果不使用远程模式类似于cp命令，例如\nrsync /etc/hosts /opt/ == cp /etc/hosts/ /opt/ 注：目录结尾加 / 与不加 / 的区别，不加斜线表示目录以及目录里面的东西，加斜线表示目录里面的东西\nrsync作为damon模式运行 如果主机没有运行 SSH服务，可以使用 rsync --daemon 配置并作为守护进程运行。这种场景下 rsync 监听端口 873 以获取来自其他使用 rsync client 的同步，这种模式下数据是未加密的。\n配置daemon端 配置rsync daemon位置文件\nrsync damon模式配置文件默认在 /etc/rsyncd.conf 如果没有可以自行创建\nconf lock file = /var/run/rsync.lock log file = /var/log/rsyncd.log pid file = /var/run/rsyncd.pid [documents] path = /home/juan/Documents comment = The documents folder of Juan uid = juan gid = juan read only = no list = yes auth users = rsyncclient secrets file = /etc/rsyncd.secrets hosts allow = 192.168.1.0/255.255.255.0 rsyncd配置文件分为两部分，全局参数与模块。\nlock file 是 rsync 用于处理最大连接数的文件 log file 是 rsync 同步时的日志；汇集路开始运行的时间, 其他客户端连接的时间与任何错误 pid file 是 rsync 记录了进程ID，可以使用这个文件来kill进程 在全局参数之后，[] 中的是模块部分，代表的是要同步的一个目录，每个模块都是要共享的文件夹\n[name] 分配给模块的名称，每个模块代表一个目录，不能包含斜杠或右方括号 path 同步的文件夹的路径 comment 当客户端获取所有可用模块的时，获取出的列表内模块名称旁边的注释 uid 当 rsync守护进程以root 身份运行时，可以指定以哪个用户拥有文件的权限 gid 同上 read only 决定rsync 客户端是否可以上传文件，默认所有模块为 true list 允许客户端请求可用模块列表，false 为从列表中隐藏模块。 auth users 允许访问该模块内容的用户列表，用户以逗号分隔。用户不需要存在于系统中，他们由密钥文件定义 secrets file 定义包含rsync同步时用户的用户名和密码的文件 hosts allow 允许连接到rsync daemon的网段，默认允许所有主机连接 创建rsync用户\nbash 1 $ useradd rsync -s /sbin/nologin -M 修改共享的目录的所属权限\nbash 1 $ chown -R rsync.rsync /data 创建密码文件\n该文件中，每行代表一个rsync用户，账号和密码用冒号分隔\nbash 1 2 3 $ echo \"rsync_backup:111111\"\u003e /etc/rsync.password # 因密码可读，所以要降低权限 $ chmod 600 /etc/rsync.password 最后，更改此文件的权限，使其不能被其他用户读取或修改。如果此文件的权限设置不正确，rsync 会报错\nbash 1 sudo chmod 600 /etc/rsyncd.secrets 启动 rsync daemon\n直接使用 --daemon 启动即可\nbash 1 sudo rsync --daemon 使用rsync连接daemon一端 使用 rsync 命令连接 rsync daemon时，不可以像使用 SSH 时那样使用冒号，我们需要使用双冒号 ”::“，后跟模块名，以及同步的文件或文件夹，例如\nbash 1 rsync -rtv user@host::module/source/ destination/ 另一种方法是增加 rsync:// 协议，例如\nbash 1 rsync -rtv rsync://user@host/module/source/ destination/ 如果不想输入密码可以指定参数 --password-file= 提供密码文件，密码文件就是创建的secret file，例如\nbash 1 2 3 $ rsync -avz rsync_backup@192.168.59.121::data \\ /test \\ --password-file=/etc/rsync.password 使用rsync命令推与拉\nPull rsync [OPTION...] [USER@]HOST::SRC... [DEST]\nbash 1 rsync -avz rsync_backup@192.168.59.121::data /test/ --password-file=/etc/rsync.password Push rsync [OPTION...] SRC... [USER@]HOST::DEST || rsync [OPTION...] SRC... rsync://[USER@]HOST[:PORT]/DEST\nbash 1 rsync -avz /test/ rsync://rsync_backup@192.168.59.121/data/ --password-file=/etc/rsync.password Rsync Over SSH 除了daemon模式，也可以使用ssh模式进行传输，例如使用Over SSH命令\nPush rsync [OPTION]... -e ssh [SRC]... [USER@]HOST:DEST Pull rsync [OPTION]... -e ssh [USER@]HOST:SRC... [DEST] 较新版本的 rsync SSH 为默认，可以省略该-e ssh选项，但 over ssh 与 over daemon的区别还是 一个冒号与两个冒号\nrsync使用实例 Over SSH Pull rsync -avz -e 'ssh -p ' @:/ / Push rsync -avz -e 'ssh -p ' / @:/ Local to Remote Push rsync -avzh @: Pull rsync -avzh @: 显示进度条 rsync -avzhe ssh --progress @: Include and exclude 排除和包含可以使用文件，也可以使用正则表达式，例如\n包含R开头文件： rsync -avze --include 'R*' @: 排除所有文件： rsync -avze --exclude '*' @: 仅上传R开头的文件：rsync -avze ssh --include 'R*' --exclude '*' @: --exclude-from 是同步时排除文件中指定的文件 已存在文件的处理策略 如果想保证 与 保持一致可以使用 --delete 来删除 现有文件或目录（只存在于目标目录不存在于源目标的文件）\nbash 1 rsync -avz --delete @: 当在删除或更新目标目录已经存在的文件时，不想删除而想备份，可以指定参数 -b, --backup\n限制传输文件大小 可以使用 “ -–max-size ” 选项指定要传输或同步的最大文件大小。例如限制最大为200k\nbash 1 rsync -avzhe ssh --max-size='200k' @: 同步成功后自动删除源文件 删除发送方的文件：如果不想将备份的本地副本保留在服务器中，可以使用参数 “ –remove-source-files ” 来自动删除 的文件吗，一般用于Push场景中。\nbash 1 rsync --remove-source-files -zvh @: dry run 与kubectl一样，rsync也支持 --dry-run ，该选项不会对文件进行更改但会显示命令的输出，可以与 -v 参数配合，这样就可以看到哪些内容会被同步\nbash 1 rsync --dry-run --remove-source-files -zvh @: 限制传输时带宽 传输时，可以使用选项 “ –bwlimit ” 选项限制I/O带宽（默认单位KB），例如\nbash 1 rsync --bwlimit=100 -avzhe ssh @: 忽略存在 如果目标目录中已经该文件，则忽略，例如\nbash 1 rsync --ignore-existing -zvh @: 同步策略 默认rsync 只检查文件的大小和最后修改日期是否发生变化，如果发生变化，就重新传输；参数 -c，--checksum 可以改变rsync 的校验方式，会通过判断文件内容的校验和，决定是否重新传输。\n参数 --size-only 可以使rsync只同步大小有变化的文件，不考虑文件修改时间的差异。\ntroubleshooting text 1 rsync error: some files/attrs were not transferred (see previous errors) (code 23) at main.c(1039) [sender=3.0.6] 问题原因：服务器端目录不存在。\n解决：在服务器端创建目录即可解决\n日志：2017/05/07 08:02:16 [2852] rsync: chdir /data1 failed:No such file or directory (2)\ntext 1 rsync: failed to set times on \".\" (in data1): Operation not permitted (1) 问题原因：服务器端模块目录权限不对\n解决方法：将服务器模块目录权限更改为rsyncd.conf中的uid与gid\n日志：2017/05/07 08:07:49 [2862] rsync: mkstemp \".paichu.log.yOhm5e\" (in data1) failed: Permission denied\ntext 1 2 rsync: failed to connect to 192.168.59.121: No route to host (113) rsync error: error in socket IO (code 10) at clientserver.c(124) [sender=3.0.6] 问题原因：防火墙处于开启状态\n解决方法：关闭防火墙 /etc/init.d/iptables stop\ntext 1 2 3 @ERROR: auth failed on module data1 rsync error: error starting client-server protocol (code 5) at main.c(1503) [sender=3.0.6] 错误原因：\n配置文件语法错误 密码与用户名错误 密码文件权限过大 解决方法：查看日志，查找具体问题\n日志文件：secrets file must not be other-acessible (see strict modes option)\ntext 1 2 rsync: failed to connect to 192.168.59.121: Connection refused (111) rsync error: error in socket IO (code 10) at clientserver.c(124) [receiver=3.0.6] 原因：rsync服务没开启\ntext 1 2 3 4 5 *** Skipping any contents from this failed directory *** sent 485 bytes received 14 bytes 332.67 bytes/sec total size is 45994 speedup is 92.17 rsync error: some files/attrs were not transferred (see previous errors) (code 23) at main.c(1039) [sender=3.0.6] 原因：服务器同步目录权限不够或所属组\n解决 chown rsync:rsync\n原因：磁盘cache导致拷贝速度逐渐下降 [1]\nrsync拷贝数据过程中发现一个现象：开始拷贝的时候速度很快，每秒有40MB左右，但拷贝几十分钟之后就降到10MB左右了，两边机器都没有跑什么应用，网络用netcat测也没有问题\n然后我观察到的一个问题是两边的 free 命令都显示出内存占用很高，并且是buffered/cache一栏很高，因为这个缓存是可以手工释放的\nbash 1 2 sync; echo 3 \u003e /proc/sys/vm/drop_caches ssh root@new-repos 'sh -c \"sync; echo 3 \u003e /proc/sys/vm/drop_caches\"' 补充说明\nlinux操作系统会将文件系统的内容缓存起来，以便后面用到时加速，但在数据迁移场景下，基本上没有“后面用到时”这个场景，这个缓存反而碍事（TODO: 为什么导致网络io下降） 对于本机内大量拷贝文件，有人提供了一个 nocache命令 Debian/Ubuntu 已经收录了这个工具。它的功能是临时禁用cache，用法是将要执行的命令用 nocache 包住，比如: nocache cp -a ~/ /mnt/backup/home-$(hostname)，但rsync会使用网络通讯，所以nocache rsync 对远端没有作用（ *Note however, that rsync uses sockets, so if you try a nocache rsync, only the local process will be intercepted.） 也有人在多年以前给rsync提交了一个补丁，增加了 --drop-cache 选项，但遗憾的是没被接纳，说是过于 linux-specific，开发人员的意见（见comment 3 ）是改用nocache: nocache rsync -aiv --rsync-path='nocache rsync' some-host:/src/ /dest/. P.S. nocache工具的主页最后在acknowledgements部分 说，其实它是衍生自rsync的这个补丁的。 Reference [1] rsync用于数据迁移/备份的几个细节\n","wordCount":"965","inLanguage":"zh","datePublished":"2017-05-07T00:00:00Z","dateModified":"2022-11-29T23:00:36+08:00","author":{"@type":"Person","name":"cylon"},"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:1313/2017/05/rsync/"},"publisher":{"@type":"Organization","name":"Cylon's Collection","logo":{"@type":"ImageObject","url":"http://localhost:1313/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=http://localhost:1313/><img src=http://localhost:1313/favicon.ico alt aria-label=logo height=20>Cylon's Collection</a><div class=logo-switches><button id=theme-toggle><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=http://localhost:1313/archives><span>归档</span></a></li><li><a href=http://localhost:1313/tags><span>标签</span></a></li><li><a href=http://localhost:1313/search><span>搜索</span></a></li><li><a href=http://localhost:1313/about accesskey=/><span>关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">同步工具rsync使用指南</h1><div class=post-meta><span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar" style="user-select:text"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" style="user-select:text"/><line x1="16" y1="2" x2="16" y2="6" style="user-select:text"/><line x1="8" y1="2" x2="8" y2="6" style="user-select:text"/><line x1="3" y1="10" x2="21" y2="10" style="user-select:text"/></svg><span>2017-05-07</span></span>&nbsp;·&nbsp;<span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text" style="user-select:text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z" style="user-select:text"/><polyline points="14 2 14 8 20 8" style="user-select:text"/><line x1="16" y1="13" x2="8" y2="13" style="user-select:text"/><line x1="16" y1="17" x2="8" y2="17" style="user-select:text"/><polyline points="10 9 9 9 8 9" style="user-select:text"/></svg><span>965 字</span></span>&nbsp;·&nbsp;<span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><span>5 分钟</span></span>
<span class=pe-post-meta-item>&nbsp;·&nbsp;<svg t="1714036239378" fill="currentcolor" class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="6659" width="256" height="256"><path d="M690 78.2c-18.6-18.8-49-19-67.8-.4s-19 49-.4 67.8l255.4 258.6c67.8 68.6 67.8 178.8.0 247.4L653.4 878.2c-18.6 18.8-18.4 49.2.4 67.8s49.2 18.4 67.8-.4l224-226.4c104.8-106 104.8-276.4.0-382.4L690 78.2zM485.4 101.4c-24-24-56.6-37.4-90.6-37.4H96C43 64 0 107 0 160v299c0 34 13.4 66.6 37.4 90.6l336 336c50 50 131 50 181 0l267-267c50-50 50-131 0-181l-336-336zM96 160h299c8.4.0 16.6 3.4 22.6 9.4l336 336c12.4 12.4 12.4 32.8.0 45.2l-267 267c-12.4 12.4-32.8 12.4-45.2.0l-336-336c-6-6-9.4-14.2-9.4-22.6V160zm192 128a64 64 0 10-128 0 64 64 0 10128 0z" p-id="6660"/></svg></span><ul class=pe-post-meta-item><a href=http://localhost:1313/tags/linux/>#Linux</a></ul></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details><summary><span class=details>目录</span></summary><div class=inner><ul><li><a href=#overview aria-label=Overview>Overview</a><li><a href=#%e5%ae%89%e8%a3%85rsync aria-label=安装rsync>安装rsync</a><ul><li><a href=#linux%e4%b8%8a%e5%ae%89%e8%a3%85rsync aria-label=linux上安装rsync>linux上安装rsync</a><li><a href=#windows%e5%ae%89%e8%a3%85rsync aria-label=windows安装rsync>windows安装rsync</a><li><a href=#rsync%e4%bd%bf%e7%94%a8%e8%af%b4%e6%98%8e aria-label=rsync使用说明>rsync使用说明</a><li><a href=#rsync%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6%e8%af%b4%e6%98%8e aria-label=rsync配置文件说明>rsync配置文件说明</a></ul><li><a href=#rsync%e7%9a%84%e5%b7%a5%e4%bd%9c%e6%a8%a1%e5%bc%8f aria-label=rsync的工作模式>rsync的工作模式</a><li><a href=#local aria-label=Local>Local</a><ul><li><a href=#rsync%e4%bd%9c%e4%b8%badamon%e6%a8%a1%e5%bc%8f%e8%bf%90%e8%a1%8c aria-label=rsync作为damon模式运行>rsync作为damon模式运行</a><ul><li><a href=#%e9%85%8d%e7%bd%aedaemon%e7%ab%af aria-label=配置daemon端>配置daemon端</a><li><a href=#%e4%bd%bf%e7%94%a8rsync%e8%bf%9e%e6%8e%a5daemon%e4%b8%80%e7%ab%af aria-label=使用rsync连接daemon一端>使用rsync连接daemon一端</a></ul><li><a href=#rsync-over-ssh aria-label="Rsync Over SSH">Rsync Over SSH</a></ul><li><a href=#rsync%e4%bd%bf%e7%94%a8%e5%ae%9e%e4%be%8b aria-label=rsync使用实例>rsync使用实例</a><ul><li><a href=#over-ssh aria-label="Over SSH">Over SSH</a><li><a href=#local-to-remote aria-label="Local to Remote">Local to Remote</a><li><a href=#%e6%98%be%e7%a4%ba%e8%bf%9b%e5%ba%a6%e6%9d%a1 aria-label=显示进度条>显示进度条</a><li><a href=#include-and-exclude aria-label="Include and exclude">Include and exclude</a><li><a href=#%e5%b7%b2%e5%ad%98%e5%9c%a8%e6%96%87%e4%bb%b6%e7%9a%84%e5%a4%84%e7%90%86%e7%ad%96%e7%95%a5 aria-label=已存在文件的处理策略>已存在文件的处理策略</a><li><a href=#%e9%99%90%e5%88%b6%e4%bc%a0%e8%be%93%e6%96%87%e4%bb%b6%e5%a4%a7%e5%b0%8f aria-label=限制传输文件大小>限制传输文件大小</a><li><a href=#%e5%90%8c%e6%ad%a5%e6%88%90%e5%8a%9f%e5%90%8e%e8%87%aa%e5%8a%a8%e5%88%a0%e9%99%a4%e6%ba%90%e6%96%87%e4%bb%b6 aria-label=同步成功后自动删除源文件>同步成功后自动删除源文件</a><li><a href=#dry-run aria-label="dry run">dry run</a><li><a href=#%e9%99%90%e5%88%b6%e4%bc%a0%e8%be%93%e6%97%b6%e5%b8%a6%e5%ae%bd aria-label=限制传输时带宽>限制传输时带宽</a><li><a href=#%e5%bf%bd%e7%95%a5%e5%ad%98%e5%9c%a8 aria-label=忽略存在>忽略存在</a><li><a href=#%e5%90%8c%e6%ad%a5%e7%ad%96%e7%95%a5 aria-label=同步策略>同步策略</a></ul><li><a href=#troubleshooting aria-label=troubleshooting>troubleshooting</a><li><a href=#reference aria-label=Reference>Reference</a></li></div></details></div></aside><script src=/js/pe-toc.min.445eb1bfc5e85dd13b9519fcc2a806522e9629b6224a2974052789ba00ab78af.js integrity="sha256-RF6xv8XoXdE7lRn8wqgGUi6WKbYiSil0BSeJugCreK8="></script><div class=post-content><h2 id=overview>Overview<a hidden class=anchor aria-hidden=true href=#overview>#</a></h2><p>官方网站：https://www.samba.org/ftp/rsync/rsync.html</p><p>rsync特性</p><ul><li><p>rsync类似于scp的功能</p></li><li><p>rsync还可以在本地的不同分区和目录之间进行全量及增量的复制数据，类似cp又优于cp</p></li><li><p>rsync可以实现文件的删除</p></li></ul><p>一个rsync相当于 scp cp rm，但是还优于他们每一个</p><ul><li>支持拷贝特殊文件如链接文件，设备等</li><li>可以有排除指定文件或目录的权限、时间、软硬链接、属主、组所有属性均不改变-p</li><li>可以有排除指定文件或目录的功能，相当于打包命令tar的排除功能</li><li>可以实现增量同步，即只同步发生变化的数据，因此数据传输效率很高tar。</li><li>可以使用rcp rsh ssh等方式来配合传输文件（rsync本身不对数据加密）</li><li>可以通过socket（进程方式）传输文件和数据</li><li>支持匿名的或认证（无须系统用户）的进程模式传输，可实现方便安全的进行数据备份及镜像</li></ul><h2 id=安装rsync>安装rsync<a hidden class=anchor aria-hidden=true href=#安装rsync>#</a></h2><h3 id=linux上安装rsync>linux上安装rsync<a hidden class=anchor aria-hidden=true href=#linux上安装rsync>#</a></h3><table><thead><tr><th>Platform</th><th>Command</th></tr></thead><tbody><tr><td>Debian/Ubuntu & Mint</td><td>sudo apt-get install rsync</td></tr><tr><td>Arch Linux</td><td>pacman -S rsync</td></tr><tr><td>Gentoo</td><td>emerge sys-apps/rsync</td></tr><tr><td>Fedora/CentOS/RHEL and Rocky Linux/AlmaLinux</td><td>sudo yum install rsync</td></tr><tr><td>openSUSE</td><td>sudo zypper install rsync</td></tr></tbody></table><h3 id=windows安装rsync>windows安装rsync<a hidden class=anchor aria-hidden=true href=#windows安装rsync>#</a></h3><p>官网下载cwRsync的服务端和客户端软件，cwRsync官网为：www.itefix.net/cwrsync</p><blockquote><p>Notes：由于伟大的 people‘s leader president xi 网站已经无法中国地区访问（<a href=https://tcp.ping.pe/www.itefix.net:443 target=_blank rel="noopener nofollow noreferrer">点击测试</a>），伟大的俄罗斯因为俄乌战争，也不对俄罗斯访问了（俄乌战争开始后，西方大量学术网站禁止了俄罗斯地区的访问）</p></blockquote><p>所以目前只能下载到一些镜像站上4.x版本，截止到2022年11月的6.2.7相差很多，windows客户端版本可以通过<code>chocolate</code> 安装</p><h3 id=rsync使用说明>rsync使用说明<a hidden class=anchor aria-hidden=true href=#rsync使用说明>#</a></h3><p>rsync命令语法</p><table><thead><tr><th>选项</th><th>注释说明</th></tr></thead><tbody><tr><td>rsync</td><td>rsync同步命令</td></tr><tr><td>option</td><td>为同步时的选项参数</td></tr><tr><td>src</td><td>为源，及待拷贝的分区、文件或目录等</td></tr><tr><td>dest</td><td>为目标分区、文件或目录等</td></tr></tbody></table><p>rsync参数说明</p><table><thead><tr><th>参数选项</th><th>注释说明</th></tr></thead><tbody><tr><td>-v &ndash;verbose</td><td>详细模式输出，传输时的进度信息</td></tr><tr><td>-z &ndash;compress</td><td>传输时进行压缩以提高传输效率，<code>--compress-level=NUM</code> 可按级别压缩</td></tr><tr><td>-a &ndash;archive</td><td>归档模式，表示以递归方式传输文件，并保持所有文件属性，等于-rtopgDl</td></tr><tr><td>r &ndash;recursive</td><td>对子目录进行递归模式，即目录下的所有目录都同样传输</td></tr><tr><td>t &ndash;times</td><td>保持文件时间信息</td></tr><tr><td>o &ndash;owner</td><td>保持文件属主信息</td></tr><tr><td>p &ndash;perms</td><td>保持文件权限</td></tr><tr><td>g &ndash;group</td><td>保持文件属主信息</td></tr><tr><td>P &ndash;progress</td><td>显示同步的过程及传输时的进度等信息</td></tr><tr><td>D &ndash;devices</td><td>爆出设备文件信息</td></tr><tr><td>l &ndash;links</td><td>保留软连接</td></tr><tr><td>-e &ndash;rsh=<strong>COMMAND</strong></td><td>使用的信道协议，制定替代rsh的shell程序，例如ssh</td></tr><tr><td>-exclude=<strong>PATTERN</strong></td><td>制定排除不需要传输的文件模式</td></tr><tr><td>&ndash;bwlimit=<strong>RATE</strong></td><td>限制socket I/O带宽</td></tr><tr><td>&ndash;password-file=<strong>PATH</strong></td><td>指定密码文件，可避免多次输入密码</td></tr><tr><td>&ndash;delete</td><td>如果服务器端为空，而客户端有文件，加上这个参数就会删除客户端目录下所有文件，相当于rm</td></tr><tr><td>&ndash;exclude</td><td>排除单/多个文件</td></tr><tr><td>&ndash;timeout=<strong>秒</strong></td><td>超时参数</td></tr><tr><td>&ndash;port</td><td>指定端口</td></tr><tr><td>-R &ndash;relative</td><td>使用相对路径信息</td></tr><tr><td>-u &ndash;update</td><td>仅仅进行更新，也就是跳过所有已经存在于DST，并且文件时间晚于要备份的文件。(不覆盖更新的文件)</td></tr></tbody></table><h3 id=rsync配置文件说明>rsync配置文件说明<a hidden class=anchor aria-hidden=true href=#rsync配置文件说明>#</a></h3><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>conf</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><pre tabindex=0><code class=language-conf data-lang=conf># 每一个程序的进程都要依赖一个用户，默认为nobody，给默认为rsync
uid = rsync
gid = rsync
# 防止出现安全问题的，一般为局域网
use chroot = no
# 有多少个客户端可以连接服务器 同时连接的客户端
max connections = 200
# 客户端连接多少时间超时（如连接了不穿数据，多少时间踢掉）
timeout = 300
# linux中每个进程都对应一个进程号pid ，pid所在的文件就是pidfile，将来处理进程的时候不用再找了，直接杀pid文件就行
pid file = /var/run/rsyncd.pid
# rsync 在传输数据时，双方都在穿可能出错，在一个用户改的时候，其他用户不能改
lock file = /var/run/rsync.lock
# 日志，出错
log file = /var/log/rsyncd.log
# 模块 相当于nfs共享的目录 可以理解为nfs的
[oldboy]
path = /oldboy/
# 在传输过程中遇到错误自动忽略
ignore errors
# 可读可写 
read only = false
# 允不允许你列表 false不允许
list = false
# 允许的主机
hosts allow = 10.0.0.0/24
# 拒绝 rsync支持虚拟用户，不是系统用户，这
hosts deny = 0.0.0.0/32
# 传输时验证的用户
auth users = rsync_backup
# 用户对应的密码文件，如果指定密码文件，就得来回输入密码，在内网中不需要重复输入密码，就将密码写入文件
secrets file = /etc/rsync.password</code></pre></div></div><h2 id=rsync的工作模式>rsync的工作模式<a hidden class=anchor aria-hidden=true href=#rsync的工作模式>#</a></h2><p>rsync提供了三种同步模式：</p><ul><li>Rsync over SSH</li><li>Rsync Daemon</li><li>Local</li></ul><h2 id=local>Local<a hidden class=anchor aria-hidden=true href=#local>#</a></h2><p>rsync如果不使用远程模式类似于cp命令，例如</p><ul><li><code>rsync /etc/hosts /opt/</code> == <code>cp /etc/hosts/ /opt/</code></li></ul><hr><p>注：目录结尾加 <code>/</code> 与不加 <code>/</code> 的区别，不加斜线表示目录以及目录里面的东西，加斜线表示目录里面的东西</p><hr><h3 id=rsync作为damon模式运行>rsync作为damon模式运行<a hidden class=anchor aria-hidden=true href=#rsync作为damon模式运行>#</a></h3><p>如果主机没有运行 SSH服务，可以使用 <code>rsync --daemon</code> 配置并作为守护进程运行。这种场景下 <code>rsync</code> 监听端口 873 以获取来自其他使用 <code>rsync client</code> 的同步，这种模式下数据是未加密的。</p><h4 id=配置daemon端>配置daemon端<a hidden class=anchor aria-hidden=true href=#配置daemon端>#</a></h4><p><strong>配置rsync daemon位置文件</strong></p><p>rsync damon模式配置文件默认在 <code>/etc/rsyncd.conf</code> 如果没有可以自行创建</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>conf</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><pre tabindex=0><code class=language-conf data-lang=conf>lock file = /var/run/rsync.lock
log file = /var/log/rsyncd.log
pid file = /var/run/rsyncd.pid

[documents]
    path = /home/juan/Documents
    comment = The documents folder of Juan
    uid = juan
    gid = juan
    read only = no
    list = yes
    auth users = rsyncclient
    secrets file = /etc/rsyncd.secrets
    hosts allow = 192.168.1.0/255.255.255.0</code></pre></div></div><p>rsyncd配置文件分为两部分，<strong>全局参数</strong>与<strong>模块</strong>。</p><ul><li><code>lock file</code> 是 <code>rsync</code> 用于处理最大连接数的文件</li><li><code>log file</code> 是 <code>rsync</code> 同步时的日志；汇集路开始运行的时间, 其他客户端连接的时间与任何错误</li><li><code>pid file</code> 是 <code>rsync</code> 记录了进程ID，可以使用这个文件来kill进程</li></ul><p>在全局参数之后，<code>[]</code> 中的是模块部分，代表的是要同步的一个目录，每个模块都是要共享的文件夹</p><ul><li><code>[name]</code> 分配给模块的名称，每个模块代表一个目录，不能包含斜杠或右方括号</li><li><code>path</code> 同步的文件夹的路径</li><li><code>comment</code> 当客户端获取所有可用模块的时，获取出的列表内模块名称旁边的注释</li><li><code>uid</code> 当 rsync守护进程以root 身份运行时，可以指定以哪个用户拥有文件的权限</li><li><code>gid</code> 同上</li><li><code>read only</code> 决定rsync 客户端是否可以上传文件，默认所有模块为 true</li><li><code>list</code> 允许客户端请求可用模块列表，false 为从列表中隐藏模块。</li><li><code>auth users</code> 允许访问该模块内容的用户列表，用户以逗号分隔。用户不需要存在于系统中，他们由密钥文件定义</li><li><code>secrets file</code> 定义包含rsync同步时用户的用户名和密码的文件</li><li><code>hosts allow</code> 允许连接到rsync daemon的网段，默认允许所有主机连接</li></ul><p><strong>创建rsync用户</strong></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ useradd rsync -s /sbin/nologin -M</span></span></code></pre></td></tr></table></div></div></div></div><p><strong>修改共享的目录的所属权限</strong></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ chown -R rsync.rsync /data  </span></span></code></pre></td></tr></table></div></div></div></div><p><strong>创建密码文件</strong></p><p>该文件中，每行代表一个rsync用户，账号和密码用冒号分隔</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ <span class=nb>echo</span> <span class=s2>&#34;rsync_backup:111111&#34;</span>&gt; /etc/rsync.password
</span></span><span class=line><span class=cl><span class=c1># 因密码可读，所以要降低权限</span>
</span></span><span class=line><span class=cl>$ chmod <span class=m>600</span> /etc/rsync.password</span></span></code></pre></td></tr></table></div></div></div></div><p>最后，更改此文件的权限，使其不能被其他用户读取或修改。如果此文件的权限设置不正确，<code>rsync</code> 会报错</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo chmod <span class=m>600</span> /etc/rsyncd.secrets</span></span></code></pre></td></tr></table></div></div></div></div><p><strong>启动 rsync daemon</strong></p><p>直接使用 <code>--daemon</code> 启动即可</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo rsync --daemon</span></span></code></pre></td></tr></table></div></div></div></div><h4 id=使用rsync连接daemon一端>使用rsync连接daemon一端<a hidden class=anchor aria-hidden=true href=#使用rsync连接daemon一端>#</a></h4><p>使用 <code>rsync</code> 命令连接 rsync daemon时，不可以像使用 SSH 时那样使用冒号，我们需要使用双冒号 ”::“，后跟模块名，以及同步的文件或文件夹，例如</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>rsync -rtv user@host::module/source/ destination/</span></span></code></pre></td></tr></table></div></div></div></div><p>另一种方法是增加 <code>rsync://</code> 协议，例如</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>rsync -rtv rsync://user@host/module/source/ destination/</span></span></code></pre></td></tr></table></div></div></div></div><p>如果不想输入密码可以指定参数 <code>--password-file=</code> 提供密码文件，密码文件就是创建的secret file，例如</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ rsync -avz rsync_backup@192.168.59.121::data <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	/test <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	--password-file<span class=o>=</span>/etc/rsync.password </span></span></code></pre></td></tr></table></div></div></div></div><p>使用rsync命令推与拉</p><ul><li><p>Pull <code>rsync [OPTION...] [USER@]HOST::SRC... [DEST]</code></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>rsync -avz rsync_backup@192.168.59.121::data /test/ --password-file<span class=o>=</span>/etc/rsync.password</span></span></code></pre></td></tr></table></div></div></div></div></li><li><p>Push <code>rsync [OPTION...] SRC... [USER@]HOST::DEST</code> || <code>rsync [OPTION...] SRC... rsync://[USER@]HOST[:PORT]/DEST</code></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>rsync -avz /test/ rsync://rsync_backup@192.168.59.121/data/  --password-file<span class=o>=</span>/etc/rsync.password</span></span></code></pre></td></tr></table></div></div></div></div></li></ul><h3 id=rsync-over-ssh>Rsync Over SSH<a hidden class=anchor aria-hidden=true href=#rsync-over-ssh>#</a></h3><p>除了daemon模式，也可以使用ssh模式进行传输，例如使用Over SSH命令</p><ul><li>Push <code>rsync [OPTION]... -e ssh [SRC]... [USER@]HOST:DEST</code></li><li>Pull <code>rsync [OPTION]... -e ssh [USER@]HOST:SRC... [DEST]</code></li></ul><p>较新版本的 rsync SSH 为默认，可以省略该<code>-e ssh</code>选项，但 over ssh 与 over daemon的区别还是 一个冒号与两个冒号</p><h2 id=rsync使用实例>rsync使用实例<a hidden class=anchor aria-hidden=true href=#rsync使用实例>#</a></h2><h3 id=over-ssh>Over SSH<a hidden class=anchor aria-hidden=true href=#over-ssh>#</a></h3><ul><li>Pull <code>rsync -avz -e 'ssh -p &lt;port>' &lt;user>@&lt;host>:/&lt;remote_dir> /&lt;local_dir></code></li><li>Push <code>rsync -avz -e 'ssh -p &lt;port>' /&lt;local_dir> &lt;user>@&lt;host>:/&lt;remote_dir></code></li></ul><h3 id=local-to-remote>Local to Remote<a hidden class=anchor aria-hidden=true href=#local-to-remote>#</a></h3><ul><li>Push <code>rsync -avzh &lt;local_dir> &lt;system_user>@&lt;host>:&lt;remote_dir></code></li><li>Pull <code>rsync -avzh &lt;system_user>@&lt;host>:&lt;remote_dir> &lt;local_dir></code></li></ul><h3 id=显示进度条>显示进度条<a hidden class=anchor aria-hidden=true href=#显示进度条>#</a></h3><ul><li><code>rsync -avzhe ssh --progress &lt;local_dir> &lt;system_user>@&lt;host>:&lt;remote_dir></code></li></ul><h3 id=include-and-exclude>Include and exclude<a hidden class=anchor aria-hidden=true href=#include-and-exclude>#</a></h3><p>排除和包含可以使用文件，也可以使用正则表达式，例如</p><ul><li>包含R开头文件： <code>rsync -avze --include 'R*' &lt;system_user>@&lt;host>:&lt;remote_dir> &lt;local_dir></code></li><li>排除所有文件： <code>rsync -avze --exclude '*' &lt;system_user>@&lt;host>:&lt;remote_dir> &lt;local_dir></code></li><li>仅上传R开头的文件：<code>rsync -avze ssh --include 'R*' --exclude '*' &lt;system_user>@&lt;host>:&lt;remote_dir> &lt;local_dir></code></li><li><code>--exclude-from</code> 是同步时排除文件中指定的文件</li></ul><h3 id=已存在文件的处理策略>已存在文件的处理策略<a hidden class=anchor aria-hidden=true href=#已存在文件的处理策略>#</a></h3><p>如果想保证 <code>&lt;Src></code> 与 <code>&lt;DST></code> 保持一致可以使用 <code>--delete</code> 来删除 <code>&lt;Src></code> 现有文件或目录（只存在于目标目录不存在于源目标的文件）</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>rsync -avz --delete &lt;system_user&gt;@&lt;host&gt;:&lt;remote_dir&gt; &lt;local_dir&gt;</span></span></code></pre></td></tr></table></div></div></div></div><p>当在删除或更新目标目录已经存在的文件时，不想删除而想备份，可以指定参数 <code>-b</code>, <code>--backup</code></p><h3 id=限制传输文件大小>限制传输文件大小<a hidden class=anchor aria-hidden=true href=#限制传输文件大小>#</a></h3><p>可以使用 “ <strong>-–max-size</strong> ” 选项指定要传输或同步的<strong>最大文件大小</strong>。例如限制最大为200k</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>rsync -avzhe ssh --max-size<span class=o>=</span><span class=s1>&#39;200k&#39;</span> &lt;local_dir&gt; &lt;system_user&gt;@&lt;host&gt;:&lt;remote_dir&gt;</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=同步成功后自动删除源文件>同步成功后自动删除源文件<a hidden class=anchor aria-hidden=true href=#同步成功后自动删除源文件>#</a></h3><p>删除发送方的文件：如果不想将备份的本地副本保留在服务器中，可以使用参数 “ <strong>&ndash;remove-source-files</strong> ” 来自动删除 <code>&lt;src></code> 的文件吗，一般用于Push场景中。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>rsync --remove-source-files -zvh &lt;local_dir&gt; &lt;system_user&gt;@&lt;host&gt;:&lt;remote_dir&gt;</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=dry-run>dry run<a hidden class=anchor aria-hidden=true href=#dry-run>#</a></h3><p>与kubectl一样，rsync也支持 <code>--dry-run</code> ，该选项不会对文件进行更改但会显示命令的输出，可以与 <code>-v</code> 参数配合，这样就可以看到哪些内容会被同步</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>rsync --dry-run --remove-source-files -zvh &lt;local_dir&gt; &lt;system_user&gt;@&lt;host&gt;:&lt;remote_dir&gt;</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=限制传输时带宽>限制传输时带宽<a hidden class=anchor aria-hidden=true href=#限制传输时带宽>#</a></h3><p>传输时，可以使用选项 “ <strong>&ndash;bwlimit</strong> ” 选项限制<strong>I/O</strong>带宽（默认单位KB），例如</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>rsync --bwlimit<span class=o>=</span><span class=m>100</span> -avzhe ssh &lt;local_dir&gt; &lt;system_user&gt;@&lt;host&gt;:&lt;remote_dir&gt;</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=忽略存在>忽略存在<a hidden class=anchor aria-hidden=true href=#忽略存在>#</a></h3><p>如果目标目录中已经该文件，则忽略，例如</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>rsync --ignore-existing -zvh &lt;local_dir&gt; &lt;system_user&gt;@&lt;host&gt;:&lt;remote_dir&gt;</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=同步策略>同步策略<a hidden class=anchor aria-hidden=true href=#同步策略>#</a></h3><p>默认rsync 只检查文件的大小和最后修改日期是否发生变化，如果发生变化，就重新传输；参数 <code>-c</code>，<code>--checksum</code> 可以改变<code>rsync</code> 的校验方式，会通过判断文件内容的校验和，决定是否重新传输。</p><p>参数 <code>--size-only</code> 可以使rsync只同步大小有变化的文件，不考虑文件修改时间的差异。</p><h2 id=troubleshooting>troubleshooting<a hidden class=anchor aria-hidden=true href=#troubleshooting>#</a></h2><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>text</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>rsync error: some files/attrs were not transferred (see previous errors) (code 23) at main.c(1039) [sender=3.0.6]</span></span></code></pre></td></tr></table></div></div></div></div><p>问题原因：服务器端目录不存在。</p><p>解决：在服务器端创建目录即可解决</p><p>日志：<code>2017/05/07 08:02:16 [2852] rsync: chdir /data1 failed:No such file or directory (2)</code></p><hr><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>text</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>rsync: failed to set times on &#34;.&#34; (in data1): Operation not permitted (1)</span></span></code></pre></td></tr></table></div></div></div></div><p>问题原因：服务器端模块目录权限不对</p><p>解决方法：将服务器模块目录权限更改为rsyncd.conf中的uid与gid</p><p>日志：<code>2017/05/07 08:07:49 [2862] rsync: mkstemp ".paichu.log.yOhm5e" (in data1) failed: Permission denied</code></p><hr><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>text</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>rsync: failed to connect to 192.168.59.121: No route to host (113)
</span></span><span class=line><span class=cl>rsync error: error in socket IO (code 10) at clientserver.c(124) [sender=3.0.6]</span></span></code></pre></td></tr></table></div></div></div></div><p>问题原因：防火墙处于开启状态</p><p>解决方法：关闭防火墙 <code>/etc/init.d/iptables stop</code></p><hr><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>text</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>@ERROR: auth failed on module data1
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>rsync error: error starting client-server protocol (code 5) at main.c(1503) [sender=3.0.6]</span></span></code></pre></td></tr></table></div></div></div></div><p>错误原因：</p><ul><li>配置文件语法错误</li><li>密码与用户名错误</li><li>密码文件权限过大</li></ul><p>解决方法：查看日志，查找具体问题</p><p>日志文件：<code>secrets file must not be other-acessible (see strict modes option)</code></p><hr><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>text</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>rsync: failed to connect to 192.168.59.121: Connection refused (111)
</span></span><span class=line><span class=cl>rsync error: error in socket IO (code 10) at clientserver.c(124) [receiver=3.0.6]</span></span></code></pre></td></tr></table></div></div></div></div><p>原因：rsync服务没开启</p><hr><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>text</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>*** Skipping any contents from this failed directory ***
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>sent 485 bytes  received 14 bytes  332.67 bytes/sec
</span></span><span class=line><span class=cl>total size is 45994  speedup is 92.17
</span></span><span class=line><span class=cl>rsync error: some files/attrs were not transferred (see previous errors) (code 23) at main.c(1039) [sender=3.0.6]</span></span></code></pre></td></tr></table></div></div></div></div><p>原因：服务器同步目录权限不够或所属组</p><p>解决 chown rsync:rsync</p><hr><p>原因：磁盘cache导致拷贝速度逐渐下降 <sup id=keywords><a href=#1>[1]</a></sup></p><p>rsync拷贝数据过程中发现一个现象：开始拷贝的时候速度很快，每秒有40MB左右，但拷贝几十分钟之后就降到10MB左右了，两边机器都没有跑什么应用，网络用netcat测也没有问题</p><p>然后我观察到的一个问题是两边的 <code>free</code> 命令都显示出内存占用很高，并且是<code>buffered/cache</code>一栏很高，因为这个缓存是可以手工释放的</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sync<span class=p>;</span> <span class=nb>echo</span> <span class=m>3</span> &gt; /proc/sys/vm/drop_caches
</span></span><span class=line><span class=cl>ssh root@new-repos <span class=s1>&#39;sh -c &#34;sync; echo 3 &gt; /proc/sys/vm/drop_caches&#34;&#39;</span></span></span></code></pre></td></tr></table></div></div></div></div><p>补充说明</p><ul><li>linux操作系统会将文件系统的内容缓存起来，以便后面用到时加速，但在数据迁移场景下，基本上没有“后面用到时”这个场景，这个缓存反而碍事（TODO: 为什么导致网络io下降）</li><li>对于本机内大量拷贝文件，有人提供了一个 <a href=https://github.com/Feh/nocache target=_blank rel="noopener nofollow noreferrer">nocache命令</a> <a href=Debian/Ubuntu>Debian/Ubuntu </a>已经收录了这个工具。它的功能是临时禁用cache，用法是将要执行的命令用 <code>nocache</code> 包住，比如: <code>nocache cp -a ~/ /mnt/backup/home-$(hostname)</code>，但rsync会使用网络通讯，所以<code>nocache rsync</code> 对远端没有作用（ *Note however, that rsync uses sockets, so if you try a nocache rsync, only the local process will be intercepted.）</li><li>也有人在多年以前给rsync提交了一个<a href="https://bugzilla.samba.org/show_bug.cgi?id=9560" target=_blank rel="noopener nofollow noreferrer">补丁</a>，增加了 <code>--drop-cache</code> 选项，但遗憾的是没被接纳，说是过于 linux-specific，开发人员的意见（<a href="https://bugzilla.samba.org/show_bug.cgi?id=9560#c3" target=_blank rel="noopener nofollow noreferrer">见comment 3</a> ）是改用<code>nocache</code>: <code>nocache rsync -aiv --rsync-path='nocache rsync' some-host:/src/ /dest/</code>. P.S. nocache工具的主页最后在<a href=https://github.com/Feh/nocache#acknowledgements target=_blank rel="noopener nofollow noreferrer">acknowledgements部分</a> 说，其实它是衍生自rsync的这个补丁的。</li></ul><hr><h2 id=reference>Reference<a hidden class=anchor aria-hidden=true href=#reference>#</a></h2><blockquote><p><sup id=1>[1]</sup> <a href=https://www.cnblogs.com/bamanzi/p/rsync-gotchas.html target=_blank rel="noopener nofollow noreferrer">rsync用于数据迁移/备份的几个细节</a></p></blockquote></div><div class=pe-copyright><hr><blockquote><p>本文为原创内容，版权归作者所有。如需转载，请在文章中声明本文标题及链接。</p><p>文章标题：同步工具rsync使用指南</p><p>文章链接：<a href=http://localhost:1313/2017/05/rsync/ target=_blank>http://localhost:1313/2017/05/rsync/</a></p><p>许可协议：<a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></p></blockquote></div><footer class=post-footer><ul class=post-tags><li><a href=http://localhost:1313/tags/linux/>Linux</a></li></ul><nav class=paginav><a class=prev href=http://localhost:1313/2017/05/ch1-mysql-deployment/><span class=title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left" style="user-select:text"><line x1="19" y1="12" x2="5" y2="12" style="user-select:text"/><polyline points="12 19 5 12 12 5" style="user-select:text"/></polyline></svg>&nbsp;</span>
<span>ch01 - Linux下安装Mysql</span>
</a><a class=next href=http://localhost:1313/2017/03/firewalld/><span class=title></span>
<span>firewalld&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right" style="user-select:text"><line x1="5" y1="12" x2="19" y2="12" style="user-select:text"/><polyline points="12 5 19 12 12 19" style="user-select:text"/></svg></span></a></nav></footer><div class=pe-comments-decoration><p class=pe-comments-title></p><p class=pe-comments-subtitle></p></div><div id=pe-comments></div><script src=/js/pe-go-comment.min.86a214102576ba5f9b7bdc29eed8d58dd56e34aef80b3c65c73ea9cc88443696.js integrity="sha256-hqIUECV2ul+be9wp7tjVjdVuNK74Czxlxz6pzIhENpY="></script><script>const getStoredTheme=()=>localStorage.getItem("pref-theme")==="dark"?"dark":"light",setGiscusTheme=()=>{const e=e=>{const t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:e},"https://giscus.app")};e({setConfig:{theme:getStoredTheme()}})};document.addEventListener("DOMContentLoaded",()=>{const s={src:"https://giscus.app/client.js","data-repo":"cylonchau/cylonchau.github.io","data-repo-id":"R_kgDOIRlNSQ","data-category":"Announcements","data-category-id":"DIC_kwDOIRlNSc4CXy1U","data-mapping":"pathname","data-term":"posts/rsync","data-strict":"0","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"top","data-theme":getStoredTheme(),"data-lang":"zh-TW","data-loading":"lazy",crossorigin:"anonymous",async:""},e=document.createElement("script");Object.entries(s).forEach(([t,n])=>e.setAttribute(t,n)),document.querySelector("#pe-comments").appendChild(e);const t=document.querySelector("#theme-toggle");t&&t.addEventListener("click",setGiscusTheme);const n=document.querySelector("#theme-toggle-float");n&&n.addEventListener("click",setGiscusTheme)})</script></article></main><footer class=footer><span>&copy; 2024 <a href=http://localhost:1313/>Cylon's Collection</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> on
<a href=https://pages.github.com/ rel=noopener target=_blank>GitHub Pages</a> & Theme
        <a href=https://github.com/tofuwine/PaperMod-PE rel=noopener target=_blank>PaperMod-PE</a></span></footer><div class=pe-right-sidebar><a href=javascript:void(0); id=theme-toggle-float class=pe-float-btn><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</a><a href=#top class=pe-float-btn id=top-link><span id=pe-read-progress></span></a></div><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>