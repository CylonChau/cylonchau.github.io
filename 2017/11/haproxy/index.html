<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>详解haproxy | Cylon&#39;s Collection</title>
<meta name="keywords" content="haproxy">
<meta name="description" content="详解haproxy - Cylon&#39;s Collection">
<meta name="author" content="cylon">
<link rel="canonical" href="https://www.oomkill.com/2017/11/haproxy/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.df0e7f0648f287aca44f5b657ff5602f436346895340daaa6589b3049a979f73.css" integrity="sha256-3w5/Bkjyh6ykT1tlf/VgL0NjRolTQNqqZYmzBJqXn3M=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://www.oomkill.com/favicon.ico">
<link rel="apple-touch-icon" href="https://www.oomkill.com/apple-touch-icon.png">

<meta name="twitter:title" content="详解haproxy | Cylon&#39;s Collection" />
<meta name="twitter:description" content="" />
<meta property="og:title" content="详解haproxy | Cylon&#39;s Collection" />
<meta property="og:description" content="" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.oomkill.com/2017/11/haproxy/" />
<meta property="article:section" content="posts" />
  <meta property="article:published_time" content="2017-11-16T00:00:00&#43;00:00" />
  <meta property="article:modified_time" content="2022-11-28T23:00:36&#43;08:00" />


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Posts",
      "item": "https://www.oomkill.com/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "详解haproxy",
      "item": "https://www.oomkill.com/2017/11/haproxy/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "详解haproxy | Cylon's Collection",
  "name": "详解haproxy",
  "description": "",
  "keywords": [
    "haproxy"
  ],
  "wordCount" : "7000",
  "inLanguage": "zh",
  "datePublished": "2017-11-16T00:00:00Z",
  "dateModified": "2022-11-28T23:00:36+08:00",
  "author":{
    "@type": "Person",
    "name": "cylon"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://www.oomkill.com/2017/11/haproxy/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Cylon's Collection",
    "logo": {
      "@type": "ImageObject",
      "url": "https://www.oomkill.com/favicon.ico"
    }
  }
}
</script><script type="text/javascript"
        async
        src="https://cdn.bootcss.com/mathjax/2.7.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\[\[','\]\]']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
});

MathJax.Hub.Queue(function() {
    
    
    
    var all = MathJax.Hub.getAllJax(), i;
    for(i = 0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
});
</script>

<style>
code.has-jax {
    font: inherit;
    font-size: 100%;
    background: inherit;
    border: inherit;
    color: #515151;
}
</style>
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary-bg: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list-page {
                background: var(--theme);
            }

            .list-page:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list-page:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>

</head>

<body class=" type-posts kind-page layout-" id="top"><script data-no-instant>
function switchTheme(theme) {
  switch (theme) {
    case 'light':
      document.body.classList.remove('dark');
      break;
    case 'dark':
      document.body.classList.add('dark');
      break;
    
    default:
      if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
      }
  }
}

function isDarkTheme() {
  return document.body.className.includes("dark");
}

function getPrefTheme() {
  return localStorage.getItem("pref-theme");
}

function setPrefTheme(theme) {
  switchTheme(theme)
  localStorage.setItem("pref-theme", theme);
}

const toggleThemeCallbacks = {}
toggleThemeCallbacks['main'] = (isDark) => {
  
  if (isDark) {
    setPrefTheme('light');
  } else {
    setPrefTheme('dark');
  }
}




window.addEventListener('toggle-theme', function() {
  
  const isDark = isDarkTheme()
  for (const key in toggleThemeCallbacks) {
    toggleThemeCallbacks[key](isDark)
  }
});


function toggleThemeListener() {
  
  window.dispatchEvent(new CustomEvent('toggle-theme'));
}

</script>
<script>
  
  (function() {
    const defaultTheme = 'auto';
    const prefTheme = getPrefTheme();
    const theme = prefTheme ? prefTheme : defaultTheme;

    switchTheme(theme);
  })();
</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://www.oomkill.com" accesskey="h" title="Cylon&#39;s Collection (Alt + H)">Cylon&#39;s Collection</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="https://www.oomkill.com/archives/" title="归档"
                >归档
                </a>
            </li>
            <li>
                <a href="https://www.oomkill.com/tags/" title="标签"
                >标签
                </a>
            </li>
            <li>
                <a href="https://www.oomkill.com/search/" title="搜索 (Alt &#43; /)"data-no-instant accesskey=/
                >搜索
                </a>
            </li>
            <li>
                <a href="https://www.oomkill.com/about/" title="关于"
                >关于
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main post">

<article class="post-single">
  <header class="post-header"><h1 class="post-title">详解haproxy</h1>
    <div class="post-meta"><span class="meta-item">
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar" style="user-select: text;"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" style="user-select: text;"></rect><line x1="16" y1="2" x2="16" y2="6" style="user-select: text;"></line><line x1="8" y1="2" x2="8" y2="6" style="user-select: text;"></line><line x1="3" y1="10" x2="21" y2="10" style="user-select: text;"></line></svg>
  <span>2017-11-16</span></span><span class="meta-item">
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar" style="user-select: text;"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" style="user-select: text;"></rect><line x1="16" y1="2" x2="16" y2="6" style="user-select: text;"></line><line x1="8" y1="2" x2="8" y2="6" style="user-select: text;"></line><line x1="3" y1="10" x2="21" y2="10" style="user-select: text;"></line></svg>
  <span>Edited on 2022-11-28</span></span><span class="meta-item">
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon" style="user-select: text;"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z" style="user-select: text;"></path><line x1="7" y1="7" x2="7" y2="7" style="user-select: text;"></line></svg>
  <span class="post-tags"><a href="https://www.oomkill.com/tags/ha/">HA</a></span></span><span class="meta-item">
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><circle cx="12" cy="12" r="9"></circle><polyline points="12 7 12 12 15 15"></polyline></svg>
  <span>14 分钟</span></span>

      
      
    </div>
  </header> <div class="toc side right">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">目录</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#haproxy-%e4%bb%8b%e7%bb%8d" aria-label="haproxy 介绍">haproxy 介绍</a><ul>
                        
                <li>
                    <a href="#lvsnginx%e5%af%b9%e6%af%94" aria-label="LVS/NGINX对比">LVS/NGINX对比</a></li>
                <li>
                    <a href="#haproxy%e4%bb%a3%e7%90%86%e6%a8%a1%e5%bc%8f" aria-label="haproxy代理模式">haproxy代理模式</a></li></ul>
                </li>
                <li>
                    <a href="#haproxy-%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88%e6%8b%93%e6%89%91%e5%9b%be" aria-label="haproxy 解决方案拓扑图">haproxy 解决方案拓扑图</a><ul>
                        
                <li>
                    <a href="#haproxy-l4%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1%e5%ba%94%e7%94%a8%e6%9e%b6%e6%9e%84%e6%8b%93%e6%89%91" aria-label="haproxy L4负载均衡应用架构拓扑">haproxy L4负载均衡应用架构拓扑</a></li>
                <li>
                    <a href="#haproxy-l7%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1%e5%ba%94%e7%94%a8%e6%9e%b6%e6%9e%84%e6%8b%93%e6%89%91" aria-label="haproxy L7负载均衡应用架构拓扑">haproxy L7负载均衡应用架构拓扑</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%ae%89%e8%a3%85haproxy" aria-label="安装haproxy">安装haproxy</a><ul>
                        
                <li>
                    <a href="#%e4%b8%8b%e8%bd%bd%e5%ae%89%e8%a3%85haproxy" aria-label="下载安装haproxy">下载安装haproxy</a></li>
                <li>
                    <a href="#%e7%bc%96%e8%af%91haproxy" aria-label="编译haproxy">编译haproxy</a></li>
                <li>
                    <a href="#%e9%85%8d%e7%bd%ae%e5%86%85%e6%a0%b8%e8%bd%ac%e5%8f%91%e5%8a%9f%e8%83%bd" aria-label="配置内核转发功能">配置内核转发功能</a></li>
                <li>
                    <a href="#haproxy%e5%90%af%e5%8a%a8%e5%91%bd%e4%bb%a4" aria-label="haproxy启动命令">haproxy启动命令</a></li>
                <li>
                    <a href="#haproxy%e6%9c%8d%e5%8a%a1%e8%84%9a%e6%9c%ac" aria-label="haproxy服务脚本">haproxy服务脚本</a></li></ul>
                </li>
                <li>
                    <a href="#haproxy%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6" aria-label="haproxy配置文件">haproxy配置文件</a></li>
                <li>
                    <a href="#haproxy%e6%97%a5%e5%bf%97%e9%85%8d%e7%bd%ae" aria-label="haproxy日志配置">haproxy日志配置</a></li>
                <li>
                    <a href="#%e5%9f%ba%e4%ba%8e%e6%9d%83%e9%87%8d%e7%9a%84%e8%bd%ae%e8%ae%adround-robin" aria-label="基于权重的轮训round robin">基于权重的轮训round robin</a></li>
                <li>
                    <a href="#%e8%b4%9f%e8%bd%bd%e6%a8%a1%e5%bc%8f%e5%ae%9e%e9%aa%8c" aria-label="负载模式实验">负载模式实验</a><ul>
                        
                <li>
                    <a href="#%e7%8e%af%e5%a2%83%e5%87%86%e5%a4%87" aria-label="环境准备">环境准备</a></li>
                <li>
                    <a href="#tcp%e8%b4%9f%e8%bd%bd%e6%a8%a1%e5%bc%8f%e9%85%8d%e7%bd%ae" aria-label="TCP负载模式配置">TCP负载模式配置</a></li>
                <li>
                    <a href="#tcp%e4%bb%a3%e7%90%86%e6%89%80%e5%87%ba%e7%8e%b0%e7%9a%84%e9%97%ae%e9%a2%98" aria-label="TCP代理所出现的问题">TCP代理所出现的问题</a><ul>
                        
                <li>
                    <a href="#tcp%e6%a8%a1%e5%bc%8f%e5%bc%80%e5%90%afweb%e7%9b%91%e6%8e%a7%e9%a1%b5%e9%9d%a2%e5%87%ba%e7%8e%b0%e8%b4%9f%e8%bd%bd%e5%87%86%e9%97%ae%e9%a2%98" aria-label="tcp模式开启web监控页面出现负载准问题">tcp模式开启web监控页面出现负载准问题</a></li>
                <li>
                    <a href="#%e4%bb%a3%e7%90%86ssh%e8%b4%9f%e8%bd%bd%e5%87%ba%e7%8e%b0%e5%a6%82%e4%b8%8b%e9%97%ae%e9%a2%98" aria-label="代理ssh负载出现如下问题">代理ssh负载出现如下问题</a></li></ul>
                </li>
                <li>
                    <a href="#l7%e4%bb%a3%e7%90%86%e5%ae%9e%e9%aa%8c" aria-label="L7代理实验">L7代理实验</a></li></ul>
                </li>
                <li>
                    <a href="#acl" aria-label="ACL">ACL</a></li>
                <li>
                    <a href="#web-stats" aria-label="web stats">web stats</a></li>
                <li>
                    <a href="#socat%e5%8a%a8%e6%80%81%e6%93%8d%e4%bd%9chaproxy" aria-label="socat动态操作haproxy">socat动态操作haproxy</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content">
    





<div class="copyrightTopBlock">
    <p>本文发布于<a href="https://www.oomkill.com/about" target="_blank">Cylon的收藏册</a>，转载请著名原文链接~</p>
    <div class="articleSuffix-bg"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 147.78 155.96"> <path d="M10.5,99.81a1.9,1.9,0,0,0-.53-.09,1.66,1.66,0,0,0-1.64,1.65A1.64,1.64,0,0,0,10,103a1.57,1.57,0,0,0,.87-.25l26.76,26.82.45-1.08L11.52,101.91A1.65,1.65,0,0,0,10.5,99.81Zm-.13,2a.57.57,0,0,1-.8,0,.58.58,0,0,1-.17-.41.58.58,0,0,1,.57-.57h0a.57.57,0,0,1,.56.58A.55.55,0,0,1,10.37,101.77Z" style="fill:#c5c9e0"></path><path d="M56.15,117.58H39.06l0-.09a1.65,1.65,0,0,0-1.36-1H37.5a1.65,1.65,0,1,0,1.56,2.19H55.7L92.92,156h41.44v-1.08h-41Zm-18.25.94a.56.56,0,0,1-.79,0,.58.58,0,0,1-.17-.41.57.57,0,0,1,.56-.57h0a.58.58,0,0,1,.57.58A.54.54,0,0,1,37.9,118.52Z" style="fill:#c5c9e0"></path><path d="M23.52,50.32a1.65,1.65,0,0,0,1.55-1.11H55.28l48-48.13h31.06V0H102.85l-48,48.13H25.07a1.64,1.64,0,0,0-2.09-1,1.64,1.64,0,0,0,.54,3.2Zm0-2.21a.57.57,0,0,1,0,1.13.57.57,0,1,1,0-1.13Z" style="fill:#c5c9e0"></path><polygon points="102.86 0 102.86 0 102.86 0 102.86 0" style="fill:#c5c9e0"></polygon><path d="M107.72,12.14h26.64V11.07H107.27L57.4,61H3.09a1.66,1.66,0,0,0-1.45-.86H1.52A1.65,1.65,0,1,0,2.81,63a1.59,1.59,0,0,0,.45-.87H57.85ZM2.05,62.23a.57.57,0,0,1-.8,0,.58.58,0,0,1-.17-.41.57.57,0,0,1,.56-.57h.09a.57.57,0,0,1,.32,1Z" style="fill:#c5c9e0"></path><path d="M134.36,43.22V42.14h-22.3l-9.62,9.63a1.64,1.64,0,0,0-2.19.77,1.61,1.61,0,0,0-.17.71,1.65,1.65,0,1,0,3.29,0,1.61,1.61,0,0,0-.16-.72l9.3-9.32Zm-32.64,10.6a.57.57,0,0,1,0-1.13.57.57,0,0,1,0,1.13Z" style="fill:#c5c9e0"></path><path d="M147,52.3l-9,9H111.48a1.64,1.64,0,0,0-1.61-1.33h-.14a1.65,1.65,0,1,0,1.6,2.41h27.19l9.26-9.29L147,52.3Zm-37.15,9.85a.56.56,0,0,1-.56-.57h0a.56.56,0,0,1,.56-.56h0a.57.57,0,1,1,0,1.13Z" style="fill:#c5c9e0"></path><path d="M66.79,75.35l11,11.06h56.53V85.33H78.27l-11-11.06H49.49L37.12,86.67a1.64,1.64,0,0,0-2.09,1,1.61,1.61,0,0,0-.09.54,1.65,1.65,0,0,0,3.29,0,1.68,1.68,0,0,0-.26-.89l12-12ZM36.58,88.79a.57.57,0,1,1,.57-.56A.57.57,0,0,1,36.58,88.79Z" style="fill:#c5c9e0"></path><path d="M110.61,95.55,92.8,113.4a1.62,1.62,0,1,0,.77.76l17.49-17.53h23.31V95.55ZM92.49,115.28a.56.56,0,0,1-.8,0,.58.58,0,0,1-.17-.41.57.57,0,0,1,.57-.57h0a.58.58,0,0,1,.56.58A.55.55,0,0,1,92.49,115.28Z" style="fill:#c5c9e0"></path><path d="M97.89,122.3H76.62L64.2,109.85a1.65,1.65,0,0,0-.77-2.2,1.77,1.77,0,0,0-.72-.17h-.14a1.65,1.65,0,0,0,.15,3.29,1.58,1.58,0,0,0,.71-.17l12.74,12.77H98.34l17.48-17.52h18.54v-1.08h-19ZM63.12,109.53a.56.56,0,0,1-.8,0,.58.58,0,0,1-.17-.41.57.57,0,0,1,1.14,0A.54.54,0,0,1,63.12,109.53Z" style="fill:#c5c9e0"></path> </svg> </div>
</div><h2 id="haproxy-介绍">haproxy 介绍<a hidden class="anchor" aria-hidden="true" href="#haproxy-介绍">¶</a></h2>
<p>haproxy是一个开源的、高性能的基于TCP和HTTP应用代理的高可用的、负载均衡服务软件，它支持双机热备、高可用、负载均衡、虚拟主机、基于TCP和HTTP的应用代理、图形界面查看信息等功能。其配置简单、维护方便，而且拥有很好的对服务器节点的健康检查功能(相当于keepalived健康检查)，当其代理的后端服务器出现故障时，haproxy会自动的将该故障服务器摘除，当故障的服务器恢复后，haproxy还会自动将该服务器自动加入进来提供服务。</p>
<h3 id="lvsnginx对比">LVS/NGINX对比<a hidden class="anchor" aria-hidden="true" href="#lvsnginx对比">¶</a></h3>
<p>haproxy 特别适用于那些高负载、访问量很大，但又需要会话保持及七层应用代理的业务应用。haproxy运行在今天的普通的服务器硬件上，几乎不需要进行任何的优化就可以支持数以万计的并发连接。并且它的运行模式使得它可以很简单、轻松、安全的整合到各种己有的网站架构中，同时，haproxy的代理模式，可以使得所有应用服务器不会暴露到公共网络上，即后面的节点服务器不需要公网IP地址。</p>
<p>从1.3版本起，haproxy软件引入了frontend,backend的功能，frontend (ad规则匹配)可以让运维管理人员根据任意HTTP请求头内容做规则匹配，然后把请求定向到相关的backend(这个是事先定义好的多个server pools，等待前端把请求转过来的服务器组)。通过frontend和backend，我们可以很容易的买现haproxy的各种7层应用代理功能。</p>
<h3 id="haproxy代理模式">haproxy代理模式<a hidden class="anchor" aria-hidden="true" href="#haproxy代理模式">¶</a></h3>
<p>haproxy支持两种主要代理模式：</p>
<p>1、基于4层的tcp应用代理(例如:可用于邮件服务、内部协议通信服务器、MySQL、HTTPS服务等)。</p>
<p>2、基于7层的http代理。在4层tcp代理模式下，haproxy仅在客户端和服务器之间进行流量转发。但是在7层http代理模式下，haproxy会分析应用层协议，并且能通过允许、拒绝、交换、增加、修改或者删除请求(request)或者回应(response)里指定内容来控制协议。</p>
<p>官方网站:www.haproxy.org</p>
<h2 id="haproxy-解决方案拓扑图">haproxy 解决方案拓扑图<a hidden class="anchor" aria-hidden="true" href="#haproxy-解决方案拓扑图">¶</a></h2>
<h3 id="haproxy-l4负载均衡应用架构拓扑">haproxy L4负载均衡应用架构拓扑<a hidden class="anchor" aria-hidden="true" href="#haproxy-l4负载均衡应用架构拓扑">¶</a></h3>
<p>haproxy软件的四层tcp应用代理非常优秀，且配置非常简单、方便，比LVS和Nginx的配置要简单很多，首先，配置haproxy不需要在RS端做任何特殊配置 (只要对应服务开启就OK)就可以实现应用代理，其次，haproxy的配置语法和增加虚拟主机功能等也比lvs/nginx简单。并且和商业版的NS (Netscaler)、F5, A10等负载均衡硬件的使用方法和在架构中的位置一模一样。下面是haproxy的Layer4层应用代理的拓扑结构图:</p>
<hr>
<p>说明:由于haproxy软件采用的是类NAT模式(本质不同)的应用代理，数据包来去都会经过haproxy，因此，在流量特别大的情况下(门户级别的流量)，其效率和性能不如LVS的DR模式负载均衡。</p>
<hr>
<p>在一般的中小型公司，建议采用haproxy做负载均衡，而不要使用LVS或Nginx。为什么强调中小型公司呢?换句话说，千万PV级别以下直接使用haproxy做负载均衡，会让我们负责维护的运维管理人员配置简单、快速、维护方便，出问题好排查。</p>
<h3 id="haproxy-l7负载均衡应用架构拓扑">haproxy L7负载均衡应用架构拓扑<a hidden class="anchor" aria-hidden="true" href="#haproxy-l7负载均衡应用架构拓扑">¶</a></h3>
<p>haproxy软件的最大优势在于其7层的根据URL请求头应用过滤的功能以及sesson会话功能，在门户网站的高并发生产架构中，haproxy软件一般用在4层LVS负载均衡软件的下一层，或者像haproxy官方推荐的也可以挂在硬件负载均衡althon, NS, F5, A10下使用，其表现非常好。从2009年起taobao，京东商城的业务也大面积使用了haproxy作为7层CACHE应用代理。</p>
<h2 id="安装haproxy">安装haproxy<a hidden class="anchor" aria-hidden="true" href="#安装haproxy">¶</a></h2>
<p>模拟真实环境</p>
<p>搭建合适的模拟环境是一个人学习能力的重要体现。例如：人类第一次上太空也没有真正的环境，但是想去太空就是要自己动手去搭建逼真的模拟环境。实验多了就是经验，自然就有解除生产环境的机会了。</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>接口</th>
<th>IP</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td><font style="background:#659bfd;" size=3>MASTER</font></td>
<td>eth0</td>
<td>10.0.0.7</td>
<td>外网管理IP用于WAN数据转发</td>
</tr>
<tr>
<td></td>
<td>eth1</td>
<td>172.16.1.7</td>
<td>内网管理IP，用于LAN数据转发</td>
</tr>
<tr>
<td></td>
<td>eth2</td>
<td>10.0.10.7</td>
<td>用于服务器间心跳连接（直连）</td>
</tr>
<tr>
<td>VIP</td>
<td></td>
<td>10.0.0.17</td>
<td>用于提供应用程序A挂载服务</td>
</tr>
<tr>
<td><font style="background:#fee904;" size=3> BACKUP</font></td>
<td>eth0</td>
<td>10.0.0.8</td>
<td>外网管理IP，用于WAN数据转发</td>
</tr>
<tr>
<td></td>
<td>eth1</td>
<td>172.16.1.8</td>
<td>内网管理IP，用于LAN数据转发</td>
</tr>
<tr>
<td></td>
<td>eth2</td>
<td>10.0.10.8</td>
<td>用于服务器间心跳连接（直连）</td>
</tr>
<tr>
<td>VIP</td>
<td></td>
<td>10.0.0.8</td>
<td>用于提供应用程序B挂载服务</td>
</tr>
</tbody>
</table>
<h3 id="下载安装haproxy">下载安装haproxy<a hidden class="anchor" aria-hidden="true" href="#下载安装haproxy">¶</a></h3>
<p>下载地址：http://www.haproxy.org/download/</p>
<p>文档地址：http://www.haproxy.org/download/1.7/doc/configuration.txt</p>
<h3 id="编译haproxy">编译haproxy<a hidden class="anchor" aria-hidden="true" href="#编译haproxy">¶</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">make <span class="nv">TARGET</span><span class="o">=</span>linux2628 <span class="nv">ARCH</span><span class="o">=</span>x86_64  <span class="c1"># &lt;==64位编译配置</span>
</span></span><span class="line"><span class="cl">make <span class="nv">TARGET</span><span class="o">=</span>linux2628 <span class="nv">ARCH</span><span class="o">=</span>i386    <span class="c1"># &lt;==32位编译配置</span>
</span></span><span class="line"><span class="cl">make <span class="nv">PREFIX</span><span class="o">=</span>/app/haproxy-1.7.5 install 
</span></span><span class="line"><span class="cl">ln -s /app/haproxy-1.7.5/ /app/haproxy
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="配置内核转发功能">配置内核转发功能<a hidden class="anchor" aria-hidden="true" href="#配置内核转发功能">¶</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">net.ipv4_forward<span class="o">=</span><span class="m">1</span>  <span class="c1"># &lt;==基于NAT模式的负载均衡器都需要打开系统转发功能</span>
</span></span><span class="line"><span class="cl">sysctl -p
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="haproxy启动命令">haproxy启动命令<a hidden class="anchor" aria-hidden="true" href="#haproxy启动命令">¶</a></h3>
<p>直接运行命令查看帮助</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ /app/haproxy/sbin/haproxy
</span></span><span class="line"><span class="cl">HA-Proxy version 1.7.5 2017/04/03
</span></span><span class="line"><span class="cl">Copyright 2000-2017 Willy Tarreau &lt;willy@haproxy.org&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Usage : haproxy <span class="o">[</span>-f &lt;cfgfile<span class="p">|</span>cfgdir&gt;<span class="o">]</span>* <span class="o">[</span> -vdVD <span class="o">]</span> <span class="o">[</span> -n &lt;maxconn&gt; <span class="o">]</span> <span class="o">[</span> -N &lt;maxpconn&gt; <span class="o">]</span>
</span></span><span class="line"><span class="cl">        <span class="o">[</span> -p &lt;pidfile&gt; <span class="o">]</span> <span class="o">[</span> -m &lt;max megs&gt; <span class="o">]</span> <span class="o">[</span> -C &lt;dir&gt; <span class="o">]</span> <span class="o">[</span>-- &lt;cfgfile&gt;*<span class="o">]</span>
</span></span><span class="line"><span class="cl">        -v displays version <span class="p">;</span> -vv shows known build options.
</span></span><span class="line"><span class="cl">        -d enters debug mode <span class="p">;</span> -db only disables background mode.
</span></span><span class="line"><span class="cl">        -dM<span class="o">[</span>&lt;byte&gt;<span class="o">]</span> poisons memory with &lt;byte&gt; <span class="o">(</span>defaults to 0x50<span class="o">)</span>
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></td></tr></table>
</div>
</div><p>命令选项</p>
<table>
<thead>
<tr>
<th>选项</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>-D</td>
<td>以后台守护进程启动服务</td>
</tr>
<tr>
<td>-f</td>
<td>指定配置文件</td>
</tr>
<tr>
<td>-c</td>
<td>检查配置文件语法</td>
</tr>
<tr>
<td>-n</td>
<td>设置最大连接数，一般在配置文件中指定</td>
</tr>
<tr>
<td>-q</td>
<td>启动时不显示警告</td>
</tr>
<tr>
<td>-m</td>
<td>限制使用的内存量</td>
</tr>
<tr>
<td>-p</td>
<td>将pid写入文件</td>
</tr>
<tr>
<td>-sf</td>
<td>平滑重启</td>
</tr>
<tr>
<td>-st</td>
<td>强制重启</td>
</tr>
</tbody>
</table>
<p>注意 <code>-sf</code> 和 <code>-st</code> 重启时需要指定配置文件</p>
<h3 id="haproxy服务脚本">haproxy服务脚本<a hidden class="anchor" aria-hidden="true" href="#haproxy服务脚本">¶</a></h3>
<p>在下载解压目录中有默认的启动脚本</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ ll /root/tools/haproxy-1.7.5/examples/haproxy.init
</span></span><span class="line"><span class="cl">/root/tools/haproxy-1.7.5/examples/haproxy.init
</span></span></code></pre></td></tr></table>
</div>
</div><p>自定义启动脚本</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="cp">#!/bin/sh
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="nv">BASE</span><span class="o">=</span>/app/haproxy
</span></span><span class="line"><span class="cl"><span class="nv">COMM</span><span class="o">=</span><span class="nv">$BASE</span>/sbin/haproxy
</span></span><span class="line"><span class="cl"><span class="nv">PIDFILE</span><span class="o">=</span><span class="nv">$BASE</span>/var/run/haproxy.pid
</span></span><span class="line"><span class="cl"><span class="nv">CONF_FILE</span><span class="o">=</span><span class="nv">$BASE</span>/conf/haproxy.conf1
</span></span><span class="line"><span class="cl"><span class="k">case</span> <span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span> in
</span></span><span class="line"><span class="cl">	<span class="s1">&#39;start&#39;</span><span class="p">|</span><span class="s1">&#39;START&#39;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="o">[</span> ! -f <span class="nv">$PIDFILE</span> <span class="o">]</span><span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl">				<span class="nv">$COMM</span> -f <span class="nv">$CONF_FILE</span> -D
</span></span><span class="line"><span class="cl">		<span class="k">else</span>
</span></span><span class="line"><span class="cl">				<span class="nb">echo</span> <span class="s1">&#39;haproxy has been started&#39;</span>
</span></span><span class="line"><span class="cl">		<span class="k">fi</span>
</span></span><span class="line"><span class="cl">		<span class="p">;;</span>
</span></span><span class="line"><span class="cl">	<span class="s1">&#39;status&#39;</span><span class="p">|</span><span class="s1">&#39;STATUS&#39;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="o">[</span> ! -f <span class="nv">$PIDFILE</span> <span class="o">]</span><span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl">			<span class="nb">echo</span> <span class="s1">&#39;haproxy is not running&#39;</span>
</span></span><span class="line"><span class="cl">			<span class="nb">exit</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">		<span class="k">fi</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> pid in <span class="k">$(</span>cat <span class="nv">$PIDFILE</span><span class="k">)</span><span class="p">;</span><span class="k">do</span>
</span></span><span class="line"><span class="cl">			<span class="nb">kill</span> -0 <span class="nv">$pid</span>
</span></span><span class="line"><span class="cl">			<span class="nv">RETVAL</span><span class="o">=</span><span class="nv">$?</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="o">[</span> <span class="nv">$RETVAL</span> <span class="o">==</span> <span class="m">0</span> <span class="o">]</span><span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl">				<span class="nb">echo</span> <span class="s1">&#39;process &#39;</span><span class="nv">$pid</span> <span class="s1">&#39; not running&#39;</span>
</span></span><span class="line"><span class="cl">			<span class="k">fi</span>
</span></span><span class="line"><span class="cl">		<span class="k">done</span>
</span></span><span class="line"><span class="cl">		<span class="nb">echo</span> <span class="s1">&#39;haproxy is running&#39;</span>
</span></span><span class="line"><span class="cl">		<span class="p">;;</span>
</span></span><span class="line"><span class="cl">	<span class="s1">&#39;restart&#39;</span><span class="p">|</span><span class="s1">&#39;RESTART&#39;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">		<span class="nv">$COMM</span> -f <span class="nv">$CONF_FILE</span> -sf <span class="k">$(</span>cat <span class="nv">$PIDFILE</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">;;</span>
</span></span><span class="line"><span class="cl">	<span class="s1">&#39;stop&#39;</span><span class="p">|</span><span class="s1">&#39;STOP&#39;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">		<span class="nb">kill</span> <span class="k">$(</span>cat <span class="nv">$PIDFILE</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">		rm -f <span class="nv">$PIDFILE</span>
</span></span><span class="line"><span class="cl">		<span class="p">;;</span>
</span></span><span class="line"><span class="cl">	<span class="s1">&#39;check&#39;</span><span class="p">|</span><span class="s1">&#39;CHECK&#39;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">		<span class="nv">$COMM</span> -f <span class="nv">$CONF_FILE</span> -c
</span></span><span class="line"><span class="cl">		<span class="p">;;</span>
</span></span><span class="line"><span class="cl">	*<span class="o">)</span>
</span></span><span class="line"><span class="cl">		<span class="nb">echo</span> <span class="s2">&#34;USAGE </span><span class="nv">$0</span><span class="s2"> start|stop|restart|status|check|&#34;</span>
</span></span><span class="line"><span class="cl">		<span class="nb">exit</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">		<span class="p">;;</span>
</span></span><span class="line"><span class="cl"><span class="k">esac</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="haproxy配置文件">haproxy配置文件<a hidden class="anchor" aria-hidden="true" href="#haproxy配置文件">¶</a></h2>
<p>haproxy 的默认配置文件在下载解压目录下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">/root/tools/haproxy-1.7.5/examples
</span></span></code></pre></td></tr></table>
</div>
</div><p>aproxy的配置文件可以分为5部分</p>
<ul>
<li>
<p>global：全局配置参数段，主要用来控制haproxy启动前的进程及系统相关设置。</p>
</li>
<li>
<p>default：配置一些默认参数，如果frontend，backend，listen等段未设置则使用default段配置。</p>
</li>
<li>
<p>listen：</p>
</li>
<li>
<p>frontend：用来匹配接受客户所请求的域名，uri等，并针对不同配置，做不同的请求处理。</p>
</li>
<li>
<p>backend：定义后端服务器集群，以及对后端 服务器的一切权重、队列、连接数等选项的设置。</p>
</li>
</ul>
<p>配置文件示例注释说明</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">global #&lt;==全局配置, 用于设定义全局参数, 属于进程级的配置, 通常与操作系统配置有关
</span></span><span class="line"><span class="cl">	chroot  /app/haproxy/var/chroot #&lt;==运行路径
</span></span><span class="line"><span class="cl">	daemon #&lt;==以守护方式运行haproxy
</span></span><span class="line"><span class="cl">	user    haproxy #&lt;==运行haproxy用户/组, 或者使用关键字uid/gid
</span></span><span class="line"><span class="cl">    group   haproxy
</span></span><span class="line"><span class="cl">log		127.0.0.1 local0 debug 
</span></span><span class="line"><span class="cl"># 全局日志配置指定127.0.0.1:514的syslog服务中local0日志设备。
</span></span><span class="line"><span class="cl"># 与记录日志的模式[err warning info debug]
</span></span><span class="line"><span class="cl">    pidfile /app/haproxy/var/run/haproxy.pid
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">maxconn	2000 
</span></span><span class="line"><span class="cl">#设置每haproxy进程的最大并发连接数, 其等同于命令行选项“-n”; 
</span></span><span class="line"><span class="cl"># “ulimit -n”自动计算的结果参照此参数设定.
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    nbproc  1 #&lt;==启动的haproxy进程数量, 只能用于守护进程模式。应该设置为cup核数
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"># ulimit-n 655350  
</span></span><span class="line"><span class="cl"># 设置每进程所能够打开的最大文件描述符数目。
</span></span><span class="line"><span class="cl"># 默认情况其会自动进行计算, 因此不推荐修改此选项.    
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">  defaults #&lt;==默认配置
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    mode http  #&lt;==默认的模式【tcp:4层； http:7层； health:只返回OK】
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    log global #&lt;==继承全局的日志定义输出
</span></span><span class="line"><span class="cl">      
</span></span><span class="line"><span class="cl">    #option httplog #&lt;==日志类别, httplog
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl">    # 如果后端服务器需要记录客户端真实ip, 需要在HTTP请求中添加”X-Forwarded-For”字段;
</span></span><span class="line"><span class="cl"># 但haproxy自身的健康检测机制访问后端服务器时, 不应将记录访问日志。
</span></span><span class="line"><span class="cl"># 可用except来排除127.0.0.0，即haproxy本身.
</span></span><span class="line"><span class="cl">    #option forwardfor except 127.0.0.0/8
</span></span><span class="line"><span class="cl">option forwardfor
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">option httpclose 
</span></span><span class="line"><span class="cl"># 开启http协议中服务器端关闭功能每个请求完毕后主动关闭http通道。
</span></span><span class="line"><span class="cl"># 使得支持长连接，使得会话可以被重用，使得每一个日志记录都会被记录.
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    option dontlognull #&lt;==如果产生了一个空连接，那这个空连接的日志将不会记录.
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    option redispatch	#&lt;==当与后端服务器的会话失败(服务器故障或其他原因)时, 把会话重新分发到其他健康的服务器上; 当故障服务器恢复时, 会话又被定向到已恢复的服务器上;
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">	retries 3  #&lt;==在判定会话失败时的尝试连接的次数
</span></span><span class="line"><span class="cl">      
</span></span><span class="line"><span class="cl">    option abortonclose #&lt;==当haproxy负载很高时, 自动结束掉当前队列处理比较久的连接.
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl">    timeout http-request 10s #&lt;==默认http请求超时时间
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">    timeout queue 1m	#&lt;==默认队列超时时间, 后端服务器在高负载时, 会将haproxy发来的请求放进一个队列中.
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    timeout connect 5s	#&lt;==haproxy与后端服务器连接超时时间.
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    timeout client 1m	#&lt;==客户端与haproxy连接后, 数据传输完毕, 不再有数据传输, 即非活动连接的超时时间.
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    timeout server 1m	#&lt;==haproxy与后端服务器非活动连接的超时时间.
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    timeout http-keep-alive 10s #&lt;==默认新的http请求连接建立的超时时间，时间较短时可以尽快释放出资源，节约资源.
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    timeout check 10s	#&lt;==心跳检测超时时间
</span></span><span class="line"><span class="cl">      
</span></span><span class="line"><span class="cl">    maxconn 2000	#&lt;==最大并发连接数
</span></span><span class="line"><span class="cl">      
</span></span><span class="line"><span class="cl">    #设置默认的负载均衡方式
</span></span><span class="line"><span class="cl">    #balance source 
</span></span><span class="line"><span class="cl">    #balnace leastconn
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  listen admin_status 
</span></span><span class="line"><span class="cl">  # 统计页面配置, frontend和backend的组合体。
</span></span><span class="line"><span class="cl">  # 监控组的名称可按需自定义
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    mode http #&lt;==监控运行模式
</span></span><span class="line"><span class="cl">      
</span></span><span class="line"><span class="cl">    bind 0.0.0.0:80	#&lt;==统计页面访问端口
</span></span><span class="line"><span class="cl">      
</span></span><span class="line"><span class="cl">    maxconn 10  #&lt;==统计页面默认最大连接数
</span></span><span class="line"><span class="cl">      
</span></span><span class="line"><span class="cl">    option httplog  #&lt;==#http日志格式
</span></span><span class="line"><span class="cl">      
</span></span><span class="line"><span class="cl">    stats enable   #&lt;==开启web统计
</span></span><span class="line"><span class="cl">      
</span></span><span class="line"><span class="cl">    stats hide-version 	#&lt;==隐藏统计页面上的haproxy版本信息
</span></span><span class="line"><span class="cl">      
</span></span><span class="line"><span class="cl">    stats refresh 30s	#&lt;==监控页面自动刷新时间
</span></span><span class="line"><span class="cl">      
</span></span><span class="line"><span class="cl">    stats uri /admin?status #&lt;==统计页面访问url
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">	stats auth admin:111	#&lt;==监控页面的用户和密码:admin, 可设置多个用户名
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    stats realm hellow world #&lt;==统计页面密码框提示文本
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    stats admin if TRUE	#&lt;==手工启动/禁用后端服务器, 可通过web管理节点
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">	#设置haproxy错误页面
</span></span><span class="line"><span class="cl">    #errorfile 400 /usr/local/haproxy/errorfiles/400.http
</span></span><span class="line"><span class="cl">    #errorfile 403 /usr/local/haproxy/errorfiles/403.http
</span></span><span class="line"><span class="cl">    #errorfile 408 /usr/local/haproxy/errorfiles/408.http
</span></span><span class="line"><span class="cl">    #errorfile 500 /usr/local/haproxy/errorfiles/500.http
</span></span><span class="line"><span class="cl">    #errorfile 502 /usr/local/haproxy/errorfiles/502.http
</span></span><span class="line"><span class="cl">    #errorfile 503 /usr/local/haproxy/errorfiles/503.http
</span></span><span class="line"><span class="cl">    #errorfile 504 /usr/local/haproxy/errorfiles/504.http
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	option forwardfor #&lt;==将用户的IP转发给监控的IP
</span></span><span class="line"><span class="cl">	option httpchk HEAD /check.html HTTP/1.0 #&lt;==http的健康检查
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">  frontend  WEB_SITE  #&lt;==vip
</span></span><span class="line"><span class="cl">	bind    *:80
</span></span><span class="line"><span class="cl">	mode    http
</span></span><span class="line"><span class="cl">	log     global
</span></span><span class="line"><span class="cl">	option  httplog    
</span></span><span class="line"><span class="cl">	option  httpclose  &lt;== http7层代理专用
</span></span><span class="line"><span class="cl">	default_backend WWW
</span></span><span class="line"><span class="cl">  backend WWW #&lt;==real server
</span></span><span class="line"><span class="cl">	option forwardfor header X-REAL-IP
</span></span><span class="line"><span class="cl">	option httpchk HEAD / HTTP/1.0  &lt;==检查real server是否存活的方式，[get post head]
</span></span><span class="line"><span class="cl">	server web1 10.0.0.3:80 check inter 2000 rise 30 fall 15  
</span></span><span class="line"><span class="cl">	server web2 www.test.com check inter 2000 rise 30 fall 15  
</span></span><span class="line"><span class="cl"># inter为检查间隔 rise为连续30次检查成功则认为有效的。
</span></span><span class="line"><span class="cl"># fall为连续15次检查失败则认为宕机
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="haproxy日志配置">haproxy日志配置<a hidden class="anchor" aria-hidden="true" href="#haproxy日志配置">¶</a></h2>
<p><strong><font color="#f8070d" size=3>CentOS 5.X</font></strong></p>
<p>编辑/etc/syslog.conf增加如下配置</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">local0.* /app/haproxy/logs/haproxy.log
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong><font color="#f8070d" size=3>CentOS 6 &amp; 7</font></strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">local0.* -/app/haproxy/logs/haproxy.log 
</span></span><span class="line"><span class="cl"><span class="c1"># 将local0设备的日志定向到haproxy.log因为haproxy使用的local0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<p><font color="#0215cd" size=3> 注：使用了local0设备需要将 local0 在 <code>/var/log/message</code> 里制空，否则会记录双份</font></p>
<hr>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">*.info<span class="p">;</span>mail.none<span class="p">;</span>authpriv.none<span class="p">;</span>cron.none<span class="p">;</span>local0.none<span class="p">;</span>    /var/log/messages
</span></span></code></pre></td></tr></table>
</div>
</div><p>修改/etc/sysconfig/syslog</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">#-r enables logging from remote machines</span>
</span></span><span class="line"><span class="cl"><span class="c1"># -x disables DNS lookups on messages recieved with -r</span>
</span></span><span class="line"><span class="cl"><span class="nv">SYSLOGD_OPTIONS</span><span class="o">=</span><span class="s2">&#34;-m 0 -r -c 2&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>重启后生效</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">/etc/init.d/syslog restart  <span class="c1"># &lt;== CentOS 5</span>
</span></span><span class="line"><span class="cl">/etc/init.d/rsyslog restart <span class="c1"># &lt;== CentOS 6</span>
</span></span><span class="line"><span class="cl">systemctl restart rsyslog   <span class="c1"># &lt;== CentOS 7</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><a href="http://www.cnblogs.com/aaa103439/p/3537163.html">http://www.cnblogs.com/aaa103439/p/3537163.html</a></p>
<p><a href="http://www.cnblogs.com/MacoLee/p/5853413.html">http://www.cnblogs.com/MacoLee/p/5853413.html</a></p>
<h2 id="基于权重的轮训round-robin">基于权重的轮训round robin<a hidden class="anchor" aria-hidden="true" href="#基于权重的轮训round-robin">¶</a></h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">server web1 10.0.0.2 check  weight <span class="m">3</span>
</span></span><span class="line"><span class="cl">server web1 10.0.0.3 check  weight <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> n in <span class="o">{</span>0..20<span class="o">}</span><span class="p">;</span><span class="k">do</span> curl 10.0.02<span class="p">;</span>sleep <span class="m">1</span> <span class="k">done</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>leastconn&ndash;&gt; 类似于 lvs中 的 wlc</p>
<p>不过这里只考虑活动连接数，即选择活动连接数少的。另外，最好在长连接会话中使用，如sql,ldap</p>
<p>
  <img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed//img/image-20221213234451180.gif" alt="image-20221213234451180"  /></p>
<h2 id="负载模式实验">负载模式实验<a hidden class="anchor" aria-hidden="true" href="#负载模式实验">¶</a></h2>
<h3 id="环境准备">环境准备<a hidden class="anchor" aria-hidden="true" href="#环境准备">¶</a></h3>
<table>
<thead>
<tr>
<th>IP</th>
<th>地位</th>
</tr>
</thead>
<tbody>
<tr>
<td>10.0.0.2</td>
<td>haproxy</td>
</tr>
<tr>
<td>10.0.0.1</td>
<td>real server 1</td>
</tr>
<tr>
<td>10.0.0.3</td>
<td>real server 2</td>
</tr>
</tbody>
</table>
<h3 id="tcp负载模式配置">TCP负载模式配置<a hidden class="anchor" aria-hidden="true" href="#tcp负载模式配置">¶</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">frontend  WEB_SITE  <span class="c1">#&lt;==vip</span>
</span></span><span class="line"><span class="cl">  <span class="nb">bind</span> *:80
</span></span><span class="line"><span class="cl">  mode    tcp
</span></span><span class="line"><span class="cl">  log     global
</span></span><span class="line"><span class="cl">  default_backend WWW
</span></span><span class="line"><span class="cl">backend WWW <span class="c1">#&lt;==real server</span>
</span></span><span class="line"><span class="cl">  server web1 10.0.0.3:52113 check inter <span class="m">2000</span> rise <span class="m">3</span> fall <span class="m">5</span>
</span></span><span class="line"><span class="cl">  server web2 10.0.0.1:52113 check inter <span class="m">2000</span> rise <span class="m">3</span> fall <span class="m">5</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<p><font color="#0215cd" size=3> 注意：listen可以看做是frontend与bankend的集合，顾如果使用tcp模式代理的话，不要开启web监控</font></p>
<hr>
<p>
  <img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed//img/image-tcp_2.gif" alt="image-20221213234451180"  /></p>
<h3 id="tcp代理所出现的问题">TCP代理所出现的问题<a hidden class="anchor" aria-hidden="true" href="#tcp代理所出现的问题">¶</a></h3>
<h4 id="tcp模式开启web监控页面出现负载准问题">tcp模式开启web监控页面出现负载准问题<a hidden class="anchor" aria-hidden="true" href="#tcp模式开启web监控页面出现负载准问题">¶</a></h4>
<p>开启web监控页面的haproxy日志</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">May <span class="m">19</span> 22:41:02 127.0.0.1 haproxy<span class="o">[</span>2579<span class="o">]</span>: Connect from 192.168.2.1:50820 to 10.0.0.2:80 <span class="o">(</span>WEB_SITE/TCP<span class="o">)</span>
</span></span><span class="line"><span class="cl">May <span class="m">19</span> 22:41:02 127.0.0.1 haproxy<span class="o">[</span>2579<span class="o">]</span>: Connect from 192.168.2.1:50820 to 10.0.0.2:80 <span class="o">(</span>WEB_SITE/TCP<span class="o">)</span>
</span></span><span class="line"><span class="cl">May <span class="m">19</span> 22:41:02 127.0.0.1 haproxy<span class="o">[</span>2578<span class="o">]</span>: 192.168.2.1:50821 <span class="o">[</span>19/May/2017:22:41:02.405<span class="o">]</span> admin_status admin_status/&lt;STATS&gt; 0/0/0/0/1 <span class="m">200</span> <span class="m">16975</span> - - LR-- 0/0/0/0/0 0/0 <span class="s2">&#34;GET /admin?status HTTP/1.1&#34;</span>
</span></span><span class="line"><span class="cl">May <span class="m">19</span> 22:41:02 127.0.0.1 haproxy<span class="o">[</span>2579<span class="o">]</span>: Connect from 192.168.2.1:50822 to 10.0.0.2:80 <span class="o">(</span>WEB_SITE/TCP<span class="o">)</span>
</span></span><span class="line"><span class="cl">May <span class="m">19</span> 22:41:02 127.0.0.1 haproxy<span class="o">[</span>2579<span class="o">]</span>: Connect from 192.168.2.1:50822 to 10.0.0.2:80 <span class="o">(</span>WEB_SITE/TCP<span class="o">)</span>
</span></span><span class="line"><span class="cl">May <span class="m">19</span> 22:41:02 127.0.0.1 haproxy<span class="o">[</span>2579<span class="o">]</span>: 192.168.2.1:50823 <span class="o">[</span>19/May/2017:22:41:02.816<span class="o">]</span> admin_status admin_status/&lt;STATS&gt; 0/0/0/0/1 <span class="m">200</span> <span class="m">16996</span> - - LR-- 0/0/0/0/0 0/0 <span class="s2">&#34;GET /admin?status HTTP/1.1&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="代理ssh负载出现如下问题">代理ssh负载出现如下问题<a hidden class="anchor" aria-hidden="true" href="#代理ssh负载出现如下问题">¶</a></h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
</span></span><span class="line"><span class="cl">@    WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!     @
</span></span><span class="line"><span class="cl">@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
</span></span><span class="line"><span class="cl">IT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY!
</span></span><span class="line"><span class="cl">Someone could be eavesdropping on you right now <span class="o">(</span>man-in-the-middle attack<span class="o">)</span>!
</span></span><span class="line"><span class="cl">It is also possible that a host key has just been changed.
</span></span><span class="line"><span class="cl">The fingerprint <span class="k">for</span> the RSA key sent by the remote host is
</span></span><span class="line"><span class="cl">11:f2:f1:05:1e:80:0a:bf:9f:09:20:3f:02:e1:12:b8.
</span></span><span class="line"><span class="cl">Please contact your system administrator.
</span></span><span class="line"><span class="cl">Add correct host key in /root/.ssh/known_hosts to get rid of this message.
</span></span><span class="line"><span class="cl">Offending RSA key in /root/.ssh/known_hosts:1
</span></span><span class="line"><span class="cl">RSA host key <span class="k">for</span> <span class="o">[</span>10.0.0.2<span class="o">]</span>:80 has changed and you have requested strict checking.
</span></span><span class="line"><span class="cl">Host key verification failed.
</span></span></code></pre></td></tr></table>
</div>
</div><p>出现此问题是因为，登陆ssh时使用的是vip，而真正的server是两个，当登陆第一台server时，将指纹保存到vip，当轮训到第二台时，因为已经保存过其他server的指纹了，会提示指纹改变。所以这个不算是问题</p>
<h3 id="l7代理实验">L7代理实验<a hidden class="anchor" aria-hidden="true" href="#l7代理实验">¶</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">frontend  WEB_SITE  #&lt;==vip
</span></span><span class="line"><span class="cl">  bind *:80
</span></span><span class="line"><span class="cl">  mode    http
</span></span><span class="line"><span class="cl">  option  httplog
</span></span><span class="line"><span class="cl">  option  httpclose
</span></span><span class="line"><span class="cl">  log     global
</span></span><span class="line"><span class="cl">  default_backend WWW
</span></span><span class="line"><span class="cl">backend WWW #&lt;==real server
</span></span><span class="line"><span class="cl">  server web1 10.0.0.3:52113 check inter 2000 rise 3 fall 5
</span></span><span class="line"><span class="cl">  server web2 10.0.0.1:52113 check inter 2000 rise 3 fall 5
</span></span></code></pre></td></tr></table>
</div>
</div><p>
  <img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed//img/image-http.gif" alt="image-20221213234451180"  /></p>
<h2 id="acl">ACL<a hidden class="anchor" aria-hidden="true" href="#acl">¶</a></h2>
<p>ACL名称必须由 大小写字母、数字、”-“（破折号）、“_”（下划线）、“.”（点）和 ”:“（冒号）。 ACL名称区分大小写，这意味着 “my_acl” 和 “My_Acl” 是两个不同的ACL。ACL的数量没有强制限制。未使用的不影响性能，他们只是消耗少量的内存。</p>
<hr>
<p>注：在http代理模式中uri的请求会被分配到real server的实体路径中</p>
<hr>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">acl &lt;aclname&gt; &lt;criterion&gt; <span class="o">[</span>flags<span class="o">]</span> <span class="o">[</span>operator<span class="o">]</span> &lt;value&gt; ... 
</span></span></code></pre></td></tr></table>
</div>
</div><p>参数说明：</p>
<ul>
<li>
<p>&lt;aclname&gt; &lt;==ACL名称；</p>
</li>
<li>
<p>&lt;criterion&gt;：测试标准，即对什么信息发起测试；测试方式可以由 [flags] 指定的标志进行调整；而有些测试标准也可以需要为其在之前指定一个操作符 [operator]；</p>
</li>
</ul>
<p>ACL的flag：</p>
<ul>
<li>-i：在匹配所有后续模式时忽略大小写。</li>
<li>-f：从文件加载模式。</li>
<li>-m：使用特定的模式匹配方法</li>
<li>-n：禁止DNS解析</li>
<li>-M：像地图文件一样加载-f指向的文件。</li>
<li>&ndash; ：强制结束标志。 当字符串看起来像其中一个标志时很有用。</li>
<li>-u：强制ACL的唯一ID</li>
</ul>
<p>&lt;value&gt;：acl测试条件支持的值有以下四类：</p>
<ol>
<li>整数或整数范围：如 1024:65535 表示从 1024~65535；仅支持使用正整数(如果出现类似小数的标识，其为通常为版本测试)，且支持使用的操作符有5个，分别为eq、ge、gt、le和lt；</li>
<li>字符串：支持使用 “-i” 以忽略字符大小写，支持使用 “\” 进行转义；如果在模式首部出现了-i，可以在其之前使用“–”标志位；</li>
<li>正则表达式：其机制类同字符串匹配；</li>
<li>IP地址及网络地址</li>
</ol>
<p>常用的测试标准(criteria)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">be_sess_rate<span class="o">(</span>backend<span class="o">)</span> &lt;integer&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>用于测试指定的backend上会话创建的速率(即每秒创建的会话数)是否满足指定的条件；常用于在指定backend上的会话速率过高时将用户请求转发至另外的backend，或用于阻止攻击行为。</p>
<p>例如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">acl being_scanned be_sess_rate gt <span class="m">50</span>  <span class="c1"># &lt;==此方案是定义在backend里的</span>
</span></span><span class="line"><span class="cl">redirect location /error_pages/denied.html <span class="k">if</span> being_scanned
</span></span></code></pre></td></tr></table>
</div>
</div><p>sd</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">fe_sess_rate<span class="o">(</span>frontend<span class="o">)</span> &lt;integer&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>用于测试指定的frontend(或当前frontend)上的会话创建速率是否满足指定的条件；</p>
<p>常用于为frontend指定一个合理的会话创建速率的上限以防止服务被滥用。例如下面的例子限定入站邮件速率不能大于50封/秒，所有在此指定范围之外的请求都将被延时50毫秒。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">frontend mail
</span></span><span class="line"><span class="cl">    bind :25
</span></span><span class="line"><span class="cl">    mode tcp
</span></span><span class="line"><span class="cl">    maxconn 500
</span></span><span class="line"><span class="cl">    acl too_fast fe_sess_rate ge 50
</span></span><span class="line"><span class="cl">    tcp-request inspect-delay 50ms
</span></span><span class="line"><span class="cl">    tcp-request content accept if ! too_fast
</span></span><span class="line"><span class="cl">    tcp-request content accept if WAIT_END
</span></span></code></pre></td></tr></table>
</div>
</div><p>hdr &lt;string&gt;</p>
<p>用于测试请求报文中的所有首部或指定首部是否满足指定的条件；指定首部时，其名称不区分大小写，且在括号 “()” 中不能有任何多余的空白字符。测试服务器端的响应报文时可以使用 <code>shdr()</code>。例如下面的例子用于测试首部Connection的值是否为close。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">acl url_bao hdr(Host) -i www.baidu.com
</span></span></code></pre></td></tr></table>
</div>
</div><p>method &lt;string&gt;</p>
<p>测试HTTP请求报文中使用的方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">front test
</span></span><span class="line"><span class="cl">  use_backend front
</span></span><span class="line"><span class="cl">  acl me method get
</span></span><span class="line"><span class="cl">  default_backend back
</span></span><span class="line"><span class="cl">backend front
</span></span><span class="line"><span class="cl">  server web01 10.0.0.1:8080 check port 8080 inter 5000 fall 5
</span></span><span class="line"><span class="cl">backend back
</span></span><span class="line"><span class="cl">  server w1 10.0.0.3:8080 check port 8080 inter 5000 fall 5
</span></span></code></pre></td></tr></table>
</div>
</div><p>
  <img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed//img/image-20221214000225672.png" alt="image-20221214000225672"  /></p>
<p>path_beg &lt;string&gt;</p>
<p>用于测试请求的URL是否以指定的模式开头。</p>
<p>下面的例子用于测试URL是否以/static、/images、/javascript或/stylesheets头。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">acl url_static path_beg -i /static /images /javascript /stylesheets
</span></span></code></pre></td></tr></table>
</div>
</div><p>path_end &lt;string&gt;</p>
<p>用于测试请求的URL是否以指定的模式结尾。</p>
<p>例如，下面的例子用户测试URL是否以jpg、gif、png、css或js结尾</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">acl url_static path_end -i .jpg .gif .png .css .js
</span></span></code></pre></td></tr></table>
</div>
</div><p>hdr_beg &lt;string&gt;</p>
<p>用于测试请求报文的指定首部的开头部分是否符合指定的模式。</p>
<p>例如，下面的例子用记测试请求是否为提供静态内容的主机img、video、download或ftp。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">acl host_static hdr_beg(host) -i img. video. download. ftp.
</span></span></code></pre></td></tr></table>
</div>
</div><p>请求uri中包含static</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">acl timetask_req url_dir -i timetask
</span></span></code></pre></td></tr></table>
</div>
</div><p>请求头长度</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">acl cl hdr_cnt(Content-length) eq 0
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="web-stats">web stats<a hidden class="anchor" aria-hidden="true" href="#web-stats">¶</a></h2>
<p>添加一个 <strong>frontend</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">frontend stats
</span></span><span class="line"><span class="cl">	<span class="c1"># 必填参数，默认无法访问</span>
</span></span><span class="line"><span class="cl">    mode http   
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># 统计页面访问端口</span>
</span></span><span class="line"><span class="cl">    <span class="nb">bind</span> 0.0.0.0:1080
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># 统计页面默认最大连接数</span>
</span></span><span class="line"><span class="cl">    maxconn <span class="m">10</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># http日志格式</span>
</span></span><span class="line"><span class="cl">    option httplog
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># 开启web统计</span>
</span></span><span class="line"><span class="cl">    stats <span class="nb">enable</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 隐藏统计页面上的haproxy版本信息</span>
</span></span><span class="line"><span class="cl">    stats hide-version
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># 监控页面自动刷新时间</span>
</span></span><span class="line"><span class="cl">    stats refresh 30s
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># 统计页面访问url</span>
</span></span><span class="line"><span class="cl">    stats uri /admin?status
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># 监控页面的用户和密码:admin, 可设置多个用户名</span>
</span></span><span class="line"><span class="cl">    stats auth admin:111
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># 统计页面密码框提示文本,某些浏览器不适合中文</span>
</span></span><span class="line"><span class="cl">    stats realm mCloud<span class="se">\ </span>Haproxy
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># 手工启动/禁用后端服务器, 可通过web管理节点</span>
</span></span><span class="line"><span class="cl">    stats admin <span class="k">if</span> TRUE
</span></span></code></pre></td></tr></table>
</div>
</div><p>
  <img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed//img/wps8A90.tmp.jpg" alt="img"  /></p>
<p>
  <img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed//img/image-20221214000411609.png" alt="image-20221214000411609"  /></p>
<h2 id="socat动态操作haproxy">socat动态操作haproxy<a hidden class="anchor" aria-hidden="true" href="#socat动态操作haproxy">¶</a></h2>
<p>socat是一个多功能的网络工具软件，名字来由是”Socket CAT”，功能与netcat类似，可以看做netcat的加强版。</p>
<p><strong>配置haproxy</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">stats socket /app/haproxy/var/run/haproxy.sock mode <span class="m">600</span> level admin
</span></span><span class="line"><span class="cl">stats timeout 2m
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>安装socat</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">yum install socat -y
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>远程操作haproxy</strong></p>
<p>socat帮助</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">echo</span> help<span class="p">|</span>socat stdio /app/haproxy/var/run/haproxy.sock
</span></span></code></pre></td></tr></table>
</div>
</div><p>上线测试摘取集群节点</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">echo</span> disable server back/w1 <span class="p">|</span>socat stdio /app/haproxy/var/run/haproxy.sock
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="nb">enable</span> server back/w1 <span class="p">|</span>socat stdio /app/haproxy/var/run/haproxy.sock
</span></span></code></pre></td></tr></table>
</div>
</div><p>
  <img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed//img/image-socat.gif" alt="image-20221213234451180"  /></p>


    
    


<div class="copyrightBlock" >
    <div class="articleSuffix-bg"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 147.78 155.96"> <path d="M10.5,99.81a1.9,1.9,0,0,0-.53-.09,1.66,1.66,0,0,0-1.64,1.65A1.64,1.64,0,0,0,10,103a1.57,1.57,0,0,0,.87-.25l26.76,26.82.45-1.08L11.52,101.91A1.65,1.65,0,0,0,10.5,99.81Zm-.13,2a.57.57,0,0,1-.8,0,.58.58,0,0,1-.17-.41.58.58,0,0,1,.57-.57h0a.57.57,0,0,1,.56.58A.55.55,0,0,1,10.37,101.77Z" style="fill:#c5c9e0"></path><path d="M56.15,117.58H39.06l0-.09a1.65,1.65,0,0,0-1.36-1H37.5a1.65,1.65,0,1,0,1.56,2.19H55.7L92.92,156h41.44v-1.08h-41Zm-18.25.94a.56.56,0,0,1-.79,0,.58.58,0,0,1-.17-.41.57.57,0,0,1,.56-.57h0a.58.58,0,0,1,.57.58A.54.54,0,0,1,37.9,118.52Z" style="fill:#c5c9e0"></path><path d="M23.52,50.32a1.65,1.65,0,0,0,1.55-1.11H55.28l48-48.13h31.06V0H102.85l-48,48.13H25.07a1.64,1.64,0,0,0-2.09-1,1.64,1.64,0,0,0,.54,3.2Zm0-2.21a.57.57,0,0,1,0,1.13.57.57,0,1,1,0-1.13Z" style="fill:#c5c9e0"></path><polygon points="102.86 0 102.86 0 102.86 0 102.86 0" style="fill:#c5c9e0"></polygon><path d="M107.72,12.14h26.64V11.07H107.27L57.4,61H3.09a1.66,1.66,0,0,0-1.45-.86H1.52A1.65,1.65,0,1,0,2.81,63a1.59,1.59,0,0,0,.45-.87H57.85ZM2.05,62.23a.57.57,0,0,1-.8,0,.58.58,0,0,1-.17-.41.57.57,0,0,1,.56-.57h.09a.57.57,0,0,1,.32,1Z" style="fill:#c5c9e0"></path><path d="M134.36,43.22V42.14h-22.3l-9.62,9.63a1.64,1.64,0,0,0-2.19.77,1.61,1.61,0,0,0-.17.71,1.65,1.65,0,1,0,3.29,0,1.61,1.61,0,0,0-.16-.72l9.3-9.32Zm-32.64,10.6a.57.57,0,0,1,0-1.13.57.57,0,0,1,0,1.13Z" style="fill:#c5c9e0"></path><path d="M147,52.3l-9,9H111.48a1.64,1.64,0,0,0-1.61-1.33h-.14a1.65,1.65,0,1,0,1.6,2.41h27.19l9.26-9.29L147,52.3Zm-37.15,9.85a.56.56,0,0,1-.56-.57h0a.56.56,0,0,1,.56-.56h0a.57.57,0,1,1,0,1.13Z" style="fill:#c5c9e0"></path><path d="M66.79,75.35l11,11.06h56.53V85.33H78.27l-11-11.06H49.49L37.12,86.67a1.64,1.64,0,0,0-2.09,1,1.61,1.61,0,0,0-.09.54,1.65,1.65,0,0,0,3.29,0,1.68,1.68,0,0,0-.26-.89l12-12ZM36.58,88.79a.57.57,0,1,1,.57-.56A.57.57,0,0,1,36.58,88.79Z" style="fill:#c5c9e0"></path><path d="M110.61,95.55,92.8,113.4a1.62,1.62,0,1,0,.77.76l17.49-17.53h23.31V95.55ZM92.49,115.28a.56.56,0,0,1-.8,0,.58.58,0,0,1-.17-.41.57.57,0,0,1,.57-.57h0a.58.58,0,0,1,.56.58A.55.55,0,0,1,92.49,115.28Z" style="fill:#c5c9e0"></path><path d="M97.89,122.3H76.62L64.2,109.85a1.65,1.65,0,0,0-.77-2.2,1.77,1.77,0,0,0-.72-.17h-.14a1.65,1.65,0,0,0,.15,3.29,1.58,1.58,0,0,0,.71-.17l12.74,12.77H98.34l17.48-17.52h18.54v-1.08h-19ZM63.12,109.53a.56.56,0,0,1-.8,0,.58.58,0,0,1-.17-.41.57.57,0,0,1,1.14,0A.54.54,0,0,1,63.12,109.53Z" style="fill:#c5c9e0"></path> </svg> </div>
    <p>本文发布于<a href="https://www.oomkill.com/about" target="_blank">Cylon的收藏册</a>，转载请著名原文链接~</p>
    <p>链接：<a href="https://www.oomkill.com/2017/11/haproxy/" target="_blank">https://www.oomkill.com/2017/11/haproxy/</a></p>
    <p style="margin-bottom: 0px;">版权：本作品采用<a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">「署名-非商业性使用-相同方式共享 4.0 国际」</a> 许可协议进行许可。</p>
    </div>
</div>
  </div>

  <footer class="post-footer">
    
<nav class="paginav">
  <a class="prev" href="https://www.oomkill.com/2018/02/jenkins-github-tag/">
    <span class="title"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left" style="user-select: text;"><line x1="19" y1="12" x2="5" y2="12" style="user-select: text;"></line><polyline points="12 19 5 12 12 5" style="user-select: text;"></polyline>
      </polyline></svg>&nbsp; </span>
    
    <span>jenkins github tag使用方式</span>
  </a>
  <a class="next" href="https://www.oomkill.com/2017/05/ch8-mysql-engine/" >
    <span class="title"> </span>
    
    <span>ch08 - MySQL存储引擎&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right" style="user-select: text;"><line x1="5" y1="12" x2="19" y2="12" style="user-select: text;"></line><polyline points="12 5 19 12 12 19" style="user-select: text;"></polyline></svg></span>
  </a>
</nav>

  </footer>

  
  <div class="pagination__title">
    <span class="pagination__title-h"></span>
  </div>
  
  
  
  
    <div class="comments-separator"></div>
    

  

  
    
      <div class="comments-separator"></div>
<div class="comments">
    <script>
    function loadComment() {
        let theme = localStorage.getItem('pref-theme') === 'dark' ? 'dark' : 'light';
        let s = document.createElement('script');
        s.src = 'https://giscus.app/client.js';
        s.setAttribute('data-repo', 'cylonchau\/cylonchau.github.io');
        s.setAttribute('data-repo-id', 'R_kgDOIRlNSQ');
        s.setAttribute('data-category', 'Announcements');
        s.setAttribute('data-category-id', 'DIC_kwDOIRlNSc4CXy1U');
        s.setAttribute('data-mapping', 'title');
        s.setAttribute('data-reactions-enabled', '1');
        s.setAttribute('data-emit-metadata', '1');
        s.setAttribute('data-input-position', 'top');
        s.setAttribute('data-lang', 'zh-TW');
        s.setAttribute('data-theme', theme);
        s.setAttribute('crossorigin', 'anonymous');
        s.setAttribute('async', '');
        document.querySelector('div.comments').innerHTML = '';
        document.querySelector('div.comments').appendChild(s);
    }
    loadComment();
    </script>
</div>
</article>
    </main>
    
<footer class="footer">
  <p>
  Copyright
  <span>&copy; 2024 <a href="https://www.oomkill.com">Cylon&#39;s Collection</a></span></p>
  <span style="display: inline-block; margin-left: 1em;">
    Powered by
    <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> on github-page & Theme
    <a href="https://github.com/reorx/hugo-PaperModX/" rel="noopener" target="_blank">PaperModX</a>
  </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <span class="topInner">
        <svg class="topSvg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z"/>
        </svg>
        <span id="read_progress"></span>
    </span>
</a>

<script>
  (function() {
     
    const disableThemeToggle = '' == '1';
    if (disableThemeToggle) {
      return;
    }

    let button = document.getElementById("theme-toggle")
    
    button.removeEventListener('click', toggleThemeListener)
    
    button.addEventListener('click', toggleThemeListener)
  })();
</script>

<script>
  (function () {
    let menu = document.getElementById('menu')
    if (menu) {
      menu.scrollLeft = localStorage.getItem("menu-scroll-position");
      menu.onscroll = function () {
        localStorage.setItem("menu-scroll-position", menu.scrollLeft);
      }
    }

    const disableSmoothScroll = '' == '1';
    const enableInstantClick = '1' == '1';
    
    if (window.matchMedia('(prefers-reduced-motion: reduce)').matches || disableSmoothScroll || enableInstantClick) {
      return;
    }
    
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
      anchor.addEventListener("click", function (e) {
        e.preventDefault();
        var id = this.getAttribute("href").substr(1);
        document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
          behavior: "smooth"
        });
        if (id === "top") {
          history.replaceState(null, null, " ");
        } else {
          history.pushState(null, null, `#${id}`);
        }
      });
    });
  })();
</script>

<script>
  document.addEventListener('scroll', function (e) {
      const readProgress = document.getElementById("read_progress");
      const scrollHeight = document.documentElement.scrollHeight;
      const clientHeight = document.documentElement.clientHeight;
      const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
      readProgress.innerText = ((scrollTop / (scrollHeight - clientHeight)).toFixed(2) * 100).toFixed(0);
  })
</script>

<script>
  var menu = document.getElementById('menu')
  if (menu) {
      menu.scrollLeft = localStorage.getItem("menu-scroll-position");
      menu.onscroll = function () {
          localStorage.setItem("menu-scroll-position", menu.scrollLeft);
      }
  }

  document.querySelectorAll('a[href^="#"]').forEach(anchor => {
      anchor.addEventListener("click", function (e) {
          e.preventDefault();
          var id = this.getAttribute("href").substr(1);
          if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
              document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                  behavior: "smooth"
              });
          } else {
              document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
          }
          if (id === "top") {
              history.replaceState(null, null, " ");
          } else {
              history.pushState(null, null, `#${id}`);
          }
      });
  });
</script>
<script>
  var mybutton = document.getElementById("top-link");
  window.onscroll = function () {
      if (document.body.scrollTop > 200 || document.documentElement.scrollTop > 200) {
          mybutton.style.visibility = "visible";
          mybutton.style.opacity = "1";
      } else {
          mybutton.style.visibility = "hidden";
          mybutton.style.opacity = "0";
      }
  };
</script>
<script>
  if (window.scrollListeners) {
    
    for (const listener of scrollListeners) {
      window.removeEventListener('scroll', listener)
    }
  }
  window.scrollListeners = []
</script>



<script src="/js/medium-zoom.min.js" data-no-instant
></script>
<script>
  document.querySelectorAll('pre > code').forEach((codeblock) => {
    const container = codeblock.parentNode.parentNode;

    const copybutton = document.createElement('button');
    copybutton.classList.add('copy-code');
    copybutton.innerText = 'copy';

    function copyingDone() {
      copybutton.innerText = 'copied';
      setTimeout(() => {
        copybutton.innerText = 'copy';
      }, 2000);
    }

    copybutton.addEventListener('click', (cb) => {
      if ('clipboard' in navigator) {
        navigator.clipboard.writeText(codeblock.textContent);
        copyingDone();
        return;
      }

      const range = document.createRange();
      range.selectNodeContents(codeblock);
      const selection = window.getSelection();
      selection.removeAllRanges();
      selection.addRange(range);
      try {
        document.execCommand('copy');
        copyingDone();
      } catch (e) { };
      selection.removeRange(range);
    });

    if (container.classList.contains("highlight")) {
      container.appendChild(copybutton);
    } else if (container.parentNode.firstChild == container) {
      
    } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
      
      codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
    } else {
      
      codeblock.parentNode.appendChild(copybutton);
    }
  });
</script>




<script>
  
  
  (function() {
    const enableTocScroll = '1' == '1'
    if (!enableTocScroll) {
      return
    }
    if (!document.querySelector('.toc')) {
      console.log('no toc found, ignore toc scroll')
      return
    }
    

    
    const scrollListeners = window.scrollListeners
    const headings = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id]');
    const activeClass = 'active';

    
    let activeHeading = headings[0];
    getLinkByHeading(activeHeading).classList.add(activeClass);

    const onScroll = () => {
      const passedHeadings = [];
      for (const h of headings) {
        
        if (getOffsetTop(h) < 5) {
          passedHeadings.push(h)
        } else {
          break;
        }
      }
      if (passedHeadings.length > 0) {
        newActiveHeading = passedHeadings[passedHeadings.length - 1];
      } else {
        newActiveHeading = headings[0];
      }
      if (activeHeading != newActiveHeading) {
        getLinkByHeading(activeHeading).classList.remove(activeClass);
        activeHeading = newActiveHeading;
        getLinkByHeading(activeHeading).classList.add(activeClass);
      }
    }

    let timer = null;
    const scrollListener = () => {
      if (timer !== null) {
        clearTimeout(timer)
      }
      timer = setTimeout(onScroll, 50)
    }
    window.addEventListener('scroll', scrollListener, false);
    scrollListeners.push(scrollListener)

    function getLinkByHeading(heading) {
      const id = encodeURI(heading.getAttribute('id')).toLowerCase();
      return document.querySelector(`.toc ul li a[href="#${id}"]`);
    }

    function getOffsetTop(heading) {
      if (!heading.getClientRects().length) {
        return 0;
      }
      let rect = heading.getBoundingClientRect();
      return rect.top
    }
  })();
  </script>

<script src="/js/instantclick.min.js" data-no-instant
></script>
<script data-no-instant>
  
  
  
  
  
  
  InstantClick.init();
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/8.6.0/mermaid.min.js" crossorigin="anonymous"></script>
<script>
    mermaid.init(undefined, '.language-mermaid');
</script>
</body>

</html>
