<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>monitor on Cylon&#39;s Collection</title>
    <link>https://www.oomkill.com/categories/monitor/</link>
    <description>Recent content in monitor on Cylon&#39;s Collection</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>zh-cn</language>
    <lastBuildDate>Wed, 17 Jul 2024 00:00:00 +0000</lastBuildDate><atom:link href="https://www.oomkill.com/categories/monitor/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>PromQL复杂使用示例</title>
      <link>https://www.oomkill.com/2024/07/promql-advanced/</link>
      <pubDate>Wed, 17 Jul 2024 00:00:00 +0000</pubDate>
      
      <guid>https://www.oomkill.com/2024/07/promql-advanced/</guid>
      <description></description>
      <content:encoded><![CDATA[<h2 id="查询结果删除某些指标">查询结果删除某些指标</h2>
<h3 id="without">without</h3>
<p>without 属于聚合查询的子句，必须在聚合查询中使用</p>
<p>语法：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">&lt;aggr-op&gt; <span class="o">[</span>without<span class="p">|</span>by <span class="o">(</span>&lt;label list&gt;<span class="o">)]</span> <span class="o">([</span>parameter,<span class="o">]</span> &lt;vector expression&gt;<span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看到属于 &lt;aggr-op&gt;</p>
<p>例如</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">sum without(instance) (http_requests_total)
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="ignoring">ignoring</h3>
<p>ignoring 属于 “向量匹配” (<em><strong>Vector matching</strong></em>) 关键词，可以在 一对多，和多对多查询中使用</p>
<p>语法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">&lt;vector expr&gt; &lt;bin-op&gt; ignoring<span class="o">(</span>&lt;label list&gt;<span class="o">)</span> &lt;vector expr&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>例如</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">method_code:http_errors:rate5m<span class="o">{</span><span class="nv">code</span><span class="o">=</span><span class="s2">&#34;500&#34;</span><span class="o">}</span> / ignoring<span class="o">(</span>code<span class="o">)</span> method:http_requests:rate5m
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="与查询">与查询</h2>
<p>可以查询满足多个条件的指标，例如下列是查询 jvm 内存 $\frac{used}{committed} &gt; 80%$ 并且 Pod WSS 使用大于 80% 的指标</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-promql" data-lang="promql"><span class="line"><span class="cl"><span class="k">sum</span><span class="w"> </span><span class="k">by</span><span class="o">(</span><span class="nv">pod</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="nv">jvm_memory_used_bytes</span><span class="p">{}</span><span class="o">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">sum</span><span class="w"> </span><span class="k">by</span><span class="o">(</span><span class="nv">pod</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="nv">jvm_memory_committed_bytes</span><span class="p">{}</span><span class="o">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="err">.</span><span class="mi">8</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="ow">and</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">sum</span><span class="o">(</span><span class="nv">node_namespace_pod_container</span><span class="err">:</span><span class="nv">container_memory_working_set_bytes</span><span class="p">{}</span><span class="o">)</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="o">(</span><span class="nv">pod</span><span class="o">)</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">/</span><span class="w"> </span><span class="k">on</span><span class="o">(</span><span class="nv">pod</span><span class="o">)</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">group_left</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">sum</span><span class="o">(</span><span class="nv">kube_pod_container_resource_limits</span><span class="p">{</span><span class="nl">resource</span><span class="o">=</span><span class="p">&#34;</span><span class="s">memory</span><span class="p">&#34;}</span><span class="o">)</span><span class="w">  </span><span class="k">by</span><span class="w"> </span><span class="o">(</span><span class="nv">pod</span><span class="o">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="err">.</span><span class="mi">8</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="向量查询">向量查询</h2>
<p>向量查询关键词为 <code>on</code> 和 <code>ignoring</code></p>
<p>on 仅考虑表达式内提供的标签相同的，ignoring 允许在匹配时间序列时忽略指定的标签。</p>
<h3 id="语法">语法</h3>
<p>一对一</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">&lt;vector expr&gt; &lt;bin-op&gt; ignoring<span class="o">(</span>&lt;label list&gt;<span class="o">)</span> &lt;vector expr&gt;
</span></span><span class="line"><span class="cl">&lt;vector expr&gt; &lt;bin-op&gt; on<span class="o">(</span>&lt;label list&gt;<span class="o">)</span> &lt;vector expr&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>多对一或一对多</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">&lt;vector expr&gt; &lt;bin-op&gt; ignoring<span class="o">(</span>&lt;label list&gt;<span class="o">)</span> group_left<span class="o">(</span>&lt;label list&gt;<span class="o">)</span> &lt;vector expr&gt;
</span></span><span class="line"><span class="cl">&lt;vector expr&gt; &lt;bin-op&gt; ignoring<span class="o">(</span>&lt;label list&gt;<span class="o">)</span> group_right<span class="o">(</span>&lt;label list&gt;<span class="o">)</span> &lt;vector expr&gt;
</span></span><span class="line"><span class="cl">&lt;vector expr&gt; &lt;bin-op&gt; on<span class="o">(</span>&lt;label list&gt;<span class="o">)</span> group_left<span class="o">(</span>&lt;label list&gt;<span class="o">)</span> &lt;vector expr&gt;
</span></span><span class="line"><span class="cl">&lt;vector expr&gt; &lt;bin-op&gt; on<span class="o">(</span>&lt;label list&gt;<span class="o">)</span> group_right<span class="o">(</span>&lt;label list&gt;<span class="o">)</span> &lt;vector expr&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="向量查询的高级用法">向量查询的高级用法</h3>
<p>通过一个 metrcs 上的 label 的值去查询另外一个 metric 上这个标签的值</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">container_memory_rss<span class="o">{</span><span class="nv">container</span><span class="o">=</span>~<span class="s2">&#34;.*</span><span class="nv">$module</span><span class="s2">.*&#34;</span><span class="o">}</span> on<span class="o">(</span>pod<span class="o">)</span> vm_memory_used_bytes<span class="o">{</span><span class="nv">instance</span><span class="o">=</span>~<span class="s2">&#34;</span><span class="nv">$module</span><span class="s2">.*&#34;</span><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>查询不同标签上的相同标签值的内容，例如，我想通过 **jvm_memory_used_bytes **指标上 pod label 为 “<em><strong>aaaa</strong></em>” 的 label，去查询 <strong>container_memory_rss</strong> 上 container label 为 “<em><strong>aaaa</strong></em>” 的指标内容，这个时候可以使用 <em><strong>label_replace</strong></em> 来重写不同的 label 为相同的值，on() 函数中添加相同指标的值即可完成查询。</p>
<p>如下所示</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">sum without(
</span></span><span class="line"><span class="cl">	node,instance,job,name,id,image,metrics_path,endpoint,service,pod)(
</span></span><span class="line"><span class="cl">		label_replace(
</span></span><span class="line"><span class="cl">			container_memory_rss{container=~&#34;.*$module.*&#34;,}
</span></span><span class="line"><span class="cl">			,&#34;ints&#34;,&#34;$1&#34;,&#34;pod&#34;, &#34;(.*)&#34;
</span></span><span class="line"><span class="cl">		)
</span></span><span class="line"><span class="cl">) 
</span></span><span class="line"><span class="cl">!= on(ints) 
</span></span><span class="line"><span class="cl">group_left() 
</span></span><span class="line"><span class="cl">sum by(ints) 
</span></span><span class="line"><span class="cl">	(sum without (job,pod,container) (
</span></span><span class="line"><span class="cl">		label_replace(
</span></span><span class="line"><span class="cl">			jvm_memory_used_bytes{instance=&#34;$instance&#34;}
</span></span><span class="line"><span class="cl">			,&#34;ints&#34;,&#34;$1&#34;,&#34;pod&#34;, &#34;(.*)&#34;
</span></span><span class="line"><span class="cl">		)
</span></span><span class="line"><span class="cl">	)
</span></span><span class="line"><span class="cl">)
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="reference">Reference</h2>
<ul>
<li><sup id="1">[1]</sup> <a href="https://blog.devops.dev/advanced-promql-understanding-optimizing-and-logical-grouping-of-queries-11220e80ba0d">Optimizing, and Logical Grouping of Queries</a></li>
<li><sup id="2">[2]</sup> <a href="https://www.robustperception.io/using-group_left-to-calculate-label-proportions">Using group_left to calculate label proportions</a></li>
<li><sup id="3">[3]</sup> <a href="https://fiberplane.com/blog/inside-some-complex-prometheus-queries">Inside some complex Prometheus queries</a></li>
<li><sup id="4">[4]</sup> <a href="https://prometheus.io/docs/prometheus/latest/querying/operators/">Operators</a></li>
</ul>
]]></content:encoded>
    </item>
    
    <item>
      <title>深入解析Kubernetes监控体系与prometheus-adapter</title>
      <link>https://www.oomkill.com/2024/05/prometheus-adapter-intro/</link>
      <pubDate>Fri, 31 May 2024 00:00:00 +0000</pubDate>
      
      <guid>https://www.oomkill.com/2024/05/prometheus-adapter-intro/</guid>
      <description></description>
      <content:encoded><![CDATA[<h2 id="kubernetes监控架构设计">Kubernetes监控架构设计</h2>
<h3 id="k8s监控设计背景说明">k8s监控设计背景说明</h3>
<p>根据 Kubernetes监控架构 <sup><a href="#1">1</a></sup>，Kubernetes 集群中的 metrcis 可以分为 <strong>系统指标</strong> (Core Metrics) 和 <strong>服务指标</strong> (service metrics) ; 系统指标(System metrics) 是通用的指标，通常可以从每一个被监控的实体中获得（例如，容器和节点的CPU和内存使用情况）。服务指标(Service metrics) 是在应用程序代码中显式定义并暴露的 (例如，API Server 处理的 500 错误数量)。</p>
<p>Kubernetes将系统指标分为两部分：</p>
<ul>
<li>核心指标 (core metrics) 是 Kubernetes 理解和用于其内部组件和核心工具操作的指标，例如：用于调度的指标 (包括资源估算算法的输入, 初始资源/VPA (vertical autoscaling)，集群自动扩缩 (cluster autoscaling)，水平Pod自动扩缩 (horizontal pod autoscaling ) 除自定义指标之外的指标)；Kube Dashboard 使用的指标，以及 “kubectl top” 命令使用的指标。</li>
<li>非核心指标 (non-core metrics) 是指不被 Kubernetes 解释的指标。我们一般假设这些指标包含核心指标 (但不一定是 Kubernetes 可理解的格式)，以及其他额外的指标。</li>
</ul>
<p>所以，kubernetes monitoring 的架构被设计拥有如下特点：</p>
<ul>
<li>通过标准的主 API (当前为主监控 API) 提供关于Node, Pod 和容器的核心系统指标，使得核心 Kubernetes 功能不依赖于非核心组件</li>
<li>kubelet 只导出有限的指标集，即核心 Kubernetes 组件正常运行所需的指标。</li>
<li>&hellip;</li>
</ul>
<h3 id="监控管道">监控管道</h3>
<p>Kubernetes 监控管道分为两个：</p>
<ul>
<li>核心指标管道 (<strong>core metrics pipeline</strong>) 由 Kubelet、资源估算器, 一个精简版 Heapster (metrics-server)，以及 api-server 中 master metrics API 组成。这些指标被核心系统组件使用，例如调度逻辑（如调度器和基于系统指标的HPA）和一些简单 UI 组件（如 kubectl top），这个管道并不打算与第三方监控系统集成。</li>
<li>监控管道：一个用于收集系统中的各种指标并将其暴露给最终用户端，以及通过适配器暴露给 HPA(用于自定义指标) 和  Infrastore 的。用户可以选择多种监控系统供应商（例如 Prometheus, metric-server），也可以完全不使用。</li>
</ul>
<h4 id="core-metrics-pipeline">Core Metrics Pipeline</h4>
<p>根据 kubernetes 监控设计文档可以得知，核心指标指</p>
<ul>
<li>使用这组核心指标，由Kubelet收集，并仅供 Kubernetes 系统组件使用，支持&quot;第一类资源隔离和利用特性&quot;。</li>
<li>不设计成面向用户的 API，而是尽可能通用，以支持未来的用户级组件。</li>
</ul>
<p>核心指标的包含三类：</p>
<ul>
<li>CpuUsage: 记录从创建对象开始的累计CPU使用时间。</li>
<li>MemoryUsage: 记录工作集内存使用量。</li>
<li>FilesystemUsage: 记录文件系统使用情况,包括已用字节数和已用Inode数。</li>
</ul>
<h4 id="monitoring-pipeline">Monitoring Pipeline</h4>
<p>根据 Kubernetes 监控设计文档 <sup><a href="#1">1</a></sup> 得知，监控管道用于与核心Kubernetes组件分开的系统，可以更加灵活。并且监控管道可以收集不同类型的指标：</p>
<ul>
<li>Core system metrics</li>
<li>Non-core system metrics</li>
<li>Service metrics from user application containers</li>
<li>Service metrics from Kubernetes infrastructure containers (using Prometheus instrumentation)</li>
</ul>
<p>监控管道主要用于根据自定义指标进行 HPA，监控管道提供了一个无状态的 API Adapter，用于拉去监控给 HPA</p>
<h3 id="指标api">指标API</h3>
<h4 id="api类别">API类别</h4>
<p>根据监控架构设计文档，Kubernetes 定义了两套指标 API，资源指标 API 和 自定义指标 API；Kubernetes 为资源指标 API 提供了两种实现：Heapster 和 metrics-server，而自定义指标 API 由不同的监控供应商实现。下面将详细描述每个 API。</p>
<ul>
<li>
<p>资源指标 API (Resource Metrics API)：该 API 允许消费者访问 Pod 和 Node 的资源指标（CPU &amp; Memory）</p>
<ul>
<li>The API is implemented by metrics-server and prometheus-adapter.</li>
</ul>
</li>
<li>
<p>自定义指标 API (Custom Metrics API)：该 API 允许消费者访问描述 Kubernetes 资源的任意指标。</p>
<ul>
<li>用户可以根据 <a href="https://github.com/kubernetes-sigs/custom-metrics-apiserver">kubernetes-sigs/custom-metrics-apiserver </a> 仓库来自定义 API-server</li>
</ul>
</li>
</ul>
<h4 id="api的访问">API的访问</h4>
<p>资源指标，该 API 是在 <code>/apis/metrics.k8s.io/</code> ，可以使用 <code>kubectl proxy --port 8080</code> 代理后进行访问，</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ kubectl proxy --port<span class="o">=</span><span class="m">8080</span>
</span></span><span class="line"><span class="cl">$ curl localhost:8080/apis/metrics.k8s.io/v1beta1/nodes
</span></span></code></pre></td></tr></table>
</div>
</div><p>或者使用 <code>kubectl get --raw</code> 进行获取</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ kubectl get --raw <span class="s2">&#34;/apis/metrics.k8s.io/v1beta1/nodes&#34;</span> <span class="p">|</span> jq 
</span></span></code></pre></td></tr></table>
</div>
</div><p>自定义指标，该 API 是在 <code>/apis/custom.metrics.k8s.io/</code> ，访问的方式相同，用户通过该 PATH 进行访问。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 查看有哪些指标可用</span>
</span></span><span class="line"><span class="cl">$ kubectl get --raw <span class="s2">&#34;/apis/custom.metrics.k8s.io/v1beta1/&#34;</span> <span class="p">|</span> jq
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="prometheus-adapter">Prometheus-adapter</h2>
<p>通过上一章节介绍了kubernetes监控体系，这已经可以了解到了 prometheus-adapter 的定位；prometheus-adapter 是通过 kubernetes custom-metrics-apiserver 标准实现的一个 custom.metrics.k8s.io API，用于提供给 HPA 的一种指标适配器，可以将任何指标转化为 HPA 可用的指标。他全名为 <strong>Kubernetes Custom Metrics Adapter for Prometheus</strong>。</p>
<h3 id="prometheus-adapter配置文件详解">prometheus-adapter配置文件详解</h3>
<p>prometheus-adapter负责确定哪些指标以及如何去发现这些指标，根据这个标准，配置文件分为四个步骤来完成这套 “发现” 规则</p>
<p>每一个指标可以大致分为四个部分，对应在配置文件中：</p>
<ul>
<li><em>Discovery</em>  ，用于指定 adapter 应如何查找此规则的所有Prometheus指标。</li>
<li><em>Association</em>  ，用于指定 adapter 应如何确定特定指标与哪些 Kubernetes 资源相关联。</li>
<li><em>Naming</em> ，用于指定 adapter 应如何在自定义指标 API 中公开该指标。</li>
<li><em>Querying</em> ，用于指定如何将针对一个或多个 Kubernetes 对象的特定指标请求转换为对 Prometheus 的查询。</li>
</ul>
<p>配置文件如下所示，这是官方给出的样板<a href="https://github.com/kubernetes-sigs/prometheus-adapter/blob/v0.12.0/docs/sample-config.yaml">配置文件</a>（文章编写时版本为0.12）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># Each rule represents a some naming and discovery logic.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># Each rule is executed independently of the others, so</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># take care to avoid overlap.  As an optimization, rules</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># with the same `seriesQuery` but different</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># `name` or `seriesFilters` will use only one query to</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># Prometheus for discovery.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># some of these rules are taken from the &#34;default&#34; configuration, which</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># can be found in pkg/config/default.go</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># this rule matches cumulative cAdvisor metrics measured in seconds</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">seriesQuery</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;{__name__=~&#34;^container_.*&#34;,container!=&#34;POD&#34;,namespace!=&#34;&#34;,pod!=&#34;&#34;}&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># skip specifying generic resource&lt;-&gt;label mappings, and just</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># attach only pod and namespace resources by mapping label names to group-resources</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">overrides</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span>{<span class="nt">resource</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;namespace&#34;</span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">pod</span><span class="p">:</span><span class="w"> </span>{<span class="nt">resource</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;pod&#34;</span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># specify that the `container_` and `_seconds_total` suffixes should be removed.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># this also introduces an implicit filter on metric family names</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># we use the value of the capture group implicitly as the API name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># we could also explicitly write `as: &#34;$1&#34;`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matches</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;^container_(.*)_seconds_total$&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># specify how to construct a query to fetch samples for a given series</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># This is a Go template where the `.Series` and `.LabelMatchers` string values</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># are available, and the delimiters are `&lt;&lt;` and `&gt;&gt;` to avoid conflicts with</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># the prometheus query language</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">metricsQuery</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;sum(rate(&lt;&lt;.Series&gt;&gt;{&lt;&lt;.LabelMatchers&gt;&gt;,container!=&#34;</span><span class="l">POD&#34;}[2m])) by (&lt;&lt;.GroupBy&gt;&gt;)&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># this rule matches cumulative cAdvisor metrics not measured in seconds</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">seriesQuery</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;{__name__=~&#34;^container_.*_total&#34;,container!=&#34;POD&#34;,namespace!=&#34;&#34;,pod!=&#34;&#34;}&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">overrides</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span>{<span class="nt">resource</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;namespace&#34;</span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">pod</span><span class="p">:</span><span class="w"> </span>{<span class="nt">resource</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;pod&#34;</span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">seriesFilters</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># since this is a superset of the query above, we introduce an additional filter here</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">isNot</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;^container_.*_seconds_total$&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span>{<span class="nt">matches</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;^container_(.*)_total$&#34;</span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">metricsQuery</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;sum(rate(&lt;&lt;.Series&gt;&gt;{&lt;&lt;.LabelMatchers&gt;&gt;,container!=&#34;</span><span class="l">POD&#34;}[2m])) by (&lt;&lt;.GroupBy&gt;&gt;)&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># this rule matches cumulative non-cAdvisor metrics</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">seriesQuery</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;{namespace!=&#34;&#34;,__name__!=&#34;^container_.*&#34;}&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span>{<span class="nt">matches</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;^(.*)_total$&#34;</span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># specify an a generic mapping between resources and labels.  This</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># is a template, like the `metricsQuery` template, except with the `.Group`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># and `.Resource` strings available.  It will also be used to match labels,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># so avoid using template functions which truncate the group or resource.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># Group will be converted to a form acceptible for use as a label automatically.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">template</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&lt;&lt;.Resource&gt;&gt;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># if we wanted to, we could also specify overrides here</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">metricsQuery</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;sum(rate(&lt;&lt;.Series&gt;&gt;{&lt;&lt;.LabelMatchers&gt;&gt;,container!=&#34;</span><span class="l">POD&#34;}[2m])) by (&lt;&lt;.GroupBy&gt;&gt;)&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># this rule matches only a single metric, explicitly naming it something else</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># It&#39;s series query *must* return only a single metric family</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">seriesQuery</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;cheddar{sharp=&#34;true&#34;}&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># this metric will appear as &#34;cheesy_goodness&#34; in the custom metrics API</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span>{<span class="nt">as</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;cheesy_goodness&#34;</span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">overrides</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c"># this should still resolve in our cluster</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">brand</span><span class="p">:</span><span class="w"> </span>{<span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;cheese.io&#34;</span><span class="nt">, resource</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;brand&#34;</span>}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">metricsQuery</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;count(cheddar{sharp=&#34;true&#34;})&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># external rules are not tied to a Kubernetes resource and can reference any metric</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough/#autoscaling-on-metrics-not-related-to-kubernetes-objects</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">externalRules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">seriesQuery</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;{__name__=&#34;queue_consumer_lag&#34;,name!=&#34;&#34;}&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">metricsQuery</span><span class="p">:</span><span class="w"> </span><span class="l">sum(&lt;&lt;.Series&gt;&gt;{&lt;&lt;.LabelMatchers&gt;&gt;}) by (name)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">seriesQuery</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;{__name__=&#34;queue_depth&#34;,topic!=&#34;&#34;}&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">metricsQuery</span><span class="p">:</span><span class="w"> </span><span class="l">sum(&lt;&lt;.Series&gt;&gt;{&lt;&lt;.LabelMatchers&gt;&gt;}) by (name)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Kubernetes metric queries include a namespace in the query by default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># but you can explicitly disable namespaces if needed with &#34;namespaced: false&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># this is useful if you have an HPA with an external metric in namespace A</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># but want to query for metrics from namespace B</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">namespaced</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># TODO: should we be able to map to a constant instance of a resource</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># (e.g. `resources: {constant: [{resource: &#34;namespace&#34;, name: &#34;kube-system&#34;}}]`)?</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="discovery">Discovery</h4>
<p>Discovery 部分控制了查找要在自定义指标 API 中公开的指标的过程。其中有两个关键字段：<code>seriesQuery</code> 和 <code>seriesFilters</code>。</p>
<p><strong>seriesQuery</strong> 指定了用于查找某些 Prometheus series 的 Prometheus series 查询(作为传递给  Prometheus  <code> /api/v1/series</code>)。适配器将从这些系列中剥离标签值，然后在后续步骤中使用得到的“指标名称—标签名称”的组合。</p>
<p>在许多情况下，seriesQuery 就足以缩小 Prometheus series 的列表。但有时(特别是当两个规则可能重叠时)，对指标名称进行额外的过滤是很有用的。在这种情况下,可以使用  seriesFilters。在从 seriesQuery 返回 series  列表后，每个 series 的指标名称都会通过指定的任何过滤器进行过滤。</p>
<p>过滤器可以是以下两种形式之一:</p>
<ul>
<li>is: <regex>，匹配名称符合指定正则表达式的任何序列。</li>
<li>isNot: <regex>，匹配名称不符合指定正则表达式的任何序列。</li>
</ul>
<p>例如</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># match all cAdvisor metrics that aren&#39;t measured in seconds</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">seriesQuery</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;{__name__=~&#34;^container_.*_total&#34;,container!=&#34;POD&#34;,namespace!=&#34;&#34;,pod!=&#34;&#34;}&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">seriesFilters</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">isNot</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;^container_.*_seconds_total&#34;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="association">Association</h4>
<p>Association 部分控制了确定序列指标可以附加到哪些 Kubernetes 资源的过程。resources 字段控制了这个过程。</p>
<p>有两种方式来关联资源与特定指标。在这两种情况下,标签的值都会成为特定对象的名称。</p>
<p>一种方式是指定，任何符合某个特定模式的标签名称都指向基于标签名称的某个“group_resource”。这可以使用 template 字段来完成。pattern 被指定为一个 Go 模板，其中 Group 和 Resource 字段分别代表“组”和“资源”。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># any label `kube_&lt;group&gt;_&lt;resource&gt;` becomes &lt;group&gt;.&lt;resource&gt; in Kubernetes</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;kube_&lt;&lt;.Group&gt;&gt;_&lt;&lt;.Resource&gt;&gt;&#34;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>另一种方式是指定某个特定标签代表某个特定的 Kubernetes 资源。这可以使用 overrides 字段来完成。每个 override 将一个 Prometheus 标签映射到一个 Kubernetes group-resource。例如:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># the microservice label corresponds to the apps.deployment resource</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">overrides</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">microservice</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;apps&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">resource</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;deployment&#34;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Association 部分提供了两种关联 Prometheus 指标和 Kubernetes 资源的方式，可以根据需要灵活地组合使用。这是实现自定义指标 API 的关键一环。</p>
<h4 id="naming">Naming</h4>
<p>Naming 部分控制了将 Prometheus 指标名称转换为自定义指标 API 中的指标，这是通过 name 字段来实现的。</p>
<p>Naming 的控制通过指定一个从 Prometheus 名称中提取 API 名称的模式，以及对提取值进行的可选转换来实现。</p>
<p>模式由 <code>matches</code> 字段指定，这是一个正则表达式。如果没有指定,它默认为 .* 。</p>
<p>转换由 <code>as</code> 字段指定。你可以使用 <code>matches</code> 字段中定义的任何捕获组。如果 <code>matches</code> 字段没有捕获组，as 字段默认为 <code>$0</code> 。如果只包含一个捕获组，as 字段默认为 <code>$1</code> 。否则，如果没有指定 as 字段就会出错。例如</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># match turn any name &lt;name&gt;_total to &lt;name&gt;_per_second</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># e.g. http_requests_total becomes http_requests_per_second</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">name</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">matches</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;^(.*)_total$&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">as</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;${1}_per_second&#34;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="querying">Querying</h4>
<p>Querying 部分控制了实际获取特定指标值的过程。它由 <code>metricsQuery</code> 字段来控制。</p>
<p>metricsQuery 字段是一个 Go 模板,它会被转换成一个 Prometheus 查询，使用从特定的自定义指标 API  调用获取的输入数据。对自定义指标 API  的一次调用会被简化为一个指标名称、一个 “group-resource” 和一个或多个该 “group-resource” 的对象。这些会被转换成模板中的以下字段:</p>
<ul>
<li>Series: 指标名称</li>
<li>LabelMatchers: 一个逗号分隔的标签匹配器列表，匹配给定的对象。当前包括特定的 “group-resource” 标签，以及 namespace 标。</li>
<li>GroupBy: 一个逗号分隔的用于分组的标签列表。当前包括用于 LabelMatchers 的组-资源标签。</li>
</ul>
<p>例如，假设我们有一个 <code>http_requests_total</code> 序列 (在 API 中公开为  http_requests_per_second )，具有 service、pod、ingress、namespace 和 verb  标签。前四个对应于 Kubernetes 资源。那么,如果有人请求了 <code>pods/http_request_per_second</code> 指标，那么针对  somens 命名空间中的 pod1 和 pod2，我们会有:</p>
<ul>
<li>Series: &ldquo;http_requests_total&rdquo;</li>
<li>LabelMatchers: <code>&quot;pod=~&quot;pod1|pod2&quot;,namespace=&quot;somens&quot;&quot;</code></li>
<li>GroupBy: pod</li>
</ul>
<p>对应 prometheus promql 如下所示</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sum<span class="o">(</span>http_requests_total<span class="o">{</span><span class="nv">pod</span><span class="o">=</span>~<span class="s2">&#34;pod1|pod2&#34;</span>,namespace<span class="o">=</span><span class="s2">&#34;somens&#34;</span><span class="o">})</span> by <span class="o">(</span>pod<span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>此外,还有两个高级字段是其他字段的&quot;原始&quot;形式:</p>
<ul>
<li>LabelValuesByName: 映射。将 LabelMatchers 字段中的标签和值对应起来。值是用 <code>|</code> 预先连接的 (用于在 Prometheus 中使用 =~ 匹配器)。</li>
<li>GroupBySlice: GroupBy 字段的切片形式。</li>
</ul>
<p>通常，我们可能会想使用 Series、LabelMatchers 和 GroupBy 字段。其他两个是用于高级用法的。</p>
<p>Querying 预计会为每个请求的对象返回一个值。适配器会使用返回的系列上的标签，将给定的系列关联回其相应的对象。例如:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># convert cumulative cAdvisor metrics into rates calculated over 2 minutes</span>
</span></span><span class="line"><span class="cl">metricsQuery: <span class="s2">&#34;sum(rate(&lt;&lt;.Series&gt;&gt;{&lt;&lt;.LabelMatchers&gt;&gt;,container!=&#34;</span>POD<span class="s2">&#34;}[2m])) by (&lt;&lt;.GroupBy&gt;&gt;)&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="完整的配置文件实例">完整的配置文件实例</h3>
<p>例如，我们想使用 springboot 的 actuator 提供的 <code>jvm_memory_used_bytes</code> 和 <code>jvm_memory_max_bytes</code> 计算内存使用率，如下所式</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">seriesQuery</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;jvm_memory_used_bytes&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">overrides</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">namespace</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">resource</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;namespace&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">pod</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">resource</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;pod&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matches</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;jvm_memory_used_bytes&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">as</span><span class="p">:</span><span class="w"> </span><span class="l">memory_percent</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">metricsQuery</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;sum(jvm_memory_used_bytes{&lt;&lt;.LabelMatchers&gt;&gt;}) by (&lt;&lt;.GroupBy&gt;&gt;) / sum(jvm_memory_max_bytes{&lt;&lt;.LabelMatchers&gt;&gt;}) by (&lt;&lt;.GroupBy&gt;&gt;) * 100&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">seriesQuery</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;process_cpu_usage&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">overrides</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">namespace</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">resource</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;namespace&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">pod</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">resource</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;pod&#34;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matches</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;process_cpu_usage&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">as</span><span class="p">:</span><span class="w"> </span><span class="l">process_cpu_percent</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">metricsQuery</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;sum(avg_over_time(process_cpu_usage{&lt;&lt;.LabelMatchers&gt;&gt;}[1m])) by (&lt;&lt;.GroupBy&gt;&gt;)&#39;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>这里用到了一个技巧，就是使用查询多个指标，这里参考了 prometheus-adapter 的说明 <sup><a href="#4">4</a></sup></p>
<blockquote>
<p>这很好理解,虽然一开始可能看起来不太明显。</p>
<p>基本上，你只需要选择一个指标作为 &ldquo;Discovery&rdquo; 和 &ldquo;naming&rdquo; 指标，然后使用它来配置配置中的 &ldquo;discovery&rdquo; 和 &ldquo;naming&rdquo; 部分。之后，你就可以在 metricsQuery 中写任何你想要的指标了！ ==<strong>Querying 的序列可以包含任何你想要的指标，只要它们有正确的标签集合即可</strong>==。</p>
</blockquote>
<p>例如，假设你有两个指标 foo_total 和 foo_count，它们都有一个标签 <code>system_name</code>，用于表示节点资源，那么如下配置所示</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">seriesQuery</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;foo_total&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span>{<span class="nt">overrides</span><span class="p">:</span><span class="w"> </span>{<span class="nt">system_name</span><span class="p">:</span><span class="w"> </span>{<span class="nt">resource</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;node&#34;</span>}}}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matches</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;foo_total&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">as</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;foo&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">metricsQuery</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;sum(foo_total{&lt;&lt;.LabelMatchers&gt;&gt;}) by (&lt;&lt;.GroupBy&gt;&gt;) / sum(foo_count{&lt;&lt;.LabelMatchers&gt;&gt;}) by (&lt;&lt;.GroupBy&gt;&gt;)&#39;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>由于我们使用了 <code>jvm_memory_used_bytes</code> 和 <code>jvm_memory_max_bytes</code> ，那么我们可以在 &ldquo;discovery&rdquo; 和 &ldquo;naming&rdquo; 部分写任意指标，在 ”quering“ 中使用真是的指标进行替换，就可以完成</p>
<h4 id="查询-kubernetes-的指标">查询 kubernetes 的指标</h4>
<p>完成配置后，可以使用下面命令进行查询</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl get --raw <span class="s2">&#34;/apis/custom.metrics.k8s.io/v1beta1&#34;</span><span class="p">|</span>jq
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;kind&#34;</span>: <span class="s2">&#34;APIResourceList&#34;</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;apiVersion&#34;</span>: <span class="s2">&#34;v1&#34;</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;groupVersion&#34;</span>: <span class="s2">&#34;custom.metrics.k8s.io/v1beta1&#34;</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;resources&#34;</span>: <span class="o">[</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;name&#34;</span>: <span class="s2">&#34;pods/process_cpu_percent&#34;</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;singularName&#34;</span>: <span class="s2">&#34;&#34;</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;namespaced&#34;</span>: true,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;kind&#34;</span>: <span class="s2">&#34;MetricValueList&#34;</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;verbs&#34;</span>: <span class="o">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;get&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="o">]</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>,
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;name&#34;</span>: <span class="s2">&#34;pods/memory_percent&#34;</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;singularName&#34;</span>: <span class="s2">&#34;&#34;</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;namespaced&#34;</span>: true,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;kind&#34;</span>: <span class="s2">&#34;MetricValueList&#34;</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;verbs&#34;</span>: <span class="o">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;get&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="o">]</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>,
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;name&#34;</span>: <span class="s2">&#34;namespaces/memory_percent&#34;</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;singularName&#34;</span>: <span class="s2">&#34;&#34;</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;namespaced&#34;</span>: false,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;kind&#34;</span>: <span class="s2">&#34;MetricValueList&#34;</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;verbs&#34;</span>: <span class="o">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;get&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="o">]</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>,
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;name&#34;</span>: <span class="s2">&#34;namespaces/process_cpu_percent&#34;</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;singularName&#34;</span>: <span class="s2">&#34;&#34;</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;namespaced&#34;</span>: false,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;kind&#34;</span>: <span class="s2">&#34;MetricValueList&#34;</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;verbs&#34;</span>: <span class="o">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;get&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="o">]</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">  <span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以通过 custom API 进程查询具体获取的值，如下所示</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ kubectl get --raw <span class="s2">&#34;/apis/custom.metrics.k8s.io/v1beta1/namespaces/public/pods/*/process_cpu_percent&#34;</span><span class="p">|</span>jq
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;kind&#34;</span>: <span class="s2">&#34;MetricValueList&#34;</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;apiVersion&#34;</span>: <span class="s2">&#34;custom.metrics.k8s.io/v1beta1&#34;</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;metadata&#34;</span>: <span class="o">{}</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;items&#34;</span>: <span class="o">[</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;describedObject&#34;</span>: <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;kind&#34;</span>: <span class="s2">&#34;Pod&#34;</span>,
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;namespace&#34;</span>: <span class="s2">&#34;msg&#34;</span>,
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;name&#34;</span>: <span class="s2">&#34;message-gateway-api-78c4d5cdbf-9k2g7&#34;</span>,
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;apiVersion&#34;</span>: <span class="s2">&#34;/v1&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="o">}</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;metricName&#34;</span>: <span class="s2">&#34;process_cpu_percent&#34;</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;timestamp&#34;</span>: <span class="s2">&#34;2024-05-31T11:40:25Z&#34;</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;value&#34;</span>: <span class="s2">&#34;404m&#34;</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;selector&#34;</span>: null
</span></span><span class="line"><span class="cl">    <span class="o">}</span>,
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    ...
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;describedObject&#34;</span>: <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;kind&#34;</span>: <span class="s2">&#34;Pod&#34;</span>,
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;namespace&#34;</span>: <span class="s2">&#34;msg&#34;</span>,
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;name&#34;</span>: <span class="s2">&#34;message-core-79fdc6fdd-lkpdm&#34;</span>,
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;apiVersion&#34;</span>: <span class="s2">&#34;/v1&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="o">}</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;metricName&#34;</span>: <span class="s2">&#34;process_cpu_percent&#34;</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;timestamp&#34;</span>: <span class="s2">&#34;2024-05-31T11:40:25Z&#34;</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;value&#34;</span>: <span class="s2">&#34;31m&#34;</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;selector&#34;</span>: null
</span></span><span class="line"><span class="cl">    <span class="o">}</span>,
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;describedObject&#34;</span>: <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;kind&#34;</span>: <span class="s2">&#34;Pod&#34;</span>,
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;namespace&#34;</span>: <span class="s2">&#34;msg&#34;</span>,
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;name&#34;</span>: <span class="s2">&#34;message-push-admin-554f5d96fd-xlnhj&#34;</span>,
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;apiVersion&#34;</span>: <span class="s2">&#34;/v1&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="o">}</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;metricName&#34;</span>: <span class="s2">&#34;process_cpu_percent&#34;</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;timestamp&#34;</span>: <span class="s2">&#34;2024-05-31T11:40:25Z&#34;</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;value&#34;</span>: <span class="s2">&#34;487m&#34;</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;selector&#34;</span>: null
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">  <span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们可以看到，返回值是带有 ”m“ 的单位，这里 issue 是这样回答的</p>
<blockquote>
<p>The <code>m</code>-suffix means milli, Quantity Values are explained here: <a href="https://github.com/kubernetes-sigs/prometheus-adapter/blob/master/docs/walkthrough.md#quantity-values">https://github.com/kubernetes-sigs/prometheus-adapter/blob/master/docs/walkthrough.md#quantity-values</a>  <sup><a href="#5">5</a></sup></p>
</blockquote>
<p>在指标 API 中最常见的是 m 后缀,它表示毫单位，即单位的千分之一；由于我们返回值是一个百分比，例如 4.87%，那么实际值是 0.0487，那么他的毫单位为就是 “487m” ，和上面返回值一样。</p>
<h3 id="prometheus-adapter的安装">Prometheus-adapter的安装</h3>
<p>在这里采用 helm 方式进行安装，只需要修改对应参数即可</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">helm install prometheus-adapter -n monitoring  prometheus-community/prometheus-adapter <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	--set prometheus.url<span class="o">=</span>http://prometheus.default.svc <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	--set <span class="nv">logLevel</span><span class="o">=</span><span class="m">2</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	--set rules.external<span class="o">=</span>xxx <span class="c1"># 如果使用外部规则替换默认的config.yaml,则需要提前创建一个configmap，然后这里指定这个名称</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="reference">Reference</h2>
<p><sup id="1">[1]</sup> <a href="https://github.com/kubernetes/design-proposals-archive/blob/main/instrumentation/monitoring_architecture.md">Kubernetes monitoring architecture</a></p>
<p><sup id="2">[2]</sup> <a href="https://github.com/kubernetes/design-proposals-archive/blob/main/instrumentation/core-metrics-pipeline.md">core-metrics-pipeline</a></p>
<p><sup id="3">[3]</sup> <a href="https://github.com/kubernetes/metrics">kubernetes/metrics</a></p>
<p><sup id="4">[4]</sup> <a href="https://github.com/kubernetes-sigs/prometheus-adapter/tree/v0.12.0?tab=readme-ov-file#my-query-contains-multiple-metrics-how-do-i-make-that-work">my-query-contains-multiple-metrics-how-do-i-make-that-work</a></p>
<p><sup id="5">[5]</sup> <a href="https://github.com/kubernetes-sigs/prometheus-adapter/issues/376">why i request rest-api, returned requeslt for item value has &rsquo;m&rsquo; unit!!  #376</a></p>
<p><sup id="6">[6]</sup> <a href="https://medium.com/@congliu.thu/complete-guide-to-kubernetes-metrics-24a8782c34cd">Guide to Kubernetes Metrics</a></p>
<p><sup id="7">[7]</sup>  <a href="https://www.geekgame.site/post/k8s/monitoring_arch/">Kubernetes 监控架构(译)</a></p>
]]></content:encoded>
    </item>
    
    <item>
      <title>使用keycloak作为grafana的OAuth2认证</title>
      <link>https://www.oomkill.com/2023/12/grafana-keycloak/</link>
      <pubDate>Tue, 19 Dec 2023 00:00:00 +0000</pubDate>
      
      <guid>https://www.oomkill.com/2023/12/grafana-keycloak/</guid>
      <description></description>
      <content:encoded><![CDATA[<p>本文使用 helm 方式部署 grafana 9 并同样将 keycloak 部署在 kubernetes 集群之上；接下来使用 keycloak 作为 grafana authentication，并实现 oauth2 的用户权限管理。</p>
<h2 id="在kubernetes-集群之上使用helm部署keycloak">在Kubernetes 集群之上使用helm部署keycloak</h2>
<p>在 kubernetes 集群安装 keycloak 有两种方式：</p>
<ul>
<li><a href="https://artifacthub.io/packages/helm/riftbit/keycloak">bitnami helm</a></li>
<li><a href="https://www.keycloak.org/getting-started/getting-started-kube">offical</a></li>
</ul>
<p>下面使用 offical 提供的方式进行部署</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl create -f https://raw.githubusercontent.com/keycloak/keycloak-quickstarts/latest/kubernetes/keycloak.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><p>helm 部署完成后默认密码是存储在 secret 中，上面方式安装的密码默认为 admin/admin</p>
<h2 id="keycloak-configuration">Keycloak configuration</h2>
<h3 id="创建realm">创建realm</h3>
<p>Realm 管理这一组用户(users), 凭据(credentials), 角色(roles) 和 组(groups)，realm之间是相互隔离，一个用户属于并登录到某个 realm，只能管理和验证其控制的用户。</p>
<p>下面为 grafana 创建一个 realm，如果你的环境已经存在通用的 realm，则可以使用这个 realm，默认 keycloak 的 realm 是 master，超级管理员属于这个 realm。</p>
<p>
  <img loading="lazy" src="https://cdn.jsdelivr.net/gh/cylonchau/imgbed/img/image-20231219231812810.png" alt="image-20231219231812810"  /></p>
<h2 id="创建-client">创建 client</h2>
<p>Client 是可以请求Keycloak对用户进行身份验证的实体。最常见用途是希望使用Keycloak来保护自己并提供单点登录(SSO)解决方案的应用程序和服务。客户端也可以是只希望请求身份信息或访问令牌的实体，以便它们可以安全地调用由 Keycloak 保护的网络上的其他服务。因此，我们需要为 grafana 创建一个 client</p>
<p>根据 grafana 官方的指南，我们创建标准需如下所示</p>
<ul>
<li>Client ID: <code>grafana-oauth</code></li>
<li>Enabled: <code>ON</code></li>
<li>Client Protocol: <code>openid-connect</code></li>
<li>Access Type: <code>confidential</code></li>
<li>Standard Flow Enabled: <code>ON</code></li>
<li>Implicit Flow Enabled: <code>OFF</code></li>
<li>Direct Access Grants Enabled: <code>ON</code></li>
<li>Root URL: <code>&lt;grafana_root_url&gt;</code></li>
<li>Valid Redirect URIs: <code>&lt;grafana_root_url&gt;/login/generic_oauth</code></li>
<li>Web Origins: <code>&lt;grafana_root_url&gt;</code></li>
<li>Admin URL: <code>&lt;grafana_root_url&gt;</code></li>
<li>Base URL: <code>&lt;grafana_root_url&gt;</code></li>
</ul>
<p>
  <img loading="lazy" src="https://cdn.jsdelivr.net/gh/cylonchau/imgbed/img/image-20231219233419049.png" alt="image-20231219233419049"  /></p>
<center>图：创建一个 grafana-oauth client</center>
<p>
  <img loading="lazy" src="https://cdn.jsdelivr.net/gh/cylonchau/imgbed/img/image-20231219233506788.png" alt="image-20231219233506788"  /></p>
<center>图：配置 capability config</center>
<p>Realm settings =&gt; Client policies =&gt;  Policies</p>
<p>
  <img loading="lazy" src="https://cdn.jsdelivr.net/gh/cylonchau/imgbed/img/image-20231219233643632.png" alt="image-20231219233643632"  /></p>
<center>图：创建 client policy</center>
<p>
  <img loading="lazy" src="https://cdn.jsdelivr.net/gh/cylonchau/imgbed/img/image-20231219233743333.png" alt="image-20231219233743333"  /></p>
<center>图：创建 access type</center>
<h2 id="准备grafana-chart包">准备grafana chart包</h2>
<p>添加 chart repo</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">helm repo add grafana https://grafana.github.io/helm-charts
</span></span></code></pre></td></tr></table>
</div>
</div><p>选择 chart 包下载</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 查看仓库中所有版本</span>
</span></span><span class="line"><span class="cl">helm search repo grafana/grafana -l
</span></span><span class="line"><span class="cl"><span class="c1"># 下载指定版本的chart包</span>
</span></span><span class="line"><span class="cl">helm pull grafana/grafana --version 6.57.4
</span></span></code></pre></td></tr></table>
</div>
</div><p>修改 values.yaml 中 grafana.ini 部分，增加</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="w">   </span><span class="nt">server</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">domain</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ if (and .Values.ingress.enabled .Values.ingress.hosts) }}{{ .Values.ingress.hosts | first }}{{ else }}&#39;&#39;{{ end }}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">server</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c"># The full public facing url you use in browser, used for redirects and emails</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">root_url</span><span class="p">:</span><span class="w"> </span><span class="l">http://10.0.0.4:30033/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">serve_from_sub_path</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">auth</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">signout_redirect_url</span><span class="p">:</span><span class="w"> </span><span class="l">http://10.0.0.5:30043/auth/realms/sso/protocol/openid-connect/logout?post_logout_redirect_uri=http%3A%2F%210.0.0.5:30033%2Flogin</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">auth.generic_oauth</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">grafana-oauth</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">allow_sign_up</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">client_id</span><span class="p">:</span><span class="w"> </span><span class="l">grafana-oauth</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">client_secret</span><span class="p">:</span><span class="w"> </span><span class="l">TF1FjfEfoeBdLa3MfpCjhC1TgChWYyPV</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">scopes</span><span class="p">:</span><span class="w"> </span><span class="l">openid email profile offline_access roles</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">auth_url</span><span class="p">:</span><span class="w"> </span><span class="l">http://10.0.0.5:30043/realms/sso/protocol/openid-connect/auth</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">token_url</span><span class="p">:</span><span class="w"> </span><span class="l">http://10.0.0.5:30043/realms/sso/protocol/openid-connect/token</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">api_url</span><span class="p">:</span><span class="w"> </span><span class="l">http://10.0.0.5:30043/realms/sso/protocol/openid-connect/userinfo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">role_attribute_path</span><span class="p">:</span><span class="w"> </span><span class="l">contains(roles[*], &#39;admin&#39;) &amp;&amp; &#39;Admin&#39; || contains(roles[*], &#39;editor&#39;) &amp;&amp; &#39;Editor&#39; || &#39;Viewer&#39;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>这里主要修改三个部分</p>
<ul>
<li><em>server</em>：
<ul>
<li><em>root_url</em>: 是在使用 keycloak 跳转时，redirect_uri 的地址，默认是 localhost:3000</li>
<li><em>serve_from_sub_path</em>: 从 root_url 设置中指定的子路径提供 Grafana 服务。 出于兼容性原因，默认情况下它设置为 false。</li>
</ul>
</li>
<li><em>auth</em>: 配置登出时请求的 API，这个按照官方给出的配置即可。</li>
<li><em>auth.generic_oauth</em>: keycloak 的配置，这个按照官方给出的配置即可。</li>
</ul>
<h2 id="troubleshooting">troubleshooting</h2>
<h3 id="invalid-redirect-uri">Invalid redirect uri</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Invalid redirect uri for “Valid Redirect URIs
</span></span></code></pre></td></tr></table>
</div>
</div><p>
  <img loading="lazy" src="https://cdn.jsdelivr.net/gh/cylonchau/imgbed/img/image-20231225230735630.png" alt="image-20231225230735630"  /></p>
<center>图：Invalid redirect uri错误</center>
<p>遇到 Invalid redirect uri 错误时，检查 Access settings 配置，并将 grafana 的 <em>auth.generic_oauth</em> 按照下面配置即可</p>
<p>
  <img loading="lazy" src="https://cdn.jsdelivr.net/gh/cylonchau/imgbed/img/image-20231225235825426.png" alt="image-20231225235825426"  /></p>
<p>server 段</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ini" data-lang="ini"><span class="line"><span class="cl">    <span class="k">[server]</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Protocol (http, https, h2, socket)</span>
</span></span><span class="line"><span class="cl">    <span class="na">protocol</span> <span class="o">=</span> <span class="s">http</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># The ip address to bind to, empty will bind to all interfaces</span>
</span></span><span class="line"><span class="cl">    <span class="na">http_addr</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># The http port to use</span>
</span></span><span class="line"><span class="cl">    <span class="na">http_port</span> <span class="o">=</span> <span class="s">3000</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># The public facing domain name used to access grafana from a browser</span>
</span></span><span class="line"><span class="cl">    <span class="na">domain</span> <span class="o">=</span> <span class="s">192.168.64.57</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Redirect to correct domain if host header does not match domain</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Prevents DNS rebinding attacks</span>
</span></span><span class="line"><span class="cl">    <span class="na">enforce_domain</span> <span class="o">=</span> <span class="s">false</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># The full public facing url</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># root_url = %(protocol)s://%(domain)s:%(http_port)s/</span>
</span></span><span class="line"><span class="cl">    <span class="na">root_url</span> <span class="o">=</span> <span class="s">http://192.168.64.57:30606</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Serve Grafana from subpath specified in `root_url` setting. By default it is set to `false` for compatibility reasons.</span>
</span></span><span class="line"><span class="cl">    <span class="na">serve_from_sub_path</span> <span class="o">=</span> <span class="s">false</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Log web requests</span>
</span></span><span class="line"><span class="cl">    <span class="na">router_logging</span> <span class="o">=</span> <span class="s">false</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># the path relative working path</span>
</span></span><span class="line"><span class="cl">    <span class="na">static_root_path</span> <span class="o">=</span> <span class="s">public</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># enable gzip</span>
</span></span><span class="line"><span class="cl">    <span class="na">enable_gzip</span> <span class="o">=</span> <span class="s">false</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># https certs &amp; key file</span>
</span></span><span class="line"><span class="cl">    <span class="na">cert_file</span> <span class="o">=</span><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">    cert_key =</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Unix socket path</span>
</span></span><span class="line"><span class="cl">    <span class="na">socket</span> <span class="o">=</span> <span class="s">/tmp/grafana.sock</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># CDN Url</span>
</span></span><span class="line"><span class="cl">    <span class="na">cdn_url</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Sets the maximum time in minutes before timing out read of an incoming request and closing idle connections.</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># `0` means there is no timeout for reading the request.</span>
</span></span><span class="line"><span class="cl">    <span class="na">read_timeout</span> <span class="o">=</span> <span class="s">0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Generic OAuth 部分</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"> #################################### Generic OAuth #######################
</span></span><span class="line"><span class="cl">    [auth.generic_oauth]
</span></span><span class="line"><span class="cl">    name = OAuth
</span></span><span class="line"><span class="cl">    enabled = true
</span></span><span class="line"><span class="cl">    allow_sign_up = true
</span></span><span class="line"><span class="cl">    client_id = Grafana
</span></span><span class="line"><span class="cl">    client_secret = ad35e16d-96d1-46ab-88d8-7cdb1512b608
</span></span><span class="line"><span class="cl">    scopes = openid profile email
</span></span><span class="line"><span class="cl">    email_attribute_name = email:primary
</span></span><span class="line"><span class="cl">    email_attribute_path =
</span></span><span class="line"><span class="cl">    login_attribute_path =
</span></span><span class="line"><span class="cl">    name_attribute_path =
</span></span><span class="line"><span class="cl">    role_attribute_path =
</span></span><span class="line"><span class="cl">    id_token_attribute_name =
</span></span><span class="line"><span class="cl">    auth_url = http://192.168.64.57:30708/auth/realms/devops/protocol/openid-connect/auth
</span></span><span class="line"><span class="cl">    token_url = http://192.168.64.57:30708/auth/realms/devops/protocol/openid-connect/token
</span></span><span class="line"><span class="cl">    api_url = http://192.168.64.57:30708/auth/realms/devops/protocol/openid-connect/userinfo
</span></span><span class="line"><span class="cl">    allowed_domains =
</span></span><span class="line"><span class="cl">    team_ids =
</span></span><span class="line"><span class="cl">    allowed_organizations =
</span></span><span class="line"><span class="cl">    tls_skip_verify_insecure = false
</span></span><span class="line"><span class="cl">    tls_client_cert =
</span></span><span class="line"><span class="cl">    tls_client_key =
</span></span><span class="line"><span class="cl">    tls_client_ca =
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="loginoauthloginstate-mismatch">login.OAuthLogin(state mismatch)</h3>
<p>
  <img loading="lazy" src="https://cdn.jsdelivr.net/gh/cylonchau/imgbed/img/image-20231226000413815.png" alt="image-20231226000413815"  /></p>
<center>图：登录后错误</center>
<p>这个错误是没有配置对应user的状态或者没有配置email导致，如果配置了 email，那么吧用户放置到对应组中就恢复了</p>
<p>
  <img loading="lazy" src="https://cdn.jsdelivr.net/gh/cylonchau/imgbed/img/image-20231226000619866.png" alt="image-20231226000619866"  /></p>
<center>图：用户与组</center>
<h3 id="配置权限">配置权限</h3>
<p>如果使用了 <em>role</em> 作为权限分配，那么按照官方的配置即可，如果使用 <em>group</em>，则需要使用下面的规则</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ini" data-lang="ini"><span class="line"><span class="cl"><span class="na">role_attribute_path</span> <span class="o">=</span> <span class="s">contains(groups[], &#39;admin&#39;) &amp;&amp; &#39;Admin&#39; || contains(groups[], &#39;editer&#39;) &amp;&amp; &#39;Editor&#39; || contains(groups[*], &#39;viewer&#39;) &amp;&amp; &#39;Viewer&#39; </span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这个表达式是一个条件表达式，用于根据用户所属的组分配角色属性值。下面是对每个字符和子表达式的翻译解释：</p>
<ul>
<li><em>role_attribute_path</em> : 角色属性路径，表示根据条件表达式的结果来确定角色属性值。</li>
<li><code>contains(groups[*], 'admin')</code>: 检查用户所属的组列表中是否包含 <em>admin</em> 组。</li>
<li><em>&amp;&amp;</em>: 逻辑与运算符，用于组合多个条件，表示两个条件都为真时整个表达式为真。</li>
<li>Admin:  如果 <code>contains(groups[*], 'admin')</code> 为真，将角色属性设置为 <em>Admin</em>。</li>
<li><code>||</code>: 逻辑或运算符，用于组合多个条件，表示任意一个条件为真时整个表达式为真。</li>
<li><code>contains(groups[*], 'editer')</code>: 检查用户所属的组列表中是否包含 <em>editer</em> 组。</li>
<li><code>'Editor'</code>: 如果 <code>contains(groups[*], 'editer')</code> 为真，将角色属性设置为 <em>Editor</em>。</li>
<li><code>contains(groups[*], 'viewer')</code>: 检查用户所属的组列表中是否包含 <em>viewer</em> 组。</li>
<li><code>'Viewer'</code>: 如果 <code>contains(groups[*], 'viewer')</code> 为真，将角色属性设置为 <em>Viewer</em>。</li>
</ul>
<h2 id="reference">Reference</h2>
<p><sup id="1">[1]</sup> <a href="https://github.com/cetic/helm-fadi/issues/39">keycloak redirect_uri is always localhost:3000 #39</a></p>
<p><sup id="2">[2]</sup> <a href="https://github.com/cetic/helm-fadi/commit/aff8f55a98c1b125a6933abc8a5801a70628d628#diff-e03be4b117ea0d0d183a8c866fe1d63dfd164e3addc99d1d7b025f7e750755d4">templates/keycloak.yaml</a></p>
<p><sup id="3">[3]</sup> <a href="https://grafana.com/docs/grafana/latest/setup-grafana/configure-security/configure-authentication/keycloak/">Configure Keycloak OAuth2 authentication</a></p>
]]></content:encoded>
    </item>
    
    <item>
      <title>在 Kubernetes 集群中使用 blackbox exporter监控外部IP</title>
      <link>https://www.oomkill.com/2023/07/blackbox_exporter-in-k8s/</link>
      <pubDate>Wed, 12 Jul 2023 00:00:00 +0000</pubDate>
      
      <guid>https://www.oomkill.com/2023/07/blackbox_exporter-in-k8s/</guid>
      <description></description>
      <content:encoded><![CDATA[<h2 id="背景">背景</h2>
<p>在云原生环境中，特别是基于 Kubernetes，集群中的 “服务” 在与外部交互时，例如，一个外部的第三方 Web 服务/API 等，而监控这些不同的 endpoint 诊断服务可用性的一个关键点，这里将阐述基于 Kube-prometheus-stacks 如果做到可以监控外部 IP/URL，例如，HTTP/TCP/ICMP 等。</p>
<p>blackbox_exporter 是 Prometheus 官方维护的 exporter之一，是提供一种用于检测 HTTP/S、DNS、TCP 和 ICMP 端点的可用性。</p>
<h2 id="基于-kube-prometheus-stack-安装-blackbox">基于 kube-prometheus-stack 安装 blackbox</h2>
<p>本文使用了 helm 安装的 <a href="https://github.com/prometheus-community/helm-charts/tree/main/charts/prometheus-blackbox-exporter">prometheus-community/prometheus-blackbox-exporter </a>，在安装前，需要自行修改要启动的 prober，与是否开启默认的 <em>servicemonitor</em></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">secretConfig</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">config</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">modules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ping</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">prober</span><span class="p">:</span><span class="w"> </span><span class="l">icmp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">timeout</span><span class="p">:</span><span class="w"> </span><span class="l">5s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">icmp</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">preferred_ip_protocol</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;ip4&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">http_2xx</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">prober</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">timeout</span><span class="p">:</span><span class="w"> </span><span class="l">5s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">http</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">valid_http_versions</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;HTTP/1.1&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;HTTP/2.0&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">follow_redirects</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">preferred_ip_protocol</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;ip4&#34;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>安装</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">helm install prometheus-blackbox-exporter -n monitoring . -f values.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="配置-servicemonitor">配置 servicemonitor</h2>
<p>blackbox-exporter 实现了多种探针，因此可以传递多个 endpoint 进行探测，下列是 <code>ServiceMonitor</code> 实现的检测外部IP/URL，使用了 icmp 探针，也就是说是在 blackbox-exporter 中配置的模块，探针通过抓取 Kubernetes service 下挂的 endpoint，通过访问 blackbox service 的 <code>/probe</code> 抓取暴露的指标 metrics</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">monitoring.coreos.com/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceMonitor</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">blackbox-exporter-probe</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">endpoints</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="l">1m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/probe</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">scrapeTimeout</span><span class="p">:</span><span class="w"> </span><span class="l">10s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">params</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">module</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">tcp_prober]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">relabelings</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">sourceLabels</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">__address__]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">targetLabel</span><span class="p">:</span><span class="w"> </span><span class="l">__param_target</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">targetLabel</span><span class="p">:</span><span class="w"> </span><span class="l">__address__</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">replacement</span><span class="p">:</span><span class="w">  </span><span class="l">black-prometheus-blackbox-exporter:9115</span><span class="w"> </span><span class="c"># is the name:port of the blackbox exporter service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">sourceLabels</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">__param_target]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">targetLabel</span><span class="p">:</span><span class="w"> </span><span class="l">instance</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">labelmap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">regex</span><span class="p">:</span><span class="w"> </span><span class="l">__meta_kubernetes_service_label_(.+)</span><span class="w"> </span><span class="c"># specify to monitor kubernets services</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">jobLabel</span><span class="p">:</span><span class="w"> </span><span class="l">blackbox-exporter</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app.kubernetes.io/action</span><span class="p">:</span><span class="w"> </span><span class="l">probe</span><span class="w"> </span><span class="c"># monitor the services only with this label</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>这个 ServiceMonitor 会通过标签匹配对应的 Kubernets service，标签为  <code>app.kubernetes.io/action: probe</code>所有 namespace 中的存在 这个 Label 的 service。  如果有需要，可以通过指定抓取的 namespace，使用<code>namespaceSelector</code></p>
<h3 id="创建一个外部-service">创建一个外部 service</h3>
<p>这里使用了 Kubernetes 外部 service 方式将外部IP引入到内部</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app.kubernetes.io/action</span><span class="p">:</span><span class="w"> </span><span class="l">probe</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">icmp-prober</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">clusterIP</span><span class="p">:</span><span class="w"> </span><span class="l">None</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">db</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">9100</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">9100</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Endpoints</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app.kubernetes.io/action</span><span class="p">:</span><span class="w"> </span><span class="l">probe</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">rahasak</span><span class="w"> </span><span class="c"># name is same as service name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">subsets</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">addresses</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">ip</span><span class="p">:</span><span class="w"> </span><span class="m">10.0.0.4</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">ip</span><span class="p">:</span><span class="w"> </span><span class="m">10.0.0.5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">db</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">9100</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="创建-servicemonitor">创建 servicemonitor</h3>
<p>创建一个 ServiceMonitor 来探测每个 endpoint，使用了 icmp 探针来抓取 带有标签 <code>app.kubernetes.io/action: probe</code> 的Kubernets service</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">monitoring.coreos.com/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceMonitor</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">blackbox-exporter</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">endpoints</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="l">1m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/probe</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">scrapeTimeout</span><span class="p">:</span><span class="w"> </span><span class="l">10s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">params</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">module</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">ping]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">relabelings</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">sourceLabels</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">__address__]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">targetLabel</span><span class="p">:</span><span class="w"> </span><span class="l">__param_target</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">targetLabel</span><span class="p">:</span><span class="w"> </span><span class="l">__address__</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># blackbox_service_name.namespace:port</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">replacement</span><span class="p">:</span><span class="w">  </span><span class="l">prometheus-blackbox-prometheus-blackbox-exporter:9115</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">sourceLabels</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">__param_target]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">targetLabel</span><span class="p">:</span><span class="w"> </span><span class="l">instance</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">labelmap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">regex</span><span class="p">:</span><span class="w"> </span><span class="l">__meta_kubernetes_endpoints_label_(.+)</span><span class="w"> </span><span class="c"># specify to monitor kubernetes endpoints </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">jobLabel</span><span class="p">:</span><span class="w"> </span><span class="l">blackbox-exporter</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app.kubernetes.io/action</span><span class="p">:</span><span class="w"> </span><span class="l">probe</span><span class="w"> </span><span class="c"># monitor endpoints only with the given label</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="notes">Notes</h2>
<p>blackbox_exporter 如果想要使用 icmp 探针，必须拥有 root 权限，直接修改 <code>runAsGroup: 0</code> 即可</p>
<p>对于 直接使用 servicemonitor 中的 endpoint 只能识别出一个 IP，原因是，balckbox 暴漏的指标需要带参数访问，下列格式</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="s2">&#34;http://10.104.202.8:9115/probe?module=ping&amp;target=10.0.0.5&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>而传入多个 target 没有用，只会返回第一个 target 的指标，所以说会出现多个 endpoint 只会出现一个，同样的问题，如果 service 设置为 ClusterIP，也会只有一个指标，必须 <code>type: None</code> 才可以，这就是只有多个 endpoint 才会在拉去指标时请求多个 balckbox exporter 的 API</p>
<p>
  <img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20230713005706664.png" alt="image-20230713005706664"  /></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">monitoring.coreos.com/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceMonitor</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">blackbox-probe-tcp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">release</span><span class="p">:</span><span class="w"> </span><span class="l">kube-prometheus-stacks</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">endpoints</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/probe</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="l">5s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">scrapeTimeout</span><span class="p">:</span><span class="w"> </span><span class="l">5s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">params</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">module</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">ping</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">target</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="m">10.0.0.4</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="m">10.0.0.5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">relabelings</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">replace</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">regex</span><span class="p">:</span><span class="w"> </span><span class="l">(.*)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">replacement</span><span class="p">:</span><span class="w"> </span><span class="l">$1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">sourceLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">__meta_kubernetes_service_label_cluster</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">targetLabel</span><span class="p">:</span><span class="w"> </span><span class="l">cluster</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">replace</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">regex</span><span class="p">:</span><span class="w"> </span><span class="l">(.*)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">replacement</span><span class="p">:</span><span class="w"> </span><span class="l">$1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">sourceLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">__param_module</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">targetLabel</span><span class="p">:</span><span class="w"> </span><span class="l">module</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">labelmap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">regex</span><span class="p">:</span><span class="w"> </span><span class="l">(.*)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">replacement</span><span class="p">:</span><span class="w"> </span><span class="l">$1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">sourceLabels</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">__param_target]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">targetLabel</span><span class="p">:</span><span class="w"> </span><span class="l">__address__</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app.kubernetes.io/instance</span><span class="p">:</span><span class="w"> </span><span class="l">prometheus-blackbox</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>目前暂未找到有效的解决方法，但是在清单配置多个 endpoint 就出现多条 serivcemonitor 记录，持续更进该问题，可能可以通过 <code>additionalScrapeConfigs</code> 可以解决该问题</p>
<h2 id="reference">Reference</h2>
<blockquote>
<p><sup id="1">[1]</sup> <a href="https://medium.com/@lambdaEranga/monitor-kubernets-services-endpoints-with-prometheus-blackbox-exporter-a64e062c05d5">Monitor Kubernets Services/Endpoints with Prometheus Blackbox Exporter</a></p>
<p><sup id="2">[2] </sup><a href="https://www.voidking.com/dev-prometheus-operator-blackbox-exporter/">Prometheus Operator + Blackbox exporter</a></p>
</blockquote>
]]></content:encoded>
    </item>
    
    <item>
      <title>使用Thanos强化Prometheus</title>
      <link>https://www.oomkill.com/2023/07/using-thanos-improve-prometheus.md/</link>
      <pubDate>Sun, 02 Jul 2023 00:00:00 +0000</pubDate>
      
      <guid>https://www.oomkill.com/2023/07/using-thanos-improve-prometheus.md/</guid>
      <description></description>
      <content:encoded><![CDATA[<h2 id="背景">背景</h2>
<p>Prometheus 是目前云原生架构中监控解决方案中的基石，而对于 “metrics”，“traces” 和 “logs” 是组成云原生架构中“可观测性”的一个基础，当在扩展 Prometheus，那么 Prometheus 提供的基础架构是无法满足需求的（高可用性和可扩展性）， 而高可用性与可扩展性是满足不断增长基础设施的一个基本条件。而 Prometheus 本身并没有提供“弹性”的集群配置，也就是说，多个副本的 Prometheus 实例，对于分布在每个 Pod 上的数据也会不一致，这时也需要保证指标的归档问题。</p>
<p>并且在一定的集群规模下，问题的出现远远大于 Prometheus 本身的能力，例如：</p>
<ul>
<li>如何经济且搞笑的存储历史数据（TB, PB）？如何快速的查询历史数据？</li>
<li>如何合并 Promehtues 多个实例收集来的副本数据？</li>
<li>以及多集群间的监控？</li>
<li>由于 TSDB 的块同步，Prometheus 严重依赖内存，使得 Prometheus 监控项的扩展将导致集群中的CPU/MEM 的使用加大</li>
<li>..</li>
</ul>
<h2 id="解决">解决</h2>
<p>Thanos 是一款可以使 Prometheus 获得 ”长期存储“，并具体有”高可用性“ 的 Prometheus 的功能扩展，“Thanos” 源自希腊语“ Athanasios”，英文意思是”不朽“。这也正是 ”Thanos“ 提供的功能：”无限制的对象存储“，并与原生 Prometheus API 高度兼容，你可以理解为 Thanos API 就是 Prometheus API。</p>
<p>Cortexmetrics 与 Thanos 类似，是用通过将 Prometheus 实例的”存储“和”查询“等功能分离到独立的组件中，实现水平扩展。它使用对象存储来持久化历史指标，块存储（TSDB）是他的存储后端；此外，Cortex 还提供了多租户与多租户隔离等功能</p>
<p>联邦集群，联邦集群是 Prometheus 官方提供的一个概念，使用了联邦将允许 Prometheus 从另一个 Prometheus 中抓取选定的指标。可以使用的一些模型如下：</p>
<ul>
<li>分层联邦：大规模的集群中，Prometheus 部署模型如一个”树形“，高级别的从多个低级实例中抓取指标，并存储聚合</li>
<li>跨服务联邦：Prometheus 从另一个 Prometheus 只抓取指定的数据</li>
</ul>
<p>
  <img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/t3.png" alt="prometheus 联邦"  /></p>
<center>图：Prometheus 联邦</center>
<center><em>Source：</em>https://www.improbable.io/blog/thanos-prometheus-at-scale</center><br>
<p>但在这种架构中，仍然还是每个查询只能针对单个 Prometheus 服务器完成。另外 Thanos 可以查询与聚合来自多个 Prometheus 实例的数据，这些数据就类似与联邦中的 ”叶“，这些数据的来源可以单实例也可以是多实例。</p>
<p>在这种架构中，本质上并不是 ”高可用性“ 的，实际上存在潜在故障点，并且数据的查询是通过唯一入口（API）进行查询，并且需要配置复杂的抓取规则才可以使规则不重复。</p>
<h2 id="thanos-架构">Thanos 架构</h2>
<p>Thanos 遵循了 KISS (<em><strong>Keep it simple</strong></em>) 原则，thanos 由多个组件组成，每个组件负责不同的功能，</p>
<p>在与 Prometheus 交互方向，Thanos 使用下列两种方式（组件）：</p>
<ul>
<li>
<p>Sidecar：</p>
<ul>
<li>连接到 Prometheus，读取数据或者将数据上传到对象存储中</li>
<li>也可以部署为传统架构，这里不能完全理解为是 Kubernetes 中的 Sidecar</li>
</ul>
</li>
<li>
<p>Receiver：从 Prometheus 接收数据，暴露或上传到云端</p>
</li>
</ul>
<p>扩展 Prometheus 的功能：</p>
<ul>
<li>
<p>Store/Store Gateway：提供存储在对象存储中的历史数据的查询功能，历史 Chunk 会存储在对象存储中</p>
<ul>
<li>支持基于 “时间/标签” 的分区</li>
</ul>
</li>
<li>
<p>Compactor：对于存储在对象存储中的数据进行压缩，通过将其合并为更大的快，以便提高查询效率</p>
</li>
<li>
<p>Ruler/Rule：类似与 Alertmanager 的功能，他提供了告警功能</p>
</li>
<li>
<p>Querier/Query：实现了 Prometheus API，他可以从 Sidecar 与 对象存储中查询全局查询</p>
</li>
<li>
<p>Query Frontend：实现了 Prometheus API 并将请求代理至 Query 组件；并且支持缓存功能（Redis/Memcached），缓存其查询结果</p>
</li>
</ul>
<blockquote>
<p>Thanos 不是一种 “节省指标存储” 的方案，而是一种提供更大时间间隔，更高可用性的的查询方案，使用Thanos 不会减少磁盘空间，反而会增加磁盘空间。</p>
</blockquote>
<p>通常 Thanos 会按照维度划分为三个级别：raw, 5m, 1h，这是根据时间划分，raw 是从 Prometheus 拿到的原始数据; 5m 压缩为5分钟的快；1h 压缩为 1h的块  <sup><a href="#1">[1]</a></sup> 。不过这些没有在官方找到，引用的其他文章</p>
<h3 id="指标的查询过程">指标的查询过程</h3>
<ol>
<li>PromQL 查询请求到组件 <code>Querier</code></li>
<li>它解释查询并进入预过滤器</li>
<li>查询根据标签和时间范围要求 扇出 (fan-out) 其对 <code>stores</code> 或 <code>prometheuses</code> 的请求
<ol>
<li>store 决定 是否从s3中拉去数据</li>
<li>query 会缓存数据到内存中</li>
</ol>
</li>
<li>Query 发送和接收请求</li>
<li>收集所有响应后，如果启用合并功能，会合并并删除重复数据</li>
<li>最后返回该时间序列</li>
</ol>
<p>
  <img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/life_of_a_query.png" alt="查询的生命周期"  /></p>
<center>图：Thanos查询生命周期</center>
<center><em>Source：</em>https://banzaicloud.com/blog/multi-cluster-monitoring/</center><br>
<h3 id="基于时间的分片">基于时间的分片</h3>
<p>默认 Thanos 的 Store gateway 会查询对象中的所有存储，根据查询时间返回数据，这显然不行，如果此时有大量数据（基于PB级别），此时可以根据时间分片（水平扩展），Store API 可以使用 最大时间 和 最小时间 来缩短查询的时间，</p>
<h3 id="基于标签的分片">基于标签的分片</h3>
<p>基于标签的分片与基于时间的分片类似，这里是使用<code>labels</code>，而 Label 是采集与 Prometheus 的外部 Label ，并基于 Thanos 组件显式重新标记，要记住，Thanos 就是 Prometheus 扩展，功能用法与 Prometheus 是相同的的，例如下列 Thanos relabeling 的操作</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl">- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">keep</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">regex</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;eu.*&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">source_labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">region</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>这些表示了只保留了以 <code>eu.*</code> 开头的 region label</p>
<h3 id="重复副本的删除">重复副本的删除</h3>
<p>Thanos 对于 Prometheus 的 HA，也就是采集多个 Prometheus 实例的指标，此时 每个实例会产生相同的指标，这种模式来实现的“高可用性”，那么这种架构产生的重复副本就需要 Thanos 来处理了，例如如下所示：<code>up{job=&quot;prometheus&quot;,env=&quot;2&quot;}</code> 的指标， 通过重复数据删除，结果是：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">up{job=&#34;prometheus&#34;,env=&#34;2&#34;,cluster=&#34;1&#34;} 1
</span></span><span class="line"><span class="cl">up{job=&#34;prometheus&#34;,env=&#34;2&#34;,cluster=&#34;2&#34;} 1
</span></span></code></pre></td></tr></table>
</div>
</div><p>那么如果不删除重复标签，可能结果就很多，是用过 replica 标签来区分副本数量</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">up{job=&#34;prometheus&#34;,env=&#34;2&#34;,cluster=&#34;1&#34;,replica=&#34;A&#34;} 1
</span></span><span class="line"><span class="cl">up{job=&#34;prometheus&#34;,env=&#34;2&#34;,cluster=&#34;1&#34;,replica=&#34;B&#34;} 1
</span></span><span class="line"><span class="cl">up{job=&#34;prometheus&#34;,env=&#34;2&#34;,cluster=&#34;2&#34;,replica=&#34;A&#34;} 1
</span></span><span class="line"><span class="cl">up{job=&#34;prometheus&#34;,env=&#34;2&#34;,cluster=&#34;2&#34;,replica=&#34;B&#34;} 1
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="全局视图查询">全局视图查询</h3>
<p>如图所示，query 是一种无状态的可水平扩展的 Querier 组件，他提供了基于 Prometheus API ，可以相应基于 PromQL 的查询，而中间数据的相应是由 Store 或者</p>
<p>
  <img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/t5.jpg" alt="sidecar"  /></p>
<center>图：Thanos query组件</center>
<center><em>Source：</em>https://banzaicloud.com/blog/multi-cluster-monitoring/</center><br>
<h2 id="高基数">高基数</h2>
<p>基数 (<em><strong>cardinality</strong></em>) 通俗来说是一个集合中的元素数量 <sup><a href="#1">[1]</a></sup> 基数的来源通常为：</p>
<ul>
<li>label 的数量</li>
<li>series(指标) 的数量</li>
<li>时间：label 或者 series 随时间而流失或增加，通常是增加</li>
</ul>
<p>那么这么看来高基数就是，label, series, 时间这三个集合的笛卡尔积，那么高基数的情况就很正常了。</p>
<p>而高基数带来的则是 Prometheus 资源使用，以及监控的性能。下图是 Grafana Lab 提到的一张图，很好的阐述了高基数这个问题</p>
<p>
  <img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/cardinality-spikes-diagram.jpg" alt="image-20220704002227865"  /></p>
<center>图：Prometheus中的基数</center>
<center><em>Source：</em>https://grafana.com/blog/2022/02/15/what-are-cardinality-spikes-and-why-do-they-matter</center><br>
<p>如图所示：一个指标 <em>server_responses</em> 他的 label 存在两个 <code>status_code</code> 与 <code>environment</code> ，这代表了一个集合，那他的 label value 是 1~5xx，这个指标的笛卡尔积就是10。</p>
<p>那么此时存在一个问题，如何能定位 基数高不高，Grafana Lab 给出了下面的数据 <sup><a href="#1">[1]</a></sup>，但是我不清楚具体的来源或者如何得到的这些值。也就是 <code>label:value</code></p>
<ul>
<li>低基数：1: 5</li>
<li>标准基数：1: 80</li>
<li>高基数：1: 10000</li>
</ul>
<h3 id="为什么指标会指数级增长">为什么指标会指数级增长</h3>
<p>在以 Kubernetes 为基础的架构中，随着抽象级别的提高（通常为Pod, Label, 以及更多抽象的拓扑），指标的时间序列也越来越多。因为在这种基础架构中，在传统架构中运行的一个应用的单个裸机，被许多运行分散在许多不同节点上的许多不同微服务的 Pod 所取代。在这些抽象层中的每一个都需要一个标签，以便可以唯一地标识它们，并且这些组件中的每一个都会生成自己的指标，从而创建其独特的时间序列集。</p>
<p>此外，在 Kubernetes 中的工作负载的短暂性最终也会创建更多的时间序列。例如 JAVA的 <code>http_request_duration_seconds_bucket</code> 指标，它会每次 pod 更改状态时生成一个新的时间序列，比如从“状态200&quot; 或者 “状态 404” 在到 “每个URL” 再到 “每个请求的时间”，这样大量短时间请求，对一个 Pod 状态可能会生成大量指标。</p>
<p>这是就要考虑到 Prometheus 兼容的格式，而非传统监控的监控指标的格式问题，就例如上面的例子，通过对 URI，请求时长，请求状态码几个维度去监控，那么此时的 exporter 导出的数据势必是非常杂乱的，而这种可能相同的指标就会放大到无穷。</p>
<p>在这种环境中的 Label，就是两组集合的笛卡尔积的选择，就是次优标签 <code>sub-optimal labels</code> ，对付这类高基数的指标，控制基数，以及如何避免使用这类错误，就是解决高基数的根本。</p>
<h3 id="高基数是一个非常重要的问题">高基数是一个非常重要的问题</h3>
<p>高基数的问题，带来的就是基于 Prometheus 的监控带来的是更多的可观测性，反之，随着时间序列的基数增加，那么为了维持某几个特别的指标的观测性，就必须要付出更多的硬件资源，以及影响本身监控系统的性能。比较明显的表现，就是监控的相应下降，极大的拖慢了整个系统的运行速度（包含仪表盘，promQL等）。还会延长系统故障排除时的MTTR (<em>Mean Time to Repair</em>)。</p>
<blockquote>
<p>Notes: 其实这里还有一类型错误，就是这会导致时间序列的乱序，怎么说呢，就是当指标无线放大时，在某一个点 scrap 的指标存储时间，大于了抓取周期，导致新指标存储早于旧指标，这种很容易出现在例如 Prometheus 的从内存到存储的那个点。</p>
</blockquote>
<h3 id="如何控制控制指标的高基数增长">如何控制控制指标的高基数增长</h3>
<p>指标的无序扩张（高基数）是不可避免对监控系统产生非常大的影响（存储和性能），而为此引出了一个如何优化不断增长的指标就是控制高基数增长的关键部分，下面将从几个维度来阐释控制“高基数”问题的步骤</p>
<h4 id="第一步高基数指标是否有价值">第一步：高基数指标是否有价值？</h4>
<p>在任何优化方法的第一步都是去了解哪些指标给系统带来负面影响（这里指高基数），并且还需要确定这些指标中哪些指标是有价值的；所谓的有价值既，在仪表板、告警中是否有被使用。</p>
<p>基于这些信息，我将根据基数问题与监控指标的价值分为四个象限：</p>
<ul>
<li>高价值，低成本：闲置、陈旧、很长时间没有新数据的</li>
<li>低价值，低成本：基本上没有什么影响，但是需要去考虑优化</li>
<li>低价值，高成本：可以考虑删除掉 Label 和 metric</li>
<li>高价值，高成本：你的指标是否过细化，是否需要重新设计 Label 或者聚合数据；或这类指标是否适合使用 Prometheus 这类时间序列</li>
</ul>
<h4 id="第二步如何确定高基数指标">第二步：如何确定高基数指标</h4>
<p>确定高基数指标包含3种方式</p>
<ul>
<li>Prometheus WEB UI 分析，2.14 版本之后</li>
<li>PromQL 分析</li>
<li>Prometheus API 分析</li>
</ul>
<p>通常情况下，WEB UI 就可以满足需求了，通过路径 Prometheus UI -&gt; Status -&gt; TSDB Status -&gt; Head Cardinality Stats。</p>
<p>
  <img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20230617175638751.png" alt="image-20230617175638751"  /></p>
<center>图：Prometheus WEB UI TOP 10 series</center>
<p>由上图可见，在这里体现的高基数问题的指标，通常都是以 <em>bucket</em> 结尾的指标，而这些指标通常包含2个维度，会无线拉长成为高基数指标。如下面指标所示，通常由 le （标识每个 bucket 的上限，这可以确保可以定位到在一个时间范围内相应的请求指标有哪些）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">apiserver_request_duration_seconds_bucket{component=&#34;apiserver&#34;, endpoint=&#34;https&#34;, group=&#34;admissionregistration.k8s.io&#34;, instance=&#34;10.0.0.4:6443&#34;, job=&#34;apiserver&#34;, le=&#34;+Inf&#34;, namespace=&#34;default&#34;, resource=&#34;mutatingwebhookconfigurations&#34;, scope=&#34;cluster&#34;, service=&#34;kubernetes&#34;, verb=&#34;DELETE&#34;, version=&#34;v1&#34;}	19
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">apiserver_request_duration_seconds_bucket{component=&#34;apiserver&#34;, endpoint=&#34;https&#34;, group=&#34;admissionregistration.k8s.io&#34;, instance=&#34;10.0.0.4:6443&#34;, job=&#34;apiserver&#34;, le=&#34;0.05&#34;, namespace=&#34;default&#34;, resource=&#34;mutatingwebhookconfigurations&#34;, scope=&#34;cluster&#34;, service=&#34;kubernetes&#34;, verb=&#34;POST&#34;, version=&#34;v1&#34;}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">apiserver_request_duration_seconds_bucket{component=&#34;apiserver&#34;, endpoint=&#34;https&#34;, group=&#34;admissionregistration.k8s.io&#34;, instance=&#34;10.0.0.4:6443&#34;, job=&#34;apiserver&#34;, le=&#34;0.25&#34;, namespace=&#34;default&#34;, resource=&#34;mutatingwebhookconfigurations&#34;, scope=&#34;cluster&#34;, service=&#34;kubernetes&#34;, verb=&#34;PATCH&#34;, version=&#34;v1&#34;}
</span></span></code></pre></td></tr></table>
</div>
</div><p>例如下面是生产环境中的一个高基数TOP10</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Count</th>
</tr>
</thead>
<tbody>
<tr>
<td>http_server_requests_seconds_bucket</td>
<td>2017537</td>
</tr>
<tr>
<td>lettuce_command_firstreponse_seconds_bucket</td>
<td>755056</td>
</tr>
<tr>
<td>lettuce_command_completion_seconds_bucket</td>
<td>755056</td>
</tr>
<tr>
<td>http_server_requests_seconds</td>
<td>555575</td>
</tr>
<tr>
<td>nginx_ingress_controller_request_duration_seconds_bucket</td>
<td>475440</td>
</tr>
<tr>
<td>node_ipvs_backend_connections_inactive</td>
<td>148796</td>
</tr>
<tr>
<td>node_ipvs_backend_connections_active</td>
<td>148796</td>
</tr>
<tr>
<td>apiserver_request_duration_seconds_bucket</td>
<td>27896</td>
</tr>
<tr>
<td>etcd_request_duration_seconds_bucket1</td>
<td>22763</td>
</tr>
</tbody>
</table>
<p>至此可以看到实际上 <code>http_server_requests_seconds_bucket</code> 这一个指标占据了 prometheus 总指标的50%+</p>
<p>而其他的一些分析，可以很有效的定位到你需要优化的标签</p>
<ul>
<li>Top 10 label names with high memory usage</li>
<li>Top 10 series count by label value pairs</li>
</ul>
<h4 id="通过-promql-定位-job">通过 promQL 定位 job</h4>
<ul>
<li>查询 top 10 的 series <code>topk(10, count by (__name__)({__name__=~&quot;.+&quot;}))</code></li>
<li><code>sum(scrape_series_added) by (job)</code> 通过 job Label 分析 series 增长</li>
<li><code>sum(scrape_samples_scraped) by (job)</code>  通过 job Label 分析 series 总量</li>
</ul>
<p>可以通过指标属于哪个 job</p>
<h4 id="第三步发现那些指标没有在使用">第三步：发现那些指标没有在使用</h4>
<p>Grafana Mimirtool 是一个开源的命令行工具， 它可以识别 Mimir、Prometheus 或 Prometheus 的存储中未在Dashboard、Alert 或 recording 中使用的指标。通过 Mimirtool 可以快速发现未使用的指标，并且做出操作</p>
<h2 id="优化监控指标">优化监控指标</h2>
<p>优化监控指标来解决高基数问题主要从以下维度进行</p>
<h3 id="增加采集间隔"><strong>增加采集间隔</strong></h3>
<p>Prometheus 的默认值为 <code>scrape_interval: 15s</code>，或 DPM (<em>Data points  Per minute</em>) 4个，但是如果查询语句为 <code>scrape_samples_scraped[1m]</code> 那么可以考虑将这个 job 的 <code>scrape_interval</code> 增加为1m，这样15~60 可以减少近75%的存储成本。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kube-state-metrics:
</span></span><span class="line"><span class="cl">  namespaceOverride: <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">  rbac:
</span></span><span class="line"><span class="cl">    create: <span class="nb">true</span>
</span></span><span class="line"><span class="cl">  releaseLabel: <span class="nb">true</span>
</span></span><span class="line"><span class="cl">  prometheus:
</span></span><span class="line"><span class="cl">    monitor:
</span></span><span class="line"><span class="cl">      enabled: <span class="nb">true</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">## Scrape interval. If not set, the Prometheus default scrape interval is used.</span>
</span></span><span class="line"><span class="cl">      <span class="c1">##</span>
</span></span><span class="line"><span class="cl">      interval: <span class="s2">&#34;&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="优化-histogram">优化 histogram</h2>
<p>histrogram 是 Prometheus中一种更具有更复杂类型的监控指标，通常用于决定数据的精度，典型的例子就是上面提到的 <code>http_server_requests_seconds_bucket</code> 中的 <code>le</code> ，此时假设 le 代表请求毫秒，那么我们只需要决定你所需要的精度是哪些？例如，如果仅仅需要 1ms, 5ms, 10ms，那么指标 le 标签就控制为3，这样结合 URI 指标，那么这个 histogram 是有限的</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># drop all metric series ending with _bucket and where le=&#34;0.1xxx&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">source_labels</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">__name__, le]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">separator</span><span class="p">:</span><span class="w"> </span><span class="l">_</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">regex</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;.+_bucket_(0.1+)&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;drop&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># Object labels:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">__name__</span><span class="p">:</span><span class="w"> </span><span class="l">http_server_requests_seconds_bucket</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">le</span><span class="p">:</span><span class="w"> </span><span class="m">0.114421</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>这里可以通过 <a href="https://relabeler.promlabs.com/">promlabs</a> 来测试你的规则是否是成功的 <sup><a href="#2">[2]</a></sup></p>
<h3 id="删除不需要的标签">删除不需要的标签</h3>
<p>对于一些指标，删除了未使用的标签后，反而会使这个指标变得没有意义，并且使这个指标变得序列重复，这个时候可以完整删除这个指标</p>
<p>例如在下面的示例中，第一个示例可以安全地删除 ip 标签，因为其余系列都是唯一的。但在第二个示例中，如果删除 ip 标签将产生重复的时间序列，Prometheus 将删除这些时间序列。<code>my_metric_total</code>在此示例中，Prometheus 将接收具有相同时间戳的值 1、3 和 7，并将丢弃其中的 2 个数据点。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># You can drop ip label, remaining series are still unique
</span></span><span class="line"><span class="cl">my_metric_total{env=“dev”, ip=“1.1.1.1&#34;} 12
</span></span><span class="line"><span class="cl">my_metric_total{env=“tst”, ip=“1.1.1.1&#34;} 14
</span></span><span class="line"><span class="cl">my_metric_total{env=“prd”, ip=“1.1.1.1&#34;} 18
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#Remaining values after dropping ip label
</span></span><span class="line"><span class="cl">my_metric_total{env=“dev”} 12
</span></span><span class="line"><span class="cl">my_metric_total{env=“tst”} 14
</span></span><span class="line"><span class="cl">my_metric_total{env=“prd”} 18
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># You can not drop ip label, remaining series are not unique
</span></span><span class="line"><span class="cl">my_metric_total{env=“dev”, ip=“1.1.1.1&#34;} 1
</span></span><span class="line"><span class="cl">my_metric_total{env=“dev”, ip=“3.3.3.3&#34;} 3
</span></span><span class="line"><span class="cl">my_metric_total{env=“dev”, ip=“5.5.5.5&#34;} 7
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#Remaining values after dropping ip label are not unique
</span></span><span class="line"><span class="cl">my_metric_total{env=“dev”} 1
</span></span><span class="line"><span class="cl">my_metric_total{env=“dev”} 3
</span></span><span class="line"><span class="cl">my_metric_total{env=“dev”} 7
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果无法控制删除标签将导致重复序列，通过 Prometheus  sum、avg、min、max等函数可以保留聚合数据，同时删除单个系列。在下面的示例中，我们使用 sum 函数来存储聚合指标，从而允许我们删除单个时间序列。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># sum by env
</span></span><span class="line"><span class="cl">my_metric_total{env=&#34;dev&#34;, ip=&#34;1.1.1.1&#34;} 1
</span></span><span class="line"><span class="cl">my_metric_total{env=&#34;dev&#34;, ip=&#34;3.3.3.3&#34;} 3
</span></span><span class="line"><span class="cl">my_metric_total{env=&#34;dev&#34;, ip=&#34;5.5.5.5&#34;} 7
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># Recording rule
</span></span><span class="line"><span class="cl">sum by(env) (my_metric_total{})
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">my_metric_total{env=&#34;dev&#34;} 11
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="使用聚合组">使用聚合组</h3>
<p>例如对于 <code>*_seconds_bucket</code> 类的指标, 通常需要的是一些高纬度的指标，那么这些指标可以通过 <code>recording rules</code> 进行记录和存储</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">groups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="l">3m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kube-apiserver-availability.rules</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="p">&gt;-</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">          avg_over_time(code_verb:apiserver_request_total:increase1h[30d]) *
</span></span></span><span class="line"><span class="cl"><span class="sd">          24 * 30</span><span class="w">          
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">record</span><span class="p">:</span><span class="w"> </span><span class="l">code_verb:apiserver_request_total:increase30d</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="p">&gt;-</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">          sum by (cluster, code, verb)
</span></span></span><span class="line"><span class="cl"><span class="sd">          (increase(apiserver_request_total{job=&#34;apiserver&#34;,verb=~&#34;LIST|GET|POST|PUT|PATCH|DELETE&#34;,code=~&#34;2..&#34;}[1h]))</span><span class="w">          
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">record</span><span class="p">:</span><span class="w"> </span><span class="l">code_verb:apiserver_request_total:increase1h</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="p">&gt;-</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">          sum by (cluster, code, verb)
</span></span></span><span class="line"><span class="cl"><span class="sd">          (increase(apiserver_request_total{job=&#34;apiserver&#34;,verb=~&#34;LIST|GET|POST|PUT|PATCH|DELETE&#34;,code=~&#34;5..&#34;}[1h]))</span><span class="w">          
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">record</span><span class="p">:</span><span class="w"> </span><span class="l">code_verb:apiserver_request_total:increase1h</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>最后 drop 掉指标</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">write_relabel_configs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">source_labels</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">__name__]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">regex</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;apiserver_request_duration_seconds_bucket&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">drop</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><code>recording rules</code> 是允许预先将经常计算的表达式的结果保存为一组新的时间序列的，这种情况下查询的成本会比每次直接查询原始的表达式要快许多，并且在聚合后，可以将原来的指标删掉</p>
<h2 id="reference">Reference</h2>
<blockquote>
<p><sup id="1">[1]</sup> <a href="https://banzaicloud.com/blog/multi-cluster-monitoring/">Multi cluster monitoring with Thanos</a></p>
<p><sup id="2">[2]</sup> <a href="https://grafana.com/blog/2022/10/20/how-to-manage-high-cardinality-metrics-in-prometheus-and-kubernetes/">How to manage high cardinality metrics in Prometheus and Kubernetes</a></p>
<p><sup id="3">[3]</sup> <a href="https://www.xiaowu95.wang/posts/bfccfc4">精简Prometheus指标减少资源占用</a></p>
<p><sup id="4">[4]</sup> <a href="https://grafana.com/blog/2022/02/15/what-are-cardinality-spikes-and-why-do-they-matter/">What are cardinality spikes and why do they matter?</a></p>
<p><sup id="5">[5]</sup> <a href="https://promcon.io/2019-munich/slides/containing-your-cardinality.pdf">Containing your Cardinality</a></p>
</blockquote>
]]></content:encoded>
    </item>
    
    <item>
      <title>我在Prometheus监控中高基数问题中的优化之路</title>
      <link>https://www.oomkill.com/2023/06/impove-prometheus-performance/</link>
      <pubDate>Wed, 14 Jun 2023 00:00:00 +0000</pubDate>
      
      <guid>https://www.oomkill.com/2023/06/impove-prometheus-performance/</guid>
      <description></description>
      <content:encoded><![CDATA[<h2 id="背景">背景</h2>
<p>对于整个 Kubernetes 集群来说，随着业务不断地打磨，新增指标，那么对于 Prometheus 特性来说，那么内存 与 存储的使用势必是增加。这是对于存储压力是很重的，通常情况下，使用 Prometheus，都会是用于 Kubernetes 集群中，而 应用于 Kubernetes 集中的存储势必是 PVC 之类的网络存储。</p>
<p>这种场景中，我将尝试拆解如何分析和配置 Prometheus 以显著的减少其资源使用并解决高基数问题</p>
<h2 id="高基数">高基数</h2>
<p>基数 (<em><strong>cardinality</strong></em>) 通俗来说是一个集合中的元素数量 <sup><a href="#1">[1]</a></sup> 基数的来源通常为：</p>
<ul>
<li>label 的数量</li>
<li>series(指标) 的数量</li>
<li>时间：label 或者 series 随时间而流失或增加，通常是增加</li>
</ul>
<p>那么这么看来高基数就是，label, series, 时间这三个集合的笛卡尔积，那么高基数的情况就很正常了。</p>
<p>而高基数带来的则是 Prometheus 资源使用，以及监控的性能。下图是 Grafana Lab 提到的一张图，很好的阐述了高基数这个问题</p>
<p>
  <img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/cardinality-spikes-diagram.jpg" alt="image-20220704002227865"  /></p>
<center>图：Prometheus中的基数</center>
<center><em>Source：</em>https://grafana.com/blog/2022/02/15/what-are-cardinality-spikes-and-why-do-they-matter</center><br>
<p>如图所示：一个指标 <em>server_responses</em> 他的 label 存在两个 <code>status_code</code> 与 <code>environment</code> ，这代表了一个集合，那他的 label value 是 1~5xx，这个指标的笛卡尔积就是10。</p>
<p>那么此时存在一个问题，如何能定位 基数高不高，Grafana Lab 给出了下面的数据 <sup><a href="#1">[1]</a></sup>，但是我不清楚具体的来源或者如何得到的这些值。也就是 <code>label:value</code></p>
<ul>
<li>低基数：1: 5</li>
<li>标准基数：1: 80</li>
<li>高基数：1: 10000</li>
</ul>
<h3 id="为什么指标会指数级增长">为什么指标会指数级增长</h3>
<p>在以 Kubernetes 为基础的架构中，随着抽象级别的提高（通常为Pod, Label, 以及更多抽象的拓扑），指标的时间序列也越来越多。因为在这种基础架构中，在传统架构中运行的一个应用的单个裸机，被许多运行分散在许多不同节点上的许多不同微服务的 Pod 所取代。在这些抽象层中的每一个都需要一个标签，以便可以唯一地标识它们，并且这些组件中的每一个都会生成自己的指标，从而创建其独特的时间序列集。</p>
<p>此外，在 Kubernetes 中的工作负载的短暂性最终也会创建更多的时间序列。例如 JAVA的 <code>http_request_duration_seconds_bucket</code> 指标，它会每次 pod 更改状态时生成一个新的时间序列，比如从“状态200&quot; 或者 “状态 404” 在到 “每个URL” 再到 “每个请求的时间”，这样大量短时间请求，对一个 Pod 状态可能会生成大量指标。</p>
<p>这是就要考虑到 Prometheus 兼容的格式，而非传统监控的监控指标的格式问题，就例如上面的例子，通过对 URI，请求时长，请求状态码几个维度去监控，那么此时的 exporter 导出的数据势必是非常杂乱的，而这种可能相同的指标就会放大到无穷。</p>
<p>在这种环境中的 Label，就是两组集合的笛卡尔积的选择，就是次优标签 <code>sub-optimal labels</code> ，对付这类高基数的指标，控制基数，以及如何避免使用这类错误，就是解决高基数的根本。</p>
<h3 id="高基数是一个非常重要的问题">高基数是一个非常重要的问题</h3>
<p>高基数的问题，带来的就是基于 Prometheus 的监控带来的是更多的可观测性，反之，随着时间序列的基数增加，那么为了维持某几个特别的指标的观测性，就必须要付出更多的硬件资源，以及影响本身监控系统的性能。比较明显的表现，就是监控的相应下降，极大的拖慢了整个系统的运行速度（包含仪表盘，promQL等）。还会延长系统故障排除时的MTTR (<em>Mean Time to Repair</em>)。</p>
<blockquote>
<p>Notes: 其实这里还有一类型错误，就是这会导致时间序列的乱序，怎么说呢，就是当指标无线放大时，在某一个点 scrap 的指标存储时间，大于了抓取周期，导致新指标存储早于旧指标，这种很容易出现在例如 Prometheus 的从内存到存储的那个点。</p>
</blockquote>
<h3 id="如何控制控制指标的高基数增长">如何控制控制指标的高基数增长</h3>
<p>指标的无序扩张（高基数）是不可避免对监控系统产生非常大的影响（存储和性能），而为此引出了一个如何优化不断增长的指标就是控制高基数增长的关键部分，下面将从几个维度来阐释控制“高基数”问题的步骤</p>
<h4 id="第一步高基数指标是否有价值">第一步：高基数指标是否有价值？</h4>
<p>在任何优化方法的第一步都是去了解哪些指标给系统带来负面影响（这里指高基数），并且还需要确定这些指标中哪些指标是有价值的；所谓的有价值既，在仪表板、告警中是否有被使用。</p>
<p>基于这些信息，我将根据基数问题与监控指标的价值分为四个象限：</p>
<ul>
<li>高价值，低成本：闲置、陈旧、很长时间没有新数据的</li>
<li>低价值，低成本：基本上没有什么影响，但是需要去考虑优化</li>
<li>低价值，高成本：可以考虑删除掉 Label 和 metric</li>
<li>高价值，高成本：你的指标是否过细化，是否需要重新设计 Label 或者聚合数据；或这类指标是否适合使用 Prometheus 这类时间序列</li>
</ul>
<h4 id="第二步如何确定高基数指标">第二步：如何确定高基数指标</h4>
<p>确定高基数指标包含3种方式</p>
<ul>
<li>Prometheus WEB UI 分析，2.14 版本之后</li>
<li>PromQL 分析</li>
<li>Prometheus API 分析</li>
</ul>
<p>通常情况下，WEB UI 就可以满足需求了，通过路径 Prometheus UI -&gt; Status -&gt; TSDB Status -&gt; Head Cardinality Stats。</p>
<p>
  <img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20230617175638751.png" alt="image-20230617175638751"  /></p>
<center>图：Prometheus WEB UI TOP 10 series</center>
<p>由上图可见，在这里体现的高基数问题的指标，通常都是以 <em>bucket</em> 结尾的指标，而这些指标通常包含2个维度，会无线拉长成为高基数指标。如下面指标所示，通常由 le （标识每个 bucket 的上限，这可以确保可以定位到在一个时间范围内相应的请求指标有哪些）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">apiserver_request_duration_seconds_bucket{component=&#34;apiserver&#34;, endpoint=&#34;https&#34;, group=&#34;admissionregistration.k8s.io&#34;, instance=&#34;10.0.0.4:6443&#34;, job=&#34;apiserver&#34;, le=&#34;+Inf&#34;, namespace=&#34;default&#34;, resource=&#34;mutatingwebhookconfigurations&#34;, scope=&#34;cluster&#34;, service=&#34;kubernetes&#34;, verb=&#34;DELETE&#34;, version=&#34;v1&#34;}	19
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">apiserver_request_duration_seconds_bucket{component=&#34;apiserver&#34;, endpoint=&#34;https&#34;, group=&#34;admissionregistration.k8s.io&#34;, instance=&#34;10.0.0.4:6443&#34;, job=&#34;apiserver&#34;, le=&#34;0.05&#34;, namespace=&#34;default&#34;, resource=&#34;mutatingwebhookconfigurations&#34;, scope=&#34;cluster&#34;, service=&#34;kubernetes&#34;, verb=&#34;POST&#34;, version=&#34;v1&#34;}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">apiserver_request_duration_seconds_bucket{component=&#34;apiserver&#34;, endpoint=&#34;https&#34;, group=&#34;admissionregistration.k8s.io&#34;, instance=&#34;10.0.0.4:6443&#34;, job=&#34;apiserver&#34;, le=&#34;0.25&#34;, namespace=&#34;default&#34;, resource=&#34;mutatingwebhookconfigurations&#34;, scope=&#34;cluster&#34;, service=&#34;kubernetes&#34;, verb=&#34;PATCH&#34;, version=&#34;v1&#34;}
</span></span></code></pre></td></tr></table>
</div>
</div><p>例如下面是生产环境中的一个高基数TOP10</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Count</th>
</tr>
</thead>
<tbody>
<tr>
<td>http_server_requests_seconds_bucket</td>
<td>2017537</td>
</tr>
<tr>
<td>lettuce_command_firstreponse_seconds_bucket</td>
<td>755056</td>
</tr>
<tr>
<td>lettuce_command_completion_seconds_bucket</td>
<td>755056</td>
</tr>
<tr>
<td>http_server_requests_seconds</td>
<td>555575</td>
</tr>
<tr>
<td>nginx_ingress_controller_request_duration_seconds_bucket</td>
<td>475440</td>
</tr>
<tr>
<td>node_ipvs_backend_connections_inactive</td>
<td>148796</td>
</tr>
<tr>
<td>node_ipvs_backend_connections_active</td>
<td>148796</td>
</tr>
<tr>
<td>apiserver_request_duration_seconds_bucket</td>
<td>27896</td>
</tr>
<tr>
<td>etcd_request_duration_seconds_bucket1</td>
<td>22763</td>
</tr>
</tbody>
</table>
<p>至此可以看到实际上 <code>http_server_requests_seconds_bucket</code> 这一个指标占据了 prometheus 总指标的50%+</p>
<p>而其他的一些分析，可以很有效的定位到你需要优化的标签</p>
<ul>
<li>Top 10 label names with high memory usage</li>
<li>Top 10 series count by label value pairs</li>
</ul>
<h4 id="通过-promql-定位-job">通过 promQL 定位 job</h4>
<ul>
<li>查询 top 10 的 series <code>topk(10, count by (__name__)({__name__=~&quot;.+&quot;}))</code></li>
<li><code>sum(scrape_series_added) by (job)</code> 通过 job Label 分析 series 增长</li>
<li><code>sum(scrape_samples_scraped) by (job)</code>  通过 job Label 分析 series 总量</li>
</ul>
<p>可以通过指标属于哪个 job</p>
<h4 id="第三步发现那些指标没有在使用">第三步：发现那些指标没有在使用</h4>
<p>Grafana Mimirtool 是一个开源的命令行工具， 它可以识别 Mimir、Prometheus 或 Prometheus 的存储中未在Dashboard、Alert 或 recording 中使用的指标。通过 Mimirtool 可以快速发现未使用的指标，并且做出操作</p>
<h2 id="优化监控指标">优化监控指标</h2>
<p>优化监控指标来解决高基数问题主要从以下维度进行</p>
<h3 id="增加采集间隔"><strong>增加采集间隔</strong></h3>
<p>Prometheus 的默认值为 <code>scrape_interval: 15s</code>，或 DPM (<em>Data points  Per minute</em>) 4个，但是如果查询语句为 <code>scrape_samples_scraped[1m]</code> 那么可以考虑将这个 job 的 <code>scrape_interval</code> 增加为1m，这样15~60 可以减少近75%的存储成本。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kube-state-metrics:
</span></span><span class="line"><span class="cl">  namespaceOverride: <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">  rbac:
</span></span><span class="line"><span class="cl">    create: <span class="nb">true</span>
</span></span><span class="line"><span class="cl">  releaseLabel: <span class="nb">true</span>
</span></span><span class="line"><span class="cl">  prometheus:
</span></span><span class="line"><span class="cl">    monitor:
</span></span><span class="line"><span class="cl">      enabled: <span class="nb">true</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">## Scrape interval. If not set, the Prometheus default scrape interval is used.</span>
</span></span><span class="line"><span class="cl">      <span class="c1">##</span>
</span></span><span class="line"><span class="cl">      interval: <span class="s2">&#34;&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="优化-histogram">优化 histogram</h2>
<p>histrogram 是 Prometheus中一种更具有更复杂类型的监控指标，通常用于决定数据的精度，典型的例子就是上面提到的 <code>http_server_requests_seconds_bucket</code> 中的 <code>le</code> ，此时假设 le 代表请求毫秒，那么我们只需要决定你所需要的精度是哪些？例如，如果仅仅需要 1ms, 5ms, 10ms，那么指标 le 标签就控制为3，这样结合 URI 指标，那么这个 histogram 是有限的</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># drop all metric series ending with _bucket and where le=&#34;0.1xxx&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">source_labels</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">__name__, le]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">separator</span><span class="p">:</span><span class="w"> </span><span class="l">_</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">regex</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;.+_bucket_(0.1+)&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;drop&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># Object labels:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">__name__</span><span class="p">:</span><span class="w"> </span><span class="l">http_server_requests_seconds_bucket</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">le</span><span class="p">:</span><span class="w"> </span><span class="m">0.114421</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>这里可以通过 <a href="https://relabeler.promlabs.com/">promlabs</a> 来测试你的规则是否是成功的 <sup><a href="#2">[2]</a></sup></p>
<h3 id="删除不需要的标签">删除不需要的标签</h3>
<p>对于一些指标，删除了未使用的标签后，反而会使这个指标变得没有意义，并且使这个指标变得序列重复，这个时候可以完整删除这个指标</p>
<p>例如在下面的示例中，第一个示例可以安全地删除 ip 标签，因为其余系列都是唯一的。但在第二个示例中，如果删除 ip 标签将产生重复的时间序列，Prometheus 将删除这些时间序列。<code>my_metric_total</code>在此示例中，Prometheus 将接收具有相同时间戳的值 1、3 和 7，并将丢弃其中的 2 个数据点。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># You can drop ip label, remaining series are still unique
</span></span><span class="line"><span class="cl">my_metric_total{env=“dev”, ip=“1.1.1.1&#34;} 12
</span></span><span class="line"><span class="cl">my_metric_total{env=“tst”, ip=“1.1.1.1&#34;} 14
</span></span><span class="line"><span class="cl">my_metric_total{env=“prd”, ip=“1.1.1.1&#34;} 18
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#Remaining values after dropping ip label
</span></span><span class="line"><span class="cl">my_metric_total{env=“dev”} 12
</span></span><span class="line"><span class="cl">my_metric_total{env=“tst”} 14
</span></span><span class="line"><span class="cl">my_metric_total{env=“prd”} 18
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># You can not drop ip label, remaining series are not unique
</span></span><span class="line"><span class="cl">my_metric_total{env=“dev”, ip=“1.1.1.1&#34;} 1
</span></span><span class="line"><span class="cl">my_metric_total{env=“dev”, ip=“3.3.3.3&#34;} 3
</span></span><span class="line"><span class="cl">my_metric_total{env=“dev”, ip=“5.5.5.5&#34;} 7
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#Remaining values after dropping ip label are not unique
</span></span><span class="line"><span class="cl">my_metric_total{env=“dev”} 1
</span></span><span class="line"><span class="cl">my_metric_total{env=“dev”} 3
</span></span><span class="line"><span class="cl">my_metric_total{env=“dev”} 7
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果无法控制删除标签将导致重复序列，通过 Prometheus  sum、avg、min、max等函数可以保留聚合数据，同时删除单个系列。在下面的示例中，我们使用 sum 函数来存储聚合指标，从而允许我们删除单个时间序列。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># sum by env
</span></span><span class="line"><span class="cl">my_metric_total{env=&#34;dev&#34;, ip=&#34;1.1.1.1&#34;} 1
</span></span><span class="line"><span class="cl">my_metric_total{env=&#34;dev&#34;, ip=&#34;3.3.3.3&#34;} 3
</span></span><span class="line"><span class="cl">my_metric_total{env=&#34;dev&#34;, ip=&#34;5.5.5.5&#34;} 7
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># Recording rule
</span></span><span class="line"><span class="cl">sum by(env) (my_metric_total{})
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">my_metric_total{env=&#34;dev&#34;} 11
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="使用聚合组">使用聚合组</h3>
<p>例如对于 <code>*_seconds_bucket</code> 类的指标, 通常需要的是一些高纬度的指标，那么这些指标可以通过 <code>recording rules</code> 进行记录和存储</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">groups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="l">3m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kube-apiserver-availability.rules</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="p">&gt;-</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">          avg_over_time(code_verb:apiserver_request_total:increase1h[30d]) *
</span></span></span><span class="line"><span class="cl"><span class="sd">          24 * 30</span><span class="w">          
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">record</span><span class="p">:</span><span class="w"> </span><span class="l">code_verb:apiserver_request_total:increase30d</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="p">&gt;-</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">          sum by (cluster, code, verb)
</span></span></span><span class="line"><span class="cl"><span class="sd">          (increase(apiserver_request_total{job=&#34;apiserver&#34;,verb=~&#34;LIST|GET|POST|PUT|PATCH|DELETE&#34;,code=~&#34;2..&#34;}[1h]))</span><span class="w">          
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">record</span><span class="p">:</span><span class="w"> </span><span class="l">code_verb:apiserver_request_total:increase1h</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="p">&gt;-</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">          sum by (cluster, code, verb)
</span></span></span><span class="line"><span class="cl"><span class="sd">          (increase(apiserver_request_total{job=&#34;apiserver&#34;,verb=~&#34;LIST|GET|POST|PUT|PATCH|DELETE&#34;,code=~&#34;5..&#34;}[1h]))</span><span class="w">          
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">record</span><span class="p">:</span><span class="w"> </span><span class="l">code_verb:apiserver_request_total:increase1h</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>最后 drop 掉指标</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">write_relabel_configs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">source_labels</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">__name__]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">regex</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;apiserver_request_duration_seconds_bucket&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">drop</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><code>recording rules</code> 是允许预先将经常计算的表达式的结果保存为一组新的时间序列的，这种情况下查询的成本会比每次直接查询原始的表达式要快许多，并且在聚合后，可以将原来的指标删掉</p>
<h2 id="reference">Reference</h2>
<blockquote>
<p><sup id="1">[1]</sup> <a href="https://grafana.com/blog/2022/02/15/what-are-cardinality-spikes-and-why-do-they-matter/">What are cardinality spikes and why do they matter?</a></p>
<p><sup id="2">[2]</sup> <a href="https://grafana.com/blog/2022/10/20/how-to-manage-high-cardinality-metrics-in-prometheus-and-kubernetes/">How to manage high cardinality metrics in Prometheus and Kubernetes</a></p>
<p><sup id="3">[3]</sup> <a href="https://www.xiaowu95.wang/posts/bfccfc4">精简Prometheus指标减少资源占用</a></p>
<p><sup id="4">[4]</sup> <a href="https://grafana.com/blog/2022/02/15/what-are-cardinality-spikes-and-why-do-they-matter/">What are cardinality spikes and why do they matter?</a></p>
<p><sup id="5">[5]</sup> <a href="https://promcon.io/2019-munich/slides/containing-your-cardinality.pdf">Containing your Cardinality</a></p>
</blockquote>
]]></content:encoded>
    </item>
    
    <item>
      <title>prometheus operator使用</title>
      <link>https://www.oomkill.com/2020/11/prometheus-operator/</link>
      <pubDate>Mon, 02 Nov 2020 00:00:00 +0000</pubDate>
      
      <guid>https://www.oomkill.com/2020/11/prometheus-operator/</guid>
      <description></description>
      <content:encoded><![CDATA[<h2 id="什么是-operator">什么是 Operator？</h2>
<p><code>Operator</code>是由<code>CoreOS</code>公司开发的，用来扩展<code>kubernetes APi</code>的特定的应用程序控制器，<code>Operator</code>基于Kubernetes的资源和控制器概念之上构建，但同时又包含了对相应应用程序特定的一些专业知识。创建<code>operator</code>的关键是 <code>CRD（CustomResourceDefinition）</code>的设计。</p>
<h3 id="prometheus-operator">Prometheus Operator</h3>
<p><code>Prometheus Operator</code> 是CoreOS公司提供的基于Prometheus及其相关监视组件对Kubernetes集群组件的管理，该Operator目的是简化和自动化针对Kubernetes集群的基于Prometheus的管理及配置。</p>
<h3 id="prometheus-operator架构组件">Prometheus Operator架构组件</h3>
<ul>
<li><strong>Operator</strong>：作为Prometheus Operator的核心组件，也即是自定义的控制器，用来监视和部署管理Prometheus Operator CRD资源对象，监控并维持CRD资源状态。</li>
<li><strong>Prometheus Server</strong>：Operator 根据自定义资源 Prometheus 类型中定义的内容而部署的Prometheus Cluster</li>
<li><strong>Prometheus Operator CRD</strong>：
<ul>
<li><code>Prometheus</code>：以CRD资源提供给Operator的类似于Pod资源清单定位的资源。</li>
<li><code>ServiceMonitor</code>：声明定义对Kubernetes Services资源进行监控，使用标签选择器来选择所需配置的监控，后端是Service的Endpoint，通过Service标签选择器获取EndPoint对象。</li>
<li><code>PodMonitor</code>：使用标签选择器，选择对匹配Pod进行监控</li>
<li><code>Alertmanager</code>：声明定义了Alertmanager在Kubernetes中运行所提供的配置。</li>
<li><code>PrometheusRule</code>: 声明定义了Prometheus在Kubernetes中运行所需的Rule配置。</li>
</ul>
</li>
</ul>
<p>reference</p>
<p><a href="https://github.com/prometheus-operator/prometheus-operator/blob/master/Documentation/design.md">Prometheus-Operator-design</a></p>
<h2 id="prometheus-operator监控二进制kubernetes">Prometheus Operator监控二进制kubernetes</h2>
<p>查看<a href="https://github.com/prometheus-operator/kube-prometheus#kubernetes-compatibility-matrix">兼容性列表</a>选择对应的版本来下载，此处kubernetes集群为1.8.10 。</p>
<p>对应地址为 <code>https://github.com/prometheus-operator/kube-prometheus.git</code> ，可以在域名后添加<code>.cnpmjs.org</code> 访问中国的github加速。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">git clone https://github.com.cnpmjs.org/prometheus-operator/kube-prometheus.git
</span></span></code></pre></td></tr></table>
</div>
</div><p>资源清单在项目目录 <code>manifests</code> CRD在 <code>manifests/setup</code> <strong>需要先安装CRD 和 Operator 对象</strong></p>
<h4 id="kube-controller-manager-和-kube-scheduler-无监控数据">kube-controller-manager 和 kube-scheduler 无监控数据</h4>
<p>二进制部署的Kubernetes集群中部署Prometheus Operator，会发现在<code>prometheus server</code>的页面上发现<code>kube-controller</code>和<code>kube-schedule</code>的target为0/0。匹配不到节点信息，这是因为<code>serviceMonitor</code>是根据<code>label</code>去选取<code>svc</code>的。此处svc并没有<code>kube-controller</code>和<code>kube-schedule</code> 需要手动创建。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kube-controller-manager</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">kube-controller-manager</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">component</span><span class="p">:</span><span class="w"> </span><span class="l">kube-controller-manager</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">kube-controller-manager</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">component</span><span class="p">:</span><span class="w"> </span><span class="l">kube-controller-manager</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">https-metrics</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">10252</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">10252</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Endpoints</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kube-controller-manager</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">kube-controller-manager</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">component</span><span class="p">:</span><span class="w"> </span><span class="l">kube-controller-manager</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">subsets</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">addresses</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">ip</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;10.0.0.5&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nodeName</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;master01&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">10252</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">https-metrics</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kube-scheduler</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">kube-scheduler</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">component</span><span class="p">:</span><span class="w"> </span><span class="l">kube-scheduler</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">kube-scheduler</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">component</span><span class="p">:</span><span class="w"> </span><span class="l">kube-scheduler</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">https-metrics</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">10251</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">10251</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Endpoints</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kube-scheduler</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">kube-scheduler</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">component</span><span class="p">:</span><span class="w"> </span><span class="l">kube-scheduler</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">subsets</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">addresses</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">ip</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;10.0.0.5&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">nodeName</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;master01&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">10251</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">https-metrics</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>此处需要注意的是：需要修改对应的Prometheus Operator资源清单的值一直才能获取到目标</p>
<p><code>Service.spec.ports.name</code>要和<code>ServiceMonitor.spec.endpoints.port</code>的名称对应。</p>
<p><code>Service.metadata.namespace</code>要和<code>ServiceMonitor.namespaceSelector.matchNames</code>对应</p>
<p><code>Service.metadata.labels</code>的key要和<code>ServiceMonitor.JobLabel</code>对应</p>
<p><code>Service.metadata.labels</code> 要和 <code>ServiceMonitor.selector.matchLabels</code>对应</p>
<h2 id="监控第三方的服务及自定义servicemonitor">监控第三方的服务及自定义servicemonitor</h2>
<h3 id="一查看-etcd-信息">一、查看 Etcd 信息</h3>
<p>这里的etcd采用二进制方法安装，可以直接访问 <code>host:2379/metrics</code> 获得。</p>
<h3 id="二将证书存入-kubernetes">二、将证书存入 Kubernetes</h3>
<p>创建secret</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">kubectl create secret generic hketcd \
</span></span><span class="line"><span class="cl">--from-file=&#39;/etc/etcd/pki/client.crt&#39; \
</span></span><span class="line"><span class="cl">--from-file=&#39;/etc/etcd/pki/client.key&#39; \
</span></span><span class="line"><span class="cl">--from-file=&#39;/etc/etcd/pki/ca.crt&#39; \
</span></span><span class="line"><span class="cl">-n monitoring
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="三将证书挂入-prometheusserver">三、将证书挂入 PrometheusServer</h3>
<p>方法1： <code>kubectl edit prometheus k8s -n monitoring</code></p>
<p>方法2：修改 <code>prometheus-prometheus.yaml</code> 文件</p>
<p>增加内容：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">secrets</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">hketcd</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>挂入后的证书保存在目录 <code>/etc/prometheus/secrets/{secret_name}/</code> 下。</p>
<h3 id="四创建-etcd-service--endpoints">四、创建 Etcd Service &amp; Endpoints</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">etcdmaster</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">etcd</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">component</span><span class="p">:</span><span class="w"> </span><span class="l">etcd</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">etcd</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">component</span><span class="p">:</span><span class="w"> </span><span class="l">etcd</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterIP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">clusterIP</span><span class="p">:</span><span class="w"> </span><span class="l">None</span><span class="w"> </span><span class="c"># 设置为None，不分配Service IP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">https-metrics</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">2379</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Endpoints</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">etcdmaster</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">etcd</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">component</span><span class="p">:</span><span class="w"> </span><span class="l">etcd</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">subsets</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">addresses</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">ip</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;10.0.0.5&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">nodeName</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;master01&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">2379</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">https-metrics</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="五创建-servicemonitor">五、创建 ServiceMonitor</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">monitoring.coreos.com/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceMonitor</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">etcd</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">monitoring</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">etcd</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">jobLabel</span><span class="p">:</span><span class="w"> </span><span class="l">k8s-app</span><span class="w"> </span><span class="c"># 匹配工作的标签，这里是servicemonitor即 为service的标签</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">endpoints</span><span class="p">:</span><span class="w"> </span><span class="c"># 此ServiceMonitor的节点</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l">https-metrics</span><span class="w"> </span><span class="c"># k8s service endports的设置的端口的名称</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="l">30s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">scheme</span><span class="p">:</span><span class="w"> </span><span class="l">https</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">tlsConfig</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">serverName</span><span class="p">:</span><span class="w"> </span><span class="l">hketcd</span><span class="w"> </span><span class="c"># 访问etcd的名称，因为证书原因需要认证访问的名称</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">caFile</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;/etc/prometheus/secrets/hketcd/ca.crt&#34;</span><span class="w"> </span><span class="c"># 这个是在prometheus容器内挂载的证书</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">certFile</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;/etc/prometheus/secrets/hketcd/client.crt&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">keyFile</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;/etc/prometheus/secrets/hketcd/client.key&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">insecureSkipVerify</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w"> </span><span class="c"># 选择匹配到的endpoints</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l">etcd</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">component</span><span class="p">:</span><span class="w"> </span><span class="l">etcd</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># 与matchExpressions: #进行后端的匹配</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespaceSelector</span><span class="p">:</span><span class="w"> </span><span class="c"># 选择所在资源的名称控件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchNames</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">kube-system</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div>]]></content:encoded>
    </item>
    
    <item>
      <title>telegram接收altermanager消息</title>
      <link>https://www.oomkill.com/2019/09/telegram-bot-send-post-json/</link>
      <pubDate>Mon, 02 Sep 2019 00:00:00 +0000</pubDate>
      
      <guid>https://www.oomkill.com/2019/09/telegram-bot-send-post-json/</guid>
      <description></description>
      <content:encoded><![CDATA[<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">curl -XPOST https://api.telegram.org/bot977657989:AAF0QE88WhxRIdpFLOYO_9ldLun5VtpfCWw/getUpdates
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">curl -X POST \
</span></span><span class="line"><span class="cl">     -H &#39;Content-Type: application/json&#39; \
</span></span><span class="line"><span class="cl">     -d &#39;{&#34;chat_id&#34;: &#34;850233746&#34;, &#34;text&#34;: &#34;This is a test from curl&#34;, &#34;disable_notification&#34;: true}&#39; \
</span></span><span class="line"><span class="cl">     https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage
</span></span><span class="line"><span class="cl">     
</span></span><span class="line"><span class="cl">curl -X POST \
</span></span><span class="line"><span class="cl">     -H &#39;Content-Type: application/json&#39; \
</span></span><span class="line"><span class="cl">     -d &#39;{&#34;chat_id&#34;: &#34;850233746&#34;, &#34;text&#34;: &#34;This is a test from curl&#34;, &#34;disable_notification&#34;: true}&#39; \
</span></span><span class="line"><span class="cl">     https://api.telegram.org/bot1009139816:AAGTmFsJDkH9H3E0OVoFi4GyvYp0uMctvcE/sendMessage
</span></span></code></pre></td></tr></table>
</div>
</div><p><a href="https://api.telegram.org/bot721202655:AAG_kN1IHP93Wmnd90RRaJC-dK9tKQHddRA/sendMessage">https://api.telegram.org/bot721202655:AAG_kN1IHP93Wmnd90RRaJC-dK9tKQHddRA/sendMessage</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&#34;chat_id&#34;</span><span class="p">:</span> <span class="s2">&#34;-383641009&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&#34;text&#34;</span><span class="p">:</span> <span class="s2">&#34;This is a test from curl&#34;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">	<span class="nt">&#34;disable_notification&#34;</span><span class="p">:</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>alertmanager发送的消息类型如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&#34;receiver&#34;</span><span class="p">:</span> <span class="s2">&#34;webhook&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&#34;status&#34;</span><span class="p">:</span> <span class="s2">&#34;firing&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&#34;alerts&#34;</span><span class="p">:</span> <span class="p">[{</span>
</span></span><span class="line"><span class="cl">		<span class="nt">&#34;status&#34;</span><span class="p">:</span> <span class="s2">&#34;firing&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nt">&#34;labels&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nt">&#34;alertname&#34;</span><span class="p">:</span> <span class="s2">&#34;InstanceDown&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nt">&#34;instance&#34;</span><span class="p">:</span> <span class="s2">&#34;192.168.8.32:9110&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nt">&#34;job&#34;</span><span class="p">:</span> <span class="s2">&#34;node&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nt">&#34;role&#34;</span><span class="p">:</span> <span class="s2">&#34;api&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nt">&#34;service&#34;</span><span class="p">:</span> <span class="s2">&#34;node&#34;</span>
</span></span><span class="line"><span class="cl">		<span class="p">},</span>
</span></span><span class="line"><span class="cl">		<span class="nt">&#34;annotations&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nt">&#34;description&#34;</span><span class="p">:</span> <span class="s2">&#34;192.168.8.32:9110: job node has been down vlaue==0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nt">&#34;summary&#34;</span><span class="p">:</span> <span class="s2">&#34;192.168.8.32:9110: has been down&#34;</span>
</span></span><span class="line"><span class="cl">		<span class="p">},</span>
</span></span><span class="line"><span class="cl">		<span class="nt">&#34;startsAt&#34;</span><span class="p">:</span> <span class="s2">&#34;2019-07-25T21:55:13.352482605+08:00&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nt">&#34;endsAt&#34;</span><span class="p">:</span> <span class="s2">&#34;0001-01-01T00:00:00Z&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nt">&#34;generatorURL&#34;</span><span class="p">:</span> <span class="s2">&#34;http://zy-tw-tianxia-prod-prometheus01:19090/graph?g0.expr=up+%3D%3D+0\u0026g0.tab=1&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="p">},</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nt">&#34;status&#34;</span><span class="p">:</span> <span class="s2">&#34;firing&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nt">&#34;labels&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nt">&#34;alertname&#34;</span><span class="p">:</span> <span class="s2">&#34;InstanceDown&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nt">&#34;instance&#34;</span><span class="p">:</span> <span class="s2">&#34;192.168.8.34:9110&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nt">&#34;job&#34;</span><span class="p">:</span> <span class="s2">&#34;node&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nt">&#34;role&#34;</span><span class="p">:</span> <span class="s2">&#34;api&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nt">&#34;service&#34;</span><span class="p">:</span> <span class="s2">&#34;node&#34;</span>
</span></span><span class="line"><span class="cl">		<span class="p">},</span>
</span></span><span class="line"><span class="cl">		<span class="nt">&#34;annotations&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nt">&#34;description&#34;</span><span class="p">:</span> <span class="s2">&#34;192.168.8.34:9110: job node has been down vlaue==0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nt">&#34;summary&#34;</span><span class="p">:</span> <span class="s2">&#34;192.168.8.34:9110: has been down&#34;</span>
</span></span><span class="line"><span class="cl">		<span class="p">},</span>
</span></span><span class="line"><span class="cl">		<span class="nt">&#34;startsAt&#34;</span><span class="p">:</span> <span class="s2">&#34;2019-07-25T21:53:13.352482605+08:00&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nt">&#34;endsAt&#34;</span><span class="p">:</span> <span class="s2">&#34;0001-01-01T00:00:00Z&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nt">&#34;generatorURL&#34;</span><span class="p">:</span> <span class="s2">&#34;http://zy-tw-tianxia-prod-prometheus01:19090/graph?g0.expr=up+%3D%3D+0\u0026g0.tab=1&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}],</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&#34;groupLabels&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nt">&#34;alertname&#34;</span><span class="p">:</span> <span class="s2">&#34;InstanceDown&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="p">},</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&#34;commonLabels&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nt">&#34;alertname&#34;</span><span class="p">:</span> <span class="s2">&#34;InstanceDown&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nt">&#34;job&#34;</span><span class="p">:</span> <span class="s2">&#34;node&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nt">&#34;role&#34;</span><span class="p">:</span> <span class="s2">&#34;api&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nt">&#34;service&#34;</span><span class="p">:</span> <span class="s2">&#34;node&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="p">},</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&#34;commonAnnotations&#34;</span><span class="p">:</span> <span class="p">{},</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&#34;externalURL&#34;</span><span class="p">:</span> <span class="s2">&#34;http://zy-tw-tianxia-prod-prometheus01:9093&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&#34;version&#34;</span><span class="p">:</span> <span class="s2">&#34;4&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&#34;groupKey&#34;</span><span class="p">:</span> <span class="s2">&#34;{}:{alertname=\&#34;InstanceDown\&#34;}&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><a href="https://www.qikqiak.com/post/prometheus-operator-custom-alert/">https://www.qikqiak.com/post/prometheus-operator-custom-alert/</a></p>
<h3 id="telegram在文本消息中插入换行符">telegram在文本消息中插入换行符</h3>
<p>尝试&rsquo;％0D&rsquo;或&rsquo;％0A&rsquo;  参考地址：https://stackoverrun.com/cn/q/8787508</p>
<p>telegram api 使用</p>
<p><a href="https://stackoverrun.com/cn/q/8787508">https://stackoverrun.com/cn/q/8787508</a></p>
]]></content:encoded>
    </item>
    
    <item>
      <title>prometheus golang_client开发Exporter</title>
      <link>https://www.oomkill.com/2019/06/prometheus-golang_client/</link>
      <pubDate>Sun, 02 Jun 2019 00:00:00 +0000</pubDate>
      
      <guid>https://www.oomkill.com/2019/06/prometheus-golang_client/</guid>
      <description></description>
      <content:encoded><![CDATA[<p>exporter是一个独立运行的采集程序，其中的功能需要有这三部分</p>
<ul>
<li>自身是HTTP服务器，可以相应从外部发过来的HTTP GET请求。</li>
<li>自身需要运行在后台，并可以定期触发抓取本地的监控数据。</li>
<li>返回给prometheus_server的内容是要符合prometheus规定的metrics类型的key-Value</li>
</ul>
<p>promethes监控中对于采集过来的数据统一称为metrice数据</p>
<p><strong>Metrics</strong>，为某个系统某个服务做监控、做统计，就需要用到Metrics.</p>
<p>metrics是一种对采样数掘的总称（metrics并不代表某一种具体的数据格式是一种对于度星计算单位的抽象）</p>
<p>metrics的几种主要的类型</p>
<h2 id="metric-types">METRIC TYPES</h2>
<p>prometheus客户端库提供4中metric类型</p>
<ul>
<li>counter 计数器，累加指标</li>
<li>gauge 测量指标</li>
<li>summary 概略</li>
<li>histogram 直方图</li>
</ul>
<h3 id="counter">counter</h3>
<p>Counter计数器，累加的指标数据，随时间逐步增加，如程序运行次数、运行错误发生总数。如网卡流量，代表持续增加的数据包或者传输字节的累加值</p>
<p>比如对用户访问量的采样数据</p>
<p>我们的产品被用户访问一次就是1过了10分钟后积累到100</p>
<p>过一天后累积到20000</p>
<p>一周后积累到100000-150000</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">test</span> <span class="p">=</span> <span class="nx">prometheus</span><span class="p">.</span><span class="nf">NewSummaryVec</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">		<span class="nx">prometheus</span><span class="p">.</span><span class="nx">SummaryOpts</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Name</span><span class="p">:</span>       <span class="s">&#34;zhangsan&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Help</span><span class="p">:</span>       <span class="s">&#34;username&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Objectives</span><span class="p">:</span> <span class="kd">map</span><span class="p">[</span><span class="kt">float64</span><span class="p">]</span><span class="kt">float64</span><span class="p">{</span><span class="mf">0.5</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">:</span> <span class="mf">0.001</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">		<span class="p">},</span>
</span></span><span class="line"><span class="cl">		<span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;service&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">	<span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># HELP zhangsan username
</span></span><span class="line"><span class="cl"># TYPE zhangsan summary
</span></span><span class="line"><span class="cl">zhangsan{service=&#34;aaa&#34;,quantile=&#34;0.5&#34;} 0.4933459627210085
</span></span><span class="line"><span class="cl">zhangsan{service=&#34;aaa&#34;,quantile=&#34;0.9&#34;} 0.884503005897664
</span></span><span class="line"><span class="cl">zhangsan{service=&#34;aaa&#34;,quantile=&#34;0.99&#34;} 0.9939536606026
</span></span><span class="line"><span class="cl">zhangsan_sum{service=&#34;aaa&#34;} 3145.830341777395
</span></span><span class="line"><span class="cl">zhangsan_count{service=&#34;aaa&#34;} 6308
</span></span></code></pre></td></tr></table>
</div>
</div><p>在每次执行后值会累加</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># HELP zhangsan username
</span></span><span class="line"><span class="cl"># TYPE zhangsan summary
</span></span><span class="line"><span class="cl">zhangsan{service=&#34;aaa&#34;,quantile=&#34;0.5&#34;} 0.4933459627210085
</span></span><span class="line"><span class="cl">zhangsan{service=&#34;aaa&#34;,quantile=&#34;0.9&#34;} 0.884503005897664
</span></span><span class="line"><span class="cl">zhangsan{service=&#34;aaa&#34;,quantile=&#34;0.99&#34;} 0.9945251964629818
</span></span><span class="line"><span class="cl">zhangsan_sum{service=&#34;aaa&#34;} 3165.232975252529
</span></span><span class="line"><span class="cl">zhangsan_count{service=&#34;aaa&#34;} 6347
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="gauge">gauge</h3>
<p>最简单的度量指标，只有一个简单的返回值，或者叫瞬时状态，例如，我们想衡量一个特处理队列中任务的个数。</p>
<p>用更简单的方式举个例子</p>
<p>例如：如果我要监控覆盘容量或者内存的使用量，那么就应该使用Gauges的metrics格式来度量，因为硬盘的容量或者内存的使用量是随着时间的推移不断的瞬时，没有规则的变化。这种变化没有规律，当前是多少，采集回来的就是多少，既不能肯定是一直持续增长，也不能肯定是一直降低，是多少就是多少这种就是Gauges使用类型的代表。</p>
<p>如图所示CPU的上下厚动就是采集使用Gauge形式的metrics数据，没有规律是多少就得到多少，然后显示出来。</p>
<p>gauge代表采集的是一个单一的数据，此数据可增可减，如内存使用情况，cpu使用情况等。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">gaugetest</span> <span class="p">=</span> <span class="nx">prometheus</span><span class="p">.</span><span class="nf">NewGauge</span><span class="p">(</span><span class="nx">prometheus</span><span class="p">.</span><span class="nx">GaugeOpts</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Name</span><span class="p">:</span> <span class="s">&#34;lisi&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Help</span><span class="p">:</span> <span class="s">&#34;password&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># HELP lisi password
</span></span><span class="line"><span class="cl"># TYPE lisi gauge
</span></span><span class="line"><span class="cl">lisi 0.4578056215001356
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># HELP lisi password
</span></span><span class="line"><span class="cl"># TYPE lisi gauge
</span></span><span class="line"><span class="cl">lisi 0.44668242347036363
</span></span></code></pre></td></tr></table>
</div>
</div><p><a href="https://github.com/lwhile/workDoc">https://github.com/lwhile/workDoc</a></p>
<h3 id="summary-概略">summary 概略</h3>
<h3 id="histogram-比例型的估算数值">histogram 比例型的估算数值</h3>
<p>Histogram 统计数据的分布情况。比如最小值，最大值，中间值，还有中位数，75百分位，90百分位，95百分位，98百分位，99百分位，和99.9百分位的值（percentiles）。</p>
<p><strong>这是一种特殊的metrics数据类型，代表的是一种</strong>近似的百分比估算数值</p>
<p>比如我们在企业工作中经常接触这种数据</p>
<p>Http.response_time HTTP响应时间</p>
<p>代表的是一次用户HTTP请求在系统传输和执行过程中总共花费的时间</p>
<p>nginx中的也会记录这一项数值在日志中</p>
<p>那么问题来了</p>
<p>我们做一个假设</p>
<p>如果我们想通过监控的方式抓取当天的nginx accoss.log，并且想监控用户的访问时间我们应该怎么做呢？同学们肯定很容易想到
简单制把日志每行的<code>http_response_time</code> 数值统统采集下来期然后计算一下总的平均值即可。那么假如我们采集到今天一天的访问量是100万次然后把这100万次的<code>http_response_time</code> 全都加一超然后除以100万最后得出来一个值</p>
<p>0.05秒=50毫秒</p>
<p>这个数据的意文大么？</p>
<p>假如今天中午1：00的时候发生了一次线上故障系统整体的访问变得非常缓慢大部分的用户请求时间都达到了0.5~1秒作用但是这一段时间只持续了5分钟，总的一天的平均值并不能表现得出来我们如何在 1:00 ~ 1:05 的时候实现报警呢？</p>
<p>在举个例子：</p>
<p>就算我们一天下来线上没有发生故障大部分用户的响应时间都在0.05秒（通过总时间/总次数得出）但是我们不要忘了任何系统中都一定存在慢请求就是有一少部分的用户请求时间会比总的平均值大很多甚至接近5秒10秒的也有（这种情况很普遍因为各种因素可能是软件本身的bug也可能是系统的原因更有可能是少部分用户的使用途径中出现了问题）</p>
<p>那么我们的监控需要发现和报警这种少部分的特殊状况，用总平均能获得吗？</p>
<p>如果采用总平均的方式，那不管发生什么特殊情况，因为大部分的用户响应都是正常的你永远也发现不了少部分的问题所以Histogram的metrics类型在这种时候就派上用场了通过histogram类型（prometheus中其实提供了一个基于histogram算法的函数可以直接使用）可以分别统计出全部用户的单应时间中
~=0.05秒的量有多少0 ~ 0.05秒的有多少，&gt;2秒的有多少&gt;10秒的有多少</p>
<p>我们就可以很清晰的看到当前我们的系统中必于基本正常状态的有多少百分比的用户（或者是请求）多少处于速度极快的用户，多少处于慢请求或者有问题的请求</p>
<p>metrics的类型其实还有另外的类型</p>
<p>但是在我们大米运维的课程中我们最主要使用的就是counter ganga 和 histogram</p>
<h4 id="kv的数据形式">kv的数据形式</h4>
<p>对于采集回来的数据类型再往细了说必须要以一种具体的数据格式供我们查看和使用那么我们来看一下一个exporter 给我们果集来的服务器上的k/v形式metrics数据当一个exporter被安装和运行在被监控的服务器上后，使用简单的curl命令就可以看到exporer帮我们采集到metrics数据的样子，以k/v的形式展现和保存</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">curl localhost:9100/metrics
</span></span></code></pre></td></tr></table>
</div>
</div>]]></content:encoded>
    </item>
    
    <item>
      <title>prometheus传统架构安装</title>
      <link>https://www.oomkill.com/2019/04/prometheus-install/</link>
      <pubDate>Tue, 02 Apr 2019 00:00:00 +0000</pubDate>
      
      <guid>https://www.oomkill.com/2019/04/prometheus-install/</guid>
      <description></description>
      <content:encoded><![CDATA[<p>全局配置选项</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">scrape_interval: 采集生命周期
</span></span><span class="line"><span class="cl">scrape_timeout: 采集超时时间
</span></span><span class="line"><span class="cl">evaluation_interval: 告警评估周期
</span></span><span class="line"><span class="cl">rule_files 监控告警规则
</span></span><span class="line"><span class="cl">scrape_config: 被监控端
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">altering 
</span></span></code></pre></td></tr></table>
</div>
</div><p>检查配置文件语法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ promtool check config \etc\prometheus.yml 
</span></span><span class="line"><span class="cl">Checking \etc\prometheus.yml
</span></span><span class="line"><span class="cl">  SUCCESS: 0 rule files found
</span></span></code></pre></td></tr></table>
</div>
</div><p>100 - (node_memory_MemFree_bytes+node_memory_Cached_bytes+node_memory_Buffers_bytes) \ node_memory_MemTotal_bytes * 100</p>
<p>计算剩余空间</p>
<p>node_filesystem_free_bytes{mountpoint=&quot;&quot;,fstype=~&ldquo;ext4|xfs&rdquo;} \ node_filesystem_size_bytes{mountpoint=&quot;&quot;,fstype=~&ldquo;ext4|xfs&rdquo;} * 100</p>
<p>查看使用的百分比</p>
<p>100-node_filesystem_free_bytes{mountpoint=&quot;&quot;,fstype=~&ldquo;ext4|xfs&rdquo;} \ node_filesystem_size_bytes{mountpoint=&quot;&quot;,fstype=~&ldquo;ext4|xfs&rdquo;} * 100</p>
<p>prometheus使用influxdb [Prometheus endpoints support in InfluxDB | InfluxData Documentation](https:\docs.influxdata.com\influxdb\v1.7\supported_protocols\prometheus)</p>
<p>[Configuration | Prometheus](https:\prometheus.io\docs\prometheus\latest\configuration\configuration)</p>
<p>配置文件参考</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">global</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">alerting</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">alertmanagers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">static_configs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">targets</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">rule_files</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">scrape_configs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">job_name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;prometheus1&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">file_sd_configs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">files</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;\data\sd_config\test.yml&#39;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">refresh_interval</span><span class="p">:</span><span class="w"> </span><span class="l">5s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">relabel_configs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">replace</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">source_labels</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;prometheous1&#39;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">regex</span><span class="p">:</span><span class="w"> </span><span class="l">(.*)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">replacement</span><span class="p">:</span><span class="w"> </span><span class="l">$1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">target_label</span><span class="p">:</span><span class="w"> </span><span class="l">ids</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l">keep</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">source_labels</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;job&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">job_name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;k8s_master&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">file_sd_configs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">files</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;\data\sd_config\master.yml&#39;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">refresh_interval</span><span class="p">:</span><span class="w"> </span><span class="l">5s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">remote_write</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;http:\\localhost:8086\api\v1\prom\write?db=prometheus&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">remote_read</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;http:\\localhost:8086\api\v1\prom\read?db=prometheus&#34;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>influxdb使用</p>
<p><a href="https:%5Cwww.linuxdaxue.com%5Cinfluxdb-basic-operation.html">InfluxDB学习之InfluxDB的基本操作 | Linux大学</a></p>
<p>查看所有表</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SHOW</span><span class="w"> </span><span class="n">MEASUREMENTS</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">up</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>https:\github.com\kubernetes\kubernetes\tree\master\cluster\addons\prometheus</p>
<p>文件主要包括一下几个部分</p>
<ul>
<li>Prometheus的安装 包括 rbac service configmap</li>
<li>Prometheus-metrics 获取资源对象</li>
<li>node-exporter 获取工作节点资源信息</li>
<li>alertmanager 告警</li>
</ul>
<p>安装顺序</p>
<p>prometheus-rbac.yaml Prometheus访问apiserver的授权
prometheus-configmap.yaml 管理Prometheus的配置文件
prometheus-service.yaml 将Prometheus端口暴漏
prometheus-statefulset.yaml</p>
<p>原因为 prometheus-statefulset.yaml中的<code>accessModes</code>不能为<code>ReadWriteOnce</code>
prometheus&quot;is invalid: spec: Forbidden: updates to statefulset spec for fields other than &lsquo;replicas&rsquo;, &rsquo;template&rsquo;, and &lsquo;updateStrategy&rsquo; are forbidden</p>
<p>日志中报错<code>pod has unbound immediate persistentvolumeclaims back-off restarting failed container</code></p>
<p>错误原因：动态绑定至其他sc上，查看<code>kubectl describe pvc prometheus-data-prometheus-0 -n kube-system</code>pvc中报错<code>storageclass.storage.k8s.io &quot;nfs&quot; not found</code></p>
<p>prometheus时间不一致问题</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">myweb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">harbor/tomcat:8.5-jre8</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">host-time</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/etc/localtime</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">host-time</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">hostPath</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/etc/localtime</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>部署应用时，单独读取主机的“/etc/localtime”文件，即创建pod时同步时区，无需修改镜像，但是每个应用都要单独设置。</p>
<p>prometheus server down</p>
<p>编辑prometheus-statusfullset.yaml 修改其配置localhost 改为 127.0.0.1</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">time=&#34;2020-11-20T18:44:48+08:00&#34; level=error msg=&#34;subset not found for kube-system/prometheus-server&#34; providerName=kubernetescrd ingress=promserver namespace=kube-system
</span></span></code></pre></td></tr></table>
</div>
</div><p>查找原因kubernetes svc 匹配错误 service endpoint没有匹配到内容</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ kubectl describe svc  prometheus-server  -n kube-system 
</span></span><span class="line"><span class="cl">Name:              prometheus-server
</span></span><span class="line"><span class="cl">Namespace:         kube-system
</span></span><span class="line"><span class="cl">Labels:            &lt;none&gt;
</span></span><span class="line"><span class="cl">Annotations:       Selector:  monitor=prometheus
</span></span><span class="line"><span class="cl">Type:              ClusterIP
</span></span><span class="line"><span class="cl">IP:                10.110.116.203
</span></span><span class="line"><span class="cl">Port:              &lt;unset&gt;  9090/TCP
</span></span><span class="line"><span class="cl">TargetPort:        9090/TCP
</span></span><span class="line"><span class="cl">Endpoints:         &lt;none&gt;
</span></span><span class="line"><span class="cl">Session Affinity:  None
</span></span><span class="line"><span class="cl">Events:            &lt;none&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>修改后正常</p>
<p>数学理论基础实现的</p>
<p>配置文件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl">- <span class="nt">job_name</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;prometheus&#39;</span><span class="w"> </span><span class="l">首先定义任务名称</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>prometheus的客户端主要有两种方式采集</p>
<ul>
<li>pull 主动输影的形式</li>
<li>push 被动推送的形式</li>
</ul>
<h3 id="put">put</h3>
<p>put指的是客户端（被监控机器）先安装各类已有exporters（由社区组积或企业开发的监控客户端插件）在系统上之后，exporter以守护进程的模式运行并开始采集数据</p>
<p>exporter 本身也是一个htp_server 可以对http请求作出响应返回数据（KV metrics）</p>
<p>prometheua用pull 这种主动拉的方式（HTTP get）去访问每个节点上exporter并采样回需要的数据</p>
<h3 id="push">push：</h3>
<p>push指的是在客户端（或者服务端）安装这个官方提供的pushgateway插件然后，使用我们自行开发的各种脚本把监控数据组织成K/V的形式，metrics形式发送给pushgateway之后 puahgataway会再推送给prometheus</p>
<p>这种是一种被动的数据采集模式</p>
]]></content:encoded>
    </item>
    
  </channel>
</rss>
