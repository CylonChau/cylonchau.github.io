<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>elasticsearch on Cylon&#39;s Collection</title>
    <link>https://www.oomkill.com/categories/elasticsearch/</link>
    <description>Recent content in elasticsearch on Cylon&#39;s Collection</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>zh-cn</language>
    <lastBuildDate>Tue, 02 Nov 2021 00:00:00 +0000</lastBuildDate><atom:link href="https://www.oomkill.com/categories/elasticsearch/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>elasticsearch mapping</title>
      <link>https://www.oomkill.com/2021/11/elasticsearch-mapping/</link>
      <pubDate>Tue, 02 Nov 2021 00:00:00 +0000</pubDate>
      
      <guid>https://www.oomkill.com/2021/11/elasticsearch-mapping/</guid>
      <description></description>
      <content:encoded><![CDATA[<h2 id="索引管理">索引管理</h2>
<h3 id="创建索引">创建索引</h3>
<p>直接创建索引 <code>PUT newindex1</code>，创建索引可以通过 <code>number_of_shares</code> 和  <code>number_of_replicas</code> 数量来修饰分片和副本的数量。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">PUT newindex
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">  &#34;settings&#34;: {
</span></span><span class="line"><span class="cl">    &#34;index&#34; : {
</span></span><span class="line"><span class="cl">      &#34;number_of_shares&#34; : 2,
</span></span><span class="line"><span class="cl">      &#34;number_of_replicas&#34;: 1
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>number_of_shares</code> 分片数在创建索引后不能修改</p>
<p><code>number_of_replicas</code>  副本数可以随时完成修改</p>
<h3 id="删除索引">删除索引</h3>
<p><code>DEL index_name</code></p>
<h3 id="打开关闭索引">打开/关闭索引</h3>
<p><code>POST {index_name}/_close</code></p>
<p><code>POST {index_name}/_open</code></p>
<p>关闭的索引无法进行【增删改查】操作</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">  &#34;error&#34; : {
</span></span><span class="line"><span class="cl">    &#34;root_cause&#34; : [
</span></span><span class="line"><span class="cl">      {
</span></span><span class="line"><span class="cl">        &#34;type&#34; : &#34;index_closed_exception&#34;,
</span></span><span class="line"><span class="cl">        &#34;reason&#34; : &#34;closed&#34;,
</span></span><span class="line"><span class="cl">        &#34;index_uuid&#34; : &#34;3eCslZZ3Q9amlUyDtqTXWA&#34;,
</span></span><span class="line"><span class="cl">        &#34;index&#34; : &#34;newindex&#34;
</span></span><span class="line"><span class="cl">      }
</span></span><span class="line"><span class="cl">    ],
</span></span><span class="line"><span class="cl">    &#34;type&#34; : &#34;index_closed_exception&#34;,
</span></span><span class="line"><span class="cl">    &#34;reason&#34; : &#34;closed&#34;,
</span></span><span class="line"><span class="cl">    &#34;index_uuid&#34; : &#34;3eCslZZ3Q9amlUyDtqTXWA&#34;,
</span></span><span class="line"><span class="cl">    &#34;index&#34; : &#34;newindex&#34;
</span></span><span class="line"><span class="cl">  },
</span></span><span class="line"><span class="cl">  &#34;status&#34; : 400
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="索引的映射-mapping">索引的映射 mapping</h3>
<p>mapping是定义文档及包含字段的存储与索引方式。可以理解为是elasticsearch的表结构，定义mapping，即在创建index时，自行判断每个字段的类型，而不是有ES自动自动判断每个纬度的类型。这种更贴合业务场景，如分词、存储。</p>
<p>每个索引仅有一个映射类型（elasticsearch6.x+，之前版本一个索引下有多个类型），它决定了文档将如何被索引。而映射类型分为两部分 <code>meta-fields</code> 与 <code>field of properties</code></p>
<p><code>meta-fields</code> ：为文档的源数据，如 <code>_index</code> （索引的名称）、<code>_type</code> （文档的类型，7.0+弃用）、<code>_id</code> （索引的ID）和 <code>_source</code>（用于关联文档源数据）字段</p>
<p><code>field of properties</code>：字段属性，包含文档的字段或属性列表。</p>
<h4 id="字段的数据类型">字段的数据类型</h4>
<h5 id="常见类型">常见类型</h5>
<ul>
<li><code>binary</code>：二进制或Base64字符串。</li>
<li><code>boolean</code>: 布尔值<code>true</code>和<code>false</code>。</li>
<li><code>keywords</code>：<code>keyword</code>, <code>constant_keyword</code>, 和 <code>wildcard</code>.</li>
<li><code>Numbers</code>：数值类型，例如<code>long</code>和<code>double</code></li>
<li><code>dates</code>：日期类型，<code>date</code> 和 <code>date_nanos</code>。</li>
<li><code>alias</code>： 为以有字段定义别名。</li>
</ul>
<h5 id="对象嵌套类型">对象嵌套类型</h5>
<ul>
<li><code>object</code> ：JSON对象。</li>
<li><code>flattened</code>：整个JSON对象作为单个字段值。</li>
<li><code>nested</code>：嵌套，与子字段之间保留关系的json对象。</li>
<li><code>join</code>：为同一索引中的文档定义父/子关系。</li>
</ul>
<h5 id="结构化类型">结构化类型</h5>
<ul>
<li><code>range</code>：，<code>long_range</code>，<code>double_range</code>， <code>date_range</code>，和<code>ip_range</code>。</li>
<li><code>ip</code>：IPv4和IPv6地址。</li>
<li><code>version</code> ：软件版本号。支持 <a href="https://semver.org/">语义化版本号</a> 优先规则。</li>
<li><code>murmur3</code>：计算并存储值的散列。</li>
</ul>
<h5 id="汇总数据类型">汇总数据类型</h5>
<ul>
<li><code>aggregate_metric_double</code>：预汇总的指标值。</li>
<li><code>histogram</code>：以直方图形式预汇总的数值。</li>
</ul>
<h5 id="文字搜寻类型">文字搜寻类型</h5>
<ul>
<li><code>text</code>：分析的非结构化文本。</li>
<li><code>annotated-text</code>：包含特殊标记的文本。用于标识命名实体。</li>
<li><code>completion</code>：用于自动补全建议。</li>
<li><code>search_as_you_type</code> <code>text</code>类似类型，用于按需输入完成。</li>
<li><code>token_count</code>：计数令牌。</li>
</ul>
<p>等等 <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-types.html#object-types">reference</a>。</p>
<h4 id="常用字段数据类型参数">常用字段数据类型参数</h4>
<p>更多参数可以参考官方文档：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-params.html">mapping-params</a></p>
<table>
<thead>
<tr>
<th>字段</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>analyzer</td>
<td>仅<code>text</code>字段支持 <code>analyzer</code> 映射参数。</td>
</tr>
<tr>
<td>index</td>
<td>选项控制是否对字段值建立索引。默认为<code>true</code>。未索引的字段不可查询。</td>
</tr>
<tr>
<td>index_prefixes</td>
<td>启用术语前缀的索引，以加快前缀搜索的速度</td>
</tr>
<tr>
<td>ignore_above</td>
<td>长度大于 ignore_above设置的字符串将不会被索引或存储</td>
</tr>
</tbody>
</table>
<h4 id="映射的元字段">映射的元字段</h4>
<p>文档的元字段是保证系统正常运转的内置字段，如 <code>_index</code> 索引的字段  <code>_type</code>映射类型（7.0后取消），<code>_id_</code> 文档主键。</p>
<h4 id="动态映射-dynamic">动态映射 dynamic</h4>
<p>在关系型数据库中，需要事先创建好数据库，并在库中插入表。而ES中需要事先创建好索引结构（Mapping），在插入文档到索引中，系统会根据文档内容进行索引的动态映射。自动检测添加新类型和字段，被成为动态映射。</p>
<p>禁用动态映射：<code>{index_name}/_mapping </code>  <code>dynamic</code> 为false</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">POST student/_mapping
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">  &#34;dynamic&#34;:&#34;false&#34;
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">GET student/_mappings
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="显式映射">显式映射</h4>
<p>实现准备好映射关系，包含文档各字段类型，关系等，这种称之为显式映射 <code>Explicit mapping</code></p>
<h4 id="动态模板">动态模板</h4>
<p>动态映射会自动推断数据类型，但这种并不完全符合所有的业务需求，而动态模板可以再动态映射之外更好的控制ES如何映射的数据类型。</p>
<h5 id="模板的匹配">模板的匹配</h5>
<ul>
<li><code>match_mapping_type</code> 对 Elasticsearch 检测到的数据类型进行操作</li>
<li><code>match</code>   <code>unmatch </code>  ： <code>match</code>使用pattern匹配字段名称，<code>unmatch</code> 使用正则排除字段</li>
<li><code>path_match</code>   <code>path_unmatch</code> 使用与match一样，这里为全名称，path指的是多层json的路径。</li>
</ul>
<p>如，需要将所有数字字段映射为integer而不是long，将所有字符串都映射为text与keyword:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">  &#34;mappings&#34;: {
</span></span><span class="line"><span class="cl">    &#34;dynamic_templates&#34;: [
</span></span><span class="line"><span class="cl">      {
</span></span><span class="line"><span class="cl">        &#34;integers&#34;: {
</span></span><span class="line"><span class="cl">          &#34;match_mapping_type&#34;: &#34;long&#34;,
</span></span><span class="line"><span class="cl">          &#34;mapping&#34;: {
</span></span><span class="line"><span class="cl">            &#34;type&#34;: &#34;integer&#34;
</span></span><span class="line"><span class="cl">          }
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">      },
</span></span><span class="line"><span class="cl">      {
</span></span><span class="line"><span class="cl">        &#34;strings&#34;: {
</span></span><span class="line"><span class="cl">          &#34;match_mapping_type&#34;: &#34;string&#34;,
</span></span><span class="line"><span class="cl">          &#34;mapping&#34;: {
</span></span><span class="line"><span class="cl">            &#34;type&#34;: &#34;text&#34;,
</span></span><span class="line"><span class="cl">            &#34;fields&#34;: {
</span></span><span class="line"><span class="cl">              &#34;raw&#34;: {
</span></span><span class="line"><span class="cl">                &#34;type&#34;:  &#34;keyword&#34;,
</span></span><span class="line"><span class="cl">                &#34;ignore_above&#34;: 256
</span></span><span class="line"><span class="cl">              }
</span></span><span class="line"><span class="cl">            }
</span></span><span class="line"><span class="cl">          }
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">      }
</span></span><span class="line"><span class="cl">    ]
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以使用正则表达式来匹配字段</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">PUT student12345
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">  &#34;mappings&#34;: {
</span></span><span class="line"><span class="cl">    &#34;dynamic_templates&#34;: [
</span></span><span class="line"><span class="cl">      {
</span></span><span class="line"><span class="cl">        &#34;longs_as_strings&#34;: {
</span></span><span class="line"><span class="cl">          &#34;match_mapping_type&#34;: &#34;string&#34;,  // 捕获的类型
</span></span><span class="line"><span class="cl">          &#34;match&#34;:   &#34;pass*&#34;, // 将以pass开头的string类型的映射为integer
</span></span><span class="line"><span class="cl">          &#34;unmatch&#34;: &#34;user*&#34;, // 忽略以user开头的
</span></span><span class="line"><span class="cl">          &#34;mapping&#34;: {
</span></span><span class="line"><span class="cl">            &#34;type&#34;: &#34;integer&#34;  // 需要映射的类型
</span></span><span class="line"><span class="cl">          }
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">      }
</span></span><span class="line"><span class="cl">    ]
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">PUT student12345/_doc/1
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">  &#34;username&#34;: &#34;zhangsan&#34;, 
</span></span><span class="line"><span class="cl">  &#34;password&#34;: &#34;123456&#34; 
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>查看映射后的类型</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">  &#34;student12345&#34; : {
</span></span><span class="line"><span class="cl">    &#34;mappings&#34; : {
</span></span><span class="line"><span class="cl">      &#34;dynamic_templates&#34; : [
</span></span><span class="line"><span class="cl">        {
</span></span><span class="line"><span class="cl">          &#34;longs_as_strings&#34; : {
</span></span><span class="line"><span class="cl">            &#34;match&#34; : &#34;pass*&#34;,
</span></span><span class="line"><span class="cl">            &#34;unmatch&#34; : &#34;user*&#34;,
</span></span><span class="line"><span class="cl">            &#34;match_mapping_type&#34; : &#34;string&#34;,
</span></span><span class="line"><span class="cl">            &#34;mapping&#34; : {
</span></span><span class="line"><span class="cl">              &#34;type&#34; : &#34;integer&#34;
</span></span><span class="line"><span class="cl">            }
</span></span><span class="line"><span class="cl">          }
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">      ],
</span></span><span class="line"><span class="cl">      &#34;properties&#34; : {
</span></span><span class="line"><span class="cl">        &#34;password&#34; : {
</span></span><span class="line"><span class="cl">          &#34;type&#34; : &#34;integer&#34;
</span></span><span class="line"><span class="cl">        },
</span></span><span class="line"><span class="cl">        &#34;username&#34; : {
</span></span><span class="line"><span class="cl">          &#34;type&#34; : &#34;text&#34;,
</span></span><span class="line"><span class="cl">          &#34;fields&#34; : {
</span></span><span class="line"><span class="cl">            &#34;keyword&#34; : {
</span></span><span class="line"><span class="cl">              &#34;type&#34; : &#34;keyword&#34;,
</span></span><span class="line"><span class="cl">              &#34;ignore_above&#34; : 256
</span></span><span class="line"><span class="cl">            }
</span></span><span class="line"><span class="cl">          }
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">      }
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>path_match</code>   <code>path_unmatch</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="err">PUT</span> <span class="err">test</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;mappings&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;dynamic_templates&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;full_name&#34;</span><span class="p">:</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;path_match&#34;</span><span class="p">:</span>   <span class="s2">&#34;document.*&#34;</span><span class="p">,</span> <span class="c1">// 将name下的所有对象复制到外部顶级字段
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="nt">&#34;path_unmatch&#34;</span><span class="p">:</span> <span class="s2">&#34;*.middlename&#34;</span><span class="p">,</span> <span class="c1">// 这个字段除外
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="nt">&#34;mapping&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;type&#34;</span><span class="p">:</span>       <span class="s2">&#34;text&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;copy_to&#34;</span><span class="p">:</span>    <span class="s2">&#34;full_name&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">PUT</span> <span class="err">test</span><span class="mi">1</span><span class="err">/_doc/</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;document&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;firstname&#34;</span><span class="p">:</span>  <span class="s2">&#34;John&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;middlename&#34;</span><span class="p">:</span> <span class="s2">&#34;Winston&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;lastname&#34;</span><span class="p">:</span>   <span class="s2">&#34;Lennon&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>当插入下列时，不成功，这里映射类型为text，与address中的对象类型不匹配所以不成功</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">PUT test1/_doc/1
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">  &#34;document&#34;: {
</span></span><span class="line"><span class="cl">    &#34;firstname&#34;:  &#34;John&#34;,
</span></span><span class="line"><span class="cl">    &#34;middlename&#34;: &#34;Winston&#34;,
</span></span><span class="line"><span class="cl">    &#34;address&#34;: {
</span></span><span class="line"><span class="cl">    	&#34;city&#34;: &#34;beijing&#34;,
</span></span><span class="line"><span class="cl">    	&#34;province&#34;: &#34;beijing&#34;,
</span></span><span class="line"><span class="cl"> 			&#34;District&#34;: &#34;haidian&#34;
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="模板变量">模板变量</h5>
<p>{name} {dynamic_type} 占位符，在映射中会替换为字段名和检测到的动态类型</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="err">PUT</span> <span class="err">student</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;mappings&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;dynamic_templates&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;named_analyzers&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;match_mapping_type&#34;</span><span class="p">:</span> <span class="s2">&#34;string&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;match&#34;</span><span class="p">:</span> <span class="s2">&#34;*&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;mapping&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;text&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;analyzer&#34;</span><span class="p">:</span> <span class="s2">&#34;{name}&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;no_doc_values&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;match_mapping_type&#34;</span><span class="p">:</span><span class="s2">&#34;*&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;mapping&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;{dynamic_type}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;doc_values&#34;</span><span class="p">:</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">PUT</span> <span class="err">student</span><span class="mi">1</span><span class="err">/_doc/</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;alex chow&#34;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">30</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="err">PUT</span> <span class="err">student</span><span class="mi">1</span><span class="err">/_doc/</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;english&#34;</span><span class="p">:</span> <span class="s2">&#34;Some English text&#34;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;count&#34;</span><span class="p">:</span>   <span class="mi">5</span> 
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>reference</strong>  <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/dynamic-templates.html#template-variables">template-variables</a></p>
<h4 id="索引的类型">索引的类型</h4>
<p>Elasticsearch7.x中，不在需要document的 type</p>
<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/removal-of-types.html#_schedule_for_removal_of_mapping_types">schedule_for_removal_of_mapping_types</a></p>
<p>ElasticSearch在7.x版本之前 <code>index</code> 类似于数据库中的 <code>database</code>，而 <code>type</code> 等同于数据库中的 <code>table</code></p>
<p>如：6.x API</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">PUT student # index（库）
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">  &#34;mappings&#34;: {
</span></span><span class="line"><span class="cl">    &#34;_doc&#34;: { # type （表）
</span></span><span class="line"><span class="cl">      &#34;properties&#34;: {
</span></span><span class="line"><span class="cl">        &#34;type&#34;: { # filed (字段)
</span></span><span class="line"><span class="cl">          &#34;type&#34;: &#34;keyword&#34;
</span></span><span class="line"><span class="cl">        },
</span></span><span class="line"><span class="cl">        &#34;name&#34;: {
</span></span><span class="line"><span class="cl">          &#34;type&#34;: &#34;text&#34;
</span></span><span class="line"><span class="cl">        },
</span></span><span class="line"><span class="cl">        &#34;user_name&#34;: {
</span></span><span class="line"><span class="cl">          &#34;type&#34;: &#34;keyword&#34;
</span></span><span class="line"><span class="cl">        },
</span></span><span class="line"><span class="cl">        &#34;email&#34;: {
</span></span><span class="line"><span class="cl">          &#34;type&#34;: &#34;keyword&#34;
</span></span><span class="line"><span class="cl">        },
</span></span><span class="line"><span class="cl">        &#34;content&#34;: {
</span></span><span class="line"><span class="cl">          &#34;type&#34;: &#34;text&#34;
</span></span><span class="line"><span class="cl">        },
</span></span><span class="line"><span class="cl">        &#34;tweeted_at&#34;: {
</span></span><span class="line"><span class="cl">          &#34;type&#34;: &#34;date&#34;
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">      }
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>而在7.x之后版本可以不需要</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">PUT student
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">  &#34;mappings&#34;: {
</span></span><span class="line"><span class="cl">      &#34;properties&#34;: {
</span></span><span class="line"><span class="cl">        &#34;type&#34;: {
</span></span><span class="line"><span class="cl">          &#34;type&#34;: &#34;keyword&#34;
</span></span><span class="line"><span class="cl">        },
</span></span><span class="line"><span class="cl">        &#34;name&#34;: {
</span></span><span class="line"><span class="cl">          &#34;type&#34;: &#34;text&#34;
</span></span><span class="line"><span class="cl">        },
</span></span><span class="line"><span class="cl">        &#34;user_name&#34;: {
</span></span><span class="line"><span class="cl">          &#34;type&#34;: &#34;keyword&#34;
</span></span><span class="line"><span class="cl">        },
</span></span><span class="line"><span class="cl">        &#34;email&#34;: {
</span></span><span class="line"><span class="cl">          &#34;type&#34;: &#34;keyword&#34;
</span></span><span class="line"><span class="cl">        },
</span></span><span class="line"><span class="cl">        &#34;content&#34;: {
</span></span><span class="line"><span class="cl">          &#34;type&#34;: &#34;text&#34;
</span></span><span class="line"><span class="cl">        },
</span></span><span class="line"><span class="cl">        &#34;tweeted_at&#34;: {
</span></span><span class="line"><span class="cl">          &#34;type&#34;: &#34;date&#34;
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">      }
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>在7.0以上版本使用时，必须使用 <code>/{index_name}/_doc/{_id}</code> 进行调用。</p>
<p><code>_doc</code> 为路由永久组成，可以理解为 <code>_doc</code> 替换之前的 <code>type</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">PUT /student/_doc/1
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">  &#34;name&#34;: &#34;zhangsan&#34;,
</span></span><span class="line"><span class="cl">  &#34;user_name&#34;: &#34;zhangsan&#34;,
</span></span><span class="line"><span class="cl">  &#34;email&#34;: &#34;1@gmail.com&#34;,
</span></span><span class="line"><span class="cl">  &#34;content&#34;: &#34;北京分行、天津分行、河北分行、山西分行、辽宁分行&#34;
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">GET /student/_doc/1
</span></span></code></pre></td></tr></table>
</div>
</div><p>对于7.0之前的<code>/{index}/{type}/{action}</code> ，的操作如<code>_update</code> 、<code>_search</code> 将紧跟<code>{action}</code>后面。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">POST /student/_update/1
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">  &#34;doc&#34;: {
</span></span><span class="line"><span class="cl">    &#34;user_name&#34;: &#34;lisi&#34;
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">GET /student/_search
</span></span></code></pre></td></tr></table>
</div>
</div>]]></content:encoded>
    </item>
    
    <item>
      <title>elasticsearch安装</title>
      <link>https://www.oomkill.com/2018/11/es/</link>
      <pubDate>Fri, 02 Nov 2018 00:00:00 +0000</pubDate>
      
      <guid>https://www.oomkill.com/2018/11/es/</guid>
      <description></description>
      <content:encoded><![CDATA[<h2 id="1-elasticsearch介绍">1 elasticsearch介绍</h2>
<p>ES是一个基于Lucene实现的开源、分布式、基于Restful风格的全文本搜索引擎；此外，它还是一个分布式实时文档存储，其中每个文档的每个field均是被索引的数据，且可被搜索：也是一个带实时分析功能的分布式搜索引擎，能够扩展至数以百计的节点实时处理PB级的数据。</p>
<h3 id="11-elasticsearch基本组件">1.1 elasticsearch基本组件</h3>
<p>索引（index）：文档容器，换句话说，索引是具有类似属性的文档的集合。类似于表。索引名必须使用小写字母：</p>
<p>类型（type）：类型是索引内部的逻辑分区，其意义完全取决于用户需求。一个索引内部可定义一个或多个类型。一般来说，类型就是拥有相同的域的文档的预定义。</p>
<p>文档（document）：文档是Lucene索引和搜索的原子单位，它包含了一个或多个域。是域的容器：基于J50N格式表示。每个域的组成部分：一个名字，一个或多个值；拥有多个值的域，通常称为多值域：</p>
<p>映射（mapping）：原始内容存储为文档之前需要事先进行分析，例如切词、过滤掉某些词等：映射用于定义此分析机制该如何实现；除此之外，ES还为映射提供了诸如将域中的内容排序等功能。</p>
<h3 id="12-es的集群组件">1.2 es的集群组件</h3>
<p>cluster: es的集群标识为集群名称：默认“elasticsearch”。节点就是靠此名字来决定加入到哪个集群中。一个节点只能属性于一个集群。</p>
<p>Node：运行了单个es实例的主机即为节点。用于存储数据、参与集群索引及搜索操作。节点的标识靠节点名。</p>
<p>Shard：将索引切割成为的物理存储组件：但每一个shard都是一个独立且完整的索引；创建索引时，ES默认将其分割为5个shard，用户也可以按需自定义，创建完成之后不可修改。</p>
<p>shard有两种类型：primary shard和replica。replica用于数据冗余及查询时的负载均衡。每个主shard的副本数量可自定义，且可动态修改。</p>
<h3 id="13-es的工作过程">1.3 es的工作过程</h3>
<p>es节点启动时默认通过多播方式或单播方式在TCP协议的9300端口查找同一集群中的其他节点，并与之建立通讯。判断是否为同一集群的标准为集群名称，集群中的所有节点会选举出一个主节点负责管理整个集群状态，以及在集群范围内决定各shared的分布方式。站在用户使用中角度而言，每个节点都可以接收并相应各类请求，无需区分哪个为主节点。</p>
<p>当集群中某一节点为down状态时，主节点会读取集群状态信息，并启动修复过程。此过程中主节点会检查所有可用shared的主shared，并确定主shared是否存在。各种shared及对应副本shared是否对数。此时集群状态会转换为yellow。</p>
<p>es集群有三种状态：green、red（不可用）、yellow（修复状态）。</p>
<p>当某状态为down的节点上存在主shared，此时需要从各副本shared中找一个提升为主shared。在yellow状态时，各副本shared均处于未分配模式。此时各个副本都不可用，只能使用主shared。集群虽可基于各组shared进行查询，但此时吞吐能力有限。yellows属于残破不全状态。</p>
<p>接下来的过程中，主节点将会查找所有的冗余shard，并将其配置为主shared。如果某shared的副本数量少于配置参数的数量，会自动启动复制过程，并为其建立副本shared。直至所有条件都满足从yellow转换至green。</p>
<p>es工作过程中主节点会周期性检查各节点是否处于可用状态，任意节点不可用时，修复模式都会启动，此时集群将会进入重新均衡过程。</p>
<h2 id="2-安装elasticsearch">2 安装elasticsearch</h2>
<p>下载地址：http://www.elastic.co/cn/downloads/elasticsearch</p>
<p></p>
<p></p>
<p>官方文档中写明对es每个版本对jdk的要求。</p>
<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html">https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html</a></p>
<h3 id="21-常用es配置文件说明">2.1 常用es配置文件说明</h3>
<p>修改配置文件：<font color="#f8070d" size=3><code>/etc/elasticsearch/elasticsearch.yml</code></font></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">cluster.name: test1 <span class="c1">#←集群名称，同一网段下可以有多个集群，通过名称区分不同的集群。</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">node.name: node-1  <span class="c1">#←节点名</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">node.master: <span class="nb">true</span> <span class="c1">#←是否有资格被选举成为node</span>
</span></span><span class="line"><span class="cl">node.data: <span class="nb">true</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># es5中已废弃</span>
</span></span><span class="line"><span class="cl">index.number_of_shards: <span class="m">5</span>  <span class="c1">#←默认索引分片个数，默认为5片。</span>
</span></span><span class="line"><span class="cl">index.number_of_replicas: 1	 <span class="c1">#←默认索引副本个数，默认为1个副本</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">path.conf: /path/to/conf   <span class="c1">#←文件的存储路径</span>
</span></span><span class="line"><span class="cl">path.data: /path/to/data   <span class="c1">#←索引数据的存储路径，多个存储路径，用逗号隔开</span>
</span></span><span class="line"><span class="cl">path.work: /path/to/work   <span class="c1">#←日志文件的存储路径</span>
</span></span><span class="line"><span class="cl">path.plugins: /path/to/plugins   <span class="c1">#←插件的存放路径</span>
</span></span><span class="line"><span class="cl">network.bind_host: 192.168.0.1   <span class="c1">#←绑定的ip地址 </span>
</span></span><span class="line"><span class="cl">network.publish_host: 192.168.0.1  <span class="c1">#←设置其它节点和该节点交互的ip地址</span>
</span></span><span class="line"><span class="cl">network.host: 192.168.0.1  <span class="c1">#←同时设置bind_host和publish_host</span>
</span></span><span class="line"><span class="cl">transport.tcp.port: <span class="m">9300</span>  <span class="c1">#←节点之间交互的tcp端口，默认是9300。</span>
</span></span><span class="line"><span class="cl">http.port: <span class="m">9200</span>   <span class="c1">#←设置对外服务的http端口，默认为9200。</span>
</span></span><span class="line"><span class="cl">transport.tcp.compress: <span class="nb">true</span>   <span class="c1">#←设置是否压缩tcp传输时的数据，默认false不压缩</span>
</span></span><span class="line"><span class="cl">http.max_content_length: 100mb  <span class="c1">#←内容的最大容量，默认100mb</span>
</span></span><span class="line"><span class="cl">http.enabled: <span class="nb">false</span>   <span class="c1">#←使用http协议对外提供服务，默认为true开启。</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#←默认为local即为本地文件系统，可以设置为本地文件系统，</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 分布式文件系统，hadoop的HDFS，和amazon的s3服务器等。</span>
</span></span><span class="line"><span class="cl">gateway.type: <span class="nb">local</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">gateway.expected_nodes: <span class="m">2</span>   <span class="c1">#←集群中节点的数量，默认为2。</span>
</span></span><span class="line"><span class="cl">discovery.zen.ping.timeout: 3s <span class="c1">#←自动发现其它节点时ping连接超时时间，默认为3秒	</span>
</span></span><span class="line"><span class="cl">discovery.zen.ping.multicast.enabled: <span class="nb">false</span>  <span class="c1">#←打开多播发现节点，默认是true。</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 设置集群中master节点的初始列表，可以通过这些节点来自动发现新加入集群的节点。</span>
</span></span><span class="line"><span class="cl">discovery.zen.ping.unicast.hosts: <span class="o">[</span><span class="s2">&#34;host1&#34;</span>, <span class="s2">&#34;host2:port&#34;</span>, <span class="s2">&#34;host3[portX-portY]&#34;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 当你无法关闭系统的swap的时候，建议把这个参数设为true。</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 防止在内存不够用的时候，elasticsearch的内存被交换至交换区，导致性能骤降</span>
</span></span><span class="line"><span class="cl">bootstrap.mlockal1: <span class="nb">true</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>参考：https://www.cnblogs.com/hanyouchun/p/5163183.html
修改启动脚本设置启动参数： <font color="#f8070d" size=3><code>/usr/share/elasticsearch/bin/elasticsearch</code></font></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">JAVA_HOME</span><span class="o">=</span>/usr/local/jdk
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span><span class="nv">$JAVA_HOME</span>/bin:<span class="nv">$PATH</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>es2.x支持方式</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">ES_HEAP_SIZE</span><span class="o">=</span>256m
</span></span></code></pre></td></tr></table>
</div>
</div><p>es5.x支持方式</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ cat /etc/elasticsearch/jvm.options 
</span></span><span class="line"><span class="cl">-Xms128m
</span></span><span class="line"><span class="cl">-Xmx128m
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="22-安装head插件">2.2 安装head插件</h3>
<p>官方网站：https://github.com/mobz/elasticsearch-head#running-with-built-in-server</p>
<p>对于elasticsearch2.x</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">elasticsearch/bin/plugin install file:///root/elasticsearch-head.zip
</span></span></code></pre></td></tr></table>
</div>
</div><p>对于Elasticsearch 5.x，head不支持网站插件。作为独立服务器运行。
<a href="https://www.cnblogs.com/alice626/p/6206722.html">https://www.cnblogs.com/alice626/p/6206722.html</a></p>
<p><a href="https://www.cnblogs.com/xing901022/p/6030296.html">https://www.cnblogs.com/xing901022/p/6030296.html</a></p>
<p><a href="https://www.cnblogs.com/valor-xh/p/6293689.html">https://www.cnblogs.com/valor-xh/p/6293689.html</a></p>
<p><a href="https://github.com/mobz/elasticsearch-head">https://github.com/mobz/elasticsearch-head</a>，github上下载压缩包。</p>
<p>因为head为独立启动的，所以随便放置任意目录即可。</p>
<h4 id="221-安装nodejs">2.2.1 安装node.js</h4>
<p><a href="https://nodejs.org/en/download/">https://nodejs.org/en/download/</a></p>
<p>解压后设置环境变量</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">NODE_HOME</span><span class="o">=</span>/usr/local/node-v6.9.1-linux-x64 
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:<span class="nv">$NODE_HOME</span>/bin
</span></span></code></pre></td></tr></table>
</div>
</div><p>检查环境变量</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ node -v
</span></span><span class="line"><span class="cl">v8.11.2
</span></span><span class="line"><span class="cl">$ npm -v
</span></span><span class="line"><span class="cl">5.6.0
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="222-安装grunt">2.2.2 安装grunt</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">npm install grunt-cli
</span></span><span class="line"><span class="cl">$ grunt -version
</span></span><span class="line"><span class="cl">grunt-cli v1.2.0
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="223-修改head配置">2.2.3 修改head配置</h4>
<p>head/Gruntfile.js，增加hostname属性，设置为*</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="nx">connect</span><span class="o">:</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl"> 	<span class="nx">server</span><span class="o">:</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl"> 		<span class="nx">options</span><span class="o">:</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl"> 			<span class="nx">port</span><span class="o">:</span> <span class="mi">9100</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">  			<span class="nx">hostname</span><span class="o">:</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl"> 			<span class="nx">base</span><span class="o">:</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl"> 			<span class="nx">keepalive</span><span class="o">:</span> <span class="kc">true</span> 
</span></span><span class="line"><span class="cl"> 		<span class="p">}</span> 
</span></span><span class="line"><span class="cl"> 	<span class="p">}</span> 
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>修改连接地址
head/_site/app.js</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="k">this</span><span class="p">.</span><span class="nx">base_uri</span> <span class="o">=</span> 
</span></span><span class="line"><span class="cl"><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">base_uri</span> <span class="o">||</span> 
</span></span><span class="line"><span class="cl"><span class="k">this</span><span class="p">.</span><span class="nx">prefs</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&#34;app-base_uri&#34;</span><span class="p">)</span> <span class="o">||</span> 
</span></span><span class="line"><span class="cl"><span class="s2">&#34;http://10.0.0.12:19200&#34;</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="224-运行head">2.2.4 运行head</h4>
<p>在head目录下，执行npm install 下载以来的包：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">nmp install
</span></span></code></pre></td></tr></table>
</div>
</div><p>出现如下报错</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">Please report this full log at https://github.com/Medium/phantomjs
</span></span><span class="line"><span class="cl">npm ERR! Darwin 15.0.0
</span></span><span class="line"><span class="cl">npm ERR! argv <span class="s2">&#34;/usr/local/bin/node&#34;</span> <span class="s2">&#34;/usr/local/bin/npm&#34;</span> <span class="s2">&#34;install&#34;</span>
</span></span><span class="line"><span class="cl">npm ERR! node v4.4.3
</span></span><span class="line"><span class="cl">npm ERR! npm  v3.10.9
</span></span><span class="line"><span class="cl">npm ERR! code ELIFECYCLE
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">npm ERR! phantomjs-prebuilt@2.1.14 install: <span class="sb">`</span>node install.js<span class="sb">`</span>
</span></span><span class="line"><span class="cl">npm ERR! Exit status <span class="m">1</span>
</span></span><span class="line"><span class="cl">npm ERR! 
</span></span><span class="line"><span class="cl">npm ERR! Failed at the phantomjs-prebuilt@2.1.14 install script <span class="err">&#39;</span>node install.js
</span></span></code></pre></td></tr></table>
</div>
</div><p>解决方法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">npm install phantomjs-prebuilt@2.1.14 --ignore-scripts
</span></span></code></pre></td></tr></table>
</div>
</div><p>运行head</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">grunt server <span class="p">&amp;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>设置http对外提供服务</p>
<h3 id="23-安装bigdesk">2.3 安装bigdesk</h3>
<p><a href="https://github.com/hlstudio/bigdesk">https://github.com/hlstudio/bigdesk</a></p>
<p>下载bigdesk</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ <span class="nb">cd</span> bigdesk-master
</span></span><span class="line"><span class="cl">$ ll
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">bigdesk_es2.png
</span></span><span class="line"><span class="cl">LICENSE
</span></span><span class="line"><span class="cl">NOTICE
</span></span><span class="line"><span class="cl">plugin-descriptor.properties
</span></span><span class="line"><span class="cl">README.md
</span></span><span class="line"><span class="cl">【_site】
</span></span></code></pre></td></tr></table>
</div>
</div><p>进入_site目录</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">python -m SimpleHTTPServer port <span class="m">8000</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p></p>
<p>marven、kopf</p>
<p>2.x plugin 访问 <font color="#f8070d" size=3><code>9200/_plugin/head</code></font></p>
<h2 id="3-es使用">3 ES使用</h2>
<h3 id="31-es-api介绍">3.1 es api介绍</h3>
<p>elasticsearch支持的是Restful风格的API接口</p>
<p>restuful介绍：
<a href="http://www.ruanyifeng.com/blog/2014/05/restful_api.html?bsh_bid=516759003">http://www.ruanyifeng.com/blog/2014/05/restful_api.html?bsh_bid=516759003</a></p>
<p>四类API：</p>
<ul>
<li>检查集群、节点、索引等健康与否，以及获取其相应状态。</li>
<li>管理集群、节点、索引及元数据。</li>
<li>执行CRUD操作。</li>
<li>执行高级操作，例如paging,filtering等。</li>
</ul>
<h3 id="32-es-api使用">3.2 es api使用</h3>
<p>E5访问接口：tcp/9200</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">curl -X <span class="o">[</span>VERB<span class="o">]</span> <span class="o">[</span>PROTOCOL<span class="o">]</span>://HOST:PORT/<span class="o">[</span>PATH<span class="o">]</span>?<span class="o">[</span>QUERY_STR<span class="o">]</span> -d <span class="s1">&#39;&lt;BODY&gt;&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>VERB：GET,PUT,DELETE等。</li>
<li>PROTOCOL：http,https。</li>
<li>QUERY_STRING：查询参数，例如？pretty表示用易读的JSON格式输出。</li>
<li>BODY：请求的主体。</li>
</ul>
<h4 id="321-查看es工作状态">3.2.1 查看es工作状态</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ curl http://10.0.0.12:19200/?pretty
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;name&#34;</span> : <span class="s2">&#34;node-1&#34;</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;cluster_name&#34;</span> : <span class="s2">&#34;test1&#34;</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;version&#34;</span> : <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;number&#34;</span> : <span class="s2">&#34;2.0.0&#34;</span>,
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;build_hash&#34;</span> : <span class="s2">&#34;de54438d6af8f9340d50c5c786151783ce7d6be5&#34;</span>,
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;build_timestamp&#34;</span> : <span class="s2">&#34;2015-10-22T08:09:48Z&#34;</span>,
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;build_snapshot&#34;</span> : false,
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;lucene_version&#34;</span> : <span class="s2">&#34;5.2.1&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;tagline&#34;</span> : <span class="s2">&#34;You Know, for Search&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>查看集群工作状态，?v查看详细信息。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ curl 127.0.0.1:19200/_cat/nodes?v
</span></span><span class="line"><span class="cl">ip        heap.percent ram.percent cpu load_1m load_5m load_15m node.role master name
</span></span><span class="line"><span class="cl">10.0.0.9            <span class="m">27</span>          <span class="m">90</span>   <span class="m">1</span>    0.07    0.03     0.05 mdi       -      node-1
</span></span><span class="line"><span class="cl">10.0.0.12           <span class="m">46</span>          <span class="m">91</span>   <span class="m">0</span>    0.00    0.01     0.05 mdi       *      node-2
</span></span></code></pre></td></tr></table>
</div>
</div><p>health：查看当前集群健康状态的相关信息</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ curl 127.0.0.1:19200/_cat/health?pretty
</span></span><span class="line"><span class="cl"><span class="m">1526839934</span> 02:12:14 <span class="nb">test</span> green <span class="m">2</span> <span class="m">2</span> <span class="m">0</span> <span class="m">0</span> <span class="m">0</span> <span class="m">0</span> <span class="m">0</span> <span class="m">0</span> - 100.0%
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ curl 127.0.0.1:19200/_cat/health?v
</span></span><span class="line"><span class="cl">epoch      timestamp cluster status node.total node.data shards pri relo init unassign pending_tasks max_task_wait_time active_shards_percent
</span></span><span class="line"><span class="cl"><span class="m">1526841115</span> 02:31:55  <span class="nb">test</span>    green           <span class="m">2</span>         <span class="m">2</span>      <span class="m">0</span>   <span class="m">0</span>    <span class="m">0</span>    <span class="m">0</span>        <span class="m">0</span>             <span class="m">0</span>                  -                100.0%
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="322-自定义查询">3.2.2 自定义查询</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ curl 127.0.0.1:19200/_cat/nodes?h<span class="o">=</span>ip,name,port,uptime,heap.current
</span></span><span class="line"><span class="cl">10.0.0.9  node-1 <span class="m">19300</span> 40.7m 107.2mb mdi
</span></span><span class="line"><span class="cl">10.0.0.12 node-2 <span class="m">19300</span>   57m  89.6mb mdi
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ curl 127.0.0.1:19200/_cat/master?v 
</span></span><span class="line"><span class="cl">id                     host      ip        node
</span></span><span class="line"><span class="cl">CorsR-_VSN2YHj5DCRXiKg 10.0.0.12 10.0.0.12 node-2
</span></span></code></pre></td></tr></table>
</div>
</div><p>官方文档：https://www.elastic.co/guide/en/elasticsearch/reference/6.2/index.html</p>
<h4 id="323-state-api">3.2.3 state api</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="err">curl</span> <span class="mf">127.0</span><span class="err">.</span><span class="mf">0.1</span><span class="err">:</span><span class="mi">19200</span><span class="err">/_cluster/state/nodes?pretty</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;cluster_name&#34;</span> <span class="p">:</span> <span class="s2">&#34;test&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;compressed_size_in_bytes&#34;</span> <span class="p">:</span> <span class="mi">276</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;nodes&#34;</span> <span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;cplyIE3WS3a4sKRhjYQPoQ&#34;</span> <span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;name&#34;</span> <span class="p">:</span> <span class="s2">&#34;node-1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;ephemeral_id&#34;</span> <span class="p">:</span> <span class="s2">&#34;axJ2wLcZRxyMMfLP7J54HA&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;transport_address&#34;</span> <span class="p">:</span> <span class="s2">&#34;10.0.0.9:19300&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;attributes&#34;</span> <span class="p">:</span> <span class="p">{</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;CorsR-_VSN2YHj5DCRXiKg&#34;</span> <span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;name&#34;</span> <span class="p">:</span> <span class="s2">&#34;node-2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;ephemeral_id&#34;</span> <span class="p">:</span> <span class="s2">&#34;UTGxkPRYSRO_wU_URX_taw&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;transport_address&#34;</span> <span class="p">:</span> <span class="s2">&#34;10.0.0.12:19300&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;attributes&#34;</span> <span class="p">:</span> <span class="p">{</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>curl 127.0.0.1:19200/_cluster/state/nodes?pretty
curl 127.0.0.1:19200/_nodes/state?pretty
<a href="https://www.elastic.co/guide/en/elasticsearch/reference/6.2/cluster-state.html">https://www.elastic.co/guide/en/elasticsearch/reference/6.2/cluster-state.html</a></p>
<h3 id="33-crud-api">3.3 crud api</h3>
<h4 id="331-创建索引">3.3.1 创建索引</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="err">curl</span> <span class="err">-X</span> <span class="err">PUT</span> <span class="err">-H</span> <span class="s2">&#34;Content-Type: application/json&#34;</span> <span class="err">http:</span><span class="c1">//127.0.0.1:19200/students/NO/1?pretty -d &#39;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="nt">&#34;first_name&#34;</span><span class="p">:</span> <span class="s2">&#34;jing&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="nt">&#34;last_name&#34;</span> <span class="p">:</span> <span class="s2">&#34;guo&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="nt">&#34;gender&#34;</span> <span class="p">:</span> <span class="s2">&#34;male&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="nt">&#34;age&#34;</span> <span class="p">:</span><span class="s2">&#34;25&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="nt">&#34;courses&#34;</span><span class="p">:</span> <span class="s2">&#34;xianglong shiba zhang&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span><span class="err">&#39;</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;_index&#34;</span> <span class="p">:</span> <span class="s2">&#34;students&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;_type&#34;</span> <span class="p">:</span> <span class="s2">&#34;NO&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="s2">&#34;1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;_version&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;result&#34;</span> <span class="p">:</span> <span class="s2">&#34;created&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;_shards&#34;</span> <span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;total&#34;</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;successful&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;failed&#34;</span> <span class="p">:</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;_seq_no&#34;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;_primary_term&#34;</span> <span class="p">:</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="err">&#39;</span><span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="nt">&#34;first_name&#34;</span><span class="p">:</span> <span class="s2">&#34;rong&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="nt">&#34;last_name&#34;</span> <span class="p">:</span> <span class="s2">&#34;huang&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="nt">&#34;gender&#34;</span> <span class="p">:</span> <span class="s2">&#34;female&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="nt">&#34;age&#34;</span> <span class="p">:</span><span class="mi">23</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="nt">&#34;courses&#34;</span><span class="p">:</span> <span class="s2">&#34;luoying shenjian zhang&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span><span class="err">&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">curl -XGET http://127.0.0.1:19200/students/NO/1?pretty
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;_index&#34;</span> : <span class="s2">&#34;students&#34;</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;_type&#34;</span> : <span class="s2">&#34;NO&#34;</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;_id&#34;</span> : <span class="s2">&#34;1&#34;</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;_version&#34;</span> : 2,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;found&#34;</span> : true,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;_source&#34;</span> : <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;first_name&#34;</span> : <span class="s2">&#34;rong&#34;</span>,
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;last_name&#34;</span> : <span class="s2">&#34;huang&#34;</span>,
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;gender&#34;</span> : <span class="s2">&#34;female&#34;</span>,
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;age&#34;</span> : 23,
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;courses&#34;</span> : <span class="s2">&#34;luoying shenjian zhang&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="332-更新文档">3.3.2 更新文档</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">curl -X POST -H <span class="s2">&#34;Content-Type: application/json&#34;</span> http://127.0.0.1:19200/students/NO/1/_update?pretty -d 
</span></span><span class="line"><span class="cl"><span class="s1">&#39;{
</span></span></span><span class="line"><span class="cl"><span class="s1">  &#34;doc&#34;: { &#34;age&#34;: 18 }
</span></span></span><span class="line"><span class="cl"><span class="s1">}&#39;</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;_index&#34;</span> : <span class="s2">&#34;students&#34;</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;_type&#34;</span> : <span class="s2">&#34;NO&#34;</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;_id&#34;</span> : <span class="s2">&#34;1&#34;</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;_version&#34;</span> : 3,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;result&#34;</span> : <span class="s2">&#34;updated&#34;</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;_shards&#34;</span> : <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;total&#34;</span> : 2,
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;successful&#34;</span> : 1,
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;failed&#34;</span> : <span class="m">0</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;_seq_no&#34;</span> : 2,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;_primary_term&#34;</span> : <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="333-删除文档">3.3.3 删除文档</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">curl  -X DELETE http://10.0.0.12:19200/students/NO/1?pretty
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;_index&#34;</span> : <span class="s2">&#34;students&#34;</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;_type&#34;</span> : <span class="s2">&#34;NO&#34;</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;_id&#34;</span> : <span class="s2">&#34;1&#34;</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;_version&#34;</span> : 4,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;result&#34;</span> : <span class="s2">&#34;deleted&#34;</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;_shards&#34;</span> : <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;total&#34;</span> : 2,
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;successful&#34;</span> : 2,
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;failed&#34;</span> : <span class="m">0</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;_seq_no&#34;</span> : 3,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;_primary_term&#34;</span> : <span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="334-删除索引">3.3.4 删除索引</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">curl  http://10.0.0.12:19200/_cat/indices
</span></span><span class="line"><span class="cl">green open test1    cBL6BqIqStyr2a8O2n8Bdw <span class="m">5</span> <span class="m">1</span> <span class="m">0</span> <span class="m">0</span>  2.5kb  1.2kb
</span></span><span class="line"><span class="cl">green open students g04VDxTUTEOLmdooHuuRpA <span class="m">5</span> <span class="m">1</span> <span class="m">1</span> <span class="m">0</span> 26.5kb 13.2kb
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">curl  -X DELETE http://10.0.0.12:19200/test1
</span></span><span class="line"><span class="cl"><span class="o">{</span><span class="s2">&#34;acknowledged&#34;</span>:true<span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">curl  http://10.0.0.12:19200/_cat/indices
</span></span><span class="line"><span class="cl">green open students g04VDxTUTEOLmdooHuuRpA <span class="m">5</span> <span class="m">1</span> <span class="m">1</span> <span class="m">0</span> 26.5kb 13.2kb
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="34-查询数据">3.4 查询数据</h3>
<p>Query API Query DSL:JS0N based language for building complex queries。</p>
<p>用户实现诸多类型的查询操作，比如，simple term query,phrase,range boolean,fuzzy等：</p>
<p>ES的查询操作执行分为两个阶段：</p>
<ul>
<li>分散阶段：</li>
<li>合并阶段：</li>
</ul>
<p>列出一个索引的所有文档，较小级别时的演示说明</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="err">curl</span>  <span class="err">http:</span><span class="c1">//10.0.0.12:19200/_search?pretty
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;took&#34;</span> <span class="p">:</span> <span class="mi">15</span><span class="p">,</span>  <span class="err">#←执行时长</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;timed_out&#34;</span> <span class="p">:</span> <span class="kc">false</span><span class="p">,</span>  <span class="err">#←是否超时</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;_shards&#34;</span> <span class="p">:</span> <span class="p">{</span>   <span class="err">#←操作设计到多少个分片</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;total&#34;</span> <span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;successful&#34;</span> <span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;skipped&#34;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;failed&#34;</span> <span class="p">:</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;hits&#34;</span> <span class="p">:</span> <span class="p">{</span>   <span class="err">#←查询结果</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;total&#34;</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;max_score&#34;</span> <span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;hits&#34;</span> <span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;_index&#34;</span> <span class="p">:</span> <span class="s2">&#34;students&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;_type&#34;</span> <span class="p">:</span> <span class="s2">&#34;NO&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="s2">&#34;2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;_score&#34;</span> <span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>  <span class="err">#←文档平分，没有加权</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;_source&#34;</span> <span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;first_name&#34;</span> <span class="p">:</span> <span class="s2">&#34;jing&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;last_name&#34;</span> <span class="p">:</span> <span class="s2">&#34;guo&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;gender&#34;</span> <span class="p">:</span> <span class="s2">&#34;male&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;age&#34;</span> <span class="p">:</span> <span class="s2">&#34;25&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;courses&#34;</span> <span class="p">:</span> <span class="s2">&#34;xianglong shiba zhang&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;_index&#34;</span> <span class="p">:</span> <span class="s2">&#34;students&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;_type&#34;</span> <span class="p">:</span> <span class="s2">&#34;NO&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="s2">&#34;1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;_score&#34;</span> <span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;_source&#34;</span> <span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;first_name&#34;</span> <span class="p">:</span> <span class="s2">&#34;rong&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;last_name&#34;</span> <span class="p">:</span> <span class="s2">&#34;huang&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;gender&#34;</span> <span class="p">:</span> <span class="s2">&#34;female&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;age&#34;</span> <span class="p">:</span> <span class="mi">23</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;courses&#34;</span> <span class="p">:</span> <span class="s2">&#34;luoying shenjian zhang&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>默认情况下，只返回前十个。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="err">curl</span> <span class="err">-H</span> <span class="err">&#39;content-type:</span> <span class="err">application/json&#39;</span> <span class="err">http:</span><span class="c1">//10.0.0.12:19200/_search?pretty -d &#39;{
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="s2">&#34;query&#34;</span><span class="err">:</span> <span class="p">{</span><span class="nt">&#34;match_all&#34;</span><span class="p">:</span> <span class="p">{}}</span>
</span></span><span class="line"><span class="cl"><span class="err">}&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="35-多索引多类型查询">3.5 多索引、多类型查询</h3>
<p>/_search：所有索引：
/INDEX_NAME/_search：单索引：
/INDEX1,INDEX2/_search：多索引：
/s*,t*/_search：
/students/class1/_search：单类型搜索
/students/class1,class2/_search：多类型搜索</p>
<h3 id="36-插入测试数据">3.6 插入测试数据</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">curl -H <span class="s1">&#39;content-type: application/json&#39;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>http://10.0.0.12:19200/test1/NO/1?pretty -d <span class="s1">&#39;{
</span></span></span><span class="line"><span class="cl"><span class="s1">   &#34;name&#34;:&#34;zhou yu&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s1">   &#34;age&#34;: &#34;25&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s1">   &#34;weapon&#34;: &#34;duan jian&#34;
</span></span></span><span class="line"><span class="cl"><span class="s1">}&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">curl -H <span class="s1">&#39;content-type: application/json&#39;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>http://10.0.0.12:19200/test1/NO/2?pretty -d <span class="s1">&#39;{
</span></span></span><span class="line"><span class="cl"><span class="s1">   &#34;name&#34;:&#34;zhangliang&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s1">   &#34;age&#34;: 31,
</span></span></span><span class="line"><span class="cl"><span class="s1">   &#34;weapon&#34;: &#34;fu zhou&#34;
</span></span></span><span class="line"><span class="cl"><span class="s1">}&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">curl -H <span class="s1">&#39;content-type: application/json&#39;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>http://10.0.0.12:19200/test1/NO/3?pretty -d <span class="s1">&#39;{
</span></span></span><span class="line"><span class="cl"><span class="s1">   &#34;name&#34;:&#34;zhang liao&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s1">   &#34;age&#34;: &#34;31&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s1">   &#34;weapon&#34;: &#34;dao&#34;
</span></span></span><span class="line"><span class="cl"><span class="s1">}&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">curl -H <span class="s1">&#39;content-type: application/json&#39;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>http://10.0.0.12:19200/test1/NO/4?pretty -d <span class="s1">&#39;{
</span></span></span><span class="line"><span class="cl"><span class="s1">   &#34;name&#34;:&#34;zhang fei&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s1">   &#34;age&#34;: &#34;30&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s1">   &#34;weapon&#34;: &#34;zhang ba she mao&#34;
</span></span></span><span class="line"><span class="cl"><span class="s1">}&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">curl -H <span class="s1">&#39;content-type: application/json&#39;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>http://10.0.0.12:19200/test1/NO/5?pretty -d <span class="s1">&#39;{
</span></span></span><span class="line"><span class="cl"><span class="s1">  &#34;name&#34;: &#34;zhu ge liang&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s1">  &#34;age&#34;: &#34;18&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s1">  &#34;weapon&#34;: &#34;yu shan&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s1">  &#34;intro&#34;: &#34;31 years old&#34;
</span></span></span><span class="line"><span class="cl"><span class="s1">}&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看出，默认按照字符串匹配。文档中的每个域存储为特定类型而非字符串。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span> 
</span></span><span class="line"><span class="cl"><span class="nt">&#34;hits&#34;</span><span class="p">:</span> 
</span></span><span class="line"><span class="cl"> 	<span class="p">{</span> <span class="nt">&#34;total&#34;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="nt">&#34;max_score&#34;</span><span class="p">:</span> <span class="mf">0.87546873</span><span class="p">,</span> <span class="nt">&#34;hits&#34;</span><span class="p">:</span> 
</span></span><span class="line"><span class="cl"> 	<span class="p">[</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl"> 			<span class="nt">&#34;_index&#34;</span><span class="p">:</span> <span class="s2">&#34;test1&#34;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl"> 		<span class="nt">&#34;_type&#34;</span><span class="p">:</span> <span class="s2">&#34;NO&#34;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl"> 		<span class="nt">&#34;_id&#34;</span><span class="p">:</span> <span class="s2">&#34;3&#34;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl"> 		<span class="nt">&#34;_score&#34;</span><span class="p">:</span> <span class="mf">0.87546873</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl"> 		<span class="nt">&#34;_source&#34;</span><span class="p">:</span> 
</span></span><span class="line"><span class="cl"> 		  <span class="p">{</span> 	
</span></span><span class="line"><span class="cl"> 					<span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;zhang liao&#34;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">           		<span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="s2">&#34;31&#34;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl"> 				<span class="nt">&#34;weapon&#34;</span><span class="p">:</span> <span class="s2">&#34;dao&#34;</span> 
</span></span><span class="line"><span class="cl"> 		  <span class="p">}</span> 
</span></span><span class="line"><span class="cl"> 		<span class="p">},</span> 
</span></span><span class="line"><span class="cl"> 	  <span class="p">{</span> 
</span></span><span class="line"><span class="cl"> 		<span class="nt">&#34;_index&#34;</span><span class="p">:</span> <span class="s2">&#34;test1&#34;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl"> 		<span class="nt">&#34;_type&#34;</span><span class="p">:</span> <span class="s2">&#34;NO&#34;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl"> 			<span class="nt">&#34;_id&#34;</span><span class="p">:</span> <span class="s2">&#34;2&#34;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl"> 		<span class="nt">&#34;_score&#34;</span><span class="p">:</span> <span class="mf">0.87546873</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl"> 		<span class="nt">&#34;_source&#34;</span><span class="p">:</span> 	
</span></span><span class="line"><span class="cl"> 			<span class="p">{</span> 	
</span></span><span class="line"><span class="cl"> 			  <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;zhangliang&#34;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl"> 				  <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">31</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl"> 			  <span class="nt">&#34;weapon&#34;</span><span class="p">:</span> <span class="s2">&#34;fu zhou&#34;</span>
</span></span><span class="line"><span class="cl"> 			<span class="p">}</span> 
</span></span><span class="line"><span class="cl"> 		<span class="p">}</span> <span class="p">,</span>
</span></span><span class="line"><span class="cl"> 		<span class="p">{</span> 
</span></span><span class="line"><span class="cl"> 			<span class="nt">&#34;_index&#34;</span><span class="p">:</span> <span class="s2">&#34;test1&#34;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl"> 			<span class="nt">&#34;_type&#34;</span><span class="p">:</span> <span class="s2">&#34;NO&#34;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl"> 			<span class="nt">&#34;_id&#34;</span><span class="p">:</span> <span class="s2">&#34;5&#34;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl"> 			<span class="nt">&#34;_score&#34;</span><span class="p">:</span> <span class="mf">0.2876821</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl"> 			<span class="nt">&#34;_source&#34;</span><span class="p">:</span> 
</span></span><span class="line"><span class="cl"> 			<span class="p">{</span> 	
</span></span><span class="line"><span class="cl"> 				<span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;zhu ge liang&#34;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl"> 				<span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="s2">&#34;18&#34;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl"> 				<span class="nt">&#34;weapon&#34;</span><span class="p">:</span> <span class="s2">&#34;yu shan&#34;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl"> 				<span class="nt">&#34;intro&#34;</span><span class="p">:</span> <span class="s2">&#34;31 years old&#34;</span> 
</span></span><span class="line"><span class="cl"> 			<span class="p">}</span> 
</span></span><span class="line"><span class="cl"> 		<span class="p">}</span> 
</span></span><span class="line"><span class="cl"> 	<span class="p">]</span> 
</span></span><span class="line"><span class="cl"><span class="p">}</span> 
</span></span></code></pre></td></tr></table>
</div>
</div><p>指定域搜索做精确匹配</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="s2">&#34;hits&#34;</span><span class="err">:</span> <span class="p">[</span> 
</span></span><span class="line"><span class="cl"> 	<span class="p">{</span> 
</span></span><span class="line"><span class="cl"> 			<span class="nt">&#34;_index&#34;</span><span class="p">:</span> <span class="s2">&#34;test1&#34;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl"> 			<span class="nt">&#34;_type&#34;</span><span class="p">:</span> <span class="s2">&#34;NO&#34;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl"> 			<span class="nt">&#34;_id&#34;</span><span class="p">:</span> <span class="s2">&#34;3&#34;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl"> 			<span class="nt">&#34;_score&#34;</span><span class="p">:</span> <span class="mf">0.87546873</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl"> 			<span class="nt">&#34;_source&#34;</span><span class="p">:</span> 
</span></span><span class="line"><span class="cl"> 			<span class="p">{</span> 
</span></span><span class="line"><span class="cl"> 				<span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;zhang liao&#34;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl"> 				<span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="s2">&#34;31&#34;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl"> 				<span class="nt">&#34;weapon&#34;</span><span class="p">:</span> <span class="s2">&#34;dao&#34;</span> 
</span></span><span class="line"><span class="cl"> 		 	<span class="p">}</span> 
</span></span><span class="line"><span class="cl"> 		<span class="p">}</span> <span class="p">,</span> 
</span></span><span class="line"><span class="cl"> 		<span class="p">{</span> 
</span></span><span class="line"><span class="cl"> 		 	<span class="nt">&#34;_index&#34;</span><span class="p">:</span> <span class="s2">&#34;test1&#34;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl"> 		 	<span class="nt">&#34;_type&#34;</span><span class="p">:</span> <span class="s2">&#34;NO&#34;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl"> 		 	<span class="nt">&#34;_id&#34;</span><span class="p">:</span> <span class="s2">&#34;4&#34;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl"> 		 	<span class="nt">&#34;_score&#34;</span><span class="p">:</span> <span class="mf">0.87546873</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> 		 	<span class="nt">&#34;_source&#34;</span><span class="p">:</span> 
</span></span><span class="line"><span class="cl"> 		 	<span class="p">{</span> 
</span></span><span class="line"><span class="cl"> 		 		<span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;zhang fei&#34;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl"> 		 		<span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="s2">&#34;30&#34;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl"> 		 		<span class="nt">&#34;weapon&#34;</span><span class="p">:</span> <span class="s2">&#34;zhang ba she mao&#34;</span> 
</span></span><span class="line"><span class="cl"> 		 	<span class="p">}</span> 
</span></span><span class="line"><span class="cl"> 	<span class="p">}</span> 
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>查看指定类型的mapping示例
curl &ldquo;http://10.0.0.12:19200/test1/_mapping/NO?pretty&rdquo;
mapping定义了整个文档中的数据是被当做何种类型对待的。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	  <span class="nt">&#34;test1&#34;</span> <span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nt">&#34;mappings&#34;</span> <span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		  <span class="nt">&#34;NO&#34;</span> <span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nt">&#34;properties&#34;</span> <span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			  <span class="nt">&#34;age&#34;</span> <span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nt">&#34;type&#34;</span> <span class="p">:</span> <span class="s2">&#34;text&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="nt">&#34;fields&#34;</span> <span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				  <span class="nt">&#34;keyword&#34;</span> <span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="nt">&#34;type&#34;</span> <span class="p">:</span> <span class="s2">&#34;keyword&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">					<span class="nt">&#34;ignore_above&#34;</span> <span class="p">:</span> <span class="mi">256</span>
</span></span><span class="line"><span class="cl">				  <span class="p">}</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">			  <span class="p">},</span>
</span></span><span class="line"><span class="cl">			  <span class="nt">&#34;intro&#34;</span> <span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nt">&#34;type&#34;</span> <span class="p">:</span> <span class="s2">&#34;text&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="nt">&#34;fields&#34;</span> <span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				  <span class="nt">&#34;keyword&#34;</span> <span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="nt">&#34;type&#34;</span> <span class="p">:</span> <span class="s2">&#34;keyword&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">					<span class="nt">&#34;ignore_above&#34;</span> <span class="p">:</span> <span class="mi">256</span>
</span></span><span class="line"><span class="cl">				  <span class="p">}</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">			  <span class="p">},</span>
</span></span><span class="line"><span class="cl">			  <span class="nt">&#34;name&#34;</span> <span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nt">&#34;type&#34;</span> <span class="p">:</span> <span class="s2">&#34;text&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="nt">&#34;fields&#34;</span> <span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				  <span class="nt">&#34;keyword&#34;</span> <span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="nt">&#34;type&#34;</span> <span class="p">:</span> <span class="s2">&#34;keyword&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">					<span class="nt">&#34;ignore_above&#34;</span> <span class="p">:</span> <span class="mi">256</span>
</span></span><span class="line"><span class="cl">				  <span class="p">}</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">			  <span class="p">},</span>
</span></span><span class="line"><span class="cl">			  <span class="nt">&#34;weapon&#34;</span> <span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nt">&#34;type&#34;</span> <span class="p">:</span> <span class="s2">&#34;text&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="nt">&#34;fields&#34;</span> <span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				  <span class="nt">&#34;keyword&#34;</span> <span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="nt">&#34;type&#34;</span> <span class="p">:</span> <span class="s2">&#34;keyword&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">					<span class="nt">&#34;ignore_above&#34;</span> <span class="p">:</span> <span class="mi">256</span>
</span></span><span class="line"><span class="cl">				  <span class="p">}</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">			  <span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		  <span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	  <span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ES中搜索的数据广义上可被理解为两类：</p>
<ul>
<li>types:exact</li>
<li>full-text</li>
</ul>
<p>精确值：指未经加工的原始值；在搜索时进行精确匹配。NOTEBOOK≠notebook</p>
<p>full-text：用于引用文本中数据；判断文档在多大程序上匹配查询请求；即评估文档与用户请求查询的相关度。</p>
<p>为了完成ful1-text搜素，ES必须首先分析文本，并创建出倒排素引：倒排素引中的数据还需进行“正规化”为标准格式：如全部小写、负数变为单数、trees改为tree等。</p>
<p>创建倒排索引需要先分词再normalization。分词加正规化的操作及为分析。</p>
<p>分析需要由分析器(analyzer)进行。分析器由三个组件构成：字符过滤器、分词器、分词过滤器。</p>
<p>ES内置的分析器：</p>
<ul>
<li>Standard analyzer：ES的默认分析器，适用于多种语言，基于Unicode方式进行分析。</li>
<li>Simple analyzer：简单分析器，根据所有的字母进行分析。</li>
<li>Wirtespace analyzer：只把空白字符当做单词分割。</li>
<li>Language analyzer：为多种语言分别提供各种各样的分析器。</li>
</ul>
<p>分析器不仅在创建素引时用到；在构建查询时也会用到。构建索引时的分析器，分析用户查询并构建成查询语句的分词方式。两种方式需要保持一致。</p>
<p>[2018-09-21 05:24:03,381][INFO ][cluster.routing.allocation.decider] [node-1] low disk watermark [85%] exceeded on [JWxQxMkeTj6BkmIx-6DsXg][node-1][/var/lib/elasticsearch/my-application/nodes/0] free: 1gb[11.2%], replicas will not be assigned to this node</p>
<h2 id="4-es错误">4 ES错误</h2>
<h3 id="es索引yellow状态">ES索引yellow状态</h3>
<blockquote>
<p><strong>查看片状态</strong></p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">curl 172.16.16.18:9200/_cat/shards
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">logstash-webapi-2018.10.30 <span class="m">0</span> p STARTED        <span class="m">1</span>   6.1kb 127.0.0.1 6wPQIP5
</span></span><span class="line"><span class="cl">logstash-webapi-2018.10.30 <span class="m">0</span> p STARTED        <span class="m">3</span>  16.4kb 127.0.0.1 6wPQIP5
</span></span><span class="line"><span class="cl">logstash-webapi-2018.10.30 <span class="m">0</span> r UNASSIGNED                         
</span></span><span class="line"><span class="cl">logstash-webapi-2018.10.30 <span class="m">0</span> p STARTED     <span class="m">1824</span>     1mb 127.0.0.1 6wPQIP5
</span></span><span class="line"><span class="cl">logstash-webapi-2018.10.30 <span class="m">0</span> p UNASSIGNED
</span></span><span class="line"><span class="cl">logstash-webapi-2018.10.30 <span class="m">0</span> p STARTED      <span class="m">272</span> 363.4kb 127.0.0.1 6wPQIP5
</span></span><span class="line"><span class="cl">logstash-webapi-2018.10.30 <span class="m">0</span> p UNASSIGNED
</span></span><span class="line"><span class="cl">logstash-webapi-2018.10.30 <span class="m">0</span> p STARTED        <span class="m">0</span>   5.1kb 127.0.0.1 6wPQIP5
</span></span><span class="line"><span class="cl">logstash-webapi-2018.10.30 <span class="m">0</span> p UNASSIGNED
</span></span><span class="line"><span class="cl">logstash-webapi-2018.10.30 <span class="m">0</span> p STARTED     <span class="m">4888</span>   2.4mb 127.0.0.1 6wPQIP5
</span></span><span class="line"><span class="cl">logstash-webapi-2018.10.30 <span class="m">0</span> p UNASSIGNED 
</span></span></code></pre></td></tr></table>
</div>
</div><p>yellow表示所有主分片可用，但不是所有副本分片都可用，最常见的情景是单节点时，由于es默认是有1个副本，主分片和副本不能在同一个节点上，所以副本就是未分配unassigned</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">PUT 172.16.16.18:9200/logstash -d <span class="s1">&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">{
</span></span></span><span class="line"><span class="cl"><span class="s1">  &#34;settings&#34;:{
</span></span></span><span class="line"><span class="cl"><span class="s1">           &#34;number_of_shards&#34;:1,     
</span></span></span><span class="line"><span class="cl"><span class="s1">           &#34;number_of_replicas&#34;:0
</span></span></span><span class="line"><span class="cl"><span class="s1">  }
</span></span></span><span class="line"><span class="cl"><span class="s1">}&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>参考网址：<a href="https://blog.csdn.net/qq_21383435/article/details/79323739">elasticsearch集群健康为黄色</a></p>
]]></content:encoded>
    </item>
    
  </channel>
</rss>
