<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Ceph RBD - 关于RBD的操作与管理 | Cylon's Collection</title>
<meta name=keywords content="ceph rbd,block device"><meta name=description content="上一章提到了 RBD 块设备相关的基本配置，这章主要描述 RBD 操作部分
ceph块设备接口（RDB） Ceph块设备，也称为RADOS块设备（简称RBD），是一种基于RADOS存储系统支持超配（thin-provisioned）、可伸缩的条带化数据存储系统，它通过librbd库与OSD进行交互。RBD为KVM等虑拟化技术和云OS（如OpenStack和CloudStack）提供高性能和无限可扩展性的存储后端，这些系统依赖于libvirt和QEMU实用程序与RBD进行集成。
客户端基于librbd库即可将RADOS存储集群用作块设备，不过，用于rbd的存储池需要实现启用rbd功能并进行初始化。例如，下面的命令创建rbddata的存储池，在启动rbd功能后对其进行初始化。
sh 1 2 3 4 ceph osd pool create rbdpool 64 # 创建存储池 rbd pool init -p rbdpool # rbd create rbdpool/img1 --size 2G rbd ls -p rbdpool 不过rbd存储池并不能直接用于块设备，而是需要事先在其中按需创建影响（image）
RBD是建立在librados之上的客户端，全程为Rados Block Devices，是对rados存储服务做抽象，将rados位于存储池当中所提供的存储空间，使用对象式存储数据的能力的机制。
rbd虚拟磁盘设备要想使linux内核所识别使用，要求linux在内核级支持Ceph，内核级有一个Ceph模块，专门用来驱动Ceph设备的。这个驱动就叫librbd。此模块自己是一个客户端，能够连接至RBD服务上，检索出他所管理的镜像文件。从而镜像文件完全可以被linux主机作为一块完整的硬盘来使用。
创建存储池镜像
--object-size 任何数据存储在存储池中都被切分为固定大小的对象，对象通常称之为条带，切分的对象大小，默认4M --image-feature 指定镜像文件的特性，每种特性代表镜像文件能支持哪些种功能，可被单独启用或禁用。 layering(+), 分层克隆 exclusive-lock 排它锁，是否支持分布式排它锁，已用来限制一个镜像文件同时只能被一个客户端使用。 object-map(+*) 对象映射,是否支持对象位图，主要用于加速导入、导出及已用容量统的。 fast-diff(+*), 快速比较，主要用于做快照之间的比较 deep-flatten(+-) , 深层展评 journaling 日志，用户在修改image数据时是否记录日志。 shared image --no-progress：不显示创建过程 sh 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 $ rbd help create usage: rbd create [--pool <pool>] [--image <image>] [--image-format <image-format>] [--new-format] [--order <order>] [--object-size <object-size>] [--image-feature <image-feature>] [--image-shared] [--stripe-unit <stripe-unit>] [--stripe-count <stripe-count>] [--data-pool <data-pool>] [--journal-splay-width <journal-splay-width>] [--journal-object-size <journal-object-size>] [--journal-pool <journal-pool>] [--thick-provision] --size <size> [--no-progress] <image-spec> Create an empty image."><meta name=author content="cylon"><link rel=canonical href=https://www.oomkill.com/2019/07/03-2-rbd-management/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://www.oomkill.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.oomkill.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.oomkill.com/favicon-32x32.png><link rel=apple-touch-icon href=https://www.oomkill.com/favicon.ico><link rel=mask-icon href=https://www.oomkill.com/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://www.oomkill.com/2019/07/03-2-rbd-management/><noscript><style>#theme-toggle,#top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link crossorigin=anonymous href=/assets/css/pe.min.css rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/pe.min.js></script><link rel=stylesheet href=https://cdn.staticfile.net/font-awesome/6.5.1/css/all.min.css><link rel=stylesheet href=https://cdn.staticfile.net/font-awesome/6.5.1/css/v4-shims.min.css><script id=MathJax-script async src=https://cdn.staticfile.net/mathjax/3.2.2/es5/tex-chtml.js></script><script>MathJax={tex:{displayMath:[["$$","$$"]],inlineMath:[["\\$","\\$"]]}}</script><meta property="og:title" content="Ceph RBD - 关于RBD的操作与管理"><meta property="og:description" content="上一章提到了 RBD 块设备相关的基本配置，这章主要描述 RBD 操作部分
ceph块设备接口（RDB） Ceph块设备，也称为RADOS块设备（简称RBD），是一种基于RADOS存储系统支持超配（thin-provisioned）、可伸缩的条带化数据存储系统，它通过librbd库与OSD进行交互。RBD为KVM等虑拟化技术和云OS（如OpenStack和CloudStack）提供高性能和无限可扩展性的存储后端，这些系统依赖于libvirt和QEMU实用程序与RBD进行集成。
客户端基于librbd库即可将RADOS存储集群用作块设备，不过，用于rbd的存储池需要实现启用rbd功能并进行初始化。例如，下面的命令创建rbddata的存储池，在启动rbd功能后对其进行初始化。
sh 1 2 3 4 ceph osd pool create rbdpool 64 # 创建存储池 rbd pool init -p rbdpool # rbd create rbdpool/img1 --size 2G rbd ls -p rbdpool 不过rbd存储池并不能直接用于块设备，而是需要事先在其中按需创建影响（image）
RBD是建立在librados之上的客户端，全程为Rados Block Devices，是对rados存储服务做抽象，将rados位于存储池当中所提供的存储空间，使用对象式存储数据的能力的机制。
rbd虚拟磁盘设备要想使linux内核所识别使用，要求linux在内核级支持Ceph，内核级有一个Ceph模块，专门用来驱动Ceph设备的。这个驱动就叫librbd。此模块自己是一个客户端，能够连接至RBD服务上，检索出他所管理的镜像文件。从而镜像文件完全可以被linux主机作为一块完整的硬盘来使用。
创建存储池镜像
--object-size 任何数据存储在存储池中都被切分为固定大小的对象，对象通常称之为条带，切分的对象大小，默认4M --image-feature 指定镜像文件的特性，每种特性代表镜像文件能支持哪些种功能，可被单独启用或禁用。 layering(+), 分层克隆 exclusive-lock 排它锁，是否支持分布式排它锁，已用来限制一个镜像文件同时只能被一个客户端使用。 object-map(+*) 对象映射,是否支持对象位图，主要用于加速导入、导出及已用容量统的。 fast-diff(+*), 快速比较，主要用于做快照之间的比较 deep-flatten(+-) , 深层展评 journaling 日志，用户在修改image数据时是否记录日志。 shared image --no-progress：不显示创建过程 sh 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 $ rbd help create usage: rbd create [--pool <pool>] [--image <image>] [--image-format <image-format>] [--new-format] [--order <order>] [--object-size <object-size>] [--image-feature <image-feature>] [--image-shared] [--stripe-unit <stripe-unit>] [--stripe-count <stripe-count>] [--data-pool <data-pool>] [--journal-splay-width <journal-splay-width>] [--journal-object-size <journal-object-size>] [--journal-pool <journal-pool>] [--thick-provision] --size <size> [--no-progress] <image-spec> Create an empty image."><meta property="og:type" content="article"><meta property="og:url" content="https://www.oomkill.com/2019/07/03-2-rbd-management/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-07-31T00:00:00+00:00"><meta property="article:modified_time" content="2023-09-07T23:10:36+08:00"><meta property="og:site_name" content="Cylon's Collection"><meta name=twitter:card content="summary"><meta name=twitter:title content="Ceph RBD - 关于RBD的操作与管理"><meta name=twitter:description content="上一章提到了 RBD 块设备相关的基本配置，这章主要描述 RBD 操作部分
ceph块设备接口（RDB） Ceph块设备，也称为RADOS块设备（简称RBD），是一种基于RADOS存储系统支持超配（thin-provisioned）、可伸缩的条带化数据存储系统，它通过librbd库与OSD进行交互。RBD为KVM等虑拟化技术和云OS（如OpenStack和CloudStack）提供高性能和无限可扩展性的存储后端，这些系统依赖于libvirt和QEMU实用程序与RBD进行集成。
客户端基于librbd库即可将RADOS存储集群用作块设备，不过，用于rbd的存储池需要实现启用rbd功能并进行初始化。例如，下面的命令创建rbddata的存储池，在启动rbd功能后对其进行初始化。
sh 1 2 3 4 ceph osd pool create rbdpool 64 # 创建存储池 rbd pool init -p rbdpool # rbd create rbdpool/img1 --size 2G rbd ls -p rbdpool 不过rbd存储池并不能直接用于块设备，而是需要事先在其中按需创建影响（image）
RBD是建立在librados之上的客户端，全程为Rados Block Devices，是对rados存储服务做抽象，将rados位于存储池当中所提供的存储空间，使用对象式存储数据的能力的机制。
rbd虚拟磁盘设备要想使linux内核所识别使用，要求linux在内核级支持Ceph，内核级有一个Ceph模块，专门用来驱动Ceph设备的。这个驱动就叫librbd。此模块自己是一个客户端，能够连接至RBD服务上，检索出他所管理的镜像文件。从而镜像文件完全可以被linux主机作为一块完整的硬盘来使用。
创建存储池镜像
--object-size 任何数据存储在存储池中都被切分为固定大小的对象，对象通常称之为条带，切分的对象大小，默认4M --image-feature 指定镜像文件的特性，每种特性代表镜像文件能支持哪些种功能，可被单独启用或禁用。 layering(+), 分层克隆 exclusive-lock 排它锁，是否支持分布式排它锁，已用来限制一个镜像文件同时只能被一个客户端使用。 object-map(+*) 对象映射,是否支持对象位图，主要用于加速导入、导出及已用容量统的。 fast-diff(+*), 快速比较，主要用于做快照之间的比较 deep-flatten(+-) , 深层展评 journaling 日志，用户在修改image数据时是否记录日志。 shared image --no-progress：不显示创建过程 sh 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 $ rbd help create usage: rbd create [--pool <pool>] [--image <image>] [--image-format <image-format>] [--new-format] [--order <order>] [--object-size <object-size>] [--image-feature <image-feature>] [--image-shared] [--stripe-unit <stripe-unit>] [--stripe-count <stripe-count>] [--data-pool <data-pool>] [--journal-splay-width <journal-splay-width>] [--journal-object-size <journal-object-size>] [--journal-pool <journal-pool>] [--thick-provision] --size <size> [--no-progress] <image-spec> Create an empty image."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://www.oomkill.com/posts/"},{"@type":"ListItem","position":2,"name":"Ceph RBD - 关于RBD的操作与管理","item":"https://www.oomkill.com/2019/07/03-2-rbd-management/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Ceph RBD - 关于RBD的操作与管理","name":"Ceph RBD - 关于RBD的操作与管理","description":"上一章提到了 RBD 块设备相关的基本配置，这章主要描述 RBD 操作部分\nceph块设备接口（RDB） Ceph块设备，也称为RADOS块设备（简称RBD），是一种基于RADOS存储系统支持超配（thin-provisioned）、可伸缩的条带化数据存储系统，它通过librbd库与OSD进行交互。RBD为KVM等虑拟化技术和云OS（如OpenStack和CloudStack）提供高性能和无限可扩展性的存储后端，这些系统依赖于libvirt和QEMU实用程序与RBD进行集成。\n客户端基于librbd库即可将RADOS存储集群用作块设备，不过，用于rbd的存储池需要实现启用rbd功能并进行初始化。例如，下面的命令创建rbddata的存储池，在启动rbd功能后对其进行初始化。\nsh 1 2 3 4 ceph osd pool create rbdpool 64 # 创建存储池 rbd pool init -p rbdpool # rbd create rbdpool/img1 --size 2G rbd ls -p rbdpool 不过rbd存储池并不能直接用于块设备，而是需要事先在其中按需创建影响（image）\nRBD是建立在librados之上的客户端，全程为Rados Block Devices，是对rados存储服务做抽象，将rados位于存储池当中所提供的存储空间，使用对象式存储数据的能力的机制。\nrbd虚拟磁盘设备要想使linux内核所识别使用，要求linux在内核级支持Ceph，内核级有一个Ceph模块，专门用来驱动Ceph设备的。这个驱动就叫librbd。此模块自己是一个客户端，能够连接至RBD服务上，检索出他所管理的镜像文件。从而镜像文件完全可以被linux主机作为一块完整的硬盘来使用。\n创建存储池镜像\n--object-size 任何数据存储在存储池中都被切分为固定大小的对象，对象通常称之为条带，切分的对象大小，默认4M --image-feature 指定镜像文件的特性，每种特性代表镜像文件能支持哪些种功能，可被单独启用或禁用。 layering(+), 分层克隆 exclusive-lock 排它锁，是否支持分布式排它锁，已用来限制一个镜像文件同时只能被一个客户端使用。 object-map(+*) 对象映射,是否支持对象位图，主要用于加速导入、导出及已用容量统的。 fast-diff(+*), 快速比较，主要用于做快照之间的比较 deep-flatten(+-) , 深层展评 journaling 日志，用户在修改image数据时是否记录日志。 shared image --no-progress：不显示创建过程 sh 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 $ rbd help create usage: rbd create [--pool \u0026lt;pool\u0026gt;] [--image \u0026lt;image\u0026gt;] [--image-format \u0026lt;image-format\u0026gt;] [--new-format] [--order \u0026lt;order\u0026gt;] [--object-size \u0026lt;object-size\u0026gt;] [--image-feature \u0026lt;image-feature\u0026gt;] [--image-shared] [--stripe-unit \u0026lt;stripe-unit\u0026gt;] [--stripe-count \u0026lt;stripe-count\u0026gt;] [--data-pool \u0026lt;data-pool\u0026gt;] [--journal-splay-width \u0026lt;journal-splay-width\u0026gt;] [--journal-object-size \u0026lt;journal-object-size\u0026gt;] [--journal-pool \u0026lt;journal-pool\u0026gt;] [--thick-provision] --size \u0026lt;size\u0026gt; [--no-progress] \u0026lt;image-spec\u0026gt; Create an empty image.","keywords":["ceph rbd","block device"],"articleBody":"上一章提到了 RBD 块设备相关的基本配置，这章主要描述 RBD 操作部分\nceph块设备接口（RDB） Ceph块设备，也称为RADOS块设备（简称RBD），是一种基于RADOS存储系统支持超配（thin-provisioned）、可伸缩的条带化数据存储系统，它通过librbd库与OSD进行交互。RBD为KVM等虑拟化技术和云OS（如OpenStack和CloudStack）提供高性能和无限可扩展性的存储后端，这些系统依赖于libvirt和QEMU实用程序与RBD进行集成。\n客户端基于librbd库即可将RADOS存储集群用作块设备，不过，用于rbd的存储池需要实现启用rbd功能并进行初始化。例如，下面的命令创建rbddata的存储池，在启动rbd功能后对其进行初始化。\nsh 1 2 3 4 ceph osd pool create rbdpool 64 # 创建存储池 rbd pool init -p rbdpool # rbd create rbdpool/img1 --size 2G rbd ls -p rbdpool 不过rbd存储池并不能直接用于块设备，而是需要事先在其中按需创建影响（image）\nRBD是建立在librados之上的客户端，全程为Rados Block Devices，是对rados存储服务做抽象，将rados位于存储池当中所提供的存储空间，使用对象式存储数据的能力的机制。\nrbd虚拟磁盘设备要想使linux内核所识别使用，要求linux在内核级支持Ceph，内核级有一个Ceph模块，专门用来驱动Ceph设备的。这个驱动就叫librbd。此模块自己是一个客户端，能够连接至RBD服务上，检索出他所管理的镜像文件。从而镜像文件完全可以被linux主机作为一块完整的硬盘来使用。\n创建存储池镜像\n--object-size 任何数据存储在存储池中都被切分为固定大小的对象，对象通常称之为条带，切分的对象大小，默认4M --image-feature 指定镜像文件的特性，每种特性代表镜像文件能支持哪些种功能，可被单独启用或禁用。 layering(+), 分层克隆 exclusive-lock 排它锁，是否支持分布式排它锁，已用来限制一个镜像文件同时只能被一个客户端使用。 object-map(+*) 对象映射,是否支持对象位图，主要用于加速导入、导出及已用容量统的。 fast-diff(+*), 快速比较，主要用于做快照之间的比较 deep-flatten(+-) , 深层展评 journaling 日志，用户在修改image数据时是否记录日志。 shared image --no-progress：不显示创建过程 sh 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 $ rbd help create usage: rbd create [--pool ] [--image ] [--image-format ] [--new-format] [--order ] [--object-size ] [--image-feature ] [--image-shared] [--stripe-unit ] [--stripe-count ] [--data-pool ] [--journal-splay-width ] [--journal-object-size ] [--journal-pool ] [--thick-provision] --size [--no-progress] Create an empty image. ceph osd pool create kube 64 64 ceph osd pool application enable kube rbd rbd pool init kube rbd create --size 2G --pool kube --image vol01 # 使用各个选项 rbd create --size 2G kube/vol02 # 获取对象更详细信息\nPARENT 父镜像\nFMT 格式，一般只有v2\nPROT\nLOCK\nsh 1 2 3 4 5 6 7 8 9 10 11 12 $ rbd ls -l --pool kube NAME SIZE PARENT FMT PROT LOCK vol01 5 GiB 2 $ rbd ls -l --pool kube --format json --pretty-format [ { \"image\": \"vol01\", \"size\": 5368709120, \"format\": 2 } ] 获取镜像文件更详细一部镜像信息，可以使用rbd info命令\nsh 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 $ rbd info kube/vol01 rbd image 'vol01': size 5 GiB in 1280 objects order 22 (4 MiB objects) id: 5e386b8b4567 block_name_prefix: rbd_data.5e386b8b4567 format: 2 features: layering, exclusive-lock, object-map, fast-diff, deep-flatten op_features: flags: create_timestamp: Mon Jun 24 05:42:00 2019 $ rbd info --pool kube --image vol01 rbd image 'vol01': size 5 GiB in 1280 objects order 22 (4 MiB objects) id: 5e386b8b4567 block_name_prefix: rbd_data.5e386b8b4567 format: 2 features: layering, exclusive-lock, object-map, fast-diff, deep-flatten op_features: flags: create_timestamp: Mon Jun 24 05:42:00 2019 $ rbd info --pool kube vol01 rbd image 'vol01': # 镜像文件是谁 size 5 GiB in 1280 objects # 镜像总体是多大空间，被分割成多少个对象 order 22 (4 MiB objects) # 顺序是22，顺序是指块大小的标识序号 # 如64k开始64m结束，4M大小正好排在第22位 id: 5e386b8b4567 # 镜像文件自身id block_name_prefix: rbd_data.5e386b8b4567 format: 2 # 镜像文件格式 features: layering, exclusive-lock, object-map, fast-diff, deep-flatten # 启动的特性 op_features: flags: create_timestamp: Mon Jun 24 05:42:00 2019 # object-map, fast-diff, deep-flatten种特性在被linux客户端作为磁盘加载到内核中使用时是不被支持的。需将其禁用掉 禁用或启用某种特性 rbd featrue\nsh 1 2 3 rbd feature disable|enable rbd feature disable kube/vol01 object-map fast-diff deep-flatten sh 1 2 3 4 5 6 7 8 9 10 11 $ rbd info --pool kube vol01 rbd image 'vol01': size 5 GiB in 1280 objects order 22 (4 MiB objects) id: 5e386b8b4567 block_name_prefix: rbd_data.5e386b8b4567 format: 2 features: layering, exclusive-lock op_features: flags: create_timestamp: Mon Jun 24 05:42:00 2019 Ceph客户端使用块设备步骤\n创建出镜像文件。 在镜像文件上禁用默认启用的五个特性中的后三个。 在客户端上使用指定命令以指定的用户的身份连入客户端。 配置客户端上yum仓库文件 ceph命令默认是以admin为账号的，使用--user指定其他用户。\ntext 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 $ ceph -s 2019-06-25 10:48:11.283 7f999daa3700 -1 auth: unable to find a keyring on /etc/ceph/ceph.client.admin.keyring,/etc/ceph/ceph.keyring,/etc/ceph/keyring,/etc/ceph/keyring.bin,: (2) No such file or directory 2019-06-25 10:48:11.283 7f999daa3700 -1 monclient: ERROR: missing keyring, cannot use cephx for authentication [errno 2] error connecting to the cluster $ ceph --user kube -s cluster: id: 69fb9b55-3fb5-42d0-8cf7-239a3b569791 health: HEALTH_WARN 1 pool(s) full application not enabled on 1 pool(s) services: mon: 3 daemons, quorum stor01,stor02,stor03 mgr: stor01(active), standbys: stor04 mds: cephfs-1/1/1 up {0=stor02=up:active} osd: 8 osds: 8 up, 8 in rgw: 1 daemon active data: pools: 9 pools, 352 pgs objects: 254 objects, 3.7 KiB usage: 49 GiB used, 51 GiB / 100 GiB avail pgs: 352 active+clean 需要操作系统支持ceph.ko模块\nsh 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 $ modinfo ceph filename: /lib/modules/3.10.0-957.12.1.el7.x86_64/kernel/fs/ceph/ceph.ko.xz license: GPL description: Ceph filesystem for Linux author: Patience Warnick author: Yehuda Sadeh author: Sage Weil alias: fs-ceph retpoline: Y rhelversion: 7.6 srcversion: 43DA49DF11334B2A5652931 depends: libceph intree: Y vermagic: 3.10.0-957.12.1.el7.x86_64 SMP mod_unload modversions signer: CentOS Linux kernel signing key sig_key: 2C:7C:17:70:5C:86:D4:20:80:50:D3:F5:54:56:9A:7B:D3:BF:D1:BF sig_hashalgo: sha256 显示设备map信息\ntext 1 2 3 $ rbd showmapped id pool image snap device 0 kube vol01 - /dev/rbd0 显示设备挂在到哪里\nsh 1 2 3 4 5 6 $ rbd showmapped id pool image snap device 0 kube vol01 - /dev/rbd0 NAME SIZE PARENT FMT PROT LOCK vol01 5 GiB 2 excl 卸载挂载\nsh 1 2 3 $ umount /dev/rbd0 # 需要先卸载rbd挂载 $ rbd unmap /dev/rbd0 $ rbd showmapped 调整镜像文件空间容量\nsh 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 $ rbd help resize usage: rbd resize [--pool ] [--image ] --size [--allow-shrink] [--no-progress] Resize (expand or shrink) image. Positional arguments image specification (example: [/]) Optional arguments -p [ --pool ] arg pool name --image arg image name -s [ --size ] arg image size (in M/G/T) [default: M] --allow-shrink permit shrinking # 允许收缩，不要收缩到已有数据占用容量、以下 --no-progress disable progress output sh 1 2 3 4 5 6 $ rbd resize -s 10G kube/vol01 Resizing image: 100% complete...done. $ rbd ls -p kube -l NAME SIZE PARENT FMT PROT LOCK vol01 10 GiB 删除镜像文件\n镜像文件被删除是不可恢复的\nsh 1 2 3 4 5 $ rbd rm kube/vol01 Removing image: 100% complete...done. $ rbd ls -p kube -l $ rbd回收站trash\n将镜像挪入回收站中\nsh 1 2 3 4 5 6 7 8 9 10 11 12 13 $ rbd ls -p kube -l NAME SIZE PARENT FMT PROT LOCK vol01 2 GiB 2 vol02 2 GiB 2 $ rbd trash move kube/vol01 $ rbd ls -p kube -l NAME SIZE PARENT FMT PROT LOCK vol02 2 GiB 2 $ rbd trash list -p kube 5ebf6b8b4567 vol01 从trash恢复镜像\ntext 1 2 3 4 5 6 7 8 $ rbd trash list -p kube 5ebf6b8b4567 vol01 $ rbd trash restore -p kube --image vol01 --image-id 5ebf6b8b4567 $ rbd ls -p kube vol01 vol02 如何对镜像文件做快照、克隆\n快照是什么？\n快照是一种能够瞬间生成数据访问目录，能够支持备份技术的一种数据管理手段。有全量快照与增量快照两种。全量快照一般使用镜像分离技术实现，而增量快照则由COW写时拷贝快照技术ROW写时重定向。 写时复制是指，当写的时候，将数据复制到快照上去修改源数据；写时重定向是指，写的时候直接去写快照，改变快照上的数据，源卷上的数据不变。\nsnap相关命令\n命令 说明 snap create (snap add) 创建快照 snap limit clear 清除快照数量限制 snap limit set 设定一个镜像文件上所能够创建的快照问价你的上线 snap list (snap ls) 列出快照 snap protect 保护快照 snap purge 清理快照 snap remove (snap rm) 移除快照 snap rename 重命名快照 snap rollback (snap revert) 回滚快照，做快照恢复 snap unprotect 解除保护，protect的相反操作。 为镜像创建快照\nrbd snap create只需为哪个镜像创建什么快照就可以了\nsh 1 2 3 4 5 6 rbd snap create kube/vol01@snap1 $ rbd snap list kube/vol01 SNAPID NAME SIZE TIMESTAMP 4 snap1 2 GiB Thu Jun 27 14:00:36 2019 快照恢复\n首先先将服务停止（拆除）\nsh 1 2 umount /rdb # 卸载挂载 rbd unmap /dev/rbd0 # 拆除连接 回到管理节点做回滚操作\n使用rbd snap rollback\nsh 1 2 $ rbd snap rollback kube/vol01@snap1 Rolling back to snapshot: 100% complete...done. 回到客户端再一次将映射挂载访问\nsh 1 2 3 4 5 6 7 rbd --user kube map /dev/rbd0 # 映射 mount /dev/rbd0 /rdb # 挂载 # 查看数据 $ ls lost+found passwd 删除快照\nsh 1 rbd snap rm kube.vol01@snap1 限制镜像文件所能够创建的快照数量\nsh 1 2 3 4 5 6 rbd snap limit set kube/vol01 --limit 2 $ rbd snap create kube/vol01@snap03 rbd: failed to create snapshot: (122) Disk quota exceeded rbd snap limit clear kube/vol01 # 清除限制 多层快照技术\n对原始镜像文件做一次快照，将此快照置于保护模式下。快照所能访问的数据一定是做快照那一刻原始卷上的所有数据的。就算修改原始卷内容，也不会影响快照访问。基于快照再做一层快照。而二级快照是可以当镜像来用的。因此基于保护快照可以创建N个克隆。每一个克隆都可以按照自己的意愿去做希望所做的后续修改操作。\n模板池，提供克隆模板的。\n工作流程\n创建镜像 对镜像做快照 对快照做保护 对快照做克隆 在管理断创建快照，将此快照当做保护模式下的快照，当做创建克隆时的模板\nsh 1 2 3 4 5 6 7 8 9 10 $ rbd snap create kube/vol01@clonetpl1 $ rbd snap ls rbd: image name was not specified $ rbd snap ls kube/vol01 SNAPID NAME SIZE TIMESTAMP 4 snap1 2 GiB Thu Jun 27 14:00:36 2019 5 snap02 2 GiB Thu Jun 27 14:41:25 2019 8 clonetpl1 10 GiB Thu Jun 27 20:43:48 2019 置入保护模式\nsh 1 2 3 $ rbd snap protect kube/vol01@clonetpl1 rbd snap unprotect kube/vol01:clonetpl1 # 解除保护 给快照再次做快照，称之为clone。==可支持跨存储池进行克隆==\nsh 1 2 3 4 $ rbd clone kube/vol01@clonetpl1 test/myimg01 # 是一个镜像，可被当做真正镜像使用 $ rbd ls -p test myimg01 rbd chlidren显示一个快照的子项\nsh 1 2 3 $ rbd children kube/vol01@clonetpl1 kube/myimg01 test/myimg01 数据展平 flatten\n当vol01被删除时，他的上层快照myimg01就无根了，因此需要做数据展平，已确保他所应用的每一个底层快照上的所有数据都被复制到当前镜像中。\nsh 1 2 $ rbd flatten kube/myimg01 Image flatten: 100% complete...done. ","wordCount":"1289","inLanguage":"zh","datePublished":"2019-07-31T00:00:00Z","dateModified":"2023-09-07T23:10:36+08:00","author":{"@type":"Person","name":"cylon"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.oomkill.com/2019/07/03-2-rbd-management/"},"publisher":{"@type":"Organization","name":"Cylon's Collection","logo":{"@type":"ImageObject","url":"https://www.oomkill.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.oomkill.com/><img src=https://www.oomkill.com/favicon.ico alt aria-label=logo height=20>Cylon's Collection</a><div class=logo-switches><button id=theme-toggle><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://www.oomkill.com/archives><span>归档</span></a></li><li><a href=https://www.oomkill.com/tags><span>标签</span></a></li><li><a href=https://www.oomkill.com/search><span>搜索</span></a></li><li><a href=https://www.oomkill.com/about accesskey=/><span>关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Ceph RBD - 关于RBD的操作与管理</h1><div class=post-meta><span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar" style="user-select:text"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" style="user-select:text"/><line x1="16" y1="2" x2="16" y2="6" style="user-select:text"/><line x1="8" y1="2" x2="8" y2="6" style="user-select:text"/><line x1="3" y1="10" x2="21" y2="10" style="user-select:text"/></svg><span>2019-07-31</span></span>&nbsp;·&nbsp;<span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text" style="user-select:text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z" style="user-select:text"/><polyline points="14 2 14 8 20 8" style="user-select:text"/><line x1="16" y1="13" x2="8" y2="13" style="user-select:text"/><line x1="16" y1="17" x2="8" y2="17" style="user-select:text"/><polyline points="10 9 9 9 8 9" style="user-select:text"/></svg><span>1289 字</span></span>&nbsp;·&nbsp;<span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><span>7 分钟</span></span>
<span class=pe-post-meta-item>&nbsp;·&nbsp;<svg t="1714036239378" fill="currentcolor" class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="6659" width="256" height="256"><path d="M690 78.2c-18.6-18.8-49-19-67.8-.4s-19 49-.4 67.8l255.4 258.6c67.8 68.6 67.8 178.8.0 247.4L653.4 878.2c-18.6 18.8-18.4 49.2.4 67.8s49.2 18.4 67.8-.4l224-226.4c104.8-106 104.8-276.4.0-382.4L690 78.2zM485.4 101.4c-24-24-56.6-37.4-90.6-37.4H96C43 64 0 107 0 160v299c0 34 13.4 66.6 37.4 90.6l336 336c50 50 131 50 181 0l267-267c50-50 50-131 0-181l-336-336zM96 160h299c8.4.0 16.6 3.4 22.6 9.4l336 336c12.4 12.4 12.4 32.8.0 45.2l-267 267c-12.4 12.4-32.8 12.4-45.2.0l-336-336c-6-6-9.4-14.2-9.4-22.6V160zm192 128a64 64 0 10-128 0 64 64 0 10128 0z" p-id="6660"/></svg></span><ul class=pe-post-meta-item><a href=https://www.oomkill.com/tags/storage/>#Storage</a></ul></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details><summary><span class=details>目录</span></summary><div class=inner><ul><li><a href=#ceph%e5%9d%97%e8%ae%be%e5%a4%87%e6%8e%a5%e5%8f%a3rdb aria-label=ceph块设备接口（RDB）>ceph块设备接口（RDB）</a></li></div></details></div></aside><script src=/js/pe-toc.min.445eb1bfc5e85dd13b9519fcc2a806522e9629b6224a2974052789ba00ab78af.js integrity="sha256-RF6xv8XoXdE7lRn8wqgGUi6WKbYiSil0BSeJugCreK8="></script><div class=post-content><p>上一章提到了 RBD 块设备相关的基本配置，这章主要描述 RBD 操作部分</p><h3 id=ceph块设备接口rdb>ceph块设备接口（RDB）<a hidden class=anchor aria-hidden=true href=#ceph块设备接口rdb>#</a></h3><p>Ceph块设备，也称为RADOS块设备（简称RBD），是一种基于RADOS存储系统支持超配（thin-provisioned）、可伸缩的条带化数据存储系统，它通过librbd库与OSD进行交互。RBD为KVM等虑拟化技术和云OS（如OpenStack和CloudStack）提供高性能和无限可扩展性的存储后端，这些系统依赖于libvirt和QEMU实用程序与RBD进行集成。</p><p>客户端基于librbd库即可将RADOS存储集群用作块设备，不过，用于rbd的存储池需要实现启用rbd功能并进行初始化。例如，下面的命令创建rbddata的存储池，在启动rbd功能后对其进行初始化。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>sh</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>ceph osd pool create rbdpool <span class=m>64</span>  <span class=c1># 创建存储池</span>
</span></span><span class=line><span class=cl>rbd pool init -p rbdpool <span class=c1># </span>
</span></span><span class=line><span class=cl>rbd create rbdpool/img1 --size 2G 
</span></span><span class=line><span class=cl>rbd ls -p rbdpool</span></span></code></pre></td></tr></table></div></div></div></div><p>不过rbd存储池并不能直接用于块设备，而是需要事先在其中按需创建影响（image）</p><p>RBD是建立在librados之上的客户端，全程为Rados Block Devices，是对rados存储服务做抽象，将rados位于存储池当中所提供的存储空间，使用对象式存储数据的能力的机制。</p><p>rbd虚拟磁盘设备要想使linux内核所识别使用，要求linux在内核级支持Ceph，内核级有一个Ceph模块，专门用来驱动Ceph设备的。这个驱动就叫librbd。此模块自己是一个客户端，能够连接至RBD服务上，检索出他所管理的镜像文件。从而镜像文件完全可以被linux主机作为一块完整的硬盘来使用。</p><blockquote><p><strong>创建存储池镜像</strong></p></blockquote><ul><li><code>--object-size</code> 任何数据存储在存储池中都被切分为固定大小的对象，对象通常称之为条带，切分的对象大小，默认4M</li><li><code>--image-feature</code> 指定镜像文件的特性，每种特性代表镜像文件能支持哪些种功能，可被单独启用或禁用。<ul><li><code>layering(+)</code>, 分层克隆</li><li><code>exclusive-lock</code> 排它锁，是否支持分布式排它锁，已用来限制一个镜像文件同时只能被一个客户端使用。</li><li><code>object-map(+*)</code> 对象映射,是否支持对象位图，主要用于加速导入、导出及已用容量统的。</li><li><code>fast-diff(+*)</code>, 快速比较，主要用于做快照之间的比较</li><li><code>deep-flatten(+-)</code> , 深层展评</li><li><code>journaling</code> 日志，用户在修改image数据时是否记录日志。
shared image</li></ul></li><li><code>--no-progress</code>：不显示创建过程</li></ul><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>sh</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ rbd <span class=nb>help</span> create
</span></span><span class=line><span class=cl>usage: rbd create <span class=o>[</span>--pool &lt;pool&gt;<span class=o>]</span> <span class=o>[</span>--image &lt;image&gt;<span class=o>]</span> 
</span></span><span class=line><span class=cl>                  <span class=o>[</span>--image-format &lt;image-format&gt;<span class=o>]</span> <span class=o>[</span>--new-format<span class=o>]</span> 
</span></span><span class=line><span class=cl>                  <span class=o>[</span>--order &lt;order&gt;<span class=o>]</span> <span class=o>[</span>--object-size &lt;object-size&gt;<span class=o>]</span> 
</span></span><span class=line><span class=cl>                  <span class=o>[</span>--image-feature &lt;image-feature&gt;<span class=o>]</span> <span class=o>[</span>--image-shared<span class=o>]</span> 
</span></span><span class=line><span class=cl>                  <span class=o>[</span>--stripe-unit &lt;stripe-unit&gt;<span class=o>]</span> 
</span></span><span class=line><span class=cl>                  <span class=o>[</span>--stripe-count &lt;stripe-count&gt;<span class=o>]</span> <span class=o>[</span>--data-pool &lt;data-pool&gt;<span class=o>]</span> 
</span></span><span class=line><span class=cl>                  <span class=o>[</span>--journal-splay-width &lt;journal-splay-width&gt;<span class=o>]</span> 
</span></span><span class=line><span class=cl>                  <span class=o>[</span>--journal-object-size &lt;journal-object-size&gt;<span class=o>]</span> 
</span></span><span class=line><span class=cl>                  <span class=o>[</span>--journal-pool &lt;journal-pool&gt;<span class=o>]</span> 
</span></span><span class=line><span class=cl>                  <span class=o>[</span>--thick-provision<span class=o>]</span> --size &lt;size&gt; <span class=o>[</span>--no-progress<span class=o>]</span> 
</span></span><span class=line><span class=cl>                  &lt;image-spec&gt; 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Create an empty image.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ceph osd pool create kube <span class=m>64</span> <span class=m>64</span>
</span></span><span class=line><span class=cl>ceph osd pool application <span class=nb>enable</span> kube rbd
</span></span><span class=line><span class=cl>rbd pool init kube
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>rbd create --size 2G --pool kube --image vol01 <span class=c1># 使用各个选项</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>rbd create --size 2G kube/vol02  <span class=c1># &lt;image-spec&gt; </span></span></span></code></pre></td></tr></table></div></div></div></div><blockquote><p>获取对象更详细信息</p></blockquote><p>PARENT 父镜像</p><p>FMT 格式，一般只有v2</p><p>PROT</p><p>LOCK</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>sh</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ rbd ls -l --pool kube
</span></span><span class=line><span class=cl>NAME   SIZE PARENT FMT PROT LOCK 
</span></span><span class=line><span class=cl>vol01 <span class=m>5</span> GiB          <span class=m>2</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ rbd ls -l --pool kube --format json --pretty-format
</span></span><span class=line><span class=cl><span class=o>[</span>
</span></span><span class=line><span class=cl>    <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;image&#34;</span>: <span class=s2>&#34;vol01&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;size&#34;</span>: 5368709120,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;format&#34;</span>: <span class=m>2</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>]</span></span></span></code></pre></td></tr></table></div></div></div></div><p>获取镜像文件更详细一部镜像信息，可以使用<code>rbd info</code>命令</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>sh</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ rbd info kube/vol01
</span></span><span class=line><span class=cl>rbd image <span class=s1>&#39;vol01&#39;</span>:
</span></span><span class=line><span class=cl>        size <span class=m>5</span> GiB in <span class=m>1280</span> objects
</span></span><span class=line><span class=cl>        order <span class=m>22</span> <span class=o>(</span><span class=m>4</span> MiB objects<span class=o>)</span>
</span></span><span class=line><span class=cl>        id: 5e386b8b4567
</span></span><span class=line><span class=cl>        block_name_prefix: rbd_data.5e386b8b4567
</span></span><span class=line><span class=cl>        format: <span class=m>2</span>
</span></span><span class=line><span class=cl>        features: layering, exclusive-lock, object-map, fast-diff, deep-flatten
</span></span><span class=line><span class=cl>        op_features: 
</span></span><span class=line><span class=cl>        flags: 
</span></span><span class=line><span class=cl>        create_timestamp: Mon Jun <span class=m>24</span> 05:42:00 <span class=m>2019</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ rbd info --pool kube --image vol01
</span></span><span class=line><span class=cl>rbd image <span class=s1>&#39;vol01&#39;</span>:
</span></span><span class=line><span class=cl>        size <span class=m>5</span> GiB in <span class=m>1280</span> objects
</span></span><span class=line><span class=cl>        order <span class=m>22</span> <span class=o>(</span><span class=m>4</span> MiB objects<span class=o>)</span>
</span></span><span class=line><span class=cl>        id: 5e386b8b4567
</span></span><span class=line><span class=cl>        block_name_prefix: rbd_data.5e386b8b4567
</span></span><span class=line><span class=cl>        format: <span class=m>2</span>
</span></span><span class=line><span class=cl>        features: layering, exclusive-lock, object-map, fast-diff, deep-flatten
</span></span><span class=line><span class=cl>        op_features: 
</span></span><span class=line><span class=cl>        flags: 
</span></span><span class=line><span class=cl>        create_timestamp: Mon Jun <span class=m>24</span> 05:42:00 <span class=m>2019</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ rbd info --pool kube vol01        
</span></span><span class=line><span class=cl>rbd image <span class=s1>&#39;vol01&#39;</span>:  <span class=c1># 镜像文件是谁</span>
</span></span><span class=line><span class=cl>        size <span class=m>5</span> GiB in <span class=m>1280</span> objects <span class=c1># 镜像总体是多大空间，被分割成多少个对象</span>
</span></span><span class=line><span class=cl>        order <span class=m>22</span> <span class=o>(</span><span class=m>4</span> MiB objects<span class=o>)</span> <span class=c1># 顺序是22，顺序是指块大小的标识序号 # 如64k开始64m结束，4M大小正好排在第22位</span>
</span></span><span class=line><span class=cl>        id: 5e386b8b4567 <span class=c1># 镜像文件自身id</span>
</span></span><span class=line><span class=cl>        block_name_prefix: rbd_data.5e386b8b4567
</span></span><span class=line><span class=cl>        format: <span class=m>2</span> <span class=c1># 镜像文件格式</span>
</span></span><span class=line><span class=cl>        features: layering, exclusive-lock, object-map, fast-diff, deep-flatten <span class=c1># 启动的特性</span>
</span></span><span class=line><span class=cl>        op_features:  
</span></span><span class=line><span class=cl>        flags: 
</span></span><span class=line><span class=cl>        create_timestamp: Mon Jun <span class=m>24</span> 05:42:00 <span class=m>2019</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl><span class=c1># object-map, fast-diff, deep-flatten种特性在被linux客户端作为磁盘加载到内核中使用时是不被支持的。需将其禁用掉        </span></span></span></code></pre></td></tr></table></div></div></div></div><blockquote><p>禁用或启用某种特性 <code>rbd featrue</code></p></blockquote><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>sh</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>rbd feature disable<span class=p>|</span><span class=nb>enable</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>rbd feature disable kube/vol01 object-map fast-diff deep-flatten</span></span></code></pre></td></tr></table></div></div></div></div><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>sh</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ rbd info --pool kube vol01
</span></span><span class=line><span class=cl>rbd image <span class=s1>&#39;vol01&#39;</span>:
</span></span><span class=line><span class=cl>        size <span class=m>5</span> GiB in <span class=m>1280</span> objects
</span></span><span class=line><span class=cl>        order <span class=m>22</span> <span class=o>(</span><span class=m>4</span> MiB objects<span class=o>)</span>
</span></span><span class=line><span class=cl>        id: 5e386b8b4567
</span></span><span class=line><span class=cl>        block_name_prefix: rbd_data.5e386b8b4567
</span></span><span class=line><span class=cl>        format: <span class=m>2</span>
</span></span><span class=line><span class=cl>        features: layering, exclusive-lock
</span></span><span class=line><span class=cl>        op_features: 
</span></span><span class=line><span class=cl>        flags: 
</span></span><span class=line><span class=cl>        create_timestamp: Mon Jun <span class=m>24</span> 05:42:00 <span class=m>2019</span></span></span></code></pre></td></tr></table></div></div></div></div><blockquote><p><strong>Ceph客户端使用块设备步骤</strong></p></blockquote><ul><li>创建出镜像文件。</li><li>在镜像文件上禁用默认启用的五个特性中的后三个。</li><li>在客户端上使用指定命令以指定的用户的身份连入客户端。</li><li>配置客户端上yum仓库文件</li></ul><p>ceph命令默认是以admin为账号的，使用<code>--user</code>指定其他用户。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>text</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>$ ceph -s
</span></span><span class=line><span class=cl>2019-06-25 10:48:11.283 7f999daa3700 -1 auth: unable to find a keyring on /etc/ceph/ceph.client.admin.keyring,/etc/ceph/ceph.keyring,/etc/ceph/keyring,/etc/ceph/keyring.bin,: (2) No such file or directory
</span></span><span class=line><span class=cl>2019-06-25 10:48:11.283 7f999daa3700 -1 monclient: ERROR: missing keyring, cannot use cephx for authentication
</span></span><span class=line><span class=cl>[errno 2] error connecting to the cluster
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ ceph --user kube -s
</span></span><span class=line><span class=cl>  cluster:
</span></span><span class=line><span class=cl>    id:     69fb9b55-3fb5-42d0-8cf7-239a3b569791
</span></span><span class=line><span class=cl>    health: HEALTH_WARN
</span></span><span class=line><span class=cl>            1 pool(s) full
</span></span><span class=line><span class=cl>            application not enabled on 1 pool(s)
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>  services:
</span></span><span class=line><span class=cl>    mon: 3 daemons, quorum stor01,stor02,stor03
</span></span><span class=line><span class=cl>    mgr: stor01(active), standbys: stor04
</span></span><span class=line><span class=cl>    mds: cephfs-1/1/1 up  {0=stor02=up:active}
</span></span><span class=line><span class=cl>    osd: 8 osds: 8 up, 8 in
</span></span><span class=line><span class=cl>    rgw: 1 daemon active
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>  data:
</span></span><span class=line><span class=cl>    pools:   9 pools, 352 pgs
</span></span><span class=line><span class=cl>    objects: 254  objects, 3.7 KiB
</span></span><span class=line><span class=cl>    usage:   49 GiB used, 51 GiB / 100 GiB avail
</span></span><span class=line><span class=cl>    pgs:     352 active+clean</span></span></code></pre></td></tr></table></div></div></div></div><p>需要操作系统支持<code>ceph.ko</code>模块</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>sh</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ modinfo ceph
</span></span><span class=line><span class=cl>filename:       /lib/modules/3.10.0-957.12.1.el7.x86_64/kernel/fs/ceph/ceph.ko.xz
</span></span><span class=line><span class=cl>license:        GPL
</span></span><span class=line><span class=cl>description:    Ceph filesystem <span class=k>for</span> Linux
</span></span><span class=line><span class=cl>author:         Patience Warnick &lt;patience@newdream.net&gt;
</span></span><span class=line><span class=cl>author:         Yehuda Sadeh &lt;yehuda@hq.newdream.net&gt;
</span></span><span class=line><span class=cl>author:         Sage Weil &lt;sage@newdream.net&gt;
</span></span><span class=line><span class=cl>alias:          fs-ceph
</span></span><span class=line><span class=cl>retpoline:      Y
</span></span><span class=line><span class=cl>rhelversion:    7.6
</span></span><span class=line><span class=cl>srcversion:     43DA49DF11334B2A5652931
</span></span><span class=line><span class=cl>depends:        libceph
</span></span><span class=line><span class=cl>intree:         Y
</span></span><span class=line><span class=cl>vermagic:       3.10.0-957.12.1.el7.x86_64 SMP mod_unload modversions 
</span></span><span class=line><span class=cl>signer:         CentOS Linux kernel signing key
</span></span><span class=line><span class=cl>sig_key:        2C:7C:17:70:5C:86:D4:20:80:50:D3:F5:54:56:9A:7B:D3:BF:D1:BF
</span></span><span class=line><span class=cl>sig_hashalgo:   sha256</span></span></code></pre></td></tr></table></div></div></div></div><p>显示设备map信息</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>text</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>$ rbd showmapped
</span></span><span class=line><span class=cl>id pool image snap device    
</span></span><span class=line><span class=cl>0  kube vol01 -    /dev/rbd0 </span></span></code></pre></td></tr></table></div></div></div></div><p>显示设备挂在到哪里</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>sh</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ rbd showmapped
</span></span><span class=line><span class=cl>id pool image snap device    
</span></span><span class=line><span class=cl><span class=m>0</span>  kube vol01 -    /dev/rbd0 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>NAME   SIZE PARENT FMT PROT LOCK 
</span></span><span class=line><span class=cl>vol01 <span class=m>5</span> GiB          <span class=m>2</span>      excl </span></span></code></pre></td></tr></table></div></div></div></div><p>卸载挂载</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>sh</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ umount /dev/rbd0  <span class=c1># 需要先卸载rbd挂载</span>
</span></span><span class=line><span class=cl>$ rbd unmap /dev/rbd0 
</span></span><span class=line><span class=cl>$ rbd showmapped</span></span></code></pre></td></tr></table></div></div></div></div><p>调整镜像文件空间容量</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>sh</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$  rbd <span class=nb>help</span> resize 
</span></span><span class=line><span class=cl>usage: rbd resize <span class=o>[</span>--pool &lt;pool&gt;<span class=o>]</span> <span class=o>[</span>--image &lt;image&gt;<span class=o>]</span> --size &lt;size&gt; 
</span></span><span class=line><span class=cl>                  <span class=o>[</span>--allow-shrink<span class=o>]</span> <span class=o>[</span>--no-progress<span class=o>]</span> 
</span></span><span class=line><span class=cl>                  &lt;image-spec&gt; 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Resize <span class=o>(</span>expand or shrink<span class=o>)</span> image.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Positional arguments
</span></span><span class=line><span class=cl>  &lt;image-spec&gt;         image specification
</span></span><span class=line><span class=cl>                       <span class=o>(</span>example: <span class=o>[</span>&lt;pool-name&gt;/<span class=o>]</span>&lt;image-name&gt;<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Optional arguments
</span></span><span class=line><span class=cl>  -p <span class=o>[</span> --pool <span class=o>]</span> arg    pool name
</span></span><span class=line><span class=cl>  --image arg          image name
</span></span><span class=line><span class=cl>  -s <span class=o>[</span> --size <span class=o>]</span> arg    image size <span class=o>(</span>in M/G/T<span class=o>)</span> <span class=o>[</span>default: M<span class=o>]</span> 
</span></span><span class=line><span class=cl>  --allow-shrink       permit shrinking <span class=c1># 允许收缩，不要收缩到已有数据占用容量、以下</span>
</span></span><span class=line><span class=cl>  --no-progress        disable progress output
</span></span><span class=line><span class=cl>  </span></span></code></pre></td></tr></table></div></div></div></div><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>sh</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ rbd resize -s 10G kube/vol01
</span></span><span class=line><span class=cl>Resizing image: 100% complete...done.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ rbd ls -p kube -l
</span></span><span class=line><span class=cl>NAME    SIZE PARENT FMT PROT LOCK 
</span></span><span class=line><span class=cl>vol01 <span class=m>10</span> GiB  </span></span></code></pre></td></tr></table></div></div></div></div><blockquote><p>删除镜像文件</p></blockquote><p>镜像文件被删除是不可恢复的</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>sh</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ rbd rm kube/vol01
</span></span><span class=line><span class=cl>Removing image: 100% complete...done.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ rbd ls -p kube -l
</span></span><span class=line><span class=cl>$ </span></span></code></pre></td></tr></table></div></div></div></div><blockquote><p>rbd回收站trash</p></blockquote><p>将镜像挪入回收站中</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>sh</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ rbd ls -p kube -l
</span></span><span class=line><span class=cl>NAME   SIZE PARENT FMT PROT LOCK 
</span></span><span class=line><span class=cl>vol01 <span class=m>2</span> GiB          <span class=m>2</span>           
</span></span><span class=line><span class=cl>vol02 <span class=m>2</span> GiB          <span class=m>2</span>       
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ rbd trash move kube/vol01
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ rbd ls -p kube -l       
</span></span><span class=line><span class=cl>NAME   SIZE PARENT FMT PROT LOCK 
</span></span><span class=line><span class=cl>vol02 <span class=m>2</span> GiB          <span class=m>2</span>           
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ rbd trash list -p kube
</span></span><span class=line><span class=cl>5ebf6b8b4567 vol01</span></span></code></pre></td></tr></table></div></div></div></div><p>从trash恢复镜像</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>text</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>$ rbd trash list -p kube
</span></span><span class=line><span class=cl>5ebf6b8b4567 vol01
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>$ rbd trash restore -p kube --image vol01 --image-id 5ebf6b8b4567
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ rbd ls -p kube 
</span></span><span class=line><span class=cl>vol01
</span></span><span class=line><span class=cl>vol02</span></span></code></pre></td></tr></table></div></div></div></div><p>如何对镜像文件做快照、克隆</p><p>快照是什么？</p><p>快照是一种能够瞬间生成数据访问目录，能够支持备份技术的一种数据管理手段。有全量快照与增量快照两种。全量快照一般使用镜像分离技术实现，而增量快照则由<code>COW</code>写时拷贝快照技术<code>ROW</code>写时重定向。
写时复制是指，当写的时候，将数据复制到快照上去修改源数据；写时重定向是指，写的时候直接去写快照，改变快照上的数据，源卷上的数据不变。</p><p>snap相关命令</p><table><thead><tr><th>命令</th><th>说明</th></tr></thead><tbody><tr><td>snap create (snap add)</td><td>创建快照</td></tr><tr><td>snap limit clear</td><td>清除快照数量限制</td></tr><tr><td>snap limit set</td><td>设定一个镜像文件上所能够创建的快照问价你的上线</td></tr><tr><td>snap list (snap ls)</td><td>列出快照</td></tr><tr><td>snap protect</td><td>保护快照</td></tr><tr><td>snap purge</td><td>清理快照</td></tr><tr><td>snap remove (snap rm)</td><td>移除快照</td></tr><tr><td>snap rename</td><td>重命名快照</td></tr><tr><td>snap rollback (snap revert)</td><td>回滚快照，做快照恢复</td></tr><tr><td>snap unprotect</td><td>解除保护，protect的相反操作。</td></tr></tbody></table><p>为镜像创建快照</p><p><code>rbd snap create</code>只需为哪个镜像创建什么快照就可以了</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>sh</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>rbd snap create kube/vol01@snap1
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ rbd snap list kube/vol01
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>SNAPID NAME   SIZE TIMESTAMP                
</span></span><span class=line><span class=cl>     <span class=m>4</span> snap1 <span class=m>2</span> GiB Thu Jun <span class=m>27</span> 14:00:36 <span class=m>2019</span> </span></span></code></pre></td></tr></table></div></div></div></div><p>快照恢复</p><p>首先先将服务停止（拆除）</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>sh</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>umount /rdb <span class=c1># 卸载挂载</span>
</span></span><span class=line><span class=cl>rbd unmap /dev/rbd0 <span class=c1># 拆除连接</span></span></span></code></pre></td></tr></table></div></div></div></div><p>回到管理节点做回滚操作</p><p>使用<code>rbd snap rollback</code></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>sh</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ rbd snap rollback kube/vol01@snap1
</span></span><span class=line><span class=cl>Rolling back to snapshot: 100% complete...done.</span></span></code></pre></td></tr></table></div></div></div></div><p>回到客户端再一次将映射挂载访问</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>sh</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>rbd --user kube map /dev/rbd0 <span class=c1># 映射</span>
</span></span><span class=line><span class=cl>mount /dev/rbd0 /rdb <span class=c1># 挂载</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看数据</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ ls
</span></span><span class=line><span class=cl>lost+found  passwd</span></span></code></pre></td></tr></table></div></div></div></div><p>删除快照</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>sh</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>rbd snap rm kube.vol01@snap1</span></span></code></pre></td></tr></table></div></div></div></div><p>限制镜像文件所能够创建的快照数量</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>sh</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>rbd snap limit <span class=nb>set</span> kube/vol01 --limit <span class=m>2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$  rbd snap create kube/vol01@snap03
</span></span><span class=line><span class=cl>rbd: failed to create snapshot: <span class=o>(</span>122<span class=o>)</span> Disk quota exceeded
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>rbd snap limit clear kube/vol01 <span class=c1># 清除限制</span></span></span></code></pre></td></tr></table></div></div></div></div><p>多层快照技术</p><p>对原始镜像文件做一次快照，将此快照置于保护模式下。快照所能访问的数据一定是做快照那一刻原始卷上的所有数据的。就算修改原始卷内容，也不会影响快照访问。基于快照再做一层快照。而二级快照是可以当镜像来用的。因此基于保护快照可以创建N个克隆。每一个克隆都可以按照自己的意愿去做希望所做的后续修改操作。</p><p>模板池，提供克隆模板的。</p><p>工作流程</p><ul><li>创建镜像</li><li>对镜像做快照</li><li>对快照做保护</li><li>对快照做克隆</li></ul><p>在管理断创建快照，将此快照当做保护模式下的快照，当做创建克隆时的模板</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>sh</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ rbd snap create kube/vol01@clonetpl1
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ rbd snap ls
</span></span><span class=line><span class=cl>rbd: image name was not specified
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ rbd snap ls kube/vol01
</span></span><span class=line><span class=cl>SNAPID NAME        SIZE TIMESTAMP                
</span></span><span class=line><span class=cl>     <span class=m>4</span> snap1      <span class=m>2</span> GiB Thu Jun <span class=m>27</span> 14:00:36 <span class=m>2019</span> 
</span></span><span class=line><span class=cl>     <span class=m>5</span> snap02     <span class=m>2</span> GiB Thu Jun <span class=m>27</span> 14:41:25 <span class=m>2019</span> 
</span></span><span class=line><span class=cl>     <span class=m>8</span> clonetpl1 <span class=m>10</span> GiB Thu Jun <span class=m>27</span> 20:43:48 <span class=m>2019</span> </span></span></code></pre></td></tr></table></div></div></div></div><p>置入保护模式</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>sh</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ rbd snap protect kube/vol01@clonetpl1
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>rbd snap unprotect kube/vol01:clonetpl1 <span class=c1># 解除保护</span></span></span></code></pre></td></tr></table></div></div></div></div><p>给快照再次做快照，称之为clone。==可支持跨存储池进行克隆==</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>sh</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ rbd clone kube/vol01@clonetpl1 test/myimg01 <span class=c1># 是一个镜像，可被当做真正镜像使用</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ rbd ls -p <span class=nb>test</span>
</span></span><span class=line><span class=cl>myimg01</span></span></code></pre></td></tr></table></div></div></div></div><p><code>rbd chlidren</code>显示一个快照的子项</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>sh</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ rbd children kube/vol01@clonetpl1  
</span></span><span class=line><span class=cl>kube/myimg01
</span></span><span class=line><span class=cl>test/myimg01</span></span></code></pre></td></tr></table></div></div></div></div><p>数据展平 flatten</p><p>当vol01被删除时，他的上层快照myimg01就无根了，因此需要做数据展平，已确保他所应用的每一个底层快照上的所有数据都被复制到当前镜像中。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>sh</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ rbd flatten kube/myimg01
</span></span><span class=line><span class=cl>Image flatten: 100% complete...done.</span></span></code></pre></td></tr></table></div></div></div></div></div><div class=pe-copyright><hr><blockquote><p>本文为原创内容，版权归作者所有。如需转载，请在文章中声明本文标题及链接。</p><p>文章标题：Ceph RBD - 关于RBD的操作与管理</p><p>文章链接：<a href=https://www.oomkill.com/2019/07/03-2-rbd-management/ target=_blank>https://www.oomkill.com/2019/07/03-2-rbd-management/</a></p><p>许可协议：<a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></p></blockquote></div><div class=comments-separator></div><h3 class=relatedContentTitle>相关阅读</h3><ul class=relatedContent><li><a href=/2019/07/05-1-rgw/><span>Ceph对象存储概述</span></a></li><li><a href=/2019/07/04-1-cephfs/><span>Ceph文件系统概述</span></a></li><li><a href=/2019/06/07-1-cephx/><span>Ceph安全 - CephX</span></a></li><li><a href=/2019/06/01-1-ceph-acquaintance/><span>Ceph概念 - 初识Ceph</span></a></li><li><a href=/2019/06/08-1-ceph-crush/><span>Ceph算法 - crush</span></a></li></ul><div class=comments-separator></div><footer class=post-footer><ul class=post-tags><li><a href=https://www.oomkill.com/tags/storage/>Storage</a></li></ul><nav class=paginav><a class=prev href=https://www.oomkill.com/2019/08/ch1-understanding-ldap/><span class=title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left" style="user-select:text"><line x1="19" y1="12" x2="5" y2="12" style="user-select:text"/><polyline points="12 19 5 12 12 5" style="user-select:text"/></polyline></svg>&nbsp;</span>
<span>理解ldap - 什么是ldap</span>
</a><a class=next href=https://www.oomkill.com/2019/07/05-1-rgw/><span class=title></span>
<span>Ceph对象存储概述&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right" style="user-select:text"><line x1="5" y1="12" x2="19" y2="12" style="user-select:text"/><polyline points="12 5 19 12 12 19" style="user-select:text"/></svg></span></a></nav></footer><div class=pe-comments-decoration><p class=pe-comments-title></p><p class=pe-comments-subtitle></p></div><div id=pe-comments></div><script src=/js/pe-go-comment.min.86a214102576ba5f9b7bdc29eed8d58dd56e34aef80b3c65c73ea9cc88443696.js integrity="sha256-hqIUECV2ul+be9wp7tjVjdVuNK74Czxlxz6pzIhENpY="></script><script>const getStoredTheme=()=>localStorage.getItem("pref-theme")==="dark"?"dark":"light",setGiscusTheme=()=>{const e=e=>{const t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:e},"https://giscus.app")};e({setConfig:{theme:getStoredTheme()}})};document.addEventListener("DOMContentLoaded",()=>{const s={src:"https://giscus.app/client.js","data-repo":"cylonchau/cylonchau.github.io","data-repo-id":"R_kgDOIRlNSQ","data-category":"Announcements","data-category-id":"DIC_kwDOIRlNSc4CXy1U","data-mapping":"pathname","data-term":"posts/03-2 rbd-management","data-strict":"0","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"top","data-theme":getStoredTheme(),"data-lang":"zh-TW","data-loading":"lazy",crossorigin:"anonymous",async:""},e=document.createElement("script");Object.entries(s).forEach(([t,n])=>e.setAttribute(t,n)),document.querySelector("#pe-comments").appendChild(e);const t=document.querySelector("#theme-toggle");t&&t.addEventListener("click",setGiscusTheme);const n=document.querySelector("#theme-toggle-float");n&&n.addEventListener("click",setGiscusTheme)})</script></article></main><footer class=footer><span>&copy; 2024 <a href=https://www.oomkill.com/>Cylon's Collection</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> on
<a href=https://pages.github.com/ rel=noopener target=_blank>GitHub Pages</a> & Theme
        <a href=https://github.com/tofuwine/PaperMod-PE rel=noopener target=_blank>PaperMod-PE</a></span></footer><div class=pe-right-sidebar><a href=javascript:void(0); id=theme-toggle-float class=pe-float-btn><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</a><a href=#top class=pe-float-btn id=top-link><span id=pe-read-progress></span></a></div><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>