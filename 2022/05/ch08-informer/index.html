<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>源码分析client-go架构 - 什么是informer | Cylon's Collection</title>
<meta name=keywords content="kubernetes,develop,informer"><meta name=description content="之前了解了client-go中的架构设计，也就是 tools/cache 下面的一些概念，那么下面将对informer进行分析
Controller 在client-go informer架构中存在一个 controller ，这个不是 Kubernetes 中的Controller组件；而是在 tools/cache 中的一个概念，controller 位于 informer 之下，Reflector 之上。code
Config 从严格意义上来讲，controller 是作为一个 sharedInformer 使用，通过接受一个 Config ，而 Reflector 则作为 controller 的 slot。Config 则包含了这个 controller 里所有的设置。
go 1 2 3 4 5 6 7 8 9 type Config struct { Queue // DeltaFIFO ListerWatcher // 用于list watch的 Process ProcessFunc // 定义如何从DeltaFIFO中弹出数据后处理的操作 ObjectType runtime.Object // Controller处理的对象数据，实际上就是kubernetes中的资源 FullResyncPeriod time.Duration // 全量同步的周期 ShouldResync ShouldResyncFunc // Reflector通过该标记来确定是否应该重新同步 RetryOnError bool } controller 然后 controller 又为 reflertor 的上层"><meta name=author content="cylon"><link rel=canonical href=https://www.oomkill.com/2022/05/ch08-informer/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://www.oomkill.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.oomkill.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.oomkill.com/favicon-32x32.png><link rel=apple-touch-icon href=https://www.oomkill.com/favicon.ico><link rel=mask-icon href=https://www.oomkill.com/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://www.oomkill.com/2022/05/ch08-informer/><noscript><style>#theme-toggle,#top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link crossorigin=anonymous href=/assets/css/pe.min.css rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/pe.min.js></script><link rel=stylesheet href=https://cdn.staticfile.net/font-awesome/6.5.1/css/all.min.css><link rel=stylesheet href=https://cdn.staticfile.net/font-awesome/6.5.1/css/v4-shims.min.css><script defer src=https://cdn.staticfile.net/jquery/3.5.1/jquery.min.js></script><link rel=stylesheet href=https://cdn.staticfile.net/fancybox/3.5.7/jquery.fancybox.min.css><script defer src=https://cdn.staticfile.net/fancybox/3.5.7/jquery.fancybox.min.js></script><script id=MathJax-script async src=https://cdn.staticfile.net/mathjax/3.2.2/es5/tex-chtml.js></script><script>MathJax={tex:{displayMath:[["$$","$$"]],inlineMath:[["\\$","\\$"]]}}</script><meta property="og:title" content="源码分析client-go架构 - 什么是informer"><meta property="og:description" content="之前了解了client-go中的架构设计，也就是 tools/cache 下面的一些概念，那么下面将对informer进行分析
Controller 在client-go informer架构中存在一个 controller ，这个不是 Kubernetes 中的Controller组件；而是在 tools/cache 中的一个概念，controller 位于 informer 之下，Reflector 之上。code
Config 从严格意义上来讲，controller 是作为一个 sharedInformer 使用，通过接受一个 Config ，而 Reflector 则作为 controller 的 slot。Config 则包含了这个 controller 里所有的设置。
go 1 2 3 4 5 6 7 8 9 type Config struct { Queue // DeltaFIFO ListerWatcher // 用于list watch的 Process ProcessFunc // 定义如何从DeltaFIFO中弹出数据后处理的操作 ObjectType runtime.Object // Controller处理的对象数据，实际上就是kubernetes中的资源 FullResyncPeriod time.Duration // 全量同步的周期 ShouldResync ShouldResyncFunc // Reflector通过该标记来确定是否应该重新同步 RetryOnError bool } controller 然后 controller 又为 reflertor 的上层"><meta property="og:type" content="article"><meta property="og:url" content="https://www.oomkill.com/2022/05/ch08-informer/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-05-25T00:00:00+00:00"><meta property="article:modified_time" content="2023-03-18T23:00:36+08:00"><meta property="og:site_name" content="Cylon's Collection"><meta name=twitter:card content="summary"><meta name=twitter:title content="源码分析client-go架构 - 什么是informer"><meta name=twitter:description content="之前了解了client-go中的架构设计，也就是 tools/cache 下面的一些概念，那么下面将对informer进行分析
Controller 在client-go informer架构中存在一个 controller ，这个不是 Kubernetes 中的Controller组件；而是在 tools/cache 中的一个概念，controller 位于 informer 之下，Reflector 之上。code
Config 从严格意义上来讲，controller 是作为一个 sharedInformer 使用，通过接受一个 Config ，而 Reflector 则作为 controller 的 slot。Config 则包含了这个 controller 里所有的设置。
go 1 2 3 4 5 6 7 8 9 type Config struct { Queue // DeltaFIFO ListerWatcher // 用于list watch的 Process ProcessFunc // 定义如何从DeltaFIFO中弹出数据后处理的操作 ObjectType runtime.Object // Controller处理的对象数据，实际上就是kubernetes中的资源 FullResyncPeriod time.Duration // 全量同步的周期 ShouldResync ShouldResyncFunc // Reflector通过该标记来确定是否应该重新同步 RetryOnError bool } controller 然后 controller 又为 reflertor 的上层"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://www.oomkill.com/posts/"},{"@type":"ListItem","position":2,"name":"源码分析client-go架构 - 什么是informer","item":"https://www.oomkill.com/2022/05/ch08-informer/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"源码分析client-go架构 - 什么是informer","name":"源码分析client-go架构 - 什么是informer","description":"之前了解了client-go中的架构设计，也就是 tools/cache 下面的一些概念，那么下面将对informer进行分析\nController 在client-go informer架构中存在一个 controller ，这个不是 Kubernetes 中的Controller组件；而是在 tools/cache 中的一个概念，controller 位于 informer 之下，Reflector 之上。code\nConfig 从严格意义上来讲，controller 是作为一个 sharedInformer 使用，通过接受一个 Config ，而 Reflector 则作为 controller 的 slot。Config 则包含了这个 controller 里所有的设置。\ngo 1 2 3 4 5 6 7 8 9 type Config struct { Queue // DeltaFIFO ListerWatcher // 用于list watch的 Process ProcessFunc // 定义如何从DeltaFIFO中弹出数据后处理的操作 ObjectType runtime.Object // Controller处理的对象数据，实际上就是kubernetes中的资源 FullResyncPeriod time.Duration // 全量同步的周期 ShouldResync ShouldResyncFunc // Reflector通过该标记来确定是否应该重新同步 RetryOnError bool } controller 然后 controller 又为 reflertor 的上层","keywords":["kubernetes","develop","informer"],"articleBody":"之前了解了client-go中的架构设计，也就是 tools/cache 下面的一些概念，那么下面将对informer进行分析\nController 在client-go informer架构中存在一个 controller ，这个不是 Kubernetes 中的Controller组件；而是在 tools/cache 中的一个概念，controller 位于 informer 之下，Reflector 之上。code\nConfig 从严格意义上来讲，controller 是作为一个 sharedInformer 使用，通过接受一个 Config ，而 Reflector 则作为 controller 的 slot。Config 则包含了这个 controller 里所有的设置。\ngo 1 2 3 4 5 6 7 8 9 type Config struct { Queue // DeltaFIFO ListerWatcher // 用于list watch的 Process ProcessFunc // 定义如何从DeltaFIFO中弹出数据后处理的操作 ObjectType runtime.Object // Controller处理的对象数据，实际上就是kubernetes中的资源 FullResyncPeriod time.Duration // 全量同步的周期 ShouldResync ShouldResyncFunc // Reflector通过该标记来确定是否应该重新同步 RetryOnError bool } controller 然后 controller 又为 reflertor 的上层\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 type controller struct { config Config reflector *Reflector reflectorMutex sync.RWMutex clock clock.Clock } type Controller interface { // controller 主要做两件事， // 1. 构建并运行 Reflector,将listerwacther中的泵压到queue（Delta fifo）中 // 2. Queue用Pop()弹出数据，具体的操作是Process // 直到 stopCh 不阻塞，这两个协程将退出 Run(stopCh \u003c-chan struct{}) HasSynced() bool // 这个实际上是从store中继承的，标记这个controller已经 LastSyncResourceVersion() string } controller 中的方法，仅有一个 Run() 和 New()；这意味着，controller 只是一个抽象的概念，作为 Reflector, Delta FIFO 整合的工作流\n而 controller 则是 SharedInformer 了。\nQueue 这里的 queue 可以理解为是一个具有 Pop() 功能的 Indexer ;而 Pop() 的功能则是 controller 中的一部分；也就是说 queue 是一个扩展的 Store ， Store 是不具备弹出功能的。\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 type Queue interface { Store // Pop会阻塞等待，直到有内容弹出，删除对应的值并处理计数器 Pop(PopProcessFunc) (interface{}, error) // AddIfNotPresent puts the given accumulator into the Queue (in // association with the accumulator's key) if and only if that key // is not already associated with a non-empty accumulator. AddIfNotPresent(interface{}) error // HasSynced returns true if the first batch of keys have all been // popped. The first batch of keys are those of the first Replace // operation if that happened before any Add, Update, or Delete; // otherwise the first batch is empty. HasSynced() bool Close() // 关闭queue } 而弹出的操作是通过 controller 中的 processLoop() 进行的，最终走到Delta FIFO中进行处理。\n通过忙等待去读取要弹出的数据，然后在弹出前 通过PopProcessFunc 进行处理\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 func (c *controller) processLoop() { for { obj, err := c.config.Queue.Pop(PopProcessFunc(c.config.Process)) if err != nil { if err == ErrFIFOClosed { return } if c.config.RetryOnError { // This is the safe way to re-enqueue. c.config.Queue.AddIfNotPresent(obj) } } } } DeltaFIFO.Pop()\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 func (f *DeltaFIFO) Pop(process PopProcessFunc) (interface{}, error) { f.lock.Lock() defer f.lock.Unlock() for { for len(f.queue) == 0 { // When the queue is empty, invocation of Pop() is blocked until new item is enqueued. // When Close() is called, the f.closed is set and the condition is broadcasted. // Which causes this loop to continue and return from the Pop(). if f.IsClosed() { return nil, ErrFIFOClosed } f.cond.Wait() } id := f.queue[0] f.queue = f.queue[1:] if f.initialPopulationCount \u003e 0 { f.initialPopulationCount-- } item, ok := f.items[id] if !ok { // Item may have been deleted subsequently. continue } delete(f.items, id) err := process(item) // 进行处理 if e, ok := err.(ErrRequeue); ok { f.addIfNotPresent(id, item) // 如果失败，再重新加入到队列中 err = e.Err } // Don't need to copyDeltas here, because we're transferring // ownership to the caller. return item, err } } Informer 通过对 Reflector, Store, Queue, ListerWatcher、ProcessFunc, 等的概念，发现由 controller 所包装的起的功能并不能完成通过对API的动作监听，并通过动作来处理本地缓存的一个能力；这个情况下诞生了 informer 严格意义上来讲是 sharedInformer\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 func newInformer( lw ListerWatcher, objType runtime.Object, resyncPeriod time.Duration, h ResourceEventHandler, clientState Store, ) Controller { // This will hold incoming changes. Note how we pass clientState in as a // KeyLister, that way resync operations will result in the correct set // of update/delete deltas. fifo := NewDeltaFIFOWithOptions(DeltaFIFOOptions{ KnownObjects: clientState, EmitDeltaTypeReplaced: true, }) cfg := \u0026Config{ Queue: fifo, ListerWatcher: lw, ObjectType: objType, FullResyncPeriod: resyncPeriod, RetryOnError: false, Process: func(obj interface{}) error { // from oldest to newest for _, d := range obj.(Deltas) { switch d.Type { case Sync, Replaced, Added, Updated: if old, exists, err := clientState.Get(d.Object); err == nil \u0026\u0026 exists { if err := clientState.Update(d.Object); err != nil { return err } h.OnUpdate(old, d.Object) } else { if err := clientState.Add(d.Object); err != nil { return err } h.OnAdd(d.Object) } case Deleted: if err := clientState.Delete(d.Object); err != nil { return err } h.OnDelete(d.Object) } } return nil }, } return New(cfg) } newInformer是位于 tools/cache/controller.go 下，可以看出，这里面并没有informer的概念，这里通过注释可以看到，newInformer实际上是一个提供了存储和事件通知的informer。他关联的 queue 则是 Delta FIFO，并包含了 ProcessFunc, Store 等 controller的概念。最终对外的方法为 NewInformer()\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 func NewInformer( lw ListerWatcher, objType runtime.Object, resyncPeriod time.Duration, h ResourceEventHandler, ) (Store, Controller) { // This will hold the client state, as we know it. clientState := NewStore(DeletionHandlingMetaNamespaceKeyFunc) return clientState, newInformer(lw, objType, resyncPeriod, h, clientState) } type ResourceEventHandler interface { OnAdd(obj interface{}) OnUpdate(oldObj, newObj interface{}) OnDelete(obj interface{}) } 可以看到 NewInformer() 就是一个带有 Store功能的controller，通过这些可以假定出，Informer 就是controller ，将queue中相关操作分发给不同事件处理的功能\nSharedIndexInformer shareInformer 为客户端提供了与apiserver一致的数据对象本地缓存，并支持多事件处理程序的informer，而 shareIndexInformer 则是对shareInformer 的扩展\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 type SharedInformer interface { // AddEventHandler adds an event handler to the shared informer using the shared informer's resync // period. Events to a single handler are delivered sequentially, but there is no coordination // between different handlers. AddEventHandler(handler ResourceEventHandler) // AddEventHandlerWithResyncPeriod adds an event handler to the // shared informer with the requested resync period; zero means // this handler does not care about resyncs. The resync operation // consists of delivering to the handler an update notification // for every object in the informer's local cache; it does not add // any interactions with the authoritative storage. Some // informers do no resyncs at all, not even for handlers added // with a non-zero resyncPeriod. For an informer that does // resyncs, and for each handler that requests resyncs, that // informer develops a nominal resync period that is no shorter // than the requested period but may be longer. The actual time // between any two resyncs may be longer than the nominal period // because the implementation takes time to do work and there may // be competing load and scheduling noise. AddEventHandlerWithResyncPeriod(handler ResourceEventHandler, resyncPeriod time.Duration) // GetStore returns the informer's local cache as a Store. GetStore() Store // GetController is deprecated, it does nothing useful GetController() Controller // Run starts and runs the shared informer, returning after it stops. // The informer will be stopped when stopCh is closed. Run(stopCh \u003c-chan struct{}) // HasSynced returns true if the shared informer's store has been // informed by at least one full LIST of the authoritative state // of the informer's object collection. This is unrelated to \"resync\". HasSynced() bool // LastSyncResourceVersion is the resource version observed when last synced with the underlying // store. The value returned is not synchronized with access to the underlying store and is not // thread-safe. LastSyncResourceVersion() string } SharedIndexInformer 是对SharedInformer的实现，可以从结构中看出，SharedIndexInformer 大致具有如下功能：\n索引本地缓存 controller，通过list watch拉取API并推入 Deltal FIFO 事件的处理 go 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 type sharedIndexInformer struct { indexer Indexer // 具有索引的本地缓存 controller Controller // controller processor *sharedProcessor // 事件处理函数集合 cacheMutationDetector MutationDetector listerWatcher ListerWatcher objectType runtime.Object resyncCheckPeriod time.Duration defaultEventHandlerResyncPeriod time.Duration clock clock.Clock started, stopped bool startedLock sync.Mutex blockDeltas sync.Mutex } 而在 tools/cache/share_informer.go 可以看到 shareIndexInformer 的运行过程\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 func (s *sharedIndexInformer) Run(stopCh \u003c-chan struct{}) { defer utilruntime.HandleCrash() fifo := NewDeltaFIFOWithOptions(DeltaFIFOOptions{ KnownObjects: s.indexer, EmitDeltaTypeReplaced: true, }) cfg := \u0026Config{ Queue: fifo, ListerWatcher: s.listerWatcher, ObjectType: s.objectType, FullResyncPeriod: s.resyncCheckPeriod, RetryOnError: false, ShouldResync: s.processor.shouldResync, Process: s.HandleDeltas, // process 弹出时操作的流程 } func() { s.startedLock.Lock() defer s.startedLock.Unlock() s.controller = New(cfg) s.controller.(*controller).clock = s.clock s.started = true }() // Separate stop channel because Processor should be stopped strictly after controller processorStopCh := make(chan struct{}) var wg wait.Group defer wg.Wait() // Wait for Processor to stop defer close(processorStopCh) // Tell Processor to stop wg.StartWithChannel(processorStopCh, s.cacheMutationDetector.Run) wg.StartWithChannel(processorStopCh, s.processor.run) // 启动事件处理函数 defer func() { s.startedLock.Lock() defer s.startedLock.Unlock() s.stopped = true // Don't want any new listeners }() s.controller.Run(stopCh) // 启动controller，controller会启动Reflector和fifo的Pop() } 而在操作Delta FIFO中可以看到，做具体操作时，会将动作分发至对应的事件处理函数中，这个是informer初始化时对事件操作的函数\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 func (s *sharedIndexInformer) HandleDeltas(obj interface{}) error { s.blockDeltas.Lock() defer s.blockDeltas.Unlock() for _, d := range obj.(Deltas) { switch d.Type { case Sync, Replaced, Added, Updated: s.cacheMutationDetector.AddObject(d.Object) if old, exists, err := s.indexer.Get(d.Object); err == nil \u0026\u0026 exists { if err := s.indexer.Update(d.Object); err != nil { return err } isSync := false switch { case d.Type == Sync: isSync = true case d.Type == Replaced: if accessor, err := meta.Accessor(d.Object); err == nil { if oldAccessor, err := meta.Accessor(old); err == nil { isSync = accessor.GetResourceVersion() == oldAccessor.GetResourceVersion() } } } // 事件的分发 s.processor.distribute(updateNotification{oldObj: old, newObj: d.Object}, isSync) } else { if err := s.indexer.Add(d.Object); err != nil { return err } // 事件的分发 s.processor.distribute(addNotification{newObj: d.Object}, false) } case Deleted: if err := s.indexer.Delete(d.Object); err != nil { return err } s.processor.distribute(deleteNotification{oldObj: d.Object}, false) } } return nil } 事件处理函数 processor 启动informer时也会启动注册进来的事件处理函数；processor 就是这个事件处理函数。\nrun() 函数会启动两个 listener，j监听事件处理业务函数 listener.run 和 事件的处理\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 wg.StartWithChannel(processorStopCh, s.processor.run) func (p *sharedProcessor) run(stopCh \u003c-chan struct{}) { func() { p.listenersLock.RLock() defer p.listenersLock.RUnlock() for _, listener := range p.listeners { p.wg.Start(listener.run) p.wg.Start(listener.pop) } p.listenersStarted = true }() \u003c-stopCh p.listenersLock.RLock() defer p.listenersLock.RUnlock() for _, listener := range p.listeners { close(listener.addCh) // Tell .pop() to stop. .pop() will tell .run() to stop } p.wg.Wait() // Wait for all .pop() and .run() to stop } 可以看出，就是拿到的事件，根据注册的到informer的事件函数进行处理\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 func (p *processorListener) run() { stopCh := make(chan struct{}) wait.Until(func() { for next := range p.nextCh { // 消费事件 switch notification := next.(type) { case updateNotification: p.handler.OnUpdate(notification.oldObj, notification.newObj) case addNotification: p.handler.OnAdd(notification.newObj) case deleteNotification: p.handler.OnDelete(notification.oldObj) default: utilruntime.HandleError(fmt.Errorf(\"unrecognized notification: %T\", next)) } } // the only way to get here is if the p.nextCh is empty and closed close(stopCh) }, 1*time.Second, stopCh) } informer中的事件的设计 了解了informer如何处理事件，就需要学习下，informer的事件系统设计 prossorListener\n事件的添加 当在handleDelta时，会分发具体的事件\ngo 1 2 // 事件的分发 s.processor.distribute(updateNotification{oldObj: old, newObj: d.Object}, isSync) 此时，事件泵 Pop() 会根据接收到的事件进行处理\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 // run() 时会启动一个事件泵 p.wg.Start(listener.pop) func (p *processorListener) pop() { defer utilruntime.HandleCrash() defer close(p.nextCh) var nextCh chan\u003c- interface{} var notification interface{} for { select { case nextCh \u003c- notification: // 这里实际上是一个阻塞的等待 // 单向channel 可能不会走到这步骤 var ok bool // deltahandle 中 distribute 会将事件添加到addCh待处理事件中 // 处理完事件会再次拿到一个事件 notification, ok = p.pendingNotifications.ReadOne() if !ok { // Nothing to pop nextCh = nil // Disable this select case } // 处理 分发过来的事件 addCh case notificationToAdd, ok := \u003c-p.addCh: // distribute分发的事件 if !ok { return } // 这里代表第一次，没有任何事件时，或者上面步骤完成读取 if notification == nil { // 就会走这里 notification = notificationToAdd nextCh = p.nextCh } else { // notification否则代表没有处理完，将数据再次添加到待处理中 p.pendingNotifications.WriteOne(notificationToAdd) } } } } 该消息事件的流程图为\n通过一个简单实例来学习client-go中的消息通知机制\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 package main import ( \"fmt\" \"time\" \"k8s.io/utils/buffer\" ) var nextCh1 = make(chan interface{}) var addCh = make(chan interface{}) var stopper = make(chan struct{}) var notification interface{} var pendding = *buffer.NewRingGrowing(2) func main() { // pop go func() { var nextCh chan\u003c- interface{} var notification interface{} //var n int for { fmt.Println(\"busy wait\") fmt.Println(\"entry select\", notification) select { // 初始时，一个未初始化的channel，nil，形成一个阻塞（单channel下是死锁） case nextCh \u003c- notification: fmt.Println(\"entry nextCh\", notification) var ok bool // 读不到数据代表已处理完，置空锁 notification, ok = pendding.ReadOne() if !ok { fmt.Println(\"unactive nextch\") nextCh = nil } // 事件的分发，监听，初始时也是一个阻塞 case notificationToAdd, ok := \u003c-addCh: fmt.Println(notificationToAdd, notification) if !ok { return } // 线程安全 // 当消息为空时，没有被处理 // 锁为空，就分发数据 if notification == nil { fmt.Println(\"frist notification nil\") notification = notificationToAdd nextCh = nextCh1 // 这步骤等于初始化了局部的nextCh，会触发上面的流程 } else { // 在第三次时，会走到这里，数据进入环 fmt.Println(\"into ring\", notificationToAdd) pendding.WriteOne(notificationToAdd) } } } }() // producer go func() { i := 0 for { i++ if i%5 == 0 { addCh \u003c- fmt.Sprintf(\"thread 2 inner -- %d\", i) time.Sleep(time.Millisecond * 9000) } else { addCh \u003c- fmt.Sprintf(\"thread 2 outer -- %d\", i) time.Sleep(time.Millisecond * 500) } } }() // subsriber go func() { for { for next := range nextCh1 { time.Sleep(time.Millisecond * 300) fmt.Println(\"consumer\", next) } } }() \u003c-stopper } 总结，这里的机制类似于线程安全，进入临界区的一些算法，临界区就是 nextCh，notification 就是保证了至少有一个进程可以进入临界区（要么分发事件，要么生产事件）；nextCh 和 nextCh1 一个是局部管道一个是全局的，管道未初始化代表了死锁（阻塞）；当有消息要处理时，会将局部管道 nextCh 赋值给 全局 nextCh1 此时相当于解除了分发的步骤（对管道赋值，触发分发操作）；ringbuffer 实际上是提供了一个对 notification 加锁的操作，在没有处理的消息时，需要保障 notification 为空，同时也关闭了流程 nextCh 的写入。这里主要是考虑对golang中channel的用法\n","wordCount":"2218","inLanguage":"zh","datePublished":"2022-05-25T00:00:00Z","dateModified":"2023-03-18T23:00:36+08:00","author":{"@type":"Person","name":"cylon"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.oomkill.com/2022/05/ch08-informer/"},"publisher":{"@type":"Organization","name":"Cylon's Collection","logo":{"@type":"ImageObject","url":"https://www.oomkill.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.oomkill.com/><img src=https://www.oomkill.com/favicon.ico alt aria-label=logo height=20>Cylon's Collection</a><div class=logo-switches><button id=theme-toggle><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://www.oomkill.com/archives><span>归档</span></a></li><li><a href=https://www.oomkill.com/tags><span>标签</span></a></li><li><a href=https://www.oomkill.com/search><span>搜索</span></a></li><li><a href=https://www.oomkill.com/about accesskey=/><span>关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">源码分析client-go架构 - 什么是informer</h1><div class=post-meta><span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar" style="user-select:text"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" style="user-select:text"/><line x1="16" y1="2" x2="16" y2="6" style="user-select:text"/><line x1="8" y1="2" x2="8" y2="6" style="user-select:text"/><line x1="3" y1="10" x2="21" y2="10" style="user-select:text"/></svg><span>2022-05-25</span></span>&nbsp;·&nbsp;<span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text" style="user-select:text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z" style="user-select:text"/><polyline points="14 2 14 8 20 8" style="user-select:text"/><line x1="16" y1="13" x2="8" y2="13" style="user-select:text"/><line x1="16" y1="17" x2="8" y2="17" style="user-select:text"/><polyline points="10 9 9 9 8 9" style="user-select:text"/></svg><span>2218 字</span></span>&nbsp;·&nbsp;<span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><span>11 分钟</span></span>
<span class=pe-post-meta-item>&nbsp;·&nbsp;<svg t="1714036239378" fill="currentcolor" class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="6659" width="256" height="256"><path d="M690 78.2c-18.6-18.8-49-19-67.8-.4s-19 49-.4 67.8l255.4 258.6c67.8 68.6 67.8 178.8.0 247.4L653.4 878.2c-18.6 18.8-18.4 49.2.4 67.8s49.2 18.4 67.8-.4l224-226.4c104.8-106 104.8-276.4.0-382.4L690 78.2zM485.4 101.4c-24-24-56.6-37.4-90.6-37.4H96C43 64 0 107 0 160v299c0 34 13.4 66.6 37.4 90.6l336 336c50 50 131 50 181 0l267-267c50-50 50-131 0-181l-336-336zM96 160h299c8.4.0 16.6 3.4 22.6 9.4l336 336c12.4 12.4 12.4 32.8.0 45.2l-267 267c-12.4 12.4-32.8 12.4-45.2.0l-336-336c-6-6-9.4-14.2-9.4-22.6V160zm192 128a64 64 0 10-128 0 64 64 0 10128 0z" p-id="6660"/></svg></span><ul class=pe-post-meta-item><a href=https://www.oomkill.com/tags/kubernetes-develop/>#Kubernetes Develop</a>
<a href=https://www.oomkill.com/tags/kubernetes/>#Kubernetes</a></ul></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details><summary><span class=details>目录</span></summary><div class=inner><ul><li><a href=#controller aria-label=Controller>Controller</a><ul><li><a href=#config aria-label=Config>Config</a><li><a href=#controller-1 aria-label=controller>controller</a><li><a href=#queue aria-label=Queue>Queue</a></ul><li><a href=#informer aria-label=Informer>Informer</a><li><a href=#sharedindexinformer aria-label=SharedIndexInformer>SharedIndexInformer</a><ul><li><a href=#%e4%ba%8b%e4%bb%b6%e5%a4%84%e7%90%86%e5%87%bd%e6%95%b0-processor aria-label="事件处理函数 processor">事件处理函数 processor</a><li><a href=#informer%e4%b8%ad%e7%9a%84%e4%ba%8b%e4%bb%b6%e7%9a%84%e8%ae%be%e8%ae%a1 aria-label=informer中的事件的设计>informer中的事件的设计</a><ul><li><a href=#%e4%ba%8b%e4%bb%b6%e7%9a%84%e6%b7%bb%e5%8a%a0 aria-label=事件的添加>事件的添加</a></li></div></details></div></aside><script src=/js/pe-toc.min.445eb1bfc5e85dd13b9519fcc2a806522e9629b6224a2974052789ba00ab78af.js integrity="sha256-RF6xv8XoXdE7lRn8wqgGUi6WKbYiSil0BSeJugCreK8="></script><div class=post-content><p>之前了解了client-go中的架构设计，也就是 <code>tools/cache</code> 下面的一些概念，那么下面将对informer进行分析</p><h2 id=controller>Controller<a hidden class=anchor aria-hidden=true href=#controller>#</a></h2><p>在client-go informer架构中存在一个 <code>controller</code> ，这个不是 Kubernetes 中的Controller组件；而是在 <code>tools/cache</code> 中的一个概念，<code>controller</code> 位于 informer 之下，Reflector 之上。<a href=https://github.com/kubernetes/client-go/blob/master/tools/cache/controller.go#L90-L115 target=_blank rel="noopener nofollow noreferrer">code</a></p><h3 id=config>Config<a hidden class=anchor aria-hidden=true href=#config>#</a></h3><p>从严格意义上来讲，<code>controller</code> 是作为一个 <code>sharedInformer</code> 使用，通过接受一个 <code>Config</code> ，而 <code>Reflector</code> 则作为 <code>controller</code> 的 slot。<code>Config</code> 则包含了这个 <code>controller</code> 里所有的设置。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Config</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>Queue</span> <span class=c1>// DeltaFIFO
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>ListerWatcher</span> <span class=c1>// 用于list watch的
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>Process</span> <span class=nx>ProcessFunc</span> <span class=c1>// 定义如何从DeltaFIFO中弹出数据后处理的操作
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>ObjectType</span> <span class=nx>runtime</span><span class=p>.</span><span class=nx>Object</span> <span class=c1>// Controller处理的对象数据，实际上就是kubernetes中的资源
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>FullResyncPeriod</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span> <span class=c1>// 全量同步的周期
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>ShouldResync</span> <span class=nx>ShouldResyncFunc</span> <span class=c1>// Reflector通过该标记来确定是否应该重新同步
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>RetryOnError</span> <span class=kt>bool</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><h3 id=controller-1>controller<a hidden class=anchor aria-hidden=true href=#controller-1>#</a></h3><p>然后 <code>controller</code> 又为 <code>reflertor</code> 的上层</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>controller</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>config</span>         <span class=nx>Config</span>
</span></span><span class=line><span class=cl>	<span class=nx>reflector</span>      <span class=o>*</span><span class=nx>Reflector</span> 
</span></span><span class=line><span class=cl>	<span class=nx>reflectorMutex</span> <span class=nx>sync</span><span class=p>.</span><span class=nx>RWMutex</span>
</span></span><span class=line><span class=cl>	<span class=nx>clock</span>          <span class=nx>clock</span><span class=p>.</span><span class=nx>Clock</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Controller</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// controller 主要做两件事，
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 1. 构建并运行 Reflector,将listerwacther中的泵压到queue（Delta fifo）中
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 2. Queue用Pop()弹出数据，具体的操作是Process
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 直到 stopCh 不阻塞，这两个协程将退出
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>Run</span><span class=p>(</span><span class=nx>stopCh</span> <span class=o>&lt;-</span><span class=kd>chan</span> <span class=kd>struct</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>	<span class=nf>HasSynced</span><span class=p>()</span> <span class=kt>bool</span> <span class=c1>// 这个实际上是从store中继承的，标记这个controller已经
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>LastSyncResourceVersion</span><span class=p>()</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p><code>controller</code> 中的方法，仅有一个 <code>Run()</code> 和 <code>New()</code>；这意味着，<code>controller</code> 只是一个抽象的概念，作为 <code>Reflector</code>, <code>Delta FIFO</code> 整合的工作流</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220523224050974.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220523224050974.png#center alt=image-20220523224050974 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><p>而 <code>controller</code> 则是 <code>SharedInformer</code> 了。</p><h3 id=queue>Queue<a hidden class=anchor aria-hidden=true href=#queue>#</a></h3><p>这里的 <code>queue</code> 可以理解为是一个具有 <code>Pop()</code> 功能的 <code>Indexer</code> ;而 <code>Pop()</code> 的功能则是 <code>controller</code> 中的一部分；也就是说 <code>queue</code> 是一个扩展的 <code>Store</code> ， <code>Store</code> 是不具备弹出功能的。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Queue</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>Store</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Pop会阻塞等待，直到有内容弹出，删除对应的值并处理计数器
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>Pop</span><span class=p>(</span><span class=nx>PopProcessFunc</span><span class=p>)</span> <span class=p>(</span><span class=kd>interface</span><span class=p>{},</span> <span class=kt>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// AddIfNotPresent puts the given accumulator into the Queue (in
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// association with the accumulator&#39;s key) if and only if that key
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// is not already associated with a non-empty accumulator.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>AddIfNotPresent</span><span class=p>(</span><span class=kd>interface</span><span class=p>{})</span> <span class=kt>error</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// HasSynced returns true if the first batch of keys have all been
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// popped.  The first batch of keys are those of the first Replace
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// operation if that happened before any Add, Update, or Delete;
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// otherwise the first batch is empty.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>HasSynced</span><span class=p>()</span> <span class=kt>bool</span>
</span></span><span class=line><span class=cl>	<span class=nf>Close</span><span class=p>()</span> <span class=c1>// 关闭queue
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>而弹出的操作是通过 controller 中的 <code>processLoop()</code> 进行的，最终走到Delta FIFO中进行处理。</p><p>通过忙等待去读取要弹出的数据，然后在弹出前 通过<code>PopProcessFunc</code> 进行处理</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>controller</span><span class=p>)</span> <span class=nf>processLoop</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>obj</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>config</span><span class=p>.</span><span class=nx>Queue</span><span class=p>.</span><span class=nf>Pop</span><span class=p>(</span><span class=nf>PopProcessFunc</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>config</span><span class=p>.</span><span class=nx>Process</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>err</span> <span class=o>==</span> <span class=nx>ErrFIFOClosed</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>c</span><span class=p>.</span><span class=nx>config</span><span class=p>.</span><span class=nx>RetryOnError</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=c1>// This is the safe way to re-enqueue.
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=nx>c</span><span class=p>.</span><span class=nx>config</span><span class=p>.</span><span class=nx>Queue</span><span class=p>.</span><span class=nf>AddIfNotPresent</span><span class=p>(</span><span class=nx>obj</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p><a href=https://github.com/kubernetes/client-go/blob/master/tools/cache/delta_fifo.go#L515 target=_blank rel="noopener nofollow noreferrer">DeltaFIFO.Pop()</a></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>f</span> <span class=o>*</span><span class=nx>DeltaFIFO</span><span class=p>)</span> <span class=nf>Pop</span><span class=p>(</span><span class=nx>process</span> <span class=nx>PopProcessFunc</span><span class=p>)</span> <span class=p>(</span><span class=kd>interface</span><span class=p>{},</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>f</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>f</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=nb>len</span><span class=p>(</span><span class=nx>f</span><span class=p>.</span><span class=nx>queue</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// When the queue is empty, invocation of Pop() is blocked until new item is enqueued.
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// When Close() is called, the f.closed is set and the condition is broadcasted.
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// Which causes this loop to continue and return from the Pop().
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>if</span> <span class=nx>f</span><span class=p>.</span><span class=nf>IsClosed</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>ErrFIFOClosed</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=nx>f</span><span class=p>.</span><span class=nx>cond</span><span class=p>.</span><span class=nf>Wait</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>id</span> <span class=o>:=</span> <span class=nx>f</span><span class=p>.</span><span class=nx>queue</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>		<span class=nx>f</span><span class=p>.</span><span class=nx>queue</span> <span class=p>=</span> <span class=nx>f</span><span class=p>.</span><span class=nx>queue</span><span class=p>[</span><span class=mi>1</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>f</span><span class=p>.</span><span class=nx>initialPopulationCount</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>f</span><span class=p>.</span><span class=nx>initialPopulationCount</span><span class=o>--</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>item</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>f</span><span class=p>.</span><span class=nx>items</span><span class=p>[</span><span class=nx>id</span><span class=p>]</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// Item may have been deleted subsequently.
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>continue</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nb>delete</span><span class=p>(</span><span class=nx>f</span><span class=p>.</span><span class=nx>items</span><span class=p>,</span> <span class=nx>id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>err</span> <span class=o>:=</span> <span class=nf>process</span><span class=p>(</span><span class=nx>item</span><span class=p>)</span> <span class=c1>// 进行处理
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nx>e</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>err</span><span class=p>.(</span><span class=nx>ErrRequeue</span><span class=p>);</span> <span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>f</span><span class=p>.</span><span class=nf>addIfNotPresent</span><span class=p>(</span><span class=nx>id</span><span class=p>,</span> <span class=nx>item</span><span class=p>)</span> <span class=c1>// 如果失败，再重新加入到队列中
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>err</span> <span class=p>=</span> <span class=nx>e</span><span class=p>.</span><span class=nx>Err</span> 
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=c1>// Don&#39;t need to copyDeltas here, because we&#39;re transferring
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// ownership to the caller.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>return</span> <span class=nx>item</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><h2 id=informer>Informer<a hidden class=anchor aria-hidden=true href=#informer>#</a></h2><p>通过对 <code>Reflector</code>, <code>Store</code>, <code>Queue</code>, <code>ListerWatcher</code>、<code>ProcessFunc</code>, 等的概念，发现由 <code>controller</code> 所包装的起的功能并不能完成通过对API的动作监听，并通过动作来处理本地缓存的一个能力；这个情况下诞生了 <code>informer</code> 严格意义上来讲是 <a href=https://github.com/kubernetes/client-go/blob/master/tools/cache/controller.go#L317 target=_blank rel="noopener nofollow noreferrer">sharedInformer</a></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>newInformer</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=nx>lw</span> <span class=nx>ListerWatcher</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>objType</span> <span class=nx>runtime</span><span class=p>.</span><span class=nx>Object</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>resyncPeriod</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>h</span> <span class=nx>ResourceEventHandler</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>clientState</span> <span class=nx>Store</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=nx>Controller</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// This will hold incoming changes. Note how we pass clientState in as a
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// KeyLister, that way resync operations will result in the correct set
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// of update/delete deltas.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>fifo</span> <span class=o>:=</span> <span class=nf>NewDeltaFIFOWithOptions</span><span class=p>(</span><span class=nx>DeltaFIFOOptions</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>KnownObjects</span><span class=p>:</span>          <span class=nx>clientState</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>EmitDeltaTypeReplaced</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>cfg</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>Config</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>Queue</span><span class=p>:</span>            <span class=nx>fifo</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>ListerWatcher</span><span class=p>:</span>    <span class=nx>lw</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>ObjectType</span><span class=p>:</span>       <span class=nx>objType</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>FullResyncPeriod</span><span class=p>:</span> <span class=nx>resyncPeriod</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>RetryOnError</span><span class=p>:</span>     <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>Process</span><span class=p>:</span> <span class=kd>func</span><span class=p>(</span><span class=nx>obj</span> <span class=kd>interface</span><span class=p>{})</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// from oldest to newest
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>d</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>obj</span><span class=p>.(</span><span class=nx>Deltas</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>switch</span> <span class=nx>d</span><span class=p>.</span><span class=nx>Type</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>case</span> <span class=nx>Sync</span><span class=p>,</span> <span class=nx>Replaced</span><span class=p>,</span> <span class=nx>Added</span><span class=p>,</span> <span class=nx>Updated</span><span class=p>:</span>
</span></span><span class=line><span class=cl>					<span class=k>if</span> <span class=nx>old</span><span class=p>,</span> <span class=nx>exists</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>clientState</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=nx>d</span><span class=p>.</span><span class=nx>Object</span><span class=p>);</span> <span class=nx>err</span> <span class=o>==</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span> <span class=nx>exists</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>clientState</span><span class=p>.</span><span class=nf>Update</span><span class=p>(</span><span class=nx>d</span><span class=p>.</span><span class=nx>Object</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>							<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>						<span class=p>}</span>
</span></span><span class=line><span class=cl>						<span class=nx>h</span><span class=p>.</span><span class=nf>OnUpdate</span><span class=p>(</span><span class=nx>old</span><span class=p>,</span> <span class=nx>d</span><span class=p>.</span><span class=nx>Object</span><span class=p>)</span>
</span></span><span class=line><span class=cl>					<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>clientState</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=nx>d</span><span class=p>.</span><span class=nx>Object</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>							<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>						<span class=p>}</span>
</span></span><span class=line><span class=cl>						<span class=nx>h</span><span class=p>.</span><span class=nf>OnAdd</span><span class=p>(</span><span class=nx>d</span><span class=p>.</span><span class=nx>Object</span><span class=p>)</span>
</span></span><span class=line><span class=cl>					<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=k>case</span> <span class=nx>Deleted</span><span class=p>:</span>
</span></span><span class=line><span class=cl>					<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>clientState</span><span class=p>.</span><span class=nf>Delete</span><span class=p>(</span><span class=nx>d</span><span class=p>.</span><span class=nx>Object</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>					<span class=p>}</span>
</span></span><span class=line><span class=cl>					<span class=nx>h</span><span class=p>.</span><span class=nf>OnDelete</span><span class=p>(</span><span class=nx>d</span><span class=p>.</span><span class=nx>Object</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nf>New</span><span class=p>(</span><span class=nx>cfg</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>newInformer是位于 <a href=https://github.com/kubernetes/client-go/blob/master/tools/cache/controller.go#L317 target=_blank rel="noopener nofollow noreferrer">tools/cache/controller.go</a> 下，可以看出，这里面并没有informer的概念，这里通过注释可以看到，newInformer实际上是一个提供了存储和事件通知的informer。他关联的 <code>queue</code> 则是 <code>Delta FIFO</code>，并包含了 <code>ProcessFunc</code>, <code>Store</code> 等 controller的概念。最终对外的方法为 <code>NewInformer()</code></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>NewInformer</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=nx>lw</span> <span class=nx>ListerWatcher</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>objType</span> <span class=nx>runtime</span><span class=p>.</span><span class=nx>Object</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>resyncPeriod</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>h</span> <span class=nx>ResourceEventHandler</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>(</span><span class=nx>Store</span><span class=p>,</span> <span class=nx>Controller</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// This will hold the client state, as we know it.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>clientState</span> <span class=o>:=</span> <span class=nf>NewStore</span><span class=p>(</span><span class=nx>DeletionHandlingMetaNamespaceKeyFunc</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>clientState</span><span class=p>,</span> <span class=nf>newInformer</span><span class=p>(</span><span class=nx>lw</span><span class=p>,</span> <span class=nx>objType</span><span class=p>,</span> <span class=nx>resyncPeriod</span><span class=p>,</span> <span class=nx>h</span><span class=p>,</span> <span class=nx>clientState</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>ResourceEventHandler</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nf>OnAdd</span><span class=p>(</span><span class=nx>obj</span> <span class=kd>interface</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>	<span class=nf>OnUpdate</span><span class=p>(</span><span class=nx>oldObj</span><span class=p>,</span> <span class=nx>newObj</span> <span class=kd>interface</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>	<span class=nf>OnDelete</span><span class=p>(</span><span class=nx>obj</span> <span class=kd>interface</span><span class=p>{})</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>可以看到 <code>NewInformer()</code> 就是一个带有 Store功能的controller，通过这些可以假定出，<strong>Informer</strong> 就是<code>controller</code> ，将queue中相关操作分发给不同事件处理的功能</p><h2 id=sharedindexinformer>SharedIndexInformer<a hidden class=anchor aria-hidden=true href=#sharedindexinformer>#</a></h2><p><code>shareInformer</code> 为客户端提供了与apiserver一致的数据对象本地缓存，并支持多事件处理程序的<strong>informer</strong>，而 <code>shareIndexInformer </code>则是对<code>shareInformer</code> 的扩展</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>SharedInformer</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// AddEventHandler adds an event handler to the shared informer using the shared informer&#39;s resync
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// period.  Events to a single handler are delivered sequentially, but there is no coordination
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// between different handlers.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>AddEventHandler</span><span class=p>(</span><span class=nx>handler</span> <span class=nx>ResourceEventHandler</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=c1>// AddEventHandlerWithResyncPeriod adds an event handler to the
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// shared informer with the requested resync period; zero means
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// this handler does not care about resyncs.  The resync operation
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// consists of delivering to the handler an update notification
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// for every object in the informer&#39;s local cache; it does not add
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// any interactions with the authoritative storage.  Some
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// informers do no resyncs at all, not even for handlers added
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// with a non-zero resyncPeriod.  For an informer that does
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// resyncs, and for each handler that requests resyncs, that
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// informer develops a nominal resync period that is no shorter
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// than the requested period but may be longer.  The actual time
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// between any two resyncs may be longer than the nominal period
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// because the implementation takes time to do work and there may
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// be competing load and scheduling noise.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>AddEventHandlerWithResyncPeriod</span><span class=p>(</span><span class=nx>handler</span> <span class=nx>ResourceEventHandler</span><span class=p>,</span> <span class=nx>resyncPeriod</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=c1>// GetStore returns the informer&#39;s local cache as a Store.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>GetStore</span><span class=p>()</span> <span class=nx>Store</span>
</span></span><span class=line><span class=cl>	<span class=c1>// GetController is deprecated, it does nothing useful
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>GetController</span><span class=p>()</span> <span class=nx>Controller</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Run starts and runs the shared informer, returning after it stops.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// The informer will be stopped when stopCh is closed.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>Run</span><span class=p>(</span><span class=nx>stopCh</span> <span class=o>&lt;-</span><span class=kd>chan</span> <span class=kd>struct</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>	<span class=c1>// HasSynced returns true if the shared informer&#39;s store has been
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// informed by at least one full LIST of the authoritative state
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// of the informer&#39;s object collection.  This is unrelated to &#34;resync&#34;.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>HasSynced</span><span class=p>()</span> <span class=kt>bool</span>
</span></span><span class=line><span class=cl>	<span class=c1>// LastSyncResourceVersion is the resource version observed when last synced with the underlying
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// store. The value returned is not synchronized with access to the underlying store and is not
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// thread-safe.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>LastSyncResourceVersion</span><span class=p>()</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p><code>SharedIndexInformer</code> 是对SharedInformer的实现，可以从结构中看出，<code>SharedIndexInformer</code> 大致具有如下功能：</p><ul><li>索引本地缓存</li><li>controller，通过list watch拉取API并推入 <code>Deltal FIFO</code></li><li>事件的处理</li></ul><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>sharedIndexInformer</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>indexer</span>    <span class=nx>Indexer</span> <span class=c1>// 具有索引的本地缓存
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>controller</span> <span class=nx>Controller</span> <span class=c1>// controller
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=nx>processor</span>             <span class=o>*</span><span class=nx>sharedProcessor</span> <span class=c1>// 事件处理函数集合
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>cacheMutationDetector</span> <span class=nx>MutationDetector</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>listerWatcher</span> <span class=nx>ListerWatcher</span>
</span></span><span class=line><span class=cl>	<span class=nx>objectType</span> <span class=nx>runtime</span><span class=p>.</span><span class=nx>Object</span>
</span></span><span class=line><span class=cl>	<span class=nx>resyncCheckPeriod</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span>
</span></span><span class=line><span class=cl>	<span class=nx>defaultEventHandlerResyncPeriod</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span>
</span></span><span class=line><span class=cl>	<span class=nx>clock</span> <span class=nx>clock</span><span class=p>.</span><span class=nx>Clock</span>
</span></span><span class=line><span class=cl>	<span class=nx>started</span><span class=p>,</span> <span class=nx>stopped</span> <span class=kt>bool</span>
</span></span><span class=line><span class=cl>	<span class=nx>startedLock</span>      <span class=nx>sync</span><span class=p>.</span><span class=nx>Mutex</span>
</span></span><span class=line><span class=cl>	<span class=nx>blockDeltas</span> <span class=nx>sync</span><span class=p>.</span><span class=nx>Mutex</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>而在 <a href=https://github.com/kubernetes/client-go/blob/master/tools/cache/shared_informer.go#L397-L444 target=_blank rel="noopener nofollow noreferrer">tools/cache/share_informer.go</a> 可以看到 shareIndexInformer 的运行过程</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>sharedIndexInformer</span><span class=p>)</span> <span class=nf>Run</span><span class=p>(</span><span class=nx>stopCh</span> <span class=o>&lt;-</span><span class=kd>chan</span> <span class=kd>struct</span><span class=p>{})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>utilruntime</span><span class=p>.</span><span class=nf>HandleCrash</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>fifo</span> <span class=o>:=</span> <span class=nf>NewDeltaFIFOWithOptions</span><span class=p>(</span><span class=nx>DeltaFIFOOptions</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>KnownObjects</span><span class=p>:</span>          <span class=nx>s</span><span class=p>.</span><span class=nx>indexer</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>EmitDeltaTypeReplaced</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>cfg</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>Config</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>Queue</span><span class=p>:</span>            <span class=nx>fifo</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>ListerWatcher</span><span class=p>:</span>    <span class=nx>s</span><span class=p>.</span><span class=nx>listerWatcher</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>ObjectType</span><span class=p>:</span>       <span class=nx>s</span><span class=p>.</span><span class=nx>objectType</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>FullResyncPeriod</span><span class=p>:</span> <span class=nx>s</span><span class=p>.</span><span class=nx>resyncCheckPeriod</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>RetryOnError</span><span class=p>:</span>     <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>ShouldResync</span><span class=p>:</span>     <span class=nx>s</span><span class=p>.</span><span class=nx>processor</span><span class=p>.</span><span class=nx>shouldResync</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>Process</span><span class=p>:</span> <span class=nx>s</span><span class=p>.</span><span class=nx>HandleDeltas</span><span class=p>,</span> <span class=c1>// process 弹出时操作的流程
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>s</span><span class=p>.</span><span class=nx>startedLock</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>defer</span> <span class=nx>s</span><span class=p>.</span><span class=nx>startedLock</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>s</span><span class=p>.</span><span class=nx>controller</span> <span class=p>=</span> <span class=nf>New</span><span class=p>(</span><span class=nx>cfg</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>s</span><span class=p>.</span><span class=nx>controller</span><span class=p>.(</span><span class=o>*</span><span class=nx>controller</span><span class=p>).</span><span class=nx>clock</span> <span class=p>=</span> <span class=nx>s</span><span class=p>.</span><span class=nx>clock</span>
</span></span><span class=line><span class=cl>		<span class=nx>s</span><span class=p>.</span><span class=nx>started</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>	<span class=p>}()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Separate stop channel because Processor should be stopped strictly after controller
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>processorStopCh</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kd>struct</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>wg</span> <span class=nx>wait</span><span class=p>.</span><span class=nx>Group</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>wg</span><span class=p>.</span><span class=nf>Wait</span><span class=p>()</span>              <span class=c1>// Wait for Processor to stop
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>defer</span> <span class=nb>close</span><span class=p>(</span><span class=nx>processorStopCh</span><span class=p>)</span> <span class=c1>// Tell Processor to stop
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>wg</span><span class=p>.</span><span class=nf>StartWithChannel</span><span class=p>(</span><span class=nx>processorStopCh</span><span class=p>,</span> <span class=nx>s</span><span class=p>.</span><span class=nx>cacheMutationDetector</span><span class=p>.</span><span class=nx>Run</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>wg</span><span class=p>.</span><span class=nf>StartWithChannel</span><span class=p>(</span><span class=nx>processorStopCh</span><span class=p>,</span> <span class=nx>s</span><span class=p>.</span><span class=nx>processor</span><span class=p>.</span><span class=nx>run</span><span class=p>)</span> <span class=c1>// 启动事件处理函数
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>s</span><span class=p>.</span><span class=nx>startedLock</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>defer</span> <span class=nx>s</span><span class=p>.</span><span class=nx>startedLock</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=nx>s</span><span class=p>.</span><span class=nx>stopped</span> <span class=p>=</span> <span class=kc>true</span> <span class=c1>// Don&#39;t want any new listeners
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=p>}()</span>
</span></span><span class=line><span class=cl>    <span class=nx>s</span><span class=p>.</span><span class=nx>controller</span><span class=p>.</span><span class=nf>Run</span><span class=p>(</span><span class=nx>stopCh</span><span class=p>)</span> <span class=c1>// 启动controller，controller会启动Reflector和fifo的Pop()
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>而在操作Delta FIFO中可以看到，做具体操作时，会将动作分发至对应的事件处理函数中，这个是informer初始化时对事件操作的函数</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>sharedIndexInformer</span><span class=p>)</span> <span class=nf>HandleDeltas</span><span class=p>(</span><span class=nx>obj</span> <span class=kd>interface</span><span class=p>{})</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>s</span><span class=p>.</span><span class=nx>blockDeltas</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>s</span><span class=p>.</span><span class=nx>blockDeltas</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>d</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>obj</span><span class=p>.(</span><span class=nx>Deltas</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>switch</span> <span class=nx>d</span><span class=p>.</span><span class=nx>Type</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=nx>Sync</span><span class=p>,</span> <span class=nx>Replaced</span><span class=p>,</span> <span class=nx>Added</span><span class=p>,</span> <span class=nx>Updated</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=nx>s</span><span class=p>.</span><span class=nx>cacheMutationDetector</span><span class=p>.</span><span class=nf>AddObject</span><span class=p>(</span><span class=nx>d</span><span class=p>.</span><span class=nx>Object</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>old</span><span class=p>,</span> <span class=nx>exists</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nx>indexer</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=nx>d</span><span class=p>.</span><span class=nx>Object</span><span class=p>);</span> <span class=nx>err</span> <span class=o>==</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span> <span class=nx>exists</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nx>indexer</span><span class=p>.</span><span class=nf>Update</span><span class=p>(</span><span class=nx>d</span><span class=p>.</span><span class=nx>Object</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>				<span class=nx>isSync</span> <span class=o>:=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>				<span class=k>switch</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>case</span> <span class=nx>d</span><span class=p>.</span><span class=nx>Type</span> <span class=o>==</span> <span class=nx>Sync</span><span class=p>:</span>
</span></span><span class=line><span class=cl>					<span class=nx>isSync</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>				<span class=k>case</span> <span class=nx>d</span><span class=p>.</span><span class=nx>Type</span> <span class=o>==</span> <span class=nx>Replaced</span><span class=p>:</span>
</span></span><span class=line><span class=cl>					<span class=k>if</span> <span class=nx>accessor</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>meta</span><span class=p>.</span><span class=nf>Accessor</span><span class=p>(</span><span class=nx>d</span><span class=p>.</span><span class=nx>Object</span><span class=p>);</span> <span class=nx>err</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=k>if</span> <span class=nx>oldAccessor</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>meta</span><span class=p>.</span><span class=nf>Accessor</span><span class=p>(</span><span class=nx>old</span><span class=p>);</span> <span class=nx>err</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>							<span class=nx>isSync</span> <span class=p>=</span> <span class=nx>accessor</span><span class=p>.</span><span class=nf>GetResourceVersion</span><span class=p>()</span> <span class=o>==</span> <span class=nx>oldAccessor</span><span class=p>.</span><span class=nf>GetResourceVersion</span><span class=p>()</span>
</span></span><span class=line><span class=cl>						<span class=p>}</span>
</span></span><span class=line><span class=cl>					<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 事件的分发
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=nx>s</span><span class=p>.</span><span class=nx>processor</span><span class=p>.</span><span class=nf>distribute</span><span class=p>(</span><span class=nx>updateNotification</span><span class=p>{</span><span class=nx>oldObj</span><span class=p>:</span> <span class=nx>old</span><span class=p>,</span> <span class=nx>newObj</span><span class=p>:</span> <span class=nx>d</span><span class=p>.</span><span class=nx>Object</span><span class=p>},</span> <span class=nx>isSync</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nx>indexer</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=nx>d</span><span class=p>.</span><span class=nx>Object</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 事件的分发
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=nx>s</span><span class=p>.</span><span class=nx>processor</span><span class=p>.</span><span class=nf>distribute</span><span class=p>(</span><span class=nx>addNotification</span><span class=p>{</span><span class=nx>newObj</span><span class=p>:</span> <span class=nx>d</span><span class=p>.</span><span class=nx>Object</span><span class=p>},</span> <span class=kc>false</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=nx>Deleted</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nx>indexer</span><span class=p>.</span><span class=nf>Delete</span><span class=p>(</span><span class=nx>d</span><span class=p>.</span><span class=nx>Object</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nx>s</span><span class=p>.</span><span class=nx>processor</span><span class=p>.</span><span class=nf>distribute</span><span class=p>(</span><span class=nx>deleteNotification</span><span class=p>{</span><span class=nx>oldObj</span><span class=p>:</span> <span class=nx>d</span><span class=p>.</span><span class=nx>Object</span><span class=p>},</span> <span class=kc>false</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><h3 id=事件处理函数-processor>事件处理函数 processor<a hidden class=anchor aria-hidden=true href=#事件处理函数-processor>#</a></h3><p>启动informer时也会启动注册进来的事件处理函数；<code>processor</code> 就是这个事件处理函数。</p><p><code>run()</code> 函数会启动两个 listener，j监听事件处理业务函数 <code>listener.run</code> 和 事件的处理</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>wg</span><span class=p>.</span><span class=nf>StartWithChannel</span><span class=p>(</span><span class=nx>processorStopCh</span><span class=p>,</span> <span class=nx>s</span><span class=p>.</span><span class=nx>processor</span><span class=p>.</span><span class=nx>run</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>p</span> <span class=o>*</span><span class=nx>sharedProcessor</span><span class=p>)</span> <span class=nf>run</span><span class=p>(</span><span class=nx>stopCh</span> <span class=o>&lt;-</span><span class=kd>chan</span> <span class=kd>struct</span><span class=p>{})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>p</span><span class=p>.</span><span class=nx>listenersLock</span><span class=p>.</span><span class=nf>RLock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>defer</span> <span class=nx>p</span><span class=p>.</span><span class=nx>listenersLock</span><span class=p>.</span><span class=nf>RUnlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>listener</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>p</span><span class=p>.</span><span class=nx>listeners</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>p</span><span class=p>.</span><span class=nx>wg</span><span class=p>.</span><span class=nf>Start</span><span class=p>(</span><span class=nx>listener</span><span class=p>.</span><span class=nx>run</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>			<span class=nx>p</span><span class=p>.</span><span class=nx>wg</span><span class=p>.</span><span class=nf>Start</span><span class=p>(</span><span class=nx>listener</span><span class=p>.</span><span class=nx>pop</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>p</span><span class=p>.</span><span class=nx>listenersStarted</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>	<span class=p>}()</span>
</span></span><span class=line><span class=cl>	<span class=o>&lt;-</span><span class=nx>stopCh</span>
</span></span><span class=line><span class=cl>	<span class=nx>p</span><span class=p>.</span><span class=nx>listenersLock</span><span class=p>.</span><span class=nf>RLock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>p</span><span class=p>.</span><span class=nx>listenersLock</span><span class=p>.</span><span class=nf>RUnlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>listener</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>p</span><span class=p>.</span><span class=nx>listeners</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nb>close</span><span class=p>(</span><span class=nx>listener</span><span class=p>.</span><span class=nx>addCh</span><span class=p>)</span> <span class=c1>// Tell .pop() to stop. .pop() will tell .run() to stop
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>p</span><span class=p>.</span><span class=nx>wg</span><span class=p>.</span><span class=nf>Wait</span><span class=p>()</span> <span class=c1>// Wait for all .pop() and .run() to stop
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>可以看出，就是拿到的事件，根据注册的到informer的事件函数进行处理</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>p</span> <span class=o>*</span><span class=nx>processorListener</span><span class=p>)</span> <span class=nf>run</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>stopCh</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kd>struct</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>	<span class=nx>wait</span><span class=p>.</span><span class=nf>Until</span><span class=p>(</span><span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=nx>next</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>p</span><span class=p>.</span><span class=nx>nextCh</span> <span class=p>{</span> <span class=c1>// 消费事件
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>switch</span> <span class=nx>notification</span> <span class=o>:=</span> <span class=nx>next</span><span class=p>.(</span><span class=kd>type</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>case</span> <span class=nx>updateNotification</span><span class=p>:</span>
</span></span><span class=line><span class=cl>				<span class=nx>p</span><span class=p>.</span><span class=nx>handler</span><span class=p>.</span><span class=nf>OnUpdate</span><span class=p>(</span><span class=nx>notification</span><span class=p>.</span><span class=nx>oldObj</span><span class=p>,</span> <span class=nx>notification</span><span class=p>.</span><span class=nx>newObj</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>case</span> <span class=nx>addNotification</span><span class=p>:</span>
</span></span><span class=line><span class=cl>				<span class=nx>p</span><span class=p>.</span><span class=nx>handler</span><span class=p>.</span><span class=nf>OnAdd</span><span class=p>(</span><span class=nx>notification</span><span class=p>.</span><span class=nx>newObj</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>case</span> <span class=nx>deleteNotification</span><span class=p>:</span>
</span></span><span class=line><span class=cl>				<span class=nx>p</span><span class=p>.</span><span class=nx>handler</span><span class=p>.</span><span class=nf>OnDelete</span><span class=p>(</span><span class=nx>notification</span><span class=p>.</span><span class=nx>oldObj</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>				<span class=nx>utilruntime</span><span class=p>.</span><span class=nf>HandleError</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;unrecognized notification: %T&#34;</span><span class=p>,</span> <span class=nx>next</span><span class=p>))</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=c1>// the only way to get here is if the p.nextCh is empty and closed
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nb>close</span><span class=p>(</span><span class=nx>stopCh</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>},</span> <span class=mi>1</span><span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>,</span> <span class=nx>stopCh</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><h3 id=informer中的事件的设计>informer中的事件的设计<a hidden class=anchor aria-hidden=true href=#informer中的事件的设计>#</a></h3><p>了解了informer如何处理事件，就需要学习下，informer的事件系统设计 <code>prossorListener</code></p><h4 id=事件的添加>事件的添加<a hidden class=anchor aria-hidden=true href=#事件的添加>#</a></h4><p>当在handleDelta时，会分发具体的事件</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 事件的分发
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>s</span><span class=p>.</span><span class=nx>processor</span><span class=p>.</span><span class=nf>distribute</span><span class=p>(</span><span class=nx>updateNotification</span><span class=p>{</span><span class=nx>oldObj</span><span class=p>:</span> <span class=nx>old</span><span class=p>,</span> <span class=nx>newObj</span><span class=p>:</span> <span class=nx>d</span><span class=p>.</span><span class=nx>Object</span><span class=p>},</span> <span class=nx>isSync</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div></div></div><p>此时，事件泵 <code>Pop()</code> 会根据接收到的事件进行处理</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// run() 时会启动一个事件泵
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>p</span><span class=p>.</span><span class=nx>wg</span><span class=p>.</span><span class=nf>Start</span><span class=p>(</span><span class=nx>listener</span><span class=p>.</span><span class=nx>pop</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>p</span> <span class=o>*</span><span class=nx>processorListener</span><span class=p>)</span> <span class=nf>pop</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>utilruntime</span><span class=p>.</span><span class=nf>HandleCrash</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nb>close</span><span class=p>(</span><span class=nx>p</span><span class=p>.</span><span class=nx>nextCh</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>nextCh</span> <span class=kd>chan</span><span class=o>&lt;-</span> <span class=kd>interface</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>notification</span> <span class=kd>interface</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=nx>nextCh</span> <span class=o>&lt;-</span> <span class=nx>notification</span><span class=p>:</span> <span class=c1>// 这里实际上是一个阻塞的等待
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// 单向channel 可能不会走到这步骤
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=kd>var</span> <span class=nx>ok</span> <span class=kt>bool</span>
</span></span><span class=line><span class=cl>            <span class=c1>// deltahandle 中 distribute 会将事件添加到addCh待处理事件中
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// 处理完事件会再次拿到一个事件
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>notification</span><span class=p>,</span> <span class=nx>ok</span> <span class=p>=</span> <span class=nx>p</span><span class=p>.</span><span class=nx>pendingNotifications</span><span class=p>.</span><span class=nf>ReadOne</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span> <span class=c1>// Nothing to pop
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=nx>nextCh</span> <span class=p>=</span> <span class=kc>nil</span> <span class=c1>// Disable this select case
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 处理 分发过来的事件 addCh
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>case</span> <span class=nx>notificationToAdd</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>p</span><span class=p>.</span><span class=nx>addCh</span><span class=p>:</span> <span class=c1>// distribute分发的事件
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 这里代表第一次，没有任何事件时，或者上面步骤完成读取
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>if</span> <span class=nx>notification</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span> <span class=c1>// 就会走这里
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=nx>notification</span> <span class=p>=</span> <span class=nx>notificationToAdd</span> 
</span></span><span class=line><span class=cl>				<span class=nx>nextCh</span> <span class=p>=</span> <span class=nx>p</span><span class=p>.</span><span class=nx>nextCh</span> 
</span></span><span class=line><span class=cl>			<span class=p>}</span> <span class=k>else</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>                <span class=c1>// notification否则代表没有处理完，将数据再次添加到待处理中
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=nx>p</span><span class=p>.</span><span class=nx>pendingNotifications</span><span class=p>.</span><span class=nf>WriteOne</span><span class=p>(</span><span class=nx>notificationToAdd</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>该消息事件的流程图为</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220525213837136.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220525213837136.png#center alt=image-20220525213837136 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><p>通过一个简单实例来学习client-go中的消息通知机制</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=s>&#34;k8s.io/utils/buffer&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>nextCh1</span> <span class=p>=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kd>interface</span><span class=p>{})</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>addCh</span> <span class=p>=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kd>interface</span><span class=p>{})</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>stopper</span> <span class=p>=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kd>struct</span><span class=p>{})</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>notification</span> <span class=kd>interface</span><span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>pendding</span> <span class=p>=</span> <span class=o>*</span><span class=nx>buffer</span><span class=p>.</span><span class=nf>NewRingGrowing</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// pop
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=kd>var</span> <span class=nx>nextCh</span> <span class=kd>chan</span><span class=o>&lt;-</span> <span class=kd>interface</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>		<span class=kd>var</span> <span class=nx>notification</span> <span class=kd>interface</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>		<span class=c1>//var n int
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;busy wait&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;entry select&#34;</span><span class=p>,</span> <span class=nx>notification</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// 初始时，一个未初始化的channel，nil，形成一个阻塞（单channel下是死锁）
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>case</span> <span class=nx>nextCh</span> <span class=o>&lt;-</span> <span class=nx>notification</span><span class=p>:</span>
</span></span><span class=line><span class=cl>				<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;entry nextCh&#34;</span><span class=p>,</span> <span class=nx>notification</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=kd>var</span> <span class=nx>ok</span> <span class=kt>bool</span>
</span></span><span class=line><span class=cl>				<span class=c1>// 读不到数据代表已处理完，置空锁
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=nx>notification</span><span class=p>,</span> <span class=nx>ok</span> <span class=p>=</span> <span class=nx>pendding</span><span class=p>.</span><span class=nf>ReadOne</span><span class=p>()</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;unactive nextch&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>					<span class=nx>nextCh</span> <span class=p>=</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=c1>// 事件的分发，监听，初始时也是一个阻塞
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>case</span> <span class=nx>notificationToAdd</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>addCh</span><span class=p>:</span>
</span></span><span class=line><span class=cl>				<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>notificationToAdd</span><span class=p>,</span> <span class=nx>notification</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=k>return</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=c1>// 线程安全
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// 当消息为空时，没有被处理
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// 锁为空，就分发数据
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=k>if</span> <span class=nx>notification</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;frist notification nil&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>					<span class=nx>notification</span> <span class=p>=</span> <span class=nx>notificationToAdd</span>
</span></span><span class=line><span class=cl>					<span class=nx>nextCh</span> <span class=p>=</span> <span class=nx>nextCh1</span> <span class=c1>// 这步骤等于初始化了局部的nextCh，会触发上面的流程
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=c1>// 在第三次时，会走到这里，数据进入环
</span></span></span><span class=line><span class=cl><span class=c1></span>					<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;into ring&#34;</span><span class=p>,</span> <span class=nx>notificationToAdd</span><span class=p>)</span>
</span></span><span class=line><span class=cl>					<span class=nx>pendding</span><span class=p>.</span><span class=nf>WriteOne</span><span class=p>(</span><span class=nx>notificationToAdd</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}()</span>
</span></span><span class=line><span class=cl>	<span class=c1>// producer
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>i</span> <span class=o>:=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>i</span><span class=o>++</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>i</span><span class=o>%</span><span class=mi>5</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>addCh</span> <span class=o>&lt;-</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;thread 2 inner -- %d&#34;</span><span class=p>,</span> <span class=nx>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=nx>time</span><span class=p>.</span><span class=nf>Sleep</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nx>Millisecond</span> <span class=o>*</span> <span class=mi>9000</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>addCh</span> <span class=o>&lt;-</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;thread 2 outer -- %d&#34;</span><span class=p>,</span> <span class=nx>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=nx>time</span><span class=p>.</span><span class=nf>Sleep</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nx>Millisecond</span> <span class=o>*</span> <span class=mi>500</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}()</span>
</span></span><span class=line><span class=cl>	<span class=c1>// subsriber
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>for</span> <span class=nx>next</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>nextCh1</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>time</span><span class=p>.</span><span class=nf>Sleep</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nx>Millisecond</span> <span class=o>*</span> <span class=mi>300</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;consumer&#34;</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}()</span>
</span></span><span class=line><span class=cl>	<span class=o>&lt;-</span><span class=nx>stopper</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>总结，这里的机制类似于线程安全，进入临界区的一些算法，临界区就是 <code>nextCh</code>，<code>notification</code> 就是保证了至少有一个进程可以进入临界区（要么分发事件，要么生产事件）；<code>nextCh</code> 和 <code>nextCh1</code> 一个是局部管道一个是全局的，管道未初始化代表了死锁（阻塞）；当有消息要处理时，会将局部管道 <code>nextCh</code> 赋值给 全局 <code>nextCh1</code> 此时相当于解除了分发的步骤（对管道赋值，触发分发操作）；<code>ringbuffer</code> 实际上是提供了一个对 <code>notification</code> 加锁的操作，在没有处理的消息时，需要保障 <code>notification</code> 为空，同时也关闭了流程 <code>nextCh</code> 的写入。这里主要是考虑对golang中channel的用法</p></div><div class=pe-copyright><hr><blockquote><p>本文为原创内容，版权归作者所有。如需转载，请在文章中声明本文标题及链接。</p><p>文章标题：源码分析client-go架构 - 什么是informer</p><p>文章链接：<a href=https://www.oomkill.com/2022/05/ch08-informer/ target=_blank>https://www.oomkill.com/2022/05/ch08-informer/</a></p><p>许可协议：<a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></p></blockquote></div><div class=comments-separator></div><h3 class=relatedContentTitle>相关阅读</h3><ul class=relatedContent><li><a href=/2022/05/ch06-client-go/><span>Kubernetes组件核心 - client-go</span></a></li><li><a href=/2022/05/ch02-kubernetes-api/><span>深入理解kubernetes API</span></a></li><li><a href=/2021/12/ch05-listwatch-mechanism/><span>理解kubernetes listwatch机制原理</span></a></li><li><a href=/2021/11/ch03-kubernetes-schema/><span>理解kubernetes schema</span></a></li><li><a href=/2021/11/ch01-k8s-perpare/><span>k8s开发环境准备 - 如何配置开发环境</span></a></li></ul><div class=comments-separator></div><footer class=post-footer><ul class=post-tags><li><a href=https://www.oomkill.com/tags/kubernetes-develop/>Kubernetes Develop</a></li><li><a href=https://www.oomkill.com/tags/kubernetes/>Kubernetes</a></li></ul><nav class=paginav><a class=prev href=https://www.oomkill.com/2022/05/debian11-install-tutorial/><span class=title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left" style="user-select:text"><line x1="19" y1="12" x2="5" y2="12" style="user-select:text"/><polyline points="12 19 5 12 12 5" style="user-select:text"/></polyline></svg>&nbsp;</span>
<span>安装Debian11 (bullseye) Step-by-Step</span>
</a><a class=next href=https://www.oomkill.com/2022/05/ch06-client-go/><span class=title></span>
<span>Kubernetes组件核心 - client-go&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right" style="user-select:text"><line x1="5" y1="12" x2="19" y2="12" style="user-select:text"/><polyline points="12 5 19 12 12 19" style="user-select:text"/></svg></span></a></nav></footer><div class=pe-comments-decoration><p class=pe-comments-title></p><p class=pe-comments-subtitle></p></div><div id=pe-comments></div><script src=/js/pe-go-comment.min.86a214102576ba5f9b7bdc29eed8d58dd56e34aef80b3c65c73ea9cc88443696.js integrity="sha256-hqIUECV2ul+be9wp7tjVjdVuNK74Czxlxz6pzIhENpY="></script><script>const getStoredTheme=()=>localStorage.getItem("pref-theme")==="dark"?"dark":"light",setGiscusTheme=()=>{const e=e=>{const t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:e},"https://giscus.app")};e({setConfig:{theme:getStoredTheme()}})};document.addEventListener("DOMContentLoaded",()=>{const s={src:"https://giscus.app/client.js","data-repo":"cylonchau/cylonchau.github.io","data-repo-id":"R_kgDOIRlNSQ","data-category":"Announcements","data-category-id":"DIC_kwDOIRlNSc4CXy1U","data-mapping":"pathname","data-term":"posts/ch08 Informer","data-strict":"0","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"top","data-theme":getStoredTheme(),"data-lang":"zh-TW","data-loading":"lazy",crossorigin:"anonymous",async:""},e=document.createElement("script");Object.entries(s).forEach(([t,n])=>e.setAttribute(t,n)),document.querySelector("#pe-comments").appendChild(e);const t=document.querySelector("#theme-toggle");t&&t.addEventListener("click",setGiscusTheme);const n=document.querySelector("#theme-toggle-float");n&&n.addEventListener("click",setGiscusTheme)})</script></article></main><footer class=footer><span>&copy; 2024 <a href=https://www.oomkill.com/>Cylon's Collection</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> on
<a href=https://pages.github.com/ rel=noopener target=_blank>GitHub Pages</a> & Theme
        <a href=https://github.com/tofuwine/PaperMod-PE rel=noopener target=_blank>PaperMod-PE</a></span></footer><div class=pe-right-sidebar><a href=javascript:void(0); id=theme-toggle-float class=pe-float-btn><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</a><a href=#top class=pe-float-btn id=top-link><span id=pe-read-progress></span></a></div><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>