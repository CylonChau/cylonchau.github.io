<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>如何理解kubernetes调度框架与插件？ | Cylon's Collection</title><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NP3JNCPR" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><meta name=keywords content="kubernetes,develop"><meta name=description content="调度框架 [1] 本文基于 kubernetes 1.24 进行分析
调度框架（Scheduling Framework）是Kubernetes 的调度器 kube-scheduler 设计的的可插拔架构，将插件（调度算法）嵌入到调度上下文的每个扩展点中，并编译为 kube-scheduler
在 kube-scheduler 1.22 之后，在 pkg/scheduler/framework/interface.go 中定义了一个 Plugin 的 interface，这个 interface 作为了所有插件的父级。而每个未调度的 Pod，Kubernetes 调度器会根据一组规则尝试在集群中寻找一个节点。
go 1 2 3 type Plugin interface { Name() string } 下面会对每个算法是如何实现的进行分析
在初始化 scheduler 时，会创建一个 profile，profile是关于 scheduler 调度配置相关的定义
go 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 func New(client clientset.Interface, ."><meta name=author content="cylon"><link rel=canonical href=https://www.oomkill.com/2022/07/ch21-scheduling-algorithm/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://www.oomkill.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.oomkill.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.oomkill.com/favicon-32x32.png><link rel=apple-touch-icon href=https://www.oomkill.com/favicon.ico><link rel=mask-icon href=https://www.oomkill.com/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://www.oomkill.com/2022/07/ch21-scheduling-algorithm/><noscript><style>#theme-toggle,#top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link crossorigin=anonymous href=/assets/css/pe.min.css rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/pe.min.js></script><link rel=stylesheet href=https://cdn.staticfile.net/font-awesome/6.5.1/css/all.min.css><link rel=stylesheet href=https://cdn.staticfile.net/font-awesome/6.5.1/css/v4-shims.min.css><script defer src=https://cdn.staticfile.net/jquery/3.5.1/jquery.min.js></script><link rel=stylesheet href=https://cdn.staticfile.net/fancybox/3.5.7/jquery.fancybox.min.css><script defer src=https://cdn.staticfile.net/fancybox/3.5.7/jquery.fancybox.min.js></script><script id=MathJax-script async src=https://cdn.staticfile.net/mathjax/3.2.2/es5/tex-chtml.js></script><script>MathJax={tex:{displayMath:[["$$","$$"]],inlineMath:[["\\$","\\$"]]}}</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-H94HZ5S19Y"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-H94HZ5S19Y")</script><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><meta name=referrer content="no-referrer-when-downgrade"><meta property="og:title" content="如何理解kubernetes调度框架与插件？"><meta property="og:description" content="调度框架 [1] 本文基于 kubernetes 1.24 进行分析
调度框架（Scheduling Framework）是Kubernetes 的调度器 kube-scheduler 设计的的可插拔架构，将插件（调度算法）嵌入到调度上下文的每个扩展点中，并编译为 kube-scheduler
在 kube-scheduler 1.22 之后，在 pkg/scheduler/framework/interface.go 中定义了一个 Plugin 的 interface，这个 interface 作为了所有插件的父级。而每个未调度的 Pod，Kubernetes 调度器会根据一组规则尝试在集群中寻找一个节点。
go 1 2 3 type Plugin interface { Name() string } 下面会对每个算法是如何实现的进行分析
在初始化 scheduler 时，会创建一个 profile，profile是关于 scheduler 调度配置相关的定义
go 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 func New(client clientset.Interface, ."><meta property="og:type" content="article"><meta property="og:url" content="https://www.oomkill.com/2022/07/ch21-scheduling-algorithm/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-07-27T00:00:00+00:00"><meta property="og:site_name" content="Cylon's Collection"><meta name=twitter:card content="summary"><meta name=twitter:title content="如何理解kubernetes调度框架与插件？"><meta name=twitter:description content="调度框架 [1] 本文基于 kubernetes 1.24 进行分析
调度框架（Scheduling Framework）是Kubernetes 的调度器 kube-scheduler 设计的的可插拔架构，将插件（调度算法）嵌入到调度上下文的每个扩展点中，并编译为 kube-scheduler
在 kube-scheduler 1.22 之后，在 pkg/scheduler/framework/interface.go 中定义了一个 Plugin 的 interface，这个 interface 作为了所有插件的父级。而每个未调度的 Pod，Kubernetes 调度器会根据一组规则尝试在集群中寻找一个节点。
go 1 2 3 type Plugin interface { Name() string } 下面会对每个算法是如何实现的进行分析
在初始化 scheduler 时，会创建一个 profile，profile是关于 scheduler 调度配置相关的定义
go 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 func New(client clientset.Interface, ."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://www.oomkill.com/posts/"},{"@type":"ListItem","position":2,"name":"如何理解kubernetes调度框架与插件？","item":"https://www.oomkill.com/2022/07/ch21-scheduling-algorithm/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"如何理解kubernetes调度框架与插件？","name":"如何理解kubernetes调度框架与插件？","description":"调度框架 [1] 本文基于 kubernetes 1.24 进行分析\n调度框架（Scheduling Framework）是Kubernetes 的调度器 kube-scheduler 设计的的可插拔架构，将插件（调度算法）嵌入到调度上下文的每个扩展点中，并编译为 kube-scheduler\n在 kube-scheduler 1.22 之后，在 pkg/scheduler/framework/interface.go 中定义了一个 Plugin 的 interface，这个 interface 作为了所有插件的父级。而每个未调度的 Pod，Kubernetes 调度器会根据一组规则尝试在集群中寻找一个节点。\ngo 1 2 3 type Plugin interface { Name() string } 下面会对每个算法是如何实现的进行分析\n在初始化 scheduler 时，会创建一个 profile，profile是关于 scheduler 调度配置相关的定义\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 func New(client clientset.Interface, .","keywords":["kubernetes","develop"],"articleBody":"调度框架 [1] 本文基于 kubernetes 1.24 进行分析\n调度框架（Scheduling Framework）是Kubernetes 的调度器 kube-scheduler 设计的的可插拔架构，将插件（调度算法）嵌入到调度上下文的每个扩展点中，并编译为 kube-scheduler\n在 kube-scheduler 1.22 之后，在 pkg/scheduler/framework/interface.go 中定义了一个 Plugin 的 interface，这个 interface 作为了所有插件的父级。而每个未调度的 Pod，Kubernetes 调度器会根据一组规则尝试在集群中寻找一个节点。\ngo 1 2 3 type Plugin interface { Name() string } 下面会对每个算法是如何实现的进行分析\n在初始化 scheduler 时，会创建一个 profile，profile是关于 scheduler 调度配置相关的定义\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 func New(client clientset.Interface, ... profiles, err := profile.NewMap(options.profiles, registry, recorderFactory, stopCh, frameworkruntime.WithComponentConfigVersion(options.componentConfigVersion), frameworkruntime.WithClientSet(client), frameworkruntime.WithKubeConfig(options.kubeConfig), frameworkruntime.WithInformerFactory(informerFactory), frameworkruntime.WithSnapshotSharedLister(snapshot), frameworkruntime.WithPodNominator(nominator), frameworkruntime.WithCaptureProfile(frameworkruntime.CaptureProfile(options.frameworkCapturer)), frameworkruntime.WithClusterEventMap(clusterEventMap), frameworkruntime.WithParallelism(int(options.parallelism)), frameworkruntime.WithExtenders(extenders), ) if err != nil { return nil, fmt.Errorf(\"initializing profiles: %v\", err) } if len(profiles) == 0 { return nil, errors.New(\"at least one profile is required\") } .... } 关于 profile 的实现，则为 KubeSchedulerProfile，也是作为 yaml生成时传入的配置\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 // KubeSchedulerProfile 是一个 scheduling profile. type KubeSchedulerProfile struct { // SchedulerName 是与此配置文件关联的调度程序的名称。 // 如果 SchedulerName 与 pod “spec.schedulerName”匹配，则使用此配置文件调度 pod。 SchedulerName string // Plugins指定应该启用或禁用的插件集。 // 启用的插件是除了默认插件之外应该启用的插件。禁用插件应是禁用的任何默认插件。 // 当没有为扩展点指定启用或禁用插件时，将使用该扩展点的默认插件（如果有）。 // 如果指定了 QueueSort 插件， // 则必须为所有配置文件指定相同的 QueueSort Plugin 和 PluginConfig。 // 这个Plugins展现的形式则是调度上下文中的所有扩展点(这是抽象)，实际中会表现为多个扩展点 Plugins *Plugins // PluginConfig 是每个插件的一组可选的自定义插件参数。 // 如果省略PluginConfig参数等同于使用该插件的默认配置。 PluginConfig []PluginConfig } 对于 profile.NewMap 就是根据给定的配置来构建这个framework，因为配置可能是存在多个的。而 Registry 则是所有可用插件的集合，内部构造则是 PluginFactory ,通过函数来构建出对应的 plugin\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 func NewMap(cfgs []config.KubeSchedulerProfile, r frameworkruntime.Registry, recorderFact RecorderFactory, stopCh \u003c-chan struct{}, opts ...frameworkruntime.Option) (Map, error) { m := make(Map) v := cfgValidator{m: m} for _, cfg := range cfgs { p, err := newProfile(cfg, r, recorderFact, stopCh, opts...) if err != nil { return nil, fmt.Errorf(\"creating profile for scheduler name %s: %v\", cfg.SchedulerName, err) } if err := v.validate(cfg, p); err != nil { return nil, err } m[cfg.SchedulerName] = p } return m, nil } // newProfile 给的配置构建出一个profile func newProfile(cfg config.KubeSchedulerProfile, r frameworkruntime.Registry, recorderFact RecorderFactory, stopCh \u003c-chan struct{}, opts ...frameworkruntime.Option) (framework.Framework, error) { recorder := recorderFact(cfg.SchedulerName) opts = append(opts, frameworkruntime.WithEventRecorder(recorder)) return frameworkruntime.NewFramework(r, \u0026cfg, stopCh, opts...) } 可以看到最终返回的是一个 Framework 。那么来看下这个 Framework\nFramework 是一个抽象，管理着调度过程中所使用的所有插件，并在调度上下文中适当的位置去运行对应的插件\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 type Framework interface { Handle // QueueSortFunc 返回对调度队列中的 Pod 进行排序的函数 // 也就是less，在Sort打分阶段的打分函数 QueueSortFunc() LessFunc // RunPreFilterPlugins 运行配置的一组PreFilter插件。 // 如果这组插件中，任何一个插件失败，则返回 *Status 并设置为non-success。 // 如果返回状态为non-success，则调度周期中止。 // 它还返回一个 PreFilterResult，它可能会影响到要评估下游的节点。 RunPreFilterPlugins(ctx context.Context, state *CycleState, pod *v1.Pod) (*PreFilterResult, *Status) // RunPostFilterPlugins 运行配置的一组PostFilter插件。 // PostFilter 插件是通知性插件，在这种情况下应配置为先执行并返回 Unschedulable 状态， // 或者尝试更改集群状态以使 pod 在未来的调度周期中可能会被调度。 RunPostFilterPlugins(ctx context.Context, state *CycleState, pod *v1.Pod, filteredNodeStatusMap NodeToStatusMap) (*PostFilterResult, *Status) // RunPreBindPlugins 运行配置的一组 PreBind 插件。 // 如果任何一个插件返回错误，则返回 *Status 并且code设置为non-success。 // 如果code为“Unschedulable”，则调度检查失败， // 则认为是内部错误。在任何一种情况下，Pod都不会被bound。 RunPreBindPlugins(ctx context.Context, state *CycleState, pod *v1.Pod, nodeName string) *Status // RunPostBindPlugins 运行配置的一组PostBind插件 RunPostBindPlugins(ctx context.Context, state *CycleState, pod *v1.Pod, nodeName string) // RunReservePluginsReserve运行配置的一组Reserve插件的Reserve方法。 // 如果在这组调用中的任何一个插件返回错误，则不会继续运行剩余调用的插件并返回错误。 // 在这种情况下，pod将不能被调度。 RunReservePluginsReserve(ctx context.Context, state *CycleState, pod *v1.Pod, nodeName string) *Status // RunReservePluginsUnreserve运行配置的一组Reserve插件的Unreserve方法。 RunReservePluginsUnreserve(ctx context.Context, state *CycleState, pod *v1.Pod, nodeName string) // RunPermitPlugins运行配置的一组Permit插件。 // 如果这些插件中的任何一个返回“Success”或“Wait”之外的状态，则它不会继续运行其余插件并返回错误。 // 否则，如果任何插件返回 “Wait”，则此函数将创建等待pod并将其添加到当前等待pod的map中， // 并使用“Wait” code返回状态。 Pod将在Permit插件返回的最短持续时间内保持等待pod。 RunPermitPlugins(ctx context.Context, state *CycleState, pod *v1.Pod, nodeName string) *Status // 如果pod是waiting pod，WaitOnPermit 将阻塞，直到等待的pod被允许或拒绝。 WaitOnPermit(ctx context.Context, pod *v1.Pod) *Status // RunBindPlugins运行配置的一组bind插件。 Bind插件可以选择是否处理Pod。 // 如果 Bind 插件选择跳过binding，它应该返回 code=5(\"skip\")状态。 // 否则，它应该返回“Error”或“Success”。 // 如果没有插件处理绑定，则RunBindPlugins返回code=5(\"skip\")的状态。 RunBindPlugins(ctx context.Context, state *CycleState, pod *v1.Pod, nodeName string) *Status // 如果至少定义了一个filter插件，则HasFilterPlugins返回true HasFilterPlugins() bool // 如果至少定义了一个PostFilter插件，则HasPostFilterPlugins返回 true。 HasPostFilterPlugins() bool // 如果至少定义了一个Score插件，则HasScorePlugins返回 true。 HasScorePlugins() bool // ListPlugins将返回map。key为扩展点名称，value则是配置的插件列表。 ListPlugins() *config.Plugins // ProfileName则是与profile name关联的framework ProfileName() string } 而实现这个抽象的则是 frameworkImpl；frameworkImpl 是初始化与运行 scheduler plugins 的组件，并在调度上下文中会运行这些扩展点\ntext 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 type frameworkImpl struct { registry Registry snapshotSharedLister framework.SharedLister waitingPods *waitingPodsMap scorePluginWeight map[string]int queueSortPlugins []framework.QueueSortPlugin preFilterPlugins []framework.PreFilterPlugin filterPlugins []framework.FilterPlugin postFilterPlugins []framework.PostFilterPlugin preScorePlugins []framework.PreScorePlugin scorePlugins []framework.ScorePlugin reservePlugins []framework.ReservePlugin preBindPlugins []framework.PreBindPlugin bindPlugins []framework.BindPlugin postBindPlugins []framework.PostBindPlugin permitPlugins []framework.PermitPlugin clientSet clientset.Interface kubeConfig *restclient.Config eventRecorder events.EventRecorder informerFactory informers.SharedInformerFactory metricsRecorder *metricsRecorder profileName string extenders []framework.Extender framework.PodNominator parallelizer parallelize.Parallelizer } 那么来看下 Registry ，Registry 是作为一个可用插件的集合。framework 使用 registry 来启用和对插件配置的初始化。在初始化框架之前，所有插件都必须在注册表中。表现形式就是一个 map[]；key 是插件的名称，value是 PluginFactory 。\ngo 1 type Registry map[string]PluginFactory 而在 pkg\\scheduler\\framework\\plugins\\registry.go 中会将所有的 in-tree plugin 注册进来。通过 NewInTreeRegistry 。后续如果还有插件要注册，可以通过 WithFrameworkOutOfTreeRegistry 来注册其他的插件。\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 func NewInTreeRegistry() runtime.Registry { fts := plfeature.Features{ EnableReadWriteOncePod: feature.DefaultFeatureGate.Enabled(features.ReadWriteOncePod), EnableVolumeCapacityPriority: feature.DefaultFeatureGate.Enabled(features.VolumeCapacityPriority), EnableMinDomainsInPodTopologySpread: feature.DefaultFeatureGate.Enabled(features.MinDomainsInPodTopologySpread), EnableNodeInclusionPolicyInPodTopologySpread: feature.DefaultFeatureGate.Enabled(features.NodeInclusionPolicyInPodTopologySpread), } return runtime.Registry{ selectorspread.Name: selectorspread.New, imagelocality.Name: imagelocality.New, tainttoleration.Name: tainttoleration.New, nodename.Name: nodename.New, nodeports.Name: nodeports.New, nodeaffinity.Name: nodeaffinity.New, podtopologyspread.Name: runtime.FactoryAdapter(fts, podtopologyspread.New), nodeunschedulable.Name: nodeunschedulable.New, noderesources.Name: runtime.FactoryAdapter(fts, noderesources.NewFit), noderesources.BalancedAllocationName: runtime.FactoryAdapter(fts, noderesources.NewBalancedAllocation), volumebinding.Name: runtime.FactoryAdapter(fts, volumebinding.New), volumerestrictions.Name: runtime.FactoryAdapter(fts, volumerestrictions.New), volumezone.Name: volumezone.New, nodevolumelimits.CSIName: runtime.FactoryAdapter(fts, nodevolumelimits.NewCSI), nodevolumelimits.EBSName: runtime.FactoryAdapter(fts, nodevolumelimits.NewEBS), nodevolumelimits.GCEPDName: runtime.FactoryAdapter(fts, nodevolumelimits.NewGCEPD), nodevolumelimits.AzureDiskName: runtime.FactoryAdapter(fts, nodevolumelimits.NewAzureDisk), nodevolumelimits.CinderName: runtime.FactoryAdapter(fts, nodevolumelimits.NewCinder), interpodaffinity.Name: interpodaffinity.New, queuesort.Name: queuesort.New, defaultbinder.Name: defaultbinder.New, defaultpreemption.Name: runtime.FactoryAdapter(fts, defaultpreemption.New), } } 这里插入一个题外话，关于 in-tree plugin\n在这里没有找到关于，kube-scheduler ，只是找到有关的概念，大概可以解释为，in-tree表示为随kubernetes官方提供的二进制构建的 plugin 则为 in-tree，而独立于kubernetes代码库之外的为 out-of-tree [3] 。这种情况下，可以理解为，AA则是 out-of-tree 而 Pod, DeplymentSet 等是 in-tree。\n接下来回到初始化 scheduler ，在初始化一个 scheduler 时，会通过NewInTreeRegistry 来初始化\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 func New(client clientset.Interface, .... registry := frameworkplugins.NewInTreeRegistry() if err := registry.Merge(options.frameworkOutOfTreeRegistry); err != nil { return nil, err } ... profiles, err := profile.NewMap(options.profiles, registry, recorderFactory, stopCh, frameworkruntime.WithComponentConfigVersion(options.componentConfigVersion), frameworkruntime.WithClientSet(client), frameworkruntime.WithKubeConfig(options.kubeConfig), frameworkruntime.WithInformerFactory(informerFactory), frameworkruntime.WithSnapshotSharedLister(snapshot), frameworkruntime.WithPodNominator(nominator), frameworkruntime.WithCaptureProfile(frameworkruntime.CaptureProfile(options.frameworkCapturer)), frameworkruntime.WithClusterEventMap(clusterEventMap), frameworkruntime.WithParallelism(int(options.parallelism)), frameworkruntime.WithExtenders(extenders), ) ... } 接下来在调度上下文 scheduleOne 中 schedulePod 时，会通过 framework 调用对应的插件来处理这个扩展点工作。具体的体现在，pkg\\scheduler\\schedule_one.go 中的预选阶段\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 func (sched *Scheduler) schedulePod(ctx context.Context, fwk framework.Framework, state *framework.CycleState, pod *v1.Pod) (result ScheduleResult, err error) { trace := utiltrace.New(\"Scheduling\", utiltrace.Field{Key: \"namespace\", Value: pod.Namespace}, utiltrace.Field{Key: \"name\", Value: pod.Name}) defer trace.LogIfLong(100 * time.Millisecond) if err := sched.Cache.UpdateSnapshot(sched.nodeInfoSnapshot); err != nil { return result, err } trace.Step(\"Snapshotting scheduler cache and node infos done\") if sched.nodeInfoSnapshot.NumNodes() == 0 { return result, ErrNoNodesAvailable } feasibleNodes, diagnosis, err := sched.findNodesThatFitPod(ctx, fwk, state, pod) if err != nil { return result, err } trace.Step(\"Computing predicates done\") 与其他扩展点部分，在调度上下文 scheduleOne 中可以很好的看出，功能都是 framework 提供的。\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 func (sched *Scheduler) scheduleOne(ctx context.Context) { ... scheduleResult, err := sched.SchedulePod(schedulingCycleCtx, fwk, state, pod) ... // Run the Reserve method of reserve plugins. if sts := fwk.RunReservePluginsReserve(schedulingCycleCtx, state, assumedPod, scheduleResult.SuggestedHost); !sts.IsSuccess() { } ... // Run \"permit\" plugins. runPermitStatus := fwk.RunPermitPlugins(schedulingCycleCtx, state, assumedPod, scheduleResult.SuggestedHost) // One of the plugins returned status different than success or wait. fwk.RunReservePluginsUnreserve(schedulingCycleCtx, state, assumedPod, scheduleResult.SuggestedHost) ... // bind the pod to its host asynchronously (we can do this b/c of the assumption step above). go func() { ... waitOnPermitStatus := fwk.WaitOnPermit(bindingCycleCtx, assumedPod) if !waitOnPermitStatus.IsSuccess() { ... // trigger un-reserve plugins to clean up state associated with the reserved Pod fwk.RunReservePluginsUnreserve(bindingCycleCtx, state, assumedPod, scheduleResult.SuggestedHost) } // Run \"prebind\" plugins. preBindStatus := fwk.RunPreBindPlugins(bindingCycleCtx, state, assumedPod, scheduleResult.SuggestedHost) ... // trigger un-reserve plugins to clean up state associated with the reserved Pod fwk.RunReservePluginsUnreserve(bindingCycleCtx, state, assumedPod, scheduleResult.SuggestedHost) ... ... // trigger un-reserve plugins to clean up state associated with the reserved Pod fwk.RunReservePluginsUnreserve(bindingCycleCtx, state, assumedPod, scheduleResult.SuggestedHost) ... // Run \"postbind\" plugins. fwk.RunPostBindPlugins(bindingCycleCtx, state, assumedPod, scheduleResult.SuggestedHost) ... } 插件 [4] 插件（Plugins）（也可以算是调度策略）在 kube-scheduler 中的实现为 framework plugin，插件API的实现分为两个步骤**：register** 和 configured，然后都实现了其父方法 Plugin。然后可以通过配置（kube-scheduler --config 提供）启动或禁用插件；除了默认插件外，还可以实现自定义调度插件与默认插件进行绑定。\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 type Plugin interface { Name() string } // sort扩展点 type QueueSortPlugin interface { Plugin Less(*v1.pod, *v1.pod) bool } // PreFilter扩展点 type PreFilterPlugin interface { Plugin PreFilter(context.Context, *framework.CycleState, *v1.pod) error } 插件的载入过程 在 scheduler 被启动时，会 scheduler.New(cc.Client.. 这个时候会传入 profiles，整个的流如下：\nNewScheduler ：kubernetes/cmd/kube-scheduler/app/server.go profile.NewMap：kubernetes/pkg/scheduler/scheduler.go newProfile：kubernetes/pkg/scheduler/scheduler.go frameworkruntime.NewFramework：kubernetes/pkg/scheduler/framework/runtime/framework.go pluginsNeeded：kubernetes/pkg/scheduler/framework/runtime/framework.go NewScheduler 我们了解如何 New 一个 scheduler 即为 Setup 中去配置这些参数，\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 func Setup(ctx context.Context, opts *options.Options, outOfTreeRegistryOptions ...Option) (*schedulerserverconfig.CompletedConfig, *scheduler.Scheduler, error) { ... // Create the scheduler. sched, err := scheduler.New(cc.Client, cc.InformerFactory, cc.DynInformerFactory, recorderFactory, ctx.Done(), scheduler.WithComponentConfigVersion(cc.ComponentConfig.TypeMeta.APIVersion), scheduler.WithKubeConfig(cc.KubeConfig), scheduler.WithProfiles(cc.ComponentConfig.Profiles...), scheduler.WithPercentageOfNodesToScore(cc.ComponentConfig.PercentageOfNodesToScore), scheduler.WithFrameworkOutOfTreeRegistry(outOfTreeRegistry), scheduler.WithPodMaxBackoffSeconds(cc.ComponentConfig.PodMaxBackoffSeconds), scheduler.WithPodInitialBackoffSeconds(cc.ComponentConfig.PodInitialBackoffSeconds), scheduler.WithPodMaxInUnschedulablePodsDuration(cc.PodMaxInUnschedulablePodsDuration), scheduler.WithExtenders(cc.ComponentConfig.Extenders...), scheduler.WithParallelism(cc.ComponentConfig.Parallelism), scheduler.WithBuildFrameworkCapturer(func(profile kubeschedulerconfig.KubeSchedulerProfile) { // Profiles are processed during Framework instantiation to set default plugins and configurations. Capturing them for logging completedProfiles = append(completedProfiles, profile) }), ) ... } profile.NewMap 在 scheduler.New 中，会根据配置生成profile，而 profile.NewMap 会完成这一步\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 func New(client clientset.Interface, ... clusterEventMap := make(map[framework.ClusterEvent]sets.String) profiles, err := profile.NewMap(options.profiles, registry, recorderFactory, stopCh, frameworkruntime.WithComponentConfigVersion(options.componentConfigVersion), frameworkruntime.WithClientSet(client), frameworkruntime.WithKubeConfig(options.kubeConfig), frameworkruntime.WithInformerFactory(informerFactory), frameworkruntime.WithSnapshotSharedLister(snapshot), frameworkruntime.WithPodNominator(nominator), frameworkruntime.WithCaptureProfile(frameworkruntime.CaptureProfile(options.frameworkCapturer)), frameworkruntime.WithClusterEventMap(clusterEventMap), frameworkruntime.WithParallelism(int(options.parallelism)), frameworkruntime.WithExtenders(extenders), ) ... } NewFramework newProfile 返回的则是一个创建好的 framework\ngo 1 2 3 4 5 6 func newProfile(cfg config.KubeSchedulerProfile, r frameworkruntime.Registry, recorderFact RecorderFactory, stopCh \u003c-chan struct{}, opts ...frameworkruntime.Option) (framework.Framework, error) { recorder := recorderFact(cfg.SchedulerName) opts = append(opts, frameworkruntime.WithEventRecorder(recorder)) return frameworkruntime.NewFramework(r, \u0026cfg, stopCh, opts...) } 最终会走到 pluginsNeeded，这里会根据配置中开启的插件而返回一个插件集，这个就是最终在每个扩展点中药执行的插件。\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 func (f *frameworkImpl) pluginsNeeded(plugins *config.Plugins) sets.String { pgSet := sets.String{} if plugins == nil { return pgSet } find := func(pgs *config.PluginSet) { for _, pg := range pgs.Enabled { pgSet.Insert(pg.Name) } } // 获取到所有的扩展点，找到为Enabled的插件加入到pgSet for _, e := range f.getExtensionPoints(plugins) { find(e.plugins) } // Parse MultiPoint separately since they are not returned by f.getExtensionPoints() find(\u0026plugins.MultiPoint) return pgSet } 插件的执行 在对插件源码部分分析，会找几个典型的插件进行分析，而不会对全部的进行分析，因为总的来说是大同小异，分析的插件有 NodePorts，NodeResourcesFit，podtopologyspread\nNodePorts 这里以一个简单的插件来分析；NodePorts 插件用于检查Pod请求的端口，在节点上是否为空闲端口。\nNodePorts 实现了 FilterPlugin 和 PreFilterPlugin\nPreFilter 将会被 framework 中 PreFilter 扩展点被调用。\ngo 1 2 3 4 5 6 func (pl *NodePorts) PreFilter(ctx context.Context, cycleState *framework.CycleState, pod *v1.Pod) (*framework.PreFilterResult, *framework.Status) { s := getContainerPorts(pod) // 或得Pod得端口 // 写入状态 cycleState.Write(preFilterStateKey, preFilterState(s)) return nil, nil } Filter 将会被 framework 中 Filter 扩展点被调用。\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 // Filter invoked at the filter extension point. func (pl *NodePorts) Filter(ctx context.Context, cycleState *framework.CycleState, pod *v1.Pod, nodeInfo *framework.NodeInfo) *framework.Status { wantPorts, err := getPreFilterState(cycleState) if err != nil { return framework.AsStatus(err) } fits := fitsPorts(wantPorts, nodeInfo) if !fits { return framework.NewStatus(framework.Unschedulable, ErrReason) } return nil } func fitsPorts(wantPorts []*v1.ContainerPort, nodeInfo *framework.NodeInfo) bool { // 对比existingPorts 和 wantPorts是否冲突，冲突则调度失败 existingPorts := nodeInfo.UsedPorts for _, cp := range wantPorts { if existingPorts.CheckConflict(cp.HostIP, string(cp.Protocol), cp.HostPort) { return false } } return true } New ，初始化新插件，在 register 中注册得\ngo 1 2 3 func New(_ runtime.Object, _ framework.Handle) (framework.Plugin, error) { return \u0026NodePorts{}, nil } 在调用中，如果有任何一个插件返回错误，则跳过该扩展点注册得其他插件，返回失败。\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 func (f *frameworkImpl) RunFilterPlugins( ctx context.Context, state *framework.CycleState, pod *v1.Pod, nodeInfo *framework.NodeInfo, ) framework.PluginToStatus { statuses := make(framework.PluginToStatus) for _, pl := range f.filterPlugins { pluginStatus := f.runFilterPlugin(ctx, pl, state, pod, nodeInfo) if !pluginStatus.IsSuccess() { if !pluginStatus.IsUnschedulable() errStatus := framework.AsStatus(fmt.Errorf(\"running %q filter plugin: %w\", pl.Name(), pluginStatus.AsError())).WithFailedPlugin(pl.Name()) return map[string]*framework.Status{pl.Name(): errStatus} } pluginStatus.SetFailedPlugin(pl.Name()) statuses[pl.Name()] = pluginStatus } } return statuses } 返回得状态是一个 Status 结构体，该结构体表示了插件运行的结果。由 Code、reasons、（可选）err 和 failedPlugin （失败的那个插件名）组成。当 code 不是 Success 时，应说明原因。而且，当 code 为 Success 时，其他所有字段都应为空。nil 状态也被视为成功。\ngo 1 2 3 4 5 6 7 8 type Status struct { code Code reasons []string err error // failedPlugin is an optional field that records the plugin name a Pod failed by. // It's set by the framework when code is Error, Unschedulable or UnschedulableAndUnresolvable. failedPlugin string } NodeResourcesFit [5] NodeResourcesFit 扩展检查节点是否拥有 Pod 请求的所有资源。分数可以使用以下三种策略之一，扩展点为：preFilter， filter，score\nLeastAllocated （默认） MostAllocated RequestedToCapacityRatio Fit NodeResourcesFit PreFilter 可以看到调用得 computePodResourceRequest\ntext 1 2 3 4 5 // PreFilter invoked at the prefilter extension point. func (f *Fit) PreFilter(ctx context.Context, cycleState *framework.CycleState, pod *v1.Pod) (*framework.PreFilterResult, *framework.Status) { cycleState.Write(preFilterStateKey, computePodResourceRequest(pod)) return nil, nil } computePodResourceRequest 这里有一个注释，总体解释起来是这样得：computePodResourceRequest ，返回值（ framework.Resource）覆盖了每一个维度中资源的最大宽度。因为将按照 init-containers , containers 得顺序运行，会通过迭代方式收集每个维度中的最大值。计算时会对常规容器的资源向量求和，因为containers 运行会同时运行多个容器。计算示例为：\nyaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 Pod: InitContainers IC1: CPU: 2 Memory: 1G IC2: CPU: 2 Memory: 3G Containers C1: CPU: 2 Memory: 1G C2: CPU: 1 Memory: 1G 在维度1中（InitContainers）所需资源最大值时，CPU=2, Memory=3G；而维度2（Containers）所需资源最大值为：CPU=2, Memory=1G；那么最终结果为 CPU=3, Memory=3G，因为在维度1，最大资源时Memory=3G；而维度2最大资源是CPU=1+2, Memory=1+1，取每个维度中最大资源最大宽度即为 CPU=3, Memory=3G。\n下面则看下代码得实现\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 func computePodResourceRequest(pod *v1.Pod) *preFilterState { result := \u0026preFilterState{} for _, container := range pod.Spec.Containers { result.Add(container.Resources.Requests) } // 取最大得资源 for _, container := range pod.Spec.InitContainers { result.SetMaxResource(container.Resources.Requests) } // 如果Overhead正在使用，需要将其计算到总资源中 if pod.Spec.Overhead != nil { result.Add(pod.Spec.Overhead) } return result } // SetMaxResource 是比较ResourceList并为每个资源取最大值。 func (r *Resource) SetMaxResource(rl v1.ResourceList) { if r == nil { return } for rName, rQuantity := range rl { switch rName { case v1.ResourceMemory: r.Memory = max(r.Memory, rQuantity.Value()) case v1.ResourceCPU: r.MilliCPU = max(r.MilliCPU, rQuantity.MilliValue()) case v1.ResourceEphemeralStorage: if utilfeature.DefaultFeatureGate.Enabled(features.LocalStorageCapacityIsolation) { r.EphemeralStorage = max(r.EphemeralStorage, rQuantity.Value()) } default: if schedutil.IsScalarResourceName(rName) { r.SetScalar(rName, max(r.ScalarResources[rName], rQuantity.Value())) } } } } leastAllocate LeastAllocated 是 NodeResourcesFit 的打分策略 ，LeastAllocated 打分的标准是更偏向于请求资源较少的Node。将会先计算出Node上调度的pod请求的内存、CPU与其他资源的百分比，然后并根据请求的比例与容量的平均值的最小值进行优先级排序。\n计算公式是这样的：$\\frac{\\frac{cpu((capacity-requested) \\times MaxNodeScore \\times cpuWeight)}{capacity} + \\frac{memory((capacity-requested) \\times MaxNodeScore \\times memoryWeight}{capacity}) + …}{weightSum}$\n下面来看下实现\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 func leastResourceScorer(resToWeightMap resourceToWeightMap) func(resourceToValueMap, resourceToValueMap) int64 { return func(requested, allocable resourceToValueMap) int64 { var nodeScore, weightSum int64 for resource := range requested { weight := resToWeightMap[resource] // 计算出的资源分数乘weight resourceScore := leastRequestedScore(requested[resource], allocable[resource]) nodeScore += resourceScore * weight weightSum += weight } if weightSum == 0 { return 0 } // 最终除weightSum return nodeScore / weightSum } } leastRequestedScore 计算标准为未使用容量的计算范围为 0~MaxNodeScore，0 为最低优先级，MaxNodeScore 为最高优先级。未使用的资源越多，得分越高。\ngo 1 2 3 4 5 6 7 8 9 10 func leastRequestedScore(requested, capacity int64) int64 { if capacity == 0 { return 0 } if requested \u003e capacity { return 0 } // 容量 - 请求的 x 预期值（100）/ 容量 return ((capacity - requested) * int64(framework.MaxNodeScore)) / capacity } Topology [6] Concept 在对 podtopologyspread 插件进行分析前，先需要掌握Pod拓扑的概念。\nPod拓扑（Pod Topology）是Kubernetes Pod调度机制，可以将Pod分布在集群中不同 Zone ，以及用户自定义的各种拓扑域 （topology domains）。当有了拓扑域后，用户可以更高效的利用集群资源。\n如何来解释拓扑域，首先需要提及为什么需要拓扑域，在集群有3个节点，并且当Pod副本数为2时，又不希望两个Pod在同一个Node上运行。在随着扩大Pod的规模，副本数扩展到到15个时，这时候最理想的方式是每个Node运行5个Pod，在这种背景下，用户希望对集群中Zone的安排为相似的副本数量，并且在集群存在部分问题时可以更好的自愈（也是按照相似的副本数量均匀的分布在Node上）。在这种情况下Kubernetes 提供了Pod 拓扑约束来解决这个问题。\n定义一个Topology yaml 1 2 3 4 5 6 7 8 9 10 11 12 apiVersion: v1 kind: Pod metadata: name: example-pod spec: # Configure a topology spread constraint topologySpreadConstraints: - maxSkew: # minDomains: # optional; alpha since v1.24 topologyKey: whenUnsatisfiable: labelSelector: 参数的描述：\nmaxSkew：Required，Pod分布不均的程度，并且数字必须大于零 当 whenUnsatisfiable: DoNotSchedule，则定义目标拓扑中匹配 pod 的数量与 全局最小值（拓扑域中的标签选择器匹配的 pod 的最小数量 ）maxSkew之间的最大允许差异。例如有 3 个 Zone，分别具有 2、4 和 5 个匹配的 pod，则全局最小值为 2 当 whenUnsatisfiable: ScheduleAnyway，scheduler 会为减少倾斜的拓扑提供更高的优先级。 minDomains：optional，符合条件的域的最小数量。 如果不指定该选项 minDomains，则约束的行为 minDomains: 1 。 minDomains必须大于 0。minDomains与 whenUnsatisfiable 一起时为whenUnsatisfiable: DoNotSchedule。 topologyKey：Node label的key，如果多个Node都使用了这个lable key那么 scheduler 将这些 Node 看作为相同的拓扑域。 whenUnsatisfiable：当 Pod 不满足分布的约束时，怎么去处理 DoNotSchedule（默认）不要调度。 ScheduleAnyway仍然调度它，同时优先考虑最小化倾斜节点 labelSelector：查找匹配的 Pod label选择器的node进行技术，以计算Pod如何分布在拓扑域中 对于拓扑域的理解 对于拓扑域，官方是这么说明的，假设有一个带有以下lable的 4 节点集群：\nbash 1 2 3 4 5 NAME STATUS ROLES AGE VERSION LABELS node1 Ready 4m26s v1.16.0 node=node1,zone=zoneA node2 Ready 3m58s v1.16.0 node=node2,zone=zoneA node3 Ready 3m17s v1.16.0 node=node3,zone=zoneB node4 Ready 2m43s v1.16.0 node=node4,zone=zoneB 那么集群拓扑如图：\n图1：集群拓扑图 Source：https://kubernetes.io/docs/concepts/scheduling-eviction/topology-spread-constraints/ 假设一个 4 节点集群，其中 3个label被标记为foo: bar的 Pod 分别位于Node1、Node2 和 Node3：\n图2：集群拓扑图 Source：https://kubernetes.io/docs/concepts/scheduling-eviction/topology-spread-constraints/ 这种情况下，新部署一个Pod，并希望新Pod与现有Pod跨 Zone均匀分布，资源清单文件如下：\nyaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 kind: Pod apiVersion: v1 metadata: name: mypod labels: foo: bar spec: topologySpreadConstraints: - maxSkew: 1 topologyKey: zone whenUnsatisfiable: DoNotSchedule labelSelector: matchLabels: foo: bar containers: - name: pause image: k8s.gcr.io/pause:3.1 这个清单对于拓扑域来说，topologyKey: zone 表示对Pod均匀分布仅应用于已标记的节点（如 foo: bar），将会跳过没有标签的节点（如zone: ）。如果 scheduler 找不到满足约束的方法，whenUnsatisfiable: DoNotSchedule 设置的策略则是 scheduler 对新部署的Pod保持 Pendding\n如果此时 scheduler 将新Pod 调度至 $Zone_A$，此时Pod分布在拓扑域间为 $[3,1]$ ，而 maxSkew 配置的值是1。此时倾斜值为 $Zone_A - Zone_B = 3-1=2$，不满足 maxSkew=1，故这个Pod只能被调度到 $Zone_B$。\n此时Pod调度拓扑图为图3或图4\n图3：集群拓扑图 Source：https://kubernetes.io/docs/concepts/scheduling-eviction/topology-spread-constraints/ 图4：集群拓扑图 Source：https://kubernetes.io/docs/concepts/scheduling-eviction/topology-spread-constraints/ 如果需要将Pod调度到 $Zone_A$ ,可以按照如下方式进行：\n修改 maxSkew=2 修改 topologyKey: node 而不是 Zone ，这种模式下可以将 Pod 均匀分布在Node而不是Zone之间。 修改 whenUnsatisfiable: DoNotSchedule 为 whenUnsatisfiable: ScheduleAnyway 确保新的Pod始终可被调度 下面再通过一个例子增强对拓扑域了解\n多拓扑约束\n设拥有一个 4 节点集群，其中 3 个现有 Pod 标记 foo: bar 分别位于 node1、node2 和 node3\n图5：集群拓扑图 Source：https://kubernetes.io/docs/concepts/scheduling-eviction/topology-spread-constraints/ 部署的资源清单如下：可以看出拓扑分布约束配置了多个\nyaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 kind: Pod apiVersion: v1 metadata: name: mypod labels: foo: bar spec: topologySpreadConstraints: - maxSkew: 1 topologyKey: zone whenUnsatisfiable: DoNotSchedule labelSelector: matchLabels: foo: bar - maxSkew: 1 topologyKey: node whenUnsatisfiable: DoNotSchedule labelSelector: matchLabels: foo: bar containers: - name: pause image: k8s.gcr.io/pause:3.1 在这种情况下，为了匹配第一个约束条件，新Pod 只能放置在 $Zone_B$ ；而就第二个约束条件，新Pod只能调度到 node4。在这种配置多约束条件下， scheduler 只考虑满足所有约束的值，因此唯一有效的是 node4。\n如何为集群设置一个默认拓扑域约束 默认情况下，拓扑域约束也作 scheduler 的为 scheduler configurtion 中的一部分参数，这也意味着，可以通过profile为整个集群级别指定一个默认的拓扑域调度约束，\nyaml 1 2 3 4 5 6 7 8 9 10 11 12 13 apiVersion: kubescheduler.config.k8s.io/v1beta3 kind: KubeSchedulerConfiguration profiles: - schedulerName: default-scheduler pluginConfig: - name: PodTopologySpread args: defaultConstraints: - maxSkew: 1 topologyKey: topology.kubernetes.io/zone whenUnsatisfiable: ScheduleAnyway defaultingType: List 默认约束策略 如果在没有配置集群级别的约束策略时，kube-scheduler 内部 topologyspread 插件提供了一个默认的拓扑约束策略，大致上如下列清单所示\ntext 1 2 3 4 5 6 7 defaultConstraints: - maxSkew: 3 topologyKey: \"kubernetes.io/hostname\" whenUnsatisfiable: ScheduleAnyway - maxSkew: 5 topologyKey: \"topology.kubernetes.io/zone\" whenUnsatisfiable: ScheduleAnyway 上述清单中内容可以在 pkg\\scheduler\\framework\\plugins\\podtopologyspread\\plugin.go\ngo 1 2 3 4 5 6 7 8 9 10 11 12 var systemDefaultConstraints = []v1.TopologySpreadConstraint{ { TopologyKey: v1.LabelHostname, WhenUnsatisfiable: v1.ScheduleAnyway, MaxSkew: 3, }, { TopologyKey: v1.LabelTopologyZone, WhenUnsatisfiable: v1.ScheduleAnyway, MaxSkew: 5, }, } 可以通过在配置文件中留空，来禁用默认配置\ndefaultConstraints: [] defaultingType: List yaml 1 2 3 4 5 6 7 8 9 10 apiVersion: kubescheduler.config.k8s.io/v1beta3 kind: KubeSchedulerConfiguration profiles: - schedulerName: default-scheduler pluginConfig: - name: PodTopologySpread args: defaultConstraints: [] defaultingType: List 通过源码学习Topology podtopologyspread 实现了4种扩展点方法，包含 filter 和 score\nPreFilter 可以看到 PreFilter 的核心为 calPreFilterState\ngo 1 2 3 4 5 6 7 8 func (pl *PodTopologySpread) PreFilter(ctx context.Context, cycleState *framework.CycleState, pod *v1.Pod) (*framework.PreFilterResult, *framework.Status) { s, err := pl.calPreFilterState(ctx, pod) if err != nil { return nil, framework.AsStatus(err) } cycleState.Write(preFilterStateKey, s) return nil, nil } calPreFilterState 主要功能是用在计算如何在拓扑域中分布Pod，首先看段代码时，需要掌握下属几个概念\npreFilterState criticalPaths update go 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 func (pl *PodTopologySpread) calPreFilterState(ctx context.Context, pod *v1.Pod) (*preFilterState, error) { // 获取Node allNodes, err := pl.sharedLister.NodeInfos().List() if err != nil { return nil, fmt.Errorf(\"listing NodeInfos: %w\", err) } var constraints []topologySpreadConstraint if len(pod.Spec.TopologySpreadConstraints) \u003e 0 { // 这里会构建出TopologySpreadConstraints，因为约束是不确定的 constraints, err = filterTopologySpreadConstraints( pod.Spec.TopologySpreadConstraints, v1.DoNotSchedule, pl.enableMinDomainsInPodTopologySpread, pl.enableNodeInclusionPolicyInPodTopologySpread, ) if err != nil { return nil, fmt.Errorf(\"obtaining pod's hard topology spread constraints: %w\", err) } } else { // buildDefaultConstraints使用\".DefaultConstraints\"与pod匹配的 // service、replication controllers、replica sets // 和stateful sets的选择器为pod构建一个约束。 constraints, err = pl.buildDefaultConstraints(pod, v1.DoNotSchedule) if err != nil { return nil, fmt.Errorf(\"setting default hard topology spread constraints: %w\", err) } } if len(constraints) == 0 { // 如果是空的，则返回空preFilterState return \u0026preFilterState{}, nil } // 初始化一个 preFilterState 状态 s := preFilterState{ Constraints: constraints, TpKeyToCriticalPaths: make(map[string]*criticalPaths, len(constraints)), TpPairToMatchNum: make(map[topologyPair]int, sizeHeuristic(len(allNodes), constraints)), } // 根据node统计拓扑域数量 tpCountsByNode := make([]map[topologyPair]int, len(allNodes)) // 获取pod亲和度配置 requiredNodeAffinity := nodeaffinity.GetRequiredNodeAffinity(pod) processNode := func(i int) { nodeInfo := allNodes[i] node := nodeInfo.Node() if node == nil { klog.ErrorS(nil, \"Node not found\") return } // 通过spreading去过滤node以用作filters，错误解析以向后兼容 if !pl.enableNodeInclusionPolicyInPodTopologySpread { if match, _ := requiredNodeAffinity.Match(node); !match { return } } // 确保node的lable 包含topologyKeys定义的值 if !nodeLabelsMatchSpreadConstraints(node.Labels, constraints) { return } tpCounts := make(map[topologyPair]int, len(constraints)) for _, c := range constraints { // 对应的约束列表 if pl.enableNodeInclusionPolicyInPodTopologySpread \u0026\u0026 !c.matchNodeInclusionPolicies(pod, node, requiredNodeAffinity) { continue } // 构建出 topologyPair 以key value形式， // 通常情况下TopologyKey属于什么类型的拓扑 // node.Labels[c.TopologyKey] 则是属于这个拓扑中那个子域 pair := topologyPair{key: c.TopologyKey, value: node.Labels[c.TopologyKey]} // 计算与标签选择器相匹配的pod有多少个 count := countPodsMatchSelector(nodeInfo.Pods, c.Selector, pod.Namespace) tpCounts[pair] = count } tpCountsByNode[i] = tpCounts // 最终形成的拓扑结构 } // 执行上面的定义的processNode，执行的数量就是node的数量 pl.parallelizer.Until(ctx, len(allNodes), processNode) // 最后构建出 TpPairToMatchNum // 表示每个拓扑域中的每个子域各分布多少Pod，如图6所示 for _, tpCounts := range tpCountsByNode { for tp, count := range tpCounts { s.TpPairToMatchNum[tp] += count } } if pl.enableMinDomainsInPodTopologySpread { // 根据状态进行构建 preFilterState s.TpKeyToDomainsNum = make(map[string]int, len(constraints)) for tp := range s.TpPairToMatchNum { s.TpKeyToDomainsNum[tp.key]++ } } // 计算最小匹配出的拓扑对 for i := 0; i \u003c len(constraints); i++ { key := constraints[i].TopologyKey s.TpKeyToCriticalPaths[key] = newCriticalPaths() } for pair, num := range s.TpPairToMatchNum { s.TpKeyToCriticalPaths[pair.key].update(pair.value, num) } return \u0026s, nil // 返回的值则包含最小的分布 } preFilterState\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 // preFilterState 是在PreFilter处计算并在Filter处使用。 // 它结合了 “TpKeyToCriticalPaths” 和 “TpPairToMatchNum” 来表示： //（1）在每个分布约束上匹配最少pod的criticalPaths。 // (2) 在每个分布约束上匹配的pod的数量。 // “nil preFilterState” 则表示没有设置（在PreFilter阶段）； // empty “preFilterState”对象则表示它是一个合法的状态，并在PreFilter阶段设置。 type preFilterState struct { Constraints []topologySpreadConstraint // 这里记录2条关键路径而不是所有关键路径。 // criticalPaths[0].MatchNum 始终保存最小匹配数。 // criticalPaths[1].MatchNum 总是大于或等于criticalPaths[0].MatchNum，但不能保证是第二个最小匹配数。 TpKeyToCriticalPaths map[string]*criticalPaths // TpKeyToDomainsNum 以 “topologyKey” 作为key ，并以zone的数量作为值。 TpKeyToDomainsNum map[string]int // TpPairToMatchNum 以 “topologyPair作为key” ，并以匹配到pod的数量作为value。 TpPairToMatchNum map[topologyPair]int } criticalPaths\ngo 1 2 3 4 5 6 7 8 9 // [2]criticalPath能够工作的原因是基于当前抢占算法的实现，特别是以下两个事实 // 事实 1：只抢占同一节点上的Pod，而不是多个节点上的 Pod。 // 事实 2：每个节点在其抢占周期期间在“preFilterState”的单独副本上进行评估。如果我们计划转向更复杂的算法，例如“多个节点上的任意pod”时则需要重新考虑这种结构。 type criticalPaths [2]struct { // TopologyValue代表映射到拓扑键的拓扑值。 TopologyValue string // MatchNum代表匹配到的pod数量 MatchNum int } 单元测试中的测试案例，具有两个约束条件的场景，通过表格来解析如下：\nNode列表与标签如下表：\nNode Name 🏷️Lable-zone 🏷️Lable-node node-a zone1 node-a node-b zone1 node-b node-x zone2 node-x node-y zone2 node-y Pod列表与标签如下表：\nPod Name Node 🏷️Label p-a1 node-a foo: p-a2 node-a foo: p-b1 node-b foo: p-y1 node-y foo: p-y2 node-y foo: p-y3 node-y foo: p-y4 node-y foo: 对应的拓扑约束\nyaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 spec: topologySpreadConstraints: - MaxSkew: 1 TopologyKey: zone labelSelector: matchLabels: foo: bar MinDomains: 1 NodeAffinityPolicy: Honor NodeTaintsPolicy: Ignore - MaxSkew: 1 TopologyKey: node labelSelector: matchLabels: foo: bar MinDomains: 1 NodeAffinityPolicy: Honor NodeTaintsPolicy: Ignore 那么整个分布如下：\n图6：具有两个场景的分布图 实现的测试代码如下\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 ... { name: \"normal case with two spreadConstraints\", pod: st.MakePod().Name(\"p\").Label(\"foo\", \"\"). SpreadConstraint(1, \"zone\", v1.DoNotSchedule, fooSelector, nil, nil, nil). SpreadConstraint(1, \"node\", v1.DoNotSchedule, fooSelector, nil, nil, nil). Obj(), nodes: []*v1.Node{ st.MakeNode().Name(\"node-a\").Label(\"zone\", \"zone1\").Label(\"node\", \"node-a\").Obj(), st.MakeNode().Name(\"node-b\").Label(\"zone\", \"zone1\").Label(\"node\", \"node-b\").Obj(), st.MakeNode().Name(\"node-x\").Label(\"zone\", \"zone2\").Label(\"node\", \"node-x\").Obj(), st.MakeNode().Name(\"node-y\").Label(\"zone\", \"zone2\").Label(\"node\", \"node-y\").Obj(), }, existingPods: []*v1.Pod{ st.MakePod().Name(\"p-a1\").Node(\"node-a\").Label(\"foo\", \"\").Obj(), st.MakePod().Name(\"p-a2\").Node(\"node-a\").Label(\"foo\", \"\").Obj(), st.MakePod().Name(\"p-b1\").Node(\"node-b\").Label(\"foo\", \"\").Obj(), st.MakePod().Name(\"p-y1\").Node(\"node-y\").Label(\"foo\", \"\").Obj(), st.MakePod().Name(\"p-y2\").Node(\"node-y\").Label(\"foo\", \"\").Obj(), st.MakePod().Name(\"p-y3\").Node(\"node-y\").Label(\"foo\", \"\").Obj(), st.MakePod().Name(\"p-y4\").Node(\"node-y\").Label(\"foo\", \"\").Obj(), }, want: \u0026preFilterState{ Constraints: []topologySpreadConstraint{ { MaxSkew: 1, TopologyKey: \"zone\", Selector: mustConvertLabelSelectorAsSelector(t, fooSelector), MinDomains: 1, NodeAffinityPolicy: v1.NodeInclusionPolicyHonor, NodeTaintsPolicy: v1.NodeInclusionPolicyIgnore, }, { MaxSkew: 1, TopologyKey: \"node\", Selector: mustConvertLabelSelectorAsSelector(t, fooSelector), MinDomains: 1, NodeAffinityPolicy: v1.NodeInclusionPolicyHonor, NodeTaintsPolicy: v1.NodeInclusionPolicyIgnore, }, }, TpKeyToCriticalPaths: map[string]*criticalPaths{ \"zone\": {{\"zone1\", 3}, {\"zone2\", 4}}, \"node\": {{\"node-x\", 0}, {\"node-b\", 1}}, }, for pair, num := range s.TpPairToMatchNum { s.TpKeyToCriticalPaths[pair.key].update(pair.value, num) } TpPairToMatchNum: map[topologyPair]int{ {key: \"zone\", value: \"zone1\"}: 3, {key: \"zone\", value: \"zone2\"}: 4, {key: \"node\", value: \"node-a\"}: 2, {key: \"node\", value: \"node-b\"}: 1, {key: \"node\", value: \"node-x\"}: 0, {key: \"node\", value: \"node-y\"}: 4, }, }, } ... update\nupdate 函数实际上时用于计算 criticalPaths 中的第一位始终保持为是一个最小Pod匹配值\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 func (p *criticalPaths) update(tpVal string, num int) { // first verify if `tpVal` exists or not i := -1 if tpVal == p[0].TopologyValue { i = 0 } else if tpVal == p[1].TopologyValue { i = 1 } if i \u003e= 0 { // `tpVal` 表示已经存在 p[i].MatchNum = num if p[0].MatchNum \u003e p[1].MatchNum { // swap paths[0] and paths[1] p[0], p[1] = p[1], p[0] } } else { // `tpVal` 表示不存在，如一个新初始化的值 // num对应子域分布的pod // 说明第一个元素不是最小的，则作为交换 if num \u003c p[0].MatchNum { // update paths[1] with paths[0] p[1] = p[0] // update paths[0] p[0].TopologyValue, p[0].MatchNum = tpVal, num } else if num \u003c p[1].MatchNum { // 如果小于 paths[1]，则更新它，永远保证元素0是最小，1是次小的 p[1].TopologyValue, p[1].MatchNum = tpVal, num } } } 综合来讲 Prefilter 主要做的工作是。循环所有的节点，先根据 NodeAffinity 或者 NodeSelector 进行过滤，然后根据约束中定义的 topologyKeys （拓扑划分的依据） 来选择节点。\n接下来会计算出每个拓扑域下的拓扑对（可以理解为子域）匹配的 Pod 数量，存入 TpPairToMatchNum 中，最后就是要把所有约束中匹配的 Pod 数量最小（第二小）匹配出来的路径（代码是这么定义的，理解上可以看作是分布图）放入 TpKeyToCriticalPaths 中保存起来。整个 preFilterState 保存下来传递到后续的 filter 插件中使用。\nFilter 在 preFilter 中 最后的计算结果会保存在 CycleState 中\ngo 1 cycleState.Write(preFilterStateKey, s) Filter 主要是从 PreFilter 处理的过程中拿到状态 preFilterState，然后看下每个拓扑约束中的 MaxSkew 是否合法，具体的计算公式为：$matchNum + selfMatchNum - minMatchNum$\nmatchNum：Prefilter 中计算出的对应的拓扑分布数量，可以在Prefilter中参考对应的内容 if tpCount, ok := s.TpPairToMatchNum[pair]; ok { selfMatchNum：匹配到label的数量，匹配到则是1，否则为0 minMatchNum：获的 Prefilter 中计算出来的最小匹配的值 go 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 func (pl *PodTopologySpread) Filter(ctx context.Context, cycleState *framework.CycleState, pod *v1.Pod, nodeInfo *framework.NodeInfo) *framework.Status { node := nodeInfo.Node() if node == nil { return framework.AsStatus(fmt.Errorf(\"node not found\")) } // 拿到 prefilter处理的s，即preFilterState s, err := getPreFilterState(cycleState) if err != nil { return framework.AsStatus(err) } // 一个 空类型的 preFilterState是合法的，这种情况下将容忍每一个被调度的 Pod if len(s.Constraints) == 0 { return nil } podLabelSet := labels.Set(pod.Labels) // 设置标签 for _, c := range s.Constraints { // 因为拓扑约束允许多个所以 tpKey := c.TopologyKey tpVal, ok := node.Labels[c.TopologyKey] if !ok { klog.V(5).InfoS(\"Node doesn't have required label\", \"node\", klog.KObj(node), \"label\", tpKey) return framework.NewStatus(framework.UnschedulableAndUnresolvable, ErrReasonNodeLabelNotMatch) } // 判断标准 // 现有的匹配数量 + 子匹配（1|0） - 全局minimum \u003c= maxSkew minMatchNum, err := s.minMatchNum(tpKey, c.MinDomains, pl.enableMinDomainsInPodTopologySpread) if err != nil { klog.ErrorS(err, \"Internal error occurred while retrieving value precalculated in PreFilter\", \"topologyKey\", tpKey, \"paths\", s.TpKeyToCriticalPaths) continue } selfMatchNum := 0 if c.Selector.Matches(podLabelSet) { selfMatchNum = 1 } pair := topologyPair{key: tpKey, value: tpVal} matchNum := 0 if tpCount, ok := s.TpPairToMatchNum[pair]; ok { matchNum = tpCount } skew := matchNum + selfMatchNum - minMatchNum if skew \u003e int(c.MaxSkew) { klog.V(5).InfoS(\"Node failed spreadConstraint: matchNum + selfMatchNum - minMatchNum \u003e maxSkew\", \"node\", klog.KObj(node), \"topologyKey\", tpKey, \"matchNum\", matchNum, \"selfMatchNum\", selfMatchNum, \"minMatchNum\", minMatchNum, \"maxSkew\", c.MaxSkew) return framework.NewStatus(framework.Unschedulable, ErrReasonConstraintsNotMatch) } } return nil } minMatchNum\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 // minMatchNum用于计算 倾斜的全局最小值，同时考虑 MinDomains。 func (s *preFilterState) minMatchNum(tpKey string, minDomains int32, enableMinDomainsInPodTopologySpread bool) (int, error) { paths, ok := s.TpKeyToCriticalPaths[tpKey] if !ok { return 0, fmt.Errorf(\"failed to retrieve path by topology key\") } // 通常来说最小值是第一个 minMatchNum := paths[0].MatchNum if !enableMinDomainsInPodTopologySpread { // 就是plugin的配置的 enableMinDomainsInPodTopologySpread return minMatchNum, nil } domainsNum, ok := s.TpKeyToDomainsNum[tpKey] if !ok { return 0, fmt.Errorf(\"failed to retrieve the number of domains by topology key\") } if domainsNum \u003c int(minDomains) { // 当有匹配拓扑键的符合条件的域的数量小于 配置的\"minDomains\"(每个约束条件的这个配置) 时， //它将全局“minimum” 设置为0。 // 因为minimum默认就为1，如果他小于1，就让他为0 minMatchNum = 0 } return minMatchNum, nil } PreScore 与 Filter 类似， PreScore 也是类似 PreFilter 的构成。 initPreScoreState 来完成过滤。\n有了 PreFilter 基础后，对于 Score 来说大同小异\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 func (pl *PodTopologySpread) PreScore( ctx context.Context, cycleState *framework.CycleState, pod *v1.Pod, filteredNodes []*v1.Node, ) *framework.Status { allNodes, err := pl.sharedLister.NodeInfos().List() if err != nil { return framework.AsStatus(fmt.Errorf(\"getting all nodes: %w\", err)) } if len(filteredNodes) == 0 || len(allNodes) == 0 { // No nodes to score. return nil } state := \u0026preScoreState{ IgnoredNodes: sets.NewString(), TopologyPairToPodCounts: make(map[topologyPair]*int64), } // Only require that nodes have all the topology labels if using // non-system-default spreading rules. This allows nodes that don't have a // zone label to still have hostname spreading. // 如果使用非系统默认分布规则，则仅要求节点具有所有拓扑标签。 // 这将允许没有zone标签的节点仍然具有hostname分布。 requireAllTopologies := len(pod.Spec.TopologySpreadConstraints) \u003e 0 || !pl.systemDefaulted err = pl.initPreScoreState(state, pod, filteredNodes, requireAllTopologies) if err != nil { return framework.AsStatus(fmt.Errorf(\"calculating preScoreState: %w\", err)) } // return if incoming pod doesn't have soft topology spread Constraints. if len(state.Constraints) == 0 { cycleState.Write(preScoreStateKey, state) return nil } // Ignore parsing errors for backwards compatibility. requiredNodeAffinity := nodeaffinity.GetRequiredNodeAffinity(pod) processAllNode := func(i int) { nodeInfo := allNodes[i] node := nodeInfo.Node() if node == nil { return } if !pl.enableNodeInclusionPolicyInPodTopologySpread { // `node` should satisfy incoming pod's NodeSelector/NodeAffinity if match, _ := requiredNodeAffinity.Match(node); !match { return } } // All topologyKeys need to be present in `node` if requireAllTopologies \u0026\u0026 !nodeLabelsMatchSpreadConstraints(node.Labels, state.Constraints) { return } for _, c := range state.Constraints { if pl.enableNodeInclusionPolicyInPodTopologySpread \u0026\u0026 !c.matchNodeInclusionPolicies(pod, node, requiredNodeAffinity) { continue } pair := topologyPair{key: c.TopologyKey, value: node.Labels[c.TopologyKey]} // If current topology pair is not associated with any candidate node, // continue to avoid unnecessary calculation. // Per-node counts are also skipped, as they are done during Score. tpCount := state.TopologyPairToPodCounts[pair] if tpCount == nil { continue } count := countPodsMatchSelector(nodeInfo.Pods, c.Selector, pod.Namespace) atomic.AddInt64(tpCount, int64(count)) } } pl.parallelizer.Until(ctx, len(allNodes), processAllNode) // 保存状态给后面sorce调用 cycleState.Write(preScoreStateKey, state) return nil } 与Filter中Update使用的函数一样，这里也会到这一步，这里会构建出TopologySpreadConstraints，因为约束是不确定的\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 func filterTopologySpreadConstraints(constraints []v1.TopologySpreadConstraint, action v1.UnsatisfiableConstraintAction, enableMinDomainsInPodTopologySpread, enableNodeInclusionPolicyInPodTopologySpread bool) ([]topologySpreadConstraint, error) { var result []topologySpreadConstraint for _, c := range constraints { if c.WhenUnsatisfiable == action { // 始终调度时 selector, err := metav1.LabelSelectorAsSelector(c.LabelSelector) if err != nil { return nil, err } tsc := topologySpreadConstraint{ MaxSkew: c.MaxSkew, TopologyKey: c.TopologyKey, Selector: selector, MinDomains: 1, // If MinDomains is nil, we treat MinDomains as 1. NodeAffinityPolicy: v1.NodeInclusionPolicyHonor, // If NodeAffinityPolicy is nil, we treat NodeAffinityPolicy as \"Honor\". NodeTaintsPolicy: v1.NodeInclusionPolicyIgnore, // If NodeTaintsPolicy is nil, we treat NodeTaintsPolicy as \"Ignore\". } if enableMinDomainsInPodTopologySpread \u0026\u0026 c.MinDomains != nil { tsc.MinDomains = *c.MinDomains } if enableNodeInclusionPolicyInPodTopologySpread { if c.NodeAffinityPolicy != nil { tsc.NodeAffinityPolicy = *c.NodeAffinityPolicy } if c.NodeTaintsPolicy != nil { tsc.NodeTaintsPolicy = *c.NodeTaintsPolicy } } result = append(result, tsc) } } return result, nil } Score GO 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 // 在分数扩展点调用分数。该函数返回的“score”是 `nodeName` 上匹配的 pod 数量，稍后会进行归一化。 func (pl *PodTopologySpread) Score(ctx context.Context, cycleState *framework.CycleState, pod *v1.Pod, nodeName string) (int64, *framework.Status) { nodeInfo, err := pl.sharedLister.NodeInfos().Get(nodeName) if err != nil { return 0, framework.AsStatus(fmt.Errorf(\"getting node %q from Snapshot: %w\", nodeName, err)) } node := nodeInfo.Node() s, err := getPreScoreState(cycleState) if err != nil { return 0, framework.AsStatus(err) } // Return if the node is not qualified. if s.IgnoredNodes.Has(node.Name) { return 0, nil } // 对于每个当前的 ，当前节点获得 的信用分。 // 计算 总和 并将其作为该节点的分数返回。 var score float64 for i, c := range s.Constraints { if tpVal, ok := node.Labels[c.TopologyKey]; ok { var cnt int64 if c.TopologyKey == v1.LabelHostname { cnt = int64(countPodsMatchSelector(nodeInfo.Pods, c.Selector, pod.Namespace)) } else { pair := topologyPair{key: c.TopologyKey, value: tpVal} cnt = *s.TopologyPairToPodCounts[pair] } score += scoreForCount(cnt, c.MaxSkew, s.TopologyNormalizingWeight[i]) } } return int64(math.Round(score)), nil } 在 Framework 中会运行 ScoreExtension ，即 NormalizeScore\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 // Run NormalizeScore method for each ScorePlugin in parallel. f.Parallelizer().Until(ctx, len(f.scorePlugins), func(index int) { pl := f.scorePlugins[index] nodeScoreList := pluginToNodeScores[pl.Name()] if pl.ScoreExtensions() == nil { return } status := f.runScoreExtension(ctx, pl, state, pod, nodeScoreList) if !status.IsSuccess() { err := fmt.Errorf(\"plugin %q failed with: %w\", pl.Name(), status.AsError()) errCh.SendErrorWithCancel(err, cancel) return } }) if err := errCh.ReceiveError(); err != nil { return nil, framework.AsStatus(fmt.Errorf(\"running Normalize on Score plugins: %w\", err)) } NormalizeScore 会为所有的node根据之前计算出的权重进行打分\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 func (pl *PodTopologySpread) NormalizeScore(ctx context.Context, cycleState *framework.CycleState, pod *v1.Pod, scores framework.NodeScoreList) *framework.Status { s, err := getPreScoreState(cycleState) if err != nil { return framework.AsStatus(err) } if s == nil { return nil } // 计算 和 var minScore int64 = math.MaxInt64 var maxScore int64 for i, score := range scores { // it's mandatory to check if is present in m.IgnoredNodes if s.IgnoredNodes.Has(score.Name) { scores[i].Score = invalidScore continue } if score.Score \u003c minScore { minScore = score.Score } if score.Score \u003e maxScore { maxScore = score.Score } } for i := range scores { if scores[i].Score == invalidScore { scores[i].Score = 0 continue } if maxScore == 0 { scores[i].Score = framework.MaxNodeScore continue } s := scores[i].Score scores[i].Score = framework.MaxNodeScore * (maxScore + minScore - s) / maxScore } return nil } 到此，对于pod拓扑插件功能大概可以明了了，\nFilter 部分（PreFilter，Filter）完成拓扑对(Topology Pair)划分 Score部分（PreScore, Score , NormalizeScore ）主要是对拓扑对（可以理解为拓扑结构划分）来选择一个最适合的pod的节点（即分数最优的节点） 而在 scoring_test.go 给了很多用例，可以更深入的了解这部分算法\nReference [1] scheduling code hierarchy\n[2] scheduler algorithm\n[3] in tree VS out of tree volume plugins\n[4] scheduler_framework_plugins\n[5] scheduling config\n[6] topology spread constraints\n","wordCount":"5303","inLanguage":"zh","datePublished":"2022-07-27T00:00:00Z","dateModified":"0001-01-01T00:00:00Z","author":{"@type":"Person","name":"cylon"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.oomkill.com/2022/07/ch21-scheduling-algorithm/"},"publisher":{"@type":"Organization","name":"Cylon's Collection","logo":{"@type":"ImageObject","url":"https://www.oomkill.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.oomkill.com/><img src=https://www.oomkill.com/favicon.ico alt aria-label=logo height=20>Cylon's Collection</a><div class=logo-switches><button id=theme-toggle><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://www.oomkill.com/archives><span>归档</span></a></li><li><a href=https://www.oomkill.com/tags><span>标签</span></a></li><li><a href=https://www.oomkill.com/search><span>搜索</span></a></li><li><a href=https://www.oomkill.com/about accesskey=/><span>关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">如何理解kubernetes调度框架与插件？</h1><div class=post-meta><span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar" style="user-select:text"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" style="user-select:text"/><line x1="16" y1="2" x2="16" y2="6" style="user-select:text"/><line x1="8" y1="2" x2="8" y2="6" style="user-select:text"/><line x1="3" y1="10" x2="21" y2="10" style="user-select:text"/></svg><span>2022-07-27</span></span>&nbsp;·&nbsp;<span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text" style="user-select:text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z" style="user-select:text"/><polyline points="14 2 14 8 20 8" style="user-select:text"/><line x1="16" y1="13" x2="8" y2="13" style="user-select:text"/><line x1="16" y1="17" x2="8" y2="17" style="user-select:text"/><polyline points="10 9 9 9 8 9" style="user-select:text"/></svg><span>5303 字</span></span>&nbsp;·&nbsp;<span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><span>25 分钟</span></span>
<span class=pe-post-meta-item>&nbsp;·&nbsp;<svg t="1714036239378" fill="currentcolor" class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="6659" width="256" height="256"><path d="M690 78.2c-18.6-18.8-49-19-67.8-.4s-19 49-.4 67.8l255.4 258.6c67.8 68.6 67.8 178.8.0 247.4L653.4 878.2c-18.6 18.8-18.4 49.2.4 67.8s49.2 18.4 67.8-.4l224-226.4c104.8-106 104.8-276.4.0-382.4L690 78.2zM485.4 101.4c-24-24-56.6-37.4-90.6-37.4H96C43 64 0 107 0 160v299c0 34 13.4 66.6 37.4 90.6l336 336c50 50 131 50 181 0l267-267c50-50 50-131 0-181l-336-336zM96 160h299c8.4.0 16.6 3.4 22.6 9.4l336 336c12.4 12.4 12.4 32.8.0 45.2l-267 267c-12.4 12.4-32.8 12.4-45.2.0l-336-336c-6-6-9.4-14.2-9.4-22.6V160zm192 128a64 64 0 10-128 0 64 64 0 10128 0z" p-id="6660"/></svg></span><ul class=pe-post-meta-item><a href=https://www.oomkill.com/tags/kubernetes-develop/>#Kubernetes Develop</a>
<a href=https://www.oomkill.com/tags/kubernetes/>#Kubernetes</a></ul></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details><summary><span class=details>目录</span></summary><div class=inner><ul><li><a href=#%e8%b0%83%e5%ba%a6%e6%a1%86%e6%9e%b6-supa-href11asup aria-label="调度框架 [1]">调度框架 <sup><a href=#1>[1]</a></sup></a><li><a href=#%e6%8f%92%e4%bb%b6-supa-href44asup aria-label="插件 [4]">插件 <sup><a href=#4>[4]</a></sup></a><ul><li><a href=#%e6%8f%92%e4%bb%b6%e7%9a%84%e8%bd%bd%e5%85%a5%e8%bf%87%e7%a8%8b aria-label=插件的载入过程>插件的载入过程</a><ul><li><a href=#newscheduler aria-label=NewScheduler>NewScheduler</a><li><a href=#profilenewmap aria-label=profile.NewMap>profile.NewMap</a><li><a href=#newframework aria-label=NewFramework>NewFramework</a></ul><li><a href=#%e6%8f%92%e4%bb%b6%e7%9a%84%e6%89%a7%e8%a1%8c aria-label=插件的执行>插件的执行</a><ul><li><a href=#nodeports aria-label=NodePorts>NodePorts</a><li><a href=#noderesourcesfit--supa-href55asup aria-label="NodeResourcesFit [5]">NodeResourcesFit <sup><a href=#5>[5]</a></sup></a><li><a href=#fit aria-label=Fit>Fit</a><li><a href=#leastallocate aria-label=leastAllocate>leastAllocate</a></ul><li><a href=#topology-supa-href66asup aria-label="Topology [6]">Topology <sup><a href=#6>[6]</a></sup></a><ul><li><a href=#concept aria-label=Concept>Concept</a><li><a href=#%e5%ae%9a%e4%b9%89%e4%b8%80%e4%b8%aatopology aria-label=定义一个Topology>定义一个Topology</a><li><a href=#%e5%af%b9%e4%ba%8e%e6%8b%93%e6%89%91%e5%9f%9f%e7%9a%84%e7%90%86%e8%a7%a3 aria-label=对于拓扑域的理解>对于拓扑域的理解</a><li><a href=#%e5%a6%82%e4%bd%95%e4%b8%ba%e9%9b%86%e7%be%a4%e8%ae%be%e7%bd%ae%e4%b8%80%e4%b8%aa%e9%bb%98%e8%ae%a4%e6%8b%93%e6%89%91%e5%9f%9f%e7%ba%a6%e6%9d%9f aria-label=如何为集群设置一个默认拓扑域约束>如何为集群设置一个默认拓扑域约束</a><li><a href=#%e9%bb%98%e8%ae%a4%e7%ba%a6%e6%9d%9f%e7%ad%96%e7%95%a5 aria-label=默认约束策略>默认约束策略</a></ul><li><a href=#%e9%80%9a%e8%bf%87%e6%ba%90%e7%a0%81%e5%ad%a6%e4%b9%a0topology aria-label=通过源码学习Topology>通过源码学习Topology</a><ul><li><a href=#prefilter aria-label=PreFilter>PreFilter</a><li><a href=#filter aria-label=Filter>Filter</a><li><a href=#prescore aria-label=PreScore>PreScore</a><li><a href=#score aria-label=Score>Score</a></ul></ul><li><a href=#reference aria-label=Reference>Reference</a></li></div></details></div></aside><script src=/js/pe-toc.min.445eb1bfc5e85dd13b9519fcc2a806522e9629b6224a2974052789ba00ab78af.js integrity="sha256-RF6xv8XoXdE7lRn8wqgGUi6WKbYiSil0BSeJugCreK8="></script><div class=post-content><h2 id=调度框架-supa-href11asup>调度框架 <sup><a href=#1>[1]</a></sup><a hidden class=anchor aria-hidden=true href=#调度框架-supa-href11asup>#</a></h2><p>本文基于 <a href=https://github.com/kubernetes/kubernetes/tree/release-1.24/pkg/scheduler target=_blank rel="noopener nofollow noreferrer">kubernetes 1.24</a> 进行分析</p><p>调度框架（<code>Scheduling Framework</code>）是Kubernetes 的调度器 <code>kube-scheduler</code> 设计的的可插拔架构，将插件（调度算法）嵌入到调度上下文的每个扩展点中，并编译为 <code>kube-scheduler</code></p><p>在 <code>kube-scheduler</code> 1.22 之后，在 <a href=https://github.com/kubernetes/kubernetes/blob/release-1.24/pkg/scheduler/framework/interface.go target=_blank rel="noopener nofollow noreferrer">pkg/scheduler/framework/interface.go</a> 中定义了一个 <a href=https://github.com/kubernetes/kubernetes/blob/32c483ea6ee90a3a81f382563c91034470af8a4a/pkg/scheduler/framework/interface.go#L295-L297 target=_blank rel="noopener nofollow noreferrer">Plugin</a> 的 <em>interface</em>，这个 <em>interface</em> 作为了所有插件的父级。而每个未调度的 Pod，Kubernetes 调度器会根据一组规则尝试在集群中寻找一个节点。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Plugin</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nf>Name</span><span class=p>()</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>下面会对每个算法是如何实现的进行分析</p><p>在初始化 <em>scheduler</em> 时，会创建一个 <code>profile</code>，profile是关于 <em>scheduler</em> 调度配置相关的定义</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>New</span><span class=p>(</span><span class=nx>client</span> <span class=nx>clientset</span><span class=p>.</span><span class=nx>Interface</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl>	<span class=nx>profiles</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>profile</span><span class=p>.</span><span class=nf>NewMap</span><span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>profiles</span><span class=p>,</span> <span class=nx>registry</span><span class=p>,</span> <span class=nx>recorderFactory</span><span class=p>,</span> <span class=nx>stopCh</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>frameworkruntime</span><span class=p>.</span><span class=nf>WithComponentConfigVersion</span><span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>componentConfigVersion</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>frameworkruntime</span><span class=p>.</span><span class=nf>WithClientSet</span><span class=p>(</span><span class=nx>client</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>frameworkruntime</span><span class=p>.</span><span class=nf>WithKubeConfig</span><span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>kubeConfig</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>frameworkruntime</span><span class=p>.</span><span class=nf>WithInformerFactory</span><span class=p>(</span><span class=nx>informerFactory</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>frameworkruntime</span><span class=p>.</span><span class=nf>WithSnapshotSharedLister</span><span class=p>(</span><span class=nx>snapshot</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>frameworkruntime</span><span class=p>.</span><span class=nf>WithPodNominator</span><span class=p>(</span><span class=nx>nominator</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>frameworkruntime</span><span class=p>.</span><span class=nf>WithCaptureProfile</span><span class=p>(</span><span class=nx>frameworkruntime</span><span class=p>.</span><span class=nf>CaptureProfile</span><span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>frameworkCapturer</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>		<span class=nx>frameworkruntime</span><span class=p>.</span><span class=nf>WithClusterEventMap</span><span class=p>(</span><span class=nx>clusterEventMap</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>frameworkruntime</span><span class=p>.</span><span class=nf>WithParallelism</span><span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>parallelism</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>		<span class=nx>frameworkruntime</span><span class=p>.</span><span class=nf>WithExtenders</span><span class=p>(</span><span class=nx>extenders</span><span class=p>),</span>
</span></span><span class=line><span class=cl>	<span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;initializing profiles: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>profiles</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;at least one profile is required&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=o>...</span><span class=p>.</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>关于 <code>profile</code> 的实现，则为 <code>KubeSchedulerProfile</code>，也是作为 yaml生成时传入的配置</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// KubeSchedulerProfile 是一个 scheduling profile.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>KubeSchedulerProfile</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// SchedulerName 是与此配置文件关联的调度程序的名称。
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 如果 SchedulerName 与 pod “spec.schedulerName”匹配，则使用此配置文件调度 pod。
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>SchedulerName</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Plugins指定应该启用或禁用的插件集。
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 启用的插件是除了默认插件之外应该启用的插件。禁用插件应是禁用的任何默认插件。
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 当没有为扩展点指定启用或禁用插件时，将使用该扩展点的默认插件（如果有）。
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 如果指定了 QueueSort 插件，
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 则必须为所有配置文件指定相同的 QueueSort Plugin 和 PluginConfig。
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 这个Plugins展现的形式则是调度上下文中的所有扩展点(这是抽象)，实际中会表现为多个扩展点
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>Plugins</span> <span class=o>*</span><span class=nx>Plugins</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// PluginConfig 是每个插件的一组可选的自定义插件参数。
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 如果省略PluginConfig参数等同于使用该插件的默认配置。
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>PluginConfig</span> <span class=p>[]</span><span class=nx>PluginConfig</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>对于 <code>profile.NewMap</code> 就是根据给定的配置来构建这个framework，因为配置可能是存在多个的。而 <a href=https://github.com/kubernetes/kubernetes/blob/32c483ea6ee90a3a81f382563c91034470af8a4a/pkg/scheduler/framework/runtime/registry.go#L70 target=_blank rel="noopener nofollow noreferrer">Registry</a> 则是所有可用插件的集合，内部构造则是 <a href=https://github.com/kubernetes/kubernetes/blob/32c483ea6ee90a3a81f382563c91034470af8a4a/pkg/scheduler/framework/runtime/registry.go#L30 target=_blank rel="noopener nofollow noreferrer">PluginFactory</a> ,通过函数来构建出对应的 plugin</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>NewMap</span><span class=p>(</span><span class=nx>cfgs</span> <span class=p>[]</span><span class=nx>config</span><span class=p>.</span><span class=nx>KubeSchedulerProfile</span><span class=p>,</span> <span class=nx>r</span> <span class=nx>frameworkruntime</span><span class=p>.</span><span class=nx>Registry</span><span class=p>,</span> <span class=nx>recorderFact</span> <span class=nx>RecorderFactory</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>stopCh</span> <span class=o>&lt;-</span><span class=kd>chan</span> <span class=kd>struct</span><span class=p>{},</span> <span class=nx>opts</span> <span class=o>...</span><span class=nx>frameworkruntime</span><span class=p>.</span><span class=nx>Option</span><span class=p>)</span> <span class=p>(</span><span class=nx>Map</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>m</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=nx>Map</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>v</span> <span class=o>:=</span> <span class=nx>cfgValidator</span><span class=p>{</span><span class=nx>m</span><span class=p>:</span> <span class=nx>m</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>cfg</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>cfgs</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>p</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>newProfile</span><span class=p>(</span><span class=nx>cfg</span><span class=p>,</span> <span class=nx>r</span><span class=p>,</span> <span class=nx>recorderFact</span><span class=p>,</span> <span class=nx>stopCh</span><span class=p>,</span> <span class=nx>opts</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;creating profile for scheduler name %s: %v&#34;</span><span class=p>,</span> <span class=nx>cfg</span><span class=p>.</span><span class=nx>SchedulerName</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>v</span><span class=p>.</span><span class=nf>validate</span><span class=p>(</span><span class=nx>cfg</span><span class=p>,</span> <span class=nx>p</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>m</span><span class=p>[</span><span class=nx>cfg</span><span class=p>.</span><span class=nx>SchedulerName</span><span class=p>]</span> <span class=p>=</span> <span class=nx>p</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>m</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// newProfile 给的配置构建出一个profile
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>newProfile</span><span class=p>(</span><span class=nx>cfg</span> <span class=nx>config</span><span class=p>.</span><span class=nx>KubeSchedulerProfile</span><span class=p>,</span> <span class=nx>r</span> <span class=nx>frameworkruntime</span><span class=p>.</span><span class=nx>Registry</span><span class=p>,</span> <span class=nx>recorderFact</span> <span class=nx>RecorderFactory</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>stopCh</span> <span class=o>&lt;-</span><span class=kd>chan</span> <span class=kd>struct</span><span class=p>{},</span> <span class=nx>opts</span> <span class=o>...</span><span class=nx>frameworkruntime</span><span class=p>.</span><span class=nx>Option</span><span class=p>)</span> <span class=p>(</span><span class=nx>framework</span><span class=p>.</span><span class=nx>Framework</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>recorder</span> <span class=o>:=</span> <span class=nf>recorderFact</span><span class=p>(</span><span class=nx>cfg</span><span class=p>.</span><span class=nx>SchedulerName</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>opts</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>opts</span><span class=p>,</span> <span class=nx>frameworkruntime</span><span class=p>.</span><span class=nf>WithEventRecorder</span><span class=p>(</span><span class=nx>recorder</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>frameworkruntime</span><span class=p>.</span><span class=nf>NewFramework</span><span class=p>(</span><span class=nx>r</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>cfg</span><span class=p>,</span> <span class=nx>stopCh</span><span class=p>,</span> <span class=nx>opts</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>可以看到最终返回的是一个 <code>Framework</code> 。那么来看下这个 <code>Framework</code></p><p><a href=https://github.com/kubernetes/kubernetes/blob/32c483ea6ee90a3a81f382563c91034470af8a4a/pkg/scheduler/framework/interface.go#L495-L566 target=_blank rel="noopener nofollow noreferrer">Framework</a> 是一个抽象，管理着调度过程中所使用的所有插件，并在调度上下文中适当的位置去运行对应的插件</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Framework</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>Handle</span>
</span></span><span class=line><span class=cl>	<span class=c1>// QueueSortFunc 返回对调度队列中的 Pod 进行排序的函数
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 也就是less，在Sort打分阶段的打分函数
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>QueueSortFunc</span><span class=p>()</span> <span class=nx>LessFunc</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// RunPreFilterPlugins 运行配置的一组PreFilter插件。
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 如果这组插件中，任何一个插件失败，则返回 *Status 并设置为non-success。
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 如果返回状态为non-success，则调度周期中止。
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 它还返回一个 PreFilterResult，它可能会影响到要评估下游的节点。
</span></span></span><span class=line><span class=cl><span class=c1></span>    
</span></span><span class=line><span class=cl>	<span class=nf>RunPreFilterPlugins</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>state</span> <span class=o>*</span><span class=nx>CycleState</span><span class=p>,</span> <span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>PreFilterResult</span><span class=p>,</span> <span class=o>*</span><span class=nx>Status</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// RunPostFilterPlugins 运行配置的一组PostFilter插件。 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// PostFilter 插件是通知性插件，在这种情况下应配置为先执行并返回 Unschedulable 状态，
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 或者尝试更改集群状态以使 pod 在未来的调度周期中可能会被调度。
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>RunPostFilterPlugins</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>state</span> <span class=o>*</span><span class=nx>CycleState</span><span class=p>,</span> <span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>,</span> <span class=nx>filteredNodeStatusMap</span> <span class=nx>NodeToStatusMap</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>PostFilterResult</span><span class=p>,</span> <span class=o>*</span><span class=nx>Status</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// RunPreBindPlugins 运行配置的一组 PreBind 插件。
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 如果任何一个插件返回错误，则返回 *Status 并且code设置为non-success。
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 如果code为“Unschedulable”，则调度检查失败，
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 则认为是内部错误。在任何一种情况下，Pod都不会被bound。
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>RunPreBindPlugins</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>state</span> <span class=o>*</span><span class=nx>CycleState</span><span class=p>,</span> <span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>,</span> <span class=nx>nodeName</span> <span class=kt>string</span><span class=p>)</span> <span class=o>*</span><span class=nx>Status</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// RunPostBindPlugins 运行配置的一组PostBind插件
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>RunPostBindPlugins</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>state</span> <span class=o>*</span><span class=nx>CycleState</span><span class=p>,</span> <span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>,</span> <span class=nx>nodeName</span> <span class=kt>string</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// RunReservePluginsReserve运行配置的一组Reserve插件的Reserve方法。
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 如果在这组调用中的任何一个插件返回错误，则不会继续运行剩余调用的插件并返回错误。
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 在这种情况下，pod将不能被调度。
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>RunReservePluginsReserve</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>state</span> <span class=o>*</span><span class=nx>CycleState</span><span class=p>,</span> <span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>,</span> <span class=nx>nodeName</span> <span class=kt>string</span><span class=p>)</span> <span class=o>*</span><span class=nx>Status</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// RunReservePluginsUnreserve运行配置的一组Reserve插件的Unreserve方法。
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>RunReservePluginsUnreserve</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>state</span> <span class=o>*</span><span class=nx>CycleState</span><span class=p>,</span> <span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>,</span> <span class=nx>nodeName</span> <span class=kt>string</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// RunPermitPlugins运行配置的一组Permit插件。
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 如果这些插件中的任何一个返回“Success”或“Wait”之外的状态，则它不会继续运行其余插件并返回错误。
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 否则，如果任何插件返回 “Wait”，则此函数将创建等待pod并将其添加到当前等待pod的map中，
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 并使用“Wait” code返回状态。 Pod将在Permit插件返回的最短持续时间内保持等待pod。
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>RunPermitPlugins</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>state</span> <span class=o>*</span><span class=nx>CycleState</span><span class=p>,</span> <span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>,</span> <span class=nx>nodeName</span> <span class=kt>string</span><span class=p>)</span> <span class=o>*</span><span class=nx>Status</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 如果pod是waiting pod，WaitOnPermit 将阻塞，直到等待的pod被允许或拒绝。
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>WaitOnPermit</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)</span> <span class=o>*</span><span class=nx>Status</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// RunBindPlugins运行配置的一组bind插件。 Bind插件可以选择是否处理Pod。
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 如果 Bind 插件选择跳过binding，它应该返回 code=5(&#34;skip&#34;)状态。
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 否则，它应该返回“Error”或“Success”。
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 如果没有插件处理绑定，则RunBindPlugins返回code=5(&#34;skip&#34;)的状态。
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>RunBindPlugins</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>state</span> <span class=o>*</span><span class=nx>CycleState</span><span class=p>,</span> <span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>,</span> <span class=nx>nodeName</span> <span class=kt>string</span><span class=p>)</span> <span class=o>*</span><span class=nx>Status</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 如果至少定义了一个filter插件，则HasFilterPlugins返回true
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>HasFilterPlugins</span><span class=p>()</span> <span class=kt>bool</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 如果至少定义了一个PostFilter插件，则HasPostFilterPlugins返回 true。
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>HasPostFilterPlugins</span><span class=p>()</span> <span class=kt>bool</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 如果至少定义了一个Score插件，则HasScorePlugins返回 true。
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>HasScorePlugins</span><span class=p>()</span> <span class=kt>bool</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// ListPlugins将返回map。key为扩展点名称，value则是配置的插件列表。
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>ListPlugins</span><span class=p>()</span> <span class=o>*</span><span class=nx>config</span><span class=p>.</span><span class=nx>Plugins</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// ProfileName则是与profile name关联的framework
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>ProfileName</span><span class=p>()</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>而实现这个抽象的则是 <a href=https://github.com/kubernetes/kubernetes/blob/32c483ea6ee90a3a81f382563c91034470af8a4a/pkg/scheduler/framework/runtime/framework.go#L73-L102 target=_blank rel="noopener nofollow noreferrer">frameworkImpl</a>；<code>frameworkImpl</code> 是初始化与运行 <em>scheduler plugins</em> 的组件，并在调度上下文中会运行这些扩展点</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>text</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>type frameworkImpl struct {
</span></span><span class=line><span class=cl>   registry             Registry
</span></span><span class=line><span class=cl>   snapshotSharedLister framework.SharedLister
</span></span><span class=line><span class=cl>   waitingPods          *waitingPodsMap
</span></span><span class=line><span class=cl>   scorePluginWeight    map[string]int
</span></span><span class=line><span class=cl>   queueSortPlugins     []framework.QueueSortPlugin
</span></span><span class=line><span class=cl>   preFilterPlugins     []framework.PreFilterPlugin
</span></span><span class=line><span class=cl>   filterPlugins        []framework.FilterPlugin
</span></span><span class=line><span class=cl>   postFilterPlugins    []framework.PostFilterPlugin
</span></span><span class=line><span class=cl>   preScorePlugins      []framework.PreScorePlugin
</span></span><span class=line><span class=cl>   scorePlugins         []framework.ScorePlugin
</span></span><span class=line><span class=cl>   reservePlugins       []framework.ReservePlugin
</span></span><span class=line><span class=cl>   preBindPlugins       []framework.PreBindPlugin
</span></span><span class=line><span class=cl>   bindPlugins          []framework.BindPlugin
</span></span><span class=line><span class=cl>   postBindPlugins      []framework.PostBindPlugin
</span></span><span class=line><span class=cl>   permitPlugins        []framework.PermitPlugin
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   clientSet       clientset.Interface
</span></span><span class=line><span class=cl>   kubeConfig      *restclient.Config
</span></span><span class=line><span class=cl>   eventRecorder   events.EventRecorder
</span></span><span class=line><span class=cl>   informerFactory informers.SharedInformerFactory
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   metricsRecorder *metricsRecorder
</span></span><span class=line><span class=cl>   profileName     string
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   extenders []framework.Extender
</span></span><span class=line><span class=cl>   framework.PodNominator
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   parallelizer parallelize.Parallelizer
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div></div></div><p>那么来看下 Registry ，<code>Registry </code>是作为一个可用插件的集合。<code>framework</code> 使用 <code>registry</code> 来启用和对插件配置的初始化。在初始化框架之前，所有插件都必须在注册表中。表现形式就是一个 <code>map[]</code>；<em>key</em> 是插件的名称，value是 <code>PluginFactory</code> 。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Registry</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=nx>PluginFactory</span></span></span></code></pre></td></tr></table></div></div></div></div><p>而在 <a href=https://github.com/kubernetes/kubernetes/blob/release-1.24/pkg/scheduler/framework/plugins/registry.go target=_blank rel="noopener nofollow noreferrer">pkg\scheduler\framework\plugins\registry.go</a> 中会将所有的 <code>in-tree plugin</code> 注册进来。通过 <code>NewInTreeRegistry</code> 。后续如果还有插件要注册，可以通过 <a href=https://github.com/kubernetes/kubernetes/blob/32c483ea6ee90a3a81f382563c91034470af8a4a/pkg/scheduler/scheduler.go#L176-L180 target=_blank rel="noopener nofollow noreferrer">WithFrameworkOutOfTreeRegistry</a> 来注册其他的插件。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>NewInTreeRegistry</span><span class=p>()</span> <span class=nx>runtime</span><span class=p>.</span><span class=nx>Registry</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>fts</span> <span class=o>:=</span> <span class=nx>plfeature</span><span class=p>.</span><span class=nx>Features</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>EnableReadWriteOncePod</span><span class=p>:</span>                       <span class=nx>feature</span><span class=p>.</span><span class=nx>DefaultFeatureGate</span><span class=p>.</span><span class=nf>Enabled</span><span class=p>(</span><span class=nx>features</span><span class=p>.</span><span class=nx>ReadWriteOncePod</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>EnableVolumeCapacityPriority</span><span class=p>:</span>                 <span class=nx>feature</span><span class=p>.</span><span class=nx>DefaultFeatureGate</span><span class=p>.</span><span class=nf>Enabled</span><span class=p>(</span><span class=nx>features</span><span class=p>.</span><span class=nx>VolumeCapacityPriority</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>EnableMinDomainsInPodTopologySpread</span><span class=p>:</span>          <span class=nx>feature</span><span class=p>.</span><span class=nx>DefaultFeatureGate</span><span class=p>.</span><span class=nf>Enabled</span><span class=p>(</span><span class=nx>features</span><span class=p>.</span><span class=nx>MinDomainsInPodTopologySpread</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>EnableNodeInclusionPolicyInPodTopologySpread</span><span class=p>:</span> <span class=nx>feature</span><span class=p>.</span><span class=nx>DefaultFeatureGate</span><span class=p>.</span><span class=nf>Enabled</span><span class=p>(</span><span class=nx>features</span><span class=p>.</span><span class=nx>NodeInclusionPolicyInPodTopologySpread</span><span class=p>),</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>runtime</span><span class=p>.</span><span class=nx>Registry</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>selectorspread</span><span class=p>.</span><span class=nx>Name</span><span class=p>:</span>                  <span class=nx>selectorspread</span><span class=p>.</span><span class=nx>New</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>imagelocality</span><span class=p>.</span><span class=nx>Name</span><span class=p>:</span>                   <span class=nx>imagelocality</span><span class=p>.</span><span class=nx>New</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>tainttoleration</span><span class=p>.</span><span class=nx>Name</span><span class=p>:</span>                 <span class=nx>tainttoleration</span><span class=p>.</span><span class=nx>New</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>nodename</span><span class=p>.</span><span class=nx>Name</span><span class=p>:</span>                        <span class=nx>nodename</span><span class=p>.</span><span class=nx>New</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>nodeports</span><span class=p>.</span><span class=nx>Name</span><span class=p>:</span>                       <span class=nx>nodeports</span><span class=p>.</span><span class=nx>New</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>nodeaffinity</span><span class=p>.</span><span class=nx>Name</span><span class=p>:</span>                    <span class=nx>nodeaffinity</span><span class=p>.</span><span class=nx>New</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>podtopologyspread</span><span class=p>.</span><span class=nx>Name</span><span class=p>:</span>               <span class=nx>runtime</span><span class=p>.</span><span class=nf>FactoryAdapter</span><span class=p>(</span><span class=nx>fts</span><span class=p>,</span> <span class=nx>podtopologyspread</span><span class=p>.</span><span class=nx>New</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>nodeunschedulable</span><span class=p>.</span><span class=nx>Name</span><span class=p>:</span>               <span class=nx>nodeunschedulable</span><span class=p>.</span><span class=nx>New</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>noderesources</span><span class=p>.</span><span class=nx>Name</span><span class=p>:</span>                   <span class=nx>runtime</span><span class=p>.</span><span class=nf>FactoryAdapter</span><span class=p>(</span><span class=nx>fts</span><span class=p>,</span> <span class=nx>noderesources</span><span class=p>.</span><span class=nx>NewFit</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>noderesources</span><span class=p>.</span><span class=nx>BalancedAllocationName</span><span class=p>:</span> <span class=nx>runtime</span><span class=p>.</span><span class=nf>FactoryAdapter</span><span class=p>(</span><span class=nx>fts</span><span class=p>,</span> <span class=nx>noderesources</span><span class=p>.</span><span class=nx>NewBalancedAllocation</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>volumebinding</span><span class=p>.</span><span class=nx>Name</span><span class=p>:</span>                   <span class=nx>runtime</span><span class=p>.</span><span class=nf>FactoryAdapter</span><span class=p>(</span><span class=nx>fts</span><span class=p>,</span> <span class=nx>volumebinding</span><span class=p>.</span><span class=nx>New</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>volumerestrictions</span><span class=p>.</span><span class=nx>Name</span><span class=p>:</span>              <span class=nx>runtime</span><span class=p>.</span><span class=nf>FactoryAdapter</span><span class=p>(</span><span class=nx>fts</span><span class=p>,</span> <span class=nx>volumerestrictions</span><span class=p>.</span><span class=nx>New</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>volumezone</span><span class=p>.</span><span class=nx>Name</span><span class=p>:</span>                      <span class=nx>volumezone</span><span class=p>.</span><span class=nx>New</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>nodevolumelimits</span><span class=p>.</span><span class=nx>CSIName</span><span class=p>:</span>             <span class=nx>runtime</span><span class=p>.</span><span class=nf>FactoryAdapter</span><span class=p>(</span><span class=nx>fts</span><span class=p>,</span> <span class=nx>nodevolumelimits</span><span class=p>.</span><span class=nx>NewCSI</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>nodevolumelimits</span><span class=p>.</span><span class=nx>EBSName</span><span class=p>:</span>             <span class=nx>runtime</span><span class=p>.</span><span class=nf>FactoryAdapter</span><span class=p>(</span><span class=nx>fts</span><span class=p>,</span> <span class=nx>nodevolumelimits</span><span class=p>.</span><span class=nx>NewEBS</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>nodevolumelimits</span><span class=p>.</span><span class=nx>GCEPDName</span><span class=p>:</span>           <span class=nx>runtime</span><span class=p>.</span><span class=nf>FactoryAdapter</span><span class=p>(</span><span class=nx>fts</span><span class=p>,</span> <span class=nx>nodevolumelimits</span><span class=p>.</span><span class=nx>NewGCEPD</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>nodevolumelimits</span><span class=p>.</span><span class=nx>AzureDiskName</span><span class=p>:</span>       <span class=nx>runtime</span><span class=p>.</span><span class=nf>FactoryAdapter</span><span class=p>(</span><span class=nx>fts</span><span class=p>,</span> <span class=nx>nodevolumelimits</span><span class=p>.</span><span class=nx>NewAzureDisk</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>nodevolumelimits</span><span class=p>.</span><span class=nx>CinderName</span><span class=p>:</span>          <span class=nx>runtime</span><span class=p>.</span><span class=nf>FactoryAdapter</span><span class=p>(</span><span class=nx>fts</span><span class=p>,</span> <span class=nx>nodevolumelimits</span><span class=p>.</span><span class=nx>NewCinder</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>interpodaffinity</span><span class=p>.</span><span class=nx>Name</span><span class=p>:</span>                <span class=nx>interpodaffinity</span><span class=p>.</span><span class=nx>New</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>queuesort</span><span class=p>.</span><span class=nx>Name</span><span class=p>:</span>                       <span class=nx>queuesort</span><span class=p>.</span><span class=nx>New</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>defaultbinder</span><span class=p>.</span><span class=nx>Name</span><span class=p>:</span>                   <span class=nx>defaultbinder</span><span class=p>.</span><span class=nx>New</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>defaultpreemption</span><span class=p>.</span><span class=nx>Name</span><span class=p>:</span>               <span class=nx>runtime</span><span class=p>.</span><span class=nf>FactoryAdapter</span><span class=p>(</span><span class=nx>fts</span><span class=p>,</span> <span class=nx>defaultpreemption</span><span class=p>.</span><span class=nx>New</span><span class=p>),</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><blockquote><p>这里插入一个题外话，关于 <em>in-tree plugin</em></p><p>在这里没有找到关于，<em>kube-scheduler</em> ，只是找到有关的概念，大概可以解释为，in-tree表示为随kubernetes官方提供的二进制构建的 <em>plugin</em> 则为 <code>in-tree</code>，而独立于kubernetes代码库之外的为 <code>out-of-tree</code> <sup><a href=#3>[3]</a></sup> 。这种情况下，可以理解为，AA则是 <code>out-of-tree</code> 而 <code>Pod</code>, <code>DeplymentSet</code> 等是 <code>in-tree</code>。</p></blockquote><p>接下来回到初始化 <em>scheduler</em> ，在初始化一个 <em>scheduler</em> 时，会通过<code>NewInTreeRegistry</code> 来初始化</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>New</span><span class=p>(</span><span class=nx>client</span> <span class=nx>clientset</span><span class=p>.</span><span class=nx>Interface</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=o>...</span><span class=p>.</span>
</span></span><span class=line><span class=cl>	<span class=nx>registry</span> <span class=o>:=</span> <span class=nx>frameworkplugins</span><span class=p>.</span><span class=nf>NewInTreeRegistry</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>registry</span><span class=p>.</span><span class=nf>Merge</span><span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>frameworkOutOfTreeRegistry</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>         
</span></span><span class=line><span class=cl>	<span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>profiles</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>profile</span><span class=p>.</span><span class=nf>NewMap</span><span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>profiles</span><span class=p>,</span> <span class=nx>registry</span><span class=p>,</span> <span class=nx>recorderFactory</span><span class=p>,</span> <span class=nx>stopCh</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>frameworkruntime</span><span class=p>.</span><span class=nf>WithComponentConfigVersion</span><span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>componentConfigVersion</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>frameworkruntime</span><span class=p>.</span><span class=nf>WithClientSet</span><span class=p>(</span><span class=nx>client</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>frameworkruntime</span><span class=p>.</span><span class=nf>WithKubeConfig</span><span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>kubeConfig</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>frameworkruntime</span><span class=p>.</span><span class=nf>WithInformerFactory</span><span class=p>(</span><span class=nx>informerFactory</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>frameworkruntime</span><span class=p>.</span><span class=nf>WithSnapshotSharedLister</span><span class=p>(</span><span class=nx>snapshot</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>frameworkruntime</span><span class=p>.</span><span class=nf>WithPodNominator</span><span class=p>(</span><span class=nx>nominator</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>frameworkruntime</span><span class=p>.</span><span class=nf>WithCaptureProfile</span><span class=p>(</span><span class=nx>frameworkruntime</span><span class=p>.</span><span class=nf>CaptureProfile</span><span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>frameworkCapturer</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>		<span class=nx>frameworkruntime</span><span class=p>.</span><span class=nf>WithClusterEventMap</span><span class=p>(</span><span class=nx>clusterEventMap</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>frameworkruntime</span><span class=p>.</span><span class=nf>WithParallelism</span><span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>parallelism</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>		<span class=nx>frameworkruntime</span><span class=p>.</span><span class=nf>WithExtenders</span><span class=p>(</span><span class=nx>extenders</span><span class=p>),</span>
</span></span><span class=line><span class=cl>	<span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>接下来在调度上下文 <code>scheduleOne</code> 中 <code>schedulePod</code> 时，会通过 <code>framework</code> 调用对应的插件来处理这个扩展点工作。具体的体现在，pkg\scheduler\schedule_one.go 中的预选阶段</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>sched</span> <span class=o>*</span><span class=nx>Scheduler</span><span class=p>)</span> <span class=nf>schedulePod</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>fwk</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>Framework</span><span class=p>,</span> <span class=nx>state</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>CycleState</span><span class=p>,</span> <span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)</span> <span class=p>(</span><span class=nx>result</span> <span class=nx>ScheduleResult</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>trace</span> <span class=o>:=</span> <span class=nx>utiltrace</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;Scheduling&#34;</span><span class=p>,</span> <span class=nx>utiltrace</span><span class=p>.</span><span class=nx>Field</span><span class=p>{</span><span class=nx>Key</span><span class=p>:</span> <span class=s>&#34;namespace&#34;</span><span class=p>,</span> <span class=nx>Value</span><span class=p>:</span> <span class=nx>pod</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>},</span> <span class=nx>utiltrace</span><span class=p>.</span><span class=nx>Field</span><span class=p>{</span><span class=nx>Key</span><span class=p>:</span> <span class=s>&#34;name&#34;</span><span class=p>,</span> <span class=nx>Value</span><span class=p>:</span> <span class=nx>pod</span><span class=p>.</span><span class=nx>Name</span><span class=p>})</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>trace</span><span class=p>.</span><span class=nf>LogIfLong</span><span class=p>(</span><span class=mi>100</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Millisecond</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nx>Cache</span><span class=p>.</span><span class=nf>UpdateSnapshot</span><span class=p>(</span><span class=nx>sched</span><span class=p>.</span><span class=nx>nodeInfoSnapshot</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>result</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>trace</span><span class=p>.</span><span class=nf>Step</span><span class=p>(</span><span class=s>&#34;Snapshotting scheduler cache and node infos done&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>sched</span><span class=p>.</span><span class=nx>nodeInfoSnapshot</span><span class=p>.</span><span class=nf>NumNodes</span><span class=p>()</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>result</span><span class=p>,</span> <span class=nx>ErrNoNodesAvailable</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>feasibleNodes</span><span class=p>,</span> <span class=nx>diagnosis</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nf>findNodesThatFitPod</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>fwk</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>pod</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>result</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>trace</span><span class=p>.</span><span class=nf>Step</span><span class=p>(</span><span class=s>&#34;Computing predicates done&#34;</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div></div></div><p>与其他扩展点部分，在调度上下文 <a href=https://github.com/kubernetes/kubernetes/blob/32c483ea6ee90a3a81f382563c91034470af8a4a/pkg/scheduler/schedule_one.go#L66-L278 target=_blank rel="noopener nofollow noreferrer">scheduleOne</a> 中可以很好的看出，功能都是 <code>framework</code> 提供的。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>sched</span> <span class=o>*</span><span class=nx>Scheduler</span><span class=p>)</span> <span class=nf>scheduleOne</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>	<span class=nx>scheduleResult</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nf>SchedulePod</span><span class=p>(</span><span class=nx>schedulingCycleCtx</span><span class=p>,</span> <span class=nx>fwk</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>pod</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>	<span class=c1>// Run the Reserve method of reserve plugins.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>sts</span> <span class=o>:=</span> <span class=nx>fwk</span><span class=p>.</span><span class=nf>RunReservePluginsReserve</span><span class=p>(</span><span class=nx>schedulingCycleCtx</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>assumedPod</span><span class=p>,</span> <span class=nx>scheduleResult</span><span class=p>.</span><span class=nx>SuggestedHost</span><span class=p>);</span> <span class=p>!</span><span class=nx>sts</span><span class=p>.</span><span class=nf>IsSuccess</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>	<span class=c1>// Run &#34;permit&#34; plugins.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>runPermitStatus</span> <span class=o>:=</span> <span class=nx>fwk</span><span class=p>.</span><span class=nf>RunPermitPlugins</span><span class=p>(</span><span class=nx>schedulingCycleCtx</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>assumedPod</span><span class=p>,</span> <span class=nx>scheduleResult</span><span class=p>.</span><span class=nx>SuggestedHost</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>		<span class=c1>// One of the plugins returned status different than success or wait.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>fwk</span><span class=p>.</span><span class=nf>RunReservePluginsUnreserve</span><span class=p>(</span><span class=nx>schedulingCycleCtx</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>assumedPod</span><span class=p>,</span> <span class=nx>scheduleResult</span><span class=p>.</span><span class=nx>SuggestedHost</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>	<span class=c1>// bind the pod to its host asynchronously (we can do this b/c of the assumption step above).
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=o>...</span>
</span></span><span class=line><span class=cl>		<span class=nx>waitOnPermitStatus</span> <span class=o>:=</span> <span class=nx>fwk</span><span class=p>.</span><span class=nf>WaitOnPermit</span><span class=p>(</span><span class=nx>bindingCycleCtx</span><span class=p>,</span> <span class=nx>assumedPod</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>!</span><span class=nx>waitOnPermitStatus</span><span class=p>.</span><span class=nf>IsSuccess</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=o>...</span>
</span></span><span class=line><span class=cl>			<span class=c1>// trigger un-reserve plugins to clean up state associated with the reserved Pod
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>fwk</span><span class=p>.</span><span class=nf>RunReservePluginsUnreserve</span><span class=p>(</span><span class=nx>bindingCycleCtx</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>assumedPod</span><span class=p>,</span> <span class=nx>scheduleResult</span><span class=p>.</span><span class=nx>SuggestedHost</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// Run &#34;prebind&#34; plugins.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>preBindStatus</span> <span class=o>:=</span> <span class=nx>fwk</span><span class=p>.</span><span class=nf>RunPreBindPlugins</span><span class=p>(</span><span class=nx>bindingCycleCtx</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>assumedPod</span><span class=p>,</span> <span class=nx>scheduleResult</span><span class=p>.</span><span class=nx>SuggestedHost</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>			<span class=c1>// trigger un-reserve plugins to clean up state associated with the reserved Pod
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>fwk</span><span class=p>.</span><span class=nf>RunReservePluginsUnreserve</span><span class=p>(</span><span class=nx>bindingCycleCtx</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>assumedPod</span><span class=p>,</span> <span class=nx>scheduleResult</span><span class=p>.</span><span class=nx>SuggestedHost</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=o>...</span>
</span></span><span class=line><span class=cl>			<span class=c1>// trigger un-reserve plugins to clean up state associated with the reserved Pod
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>fwk</span><span class=p>.</span><span class=nf>RunReservePluginsUnreserve</span><span class=p>(</span><span class=nx>bindingCycleCtx</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>assumedPod</span><span class=p>,</span> <span class=nx>scheduleResult</span><span class=p>.</span><span class=nx>SuggestedHost</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// Run &#34;postbind&#34; plugins.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>fwk</span><span class=p>.</span><span class=nf>RunPostBindPlugins</span><span class=p>(</span><span class=nx>bindingCycleCtx</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>assumedPod</span><span class=p>,</span> <span class=nx>scheduleResult</span><span class=p>.</span><span class=nx>SuggestedHost</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><h2 id=插件-supa-href44asup>插件 <sup><a href=#4>[4]</a></sup><a hidden class=anchor aria-hidden=true href=#插件-supa-href44asup>#</a></h2><p>插件（<code>Plugins</code>）（也可以算是调度策略）在 <code>kube-scheduler</code> 中的实现为 <code>framework plugin</code>，插件API的实现分为两个步骤**：register** 和 <strong>configured</strong>，然后都实现了其父方法 <code>Plugin</code>。然后可以通过配置（kube-scheduler <code>--config</code> 提供）启动或禁用插件；除了默认插件外，还可以实现自定义调度插件与默认插件进行绑定。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Plugin</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>Name</span><span class=p>()</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// sort扩展点
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>QueueSortPlugin</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>Plugin</span>
</span></span><span class=line><span class=cl>    <span class=nf>Less</span><span class=p>(</span><span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>pod</span><span class=p>,</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>pod</span><span class=p>)</span> <span class=kt>bool</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// PreFilter扩展点
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>PreFilterPlugin</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>Plugin</span>
</span></span><span class=line><span class=cl>    <span class=nf>PreFilter</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>CycleState</span><span class=p>,</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>pod</span><span class=p>)</span> <span class=kt>error</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><h3 id=插件的载入过程>插件的载入过程<a hidden class=anchor aria-hidden=true href=#插件的载入过程>#</a></h3><p>在 <em>scheduler</em> 被启动时，会 <code>scheduler.New(cc.Client..</code> 这个时候会传入 <code>profiles</code>，整个的流如下：</p><ul><li><code>NewScheduler</code> ：<a href=https://github.com/kubernetes/kubernetes/blob/32c483ea6ee90a3a81f382563c91034470af8a4a/cmd/kube-scheduler/app/server.go#L327-L346 target=_blank rel="noopener nofollow noreferrer">kubernetes/cmd/kube-scheduler/app/server.go</a></li><li><code>profile.NewMap</code>：<a href=https://github.com/kubernetes/kubernetes/blob/32c483ea6ee90a3a81f382563c91034470af8a4a/pkg/scheduler/profile/profile.go#L48-L64 target=_blank rel="noopener nofollow noreferrer">kubernetes/pkg/scheduler/scheduler.go</a><ul><li><code>newProfile</code>：<a href=https://github.com/kubernetes/kubernetes/blob/32c483ea6ee90a3a81f382563c91034470af8a4a/pkg/scheduler/profile/profile.go#L37-L42 target=_blank rel="noopener nofollow noreferrer">kubernetes/pkg/scheduler/scheduler.go</a></li></ul></li><li><code>frameworkruntime.NewFramework</code>：<a href=kubernetes/pkg/scheduler/framework/runtime/framework.go>kubernetes/pkg/scheduler/framework/runtime/framework.go</a><ul><li><code>pluginsNeeded</code>：<a href=kubernetes/pkg/scheduler/framework/runtime/framework.go>kubernetes/pkg/scheduler/framework/runtime/framework.go</a></li></ul></li></ul><h4 id=newscheduler>NewScheduler<a hidden class=anchor aria-hidden=true href=#newscheduler>#</a></h4><p>我们了解如何 New 一个 <em>scheduler</em> 即为 <code>Setup</code> 中去配置这些参数，</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>Setup</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>opts</span> <span class=o>*</span><span class=nx>options</span><span class=p>.</span><span class=nx>Options</span><span class=p>,</span> <span class=nx>outOfTreeRegistryOptions</span> <span class=o>...</span><span class=nx>Option</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>schedulerserverconfig</span><span class=p>.</span><span class=nx>CompletedConfig</span><span class=p>,</span> <span class=o>*</span><span class=nx>scheduler</span><span class=p>.</span><span class=nx>Scheduler</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>	<span class=c1>// Create the scheduler.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>sched</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>scheduler</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=nx>cc</span><span class=p>.</span><span class=nx>Client</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>cc</span><span class=p>.</span><span class=nx>InformerFactory</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>cc</span><span class=p>.</span><span class=nx>DynInformerFactory</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>recorderFactory</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>ctx</span><span class=p>.</span><span class=nf>Done</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>		<span class=nx>scheduler</span><span class=p>.</span><span class=nf>WithComponentConfigVersion</span><span class=p>(</span><span class=nx>cc</span><span class=p>.</span><span class=nx>ComponentConfig</span><span class=p>.</span><span class=nx>TypeMeta</span><span class=p>.</span><span class=nx>APIVersion</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>scheduler</span><span class=p>.</span><span class=nf>WithKubeConfig</span><span class=p>(</span><span class=nx>cc</span><span class=p>.</span><span class=nx>KubeConfig</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>scheduler</span><span class=p>.</span><span class=nf>WithProfiles</span><span class=p>(</span><span class=nx>cc</span><span class=p>.</span><span class=nx>ComponentConfig</span><span class=p>.</span><span class=nx>Profiles</span><span class=o>...</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>scheduler</span><span class=p>.</span><span class=nf>WithPercentageOfNodesToScore</span><span class=p>(</span><span class=nx>cc</span><span class=p>.</span><span class=nx>ComponentConfig</span><span class=p>.</span><span class=nx>PercentageOfNodesToScore</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>scheduler</span><span class=p>.</span><span class=nf>WithFrameworkOutOfTreeRegistry</span><span class=p>(</span><span class=nx>outOfTreeRegistry</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>scheduler</span><span class=p>.</span><span class=nf>WithPodMaxBackoffSeconds</span><span class=p>(</span><span class=nx>cc</span><span class=p>.</span><span class=nx>ComponentConfig</span><span class=p>.</span><span class=nx>PodMaxBackoffSeconds</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>scheduler</span><span class=p>.</span><span class=nf>WithPodInitialBackoffSeconds</span><span class=p>(</span><span class=nx>cc</span><span class=p>.</span><span class=nx>ComponentConfig</span><span class=p>.</span><span class=nx>PodInitialBackoffSeconds</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>scheduler</span><span class=p>.</span><span class=nf>WithPodMaxInUnschedulablePodsDuration</span><span class=p>(</span><span class=nx>cc</span><span class=p>.</span><span class=nx>PodMaxInUnschedulablePodsDuration</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>scheduler</span><span class=p>.</span><span class=nf>WithExtenders</span><span class=p>(</span><span class=nx>cc</span><span class=p>.</span><span class=nx>ComponentConfig</span><span class=p>.</span><span class=nx>Extenders</span><span class=o>...</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>scheduler</span><span class=p>.</span><span class=nf>WithParallelism</span><span class=p>(</span><span class=nx>cc</span><span class=p>.</span><span class=nx>ComponentConfig</span><span class=p>.</span><span class=nx>Parallelism</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>scheduler</span><span class=p>.</span><span class=nf>WithBuildFrameworkCapturer</span><span class=p>(</span><span class=kd>func</span><span class=p>(</span><span class=nx>profile</span> <span class=nx>kubeschedulerconfig</span><span class=p>.</span><span class=nx>KubeSchedulerProfile</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// Profiles are processed during Framework instantiation to set default plugins and configurations. Capturing them for logging
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>completedProfiles</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>completedProfiles</span><span class=p>,</span> <span class=nx>profile</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}),</span>
</span></span><span class=line><span class=cl>	<span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><h4 id=profilenewmap>profile.NewMap<a hidden class=anchor aria-hidden=true href=#profilenewmap>#</a></h4><p>在 <code>scheduler.New</code> 中，会根据配置生成profile，而 <code>profile.NewMap</code> 会完成这一步</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>New</span><span class=p>(</span><span class=nx>client</span> <span class=nx>clientset</span><span class=p>.</span><span class=nx>Interface</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=o>...</span>
</span></span><span class=line><span class=cl>         
</span></span><span class=line><span class=cl>	<span class=nx>clusterEventMap</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=nx>framework</span><span class=p>.</span><span class=nx>ClusterEvent</span><span class=p>]</span><span class=nx>sets</span><span class=p>.</span><span class=nx>String</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>profiles</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>profile</span><span class=p>.</span><span class=nf>NewMap</span><span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>profiles</span><span class=p>,</span> <span class=nx>registry</span><span class=p>,</span> <span class=nx>recorderFactory</span><span class=p>,</span> <span class=nx>stopCh</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>frameworkruntime</span><span class=p>.</span><span class=nf>WithComponentConfigVersion</span><span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>componentConfigVersion</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>frameworkruntime</span><span class=p>.</span><span class=nf>WithClientSet</span><span class=p>(</span><span class=nx>client</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>frameworkruntime</span><span class=p>.</span><span class=nf>WithKubeConfig</span><span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>kubeConfig</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>frameworkruntime</span><span class=p>.</span><span class=nf>WithInformerFactory</span><span class=p>(</span><span class=nx>informerFactory</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>frameworkruntime</span><span class=p>.</span><span class=nf>WithSnapshotSharedLister</span><span class=p>(</span><span class=nx>snapshot</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>frameworkruntime</span><span class=p>.</span><span class=nf>WithPodNominator</span><span class=p>(</span><span class=nx>nominator</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>frameworkruntime</span><span class=p>.</span><span class=nf>WithCaptureProfile</span><span class=p>(</span><span class=nx>frameworkruntime</span><span class=p>.</span><span class=nf>CaptureProfile</span><span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>frameworkCapturer</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>		<span class=nx>frameworkruntime</span><span class=p>.</span><span class=nf>WithClusterEventMap</span><span class=p>(</span><span class=nx>clusterEventMap</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>frameworkruntime</span><span class=p>.</span><span class=nf>WithParallelism</span><span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>parallelism</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>		<span class=nx>frameworkruntime</span><span class=p>.</span><span class=nf>WithExtenders</span><span class=p>(</span><span class=nx>extenders</span><span class=p>),</span>
</span></span><span class=line><span class=cl>	<span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>         <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><h4 id=newframework>NewFramework<a hidden class=anchor aria-hidden=true href=#newframework>#</a></h4><p><code>newProfile</code> 返回的则是一个创建好的 framework</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>newProfile</span><span class=p>(</span><span class=nx>cfg</span> <span class=nx>config</span><span class=p>.</span><span class=nx>KubeSchedulerProfile</span><span class=p>,</span> <span class=nx>r</span> <span class=nx>frameworkruntime</span><span class=p>.</span><span class=nx>Registry</span><span class=p>,</span> <span class=nx>recorderFact</span> <span class=nx>RecorderFactory</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>stopCh</span> <span class=o>&lt;-</span><span class=kd>chan</span> <span class=kd>struct</span><span class=p>{},</span> <span class=nx>opts</span> <span class=o>...</span><span class=nx>frameworkruntime</span><span class=p>.</span><span class=nx>Option</span><span class=p>)</span> <span class=p>(</span><span class=nx>framework</span><span class=p>.</span><span class=nx>Framework</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>recorder</span> <span class=o>:=</span> <span class=nf>recorderFact</span><span class=p>(</span><span class=nx>cfg</span><span class=p>.</span><span class=nx>SchedulerName</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>opts</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>opts</span><span class=p>,</span> <span class=nx>frameworkruntime</span><span class=p>.</span><span class=nf>WithEventRecorder</span><span class=p>(</span><span class=nx>recorder</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>frameworkruntime</span><span class=p>.</span><span class=nf>NewFramework</span><span class=p>(</span><span class=nx>r</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>cfg</span><span class=p>,</span> <span class=nx>stopCh</span><span class=p>,</span> <span class=nx>opts</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>最终会走到 <code>pluginsNeeded</code>，这里会根据配置中开启的插件而返回一个插件集，这个就是最终在每个扩展点中药执行的插件。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>f</span> <span class=o>*</span><span class=nx>frameworkImpl</span><span class=p>)</span> <span class=nf>pluginsNeeded</span><span class=p>(</span><span class=nx>plugins</span> <span class=o>*</span><span class=nx>config</span><span class=p>.</span><span class=nx>Plugins</span><span class=p>)</span> <span class=nx>sets</span><span class=p>.</span><span class=nx>String</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>pgSet</span> <span class=o>:=</span> <span class=nx>sets</span><span class=p>.</span><span class=nx>String</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>plugins</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>pgSet</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>find</span> <span class=o>:=</span> <span class=kd>func</span><span class=p>(</span><span class=nx>pgs</span> <span class=o>*</span><span class=nx>config</span><span class=p>.</span><span class=nx>PluginSet</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>pg</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>pgs</span><span class=p>.</span><span class=nx>Enabled</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>pgSet</span><span class=p>.</span><span class=nf>Insert</span><span class=p>(</span><span class=nx>pg</span><span class=p>.</span><span class=nx>Name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 获取到所有的扩展点，找到为Enabled的插件加入到pgSet
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>e</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>f</span><span class=p>.</span><span class=nf>getExtensionPoints</span><span class=p>(</span><span class=nx>plugins</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>find</span><span class=p>(</span><span class=nx>e</span><span class=p>.</span><span class=nx>plugins</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Parse MultiPoint separately since they are not returned by f.getExtensionPoints()
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>find</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>plugins</span><span class=p>.</span><span class=nx>MultiPoint</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>pgSet</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><h3 id=插件的执行>插件的执行<a hidden class=anchor aria-hidden=true href=#插件的执行>#</a></h3><p>在对插件源码部分分析，会找几个典型的插件进行分析，而不会对全部的进行分析，因为总的来说是大同小异，分析的插件有 <code>NodePorts</code>，<code>NodeResourcesFit</code>，<code>podtopologyspread</code></p><h4 id=nodeports>NodePorts<a hidden class=anchor aria-hidden=true href=#nodeports>#</a></h4><p>这里以一个简单的插件来分析；<code>NodePorts</code> 插件用于检查Pod请求的端口，在节点上是否为空闲端口。</p><p><a href=https://github.com/kubernetes/kubernetes/blob/32c483ea6ee90a3a81f382563c91034470af8a4a/pkg/scheduler/framework/plugins/nodeports/node_ports.go#L30 target=_blank rel="noopener nofollow noreferrer">NodePorts</a> 实现了 <code>FilterPlugin</code> 和 <code>PreFilterPlugin</code></p><p><a href=https://github.com/kubernetes/kubernetes/blob/32c483ea6ee90a3a81f382563c91034470af8a4a/pkg/scheduler/framework/plugins/nodeports/node_ports.go#L77-L81 target=_blank rel="noopener nofollow noreferrer">PreFilter</a> 将会被 <code>framework</code> 中 <code>PreFilter</code> 扩展点被调用。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>pl</span> <span class=o>*</span><span class=nx>NodePorts</span><span class=p>)</span> <span class=nf>PreFilter</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>cycleState</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>CycleState</span><span class=p>,</span> <span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>PreFilterResult</span><span class=p>,</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>Status</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>s</span> <span class=o>:=</span> <span class=nf>getContainerPorts</span><span class=p>(</span><span class=nx>pod</span><span class=p>)</span> <span class=c1>// 或得Pod得端口
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 写入状态
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>cycleState</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span><span class=nx>preFilterStateKey</span><span class=p>,</span> <span class=nf>preFilterState</span><span class=p>(</span><span class=nx>s</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p><a href=https://github.com/kubernetes/kubernetes/blob/32c483ea6ee90a3a81f382563c91034470af8a4a/pkg/scheduler/framework/plugins/nodeports/node_ports.go#L113-L125 target=_blank rel="noopener nofollow noreferrer">Filter</a> 将会被 <code>framework</code> 中 <code>Filter</code> 扩展点被调用。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// Filter invoked at the filter extension point.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>pl</span> <span class=o>*</span><span class=nx>NodePorts</span><span class=p>)</span> <span class=nf>Filter</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>cycleState</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>CycleState</span><span class=p>,</span> <span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>,</span> <span class=nx>nodeInfo</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>NodeInfo</span><span class=p>)</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>Status</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nx>wantPorts</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>getPreFilterState</span><span class=p>(</span><span class=nx>cycleState</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>framework</span><span class=p>.</span><span class=nf>AsStatus</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=nx>fits</span> <span class=o>:=</span> <span class=nf>fitsPorts</span><span class=p>(</span><span class=nx>wantPorts</span><span class=p>,</span> <span class=nx>nodeInfo</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=p>!</span><span class=nx>fits</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>framework</span><span class=p>.</span><span class=nf>NewStatus</span><span class=p>(</span><span class=nx>framework</span><span class=p>.</span><span class=nx>Unschedulable</span><span class=p>,</span> <span class=nx>ErrReason</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>fitsPorts</span><span class=p>(</span><span class=nx>wantPorts</span> <span class=p>[]</span><span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>ContainerPort</span><span class=p>,</span> <span class=nx>nodeInfo</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>NodeInfo</span><span class=p>)</span> <span class=kt>bool</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 对比existingPorts 和 wantPorts是否冲突，冲突则调度失败
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>existingPorts</span> <span class=o>:=</span> <span class=nx>nodeInfo</span><span class=p>.</span><span class=nx>UsedPorts</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>cp</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>wantPorts</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>existingPorts</span><span class=p>.</span><span class=nf>CheckConflict</span><span class=p>(</span><span class=nx>cp</span><span class=p>.</span><span class=nx>HostIP</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>cp</span><span class=p>.</span><span class=nx>Protocol</span><span class=p>),</span> <span class=nx>cp</span><span class=p>.</span><span class=nx>HostPort</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p><a href=https://github.com/kubernetes/kubernetes/blob/32c483ea6ee90a3a81f382563c91034470af8a4a/pkg/scheduler/framework/plugins/nodeports/node_ports.go#L144-L146 target=_blank rel="noopener nofollow noreferrer">New</a> ，初始化新插件，在 <code>register</code> 中注册得</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>New</span><span class=p>(</span><span class=nx>_</span> <span class=nx>runtime</span><span class=p>.</span><span class=nx>Object</span><span class=p>,</span> <span class=nx>_</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>Handle</span><span class=p>)</span> <span class=p>(</span><span class=nx>framework</span><span class=p>.</span><span class=nx>Plugin</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=o>&amp;</span><span class=nx>NodePorts</span><span class=p>{},</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>在调用中，如果有任何一个插件返回错误，则跳过该扩展点注册得其他插件，返回失败。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>f</span> <span class=o>*</span><span class=nx>frameworkImpl</span><span class=p>)</span> <span class=nf>RunFilterPlugins</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>state</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>CycleState</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>nodeInfo</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>NodeInfo</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>PluginToStatus</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>statuses</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=nx>framework</span><span class=p>.</span><span class=nx>PluginToStatus</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>pl</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>f</span><span class=p>.</span><span class=nx>filterPlugins</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>pluginStatus</span> <span class=o>:=</span> <span class=nx>f</span><span class=p>.</span><span class=nf>runFilterPlugin</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>pl</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>pod</span><span class=p>,</span> <span class=nx>nodeInfo</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>!</span><span class=nx>pluginStatus</span><span class=p>.</span><span class=nf>IsSuccess</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>!</span><span class=nx>pluginStatus</span><span class=p>.</span><span class=nf>IsUnschedulable</span><span class=p>()</span> 
</span></span><span class=line><span class=cl>				<span class=nx>errStatus</span> <span class=o>:=</span> <span class=nx>framework</span><span class=p>.</span><span class=nf>AsStatus</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;running %q filter plugin: %w&#34;</span><span class=p>,</span> <span class=nx>pl</span><span class=p>.</span><span class=nf>Name</span><span class=p>(),</span> <span class=nx>pluginStatus</span><span class=p>.</span><span class=nf>AsError</span><span class=p>())).</span><span class=nf>WithFailedPlugin</span><span class=p>(</span><span class=nx>pl</span><span class=p>.</span><span class=nf>Name</span><span class=p>())</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>Status</span><span class=p>{</span><span class=nx>pl</span><span class=p>.</span><span class=nf>Name</span><span class=p>():</span> <span class=nx>errStatus</span><span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nx>pluginStatus</span><span class=p>.</span><span class=nf>SetFailedPlugin</span><span class=p>(</span><span class=nx>pl</span><span class=p>.</span><span class=nf>Name</span><span class=p>())</span>
</span></span><span class=line><span class=cl>			<span class=nx>statuses</span><span class=p>[</span><span class=nx>pl</span><span class=p>.</span><span class=nf>Name</span><span class=p>()]</span> <span class=p>=</span> <span class=nx>pluginStatus</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>statuses</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>返回得状态是一个 Status 结构体，该结构体表示了插件运行的结果。由 <code>Code</code>、<code>reasons</code>、（可选）<code>err</code> 和 <code>failedPlugin</code> （失败的那个插件名）组成。当 <em>code</em> 不是 <code>Success</code> 时，应说明原因。而且，当 <em>code</em> 为 <code>Success</code> 时，其他所有字段都应为空。<code>nil</code> 状态也被视为成功。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Status</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>code</span>    <span class=nx>Code</span>
</span></span><span class=line><span class=cl>	<span class=nx>reasons</span> <span class=p>[]</span><span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=nx>err</span>     <span class=kt>error</span>
</span></span><span class=line><span class=cl>	<span class=c1>// failedPlugin is an optional field that records the plugin name a Pod failed by.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// It&#39;s set by the framework when code is Error, Unschedulable or UnschedulableAndUnresolvable.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>failedPlugin</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><h4 id=noderesourcesfit--supa-href55asup>NodeResourcesFit <sup><a href=#5>[5]</a></sup><a hidden class=anchor aria-hidden=true href=#noderesourcesfit--supa-href55asup>#</a></h4><p><code>NodeResourcesFit</code> 扩展检查节点是否拥有 Pod 请求的所有资源。分数可以使用以下三种策略之一，扩展点为：<code>preFilter</code>， <code>filter</code>，<code>score</code></p><ul><li><code>LeastAllocated</code> （默认）</li><li><code>MostAllocated</code></li><li><code>RequestedToCapacityRatio</code></li></ul><h4 id=fit>Fit<a hidden class=anchor aria-hidden=true href=#fit>#</a></h4><p><code>NodeResourcesFit </code>PreFilter 可以看到调用得 <code>computePodResourceRequest</code></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>text</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>// PreFilter invoked at the prefilter extension point.
</span></span><span class=line><span class=cl>func (f *Fit) PreFilter(ctx context.Context, cycleState *framework.CycleState, pod *v1.Pod) (*framework.PreFilterResult, *framework.Status) {
</span></span><span class=line><span class=cl>   cycleState.Write(preFilterStateKey, computePodResourceRequest(pod))
</span></span><span class=line><span class=cl>   return nil, nil
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div></div></div><p><a href=https://github.com/kubernetes/kubernetes/blob/32c483ea6ee90a3a81f382563c91034470af8a4a/pkg/scheduler/framework/plugins/noderesources/fit.go#L133-L175 target=_blank rel="noopener nofollow noreferrer">computePodResourceRequest</a> 这里有一个注释，总体解释起来是这样得：<code>computePodResourceRequest</code> ，返回值（ <code>framework.Resource</code>）覆盖了每一个维度中资源的最大宽度。因为将按照 <code>init-containers</code> , <code>containers</code> 得顺序运行，会通过迭代方式收集每个维度中的最大值。计算时会对常规容器的资源向量求和，因为<code>containers</code> 运行会同时运行多个容器。计算示例为：</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>yaml</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>Pod</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=l>InitContainers</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>IC1</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>CPU</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>Memory</span><span class=p>:</span><span class=w> </span><span class=l>1G</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>IC2</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>CPU</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>Memory</span><span class=p>:</span><span class=w> </span><span class=l>3G</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=l>Containers</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>C1</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>CPU</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>Memory</span><span class=p>:</span><span class=w> </span><span class=l>1G</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>C2</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>CPU</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>Memory</span><span class=p>:</span><span class=w> </span><span class=l>1G</span></span></span></code></pre></td></tr></table></div></div></div></div><p>在维度1中（<code>InitContainers</code>）所需资源最大值时，CPU=2, Memory=3G；而维度2（<code>Containers</code>）所需资源最大值为：CPU=2, Memory=1G；那么最终结果为 CPU=3, Memory=3G，因为在维度1，最大资源时Memory=3G；而维度2最大资源是CPU=1+2, Memory=1+1，取每个维度中最大资源最大宽度即为 CPU=3, Memory=3G。</p><p>下面则看下代码得实现</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>computePodResourceRequest</span><span class=p>(</span><span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)</span> <span class=o>*</span><span class=nx>preFilterState</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>result</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>preFilterState</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>container</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>pod</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Containers</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>result</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=nx>container</span><span class=p>.</span><span class=nx>Resources</span><span class=p>.</span><span class=nx>Requests</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 取最大得资源
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>container</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>pod</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>InitContainers</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>result</span><span class=p>.</span><span class=nf>SetMaxResource</span><span class=p>(</span><span class=nx>container</span><span class=p>.</span><span class=nx>Resources</span><span class=p>.</span><span class=nx>Requests</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 如果Overhead正在使用，需要将其计算到总资源中
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>pod</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Overhead</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>result</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=nx>pod</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Overhead</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>result</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// SetMaxResource 是比较ResourceList并为每个资源取最大值。
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>r</span> <span class=o>*</span><span class=nx>Resource</span><span class=p>)</span> <span class=nf>SetMaxResource</span><span class=p>(</span><span class=nx>rl</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>ResourceList</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>r</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>rName</span><span class=p>,</span> <span class=nx>rQuantity</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>rl</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>switch</span> <span class=nx>rName</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>ResourceMemory</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=nx>r</span><span class=p>.</span><span class=nx>Memory</span> <span class=p>=</span> <span class=nb>max</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>Memory</span><span class=p>,</span> <span class=nx>rQuantity</span><span class=p>.</span><span class=nf>Value</span><span class=p>())</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>ResourceCPU</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=nx>r</span><span class=p>.</span><span class=nx>MilliCPU</span> <span class=p>=</span> <span class=nb>max</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>MilliCPU</span><span class=p>,</span> <span class=nx>rQuantity</span><span class=p>.</span><span class=nf>MilliValue</span><span class=p>())</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>ResourceEphemeralStorage</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>utilfeature</span><span class=p>.</span><span class=nx>DefaultFeatureGate</span><span class=p>.</span><span class=nf>Enabled</span><span class=p>(</span><span class=nx>features</span><span class=p>.</span><span class=nx>LocalStorageCapacityIsolation</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>r</span><span class=p>.</span><span class=nx>EphemeralStorage</span> <span class=p>=</span> <span class=nb>max</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>EphemeralStorage</span><span class=p>,</span> <span class=nx>rQuantity</span><span class=p>.</span><span class=nf>Value</span><span class=p>())</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>schedutil</span><span class=p>.</span><span class=nf>IsScalarResourceName</span><span class=p>(</span><span class=nx>rName</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>r</span><span class=p>.</span><span class=nf>SetScalar</span><span class=p>(</span><span class=nx>rName</span><span class=p>,</span> <span class=nb>max</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>ScalarResources</span><span class=p>[</span><span class=nx>rName</span><span class=p>],</span> <span class=nx>rQuantity</span><span class=p>.</span><span class=nf>Value</span><span class=p>()))</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><h4 id=leastallocate>leastAllocate<a hidden class=anchor aria-hidden=true href=#leastallocate>#</a></h4><p>LeastAllocated 是 NodeResourcesFit 的打分策略 ，<code>LeastAllocated</code> 打分的标准是更偏向于请求资源较少的Node。将会先计算出Node上调度的pod请求的内存、CPU与其他资源的百分比，然后并根据请求的比例与容量的平均值的最小值进行优先级排序。</p><p>计算公式是这样的：$\frac{\frac{cpu((capacity-requested) \times MaxNodeScore \times cpuWeight)}{capacity} + \frac{memory((capacity-requested) \times MaxNodeScore \times memoryWeight}{capacity}) + &mldr;}{weightSum}$</p><p>下面来看下实现</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>leastResourceScorer</span><span class=p>(</span><span class=nx>resToWeightMap</span> <span class=nx>resourceToWeightMap</span><span class=p>)</span> <span class=kd>func</span><span class=p>(</span><span class=nx>resourceToValueMap</span><span class=p>,</span> <span class=nx>resourceToValueMap</span><span class=p>)</span> <span class=kt>int64</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kd>func</span><span class=p>(</span><span class=nx>requested</span><span class=p>,</span> <span class=nx>allocable</span> <span class=nx>resourceToValueMap</span><span class=p>)</span> <span class=kt>int64</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=kd>var</span> <span class=nx>nodeScore</span><span class=p>,</span> <span class=nx>weightSum</span> <span class=kt>int64</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=nx>resource</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>requested</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>weight</span> <span class=o>:=</span> <span class=nx>resToWeightMap</span><span class=p>[</span><span class=nx>resource</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=c1>//  计算出的资源分数乘weight
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>resourceScore</span> <span class=o>:=</span> <span class=nf>leastRequestedScore</span><span class=p>(</span><span class=nx>requested</span><span class=p>[</span><span class=nx>resource</span><span class=p>],</span> <span class=nx>allocable</span><span class=p>[</span><span class=nx>resource</span><span class=p>])</span>
</span></span><span class=line><span class=cl>			<span class=nx>nodeScore</span> <span class=o>+=</span> <span class=nx>resourceScore</span> <span class=o>*</span> <span class=nx>weight</span>
</span></span><span class=line><span class=cl>			<span class=nx>weightSum</span> <span class=o>+=</span> <span class=nx>weight</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>weightSum</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 最终除weightSum
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>return</span> <span class=nx>nodeScore</span> <span class=o>/</span> <span class=nx>weightSum</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>leastRequestedScore 计算标准为<strong>未使用容量</strong>的计算范围为 <code>0~MaxNodeScore</code>，0 为最低优先级，<code>MaxNodeScore</code> 为最高优先级。未使用的资源越多，得分越高。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>leastRequestedScore</span><span class=p>(</span><span class=nx>requested</span><span class=p>,</span> <span class=nx>capacity</span> <span class=kt>int64</span><span class=p>)</span> <span class=kt>int64</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>capacity</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>requested</span> <span class=p>&gt;</span> <span class=nx>capacity</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 容量 - 请求的 x 预期值（100）/ 容量
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>return</span> <span class=p>((</span><span class=nx>capacity</span> <span class=o>-</span> <span class=nx>requested</span><span class=p>)</span> <span class=o>*</span> <span class=nb>int64</span><span class=p>(</span><span class=nx>framework</span><span class=p>.</span><span class=nx>MaxNodeScore</span><span class=p>))</span> <span class=o>/</span> <span class=nx>capacity</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><h3 id=topology-supa-href66asup>Topology <sup><a href=#6>[6]</a></sup><a hidden class=anchor aria-hidden=true href=#topology-supa-href66asup>#</a></h3><h4 id=concept>Concept<a hidden class=anchor aria-hidden=true href=#concept>#</a></h4><p>在对 <code>podtopologyspread</code> 插件进行分析前，先需要掌握Pod拓扑的概念。</p><p>Pod拓扑（<code>Pod Topology</code>）是Kubernetes Pod调度机制，可以将Pod分布在集群中不同 <code>Zone</code> ，以及用户自定义的各种拓扑域 （<code>topology domains</code>）。当有了拓扑域后，用户可以更高效的利用集群资源。</p><p>如何来解释拓扑域，首先需要提及为什么需要拓扑域，在集群有3个节点，并且当Pod副本数为2时，又不希望两个Pod在同一个Node上运行。在随着扩大Pod的规模，副本数扩展到到15个时，这时候最理想的方式是每个Node运行5个Pod，在这种背景下，用户希望对集群中Zone的安排为相似的副本数量，并且在集群存在部分问题时可以更好的自愈（也是按照相似的副本数量均匀的分布在Node上）。在这种情况下Kubernetes 提供了Pod 拓扑约束来解决这个问题。</p><h4 id=定义一个topology>定义一个Topology<a hidden class=anchor aria-hidden=true href=#定义一个topology>#</a></h4><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>yaml</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>example-pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Configure a topology spread constraint</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>topologySpreadConstraints</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>maxSkew</span><span class=p>:</span><span class=w> </span><span class=l>&lt;integer&gt;</span><span class=w> </span><span class=c># </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>minDomains</span><span class=p>:</span><span class=w> </span><span class=l>&lt;integer&gt;</span><span class=w> </span><span class=c># optional; alpha since v1.24</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>topologyKey</span><span class=p>:</span><span class=w> </span><span class=l>&lt;string&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>whenUnsatisfiable</span><span class=p>:</span><span class=w> </span><span class=l>&lt;string&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labelSelector</span><span class=p>:</span><span class=w> </span><span class=l>&lt;object&gt;</span></span></span></code></pre></td></tr></table></div></div></div></div><p><strong>参数的描述</strong>：</p><ul><li><strong>maxSkew</strong>：Required，Pod分布不均的程度，并且数字必须大于零<ul><li>当 <code>whenUnsatisfiable: DoNotSchedule</code>，则定义目标拓扑中匹配 pod 的数量与 <strong>全局最小值</strong>（<em>拓扑域中的标签选择器匹配的 pod 的最小数量</em> ）<code>maxSkew</code>之间的最大允许差异。例如有 3 个 <code>Zone</code>，分别具有 2、4 和 5 个匹配的 pod，则全局最小值为 2</li><li>当 <code>whenUnsatisfiable: ScheduleAnyway</code>，<em>scheduler</em> 会为减少倾斜的拓扑提供更高的优先级。</li></ul></li><li><strong>minDomains</strong>：optional，符合条件的域的最小数量。<ul><li>如果不指定该选项 <code>minDomains</code>，则约束的行为 <code>minDomains: 1</code> 。</li><li><code>minDomains</code>必须大于 0。<code>minDomains</code>与 <code>whenUnsatisfiable</code> 一起时为<code>whenUnsatisfiable: DoNotSchedule</code>。</li></ul></li><li><strong>topologyKey</strong>：Node label的key，如果多个Node都使用了这个lable key那么 <em>scheduler</em> 将这些 Node 看作为相同的拓扑域。</li><li><strong>whenUnsatisfiable</strong>：当 Pod 不满足分布的约束时，怎么去处理<ul><li><code>DoNotSchedule</code>（默认）不要调度。</li><li><code>ScheduleAnyway</code>仍然调度它，同时优先考虑最小化倾斜节点</li></ul></li><li><strong>labelSelector</strong>：查找匹配的 Pod label选择器的node进行技术，以计算Pod如何分布在拓扑域中</li></ul><h4 id=对于拓扑域的理解>对于拓扑域的理解<a hidden class=anchor aria-hidden=true href=#对于拓扑域的理解>#</a></h4><p>对于拓扑域，官方是这么说明的，假设有一个带有以下lable的 4 节点集群：</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>NAME    STATUS   ROLES    AGE     VERSION   LABELS
</span></span><span class=line><span class=cl>node1   Ready    &lt;none&gt;   4m26s   v1.16.0   <span class=nv>node</span><span class=o>=</span>node1,zone<span class=o>=</span>zoneA
</span></span><span class=line><span class=cl>node2   Ready    &lt;none&gt;   3m58s   v1.16.0   <span class=nv>node</span><span class=o>=</span>node2,zone<span class=o>=</span>zoneA
</span></span><span class=line><span class=cl>node3   Ready    &lt;none&gt;   3m17s   v1.16.0   <span class=nv>node</span><span class=o>=</span>node3,zone<span class=o>=</span>zoneB
</span></span><span class=line><span class=cl>node4   Ready    &lt;none&gt;   2m43s   v1.16.0   <span class=nv>node</span><span class=o>=</span>node4,zone<span class=o>=</span>zoneB</span></span></code></pre></td></tr></table></div></div></div></div><p>那么集群拓扑如图：</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220725223516451.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220725223516451.png#center alt=image-20220725223516451 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><center class=podsc>图1：集群拓扑图</center><center><em>Source：</em>https://kubernetes.io/docs/concepts/scheduling-eviction/topology-spread-constraints/</center><p>假设一个 4 节点集群，其中 3个label被标记为<code>foo: bar</code>的 Pod 分别位于Node1、Node2 和 Node3：</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220725224602667.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220725224602667.png#center alt=image-20220725224602667 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><center class=podsc>图2：集群拓扑图</center><center><em>Source：</em>https://kubernetes.io/docs/concepts/scheduling-eviction/topology-spread-constraints/</center><p>这种情况下，新部署一个Pod，并希望新Pod与现有Pod跨 <code>Zone</code>均匀分布，资源清单文件如下：</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>yaml</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mypod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>foo</span><span class=p>:</span><span class=w> </span><span class=l>bar</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>topologySpreadConstraints</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>maxSkew</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>topologyKey</span><span class=p>:</span><span class=w> </span><span class=l>zone</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>whenUnsatisfiable</span><span class=p>:</span><span class=w> </span><span class=l>DoNotSchedule</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>labelSelector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>foo</span><span class=p>:</span><span class=w> </span><span class=l>bar</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pause</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>k8s.gcr.io/pause:3.1</span></span></span></code></pre></td></tr></table></div></div></div></div><p>这个清单对于拓扑域来说，<code>topologyKey: zone</code> 表示对Pod均匀分布仅应用于已标记的节点（如 <code>foo: bar</code>），将会跳过没有标签的节点（如<code>zone: &lt;any value></code>）。如果 <em>scheduler</em> 找不到满足约束的方法，<code>whenUnsatisfiable: DoNotSchedule</code> 设置的策略则是 <em>scheduler</em> 对新部署的Pod保持 <code>Pendding</code></p><p>如果此时 <em>scheduler</em> 将新Pod 调度至 $Zone_A$，此时Pod分布在拓扑域间为 $[3,1]$ ，而 <code>maxSkew</code> 配置的值是1。此时倾斜值为 $Zone_A - Zone_B = 3-1=2$，不满足 <code>maxSkew=1</code>，故这个Pod只能被调度到 $Zone_B$。</p><p>此时Pod调度拓扑图为图3或图4</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220725230358777.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220725230358777.png#center alt=image-20220725230358777 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><center class=podsc>图3：集群拓扑图</center><center><em>Source：</em>https://kubernetes.io/docs/concepts/scheduling-eviction/topology-spread-constraints/</center><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220725230515969.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220725230515969.png#center alt=image-20220725230515969 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><center class=podsc>图4：集群拓扑图</center><center><em>Source：</em>https://kubernetes.io/docs/concepts/scheduling-eviction/topology-spread-constraints/</center><p>如果需要将Pod调度到 $Zone_A$ ,可以按照如下方式进行：</p><ul><li>修改 <code>maxSkew=2</code></li><li>修改 <code>topologyKey: node</code> 而不是 <code>Zone</code> ，这种模式下可以将 Pod 均匀分布在Node而不是Zone之间。</li><li>修改 <code>whenUnsatisfiable: DoNotSchedule</code> 为 <code>whenUnsatisfiable: ScheduleAnyway</code> 确保新的Pod始终可被调度</li></ul><p>下面再通过一个例子增强对拓扑域了解</p><p><strong>多拓扑约束</strong></p><p>设拥有一个 4 节点集群，其中 3 个现有 Pod 标记 <code>foo: bar </code>分别位于 <code>node1</code>、<code>node2</code> 和 <code>node3</code></p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220725231905415.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220725231905415.png#center alt=image-20220725231905415 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><center class=podsc>图5：集群拓扑图</center><center><em>Source：</em>https://kubernetes.io/docs/concepts/scheduling-eviction/topology-spread-constraints/</center><p>部署的资源清单如下：可以看出拓扑分布约束配置了多个</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>yaml</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mypod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>foo</span><span class=p>:</span><span class=w> </span><span class=l>bar</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>topologySpreadConstraints</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>maxSkew</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>topologyKey</span><span class=p>:</span><span class=w> </span><span class=l>zone</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>whenUnsatisfiable</span><span class=p>:</span><span class=w> </span><span class=l>DoNotSchedule</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>labelSelector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>foo</span><span class=p>:</span><span class=w> </span><span class=l>bar</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>maxSkew</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>topologyKey</span><span class=p>:</span><span class=w> </span><span class=l>node</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>whenUnsatisfiable</span><span class=p>:</span><span class=w> </span><span class=l>DoNotSchedule</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>labelSelector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>foo</span><span class=p>:</span><span class=w> </span><span class=l>bar</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pause</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>k8s.gcr.io/pause:3.1</span></span></span></code></pre></td></tr></table></div></div></div></div><p>在这种情况下，为了匹配第一个约束条件，新Pod 只能放置在 $Zone_B$ ；而就第二个约束条件，新Pod只能调度到 <code>node4</code>。在这种配置多约束条件下， <em>scheduler</em> 只考虑满足所有约束的值，因此唯一有效的是 <code>node4</code>。</p><h4 id=如何为集群设置一个默认拓扑域约束>如何为集群设置一个默认拓扑域约束<a hidden class=anchor aria-hidden=true href=#如何为集群设置一个默认拓扑域约束>#</a></h4><p>默认情况下，拓扑域约束也作 <em>scheduler</em> 的为 <em>scheduler configurtion</em> 中的一部分参数，这也意味着，可以通过profile为整个集群级别指定一个默认的拓扑域调度约束，</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>yaml</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>kubescheduler.config.k8s.io/v1beta3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>KubeSchedulerConfiguration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>profiles</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>schedulerName</span><span class=p>:</span><span class=w> </span><span class=l>default-scheduler</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>pluginConfig</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>PodTopologySpread</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>defaultConstraints</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>maxSkew</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>topologyKey</span><span class=p>:</span><span class=w> </span><span class=l>topology.kubernetes.io/zone</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>whenUnsatisfiable</span><span class=p>:</span><span class=w> </span><span class=l>ScheduleAnyway</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>defaultingType</span><span class=p>:</span><span class=w> </span><span class=l>List</span></span></span></code></pre></td></tr></table></div></div></div></div><h4 id=默认约束策略>默认约束策略<a hidden class=anchor aria-hidden=true href=#默认约束策略>#</a></h4><p>如果在没有配置集群级别的约束策略时，<em>kube-scheduler</em> 内部 <code>topologyspread</code> 插件提供了一个默认的拓扑约束策略，大致上如下列清单所示</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>text</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>defaultConstraints:
</span></span><span class=line><span class=cl>  - maxSkew: 3
</span></span><span class=line><span class=cl>    topologyKey: &#34;kubernetes.io/hostname&#34;
</span></span><span class=line><span class=cl>    whenUnsatisfiable: ScheduleAnyway
</span></span><span class=line><span class=cl>  - maxSkew: 5
</span></span><span class=line><span class=cl>    topologyKey: &#34;topology.kubernetes.io/zone&#34;
</span></span><span class=line><span class=cl>    whenUnsatisfiable: ScheduleAnyway</span></span></code></pre></td></tr></table></div></div></div></div><p>上述清单中内容可以在 <a href=https://github.com/kubernetes/kubernetes/blob/32c483ea6ee90a3a81f382563c91034470af8a4a/pkg/scheduler/framework/plugins/podtopologyspread/plugin.go#L42-L53 target=_blank rel="noopener nofollow noreferrer">pkg\scheduler\framework\plugins\podtopologyspread\plugin.go</a></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>var</span> <span class=nx>systemDefaultConstraints</span> <span class=p>=</span> <span class=p>[]</span><span class=nx>v1</span><span class=p>.</span><span class=nx>TopologySpreadConstraint</span><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>TopologyKey</span><span class=p>:</span>       <span class=nx>v1</span><span class=p>.</span><span class=nx>LabelHostname</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>WhenUnsatisfiable</span><span class=p>:</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>ScheduleAnyway</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>MaxSkew</span><span class=p>:</span>           <span class=mi>3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>TopologyKey</span><span class=p>:</span>       <span class=nx>v1</span><span class=p>.</span><span class=nx>LabelTopologyZone</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>WhenUnsatisfiable</span><span class=p>:</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>ScheduleAnyway</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>MaxSkew</span><span class=p>:</span>           <span class=mi>5</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>可以通过在配置文件中留空，来禁用默认配置</p><ul><li><code>defaultConstraints: []</code></li><li><code>defaultingType: List</code></li></ul><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>yaml</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>kubescheduler.config.k8s.io/v1beta3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>KubeSchedulerConfiguration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>profiles</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>schedulerName</span><span class=p>:</span><span class=w> </span><span class=l>default-scheduler</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>pluginConfig</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>PodTopologySpread</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>defaultConstraints</span><span class=p>:</span><span class=w> </span><span class=p>[]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>defaultingType</span><span class=p>:</span><span class=w> </span><span class=l>List</span></span></span></code></pre></td></tr></table></div></div></div></div><h3 id=通过源码学习topology>通过源码学习Topology<a hidden class=anchor aria-hidden=true href=#通过源码学习topology>#</a></h3><p><code>podtopologyspread</code> 实现了4种扩展点方法，包含 <code>filter</code> 和 <code>score</code></p><h4 id=prefilter>PreFilter<a hidden class=anchor aria-hidden=true href=#prefilter>#</a></h4><p>可以看到 <code>PreFilter</code> 的核心为 <code>calPreFilterState</code></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>pl</span> <span class=o>*</span><span class=nx>PodTopologySpread</span><span class=p>)</span> <span class=nf>PreFilter</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>cycleState</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>CycleState</span><span class=p>,</span> <span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>PreFilterResult</span><span class=p>,</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>Status</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>s</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>pl</span><span class=p>.</span><span class=nf>calPreFilterState</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>pod</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>framework</span><span class=p>.</span><span class=nf>AsStatus</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>cycleState</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span><span class=nx>preFilterStateKey</span><span class=p>,</span> <span class=nx>s</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p><a href=https://github.com/kubernetes/kubernetes/blob/32c483ea6ee90a3a81f382563c91034470af8a4a/pkg/scheduler/framework/plugins/podtopologyspread/filtering.go#L225-L307 target=_blank rel="noopener nofollow noreferrer">calPreFilterState</a> 主要功能是用在计算如何在拓扑域中分布Pod，首先看段代码时，需要掌握下属几个概念</p><ul><li><a href=#preFilterState>preFilterState</a></li><li><a href=#criticalPaths>criticalPaths</a></li><li><a href=#update>update</a></li></ul><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>pl</span> <span class=o>*</span><span class=nx>PodTopologySpread</span><span class=p>)</span> <span class=nf>calPreFilterState</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>preFilterState</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 获取Node
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>allNodes</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>pl</span><span class=p>.</span><span class=nx>sharedLister</span><span class=p>.</span><span class=nf>NodeInfos</span><span class=p>().</span><span class=nf>List</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;listing NodeInfos: %w&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>constraints</span> <span class=p>[]</span><span class=nx>topologySpreadConstraint</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>pod</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>TopologySpreadConstraints</span><span class=p>)</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 这里会构建出TopologySpreadConstraints，因为约束是不确定的
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>constraints</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nf>filterTopologySpreadConstraints</span><span class=p>(</span>
</span></span><span class=line><span class=cl>			<span class=nx>pod</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>TopologySpreadConstraints</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>v1</span><span class=p>.</span><span class=nx>DoNotSchedule</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>pl</span><span class=p>.</span><span class=nx>enableMinDomainsInPodTopologySpread</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>pl</span><span class=p>.</span><span class=nx>enableNodeInclusionPolicyInPodTopologySpread</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;obtaining pod&#39;s hard topology spread constraints: %w&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// buildDefaultConstraints使用&#34;.DefaultConstraints&#34;与pod匹配的
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// service、replication controllers、replica sets 
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// 和stateful sets的选择器为pod构建一个约束。
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>constraints</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>pl</span><span class=p>.</span><span class=nf>buildDefaultConstraints</span><span class=p>(</span><span class=nx>pod</span><span class=p>,</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>DoNotSchedule</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;setting default hard topology spread constraints: %w&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>constraints</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span> <span class=c1>// 如果是空的，则返回空preFilterState
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>return</span> <span class=o>&amp;</span><span class=nx>preFilterState</span><span class=p>{},</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 初始化一个 preFilterState 状态
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>s</span> <span class=o>:=</span> <span class=nx>preFilterState</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>Constraints</span><span class=p>:</span>          <span class=nx>constraints</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>TpKeyToCriticalPaths</span><span class=p>:</span> <span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=o>*</span><span class=nx>criticalPaths</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>constraints</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>		<span class=nx>TpPairToMatchNum</span><span class=p>:</span>     <span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=nx>topologyPair</span><span class=p>]</span><span class=kt>int</span><span class=p>,</span> <span class=nf>sizeHeuristic</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=nx>allNodes</span><span class=p>),</span> <span class=nx>constraints</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 根据node统计拓扑域数量
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>tpCountsByNode</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=kd>map</span><span class=p>[</span><span class=nx>topologyPair</span><span class=p>]</span><span class=kt>int</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>allNodes</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 获取pod亲和度配置
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>requiredNodeAffinity</span> <span class=o>:=</span> <span class=nx>nodeaffinity</span><span class=p>.</span><span class=nf>GetRequiredNodeAffinity</span><span class=p>(</span><span class=nx>pod</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>processNode</span> <span class=o>:=</span> <span class=kd>func</span><span class=p>(</span><span class=nx>i</span> <span class=kt>int</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>nodeInfo</span> <span class=o>:=</span> <span class=nx>allNodes</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>		<span class=nx>node</span> <span class=o>:=</span> <span class=nx>nodeInfo</span><span class=p>.</span><span class=nf>Node</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>node</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>klog</span><span class=p>.</span><span class=nf>ErrorS</span><span class=p>(</span><span class=kc>nil</span><span class=p>,</span> <span class=s>&#34;Node not found&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 通过spreading去过滤node以用作filters，错误解析以向后兼容
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=p>!</span><span class=nx>pl</span><span class=p>.</span><span class=nx>enableNodeInclusionPolicyInPodTopologySpread</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>match</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>requiredNodeAffinity</span><span class=p>.</span><span class=nf>Match</span><span class=p>(</span><span class=nx>node</span><span class=p>);</span> <span class=p>!</span><span class=nx>match</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// 确保node的lable 包含topologyKeys定义的值
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=p>!</span><span class=nf>nodeLabelsMatchSpreadConstraints</span><span class=p>(</span><span class=nx>node</span><span class=p>.</span><span class=nx>Labels</span><span class=p>,</span> <span class=nx>constraints</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>tpCounts</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=nx>topologyPair</span><span class=p>]</span><span class=kt>int</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>constraints</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>c</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>constraints</span> <span class=p>{</span> <span class=c1>// 对应的约束列表
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>if</span> <span class=nx>pl</span><span class=p>.</span><span class=nx>enableNodeInclusionPolicyInPodTopologySpread</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>				<span class=p>!</span><span class=nx>c</span><span class=p>.</span><span class=nf>matchNodeInclusionPolicies</span><span class=p>(</span><span class=nx>pod</span><span class=p>,</span> <span class=nx>node</span><span class=p>,</span> <span class=nx>requiredNodeAffinity</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>continue</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=c1>// 构建出 topologyPair 以key value形式，
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// 通常情况下TopologyKey属于什么类型的拓扑
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>//  node.Labels[c.TopologyKey] 则是属于这个拓扑中那个子域
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>pair</span> <span class=o>:=</span> <span class=nx>topologyPair</span><span class=p>{</span><span class=nx>key</span><span class=p>:</span> <span class=nx>c</span><span class=p>.</span><span class=nx>TopologyKey</span><span class=p>,</span> <span class=nx>value</span><span class=p>:</span> <span class=nx>node</span><span class=p>.</span><span class=nx>Labels</span><span class=p>[</span><span class=nx>c</span><span class=p>.</span><span class=nx>TopologyKey</span><span class=p>]}</span>
</span></span><span class=line><span class=cl>			<span class=c1>// 计算与标签选择器相匹配的pod有多少个
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>count</span> <span class=o>:=</span> <span class=nf>countPodsMatchSelector</span><span class=p>(</span><span class=nx>nodeInfo</span><span class=p>.</span><span class=nx>Pods</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>Selector</span><span class=p>,</span> <span class=nx>pod</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=nx>tpCounts</span><span class=p>[</span><span class=nx>pair</span><span class=p>]</span> <span class=p>=</span> <span class=nx>count</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>tpCountsByNode</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=p>=</span> <span class=nx>tpCounts</span> <span class=c1>// 最终形成的拓扑结构
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 执行上面的定义的processNode，执行的数量就是node的数量
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>pl</span><span class=p>.</span><span class=nx>parallelizer</span><span class=p>.</span><span class=nf>Until</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>allNodes</span><span class=p>),</span> <span class=nx>processNode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 最后构建出 TpPairToMatchNum
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// 表示每个拓扑域中的每个子域各分布多少Pod，如图6所示
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>tpCounts</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>tpCountsByNode</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=nx>tp</span><span class=p>,</span> <span class=nx>count</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>tpCounts</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>s</span><span class=p>.</span><span class=nx>TpPairToMatchNum</span><span class=p>[</span><span class=nx>tp</span><span class=p>]</span> <span class=o>+=</span> <span class=nx>count</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>pl</span><span class=p>.</span><span class=nx>enableMinDomainsInPodTopologySpread</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 根据状态进行构建 preFilterState
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>s</span><span class=p>.</span><span class=nx>TpKeyToDomainsNum</span> <span class=p>=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>int</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>constraints</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=nx>tp</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>s</span><span class=p>.</span><span class=nx>TpPairToMatchNum</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>s</span><span class=p>.</span><span class=nx>TpKeyToDomainsNum</span><span class=p>[</span><span class=nx>tp</span><span class=p>.</span><span class=nx>key</span><span class=p>]</span><span class=o>++</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 计算最小匹配出的拓扑对
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=p>&lt;</span> <span class=nb>len</span><span class=p>(</span><span class=nx>constraints</span><span class=p>);</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>key</span> <span class=o>:=</span> <span class=nx>constraints</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>TopologyKey</span>
</span></span><span class=line><span class=cl>		<span class=nx>s</span><span class=p>.</span><span class=nx>TpKeyToCriticalPaths</span><span class=p>[</span><span class=nx>key</span><span class=p>]</span> <span class=p>=</span> <span class=nf>newCriticalPaths</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>pair</span><span class=p>,</span> <span class=nx>num</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>s</span><span class=p>.</span><span class=nx>TpPairToMatchNum</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>s</span><span class=p>.</span><span class=nx>TpKeyToCriticalPaths</span><span class=p>[</span><span class=nx>pair</span><span class=p>.</span><span class=nx>key</span><span class=p>].</span><span class=nf>update</span><span class=p>(</span><span class=nx>pair</span><span class=p>.</span><span class=nx>value</span><span class=p>,</span> <span class=nx>num</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=o>&amp;</span><span class=nx>s</span><span class=p>,</span> <span class=kc>nil</span> <span class=c1>// 返回的值则包含最小的分布
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p class=preFilterState>preFilterState</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// preFilterState 是在PreFilter处计算并在Filter处使用。
</span></span></span><span class=line><span class=cl><span class=c1>// 它结合了 “TpKeyToCriticalPaths” 和 “TpPairToMatchNum” 来表示：
</span></span></span><span class=line><span class=cl><span class=c1>//（1）在每个分布约束上匹配最少pod的criticalPaths。 
</span></span></span><span class=line><span class=cl><span class=c1>// (2) 在每个分布约束上匹配的pod的数量。
</span></span></span><span class=line><span class=cl><span class=c1>// “nil preFilterState” 则表示没有设置（在PreFilter阶段）；
</span></span></span><span class=line><span class=cl><span class=c1>// empty “preFilterState”对象则表示它是一个合法的状态，并在PreFilter阶段设置。
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>preFilterState</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>Constraints</span> <span class=p>[]</span><span class=nx>topologySpreadConstraint</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 这里记录2条关键路径而不是所有关键路径。 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// criticalPaths[0].MatchNum 始终保存最小匹配数。 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// criticalPaths[1].MatchNum 总是大于或等于criticalPaths[0].MatchNum，但不能保证是第二个最小匹配数。
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>TpKeyToCriticalPaths</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=o>*</span><span class=nx>criticalPaths</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>    <span class=c1>// TpKeyToDomainsNum 以 “topologyKey” 作为key ，并以zone的数量作为值。
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>TpKeyToDomainsNum</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>int</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>    <span class=c1>// TpPairToMatchNum 以 “topologyPair作为key” ，并以匹配到pod的数量作为value。
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>TpPairToMatchNum</span> <span class=kd>map</span><span class=p>[</span><span class=nx>topologyPair</span><span class=p>]</span><span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p class=criticalPaths>criticalPaths</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// [2]criticalPath能够工作的原因是基于当前抢占算法的实现，特别是以下两个事实
</span></span></span><span class=line><span class=cl><span class=c1>// 事实 1：只抢占同一节点上的Pod，而不是多个节点上的 Pod。
</span></span></span><span class=line><span class=cl><span class=c1>// 事实 2：每个节点在其抢占周期期间在“preFilterState”的单独副本上进行评估。如果我们计划转向更复杂的算法，例如“多个节点上的任意pod”时则需要重新考虑这种结构。
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>criticalPaths</span> <span class=p>[</span><span class=mi>2</span><span class=p>]</span><span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// TopologyValue代表映射到拓扑键的拓扑值。
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>TopologyValue</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=c1>// MatchNum代表匹配到的pod数量
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>MatchNum</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>单元测试中的测试案例，具有两个约束条件的场景，通过表格来解析如下：</p><p>Node列表与标签如下表：</p><table><thead><tr><th>Node Name</th><th>&#x1f3f7;&#xfe0f;Lable-zone</th><th>&#x1f3f7;&#xfe0f;Lable-node</th></tr></thead><tbody><tr><td>node-a</td><td>zone1</td><td>node-a</td></tr><tr><td>node-b</td><td>zone1</td><td>node-b</td></tr><tr><td>node-x</td><td>zone2</td><td>node-x</td></tr><tr><td>node-y</td><td>zone2</td><td>node-y</td></tr></tbody></table><p>Pod列表与标签如下表：</p><table><thead><tr><th>Pod Name</th><th>Node</th><th>&#x1f3f7;&#xfe0f;Label</th></tr></thead><tbody><tr><td>p-a1</td><td>node-a</td><td>foo:</td></tr><tr><td>p-a2</td><td>node-a</td><td>foo:</td></tr><tr><td>p-b1</td><td>node-b</td><td>foo:</td></tr><tr><td>p-y1</td><td>node-y</td><td>foo:</td></tr><tr><td>p-y2</td><td>node-y</td><td>foo:</td></tr><tr><td>p-y3</td><td>node-y</td><td>foo:</td></tr><tr><td>p-y4</td><td>node-y</td><td>foo:</td></tr></tbody></table><p>对应的拓扑约束</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>yaml</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>topologySpreadConstraints</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>MaxSkew</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nt>TopologyKey</span><span class=p>:</span><span class=w> </span><span class=l>zone</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nt>labelSelector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	  </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	    </span><span class=nt>foo</span><span class=p>:</span><span class=w> </span><span class=l>bar</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nt>MinDomains</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nt>NodeAffinityPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Honor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nt>NodeTaintsPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Ignore</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>MaxSkew</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nt>TopologyKey</span><span class=p>:</span><span class=w> </span><span class=l>node</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nt>labelSelector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	  </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	    </span><span class=nt>foo</span><span class=p>:</span><span class=w> </span><span class=l>bar</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nt>MinDomains</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nt>NodeAffinityPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Honor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nt>NodeTaintsPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Ignore</span></span></span></code></pre></td></tr></table></div></div></div></div><p>那么整个分布如下：</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220726214255638.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220726214255638.png#center alt=image-20220726214255638 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><center class=podsc>图6：具有两个场景的分布图</center><p id=prefiltertesting>实现的测试代码如下</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>name</span><span class=p>:</span> <span class=s>&#34;normal case with two spreadConstraints&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>pod</span><span class=p>:</span> <span class=nx>st</span><span class=p>.</span><span class=nf>MakePod</span><span class=p>().</span><span class=nf>Name</span><span class=p>(</span><span class=s>&#34;p&#34;</span><span class=p>).</span><span class=nf>Label</span><span class=p>(</span><span class=s>&#34;foo&#34;</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>).</span>
</span></span><span class=line><span class=cl>    <span class=nf>SpreadConstraint</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=s>&#34;zone&#34;</span><span class=p>,</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>DoNotSchedule</span><span class=p>,</span> <span class=nx>fooSelector</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=kc>nil</span><span class=p>).</span>
</span></span><span class=line><span class=cl>    <span class=nf>SpreadConstraint</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=s>&#34;node&#34;</span><span class=p>,</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>DoNotSchedule</span><span class=p>,</span> <span class=nx>fooSelector</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=kc>nil</span><span class=p>).</span>
</span></span><span class=line><span class=cl>    <span class=nf>Obj</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=nx>nodes</span><span class=p>:</span> <span class=p>[]</span><span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Node</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>st</span><span class=p>.</span><span class=nf>MakeNode</span><span class=p>().</span><span class=nf>Name</span><span class=p>(</span><span class=s>&#34;node-a&#34;</span><span class=p>).</span><span class=nf>Label</span><span class=p>(</span><span class=s>&#34;zone&#34;</span><span class=p>,</span> <span class=s>&#34;zone1&#34;</span><span class=p>).</span><span class=nf>Label</span><span class=p>(</span><span class=s>&#34;node&#34;</span><span class=p>,</span> <span class=s>&#34;node-a&#34;</span><span class=p>).</span><span class=nf>Obj</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=nx>st</span><span class=p>.</span><span class=nf>MakeNode</span><span class=p>().</span><span class=nf>Name</span><span class=p>(</span><span class=s>&#34;node-b&#34;</span><span class=p>).</span><span class=nf>Label</span><span class=p>(</span><span class=s>&#34;zone&#34;</span><span class=p>,</span> <span class=s>&#34;zone1&#34;</span><span class=p>).</span><span class=nf>Label</span><span class=p>(</span><span class=s>&#34;node&#34;</span><span class=p>,</span> <span class=s>&#34;node-b&#34;</span><span class=p>).</span><span class=nf>Obj</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=nx>st</span><span class=p>.</span><span class=nf>MakeNode</span><span class=p>().</span><span class=nf>Name</span><span class=p>(</span><span class=s>&#34;node-x&#34;</span><span class=p>).</span><span class=nf>Label</span><span class=p>(</span><span class=s>&#34;zone&#34;</span><span class=p>,</span> <span class=s>&#34;zone2&#34;</span><span class=p>).</span><span class=nf>Label</span><span class=p>(</span><span class=s>&#34;node&#34;</span><span class=p>,</span> <span class=s>&#34;node-x&#34;</span><span class=p>).</span><span class=nf>Obj</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=nx>st</span><span class=p>.</span><span class=nf>MakeNode</span><span class=p>().</span><span class=nf>Name</span><span class=p>(</span><span class=s>&#34;node-y&#34;</span><span class=p>).</span><span class=nf>Label</span><span class=p>(</span><span class=s>&#34;zone&#34;</span><span class=p>,</span> <span class=s>&#34;zone2&#34;</span><span class=p>).</span><span class=nf>Label</span><span class=p>(</span><span class=s>&#34;node&#34;</span><span class=p>,</span> <span class=s>&#34;node-y&#34;</span><span class=p>).</span><span class=nf>Obj</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>existingPods</span><span class=p>:</span> <span class=p>[]</span><span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>st</span><span class=p>.</span><span class=nf>MakePod</span><span class=p>().</span><span class=nf>Name</span><span class=p>(</span><span class=s>&#34;p-a1&#34;</span><span class=p>).</span><span class=nf>Node</span><span class=p>(</span><span class=s>&#34;node-a&#34;</span><span class=p>).</span><span class=nf>Label</span><span class=p>(</span><span class=s>&#34;foo&#34;</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>).</span><span class=nf>Obj</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=nx>st</span><span class=p>.</span><span class=nf>MakePod</span><span class=p>().</span><span class=nf>Name</span><span class=p>(</span><span class=s>&#34;p-a2&#34;</span><span class=p>).</span><span class=nf>Node</span><span class=p>(</span><span class=s>&#34;node-a&#34;</span><span class=p>).</span><span class=nf>Label</span><span class=p>(</span><span class=s>&#34;foo&#34;</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>).</span><span class=nf>Obj</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=nx>st</span><span class=p>.</span><span class=nf>MakePod</span><span class=p>().</span><span class=nf>Name</span><span class=p>(</span><span class=s>&#34;p-b1&#34;</span><span class=p>).</span><span class=nf>Node</span><span class=p>(</span><span class=s>&#34;node-b&#34;</span><span class=p>).</span><span class=nf>Label</span><span class=p>(</span><span class=s>&#34;foo&#34;</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>).</span><span class=nf>Obj</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=nx>st</span><span class=p>.</span><span class=nf>MakePod</span><span class=p>().</span><span class=nf>Name</span><span class=p>(</span><span class=s>&#34;p-y1&#34;</span><span class=p>).</span><span class=nf>Node</span><span class=p>(</span><span class=s>&#34;node-y&#34;</span><span class=p>).</span><span class=nf>Label</span><span class=p>(</span><span class=s>&#34;foo&#34;</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>).</span><span class=nf>Obj</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=nx>st</span><span class=p>.</span><span class=nf>MakePod</span><span class=p>().</span><span class=nf>Name</span><span class=p>(</span><span class=s>&#34;p-y2&#34;</span><span class=p>).</span><span class=nf>Node</span><span class=p>(</span><span class=s>&#34;node-y&#34;</span><span class=p>).</span><span class=nf>Label</span><span class=p>(</span><span class=s>&#34;foo&#34;</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>).</span><span class=nf>Obj</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=nx>st</span><span class=p>.</span><span class=nf>MakePod</span><span class=p>().</span><span class=nf>Name</span><span class=p>(</span><span class=s>&#34;p-y3&#34;</span><span class=p>).</span><span class=nf>Node</span><span class=p>(</span><span class=s>&#34;node-y&#34;</span><span class=p>).</span><span class=nf>Label</span><span class=p>(</span><span class=s>&#34;foo&#34;</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>).</span><span class=nf>Obj</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=nx>st</span><span class=p>.</span><span class=nf>MakePod</span><span class=p>().</span><span class=nf>Name</span><span class=p>(</span><span class=s>&#34;p-y4&#34;</span><span class=p>).</span><span class=nf>Node</span><span class=p>(</span><span class=s>&#34;node-y&#34;</span><span class=p>).</span><span class=nf>Label</span><span class=p>(</span><span class=s>&#34;foo&#34;</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>).</span><span class=nf>Obj</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>want</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>preFilterState</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>Constraints</span><span class=p>:</span> <span class=p>[]</span><span class=nx>topologySpreadConstraint</span><span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>MaxSkew</span><span class=p>:</span>            <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nx>TopologyKey</span><span class=p>:</span>        <span class=s>&#34;zone&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nx>Selector</span><span class=p>:</span>           <span class=nf>mustConvertLabelSelectorAsSelector</span><span class=p>(</span><span class=nx>t</span><span class=p>,</span> <span class=nx>fooSelector</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=nx>MinDomains</span><span class=p>:</span>         <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nx>NodeAffinityPolicy</span><span class=p>:</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>NodeInclusionPolicyHonor</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nx>NodeTaintsPolicy</span><span class=p>:</span>   <span class=nx>v1</span><span class=p>.</span><span class=nx>NodeInclusionPolicyIgnore</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>MaxSkew</span><span class=p>:</span>            <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nx>TopologyKey</span><span class=p>:</span>        <span class=s>&#34;node&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nx>Selector</span><span class=p>:</span>           <span class=nf>mustConvertLabelSelectorAsSelector</span><span class=p>(</span><span class=nx>t</span><span class=p>,</span> <span class=nx>fooSelector</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=nx>MinDomains</span><span class=p>:</span>         <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nx>NodeAffinityPolicy</span><span class=p>:</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>NodeInclusionPolicyHonor</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nx>NodeTaintsPolicy</span><span class=p>:</span>   <span class=nx>v1</span><span class=p>.</span><span class=nx>NodeInclusionPolicyIgnore</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=nx>TpKeyToCriticalPaths</span><span class=p>:</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=o>*</span><span class=nx>criticalPaths</span><span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;zone&#34;</span><span class=p>:</span> <span class=p>{{</span><span class=s>&#34;zone1&#34;</span><span class=p>,</span> <span class=mi>3</span><span class=p>},</span> <span class=p>{</span><span class=s>&#34;zone2&#34;</span><span class=p>,</span> <span class=mi>4</span><span class=p>}},</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;node&#34;</span><span class=p>:</span> <span class=p>{{</span><span class=s>&#34;node-x&#34;</span><span class=p>,</span> <span class=mi>0</span><span class=p>},</span> <span class=p>{</span><span class=s>&#34;node-b&#34;</span><span class=p>,</span> <span class=mi>1</span><span class=p>}},</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=nx>pair</span><span class=p>,</span> <span class=nx>num</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>s</span><span class=p>.</span><span class=nx>TpPairToMatchNum</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>s</span><span class=p>.</span><span class=nx>TpKeyToCriticalPaths</span><span class=p>[</span><span class=nx>pair</span><span class=p>.</span><span class=nx>key</span><span class=p>].</span><span class=nf>update</span><span class=p>(</span><span class=nx>pair</span><span class=p>.</span><span class=nx>value</span><span class=p>,</span> <span class=nx>num</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nx>TpPairToMatchNum</span><span class=p>:</span> <span class=kd>map</span><span class=p>[</span><span class=nx>topologyPair</span><span class=p>]</span><span class=kt>int</span><span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span><span class=nx>key</span><span class=p>:</span> <span class=s>&#34;zone&#34;</span><span class=p>,</span> <span class=nx>value</span><span class=p>:</span> <span class=s>&#34;zone1&#34;</span><span class=p>}:</span>  <span class=mi>3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span><span class=nx>key</span><span class=p>:</span> <span class=s>&#34;zone&#34;</span><span class=p>,</span> <span class=nx>value</span><span class=p>:</span> <span class=s>&#34;zone2&#34;</span><span class=p>}:</span>  <span class=mi>4</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span><span class=nx>key</span><span class=p>:</span> <span class=s>&#34;node&#34;</span><span class=p>,</span> <span class=nx>value</span><span class=p>:</span> <span class=s>&#34;node-a&#34;</span><span class=p>}:</span> <span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span><span class=nx>key</span><span class=p>:</span> <span class=s>&#34;node&#34;</span><span class=p>,</span> <span class=nx>value</span><span class=p>:</span> <span class=s>&#34;node-b&#34;</span><span class=p>}:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span><span class=nx>key</span><span class=p>:</span> <span class=s>&#34;node&#34;</span><span class=p>,</span> <span class=nx>value</span><span class=p>:</span> <span class=s>&#34;node-x&#34;</span><span class=p>}:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span><span class=nx>key</span><span class=p>:</span> <span class=s>&#34;node&#34;</span><span class=p>,</span> <span class=nx>value</span><span class=p>:</span> <span class=s>&#34;node-y&#34;</span><span class=p>}:</span> <span class=mi>4</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=o>...</span></span></span></code></pre></td></tr></table></div></div></div></div><p class=update>update</p><p><a href=https://github.com/kubernetes/kubernetes/blob/32c483ea6ee90a3a81f382563c91034470af8a4a/pkg/scheduler/framework/plugins/podtopologyspread/filtering.go#L120-L148 target=_blank rel="noopener nofollow noreferrer">update</a> 函数实际上时用于计算 <a href=#criticalPaths>criticalPaths</a> 中的第一位始终保持为是一个最小Pod匹配值</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>p</span> <span class=o>*</span><span class=nx>criticalPaths</span><span class=p>)</span> <span class=nf>update</span><span class=p>(</span><span class=nx>tpVal</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>num</span> <span class=kt>int</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// first verify if `tpVal` exists or not
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>i</span> <span class=o>:=</span> <span class=o>-</span><span class=mi>1</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>tpVal</span> <span class=o>==</span> <span class=nx>p</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>TopologyValue</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>i</span> <span class=p>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=nx>tpVal</span> <span class=o>==</span> <span class=nx>p</span><span class=p>[</span><span class=mi>1</span><span class=p>].</span><span class=nx>TopologyValue</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>i</span> <span class=p>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>i</span> <span class=o>&gt;=</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// `tpVal` 表示已经存在
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>p</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>MatchNum</span> <span class=p>=</span> <span class=nx>num</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>p</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>MatchNum</span> <span class=p>&gt;</span> <span class=nx>p</span><span class=p>[</span><span class=mi>1</span><span class=p>].</span><span class=nx>MatchNum</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// swap paths[0] and paths[1]
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>p</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=nx>p</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=p>=</span> <span class=nx>p</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=nx>p</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// `tpVal` 表示不存在，如一个新初始化的值
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// num对应子域分布的pod
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// 说明第一个元素不是最小的，则作为交换
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nx>num</span> <span class=p>&lt;</span> <span class=nx>p</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>MatchNum</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// update paths[1] with paths[0]
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>p</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=p>=</span> <span class=nx>p</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>			<span class=c1>// update paths[0]
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>p</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>TopologyValue</span><span class=p>,</span> <span class=nx>p</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>MatchNum</span> <span class=p>=</span> <span class=nx>tpVal</span><span class=p>,</span> <span class=nx>num</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=nx>num</span> <span class=p>&lt;</span> <span class=nx>p</span><span class=p>[</span><span class=mi>1</span><span class=p>].</span><span class=nx>MatchNum</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// 如果小于 paths[1]，则更新它，永远保证元素0是最小，1是次小的
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>p</span><span class=p>[</span><span class=mi>1</span><span class=p>].</span><span class=nx>TopologyValue</span><span class=p>,</span> <span class=nx>p</span><span class=p>[</span><span class=mi>1</span><span class=p>].</span><span class=nx>MatchNum</span> <span class=p>=</span> <span class=nx>tpVal</span><span class=p>,</span> <span class=nx>num</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>综合来讲 <code>Prefilter</code> 主要做的工作是。循环所有的节点，先根据 <code>NodeAffinity</code> 或者 <code>NodeSelector</code> 进行过滤，然后根据约束中定义的 <code>topologyKeys</code> （拓扑划分的依据） 来选择节点。</p><p>接下来会计算出每个拓扑域下的拓扑对（可以理解为子域）匹配的 Pod 数量，存入 <code>TpPairToMatchNum</code> 中，最后就是要把所有约束中匹配的 Pod 数量最小（第二小）匹配出来的路径（代码是这么定义的，理解上可以看作是分布图）放入 <code>TpKeyToCriticalPaths</code> 中保存起来。整个 <code>preFilterState</code> 保存下来传递到后续的 <code>filter</code> 插件中使用。</p><h4 id=filter>Filter<a hidden class=anchor aria-hidden=true href=#filter>#</a></h4><p>在 <a href=https://github.com/kubernetes/kubernetes/blob/32c483ea6ee90a3a81f382563c91034470af8a4a/pkg/scheduler/framework/plugins/podtopologyspread/filtering.go#L178 target=_blank rel="noopener nofollow noreferrer">preFilter</a> 中 最后的计算结果会保存在 <code>CycleState</code> 中</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>cycleState</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span><span class=nx>preFilterStateKey</span><span class=p>,</span> <span class=nx>s</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div></div></div><p><a href=https://github.com/kubernetes/kubernetes/blob/32c483ea6ee90a3a81f382563c91034470af8a4a/pkg/scheduler/framework/plugins/podtopologyspread/filtering.go#L310-L362 target=_blank rel="noopener nofollow noreferrer">Filter</a> 主要是从 <code>PreFilter</code> 处理的过程中拿到状态 <code>preFilterState</code>，然后看下每个拓扑约束中的 <code>MaxSkew</code> 是否合法，具体的计算公式为：$matchNum + selfMatchNum - minMatchNum$</p><ul><li><code>matchNum</code>：Prefilter 中计算出的对应的拓扑分布数量，可以在<a href=#prefiltertesting>Prefilter</a>中参考对应的内容<ul><li><code>if tpCount, ok := s.TpPairToMatchNum[pair]; ok {</code></li></ul></li><li><code>selfMatchNum</code>：匹配到label的数量，匹配到则是1，否则为0</li><li><code>minMatchNum</code>：获的 <code>Prefilter </code>中计算出来的最小匹配的值</li></ul><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>pl</span> <span class=o>*</span><span class=nx>PodTopologySpread</span><span class=p>)</span> <span class=nf>Filter</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>cycleState</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>CycleState</span><span class=p>,</span> <span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>,</span> <span class=nx>nodeInfo</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>NodeInfo</span><span class=p>)</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>Status</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>node</span> <span class=o>:=</span> <span class=nx>nodeInfo</span><span class=p>.</span><span class=nf>Node</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>node</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>framework</span><span class=p>.</span><span class=nf>AsStatus</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;node not found&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 拿到 prefilter处理的s，即preFilterState
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>s</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>getPreFilterState</span><span class=p>(</span><span class=nx>cycleState</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>framework</span><span class=p>.</span><span class=nf>AsStatus</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 一个 空类型的 preFilterState是合法的，这种情况下将容忍每一个被调度的 Pod
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>s</span><span class=p>.</span><span class=nx>Constraints</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>podLabelSet</span> <span class=o>:=</span> <span class=nx>labels</span><span class=p>.</span><span class=nf>Set</span><span class=p>(</span><span class=nx>pod</span><span class=p>.</span><span class=nx>Labels</span><span class=p>)</span> <span class=c1>// 设置标签
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>c</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>s</span><span class=p>.</span><span class=nx>Constraints</span> <span class=p>{</span> <span class=c1>// 因为拓扑约束允许多个所以
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>tpKey</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>TopologyKey</span>
</span></span><span class=line><span class=cl>		<span class=nx>tpVal</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>node</span><span class=p>.</span><span class=nx>Labels</span><span class=p>[</span><span class=nx>c</span><span class=p>.</span><span class=nx>TopologyKey</span><span class=p>]</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>5</span><span class=p>).</span><span class=nf>InfoS</span><span class=p>(</span><span class=s>&#34;Node doesn&#39;t have required label&#34;</span><span class=p>,</span> <span class=s>&#34;node&#34;</span><span class=p>,</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>KObj</span><span class=p>(</span><span class=nx>node</span><span class=p>),</span> <span class=s>&#34;label&#34;</span><span class=p>,</span> <span class=nx>tpKey</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>framework</span><span class=p>.</span><span class=nf>NewStatus</span><span class=p>(</span><span class=nx>framework</span><span class=p>.</span><span class=nx>UnschedulableAndUnresolvable</span><span class=p>,</span> <span class=nx>ErrReasonNodeLabelNotMatch</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// 判断标准
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// 现有的匹配数量 + 子匹配（1|0） - 全局minimum &lt;= maxSkew
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>minMatchNum</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nf>minMatchNum</span><span class=p>(</span><span class=nx>tpKey</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>MinDomains</span><span class=p>,</span> <span class=nx>pl</span><span class=p>.</span><span class=nx>enableMinDomainsInPodTopologySpread</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>klog</span><span class=p>.</span><span class=nf>ErrorS</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=s>&#34;Internal error occurred while retrieving value precalculated in PreFilter&#34;</span><span class=p>,</span> <span class=s>&#34;topologyKey&#34;</span><span class=p>,</span> <span class=nx>tpKey</span><span class=p>,</span> <span class=s>&#34;paths&#34;</span><span class=p>,</span> <span class=nx>s</span><span class=p>.</span><span class=nx>TpKeyToCriticalPaths</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>continue</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>selfMatchNum</span> <span class=o>:=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>c</span><span class=p>.</span><span class=nx>Selector</span><span class=p>.</span><span class=nf>Matches</span><span class=p>(</span><span class=nx>podLabelSet</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>selfMatchNum</span> <span class=p>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>pair</span> <span class=o>:=</span> <span class=nx>topologyPair</span><span class=p>{</span><span class=nx>key</span><span class=p>:</span> <span class=nx>tpKey</span><span class=p>,</span> <span class=nx>value</span><span class=p>:</span> <span class=nx>tpVal</span><span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>matchNum</span> <span class=o>:=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>tpCount</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nx>TpPairToMatchNum</span><span class=p>[</span><span class=nx>pair</span><span class=p>];</span> <span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>matchNum</span> <span class=p>=</span> <span class=nx>tpCount</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>skew</span> <span class=o>:=</span> <span class=nx>matchNum</span> <span class=o>+</span> <span class=nx>selfMatchNum</span> <span class=o>-</span> <span class=nx>minMatchNum</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>skew</span> <span class=p>&gt;</span> <span class=nb>int</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>MaxSkew</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>5</span><span class=p>).</span><span class=nf>InfoS</span><span class=p>(</span><span class=s>&#34;Node failed spreadConstraint: matchNum + selfMatchNum - minMatchNum &gt; maxSkew&#34;</span><span class=p>,</span> <span class=s>&#34;node&#34;</span><span class=p>,</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>KObj</span><span class=p>(</span><span class=nx>node</span><span class=p>),</span> <span class=s>&#34;topologyKey&#34;</span><span class=p>,</span> <span class=nx>tpKey</span><span class=p>,</span> <span class=s>&#34;matchNum&#34;</span><span class=p>,</span> <span class=nx>matchNum</span><span class=p>,</span> <span class=s>&#34;selfMatchNum&#34;</span><span class=p>,</span> <span class=nx>selfMatchNum</span><span class=p>,</span> <span class=s>&#34;minMatchNum&#34;</span><span class=p>,</span> <span class=nx>minMatchNum</span><span class=p>,</span> <span class=s>&#34;maxSkew&#34;</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>MaxSkew</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>framework</span><span class=p>.</span><span class=nf>NewStatus</span><span class=p>(</span><span class=nx>framework</span><span class=p>.</span><span class=nx>Unschedulable</span><span class=p>,</span> <span class=nx>ErrReasonConstraintsNotMatch</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>minMatchNum</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// minMatchNum用于计算 倾斜的全局最小值，同时考虑 MinDomains。
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>preFilterState</span><span class=p>)</span> <span class=nf>minMatchNum</span><span class=p>(</span><span class=nx>tpKey</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>minDomains</span> <span class=kt>int32</span><span class=p>,</span> <span class=nx>enableMinDomainsInPodTopologySpread</span> <span class=kt>bool</span><span class=p>)</span> <span class=p>(</span><span class=kt>int</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>paths</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nx>TpKeyToCriticalPaths</span><span class=p>[</span><span class=nx>tpKey</span><span class=p>]</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to retrieve path by topology key&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 通常来说最小值是第一个
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>minMatchNum</span> <span class=o>:=</span> <span class=nx>paths</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>MatchNum</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>!</span><span class=nx>enableMinDomainsInPodTopologySpread</span> <span class=p>{</span> <span class=c1>// 就是plugin的配置的 enableMinDomainsInPodTopologySpread
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>return</span> <span class=nx>minMatchNum</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>domainsNum</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nx>TpKeyToDomainsNum</span><span class=p>[</span><span class=nx>tpKey</span><span class=p>]</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to retrieve the number of domains by topology key&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>domainsNum</span> <span class=p>&lt;</span> <span class=nb>int</span><span class=p>(</span><span class=nx>minDomains</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 当有匹配拓扑键的符合条件的域的数量小于 配置的&#34;minDomains&#34;(每个约束条件的这个配置) 时，
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>//它将全局“minimum” 设置为0。
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// 因为minimum默认就为1，如果他小于1，就让他为0
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>minMatchNum</span> <span class=p>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>minMatchNum</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><h4 id=prescore>PreScore<a hidden class=anchor aria-hidden=true href=#prescore>#</a></h4><p>与 Filter 类似， <code>PreScore</code> 也是类似 <code>PreFilter</code> 的构成。 <code>initPreScoreState</code> 来完成过滤。</p><p>有了 <code>PreFilter</code> 基础后，对于 Score 来说大同小异</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>pl</span> <span class=o>*</span><span class=nx>PodTopologySpread</span><span class=p>)</span> <span class=nf>PreScore</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>cycleState</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>CycleState</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>filteredNodes</span> <span class=p>[]</span><span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Node</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>Status</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>allNodes</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>pl</span><span class=p>.</span><span class=nx>sharedLister</span><span class=p>.</span><span class=nf>NodeInfos</span><span class=p>().</span><span class=nf>List</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>framework</span><span class=p>.</span><span class=nf>AsStatus</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;getting all nodes: %w&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>filteredNodes</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>||</span> <span class=nb>len</span><span class=p>(</span><span class=nx>allNodes</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// No nodes to score.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>state</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>preScoreState</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>IgnoredNodes</span><span class=p>:</span>            <span class=nx>sets</span><span class=p>.</span><span class=nf>NewString</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>		<span class=nx>TopologyPairToPodCounts</span><span class=p>:</span> <span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=nx>topologyPair</span><span class=p>]</span><span class=o>*</span><span class=kt>int64</span><span class=p>),</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Only require that nodes have all the topology labels if using
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// non-system-default spreading rules. This allows nodes that don&#39;t have a
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// zone label to still have hostname spreading.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// 如果使用非系统默认分布规则，则仅要求节点具有所有拓扑标签。
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// 这将允许没有zone标签的节点仍然具有hostname分布。
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>requireAllTopologies</span> <span class=o>:=</span> <span class=nb>len</span><span class=p>(</span><span class=nx>pod</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>TopologySpreadConstraints</span><span class=p>)</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=o>||</span> <span class=p>!</span><span class=nx>pl</span><span class=p>.</span><span class=nx>systemDefaulted</span>
</span></span><span class=line><span class=cl>	<span class=nx>err</span> <span class=p>=</span> <span class=nx>pl</span><span class=p>.</span><span class=nf>initPreScoreState</span><span class=p>(</span><span class=nx>state</span><span class=p>,</span> <span class=nx>pod</span><span class=p>,</span> <span class=nx>filteredNodes</span><span class=p>,</span> <span class=nx>requireAllTopologies</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>framework</span><span class=p>.</span><span class=nf>AsStatus</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;calculating preScoreState: %w&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// return if incoming pod doesn&#39;t have soft topology spread Constraints.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>state</span><span class=p>.</span><span class=nx>Constraints</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>cycleState</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span><span class=nx>preScoreStateKey</span><span class=p>,</span> <span class=nx>state</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Ignore parsing errors for backwards compatibility.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>requiredNodeAffinity</span> <span class=o>:=</span> <span class=nx>nodeaffinity</span><span class=p>.</span><span class=nf>GetRequiredNodeAffinity</span><span class=p>(</span><span class=nx>pod</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>processAllNode</span> <span class=o>:=</span> <span class=kd>func</span><span class=p>(</span><span class=nx>i</span> <span class=kt>int</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>nodeInfo</span> <span class=o>:=</span> <span class=nx>allNodes</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>		<span class=nx>node</span> <span class=o>:=</span> <span class=nx>nodeInfo</span><span class=p>.</span><span class=nf>Node</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>node</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>!</span><span class=nx>pl</span><span class=p>.</span><span class=nx>enableNodeInclusionPolicyInPodTopologySpread</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// `node` should satisfy incoming pod&#39;s NodeSelector/NodeAffinity
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>if</span> <span class=nx>match</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>requiredNodeAffinity</span><span class=p>.</span><span class=nf>Match</span><span class=p>(</span><span class=nx>node</span><span class=p>);</span> <span class=p>!</span><span class=nx>match</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// All topologyKeys need to be present in `node`
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nx>requireAllTopologies</span> <span class=o>&amp;&amp;</span> <span class=p>!</span><span class=nf>nodeLabelsMatchSpreadConstraints</span><span class=p>(</span><span class=nx>node</span><span class=p>.</span><span class=nx>Labels</span><span class=p>,</span> <span class=nx>state</span><span class=p>.</span><span class=nx>Constraints</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>c</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>state</span><span class=p>.</span><span class=nx>Constraints</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>pl</span><span class=p>.</span><span class=nx>enableNodeInclusionPolicyInPodTopologySpread</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>				<span class=p>!</span><span class=nx>c</span><span class=p>.</span><span class=nf>matchNodeInclusionPolicies</span><span class=p>(</span><span class=nx>pod</span><span class=p>,</span> <span class=nx>node</span><span class=p>,</span> <span class=nx>requiredNodeAffinity</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>continue</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=nx>pair</span> <span class=o>:=</span> <span class=nx>topologyPair</span><span class=p>{</span><span class=nx>key</span><span class=p>:</span> <span class=nx>c</span><span class=p>.</span><span class=nx>TopologyKey</span><span class=p>,</span> <span class=nx>value</span><span class=p>:</span> <span class=nx>node</span><span class=p>.</span><span class=nx>Labels</span><span class=p>[</span><span class=nx>c</span><span class=p>.</span><span class=nx>TopologyKey</span><span class=p>]}</span>
</span></span><span class=line><span class=cl>			<span class=c1>// If current topology pair is not associated with any candidate node,
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// continue to avoid unnecessary calculation.
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// Per-node counts are also skipped, as they are done during Score.
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>tpCount</span> <span class=o>:=</span> <span class=nx>state</span><span class=p>.</span><span class=nx>TopologyPairToPodCounts</span><span class=p>[</span><span class=nx>pair</span><span class=p>]</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>tpCount</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>continue</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nx>count</span> <span class=o>:=</span> <span class=nf>countPodsMatchSelector</span><span class=p>(</span><span class=nx>nodeInfo</span><span class=p>.</span><span class=nx>Pods</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>Selector</span><span class=p>,</span> <span class=nx>pod</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=nx>atomic</span><span class=p>.</span><span class=nf>AddInt64</span><span class=p>(</span><span class=nx>tpCount</span><span class=p>,</span> <span class=nb>int64</span><span class=p>(</span><span class=nx>count</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>pl</span><span class=p>.</span><span class=nx>parallelizer</span><span class=p>.</span><span class=nf>Until</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>allNodes</span><span class=p>),</span> <span class=nx>processAllNode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 保存状态给后面sorce调用
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>cycleState</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span><span class=nx>preScoreStateKey</span><span class=p>,</span> <span class=nx>state</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>与Filter中Update使用的函数一样，这里也会到这一步，这里会构建出TopologySpreadConstraints，因为约束是不确定的</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>filterTopologySpreadConstraints</span><span class=p>(</span><span class=nx>constraints</span> <span class=p>[]</span><span class=nx>v1</span><span class=p>.</span><span class=nx>TopologySpreadConstraint</span><span class=p>,</span> <span class=nx>action</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>UnsatisfiableConstraintAction</span><span class=p>,</span> <span class=nx>enableMinDomainsInPodTopologySpread</span><span class=p>,</span> <span class=nx>enableNodeInclusionPolicyInPodTopologySpread</span> <span class=kt>bool</span><span class=p>)</span> <span class=p>([]</span><span class=nx>topologySpreadConstraint</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>result</span> <span class=p>[]</span><span class=nx>topologySpreadConstraint</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>c</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>constraints</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>c</span><span class=p>.</span><span class=nx>WhenUnsatisfiable</span> <span class=o>==</span> <span class=nx>action</span> <span class=p>{</span> <span class=c1>// 始终调度时
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>selector</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>metav1</span><span class=p>.</span><span class=nf>LabelSelectorAsSelector</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>LabelSelector</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nx>tsc</span> <span class=o>:=</span> <span class=nx>topologySpreadConstraint</span><span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>MaxSkew</span><span class=p>:</span>            <span class=nx>c</span><span class=p>.</span><span class=nx>MaxSkew</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=nx>TopologyKey</span><span class=p>:</span>        <span class=nx>c</span><span class=p>.</span><span class=nx>TopologyKey</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=nx>Selector</span><span class=p>:</span>           <span class=nx>selector</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=nx>MinDomains</span><span class=p>:</span>         <span class=mi>1</span><span class=p>,</span>                            <span class=c1>// If MinDomains is nil, we treat MinDomains as 1.
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=nx>NodeAffinityPolicy</span><span class=p>:</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>NodeInclusionPolicyHonor</span><span class=p>,</span>  <span class=c1>// If NodeAffinityPolicy is nil, we treat NodeAffinityPolicy as &#34;Honor&#34;.
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=nx>NodeTaintsPolicy</span><span class=p>:</span>   <span class=nx>v1</span><span class=p>.</span><span class=nx>NodeInclusionPolicyIgnore</span><span class=p>,</span> <span class=c1>// If NodeTaintsPolicy is nil, we treat NodeTaintsPolicy as &#34;Ignore&#34;.
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>enableMinDomainsInPodTopologySpread</span> <span class=o>&amp;&amp;</span> <span class=nx>c</span><span class=p>.</span><span class=nx>MinDomains</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>tsc</span><span class=p>.</span><span class=nx>MinDomains</span> <span class=p>=</span> <span class=o>*</span><span class=nx>c</span><span class=p>.</span><span class=nx>MinDomains</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>enableNodeInclusionPolicyInPodTopologySpread</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nx>c</span><span class=p>.</span><span class=nx>NodeAffinityPolicy</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>tsc</span><span class=p>.</span><span class=nx>NodeAffinityPolicy</span> <span class=p>=</span> <span class=o>*</span><span class=nx>c</span><span class=p>.</span><span class=nx>NodeAffinityPolicy</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nx>c</span><span class=p>.</span><span class=nx>NodeTaintsPolicy</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>tsc</span><span class=p>.</span><span class=nx>NodeTaintsPolicy</span> <span class=p>=</span> <span class=o>*</span><span class=nx>c</span><span class=p>.</span><span class=nx>NodeTaintsPolicy</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nx>result</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>result</span><span class=p>,</span> <span class=nx>tsc</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>result</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><h4 id=score>Score<a hidden class=anchor aria-hidden=true href=#score>#</a></h4><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>GO</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-GO data-lang=GO><span class=line><span class=cl><span class=c1>// 在分数扩展点调用分数。该函数返回的“score”是 `nodeName` 上匹配的 pod 数量，稍后会进行归一化。
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>pl</span> <span class=o>*</span><span class=nx>PodTopologySpread</span><span class=p>)</span> <span class=nf>Score</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>cycleState</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>CycleState</span><span class=p>,</span> <span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>,</span> <span class=nx>nodeName</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=kt>int64</span><span class=p>,</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>Status</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>nodeInfo</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>pl</span><span class=p>.</span><span class=nx>sharedLister</span><span class=p>.</span><span class=nf>NodeInfos</span><span class=p>().</span><span class=nf>Get</span><span class=p>(</span><span class=nx>nodeName</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>framework</span><span class=p>.</span><span class=nf>AsStatus</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;getting node %q from Snapshot: %w&#34;</span><span class=p>,</span> <span class=nx>nodeName</span><span class=p>,</span> <span class=nx>err</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>node</span> <span class=o>:=</span> <span class=nx>nodeInfo</span><span class=p>.</span><span class=nf>Node</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>s</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>getPreScoreState</span><span class=p>(</span><span class=nx>cycleState</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>framework</span><span class=p>.</span><span class=nf>AsStatus</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Return if the node is not qualified.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>s</span><span class=p>.</span><span class=nx>IgnoredNodes</span><span class=p>.</span><span class=nf>Has</span><span class=p>(</span><span class=nx>node</span><span class=p>.</span><span class=nx>Name</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=mi>0</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 对于每个当前的 &lt;pair&gt;，当前节点获得 &lt;matchSum&gt; 的信用分。
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// 计算 &lt;matchSum&gt;总和 并将其作为该节点的分数返回。
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=kd>var</span> <span class=nx>score</span> <span class=kt>float64</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>i</span><span class=p>,</span> <span class=nx>c</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>s</span><span class=p>.</span><span class=nx>Constraints</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>tpVal</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>node</span><span class=p>.</span><span class=nx>Labels</span><span class=p>[</span><span class=nx>c</span><span class=p>.</span><span class=nx>TopologyKey</span><span class=p>];</span> <span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=kd>var</span> <span class=nx>cnt</span> <span class=kt>int64</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>c</span><span class=p>.</span><span class=nx>TopologyKey</span> <span class=o>==</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>LabelHostname</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>cnt</span> <span class=p>=</span> <span class=nb>int64</span><span class=p>(</span><span class=nf>countPodsMatchSelector</span><span class=p>(</span><span class=nx>nodeInfo</span><span class=p>.</span><span class=nx>Pods</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>Selector</span><span class=p>,</span> <span class=nx>pod</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>))</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>pair</span> <span class=o>:=</span> <span class=nx>topologyPair</span><span class=p>{</span><span class=nx>key</span><span class=p>:</span> <span class=nx>c</span><span class=p>.</span><span class=nx>TopologyKey</span><span class=p>,</span> <span class=nx>value</span><span class=p>:</span> <span class=nx>tpVal</span><span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=nx>cnt</span> <span class=p>=</span> <span class=o>*</span><span class=nx>s</span><span class=p>.</span><span class=nx>TopologyPairToPodCounts</span><span class=p>[</span><span class=nx>pair</span><span class=p>]</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nx>score</span> <span class=o>+=</span> <span class=nf>scoreForCount</span><span class=p>(</span><span class=nx>cnt</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>MaxSkew</span><span class=p>,</span> <span class=nx>s</span><span class=p>.</span><span class=nx>TopologyNormalizingWeight</span><span class=p>[</span><span class=nx>i</span><span class=p>])</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nb>int64</span><span class=p>(</span><span class=nx>math</span><span class=p>.</span><span class=nf>Round</span><span class=p>(</span><span class=nx>score</span><span class=p>)),</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>在 <a href=https://github.com/kubernetes/kubernetes/blob/32c483ea6ee90a3a81f382563c91034470af8a4a/pkg/scheduler/framework/runtime/framework.go#L940-L952 target=_blank rel="noopener nofollow noreferrer">Framework</a> 中会运行 <code>ScoreExtension</code> ，即 <code>NormalizeScore</code></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// Run NormalizeScore method for each ScorePlugin in parallel.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>f</span><span class=p>.</span><span class=nf>Parallelizer</span><span class=p>().</span><span class=nf>Until</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>f</span><span class=p>.</span><span class=nx>scorePlugins</span><span class=p>),</span> <span class=kd>func</span><span class=p>(</span><span class=nx>index</span> <span class=kt>int</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>pl</span> <span class=o>:=</span> <span class=nx>f</span><span class=p>.</span><span class=nx>scorePlugins</span><span class=p>[</span><span class=nx>index</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nx>nodeScoreList</span> <span class=o>:=</span> <span class=nx>pluginToNodeScores</span><span class=p>[</span><span class=nx>pl</span><span class=p>.</span><span class=nf>Name</span><span class=p>()]</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>pl</span><span class=p>.</span><span class=nf>ScoreExtensions</span><span class=p>()</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>status</span> <span class=o>:=</span> <span class=nx>f</span><span class=p>.</span><span class=nf>runScoreExtension</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>pl</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>pod</span><span class=p>,</span> <span class=nx>nodeScoreList</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>!</span><span class=nx>status</span><span class=p>.</span><span class=nf>IsSuccess</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>err</span> <span class=o>:=</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;plugin %q failed with: %w&#34;</span><span class=p>,</span> <span class=nx>pl</span><span class=p>.</span><span class=nf>Name</span><span class=p>(),</span> <span class=nx>status</span><span class=p>.</span><span class=nf>AsError</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=nx>errCh</span><span class=p>.</span><span class=nf>SendErrorWithCancel</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=nx>cancel</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>errCh</span><span class=p>.</span><span class=nf>ReceiveError</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>framework</span><span class=p>.</span><span class=nf>AsStatus</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;running Normalize on Score plugins: %w&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p><a href=https://github.com/kubernetes/kubernetes/blob/32c483ea6ee90a3a81f382563c91034470af8a4a/pkg/scheduler/framework/plugins/podtopologyspread/scoring.go#L216-L255 target=_blank rel="noopener nofollow noreferrer">NormalizeScore</a> 会为所有的node根据之前计算出的权重进行打分</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>pl</span> <span class=o>*</span><span class=nx>PodTopologySpread</span><span class=p>)</span> <span class=nf>NormalizeScore</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>cycleState</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>CycleState</span><span class=p>,</span> <span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>,</span> <span class=nx>scores</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>NodeScoreList</span><span class=p>)</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>Status</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>s</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>getPreScoreState</span><span class=p>(</span><span class=nx>cycleState</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>framework</span><span class=p>.</span><span class=nf>AsStatus</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>s</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 计算 &lt;minScore&gt; 和 &lt;maxScore&gt;
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=kd>var</span> <span class=nx>minScore</span> <span class=kt>int64</span> <span class=p>=</span> <span class=nx>math</span><span class=p>.</span><span class=nx>MaxInt64</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>maxScore</span> <span class=kt>int64</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>i</span><span class=p>,</span> <span class=nx>score</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>scores</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// it&#39;s mandatory to check if &lt;score.Name&gt; is present in m.IgnoredNodes
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nx>s</span><span class=p>.</span><span class=nx>IgnoredNodes</span><span class=p>.</span><span class=nf>Has</span><span class=p>(</span><span class=nx>score</span><span class=p>.</span><span class=nx>Name</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>scores</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>Score</span> <span class=p>=</span> <span class=nx>invalidScore</span>
</span></span><span class=line><span class=cl>			<span class=k>continue</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>score</span><span class=p>.</span><span class=nx>Score</span> <span class=p>&lt;</span> <span class=nx>minScore</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>minScore</span> <span class=p>=</span> <span class=nx>score</span><span class=p>.</span><span class=nx>Score</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>score</span><span class=p>.</span><span class=nx>Score</span> <span class=p>&gt;</span> <span class=nx>maxScore</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>maxScore</span> <span class=p>=</span> <span class=nx>score</span><span class=p>.</span><span class=nx>Score</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>scores</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>scores</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>Score</span> <span class=o>==</span> <span class=nx>invalidScore</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>scores</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>Score</span> <span class=p>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>			<span class=k>continue</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>maxScore</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>scores</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>Score</span> <span class=p>=</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>MaxNodeScore</span>
</span></span><span class=line><span class=cl>			<span class=k>continue</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>s</span> <span class=o>:=</span> <span class=nx>scores</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>Score</span>
</span></span><span class=line><span class=cl>		<span class=nx>scores</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>Score</span> <span class=p>=</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>MaxNodeScore</span> <span class=o>*</span> <span class=p>(</span><span class=nx>maxScore</span> <span class=o>+</span> <span class=nx>minScore</span> <span class=o>-</span> <span class=nx>s</span><span class=p>)</span> <span class=o>/</span> <span class=nx>maxScore</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>到此，对于pod拓扑插件功能大概可以明了了，</p><ul><li>Filter 部分（<code>PreFilter</code>，<code>Filter</code>）完成拓扑对(<code>Topology Pair</code>)划分</li><li>Score部分（<code>PreScore</code>, <code>Score</code> , <code>NormalizeScore</code> ）主要是对拓扑对（可以理解为拓扑结构划分）来选择一个最适合的pod的节点（即分数最优的节点）</li></ul><p>而在 <a href=https://github.com/kubernetes/kubernetes/blob/release-1.24/pkg/scheduler/framework/plugins/podtopologyspread/scoring_test.go target=_blank rel="noopener nofollow noreferrer">scoring_test.go</a> 给了很多用例，可以更深入的了解这部分算法</p><h2 id=reference>Reference<a hidden class=anchor aria-hidden=true href=#reference>#</a></h2><blockquote><p><sup id=1>[1]</sup> <a href=https://github.com/kubernetes/community/blob/master/contributors/devel/sig-scheduling/scheduling_code_hierarchy_overview.md target=_blank rel="noopener nofollow noreferrer">scheduling code hierarchy</a></p><p><sup id=2>[2]</sup> <a href=https://github.com/kubernetes/community/blob/master/contributors/devel/sig-scheduling/scheduler_algorithm.md target=_blank rel="noopener nofollow noreferrer">scheduler algorithm</a></p><p><sup id=3>[3]</sup> <a href=https://github.com/kubernetes/community/blob/master/sig-storage/volume-plugin-faq.md#in-tree-vs-out-of-tree-volume-plugins target=_blank rel="noopener nofollow noreferrer">in tree VS out of tree volume plugins</a></p><p><sup id=4>[4]</sup> <a href=https://github.com/kubernetes/community/blob/master/contributors/devel/sig-scheduling/scheduler_framework_plugins.md target=_blank rel="noopener nofollow noreferrer">scheduler_framework_plugins</a></p><p><sup id=5>[5]</sup> <a href=https://kubernetes.io/docs/reference/scheduling/config/ target=_blank rel="noopener nofollow noreferrer">scheduling config</a></p><p><sup id=6>[6]</sup> <a href=https://kubernetes.io/docs/concepts/scheduling-eviction/topology-spread-constraints/ target=_blank rel="noopener nofollow noreferrer">topology spread constraints</a></p></blockquote></div><div class=pe-copyright><hr><blockquote><p>本文为原创内容，版权归作者所有。如需转载，请在文章中声明本文标题及链接。</p><p>文章标题：如何理解kubernetes调度框架与插件？</p><p>文章链接：<a href=https://www.oomkill.com/2022/07/ch21-scheduling-algorithm/ target=_blank>https://www.oomkill.com/2022/07/ch21-scheduling-algorithm/</a></p><p>许可协议：<a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></p></blockquote></div><div class=comments-separator></div><h3 class=relatedContentTitle>相关阅读</h3><ul class=relatedContent><li><a href=/2022/07/ch20-schedule-workflow/><span>kube-scheduler的调度上下文</span></a></li><li><a href=/2022/07/ch16-scheduler/><span>kubernetes的决策组件 - kube-scheduler原理分析</span></a></li><li><a href=/2022/07/ch33-admission-webhook/><span>深入理解Kubernetes 4A - Admission Control源码解析</span></a></li><li><a href=/2022/06/ch27-leader-election/><span>源码分析Kubernetes HA机制 - leader election</span></a></li><li><a href=/2022/06/ch15-controller-runtime/><span>源码分析Kubernetes controller组件 - controller-runtime</span></a></li></ul><div class=comments-separator></div><footer class=post-footer><ul class=post-tags><li><a href=https://www.oomkill.com/tags/kubernetes-develop/>Kubernetes Develop</a></li><li><a href=https://www.oomkill.com/tags/kubernetes/>Kubernetes</a></li></ul><nav class=paginav><a class=prev href=https://www.oomkill.com/2022/08/ch22-custom-scheduler/><span class=title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left" style="user-select:text"><line x1="19" y1="12" x2="5" y2="12" style="user-select:text"/><polyline points="12 19 5 12 12 5" style="user-select:text"/></polyline></svg>&nbsp;</span>
<span>基于Prometheus的Kubernetes网络调度器</span>
</a><a class=next href=https://www.oomkill.com/2022/07/ch20-schedule-workflow/><span class=title></span>
<span>kube-scheduler的调度上下文&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right" style="user-select:text"><line x1="5" y1="12" x2="19" y2="12" style="user-select:text"/><polyline points="12 5 19 12 12 19" style="user-select:text"/></svg></span></a></nav></footer><div class=pe-comments-decoration><p class=pe-comments-title></p><p class=pe-comments-subtitle></p></div><div id=pe-comments></div><script src=/js/pe-go-comment.min.86a214102576ba5f9b7bdc29eed8d58dd56e34aef80b3c65c73ea9cc88443696.js integrity="sha256-hqIUECV2ul+be9wp7tjVjdVuNK74Czxlxz6pzIhENpY="></script><script>const getStoredTheme=()=>localStorage.getItem("pref-theme")==="dark"?"dark":"light",setGiscusTheme=()=>{const e=e=>{const t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:e},"https://giscus.app")};e({setConfig:{theme:getStoredTheme()}})};document.addEventListener("DOMContentLoaded",()=>{const s={src:"https://giscus.app/client.js","data-repo":"cylonchau/blogs","data-repo-id":"R_kgDOIRlNSQ","data-category":"Announcements","data-category-id":"DIC_kwDOIRlNSc4CXy1U","data-mapping":"pathname","data-term":"posts/ch21 Scheduling Algorithm","data-strict":"0","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"top","data-theme":getStoredTheme(),"data-lang":"zh-TW","data-loading":"lazy",crossorigin:"anonymous",async:""},e=document.createElement("script");Object.entries(s).forEach(([t,n])=>e.setAttribute(t,n)),document.querySelector("#pe-comments").appendChild(e);const t=document.querySelector("#theme-toggle");t&&t.addEventListener("click",setGiscusTheme);const n=document.querySelector("#theme-toggle-float");n&&n.addEventListener("click",setGiscusTheme)})</script></article></main><footer class=footer><span>&copy; 2024 <a href=https://www.oomkill.com/>Cylon's Collection</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> on
<a href=https://pages.github.com/ rel=noopener target=_blank>GitHub Pages</a> & Theme
        <a href=https://github.com/tofuwine/PaperMod-PE rel=noopener target=_blank>PaperMod-PE</a></span></footer><div class=pe-right-sidebar><a href=javascript:void(0); id=theme-toggle-float class=pe-float-btn><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</a><a href=#top class=pe-float-btn id=top-link><span id=pe-read-progress></span></a></div><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>