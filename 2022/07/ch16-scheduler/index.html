<!doctype html><html lang=zh dir=auto><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>kubernetes的决策组件 - kube-scheduler原理分析 | Cylon's Collection</title><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NP3JNCPR" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><meta name=keywords content="kubernetes,develop,k8s调度"><meta name=description content="Overview [1] kubernetes集群中的调度程序 kube-scheduler 会 watch 未分配节点的新创建的Pod，并未该Pod找到可运行的最佳（特定）节点。那么这些动作或者说这些原理是怎么实现的呢，让我们往下剖析下。
对于新创建的 pod 或其他未调度的 pod来讲，kube-scheduler 选择一个最佳节点供它们运行。但是，Pod 中的每个容器对资源的要求都不同，每个 Pod 也有不同的要求。因此，需要根据具体的调度要求对现有节点进行过滤。
在Kubernetes集群中，满足 Pod 调度要求的节点称为可行节点 （ feasible nodes FN） 。如果没有合适的节点，则 pod 将保持未调度状态，直到调度程序能够放置它。也就是说，当我们创建Pod时，如果长期处于 Pending 状态，这个时候应该看你的集群调度器是否因为某些问题没有合适的节点了
调度器为 Pod 找到 FN 后，然后运行一组函数对 FN 进行评分，并在 FN 中找到得分最高的节点来运行 Pod。
调度策略在决策时需要考虑的因素包括个人和集体资源需求、硬件/软件/策略约束 （constraints）、亲和性 (affinity) 和反亲和性（ anti-affinity ）规范、数据局部性、工作负载间干扰等。
如何为pod选择节点？ kube-scheduler 为pod选择节点会分位两部：
过滤 (Filtering) 打分 (Scoring) 过滤也被称为预选 （Predicates），该步骤会找到可调度的节点集，然后通过是否满足特定资源的请求，例如通过 PodFitsResources 过滤器检查候选节点是否有足够的资源来满足 Pod 资源的请求。这个步骤完成后会得到一个包含合适的节点的列表（通常为多个），如果列表为空，则Pod不可调度。
打分也被称为优选（Priorities），在该步骤中，会对上一个步骤的输出进行打分，Scheduer 通过打分的规则为每个通过 Filtering 步骤的节点计算出一个分数。
完成上述两个步骤之后，kube-scheduler 会将Pod分配给分数最高的 Node，如果存在多个相同分数的节点，会随机选择一个。
kubernetes的调度策略 Kubernetes 1.21之前版本可以在代码 kubernetes\pkg\scheduler\algorithmprovider\registry.go 中看到对应的注册模式，在1.22 scheduler 更换了其路径，对于registry文件更换到了kubernetes\pkg\scheduler\framework\plugins\registry.go ；对于kubernetes官方说法为，调度策略是用于“预选” (Predicates )或 过滤（filtering ） 和 用于 优选（Priorities）或 评分 (scoring)的"><meta name=author content="cylon"><link rel=canonical href=http://localhost:1313/2022/07/ch16-scheduler/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=http://localhost:1313/favicon.ico><link rel=icon type=image/png sizes=16x16 href=http://localhost:1313/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=http://localhost:1313/favicon-32x32.png><link rel=apple-touch-icon href=http://localhost:1313/favicon.ico><link rel=mask-icon href=http://localhost:1313/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=http://localhost:1313/2022/07/ch16-scheduler/><noscript><style>#theme-toggle,#top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link crossorigin=anonymous href=/assets/css/pe.min.css rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/pe.min.js></script><link rel=stylesheet href=https://cdn.staticfile.net/font-awesome/6.5.1/css/all.min.css><link rel=stylesheet href=https://cdn.staticfile.net/font-awesome/6.5.1/css/v4-shims.min.css><script defer src=https://cdn.staticfile.net/jquery/3.5.1/jquery.min.js></script><link rel=stylesheet href=https://cdn.staticfile.net/fancybox/3.5.7/jquery.fancybox.min.css><script defer src=https://cdn.staticfile.net/fancybox/3.5.7/jquery.fancybox.min.js></script><script id=MathJax-script async src=https://cdn.staticfile.net/mathjax/3.2.2/es5/tex-chtml.js></script><script>MathJax={tex:{displayMath:[["$$","$$"]],inlineMath:[["\\$","\\$"]]}}</script><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><meta name=referrer content="no-referrer-when-downgrade"><script>(function(e,t,n,s,o){e[s]=e[s]||[],e[s].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var a=t.getElementsByTagName(n)[0],i=t.createElement(n),r=s!="dataLayer"?"&l="+s:"";i.async=!0,i.src="https://www.googletagmanager.com/gtm.js?id="+o+r,a.parentNode.insertBefore(i,a)})(window,document,"script","dataLayer","GTM-NP3JNCPR")</script><meta property="og:title" content="kubernetes的决策组件 - kube-scheduler原理分析"><meta property="og:description" content="Overview [1] kubernetes集群中的调度程序 kube-scheduler 会 watch 未分配节点的新创建的Pod，并未该Pod找到可运行的最佳（特定）节点。那么这些动作或者说这些原理是怎么实现的呢，让我们往下剖析下。
对于新创建的 pod 或其他未调度的 pod来讲，kube-scheduler 选择一个最佳节点供它们运行。但是，Pod 中的每个容器对资源的要求都不同，每个 Pod 也有不同的要求。因此，需要根据具体的调度要求对现有节点进行过滤。
在Kubernetes集群中，满足 Pod 调度要求的节点称为可行节点 （ feasible nodes FN） 。如果没有合适的节点，则 pod 将保持未调度状态，直到调度程序能够放置它。也就是说，当我们创建Pod时，如果长期处于 Pending 状态，这个时候应该看你的集群调度器是否因为某些问题没有合适的节点了
调度器为 Pod 找到 FN 后，然后运行一组函数对 FN 进行评分，并在 FN 中找到得分最高的节点来运行 Pod。
调度策略在决策时需要考虑的因素包括个人和集体资源需求、硬件/软件/策略约束 （constraints）、亲和性 (affinity) 和反亲和性（ anti-affinity ）规范、数据局部性、工作负载间干扰等。
如何为pod选择节点？ kube-scheduler 为pod选择节点会分位两部：
过滤 (Filtering) 打分 (Scoring) 过滤也被称为预选 （Predicates），该步骤会找到可调度的节点集，然后通过是否满足特定资源的请求，例如通过 PodFitsResources 过滤器检查候选节点是否有足够的资源来满足 Pod 资源的请求。这个步骤完成后会得到一个包含合适的节点的列表（通常为多个），如果列表为空，则Pod不可调度。
打分也被称为优选（Priorities），在该步骤中，会对上一个步骤的输出进行打分，Scheduer 通过打分的规则为每个通过 Filtering 步骤的节点计算出一个分数。
完成上述两个步骤之后，kube-scheduler 会将Pod分配给分数最高的 Node，如果存在多个相同分数的节点，会随机选择一个。
kubernetes的调度策略 Kubernetes 1.21之前版本可以在代码 kubernetes\pkg\scheduler\algorithmprovider\registry.go 中看到对应的注册模式，在1.22 scheduler 更换了其路径，对于registry文件更换到了kubernetes\pkg\scheduler\framework\plugins\registry.go ；对于kubernetes官方说法为，调度策略是用于“预选” (Predicates )或 过滤（filtering ） 和 用于 优选（Priorities）或 评分 (scoring)的"><meta property="og:type" content="article"><meta property="og:url" content="http://localhost:1313/2022/07/ch16-scheduler/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-07-18T00:00:00+00:00"><meta property="og:site_name" content="Cylon's Collection"><meta name=twitter:card content="summary"><meta name=twitter:title content="kubernetes的决策组件 - kube-scheduler原理分析"><meta name=twitter:description content="Overview [1] kubernetes集群中的调度程序 kube-scheduler 会 watch 未分配节点的新创建的Pod，并未该Pod找到可运行的最佳（特定）节点。那么这些动作或者说这些原理是怎么实现的呢，让我们往下剖析下。
对于新创建的 pod 或其他未调度的 pod来讲，kube-scheduler 选择一个最佳节点供它们运行。但是，Pod 中的每个容器对资源的要求都不同，每个 Pod 也有不同的要求。因此，需要根据具体的调度要求对现有节点进行过滤。
在Kubernetes集群中，满足 Pod 调度要求的节点称为可行节点 （ feasible nodes FN） 。如果没有合适的节点，则 pod 将保持未调度状态，直到调度程序能够放置它。也就是说，当我们创建Pod时，如果长期处于 Pending 状态，这个时候应该看你的集群调度器是否因为某些问题没有合适的节点了
调度器为 Pod 找到 FN 后，然后运行一组函数对 FN 进行评分，并在 FN 中找到得分最高的节点来运行 Pod。
调度策略在决策时需要考虑的因素包括个人和集体资源需求、硬件/软件/策略约束 （constraints）、亲和性 (affinity) 和反亲和性（ anti-affinity ）规范、数据局部性、工作负载间干扰等。
如何为pod选择节点？ kube-scheduler 为pod选择节点会分位两部：
过滤 (Filtering) 打分 (Scoring) 过滤也被称为预选 （Predicates），该步骤会找到可调度的节点集，然后通过是否满足特定资源的请求，例如通过 PodFitsResources 过滤器检查候选节点是否有足够的资源来满足 Pod 资源的请求。这个步骤完成后会得到一个包含合适的节点的列表（通常为多个），如果列表为空，则Pod不可调度。
打分也被称为优选（Priorities），在该步骤中，会对上一个步骤的输出进行打分，Scheduer 通过打分的规则为每个通过 Filtering 步骤的节点计算出一个分数。
完成上述两个步骤之后，kube-scheduler 会将Pod分配给分数最高的 Node，如果存在多个相同分数的节点，会随机选择一个。
kubernetes的调度策略 Kubernetes 1.21之前版本可以在代码 kubernetes\pkg\scheduler\algorithmprovider\registry.go 中看到对应的注册模式，在1.22 scheduler 更换了其路径，对于registry文件更换到了kubernetes\pkg\scheduler\framework\plugins\registry.go ；对于kubernetes官方说法为，调度策略是用于“预选” (Predicates )或 过滤（filtering ） 和 用于 优选（Priorities）或 评分 (scoring)的"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"http://localhost:1313/posts/"},{"@type":"ListItem","position":2,"name":"kubernetes的决策组件 - kube-scheduler原理分析","item":"http://localhost:1313/2022/07/ch16-scheduler/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"kubernetes的决策组件 - kube-scheduler原理分析","name":"kubernetes的决策组件 - kube-scheduler原理分析","description":"Overview [1] kubernetes集群中的调度程序 kube-scheduler 会 watch 未分配节点的新创建的Pod，并未该Pod找到可运行的最佳（特定）节点。那么这些动作或者说这些原理是怎么实现的呢，让我们往下剖析下。\n对于新创建的 pod 或其他未调度的 pod来讲，kube-scheduler 选择一个最佳节点供它们运行。但是，Pod 中的每个容器对资源的要求都不同，每个 Pod 也有不同的要求。因此，需要根据具体的调度要求对现有节点进行过滤。\n在Kubernetes集群中，满足 Pod 调度要求的节点称为可行节点 （ feasible nodes FN） 。如果没有合适的节点，则 pod 将保持未调度状态，直到调度程序能够放置它。也就是说，当我们创建Pod时，如果长期处于 Pending 状态，这个时候应该看你的集群调度器是否因为某些问题没有合适的节点了\n调度器为 Pod 找到 FN 后，然后运行一组函数对 FN 进行评分，并在 FN 中找到得分最高的节点来运行 Pod。\n调度策略在决策时需要考虑的因素包括个人和集体资源需求、硬件/软件/策略约束 （constraints）、亲和性 (affinity) 和反亲和性（ anti-affinity ）规范、数据局部性、工作负载间干扰等。\n如何为pod选择节点？ kube-scheduler 为pod选择节点会分位两部：\n过滤 (Filtering) 打分 (Scoring) 过滤也被称为预选 （Predicates），该步骤会找到可调度的节点集，然后通过是否满足特定资源的请求，例如通过 PodFitsResources 过滤器检查候选节点是否有足够的资源来满足 Pod 资源的请求。这个步骤完成后会得到一个包含合适的节点的列表（通常为多个），如果列表为空，则Pod不可调度。\n打分也被称为优选（Priorities），在该步骤中，会对上一个步骤的输出进行打分，Scheduer 通过打分的规则为每个通过 Filtering 步骤的节点计算出一个分数。\n完成上述两个步骤之后，kube-scheduler 会将Pod分配给分数最高的 Node，如果存在多个相同分数的节点，会随机选择一个。\nkubernetes的调度策略 Kubernetes 1.21之前版本可以在代码 kubernetes\\pkg\\scheduler\\algorithmprovider\\registry.go 中看到对应的注册模式，在1.22 scheduler 更换了其路径，对于registry文件更换到了kubernetes\\pkg\\scheduler\\framework\\plugins\\registry.go ；对于kubernetes官方说法为，调度策略是用于“预选” (Predicates )或 过滤（filtering ） 和 用于 优选（Priorities）或 评分 (scoring)的","keywords":["kubernetes","develop","k8s调度"],"articleBody":"Overview [1] kubernetes集群中的调度程序 kube-scheduler 会 watch 未分配节点的新创建的Pod，并未该Pod找到可运行的最佳（特定）节点。那么这些动作或者说这些原理是怎么实现的呢，让我们往下剖析下。\n对于新创建的 pod 或其他未调度的 pod来讲，kube-scheduler 选择一个最佳节点供它们运行。但是，Pod 中的每个容器对资源的要求都不同，每个 Pod 也有不同的要求。因此，需要根据具体的调度要求对现有节点进行过滤。\n在Kubernetes集群中，满足 Pod 调度要求的节点称为可行节点 （ feasible nodes FN） 。如果没有合适的节点，则 pod 将保持未调度状态，直到调度程序能够放置它。也就是说，当我们创建Pod时，如果长期处于 Pending 状态，这个时候应该看你的集群调度器是否因为某些问题没有合适的节点了\n调度器为 Pod 找到 FN 后，然后运行一组函数对 FN 进行评分，并在 FN 中找到得分最高的节点来运行 Pod。\n调度策略在决策时需要考虑的因素包括个人和集体资源需求、硬件/软件/策略约束 （constraints）、亲和性 (affinity) 和反亲和性（ anti-affinity ）规范、数据局部性、工作负载间干扰等。\n如何为pod选择节点？ kube-scheduler 为pod选择节点会分位两部：\n过滤 (Filtering) 打分 (Scoring) 过滤也被称为预选 （Predicates），该步骤会找到可调度的节点集，然后通过是否满足特定资源的请求，例如通过 PodFitsResources 过滤器检查候选节点是否有足够的资源来满足 Pod 资源的请求。这个步骤完成后会得到一个包含合适的节点的列表（通常为多个），如果列表为空，则Pod不可调度。\n打分也被称为优选（Priorities），在该步骤中，会对上一个步骤的输出进行打分，Scheduer 通过打分的规则为每个通过 Filtering 步骤的节点计算出一个分数。\n完成上述两个步骤之后，kube-scheduler 会将Pod分配给分数最高的 Node，如果存在多个相同分数的节点，会随机选择一个。\nkubernetes的调度策略 Kubernetes 1.21之前版本可以在代码 kubernetes\\pkg\\scheduler\\algorithmprovider\\registry.go 中看到对应的注册模式，在1.22 scheduler 更换了其路径，对于registry文件更换到了kubernetes\\pkg\\scheduler\\framework\\plugins\\registry.go ；对于kubernetes官方说法为，调度策略是用于“预选” (Predicates )或 过滤（filtering ） 和 用于 优选（Priorities）或 评分 (scoring)的\n注：kubernetes官方没有找到预选和优选的概念，而Predicates和filtering 是处于预选阶段的动词，而Priorities和scoring是优选阶段的动词。后面用PF和PS代替这个两个词。\n为Pod预选节点 [2] 上面也提到了，filtering 的目的是为了排除（过滤）掉不满足 Pod 要求的节点。例如，某个节点上的闲置资源小于 Pod 所需资源，则该节点不会被考虑在内，即被过滤掉。在 “Predicates” 阶段实现的 filtering 策略，包括：\nNoDiskConflict ：评估是否有合适Pod请求的卷 NoVolumeZoneConflict：在给定zone限制情况下，评估Pod请求所需的卷在Node上是否可用 PodFitsResources：检查空闲资源（CPU、内存）是否满足Pod请求 PodFitsHostPorts：检查Pod所需端口在Node上是否被占用 HostName： 过滤除去，PodSpec 中 NodeName 字段中指定的Node之外的所有Node。 MatchNodeSelector：检查Node的 label 是否与 Pod 配置中 nodeSelector字段中指定的 label 匹配，并且从 Kubernetes v1.2 开始， 如果存在 nodeAffinity 也会匹配。 CheckNodeMemoryPressure：检查是否可以在已出现内存压力情况节点上调度 Pod。 CheckNodeDiskPressure：检查是否可以在报告磁盘压力情况的节点上调度 Pod 具体对应得策略可以在 kubernetes\\pkg\\scheduler\\framework\\plugins\\registry.go 看到\n对预选节点打分 [2] 通过上面步骤过滤过得列表则是适合托管的Pod，这个结果通常来说是一个列表，如何选择最优Node进行调度，则是接下来打分的步骤步骤。\n例如：Kubernetes对剩余节点进行优先级排序，优先级由一组函数计算；优先级函数将为剩余节点给出从0~10 的分数，10 表示最优，0 表示最差。每个优先级函数由一个正数加权组成，每个Node的得分是通过将所有加权得分相加来计算的。设有两个优先级函数，priorityFunc1 和 priorityFunc2 加上权重因子 weight1 和weight2，那么这个Node的最终得分为：$finalScore = (w1 \\times priorityFunc1) + (w2 \\times priorityFunc2)$。计算完分数后，选择最高分数的Node做为Pod的宿主机，存在多个相同分数Node情况下会随机选择一个Node。\n目前kubernetes提供了一些在打分 Scoring 阶段算法：\nLeastRequestedPriority：Node的优先级基于Node的空闲部分$\\frac{capacity\\ -\\ Node上所有存在的Pod\\ -\\ 正在调度的Pod请求}{capacity}$，通过计算具有最高分数的Node是FN BalancedResourceAllocation ：该算法会将 Pod 放在一个Node上，使得在Pod 部署后 CPU 和内存的使用率为平衡的 SelectorSpreadPriority：通过最小化资源方式，将属于同一种服务、控制器或同一Node上的Replica的 Pod的数量来分布Pod。如果节点上存在Zone，则会调整优先级，以便 pod可以分布在Zone之上。 CalculateAntiAffinityPriority：根据label来分布，按照相同service上相同label值的pod进行分配 ImageLocalityPriority ：根据Node上镜像进行打分，Node上存在Pod请求所需的镜像优先级较高。 在代码中查看上述的代码 以 PodFitsHostPorts 算法为例，因为是Node类算法，在kubernetes\\pkg\\scheduler\\framework\\plugins\\nodeports\n调度框架 [3] 调度框架 (scheduling framework SF ) 是kubernetes为 scheduler设计的一个pluggable的架构。SF 将scheduler设计为 Plugin 式的 API，API将上一章中提到的一些列调度策略实现为 Plugin。\n在 SF 中，定义了一些扩展点 （extension points EP ），而被实现为Plugin的调度程序将被注册在一个或多个 EP 中，换句话来说，在这些 EP 的执行过程中如果注册在多个 EP 中，将会在多个 EP 被调用。\n每次调度都分为两个阶段，调度周期（Scheduling Cycel）与绑定周期（Binding Cycle）。\nSC 表示为，为Pod选择一个节点；SC 是串行运行的。 BC 表示为，将 SC 决策结果应用于集群中；BC 可以同时运行。 调度周期与绑定周期结合一起，被称为调度上下文 （Scheduling Context）,下图则是调度上下文的工作流\n注：如果决策结果为Pod的调度结果无可用节点，或存在内部错误，则中止 SC 或 BC。Pod将重入队列重试\n图1：Pod的调度上下文 Source：https://kubernetes.io/docs/concepts/scheduling-eviction/scheduling-framework 扩展点 [4] 扩展点（Extension points）是指在调度上下文中的每个可扩展API，通过图提现为[图1]。其中 Filter 相当于 Predicate 而 Scoring 相当于 Priority。\n对于调度阶段会通过以下扩展点：\nSort：该插件提供了排序功能，用于对在调度队列中待处理 Pod 进行排序。一次只能启用一个队列排序。\npreFilter：该插件用于在过滤之前预处理或检查 Pod 或集群的相关信息。这里会终止调度\nfilter：该插件相当于调度上下文中的 Predicates，用于排除不能运行 Pod 的节点。Filter 会按配置的顺序进行调用。如果有一个filter将节点标记位不可用，则将 Pod 标记为不可调度（即不会向下执行）。\npostFilter：当没有为 pod 找到FN时，该插件会按照配置的顺序进行调用。如果任何postFilter插件将 Pod 标记为schedulable，则不会调用其余插件。即 filter 成功后不会进行这步骤\npreScore：可用于进行预Score工作（通知性的扩展点）。\nscore：该插件为每个通过 filter 阶段的Node提供打分服务。然后Scheduler将选择具有最高加权分数总和的Node。\nreserve：因为绑定事件时异步发生的，该插件是为了避免Pod在绑定到节点前时，调度到新的Pod，使节点使用资源超过可用资源情况。如果后续阶段发生错误或失败，将触发 UnReserve 回滚（通知性扩展点）。这也是作为调度周期中最后一个状态，要么成功到 postBind ，要么失败触发 UnReserve。\npermit：该插件可以阻止或延迟 Pod 的绑定，一般情况下这步骤会做三件事：\nappove ：调度器继续绑定过程 Deny：如果任何一个Premit拒绝了Pod与节点的绑定，那么将触发 UnReserve ，并重入队列 Wait： 如果 Permit 插件返回 Wait，该 Pod 将保留在内部 Wait Pod 列表中，直到被 Appove。如果发生超时，wait 变为 deny ，将Pod放回至调度队列中，并触发 Unreserve 回滚 。 preBind：该插件用于在 bind Pod 之前执行所需的前置工作。如，preBind 可能会提供一个网络卷并将其挂载到目标节点上。如果在该步骤中的任意插件返回错误，则Pod 将被 deny 并放置到调度队列中。\nbind：在所有的 preBind 完成后，该插件将用于将Pod绑定到Node，并按顺序调用绑定该步骤的插件。如果有一个插件处理了这个事件，那么则忽略其余所有插件。\npostBind：该插件在绑定 Pod 后调用，可用于清理相关资源（通知性的扩展点）。\nmultiPoint：这是一个仅配置字段，允许同时为所有适用的扩展点启用或禁用插件。\nkube-scheduler工作流分析 对于 kube-scheduler 组件的分析，包含 kube-scheduler 启动流程，以及scheduler调度流程。这里会主要针对启动流程分析，后面算法及二次开发部分会切入调度分析。\n对于我们部署时使用的 kube-scheduler 位于 cmd/kube-scheduler ，在 Alpha (1.16) 版本提供了调度框架的模式，到 Stable (1.19) ，从代码结构上是相似的；直到1.22后改变了代码风格。\n首先看到的是 kube-scheduler 的入口 cmd/kube-scheduler ，这里主要作为两部分，构建参数与启动server ,这里严格来讲 kube-scheduer 是作为一个server，而调度框架等部分是另外的。\ngo 1 2 3 4 5 func main() { command := app.NewSchedulerCommand() code := cli.Run(command) os.Exit(code) } cli.Run 提供了cobra构成的命令行cli，日志将输出为标准输出\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 // 这里是main中执行的Run func Run(cmd *cobra.Command) int { if logsInitialized, err := run(cmd); err != nil { if !logsInitialized { fmt.Fprintf(os.Stderr, \"Error: %v\\n\", err) } else { klog.ErrorS(err, \"command failed\") } return 1 } return 0 } // 这个run作为 func run(cmd *cobra.Command) (logsInitialized bool, err error) { rand.Seed(time.Now().UnixNano()) defer logs.FlushLogs() cmd.SetGlobalNormalizationFunc(cliflag.WordSepNormalizeFunc) if !cmd.SilenceUsage { cmd.SilenceUsage = true cmd.SetFlagErrorFunc(func(c *cobra.Command, err error) error { // Re-enable usage printing. c.SilenceUsage = false return err }) } // In all cases error printing is done below. cmd.SilenceErrors = true // This is idempotent. logs.AddFlags(cmd.PersistentFlags()) // Inject logs.InitLogs after command line parsing into one of the // PersistentPre* functions. switch { case cmd.PersistentPreRun != nil: pre := cmd.PersistentPreRun cmd.PersistentPreRun = func(cmd *cobra.Command, args []string) { logs.InitLogs() logsInitialized = true pre(cmd, args) } case cmd.PersistentPreRunE != nil: pre := cmd.PersistentPreRunE cmd.PersistentPreRunE = func(cmd *cobra.Command, args []string) error { logs.InitLogs() logsInitialized = true return pre(cmd, args) } default: cmd.PersistentPreRun = func(cmd *cobra.Command, args []string) { logs.InitLogs() logsInitialized = true } } err = cmd.Execute() return } 可以看到最终是调用 command.Execute() 执行，这个是执行本身构建的命令，而真正被执行的则是上面的 app.NewSchedulerCommand() ,那么来看看这个是什么\napp.NewSchedulerCommand() 构建了一个cobra.Commond对象， runCommand() 被封装在内，这个是作为启动scheduler的函数\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 func NewSchedulerCommand(registryOptions ...Option) *cobra.Command { opts := options.NewOptions() cmd := \u0026cobra.Command{ Use: \"kube-scheduler\", Long: `The Kubernetes scheduler is a control plane process which assigns Pods to Nodes. The scheduler determines which Nodes are valid placements for each Pod in the scheduling queue according to constraints and available resources. The scheduler then ranks each valid Node and binds the Pod to a suitable Node. Multiple different schedulers may be used within a cluster; kube-scheduler is the reference implementation. See [scheduling](https://kubernetes.io/docs/concepts/scheduling-eviction/) for more information about scheduling and the kube-scheduler component.`, RunE: func(cmd *cobra.Command, args []string) error { return runCommand(cmd, opts, registryOptions...) }, Args: func(cmd *cobra.Command, args []string) error { for _, arg := range args { if len(arg) \u003e 0 { return fmt.Errorf(\"%q does not take any arguments, got %q\", cmd.CommandPath(), args) } } return nil }, } nfs := opts.Flags verflag.AddFlags(nfs.FlagSet(\"global\")) globalflag.AddGlobalFlags(nfs.FlagSet(\"global\"), cmd.Name(), logs.SkipLoggingConfigurationFlags()) fs := cmd.Flags() for _, f := range nfs.FlagSets { fs.AddFlagSet(f) } cols, _, _ := term.TerminalSize(cmd.OutOrStdout()) cliflag.SetUsageAndHelpFunc(cmd, *nfs, cols) if err := cmd.MarkFlagFilename(\"config\", \"yaml\", \"yml\", \"json\"); err != nil { klog.ErrorS(err, \"Failed to mark flag filename\") } return cmd } 下面来看下 runCommand() 在启动 scheduler 时提供了什么功能。\n在新版中已经没有 algorithmprovider 的概念，所以在 runCommand 中做的也就是仅仅启动这个 scheduler ，而 scheduler 作为kubernetes组件，也是会watch等操作，自然少不了informer。其次作为和 controller-manager 相同的工作特性，kube-scheduler 也是 基于Leader选举的。\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 func Run(ctx context.Context, cc *schedulerserverconfig.CompletedConfig, sched *scheduler.Scheduler) error { // To help debugging, immediately log version klog.InfoS(\"Starting Kubernetes Scheduler\", \"version\", version.Get()) klog.InfoS(\"Golang settings\", \"GOGC\", os.Getenv(\"GOGC\"), \"GOMAXPROCS\", os.Getenv(\"GOMAXPROCS\"), \"GOTRACEBACK\", os.Getenv(\"GOTRACEBACK\")) // Configz registration. if cz, err := configz.New(\"componentconfig\"); err == nil { cz.Set(cc.ComponentConfig) } else { return fmt.Errorf(\"unable to register configz: %s\", err) } // Start events processing pipeline. cc.EventBroadcaster.StartRecordingToSink(ctx.Done()) defer cc.EventBroadcaster.Shutdown() // Setup healthz checks. var checks []healthz.HealthChecker if cc.ComponentConfig.LeaderElection.LeaderElect { checks = append(checks, cc.LeaderElection.WatchDog) } waitingForLeader := make(chan struct{}) isLeader := func() bool { select { case _, ok := \u003c-waitingForLeader: // if channel is closed, we are leading return !ok default: // channel is open, we are waiting for a leader return false } } // Start up the healthz server. if cc.SecureServing != nil { handler := buildHandlerChain(newHealthzAndMetricsHandler(\u0026cc.ComponentConfig, cc.InformerFactory, isLeader, checks...), cc.Authentication.Authenticator, cc.Authorization.Authorizer) // TODO: handle stoppedCh and listenerStoppedCh returned by c.SecureServing.Serve if _, _, err := cc.SecureServing.Serve(handler, 0, ctx.Done()); err != nil { // fail early for secure handlers, removing the old error loop from above return fmt.Errorf(\"failed to start secure server: %v\", err) } } // Start all informers. cc.InformerFactory.Start(ctx.Done()) // DynInformerFactory can be nil in tests. if cc.DynInformerFactory != nil { cc.DynInformerFactory.Start(ctx.Done()) } // Wait for all caches to sync before scheduling. cc.InformerFactory.WaitForCacheSync(ctx.Done()) // DynInformerFactory can be nil in tests. if cc.DynInformerFactory != nil { cc.DynInformerFactory.WaitForCacheSync(ctx.Done()) } // If leader election is enabled, runCommand via LeaderElector until done and exit. if cc.LeaderElection != nil { cc.LeaderElection.Callbacks = leaderelection.LeaderCallbacks{ OnStartedLeading: func(ctx context.Context) { close(waitingForLeader) sched.Run(ctx) }, OnStoppedLeading: func() { select { case \u003c-ctx.Done(): // We were asked to terminate. Exit 0. klog.InfoS(\"Requested to terminate, exiting\") os.Exit(0) default: // We lost the lock. klog.ErrorS(nil, \"Leaderelection lost\") klog.FlushAndExit(klog.ExitFlushTimeout, 1) } }, } leaderElector, err := leaderelection.NewLeaderElector(*cc.LeaderElection) if err != nil { return fmt.Errorf(\"couldn't create leader elector: %v\", err) } leaderElector.Run(ctx) return fmt.Errorf(\"lost lease\") } // Leader election is disabled, so runCommand inline until done. close(waitingForLeader) sched.Run(ctx) return fmt.Errorf(\"finished without leader elect\") } 上面看到了 runCommend 是作为启动 scheduler 的工作，那么通过参数构建一个 scheduler 则是在 Setup 中完成的。\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 // Setup creates a completed config and a scheduler based on the command args and options func Setup(ctx context.Context, opts *options.Options, outOfTreeRegistryOptions ...Option) (*schedulerserverconfig.CompletedConfig, *scheduler.Scheduler, error) { if cfg, err := latest.Default(); err != nil { return nil, nil, err } else { opts.ComponentConfig = cfg } // 验证参数 if errs := opts.Validate(); len(errs) \u003e 0 { return nil, nil, utilerrors.NewAggregate(errs) } // 构建一个config对象 c, err := opts.Config() if err != nil { return nil, nil, err } // 返回一个config对象，包含了scheduler所需的配置，如informer，leader selection cc := c.Complete() outOfTreeRegistry := make(runtime.Registry) for _, option := range outOfTreeRegistryOptions { if err := option(outOfTreeRegistry); err != nil { return nil, nil, err } } recorderFactory := getRecorderFactory(\u0026cc) completedProfiles := make([]kubeschedulerconfig.KubeSchedulerProfile, 0) // 创建出来的scheduler sched, err := scheduler.New(cc.Client, cc.InformerFactory, cc.DynInformerFactory, recorderFactory, ctx.Done(), scheduler.WithComponentConfigVersion(cc.ComponentConfig.TypeMeta.APIVersion), scheduler.WithKubeConfig(cc.KubeConfig), scheduler.WithProfiles(cc.ComponentConfig.Profiles...), scheduler.WithPercentageOfNodesToScore(cc.ComponentConfig.PercentageOfNodesToScore), scheduler.WithFrameworkOutOfTreeRegistry(outOfTreeRegistry), scheduler.WithPodMaxBackoffSeconds(cc.ComponentConfig.PodMaxBackoffSeconds), scheduler.WithPodInitialBackoffSeconds(cc.ComponentConfig.PodInitialBackoffSeconds), scheduler.WithPodMaxInUnschedulablePodsDuration(cc.PodMaxInUnschedulablePodsDuration), scheduler.WithExtenders(cc.ComponentConfig.Extenders...), scheduler.WithParallelism(cc.ComponentConfig.Parallelism), scheduler.WithBuildFrameworkCapturer(func(profile kubeschedulerconfig.KubeSchedulerProfile) { // Profiles are processed during Framework instantiation to set default plugins and configurations. Capturing them for logging completedProfiles = append(completedProfiles, profile) }), ) if err != nil { return nil, nil, err } if err := options.LogOrWriteConfig(opts.WriteConfigTo, \u0026cc.ComponentConfig, completedProfiles); err != nil { return nil, nil, err } return \u0026cc, sched, nil } 上面了解到了 scheduler 是如何被构建出来的，下面就看看 构建时参数是如何传递进来的，而对象 option就是对应需要的配置结构，而 ApplyTo 则是将启动时传入的参数转化为构建 scheduler 所需的配置。\n对于Deprecated flags可以参考官方对于kube-scheduler启动参数的说明 [5]\n对于如何编写一个scheduler config请参考 [6] 与 [7]\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 func (o *Options) ApplyTo(c *schedulerappconfig.Config) error { if len(o.ConfigFile) == 0 { // 在没有指定 --config时会找到 Deprecated flags:参数 // 通过kube-scheduler --help可以看到这些被弃用的参数 o.ApplyDeprecated() o.ApplyLeaderElectionTo(o.ComponentConfig) c.ComponentConfig = *o.ComponentConfig } else { // 这里就是指定了--config cfg, err := loadConfigFromFile(o.ConfigFile) if err != nil { return err } // 这里会将leader选举的参数附加到配置中 o.ApplyLeaderElectionTo(cfg) if err := validation.ValidateKubeSchedulerConfiguration(cfg); err != nil { return err } c.ComponentConfig = *cfg } if err := o.SecureServing.ApplyTo(\u0026c.SecureServing, \u0026c.LoopbackClientConfig); err != nil { return err } if o.SecureServing != nil \u0026\u0026 (o.SecureServing.BindPort != 0 || o.SecureServing.Listener != nil) { if err := o.Authentication.ApplyTo(\u0026c.Authentication, c.SecureServing, nil); err != nil { return err } if err := o.Authorization.ApplyTo(\u0026c.Authorization); err != nil { return err } } o.Metrics.Apply() // Apply value independently instead of using ApplyDeprecated() because it can't be configured via ComponentConfig. if o.Deprecated != nil { c.PodMaxInUnschedulablePodsDuration = o.Deprecated.PodMaxInUnschedulablePodsDuration } return nil } Setup 后会new一个 schedueler , New 则是这个动作，在里面可以看出，会初始化一些informer与 Pod的list等操作。\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 func New(client clientset.Interface, informerFactory informers.SharedInformerFactory, dynInformerFactory dynamicinformer.DynamicSharedInformerFactory, recorderFactory profile.RecorderFactory, stopCh \u003c-chan struct{}, opts ...Option) (*Scheduler, error) { stopEverything := stopCh if stopEverything == nil { stopEverything = wait.NeverStop } options := defaultSchedulerOptions // 默认调度策略，如percentageOfNodesToScore for _, opt := range opts { opt(\u0026options) // opt 是传入的函数，会返回一个schedulerOptions即相应的一些配置 } if options.applyDefaultProfile { // 这个是个bool类型，默认scheduler会到这里 // Profile包含了调度器的名称与调度器在两个过程中使用的插件 var versionedCfg v1beta3.KubeSchedulerConfiguration scheme.Scheme.Default(\u0026versionedCfg) cfg := schedulerapi.KubeSchedulerConfiguration{} // 初始化一个配置，这个是--config传入的类型。因为默认的调度策略会初始化 // convert 会将in转为out即versionedCfg转换为cfg if err := scheme.Scheme.Convert(\u0026versionedCfg, \u0026cfg, nil); err != nil { return nil, err } options.profiles = cfg.Profiles } registry := frameworkplugins.NewInTreeRegistry() // 调度框架的注册 if err := registry.Merge(options.frameworkOutOfTreeRegistry); err != nil { return nil, err } metrics.Register() // 指标类 extenders, err := buildExtenders(options.extenders, options.profiles) if err != nil { return nil, fmt.Errorf(\"couldn't build extenders: %w\", err) } podLister := informerFactory.Core().V1().Pods().Lister() nodeLister := informerFactory.Core().V1().Nodes().Lister() // The nominator will be passed all the way to framework instantiation. nominator := internalqueue.NewPodNominator(podLister) snapshot := internalcache.NewEmptySnapshot() clusterEventMap := make(map[framework.ClusterEvent]sets.String) profiles, err := profile.NewMap(options.profiles, registry, recorderFactory, stopCh, frameworkruntime.WithComponentConfigVersion(options.componentConfigVersion), frameworkruntime.WithClientSet(client), frameworkruntime.WithKubeConfig(options.kubeConfig), frameworkruntime.WithInformerFactory(informerFactory), frameworkruntime.WithSnapshotSharedLister(snapshot), frameworkruntime.WithPodNominator(nominator), frameworkruntime.WithCaptureProfile(frameworkruntime.CaptureProfile(options.frameworkCapturer)), frameworkruntime.WithClusterEventMap(clusterEventMap), frameworkruntime.WithParallelism(int(options.parallelism)), frameworkruntime.WithExtenders(extenders), ) if err != nil { return nil, fmt.Errorf(\"initializing profiles: %v\", err) } if len(profiles) == 0 { return nil, errors.New(\"at least one profile is required\") } podQueue := internalqueue.NewSchedulingQueue( profiles[options.profiles[0].SchedulerName].QueueSortFunc(), informerFactory, internalqueue.WithPodInitialBackoffDuration(time.Duration(options.podInitialBackoffSeconds)*time.Second), internalqueue.WithPodMaxBackoffDuration(time.Duration(options.podMaxBackoffSeconds)*time.Second), internalqueue.WithPodNominator(nominator), internalqueue.WithClusterEventMap(clusterEventMap), internalqueue.WithPodMaxInUnschedulablePodsDuration(options.podMaxInUnschedulablePodsDuration), ) schedulerCache := internalcache.New(durationToExpireAssumedPod, stopEverything) // Setup cache debugger. debugger := cachedebugger.New(nodeLister, podLister, schedulerCache, podQueue) debugger.ListenForSignal(stopEverything) sched := newScheduler( schedulerCache, extenders, internalqueue.MakeNextPodFunc(podQueue), MakeDefaultErrorFunc(client, podLister, podQueue, schedulerCache), stopEverything, podQueue, profiles, client, snapshot, options.percentageOfNodesToScore, ) // 这个就是controller中onAdd等那三个必须的事件函数 addAllEventHandlers(sched, informerFactory, dynInformerFactory, unionedGVKs(clusterEventMap)) return sched, nil } 接下来会启动这个 scheduler， 在上面我们看到 NewSchedulerCommand 构建了一个cobra.Commond对象， runCommand() 最终会返回个 Run，而这个Run就是启动这个 sche 的。\n下面这个 run 是 sche 的运行，他运行并watch资源，直到上下文完成。\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 func (sched *Scheduler) Run(ctx context.Context) { sched.SchedulingQueue.Run() // We need to start scheduleOne loop in a dedicated goroutine, // because scheduleOne function hangs on getting the next item // from the SchedulingQueue. // If there are no new pods to schedule, it will be hanging there // and if done in this goroutine it will be blocking closing // SchedulingQueue, in effect causing a deadlock on shutdown. go wait.UntilWithContext(ctx, sched.scheduleOne, 0) \u003c-ctx.Done() sched.SchedulingQueue.Close() } 而调用这个 Run 的部分则是作为server的 kube-scheduler 中的 run\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 // Run executes the scheduler based on the given configuration. It only returns on error or when context is done. func Run(ctx context.Context, cc *schedulerserverconfig.CompletedConfig, sched *scheduler.Scheduler) error { // To help debugging, immediately log version klog.InfoS(\"Starting Kubernetes Scheduler\", \"version\", version.Get()) klog.InfoS(\"Golang settings\", \"GOGC\", os.Getenv(\"GOGC\"), \"GOMAXPROCS\", os.Getenv(\"GOMAXPROCS\"), \"GOTRACEBACK\", os.Getenv(\"GOTRACEBACK\")) // Configz registration. if cz, err := configz.New(\"componentconfig\"); err == nil { cz.Set(cc.ComponentConfig) } else { return fmt.Errorf(\"unable to register configz: %s\", err) } // Start events processing pipeline. cc.EventBroadcaster.StartRecordingToSink(ctx.Done()) defer cc.EventBroadcaster.Shutdown() // Setup healthz checks. var checks []healthz.HealthChecker if cc.ComponentConfig.LeaderElection.LeaderElect { checks = append(checks, cc.LeaderElection.WatchDog) } waitingForLeader := make(chan struct{}) isLeader := func() bool { select { case _, ok := \u003c-waitingForLeader: // if channel is closed, we are leading return !ok default: // channel is open, we are waiting for a leader return false } } // Start up the healthz server. if cc.SecureServing != nil { handler := buildHandlerChain(newHealthzAndMetricsHandler(\u0026cc.ComponentConfig, cc.InformerFactory, isLeader, checks...), cc.Authentication.Authenticator, cc.Authorization.Authorizer) // TODO: handle stoppedCh and listenerStoppedCh returned by c.SecureServing.Serve if _, _, err := cc.SecureServing.Serve(handler, 0, ctx.Done()); err != nil { // fail early for secure handlers, removing the old error loop from above return fmt.Errorf(\"failed to start secure server: %v\", err) } } // Start all informers. cc.InformerFactory.Start(ctx.Done()) // DynInformerFactory can be nil in tests. if cc.DynInformerFactory != nil { cc.DynInformerFactory.Start(ctx.Done()) } // Wait for all caches to sync before scheduling. cc.InformerFactory.WaitForCacheSync(ctx.Done()) // DynInformerFactory can be nil in tests. if cc.DynInformerFactory != nil { cc.DynInformerFactory.WaitForCacheSync(ctx.Done()) } // If leader election is enabled, runCommand via LeaderElector until done and exit. if cc.LeaderElection != nil { cc.LeaderElection.Callbacks = leaderelection.LeaderCallbacks{ OnStartedLeading: func(ctx context.Context) { close(waitingForLeader) sched.Run(ctx) }, OnStoppedLeading: func() { select { case \u003c-ctx.Done(): // We were asked to terminate. Exit 0. klog.InfoS(\"Requested to terminate, exiting\") os.Exit(0) default: // We lost the lock. klog.ErrorS(nil, \"Leaderelection lost\") klog.FlushAndExit(klog.ExitFlushTimeout, 1) } }, } leaderElector, err := leaderelection.NewLeaderElector(*cc.LeaderElection) if err != nil { return fmt.Errorf(\"couldn't create leader elector: %v\", err) } leaderElector.Run(ctx) return fmt.Errorf(\"lost lease\") } // Leader election is disabled, so runCommand inline until done. close(waitingForLeader) sched.Run(ctx) return fmt.Errorf(\"finished without leader elect\") } 而上面的 server.Run 会被 runCommand 也就是在 NewSchedulerCommand 时被返回，在 kube-scheduler 的入口文件中被执行。\ngo 1 2 3 4 5 6 cc, sched, err := Setup(ctx, opts, registryOptions...) if err != nil { return err } return Run(ctx, cc, sched) 至此，整个 kube-scheduler 启动流就分析完了，这个的流程可以用下图表示\n图2：scheduler server运行流程 Reference [1] kube scheduler\n[2] Scheduler Algorithm in Kubernetes\n[3] scheduling framework\n[4] permit\n[5] kube-scheduler parmater\n[6] kube-scheduler config.v1beta3/\n[7] kube-scheduler config\n","wordCount":"2679","inLanguage":"zh","datePublished":"2022-07-18T00:00:00Z","dateModified":"0001-01-01T00:00:00Z","author":{"@type":"Person","name":"cylon"},"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:1313/2022/07/ch16-scheduler/"},"publisher":{"@type":"Organization","name":"Cylon's Collection","logo":{"@type":"ImageObject","url":"http://localhost:1313/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=http://localhost:1313/><img src=http://localhost:1313/favicon.ico alt aria-label=logo height=20>Cylon's Collection</a><div class=logo-switches><button id=theme-toggle><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=http://localhost:1313/archives><span>归档</span></a></li><li><a href=http://localhost:1313/tags><span>标签</span></a></li><li><a href=http://localhost:1313/search><span>搜索</span></a></li><li><a href=http://localhost:1313/about accesskey=/><span>关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">kubernetes的决策组件 - kube-scheduler原理分析</h1><div class=post-meta><span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar" style="user-select:text"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" style="user-select:text"/><line x1="16" y1="2" x2="16" y2="6" style="user-select:text"/><line x1="8" y1="2" x2="8" y2="6" style="user-select:text"/><line x1="3" y1="10" x2="21" y2="10" style="user-select:text"/></svg><span>2022-07-18</span></span>&nbsp;·&nbsp;<span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text" style="user-select:text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z" style="user-select:text"/><polyline points="14 2 14 8 20 8" style="user-select:text"/><line x1="16" y1="13" x2="8" y2="13" style="user-select:text"/><line x1="16" y1="17" x2="8" y2="17" style="user-select:text"/><polyline points="10 9 9 9 8 9" style="user-select:text"/></svg><span>2679 字</span></span>&nbsp;·&nbsp;<span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><span>13 分钟</span></span>
<span class=pe-post-meta-item>&nbsp;·&nbsp;<svg t="1714036239378" fill="currentcolor" class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="6659" width="256" height="256"><path d="M690 78.2c-18.6-18.8-49-19-67.8-.4s-19 49-.4 67.8l255.4 258.6c67.8 68.6 67.8 178.8.0 247.4L653.4 878.2c-18.6 18.8-18.4 49.2.4 67.8s49.2 18.4 67.8-.4l224-226.4c104.8-106 104.8-276.4.0-382.4L690 78.2zM485.4 101.4c-24-24-56.6-37.4-90.6-37.4H96C43 64 0 107 0 160v299c0 34 13.4 66.6 37.4 90.6l336 336c50 50 131 50 181 0l267-267c50-50 50-131 0-181l-336-336zM96 160h299c8.4.0 16.6 3.4 22.6 9.4l336 336c12.4 12.4 12.4 32.8.0 45.2l-267 267c-12.4 12.4-32.8 12.4-45.2.0l-336-336c-6-6-9.4-14.2-9.4-22.6V160zm192 128a64 64 0 10-128 0 64 64 0 10128 0z" p-id="6660"/></svg></span><ul class=pe-post-meta-item><a href=http://localhost:1313/tags/kubernetes-develop/>#Kubernetes Develop</a>
<a href=http://localhost:1313/tags/kubernetes/>#Kubernetes</a></ul></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details><summary><span class=details>目录</span></summary><div class=inner><ul><li><a href=#overview-supa-href11asup aria-label="Overview [1]">Overview <sup><a href=#1>[1]</a></sup></a><ul><li><a href=#%e5%a6%82%e4%bd%95%e4%b8%bapod%e9%80%89%e6%8b%a9%e8%8a%82%e7%82%b9 aria-label=如何为pod选择节点？>如何为pod选择节点？</a></ul><li><a href=#kubernetes%e7%9a%84%e8%b0%83%e5%ba%a6%e7%ad%96%e7%95%a5 aria-label=kubernetes的调度策略>kubernetes的调度策略</a><ul><li><a href=#%e4%b8%bapod%e9%a2%84%e9%80%89%e8%8a%82%e7%82%b9-supa-href22asup aria-label="为Pod预选节点 [2]">为Pod预选节点 <sup><a href=#2>[2]</a></sup></a><li><a href=#%e5%af%b9%e9%a2%84%e9%80%89%e8%8a%82%e7%82%b9%e6%89%93%e5%88%86-supa-href22asup aria-label="对预选节点打分 [2]">对预选节点打分 <sup><a href=#2>[2]</a></sup></a><li><a href=#%e5%9c%a8%e4%bb%a3%e7%a0%81%e4%b8%ad%e6%9f%a5%e7%9c%8b%e4%b8%8a%e8%bf%b0%e7%9a%84%e4%bb%a3%e7%a0%81 aria-label=在代码中查看上述的代码>在代码中查看上述的代码</a></ul><li><a href=#%e8%b0%83%e5%ba%a6%e6%a1%86%e6%9e%b6-supa-href33asup aria-label="调度框架 [3]">调度框架 <sup><a href=#3>[3]</a></sup></a><ul><li><a href=#%e6%89%a9%e5%b1%95%e7%82%b9-supa-href44asup aria-label="扩展点 [4]">扩展点 <sup><a href=#4>[4]</a></sup></a></ul><li><a href=#kube-scheduler%e5%b7%a5%e4%bd%9c%e6%b5%81%e5%88%86%e6%9e%90 aria-label=kube-scheduler工作流分析>kube-scheduler工作流分析</a><li><a href=#reference aria-label=Reference>Reference</a></li></div></details></div></aside><script src=/js/pe-toc.min.445eb1bfc5e85dd13b9519fcc2a806522e9629b6224a2974052789ba00ab78af.js integrity="sha256-RF6xv8XoXdE7lRn8wqgGUi6WKbYiSil0BSeJugCreK8="></script><div class=post-content><h2 id=overview-supa-href11asup>Overview <sup><a href=#1>[1]</a></sup><a hidden class=anchor aria-hidden=true href=#overview-supa-href11asup>#</a></h2><p>kubernetes集群中的调度程序 <code>kube-scheduler</code> 会 <code>watch</code> 未分配节点的新创建的Pod，并未该Pod找到可运行的最佳（特定）节点。那么这些动作或者说这些原理是怎么实现的呢，让我们往下剖析下。</p><p>对于新创建的 pod 或其他未调度的 pod来讲，kube-scheduler 选择一个最佳节点供它们运行。但是，Pod 中的每个容器对资源的要求都不同，每个 Pod 也有不同的要求。因此，需要根据具体的调度要求对现有节点进行过滤。</p><p>在Kubernetes集群中，满足 Pod 调度要求的节点称为可行节点 （<code> feasible nodes</code> <em>FN</em>） 。如果没有合适的节点，则 pod 将保持未调度状态，直到调度程序能够放置它。也就是说，当我们创建Pod时，如果长期处于 <code>Pending</code> 状态，这个时候应该看你的集群调度器是否因为某些问题没有合适的节点了</p><p>调度器为 Pod 找到 FN 后，然后运行一组函数对 FN 进行评分，并在 FN 中找到得分最高的节点来运行 Pod。</p><p>调度策略在决策时需要考虑的因素包括个人和集体资源需求、硬件/软件/策略约束 （<code>constraints</code>）、亲和性 (<code>affinity</code>) 和反亲和性（ <code>anti-affinity</code> ）规范、数据局部性、工作负载间干扰等。</p><h3 id=如何为pod选择节点>如何为pod选择节点？<a hidden class=anchor aria-hidden=true href=#如何为pod选择节点>#</a></h3><p><code>kube-scheduler</code> 为pod选择节点会分位两部：</p><ul><li>过滤 (<code>Filtering</code>)</li><li>打分 (<code>Scoring</code>)</li></ul><p>过滤也被称为预选 （<code>Predicates</code>），该步骤会找到可调度的节点集，然后通过是否满足特定资源的请求，例如通过 <code>PodFitsResources</code> 过滤器检查候选节点是否有足够的资源来满足 Pod 资源的请求。这个步骤完成后会得到一个包含合适的节点的列表（通常为多个），如果列表为空，则Pod不可调度。</p><p>打分也被称为优选（<code>Priorities</code>），在该步骤中，会对上一个步骤的输出进行打分，Scheduer 通过打分的规则为每个通过 <code>Filtering</code> 步骤的节点计算出一个分数。</p><p>完成上述两个步骤之后，<code>kube-scheduler</code> 会将Pod分配给分数最高的 Node，如果存在多个相同分数的节点，会随机选择一个。</p><h2 id=kubernetes的调度策略>kubernetes的调度策略<a hidden class=anchor aria-hidden=true href=#kubernetes的调度策略>#</a></h2><p>Kubernetes 1.21之前版本可以在代码 <a href=https://github.com/kubernetes/kubernetes/blob/release-1.21/pkg/scheduler/algorithmprovider/registry.go target=_blank rel="noopener nofollow noreferrer">kubernetes\pkg\scheduler\algorithmprovider\registry.go</a> 中看到对应的注册模式，在1.22 scheduler 更换了其路径，对于registry文件更换到了<a href=https://github.com/kubernetes/kubernetes/blob/release-1.24/pkg/scheduler/framework/plugins/registry.go target=_blank rel="noopener nofollow noreferrer">kubernetes\pkg\scheduler\framework\plugins\registry.go</a> ；对于kubernetes官方说法为，<em>调度策略是用于“预选” (<code>Predicates </code>)或 过滤（<code>filtering </code>） 和 用于 优选（<code>Priorities</code>）或 评分 (<code>scoring</code>)的</em></p><blockquote><p>注：kubernetes官方没有找到预选和优选的概念，而Predicates和filtering 是处于预选阶段的动词，而Priorities和scoring是优选阶段的动词。后面用PF和PS代替这个两个词。</p></blockquote><h3 id=为pod预选节点-supa-href22asup>为Pod预选节点 <sup><a href=#2>[2]</a></sup><a hidden class=anchor aria-hidden=true href=#为pod预选节点-supa-href22asup>#</a></h3><p>上面也提到了，<code>filtering</code> 的目的是为了排除（过滤）掉不满足 Pod 要求的节点。例如，某个节点上的闲置资源小于 Pod 所需资源，则该节点不会被考虑在内，即被过滤掉。在 <em>“Predicates”</em> 阶段实现的 <em>filtering</em> 策略，包括：</p><ul><li><code>NoDiskConflict</code> ：评估是否有合适Pod请求的卷</li><li><code>NoVolumeZoneConflict</code>：在给定zone限制情况下，评估Pod请求所需的卷在Node上是否可用</li><li><code>PodFitsResources</code>：检查空闲资源（CPU、内存）是否满足Pod请求</li><li><code>PodFitsHostPorts</code>：检查Pod所需端口在Node上是否被占用</li><li><code>HostName</code>： 过滤除去，<code>PodSpec</code> 中 <code>NodeName</code> 字段中指定的Node之外的所有Node。</li><li><code>MatchNodeSelector</code>：检查Node的 <em>label</em> 是否与 <em>Pod</em> 配置中 <code>nodeSelector</code>字段中指定的 <em>label</em> 匹配，并且从 Kubernetes v1.2 开始， 如果存在 <code>nodeAffinity</code> 也会匹配。</li><li><code>CheckNodeMemoryPressure</code>：检查是否可以在已出现内存压力情况节点上调度 Pod。</li><li><code>CheckNodeDiskPressure</code>：检查是否可以在报告磁盘压力情况的节点上调度 Pod</li></ul><p>具体对应得策略可以在 kubernetes\pkg\scheduler\framework\plugins\registry.go 看到</p><h3 id=对预选节点打分-supa-href22asup>对预选节点打分 <sup><a href=#2>[2]</a></sup><a hidden class=anchor aria-hidden=true href=#对预选节点打分-supa-href22asup>#</a></h3><p>通过上面步骤过滤过得列表则是适合托管的Pod，这个结果通常来说是一个列表，如何选择最优Node进行调度，则是接下来打分的步骤步骤。</p><p>例如：Kubernetes对剩余节点进行优先级排序，优先级由一组函数计算；优先级函数将为剩余节点给出从<code>0~10</code> 的分数，10 表示最优，0 表示最差。每个优先级函数由一个正数加权组成，每个Node的得分是通过将所有加权得分相加来计算的。设有两个优先级函数，<code>priorityFunc1</code> 和 <code>priorityFunc2</code> 加上权重因子 <code>weight1</code> 和<code>weight2</code>，那么这个Node的最终得分为：$finalScore = (w1 \times priorityFunc1) + (w2 \times priorityFunc2)$。计算完分数后，选择最高分数的Node做为Pod的宿主机，存在多个相同分数Node情况下会随机选择一个Node。</p><p>目前kubernetes提供了一些在打分 <em>Scoring</em> 阶段算法：</p><ul><li><code>LeastRequestedPriority</code>：Node的优先级基于Node的空闲部分$\frac{capacity\ -\ Node上所有存在的Pod\ -\ 正在调度的Pod请求}{capacity}$，通过计算具有最高分数的Node是FN</li><li><code>BalancedResourceAllocation</code> ：该算法会将 Pod 放在一个Node上，使得在Pod 部署后 CPU 和内存的使用率为平衡的</li><li><code>SelectorSpreadPriority</code>：通过最小化资源方式，将属于同一种服务、控制器或同一Node上的Replica的 Pod的数量来分布Pod。如果节点上存在Zone，则会调整优先级，以便 pod可以分布在Zone之上。</li><li><code>CalculateAntiAffinityPriority</code>：根据label来分布，按照相同service上相同label值的pod进行分配</li><li><code>ImageLocalityPriority</code> ：根据Node上镜像进行打分，Node上存在Pod请求所需的镜像优先级较高。</li></ul><h3 id=在代码中查看上述的代码>在代码中查看上述的代码<a hidden class=anchor aria-hidden=true href=#在代码中查看上述的代码>#</a></h3><p>以 <code>PodFitsHostPorts</code> 算法为例，因为是Node类算法，在<a href=https://github.com/kubernetes/kubernetes/tree/release-1.23/pkg/scheduler/framework/plugins/nodeports target=_blank rel="noopener nofollow noreferrer">kubernetes\pkg\scheduler\framework\plugins\nodeports</a></p><h2 id=调度框架-supa-href33asup>调度框架 <sup><a href=#3>[3]</a></sup><a hidden class=anchor aria-hidden=true href=#调度框架-supa-href33asup>#</a></h2><p>调度框架 (<code>scheduling framework</code> <em>SF</em> ) 是kubernetes为 scheduler设计的一个pluggable的架构。SF 将scheduler设计为 <em>Plugin</em> 式的 API，API将上一章中提到的一些列调度策略实现为 <code>Plugin</code>。</p><p>在 <em>SF</em> 中，定义了一些扩展点 （<code>extension points</code> <em>EP</em> ），而被实现为Plugin的调度程序将被注册在一个或多个 <em>EP</em> 中，换句话来说，在这些 <em>EP</em> 的执行过程中如果注册在多个 <em>EP</em> 中，将会在多个 <em>EP</em> 被调用。</p><p>每次调度都分为两个阶段，调度周期（<code>Scheduling Cycel</code>）与绑定周期（<code>Binding Cycle</code>）。</p><ul><li><em>SC</em> 表示为，为Pod选择一个节点；<em>SC</em> 是串行运行的。</li><li><em>BC</em> 表示为，将 <em>SC</em> 决策结果应用于集群中；<em>BC</em> 可以同时运行。</li></ul><p>调度周期与绑定周期结合一起，被称为<strong>调度上下文</strong> （<code>Scheduling Context</code>）,下图则是调度上下文的工作流</p><blockquote><p>注：如果决策结果为Pod的调度结果无可用节点，或存在内部错误，则中止 <em>SC</em> 或 <em>BC</em>。Pod将重入队列重试</p></blockquote><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/scheduling-framework-extensions.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/scheduling-framework-extensions.png#center alt=img onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><center class=podsc>图1：Pod的调度上下文</center><center><em>Source：</em>https://kubernetes.io/docs/concepts/scheduling-eviction/scheduling-framework</center><h3 id=扩展点-supa-href44asup>扩展点 <sup><a href=#4>[4]</a></sup><a hidden class=anchor aria-hidden=true href=#扩展点-supa-href44asup>#</a></h3><p>扩展点（<code>Extension points</code>）是指在<em>调度上下文</em>中的每个可扩展API，通过图提现为<a href=#podsc>[图1]</a>。其中 <code>Filter</code> 相当于 <code>Predicate</code> 而 <code>Scoring</code> 相当于 <code>Priority</code>。</p><p>对于调度阶段会通过以下扩展点：</p><ul><li><p><code>Sort</code>：该插件提供了排序功能，用于对在调度队列中待处理 Pod 进行排序。一次只能启用一个队列排序。</p></li><li><p><code>preFilter</code>：该插件用于在过滤之前预处理或检查 Pod 或集群的相关信息。这里会终止调度</p></li><li><p><code>filter</code>：该插件相当于<em>调度上下文</em>中的 <code>Predicates</code>，用于排除不能运行 Pod 的节点。Filter 会按配置的顺序进行调用。如果有一个filter将节点标记位不可用，则将 Pod 标记为不可调度（即不会向下执行）。</p></li><li><p><code>postFilter</code>：当没有为 pod 找到<em>FN</em>时，该插件会按照配置的顺序进行调用。如果任何<code>postFilter</code>插件将 Pod 标记为<em>schedulable</em>，则不会调用其余插件。即 <code>filter</code> 成功后不会进行这步骤</p></li><li><p><code>preScore</code>：可用于进行预Score工作（通知性的扩展点）。</p></li><li><p><code>score</code>：该插件为每个通过 <code>filter</code> 阶段的Node提供打分服务。然后Scheduler将选择具有最高加权分数总和的Node。</p></li><li><p><code>reserve</code>：因为绑定事件时异步发生的，该插件是为了避免Pod在绑定到节点前时，调度到新的Pod，使节点使用资源超过可用资源情况。如果后续阶段发生错误或失败，将触发 <code>UnReserve</code> 回滚（通知性扩展点）。这也是作为调度周期中最后一个状态，要么成功到 <code>postBind</code> ，要么失败触发 <code>UnReserve</code>。</p></li><li><p><code>permit</code>：该插件可以阻止或延迟 Pod 的绑定，一般情况下这步骤会做三件事：</p><ul><li><code>appove</code> ：调度器继续绑定过程</li><li><code>Deny</code>：如果任何一个Premit拒绝了Pod与节点的绑定，那么将触发 <code>UnReserve</code> ，并重入队列</li><li><code>Wait</code>： 如果 Permit 插件返回 <code>Wait</code>，该 Pod 将保留在内部 <code>Wait</code> Pod 列表中，直到被 <code>Appove</code>。如果发生超时，<code>wait</code> 变为 <code>deny</code> ，将Pod放回至调度队列中，并触发 <code>Unreserve</code> 回滚 。</li></ul></li><li><p><code>preBind</code>：该插件用于在 bind Pod 之前执行所需的前置工作。如，<code>preBind</code> 可能会提供一个网络卷并将其挂载到目标节点上。如果在该步骤中的任意插件返回错误，则Pod 将被 <code>deny</code> 并放置到调度队列中。</p></li><li><p><code>bind</code>：在所有的 <code>preBind</code> 完成后，该插件将用于将Pod绑定到Node，并按顺序调用绑定该步骤的插件。如果有一个插件处理了这个事件，那么则忽略其余所有插件。</p></li><li><p><code>postBind</code>：该插件在绑定 Pod 后调用，可用于清理相关资源（通知性的扩展点）。</p></li><li><p><code>multiPoint</code>：这是一个仅配置字段，允许同时为所有适用的扩展点启用或禁用插件。</p></li></ul><h2 id=kube-scheduler工作流分析>kube-scheduler工作流分析<a hidden class=anchor aria-hidden=true href=#kube-scheduler工作流分析>#</a></h2><p>对于 <code>kube-scheduler</code> 组件的分析，包含 <code>kube-scheduler</code> 启动流程，以及scheduler调度流程。这里会主要针对启动流程分析，后面算法及二次开发部分会切入调度分析。</p><p>对于我们部署时使用的 <code>kube-scheduler</code> 位于 <a href=https://github.com/kubernetes/kubernetes/tree/release-1.24/cmd/kube-scheduler target=_blank rel="noopener nofollow noreferrer">cmd/kube-scheduler</a> ，在 <em>Alpha (1.16)</em> 版本提供了调度框架的模式，到 <em>Stable (1.19)</em> ，从代码结构上是相似的；直到1.22后改变了代码风格。</p><p>首先看到的是 <code>kube-scheduler</code> 的入口 <a href=https://github.com/kubernetes/kubernetes/blob/release-1.24/cmd/kube-scheduler/scheduler.go target=_blank rel="noopener nofollow noreferrer">cmd/kube-scheduler</a> ，这里主要作为两部分，构建参数与启动<code>server</code> ,这里严格来讲 <code>kube-scheduer</code> 是作为一个server，而调度框架等部分是另外的。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>command</span> <span class=o>:=</span> <span class=nx>app</span><span class=p>.</span><span class=nf>NewSchedulerCommand</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>code</span> <span class=o>:=</span> <span class=nx>cli</span><span class=p>.</span><span class=nf>Run</span><span class=p>(</span><span class=nx>command</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>os</span><span class=p>.</span><span class=nf>Exit</span><span class=p>(</span><span class=nx>code</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p><code>cli.Run</code> 提供了cobra构成的命令行cli，日志将输出为标准输出</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 这里是main中执行的Run
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>Run</span><span class=p>(</span><span class=nx>cmd</span> <span class=o>*</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span><span class=p>)</span> <span class=kt>int</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>logsInitialized</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>run</span><span class=p>(</span><span class=nx>cmd</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>!</span><span class=nx>logsInitialized</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>fmt</span><span class=p>.</span><span class=nf>Fprintf</span><span class=p>(</span><span class=nx>os</span><span class=p>.</span><span class=nx>Stderr</span><span class=p>,</span> <span class=s>&#34;Error: %v\n&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>klog</span><span class=p>.</span><span class=nf>ErrorS</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=s>&#34;command failed&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 这个run作为
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>run</span><span class=p>(</span><span class=nx>cmd</span> <span class=o>*</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span><span class=p>)</span> <span class=p>(</span><span class=nx>logsInitialized</span> <span class=kt>bool</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>rand</span><span class=p>.</span><span class=nf>Seed</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>().</span><span class=nf>UnixNano</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>logs</span><span class=p>.</span><span class=nf>FlushLogs</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>cmd</span><span class=p>.</span><span class=nf>SetGlobalNormalizationFunc</span><span class=p>(</span><span class=nx>cliflag</span><span class=p>.</span><span class=nx>WordSepNormalizeFunc</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>!</span><span class=nx>cmd</span><span class=p>.</span><span class=nx>SilenceUsage</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>cmd</span><span class=p>.</span><span class=nx>SilenceUsage</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>		<span class=nx>cmd</span><span class=p>.</span><span class=nf>SetFlagErrorFunc</span><span class=p>(</span><span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// Re-enable usage printing.
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>c</span><span class=p>.</span><span class=nx>SilenceUsage</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>		<span class=p>})</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// In all cases error printing is done below.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>cmd</span><span class=p>.</span><span class=nx>SilenceErrors</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// This is idempotent.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>logs</span><span class=p>.</span><span class=nf>AddFlags</span><span class=p>(</span><span class=nx>cmd</span><span class=p>.</span><span class=nf>PersistentFlags</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Inject logs.InitLogs after command line parsing into one of the
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// PersistentPre* functions.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>switch</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=nx>cmd</span><span class=p>.</span><span class=nx>PersistentPreRun</span> <span class=o>!=</span> <span class=kc>nil</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=nx>pre</span> <span class=o>:=</span> <span class=nx>cmd</span><span class=p>.</span><span class=nx>PersistentPreRun</span>
</span></span><span class=line><span class=cl>		<span class=nx>cmd</span><span class=p>.</span><span class=nx>PersistentPreRun</span> <span class=p>=</span> <span class=kd>func</span><span class=p>(</span><span class=nx>cmd</span> <span class=o>*</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span><span class=p>,</span> <span class=nx>args</span> <span class=p>[]</span><span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>logs</span><span class=p>.</span><span class=nf>InitLogs</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=nx>logsInitialized</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>			<span class=nf>pre</span><span class=p>(</span><span class=nx>cmd</span><span class=p>,</span> <span class=nx>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=nx>cmd</span><span class=p>.</span><span class=nx>PersistentPreRunE</span> <span class=o>!=</span> <span class=kc>nil</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=nx>pre</span> <span class=o>:=</span> <span class=nx>cmd</span><span class=p>.</span><span class=nx>PersistentPreRunE</span>
</span></span><span class=line><span class=cl>		<span class=nx>cmd</span><span class=p>.</span><span class=nx>PersistentPreRunE</span> <span class=p>=</span> <span class=kd>func</span><span class=p>(</span><span class=nx>cmd</span> <span class=o>*</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span><span class=p>,</span> <span class=nx>args</span> <span class=p>[]</span><span class=kt>string</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>logs</span><span class=p>.</span><span class=nf>InitLogs</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=nx>logsInitialized</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nf>pre</span><span class=p>(</span><span class=nx>cmd</span><span class=p>,</span> <span class=nx>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=nx>cmd</span><span class=p>.</span><span class=nx>PersistentPreRun</span> <span class=p>=</span> <span class=kd>func</span><span class=p>(</span><span class=nx>cmd</span> <span class=o>*</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span><span class=p>,</span> <span class=nx>args</span> <span class=p>[]</span><span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>logs</span><span class=p>.</span><span class=nf>InitLogs</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=nx>logsInitialized</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>err</span> <span class=p>=</span> <span class=nx>cmd</span><span class=p>.</span><span class=nf>Execute</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>可以看到最终是调用 <code>command.Execute() </code>执行，这个是执行本身构建的命令，而真正被执行的则是上面的 <code>app.NewSchedulerCommand()</code> ,那么来看看这个是什么</p><p><a href=https://github.com/kubernetes/kubernetes/blob/140c27533044e9e00f800d3ad0517540e3e4ecad/cmd/kube-scheduler/app/server.go#L72-L114 target=_blank rel="noopener nofollow noreferrer">app.NewSchedulerCommand()</a> 构建了一个cobra.Commond对象， <a href=https://github.com/kubernetes/kubernetes/blob/140c27533044e9e00f800d3ad0517540e3e4ecad/cmd/kube-scheduler/app/server.go#L117-L142 target=_blank rel="noopener nofollow noreferrer">runCommand()</a> 被封装在内，这个是作为启动scheduler的函数</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>NewSchedulerCommand</span><span class=p>(</span><span class=nx>registryOptions</span> <span class=o>...</span><span class=nx>Option</span><span class=p>)</span> <span class=o>*</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>opts</span> <span class=o>:=</span> <span class=nx>options</span><span class=p>.</span><span class=nf>NewOptions</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>cmd</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>Use</span><span class=p>:</span> <span class=s>&#34;kube-scheduler&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>Long</span><span class=p>:</span> <span class=s>`The Kubernetes scheduler is a control plane process which assigns
</span></span></span><span class=line><span class=cl><span class=s>Pods to Nodes. The scheduler determines which Nodes are valid placements for
</span></span></span><span class=line><span class=cl><span class=s>each Pod in the scheduling queue according to constraints and available
</span></span></span><span class=line><span class=cl><span class=s>resources. The scheduler then ranks each valid Node and binds the Pod to a
</span></span></span><span class=line><span class=cl><span class=s>suitable Node. Multiple different schedulers may be used within a cluster;
</span></span></span><span class=line><span class=cl><span class=s>kube-scheduler is the reference implementation.
</span></span></span><span class=line><span class=cl><span class=s>See [scheduling](https://kubernetes.io/docs/concepts/scheduling-eviction/)
</span></span></span><span class=line><span class=cl><span class=s>for more information about scheduling and the kube-scheduler component.`</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>RunE</span><span class=p>:</span> <span class=kd>func</span><span class=p>(</span><span class=nx>cmd</span> <span class=o>*</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span><span class=p>,</span> <span class=nx>args</span> <span class=p>[]</span><span class=kt>string</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nf>runCommand</span><span class=p>(</span><span class=nx>cmd</span><span class=p>,</span> <span class=nx>opts</span><span class=p>,</span> <span class=nx>registryOptions</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=nx>Args</span><span class=p>:</span> <span class=kd>func</span><span class=p>(</span><span class=nx>cmd</span> <span class=o>*</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span><span class=p>,</span> <span class=nx>args</span> <span class=p>[]</span><span class=kt>string</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>arg</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>args</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>arg</span><span class=p>)</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;%q does not take any arguments, got %q&#34;</span><span class=p>,</span> <span class=nx>cmd</span><span class=p>.</span><span class=nf>CommandPath</span><span class=p>(),</span> <span class=nx>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>nfs</span> <span class=o>:=</span> <span class=nx>opts</span><span class=p>.</span><span class=nx>Flags</span>
</span></span><span class=line><span class=cl>	<span class=nx>verflag</span><span class=p>.</span><span class=nf>AddFlags</span><span class=p>(</span><span class=nx>nfs</span><span class=p>.</span><span class=nf>FlagSet</span><span class=p>(</span><span class=s>&#34;global&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=nx>globalflag</span><span class=p>.</span><span class=nf>AddGlobalFlags</span><span class=p>(</span><span class=nx>nfs</span><span class=p>.</span><span class=nf>FlagSet</span><span class=p>(</span><span class=s>&#34;global&#34;</span><span class=p>),</span> <span class=nx>cmd</span><span class=p>.</span><span class=nf>Name</span><span class=p>(),</span> <span class=nx>logs</span><span class=p>.</span><span class=nf>SkipLoggingConfigurationFlags</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=nx>fs</span> <span class=o>:=</span> <span class=nx>cmd</span><span class=p>.</span><span class=nf>Flags</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>f</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>nfs</span><span class=p>.</span><span class=nx>FlagSets</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>fs</span><span class=p>.</span><span class=nf>AddFlagSet</span><span class=p>(</span><span class=nx>f</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>cols</span><span class=p>,</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>term</span><span class=p>.</span><span class=nf>TerminalSize</span><span class=p>(</span><span class=nx>cmd</span><span class=p>.</span><span class=nf>OutOrStdout</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=nx>cliflag</span><span class=p>.</span><span class=nf>SetUsageAndHelpFunc</span><span class=p>(</span><span class=nx>cmd</span><span class=p>,</span> <span class=o>*</span><span class=nx>nfs</span><span class=p>,</span> <span class=nx>cols</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>cmd</span><span class=p>.</span><span class=nf>MarkFlagFilename</span><span class=p>(</span><span class=s>&#34;config&#34;</span><span class=p>,</span> <span class=s>&#34;yaml&#34;</span><span class=p>,</span> <span class=s>&#34;yml&#34;</span><span class=p>,</span> <span class=s>&#34;json&#34;</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>ErrorS</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=s>&#34;Failed to mark flag filename&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>cmd</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>下面来看下 <a href=https://github.com/kubernetes/kubernetes/blob/140c27533044e9e00f800d3ad0517540e3e4ecad/cmd/kube-scheduler/app/server.go#L117-L142 target=_blank rel="noopener nofollow noreferrer">runCommand()</a> 在启动 <em>scheduler</em> 时提供了什么功能。</p><p>在新版中已经没有 <code>algorithmprovider</code> 的概念，所以在 <code>runCommand</code> 中做的也就是仅仅启动这个 <code>scheduler</code> ，而 scheduler 作为kubernetes组件，也是会watch等操作，自然少不了informer。其次作为和 <code>controller-manager</code> 相同的工作特性，<code>kube-scheduler</code> 也是 基于Leader选举的。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span><span class=lnt>92
</span><span class=lnt>93
</span><span class=lnt>94
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>Run</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>cc</span> <span class=o>*</span><span class=nx>schedulerserverconfig</span><span class=p>.</span><span class=nx>CompletedConfig</span><span class=p>,</span> <span class=nx>sched</span> <span class=o>*</span><span class=nx>scheduler</span><span class=p>.</span><span class=nx>Scheduler</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// To help debugging, immediately log version
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>klog</span><span class=p>.</span><span class=nf>InfoS</span><span class=p>(</span><span class=s>&#34;Starting Kubernetes Scheduler&#34;</span><span class=p>,</span> <span class=s>&#34;version&#34;</span><span class=p>,</span> <span class=nx>version</span><span class=p>.</span><span class=nf>Get</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>klog</span><span class=p>.</span><span class=nf>InfoS</span><span class=p>(</span><span class=s>&#34;Golang settings&#34;</span><span class=p>,</span> <span class=s>&#34;GOGC&#34;</span><span class=p>,</span> <span class=nx>os</span><span class=p>.</span><span class=nf>Getenv</span><span class=p>(</span><span class=s>&#34;GOGC&#34;</span><span class=p>),</span> <span class=s>&#34;GOMAXPROCS&#34;</span><span class=p>,</span> <span class=nx>os</span><span class=p>.</span><span class=nf>Getenv</span><span class=p>(</span><span class=s>&#34;GOMAXPROCS&#34;</span><span class=p>),</span> <span class=s>&#34;GOTRACEBACK&#34;</span><span class=p>,</span> <span class=nx>os</span><span class=p>.</span><span class=nf>Getenv</span><span class=p>(</span><span class=s>&#34;GOTRACEBACK&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Configz registration.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>cz</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>configz</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;componentconfig&#34;</span><span class=p>);</span> <span class=nx>err</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>cz</span><span class=p>.</span><span class=nf>Set</span><span class=p>(</span><span class=nx>cc</span><span class=p>.</span><span class=nx>ComponentConfig</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;unable to register configz: %s&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Start events processing pipeline.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>cc</span><span class=p>.</span><span class=nx>EventBroadcaster</span><span class=p>.</span><span class=nf>StartRecordingToSink</span><span class=p>(</span><span class=nx>ctx</span><span class=p>.</span><span class=nf>Done</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>cc</span><span class=p>.</span><span class=nx>EventBroadcaster</span><span class=p>.</span><span class=nf>Shutdown</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Setup healthz checks.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=kd>var</span> <span class=nx>checks</span> <span class=p>[]</span><span class=nx>healthz</span><span class=p>.</span><span class=nx>HealthChecker</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>cc</span><span class=p>.</span><span class=nx>ComponentConfig</span><span class=p>.</span><span class=nx>LeaderElection</span><span class=p>.</span><span class=nx>LeaderElect</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>checks</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>checks</span><span class=p>,</span> <span class=nx>cc</span><span class=p>.</span><span class=nx>LeaderElection</span><span class=p>.</span><span class=nx>WatchDog</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>waitingForLeader</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kd>struct</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>	<span class=nx>isLeader</span> <span class=o>:=</span> <span class=kd>func</span><span class=p>()</span> <span class=kt>bool</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>waitingForLeader</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=c1>// if channel is closed, we are leading
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>return</span> <span class=p>!</span><span class=nx>ok</span>
</span></span><span class=line><span class=cl>		<span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=c1>// channel is open, we are waiting for a leader
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>return</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Start up the healthz server.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>cc</span><span class=p>.</span><span class=nx>SecureServing</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>handler</span> <span class=o>:=</span> <span class=nf>buildHandlerChain</span><span class=p>(</span><span class=nf>newHealthzAndMetricsHandler</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>cc</span><span class=p>.</span><span class=nx>ComponentConfig</span><span class=p>,</span> <span class=nx>cc</span><span class=p>.</span><span class=nx>InformerFactory</span><span class=p>,</span> <span class=nx>isLeader</span><span class=p>,</span> <span class=nx>checks</span><span class=o>...</span><span class=p>),</span> <span class=nx>cc</span><span class=p>.</span><span class=nx>Authentication</span><span class=p>.</span><span class=nx>Authenticator</span><span class=p>,</span> <span class=nx>cc</span><span class=p>.</span><span class=nx>Authorization</span><span class=p>.</span><span class=nx>Authorizer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=c1>// TODO: handle stoppedCh and listenerStoppedCh returned by c.SecureServing.Serve
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>cc</span><span class=p>.</span><span class=nx>SecureServing</span><span class=p>.</span><span class=nf>Serve</span><span class=p>(</span><span class=nx>handler</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>ctx</span><span class=p>.</span><span class=nf>Done</span><span class=p>());</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// fail early for secure handlers, removing the old error loop from above
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to start secure server: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Start all informers.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>cc</span><span class=p>.</span><span class=nx>InformerFactory</span><span class=p>.</span><span class=nf>Start</span><span class=p>(</span><span class=nx>ctx</span><span class=p>.</span><span class=nf>Done</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=c1>// DynInformerFactory can be nil in tests.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>cc</span><span class=p>.</span><span class=nx>DynInformerFactory</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>cc</span><span class=p>.</span><span class=nx>DynInformerFactory</span><span class=p>.</span><span class=nf>Start</span><span class=p>(</span><span class=nx>ctx</span><span class=p>.</span><span class=nf>Done</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Wait for all caches to sync before scheduling.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>cc</span><span class=p>.</span><span class=nx>InformerFactory</span><span class=p>.</span><span class=nf>WaitForCacheSync</span><span class=p>(</span><span class=nx>ctx</span><span class=p>.</span><span class=nf>Done</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=c1>// DynInformerFactory can be nil in tests.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>cc</span><span class=p>.</span><span class=nx>DynInformerFactory</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>cc</span><span class=p>.</span><span class=nx>DynInformerFactory</span><span class=p>.</span><span class=nf>WaitForCacheSync</span><span class=p>(</span><span class=nx>ctx</span><span class=p>.</span><span class=nf>Done</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// If leader election is enabled, runCommand via LeaderElector until done and exit.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>cc</span><span class=p>.</span><span class=nx>LeaderElection</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>cc</span><span class=p>.</span><span class=nx>LeaderElection</span><span class=p>.</span><span class=nx>Callbacks</span> <span class=p>=</span> <span class=nx>leaderelection</span><span class=p>.</span><span class=nx>LeaderCallbacks</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>OnStartedLeading</span><span class=p>:</span> <span class=kd>func</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nb>close</span><span class=p>(</span><span class=nx>waitingForLeader</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=nx>sched</span><span class=p>.</span><span class=nf>Run</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>},</span>
</span></span><span class=line><span class=cl>			<span class=nx>OnStoppedLeading</span><span class=p>:</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>case</span> <span class=o>&lt;-</span><span class=nx>ctx</span><span class=p>.</span><span class=nf>Done</span><span class=p>():</span>
</span></span><span class=line><span class=cl>					<span class=c1>// We were asked to terminate. Exit 0.
</span></span></span><span class=line><span class=cl><span class=c1></span>					<span class=nx>klog</span><span class=p>.</span><span class=nf>InfoS</span><span class=p>(</span><span class=s>&#34;Requested to terminate, exiting&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>					<span class=nx>os</span><span class=p>.</span><span class=nf>Exit</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>					<span class=c1>// We lost the lock.
</span></span></span><span class=line><span class=cl><span class=c1></span>					<span class=nx>klog</span><span class=p>.</span><span class=nf>ErrorS</span><span class=p>(</span><span class=kc>nil</span><span class=p>,</span> <span class=s>&#34;Leaderelection lost&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>					<span class=nx>klog</span><span class=p>.</span><span class=nf>FlushAndExit</span><span class=p>(</span><span class=nx>klog</span><span class=p>.</span><span class=nx>ExitFlushTimeout</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>leaderElector</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>leaderelection</span><span class=p>.</span><span class=nf>NewLeaderElector</span><span class=p>(</span><span class=o>*</span><span class=nx>cc</span><span class=p>.</span><span class=nx>LeaderElection</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;couldn&#39;t create leader elector: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>leaderElector</span><span class=p>.</span><span class=nf>Run</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;lost lease&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Leader election is disabled, so runCommand inline until done.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nb>close</span><span class=p>(</span><span class=nx>waitingForLeader</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>sched</span><span class=p>.</span><span class=nf>Run</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;finished without leader elect&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>上面看到了 <code>runCommend</code> 是作为启动 <em>scheduler</em> 的工作，那么通过参数构建一个 <em>scheduler</em> 则是在 <a href=https://github.com/kubernetes/kubernetes/blob/140c27533044e9e00f800d3ad0517540e3e4ecad/cmd/kube-scheduler/app/server.go#L298-L355 target=_blank rel="noopener nofollow noreferrer">Setup</a> 中完成的。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// Setup creates a completed config and a scheduler based on the command args and options
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>Setup</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>opts</span> <span class=o>*</span><span class=nx>options</span><span class=p>.</span><span class=nx>Options</span><span class=p>,</span> <span class=nx>outOfTreeRegistryOptions</span> <span class=o>...</span><span class=nx>Option</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>schedulerserverconfig</span><span class=p>.</span><span class=nx>CompletedConfig</span><span class=p>,</span> <span class=o>*</span><span class=nx>scheduler</span><span class=p>.</span><span class=nx>Scheduler</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>cfg</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>latest</span><span class=p>.</span><span class=nf>Default</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>opts</span><span class=p>.</span><span class=nx>ComponentConfig</span> <span class=p>=</span> <span class=nx>cfg</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 验证参数
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>errs</span> <span class=o>:=</span> <span class=nx>opts</span><span class=p>.</span><span class=nf>Validate</span><span class=p>();</span> <span class=nb>len</span><span class=p>(</span><span class=nx>errs</span><span class=p>)</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>utilerrors</span><span class=p>.</span><span class=nf>NewAggregate</span><span class=p>(</span><span class=nx>errs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 构建一个config对象
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>c</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>opts</span><span class=p>.</span><span class=nf>Config</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 返回一个config对象，包含了scheduler所需的配置，如informer，leader selection
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>cc</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Complete</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>outOfTreeRegistry</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=nx>runtime</span><span class=p>.</span><span class=nx>Registry</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>option</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>outOfTreeRegistryOptions</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>option</span><span class=p>(</span><span class=nx>outOfTreeRegistry</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>recorderFactory</span> <span class=o>:=</span> <span class=nf>getRecorderFactory</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>cc</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>completedProfiles</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=nx>kubeschedulerconfig</span><span class=p>.</span><span class=nx>KubeSchedulerProfile</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 创建出来的scheduler
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>sched</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>scheduler</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=nx>cc</span><span class=p>.</span><span class=nx>Client</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>cc</span><span class=p>.</span><span class=nx>InformerFactory</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>cc</span><span class=p>.</span><span class=nx>DynInformerFactory</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>recorderFactory</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>ctx</span><span class=p>.</span><span class=nf>Done</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>		<span class=nx>scheduler</span><span class=p>.</span><span class=nf>WithComponentConfigVersion</span><span class=p>(</span><span class=nx>cc</span><span class=p>.</span><span class=nx>ComponentConfig</span><span class=p>.</span><span class=nx>TypeMeta</span><span class=p>.</span><span class=nx>APIVersion</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>scheduler</span><span class=p>.</span><span class=nf>WithKubeConfig</span><span class=p>(</span><span class=nx>cc</span><span class=p>.</span><span class=nx>KubeConfig</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>scheduler</span><span class=p>.</span><span class=nf>WithProfiles</span><span class=p>(</span><span class=nx>cc</span><span class=p>.</span><span class=nx>ComponentConfig</span><span class=p>.</span><span class=nx>Profiles</span><span class=o>...</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>scheduler</span><span class=p>.</span><span class=nf>WithPercentageOfNodesToScore</span><span class=p>(</span><span class=nx>cc</span><span class=p>.</span><span class=nx>ComponentConfig</span><span class=p>.</span><span class=nx>PercentageOfNodesToScore</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>scheduler</span><span class=p>.</span><span class=nf>WithFrameworkOutOfTreeRegistry</span><span class=p>(</span><span class=nx>outOfTreeRegistry</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>scheduler</span><span class=p>.</span><span class=nf>WithPodMaxBackoffSeconds</span><span class=p>(</span><span class=nx>cc</span><span class=p>.</span><span class=nx>ComponentConfig</span><span class=p>.</span><span class=nx>PodMaxBackoffSeconds</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>scheduler</span><span class=p>.</span><span class=nf>WithPodInitialBackoffSeconds</span><span class=p>(</span><span class=nx>cc</span><span class=p>.</span><span class=nx>ComponentConfig</span><span class=p>.</span><span class=nx>PodInitialBackoffSeconds</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>scheduler</span><span class=p>.</span><span class=nf>WithPodMaxInUnschedulablePodsDuration</span><span class=p>(</span><span class=nx>cc</span><span class=p>.</span><span class=nx>PodMaxInUnschedulablePodsDuration</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>scheduler</span><span class=p>.</span><span class=nf>WithExtenders</span><span class=p>(</span><span class=nx>cc</span><span class=p>.</span><span class=nx>ComponentConfig</span><span class=p>.</span><span class=nx>Extenders</span><span class=o>...</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>scheduler</span><span class=p>.</span><span class=nf>WithParallelism</span><span class=p>(</span><span class=nx>cc</span><span class=p>.</span><span class=nx>ComponentConfig</span><span class=p>.</span><span class=nx>Parallelism</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>scheduler</span><span class=p>.</span><span class=nf>WithBuildFrameworkCapturer</span><span class=p>(</span><span class=kd>func</span><span class=p>(</span><span class=nx>profile</span> <span class=nx>kubeschedulerconfig</span><span class=p>.</span><span class=nx>KubeSchedulerProfile</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// Profiles are processed during Framework instantiation to set default plugins and configurations. Capturing them for logging
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>completedProfiles</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>completedProfiles</span><span class=p>,</span> <span class=nx>profile</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}),</span>
</span></span><span class=line><span class=cl>	<span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>options</span><span class=p>.</span><span class=nf>LogOrWriteConfig</span><span class=p>(</span><span class=nx>opts</span><span class=p>.</span><span class=nx>WriteConfigTo</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>cc</span><span class=p>.</span><span class=nx>ComponentConfig</span><span class=p>,</span> <span class=nx>completedProfiles</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=o>&amp;</span><span class=nx>cc</span><span class=p>,</span> <span class=nx>sched</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>上面了解到了 <em>scheduler</em> 是如何被构建出来的，下面就看看 构建时参数是如何传递进来的，而对象 option就是对应需要的配置结构，而 <a href=https://github.com/kubernetes/kubernetes/blob/140c27533044e9e00f800d3ad0517540e3e4ecad/cmd/kube-scheduler/app/options/options.go#L203-L243 target=_blank rel="noopener nofollow noreferrer">ApplyTo</a> 则是将启动时传入的参数转化为构建 <em>scheduler</em> 所需的配置。</p><blockquote><p>对于Deprecated flags可以参考官方对于kube-scheduler启动参数的说明 <sup><a href=#5>[5]</a></sup></p><p>对于如何编写一个scheduler config请参考 <a href=#6>[6]</a> 与 <a href=#7>[7]</a></p></blockquote><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>o</span> <span class=o>*</span><span class=nx>Options</span><span class=p>)</span> <span class=nf>ApplyTo</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>schedulerappconfig</span><span class=p>.</span><span class=nx>Config</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>o</span><span class=p>.</span><span class=nx>ConfigFile</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 在没有指定 --config时会找到 Deprecated flags:参数
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// 通过kube-scheduler --help可以看到这些被弃用的参数
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>o</span><span class=p>.</span><span class=nf>ApplyDeprecated</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=nx>o</span><span class=p>.</span><span class=nf>ApplyLeaderElectionTo</span><span class=p>(</span><span class=nx>o</span><span class=p>.</span><span class=nx>ComponentConfig</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>c</span><span class=p>.</span><span class=nx>ComponentConfig</span> <span class=p>=</span> <span class=o>*</span><span class=nx>o</span><span class=p>.</span><span class=nx>ComponentConfig</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 这里就是指定了--config
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>cfg</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>loadConfigFromFile</span><span class=p>(</span><span class=nx>o</span><span class=p>.</span><span class=nx>ConfigFile</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 这里会将leader选举的参数附加到配置中
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>o</span><span class=p>.</span><span class=nf>ApplyLeaderElectionTo</span><span class=p>(</span><span class=nx>cfg</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>validation</span><span class=p>.</span><span class=nf>ValidateKubeSchedulerConfiguration</span><span class=p>(</span><span class=nx>cfg</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>c</span><span class=p>.</span><span class=nx>ComponentConfig</span> <span class=p>=</span> <span class=o>*</span><span class=nx>cfg</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>o</span><span class=p>.</span><span class=nx>SecureServing</span><span class=p>.</span><span class=nf>ApplyTo</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>c</span><span class=p>.</span><span class=nx>SecureServing</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>c</span><span class=p>.</span><span class=nx>LoopbackClientConfig</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>o</span><span class=p>.</span><span class=nx>SecureServing</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=nx>o</span><span class=p>.</span><span class=nx>SecureServing</span><span class=p>.</span><span class=nx>BindPort</span> <span class=o>!=</span> <span class=mi>0</span> <span class=o>||</span> <span class=nx>o</span><span class=p>.</span><span class=nx>SecureServing</span><span class=p>.</span><span class=nx>Listener</span> <span class=o>!=</span> <span class=kc>nil</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>o</span><span class=p>.</span><span class=nx>Authentication</span><span class=p>.</span><span class=nf>ApplyTo</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>c</span><span class=p>.</span><span class=nx>Authentication</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>SecureServing</span><span class=p>,</span> <span class=kc>nil</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>o</span><span class=p>.</span><span class=nx>Authorization</span><span class=p>.</span><span class=nf>ApplyTo</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>c</span><span class=p>.</span><span class=nx>Authorization</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>o</span><span class=p>.</span><span class=nx>Metrics</span><span class=p>.</span><span class=nf>Apply</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Apply value independently instead of using ApplyDeprecated() because it can&#39;t be configured via ComponentConfig.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>o</span><span class=p>.</span><span class=nx>Deprecated</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>c</span><span class=p>.</span><span class=nx>PodMaxInUnschedulablePodsDuration</span> <span class=p>=</span> <span class=nx>o</span><span class=p>.</span><span class=nx>Deprecated</span><span class=p>.</span><span class=nx>PodMaxInUnschedulablePodsDuration</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p><code>Setup</code> 后会new一个 <code>schedueler</code> , <a href=https://github.com/kubernetes/kubernetes/blob/140c27533044e9e00f800d3ad0517540e3e4ecad/pkg/scheduler/scheduler.go#L234-L333 target=_blank rel="noopener nofollow noreferrer">New</a> 则是这个动作，在里面可以看出，会初始化一些informer与 Pod的list等操作。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>New</span><span class=p>(</span><span class=nx>client</span> <span class=nx>clientset</span><span class=p>.</span><span class=nx>Interface</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>informerFactory</span> <span class=nx>informers</span><span class=p>.</span><span class=nx>SharedInformerFactory</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>dynInformerFactory</span> <span class=nx>dynamicinformer</span><span class=p>.</span><span class=nx>DynamicSharedInformerFactory</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>recorderFactory</span> <span class=nx>profile</span><span class=p>.</span><span class=nx>RecorderFactory</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>stopCh</span> <span class=o>&lt;-</span><span class=kd>chan</span> <span class=kd>struct</span><span class=p>{},</span>
</span></span><span class=line><span class=cl>	<span class=nx>opts</span> <span class=o>...</span><span class=nx>Option</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>Scheduler</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>stopEverything</span> <span class=o>:=</span> <span class=nx>stopCh</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>stopEverything</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>stopEverything</span> <span class=p>=</span> <span class=nx>wait</span><span class=p>.</span><span class=nx>NeverStop</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>options</span> <span class=o>:=</span> <span class=nx>defaultSchedulerOptions</span> <span class=c1>// 默认调度策略，如percentageOfNodesToScore
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>opt</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>opts</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>opt</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>options</span><span class=p>)</span> <span class=c1>// opt 是传入的函数，会返回一个schedulerOptions即相应的一些配置
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>options</span><span class=p>.</span><span class=nx>applyDefaultProfile</span> <span class=p>{</span> <span class=c1>// 这个是个bool类型，默认scheduler会到这里
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// Profile包含了调度器的名称与调度器在两个过程中使用的插件
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=kd>var</span> <span class=nx>versionedCfg</span> <span class=nx>v1beta3</span><span class=p>.</span><span class=nx>KubeSchedulerConfiguration</span>
</span></span><span class=line><span class=cl>		<span class=nx>scheme</span><span class=p>.</span><span class=nx>Scheme</span><span class=p>.</span><span class=nf>Default</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>versionedCfg</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>cfg</span> <span class=o>:=</span> <span class=nx>schedulerapi</span><span class=p>.</span><span class=nx>KubeSchedulerConfiguration</span><span class=p>{}</span> <span class=c1>// 初始化一个配置，这个是--config传入的类型。因为默认的调度策略会初始化
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// convert 会将in转为out即versionedCfg转换为cfg
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>scheme</span><span class=p>.</span><span class=nx>Scheme</span><span class=p>.</span><span class=nf>Convert</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>versionedCfg</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>cfg</span><span class=p>,</span> <span class=kc>nil</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>options</span><span class=p>.</span><span class=nx>profiles</span> <span class=p>=</span> <span class=nx>cfg</span><span class=p>.</span><span class=nx>Profiles</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>registry</span> <span class=o>:=</span> <span class=nx>frameworkplugins</span><span class=p>.</span><span class=nf>NewInTreeRegistry</span><span class=p>()</span> <span class=c1>// 调度框架的注册
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>registry</span><span class=p>.</span><span class=nf>Merge</span><span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>frameworkOutOfTreeRegistry</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>metrics</span><span class=p>.</span><span class=nf>Register</span><span class=p>()</span> <span class=c1>// 指标类
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=nx>extenders</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>buildExtenders</span><span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>extenders</span><span class=p>,</span> <span class=nx>options</span><span class=p>.</span><span class=nx>profiles</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;couldn&#39;t build extenders: %w&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>podLister</span> <span class=o>:=</span> <span class=nx>informerFactory</span><span class=p>.</span><span class=nf>Core</span><span class=p>().</span><span class=nf>V1</span><span class=p>().</span><span class=nf>Pods</span><span class=p>().</span><span class=nf>Lister</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>nodeLister</span> <span class=o>:=</span> <span class=nx>informerFactory</span><span class=p>.</span><span class=nf>Core</span><span class=p>().</span><span class=nf>V1</span><span class=p>().</span><span class=nf>Nodes</span><span class=p>().</span><span class=nf>Lister</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// The nominator will be passed all the way to framework instantiation.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>nominator</span> <span class=o>:=</span> <span class=nx>internalqueue</span><span class=p>.</span><span class=nf>NewPodNominator</span><span class=p>(</span><span class=nx>podLister</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>snapshot</span> <span class=o>:=</span> <span class=nx>internalcache</span><span class=p>.</span><span class=nf>NewEmptySnapshot</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>clusterEventMap</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=nx>framework</span><span class=p>.</span><span class=nx>ClusterEvent</span><span class=p>]</span><span class=nx>sets</span><span class=p>.</span><span class=nx>String</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>profiles</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>profile</span><span class=p>.</span><span class=nf>NewMap</span><span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>profiles</span><span class=p>,</span> <span class=nx>registry</span><span class=p>,</span> <span class=nx>recorderFactory</span><span class=p>,</span> <span class=nx>stopCh</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>frameworkruntime</span><span class=p>.</span><span class=nf>WithComponentConfigVersion</span><span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>componentConfigVersion</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>frameworkruntime</span><span class=p>.</span><span class=nf>WithClientSet</span><span class=p>(</span><span class=nx>client</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>frameworkruntime</span><span class=p>.</span><span class=nf>WithKubeConfig</span><span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>kubeConfig</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>frameworkruntime</span><span class=p>.</span><span class=nf>WithInformerFactory</span><span class=p>(</span><span class=nx>informerFactory</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>frameworkruntime</span><span class=p>.</span><span class=nf>WithSnapshotSharedLister</span><span class=p>(</span><span class=nx>snapshot</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>frameworkruntime</span><span class=p>.</span><span class=nf>WithPodNominator</span><span class=p>(</span><span class=nx>nominator</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>frameworkruntime</span><span class=p>.</span><span class=nf>WithCaptureProfile</span><span class=p>(</span><span class=nx>frameworkruntime</span><span class=p>.</span><span class=nf>CaptureProfile</span><span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>frameworkCapturer</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>		<span class=nx>frameworkruntime</span><span class=p>.</span><span class=nf>WithClusterEventMap</span><span class=p>(</span><span class=nx>clusterEventMap</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>frameworkruntime</span><span class=p>.</span><span class=nf>WithParallelism</span><span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>parallelism</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>		<span class=nx>frameworkruntime</span><span class=p>.</span><span class=nf>WithExtenders</span><span class=p>(</span><span class=nx>extenders</span><span class=p>),</span>
</span></span><span class=line><span class=cl>	<span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;initializing profiles: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>profiles</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;at least one profile is required&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>podQueue</span> <span class=o>:=</span> <span class=nx>internalqueue</span><span class=p>.</span><span class=nf>NewSchedulingQueue</span><span class=p>(</span>
</span></span><span class=line><span class=cl>		<span class=nx>profiles</span><span class=p>[</span><span class=nx>options</span><span class=p>.</span><span class=nx>profiles</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>SchedulerName</span><span class=p>].</span><span class=nf>QueueSortFunc</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>		<span class=nx>informerFactory</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>internalqueue</span><span class=p>.</span><span class=nf>WithPodInitialBackoffDuration</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nf>Duration</span><span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>podInitialBackoffSeconds</span><span class=p>)</span><span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>internalqueue</span><span class=p>.</span><span class=nf>WithPodMaxBackoffDuration</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nf>Duration</span><span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>podMaxBackoffSeconds</span><span class=p>)</span><span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>internalqueue</span><span class=p>.</span><span class=nf>WithPodNominator</span><span class=p>(</span><span class=nx>nominator</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>internalqueue</span><span class=p>.</span><span class=nf>WithClusterEventMap</span><span class=p>(</span><span class=nx>clusterEventMap</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>internalqueue</span><span class=p>.</span><span class=nf>WithPodMaxInUnschedulablePodsDuration</span><span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>podMaxInUnschedulablePodsDuration</span><span class=p>),</span>
</span></span><span class=line><span class=cl>	<span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>schedulerCache</span> <span class=o>:=</span> <span class=nx>internalcache</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=nx>durationToExpireAssumedPod</span><span class=p>,</span> <span class=nx>stopEverything</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Setup cache debugger.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>debugger</span> <span class=o>:=</span> <span class=nx>cachedebugger</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=nx>nodeLister</span><span class=p>,</span> <span class=nx>podLister</span><span class=p>,</span> <span class=nx>schedulerCache</span><span class=p>,</span> <span class=nx>podQueue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>debugger</span><span class=p>.</span><span class=nf>ListenForSignal</span><span class=p>(</span><span class=nx>stopEverything</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>sched</span> <span class=o>:=</span> <span class=nf>newScheduler</span><span class=p>(</span>
</span></span><span class=line><span class=cl>		<span class=nx>schedulerCache</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>extenders</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>internalqueue</span><span class=p>.</span><span class=nf>MakeNextPodFunc</span><span class=p>(</span><span class=nx>podQueue</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nf>MakeDefaultErrorFunc</span><span class=p>(</span><span class=nx>client</span><span class=p>,</span> <span class=nx>podLister</span><span class=p>,</span> <span class=nx>podQueue</span><span class=p>,</span> <span class=nx>schedulerCache</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>stopEverything</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>podQueue</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>profiles</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>client</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>snapshot</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>options</span><span class=p>.</span><span class=nx>percentageOfNodesToScore</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 这个就是controller中onAdd等那三个必须的事件函数
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>addAllEventHandlers</span><span class=p>(</span><span class=nx>sched</span><span class=p>,</span> <span class=nx>informerFactory</span><span class=p>,</span> <span class=nx>dynInformerFactory</span><span class=p>,</span> <span class=nf>unionedGVKs</span><span class=p>(</span><span class=nx>clusterEventMap</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>sched</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>接下来会启动这个 <em>scheduler</em>， 在上面我们看到 <a href=https://github.com/kubernetes/kubernetes/blob/140c27533044e9e00f800d3ad0517540e3e4ecad/cmd/kube-scheduler/app/server.go#L72-L114 target=_blank rel="noopener nofollow noreferrer">NewSchedulerCommand</a> 构建了一个cobra.Commond对象， <a href=https://github.com/kubernetes/kubernetes/blob/140c27533044e9e00f800d3ad0517540e3e4ecad/cmd/kube-scheduler/app/server.go#L117-L142 target=_blank rel="noopener nofollow noreferrer">runCommand()</a> 最终会返回个 Run，而这个Run就是启动这个 <em>sche</em> 的。</p><p>下面这个 <a href=https://github.com/kubernetes/kubernetes/blob/140c27533044e9e00f800d3ad0517540e3e4ecad/pkg/scheduler/scheduler.go#L336-L340 target=_blank rel="noopener nofollow noreferrer">run</a> 是 <em>sche</em> 的运行，他运行并watch资源，直到上下文完成。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>sched</span> <span class=o>*</span><span class=nx>Scheduler</span><span class=p>)</span> <span class=nf>Run</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>sched</span><span class=p>.</span><span class=nx>SchedulingQueue</span><span class=p>.</span><span class=nf>Run</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// We need to start scheduleOne loop in a dedicated goroutine,
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// because scheduleOne function hangs on getting the next item
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// from the SchedulingQueue.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// If there are no new pods to schedule, it will be hanging there
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// and if done in this goroutine it will be blocking closing
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// SchedulingQueue, in effect causing a deadlock on shutdown.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>go</span> <span class=nx>wait</span><span class=p>.</span><span class=nf>UntilWithContext</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>sched</span><span class=p>.</span><span class=nx>scheduleOne</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=o>&lt;-</span><span class=nx>ctx</span><span class=p>.</span><span class=nf>Done</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>sched</span><span class=p>.</span><span class=nx>SchedulingQueue</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>而调用这个 <em>Run</em> 的部分则是作为server的 <em>kube-scheduler</em> 中的 <a href=https://github.com/kubernetes/kubernetes/blob/140c27533044e9e00f800d3ad0517540e3e4ecad/cmd/kube-scheduler/app/server.go#L145-L237 target=_blank rel="noopener nofollow noreferrer">run</a></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span><span class=lnt>92
</span><span class=lnt>93
</span><span class=lnt>94
</span><span class=lnt>95
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// Run executes the scheduler based on the given configuration. It only returns on error or when context is done.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>Run</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>cc</span> <span class=o>*</span><span class=nx>schedulerserverconfig</span><span class=p>.</span><span class=nx>CompletedConfig</span><span class=p>,</span> <span class=nx>sched</span> <span class=o>*</span><span class=nx>scheduler</span><span class=p>.</span><span class=nx>Scheduler</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// To help debugging, immediately log version
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>klog</span><span class=p>.</span><span class=nf>InfoS</span><span class=p>(</span><span class=s>&#34;Starting Kubernetes Scheduler&#34;</span><span class=p>,</span> <span class=s>&#34;version&#34;</span><span class=p>,</span> <span class=nx>version</span><span class=p>.</span><span class=nf>Get</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>klog</span><span class=p>.</span><span class=nf>InfoS</span><span class=p>(</span><span class=s>&#34;Golang settings&#34;</span><span class=p>,</span> <span class=s>&#34;GOGC&#34;</span><span class=p>,</span> <span class=nx>os</span><span class=p>.</span><span class=nf>Getenv</span><span class=p>(</span><span class=s>&#34;GOGC&#34;</span><span class=p>),</span> <span class=s>&#34;GOMAXPROCS&#34;</span><span class=p>,</span> <span class=nx>os</span><span class=p>.</span><span class=nf>Getenv</span><span class=p>(</span><span class=s>&#34;GOMAXPROCS&#34;</span><span class=p>),</span> <span class=s>&#34;GOTRACEBACK&#34;</span><span class=p>,</span> <span class=nx>os</span><span class=p>.</span><span class=nf>Getenv</span><span class=p>(</span><span class=s>&#34;GOTRACEBACK&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Configz registration.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>cz</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>configz</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;componentconfig&#34;</span><span class=p>);</span> <span class=nx>err</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>cz</span><span class=p>.</span><span class=nf>Set</span><span class=p>(</span><span class=nx>cc</span><span class=p>.</span><span class=nx>ComponentConfig</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;unable to register configz: %s&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Start events processing pipeline.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>cc</span><span class=p>.</span><span class=nx>EventBroadcaster</span><span class=p>.</span><span class=nf>StartRecordingToSink</span><span class=p>(</span><span class=nx>ctx</span><span class=p>.</span><span class=nf>Done</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>cc</span><span class=p>.</span><span class=nx>EventBroadcaster</span><span class=p>.</span><span class=nf>Shutdown</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Setup healthz checks.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=kd>var</span> <span class=nx>checks</span> <span class=p>[]</span><span class=nx>healthz</span><span class=p>.</span><span class=nx>HealthChecker</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>cc</span><span class=p>.</span><span class=nx>ComponentConfig</span><span class=p>.</span><span class=nx>LeaderElection</span><span class=p>.</span><span class=nx>LeaderElect</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>checks</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>checks</span><span class=p>,</span> <span class=nx>cc</span><span class=p>.</span><span class=nx>LeaderElection</span><span class=p>.</span><span class=nx>WatchDog</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>waitingForLeader</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kd>struct</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>	<span class=nx>isLeader</span> <span class=o>:=</span> <span class=kd>func</span><span class=p>()</span> <span class=kt>bool</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>waitingForLeader</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=c1>// if channel is closed, we are leading
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>return</span> <span class=p>!</span><span class=nx>ok</span>
</span></span><span class=line><span class=cl>		<span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=c1>// channel is open, we are waiting for a leader
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>return</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Start up the healthz server.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>cc</span><span class=p>.</span><span class=nx>SecureServing</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>handler</span> <span class=o>:=</span> <span class=nf>buildHandlerChain</span><span class=p>(</span><span class=nf>newHealthzAndMetricsHandler</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>cc</span><span class=p>.</span><span class=nx>ComponentConfig</span><span class=p>,</span> <span class=nx>cc</span><span class=p>.</span><span class=nx>InformerFactory</span><span class=p>,</span> <span class=nx>isLeader</span><span class=p>,</span> <span class=nx>checks</span><span class=o>...</span><span class=p>),</span> <span class=nx>cc</span><span class=p>.</span><span class=nx>Authentication</span><span class=p>.</span><span class=nx>Authenticator</span><span class=p>,</span> <span class=nx>cc</span><span class=p>.</span><span class=nx>Authorization</span><span class=p>.</span><span class=nx>Authorizer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=c1>// TODO: handle stoppedCh and listenerStoppedCh returned by c.SecureServing.Serve
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>cc</span><span class=p>.</span><span class=nx>SecureServing</span><span class=p>.</span><span class=nf>Serve</span><span class=p>(</span><span class=nx>handler</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>ctx</span><span class=p>.</span><span class=nf>Done</span><span class=p>());</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// fail early for secure handlers, removing the old error loop from above
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to start secure server: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Start all informers.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>cc</span><span class=p>.</span><span class=nx>InformerFactory</span><span class=p>.</span><span class=nf>Start</span><span class=p>(</span><span class=nx>ctx</span><span class=p>.</span><span class=nf>Done</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=c1>// DynInformerFactory can be nil in tests.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>cc</span><span class=p>.</span><span class=nx>DynInformerFactory</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>cc</span><span class=p>.</span><span class=nx>DynInformerFactory</span><span class=p>.</span><span class=nf>Start</span><span class=p>(</span><span class=nx>ctx</span><span class=p>.</span><span class=nf>Done</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Wait for all caches to sync before scheduling.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>cc</span><span class=p>.</span><span class=nx>InformerFactory</span><span class=p>.</span><span class=nf>WaitForCacheSync</span><span class=p>(</span><span class=nx>ctx</span><span class=p>.</span><span class=nf>Done</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=c1>// DynInformerFactory can be nil in tests.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>cc</span><span class=p>.</span><span class=nx>DynInformerFactory</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>cc</span><span class=p>.</span><span class=nx>DynInformerFactory</span><span class=p>.</span><span class=nf>WaitForCacheSync</span><span class=p>(</span><span class=nx>ctx</span><span class=p>.</span><span class=nf>Done</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// If leader election is enabled, runCommand via LeaderElector until done and exit.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>cc</span><span class=p>.</span><span class=nx>LeaderElection</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>cc</span><span class=p>.</span><span class=nx>LeaderElection</span><span class=p>.</span><span class=nx>Callbacks</span> <span class=p>=</span> <span class=nx>leaderelection</span><span class=p>.</span><span class=nx>LeaderCallbacks</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>OnStartedLeading</span><span class=p>:</span> <span class=kd>func</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nb>close</span><span class=p>(</span><span class=nx>waitingForLeader</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=nx>sched</span><span class=p>.</span><span class=nf>Run</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>},</span>
</span></span><span class=line><span class=cl>			<span class=nx>OnStoppedLeading</span><span class=p>:</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>case</span> <span class=o>&lt;-</span><span class=nx>ctx</span><span class=p>.</span><span class=nf>Done</span><span class=p>():</span>
</span></span><span class=line><span class=cl>					<span class=c1>// We were asked to terminate. Exit 0.
</span></span></span><span class=line><span class=cl><span class=c1></span>					<span class=nx>klog</span><span class=p>.</span><span class=nf>InfoS</span><span class=p>(</span><span class=s>&#34;Requested to terminate, exiting&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>					<span class=nx>os</span><span class=p>.</span><span class=nf>Exit</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>					<span class=c1>// We lost the lock.
</span></span></span><span class=line><span class=cl><span class=c1></span>					<span class=nx>klog</span><span class=p>.</span><span class=nf>ErrorS</span><span class=p>(</span><span class=kc>nil</span><span class=p>,</span> <span class=s>&#34;Leaderelection lost&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>					<span class=nx>klog</span><span class=p>.</span><span class=nf>FlushAndExit</span><span class=p>(</span><span class=nx>klog</span><span class=p>.</span><span class=nx>ExitFlushTimeout</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>leaderElector</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>leaderelection</span><span class=p>.</span><span class=nf>NewLeaderElector</span><span class=p>(</span><span class=o>*</span><span class=nx>cc</span><span class=p>.</span><span class=nx>LeaderElection</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;couldn&#39;t create leader elector: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>leaderElector</span><span class=p>.</span><span class=nf>Run</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;lost lease&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Leader election is disabled, so runCommand inline until done.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nb>close</span><span class=p>(</span><span class=nx>waitingForLeader</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>sched</span><span class=p>.</span><span class=nf>Run</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;finished without leader elect&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>而上面的 <em>server.Run</em> 会被 <code>runCommand</code> 也就是在 <code>NewSchedulerCommand</code> 时被返回，在 <code>kube-scheduler</code> 的入口文件中被执行。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>cc</span><span class=p>,</span> <span class=nx>sched</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>Setup</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>opts</span><span class=p>,</span> <span class=nx>registryOptions</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>return</span> <span class=nf>Run</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>cc</span><span class=p>,</span> <span class=nx>sched</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div></div></div><p>至此，整个 <code>kube-scheduler</code> 启动流就分析完了，这个的流程可以用下图表示</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220718174104043.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220718174104043.png#center alt=image-20220718174104043 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><center class=podsc>图2：scheduler server运行流程</center><h2 id=reference>Reference<a hidden class=anchor aria-hidden=true href=#reference>#</a></h2><ul><li><p><sup id=1>[1]</sup> <a href=https://kubernetes.io/docs/concepts/scheduling-eviction/kube-scheduler/ target=_blank rel="noopener nofollow noreferrer">kube scheduler</a></p></li><li><p><sup id=2>[2]</sup> <a href=https://github.com/kubernetes/community/blob/master/contributors/devel/sig-scheduling/scheduler_algorithm.md#filtering-the-nodes target=_blank rel="noopener nofollow noreferrer">Scheduler Algorithm in Kubernetes</a></p></li><li><p><sup id=3>[3]</sup> <a href=https://kubernetes.io/docs/concepts/scheduling-eviction/scheduling-framework/ target=_blank rel="noopener nofollow noreferrer">scheduling framework</a></p></li><li><p><sup id=4>[4]</sup> <a href=https://kubernetes.io/docs/concepts/scheduling-eviction/scheduling-framework/#permit target=_blank rel="noopener nofollow noreferrer">permit</a></p></li><li><p><sup id=5>[5]</sup> <a href=https://kubernetes.io/docs/reference/command-line-tools-reference/kube-scheduler/ target=_blank rel="noopener nofollow noreferrer">kube-scheduler parmater</a></p></li><li><p><sup id=6>[6]</sup> <a href=https://kubernetes.io/docs/reference/config-api/kube-scheduler-config.v1beta3/ target=_blank rel="noopener nofollow noreferrer">kube-scheduler config.v1beta3/</a></p></li><li><p><sup id=7>[7]</sup> <a href=https://kubernetes.io/docs/reference/scheduling/config/ target=_blank rel="noopener nofollow noreferrer">kube-scheduler config</a></p></li></ul></div><div class=pe-copyright><hr><blockquote><p>本文为原创内容，版权归作者所有。如需转载，请在文章中声明本文标题及链接。</p><p>文章标题：kubernetes的决策组件 - kube-scheduler原理分析</p><p>文章链接：<a href=http://localhost:1313/2022/07/ch16-scheduler/ target=_blank>http://localhost:1313/2022/07/ch16-scheduler/</a></p><p>许可协议：<a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></p></blockquote></div><div class=comments-separator></div><h3 class=relatedContentTitle>相关阅读</h3><ul class=relatedContent><li><a href=/2022/07/ch33-admission-webhook/><span>深入理解Kubernetes 4A - Admission Control源码解析</span></a></li><li><a href=/2022/06/ch27-leader-election/><span>源码分析Kubernetes HA机制 - leader election</span></a></li><li><a href=/2022/06/ch15-controller-runtime/><span>源码分析Kubernetes controller组件 - controller-runtime</span></a></li><li><a href=/2022/06/ch04-apiserver-aggregation/><span>扩展Kubernetes API的另一种方式 - APIServer aggregation</span></a></li><li><a href=/2022/06/ch14-code-generator/><span>kubernetes代码生成器 - code-generator</span></a></li></ul><div class=comments-separator></div><footer class=post-footer><ul class=post-tags><li><a href=http://localhost:1313/tags/kubernetes-develop/>Kubernetes Develop</a></li><li><a href=http://localhost:1313/tags/kubernetes/>Kubernetes</a></li></ul><nav class=paginav><a class=prev href=http://localhost:1313/2022/07/ch20-schedule-workflow/><span class=title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left" style="user-select:text"><line x1="19" y1="12" x2="5" y2="12" style="user-select:text"/><polyline points="12 19 5 12 12 5" style="user-select:text"/></polyline></svg>&nbsp;</span>
<span>kube-scheduler的调度上下文</span>
</a><a class=next href=http://localhost:1313/2022/07/ch33-admission-webhook/><span class=title></span>
<span>深入理解Kubernetes 4A - Admission Control源码解析&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right" style="user-select:text"><line x1="5" y1="12" x2="19" y2="12" style="user-select:text"/><polyline points="12 5 19 12 12 19" style="user-select:text"/></svg></span></a></nav></footer><div class=pe-comments-decoration><p class=pe-comments-title></p><p class=pe-comments-subtitle></p></div><div id=pe-comments></div><script src=/js/pe-go-comment.min.86a214102576ba5f9b7bdc29eed8d58dd56e34aef80b3c65c73ea9cc88443696.js integrity="sha256-hqIUECV2ul+be9wp7tjVjdVuNK74Czxlxz6pzIhENpY="></script><script>const getStoredTheme=()=>localStorage.getItem("pref-theme")==="dark"?"dark":"light",setGiscusTheme=()=>{const e=e=>{const t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:e},"https://giscus.app")};e({setConfig:{theme:getStoredTheme()}})};document.addEventListener("DOMContentLoaded",()=>{const s={src:"https://giscus.app/client.js","data-repo":"cylonchau/cylonchau.github.io","data-repo-id":"R_kgDOIRlNSQ","data-category":"Announcements","data-category-id":"DIC_kwDOIRlNSc4CXy1U","data-mapping":"pathname","data-term":"posts/ch16 scheduler","data-strict":"0","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"top","data-theme":getStoredTheme(),"data-lang":"zh-TW","data-loading":"lazy",crossorigin:"anonymous",async:""},e=document.createElement("script");Object.entries(s).forEach(([t,n])=>e.setAttribute(t,n)),document.querySelector("#pe-comments").appendChild(e);const t=document.querySelector("#theme-toggle");t&&t.addEventListener("click",setGiscusTheme);const n=document.querySelector("#theme-toggle-float");n&&n.addEventListener("click",setGiscusTheme)})</script></article></main><footer class=footer><span>&copy; 2024 <a href=http://localhost:1313/>Cylon's Collection</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> on
<a href=https://pages.github.com/ rel=noopener target=_blank>GitHub Pages</a> & Theme
        <a href=https://github.com/tofuwine/PaperMod-PE rel=noopener target=_blank>PaperMod-PE</a></span></footer><div class=pe-right-sidebar><a href=javascript:void(0); id=theme-toggle-float class=pe-float-btn><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</a><a href=#top class=pe-float-btn id=top-link><span id=pe-read-progress></span></a></div><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>