<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>kube-scheduler的调度上下文 | Cylon's Collection</title><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NP3JNCPR" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><meta name=keywords content="kubernetes,develop"><meta name=description content="Scheduler Scheduler 是整个 kube-scheduler 的一个 structure，提供了 kube-scheduler 运行所需的组件。
go 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 type Scheduler struct { // Cache是一个抽象，会缓存pod的信息，作为scheduler进行查找，操作是基于Pod进行增加 Cache internalcache.Cache // Extenders 算是调度框架中提供的调度插件，会影响kubernetes中的调度策略 Extenders []framework.Extender // NextPod 作为一个函数提供，会阻塞获取下一个ke'diao'du NextPod func() *framework.QueuedPodInfo // Error is called if there is an error. It is passed the pod in // question, and the error Error func(*framework."><meta name=author content="cylon"><link rel=canonical href=https://www.oomkill.com/2022/07/ch20-schedule-workflow/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://www.oomkill.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.oomkill.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.oomkill.com/favicon-32x32.png><link rel=apple-touch-icon href=https://www.oomkill.com/favicon.ico><link rel=mask-icon href=https://www.oomkill.com/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://www.oomkill.com/2022/07/ch20-schedule-workflow/><noscript><style>#theme-toggle,#top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link crossorigin=anonymous href=/assets/css/pe.min.css rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/pe.min.js></script><link rel=stylesheet href=https://cdn.staticfile.net/font-awesome/6.5.1/css/all.min.css><link rel=stylesheet href=https://cdn.staticfile.net/font-awesome/6.5.1/css/v4-shims.min.css><script defer src=https://cdn.staticfile.net/jquery/3.5.1/jquery.min.js></script><link rel=stylesheet href=https://cdn.staticfile.net/fancybox/3.5.7/jquery.fancybox.min.css><script defer src=https://cdn.staticfile.net/fancybox/3.5.7/jquery.fancybox.min.js></script><script id=MathJax-script async src=https://cdn.staticfile.net/mathjax/3.2.2/es5/tex-chtml.js></script><script>MathJax={tex:{displayMath:[["$$","$$"]],inlineMath:[["\\$","\\$"]]}}</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-H94HZ5S19Y"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-H94HZ5S19Y")</script><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><meta name=referrer content="no-referrer-when-downgrade"><meta property="og:title" content="kube-scheduler的调度上下文"><meta property="og:description" content="Scheduler Scheduler 是整个 kube-scheduler 的一个 structure，提供了 kube-scheduler 运行所需的组件。
go 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 type Scheduler struct { // Cache是一个抽象，会缓存pod的信息，作为scheduler进行查找，操作是基于Pod进行增加 Cache internalcache.Cache // Extenders 算是调度框架中提供的调度插件，会影响kubernetes中的调度策略 Extenders []framework.Extender // NextPod 作为一个函数提供，会阻塞获取下一个ke'diao'du NextPod func() *framework.QueuedPodInfo // Error is called if there is an error. It is passed the pod in // question, and the error Error func(*framework."><meta property="og:type" content="article"><meta property="og:url" content="https://www.oomkill.com/2022/07/ch20-schedule-workflow/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-07-21T00:00:00+00:00"><meta property="og:site_name" content="Cylon's Collection"><meta name=twitter:card content="summary"><meta name=twitter:title content="kube-scheduler的调度上下文"><meta name=twitter:description content="Scheduler Scheduler 是整个 kube-scheduler 的一个 structure，提供了 kube-scheduler 运行所需的组件。
go 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 type Scheduler struct { // Cache是一个抽象，会缓存pod的信息，作为scheduler进行查找，操作是基于Pod进行增加 Cache internalcache.Cache // Extenders 算是调度框架中提供的调度插件，会影响kubernetes中的调度策略 Extenders []framework.Extender // NextPod 作为一个函数提供，会阻塞获取下一个ke'diao'du NextPod func() *framework.QueuedPodInfo // Error is called if there is an error. It is passed the pod in // question, and the error Error func(*framework."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://www.oomkill.com/posts/"},{"@type":"ListItem","position":2,"name":"kube-scheduler的调度上下文","item":"https://www.oomkill.com/2022/07/ch20-schedule-workflow/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"kube-scheduler的调度上下文","name":"kube-scheduler的调度上下文","description":"Scheduler Scheduler 是整个 kube-scheduler 的一个 structure，提供了 kube-scheduler 运行所需的组件。\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 type Scheduler struct { // Cache是一个抽象，会缓存pod的信息，作为scheduler进行查找，操作是基于Pod进行增加 Cache internalcache.Cache // Extenders 算是调度框架中提供的调度插件，会影响kubernetes中的调度策略 Extenders []framework.Extender // NextPod 作为一个函数提供，会阻塞获取下一个ke\u0026#39;diao\u0026#39;du NextPod func() *framework.QueuedPodInfo // Error is called if there is an error. It is passed the pod in // question, and the error Error func(*framework.","keywords":["kubernetes","develop"],"articleBody":"Scheduler Scheduler 是整个 kube-scheduler 的一个 structure，提供了 kube-scheduler 运行所需的组件。\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 type Scheduler struct { // Cache是一个抽象，会缓存pod的信息，作为scheduler进行查找，操作是基于Pod进行增加 Cache internalcache.Cache // Extenders 算是调度框架中提供的调度插件，会影响kubernetes中的调度策略 Extenders []framework.Extender // NextPod 作为一个函数提供，会阻塞获取下一个ke'diao'du NextPod func() *framework.QueuedPodInfo // Error is called if there is an error. It is passed the pod in // question, and the error Error func(*framework.QueuedPodInfo, error) // SchedulePod 尝试将给出的pod调度到Node。 SchedulePod func(ctx context.Context, fwk framework.Framework, state *framework.CycleState, pod *v1.Pod) (ScheduleResult, error) // 关闭scheduler的信号 StopEverything \u003c-chan struct{} // SchedulingQueue保存要调度的Pod SchedulingQueue internalqueue.SchedulingQueue // Profiles中是多个调度框架 Profiles profile.Map client clientset.Interface nodeInfoSnapshot *internalcache.Snapshot percentageOfNodesToScore int32 nextStartNodeIndex int } 作为实际执行的两个核心，SchedulingQueue ，与 scheduleOne 将会分析到这两个\nSchedulingQueue 在知道 kube-scheduler 初始化过程后，需要对 kube-scheduler 的整个 structure 和 workflow 进行分析\n在 Run 中，运行的是 一个 SchedulingQueue 与 一个 scheduleOne ，从结构上看是属于 Scheduler\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 func (sched *Scheduler) Run(ctx context.Context) { sched.SchedulingQueue.Run() // We need to start scheduleOne loop in a dedicated goroutine, // because scheduleOne function hangs on getting the next item // from the SchedulingQueue. // If there are no new pods to schedule, it will be hanging there // and if done in this goroutine it will be blocking closing // SchedulingQueue, in effect causing a deadlock on shutdown. go wait.UntilWithContext(ctx, sched.scheduleOne, 0) \u003c-ctx.Done() sched.SchedulingQueue.Close() } SchedulingQueue 是一个队列的抽象，用于存储等待调度的Pod。该接口遵循类似于 cache.FIFO 和 cache.Heap 的模式。\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 type SchedulingQueue interface { framework.PodNominator Add(pod *v1.Pod) error // Activate moves the given pods to activeQ iff they're in unschedulablePods or backoffQ. // The passed-in pods are originally compiled from plugins that want to activate Pods, // by injecting the pods through a reserved CycleState struct (PodsToActivate). Activate(pods map[string]*v1.Pod) // 将不可调度的Pod重入到队列中 AddUnschedulableIfNotPresent(pod *framework.QueuedPodInfo, podSchedulingCycle int64) error // SchedulingCycle returns the current number of scheduling cycle which is // cached by scheduling queue. Normally, incrementing this number whenever // a pod is popped (e.g. called Pop()) is enough. SchedulingCycle() int64 // Pop会弹出一个pod，并从head优先级队列中删除 Pop() (*framework.QueuedPodInfo, error) Update(oldPod, newPod *v1.Pod) error Delete(pod *v1.Pod) error MoveAllToActiveOrBackoffQueue(event framework.ClusterEvent, preCheck PreEnqueueCheck) AssignedPodAdded(pod *v1.Pod) AssignedPodUpdated(pod *v1.Pod) PendingPods() []*v1.Pod // Close closes the SchedulingQueue so that the goroutine which is // waiting to pop items can exit gracefully. Close() // Run starts the goroutines managing the queue. Run() } 而 PriorityQueue 是 SchedulingQueue 的实现，该部分的核心构成是两个子队列与一个数据结构，即 activeQ、backoffQ 和 unschedulablePods\nactiveQ：是一个 heap 类型的优先级队列，是 sheduler 从中获得优先级最高的Pod进行调度 backoffQ：也是一个 heap 类型的优先级队列，存放的是不可调度的Pod unschedulablePods ：保存确定不可被调度的Pod GO 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 type SchedulingQueue interface { framework.PodNominator Add(pod *v1.Pod) error // Activate moves the given pods to activeQ iff they're in unschedulablePods or backoffQ. // The passed-in pods are originally compiled from plugins that want to activate Pods, // by injecting the pods through a reserved CycleState struct (PodsToActivate). Activate(pods map[string]*v1.Pod) // AddUnschedulableIfNotPresent adds an unschedulable pod back to scheduling queue. // The podSchedulingCycle represents the current scheduling cycle number which can be // returned by calling SchedulingCycle(). AddUnschedulableIfNotPresent(pod *framework.QueuedPodInfo, podSchedulingCycle int64) error // SchedulingCycle returns the current number of scheduling cycle which is // cached by scheduling queue. Normally, incrementing this number whenever // a pod is popped (e.g. called Pop()) is enough. SchedulingCycle() int64 // Pop removes the head of the queue and returns it. It blocks if the // queue is empty and waits until a new item is added to the queue. Pop() (*framework.QueuedPodInfo, error) Update(oldPod, newPod *v1.Pod) error Delete(pod *v1.Pod) error MoveAllToActiveOrBackoffQueue(event framework.ClusterEvent, preCheck PreEnqueueCheck) AssignedPodAdded(pod *v1.Pod) AssignedPodUpdated(pod *v1.Pod) PendingPods() []*v1.Pod // Close closes the SchedulingQueue so that the goroutine which is // waiting to pop items can exit gracefully. Close() // Run starts the goroutines managing the queue. Run() } 在New scheduler 时可以看到会初始化这个queue\ngo 1 2 3 4 5 6 7 8 9 10 podQueue := internalqueue.NewSchedulingQueue( // 实现pod对比的一个函数即less profiles[options.profiles[0].SchedulerName].QueueSortFunc(), informerFactory, internalqueue.WithPodInitialBackoffDuration(time.Duration(options.podInitialBackoffSeconds)*time.Second), internalqueue.WithPodMaxBackoffDuration(time.Duration(options.podMaxBackoffSeconds)*time.Second), internalqueue.WithPodNominator(nominator), internalqueue.WithClusterEventMap(clusterEventMap), internalqueue.WithPodMaxInUnschedulablePodsDuration(options.podMaxInUnschedulablePodsDuration), ) 而 NewSchedulingQueue 则是初始化这个 PriorityQueue\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 // NewSchedulingQueue initializes a priority queue as a new scheduling queue. func NewSchedulingQueue( lessFn framework.LessFunc, informerFactory informers.SharedInformerFactory, opts ...Option) SchedulingQueue { return NewPriorityQueue(lessFn, informerFactory, opts...) } // NewPriorityQueue creates a PriorityQueue object. func NewPriorityQueue( lessFn framework.LessFunc, informerFactory informers.SharedInformerFactory, opts ...Option, ) *PriorityQueue { options := defaultPriorityQueueOptions for _, opt := range opts { opt(\u0026options) } // 这个就是 less函数，作为打分的一部分 comp := func(podInfo1, podInfo2 interface{}) bool { pInfo1 := podInfo1.(*framework.QueuedPodInfo) pInfo2 := podInfo2.(*framework.QueuedPodInfo) return lessFn(pInfo1, pInfo2) } if options.podNominator == nil { options.podNominator = NewPodNominator(informerFactory.Core().V1().Pods().Lister()) } pq := \u0026PriorityQueue{ PodNominator: options.podNominator, clock: options.clock, stop: make(chan struct{}), podInitialBackoffDuration: options.podInitialBackoffDuration, podMaxBackoffDuration: options.podMaxBackoffDuration, podMaxInUnschedulablePodsDuration: options.podMaxInUnschedulablePodsDuration, activeQ: heap.NewWithRecorder(podInfoKeyFunc, comp, metrics.NewActivePodsRecorder()), unschedulablePods: newUnschedulablePods(metrics.NewUnschedulablePodsRecorder()), moveRequestCycle: -1, clusterEventMap: options.clusterEventMap, } pq.cond.L = \u0026pq.lock pq.podBackoffQ = heap.NewWithRecorder(podInfoKeyFunc, pq.podsCompareBackoffCompleted, metrics.NewBackoffPodsRecorder()) pq.nsLister = informerFactory.Core().V1().Namespaces().Lister() return pq } 了解了Queue的结构，就需要知道 入队列与出队列是在哪里操作的。在初始化时，需要注册一个 addEventHandlerFuncs 这个时候，会注入三个动作函数，也就是controller中的概念；而在AddFunc中可以看到会入队列。\n注入是对 Pod 的informer注入的，注入的函数 addPodToSchedulingQueue 就是入栈\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 Handler: cache.ResourceEventHandlerFuncs{ AddFunc: sched.addPodToSchedulingQueue, UpdateFunc: sched.updatePodInSchedulingQueue, DeleteFunc: sched.deletePodFromSchedulingQueue, }, func (sched *Scheduler) addPodToSchedulingQueue(obj interface{}) { pod := obj.(*v1.Pod) klog.V(3).InfoS(\"Add event for unscheduled pod\", \"pod\", klog.KObj(pod)) if err := sched.SchedulingQueue.Add(pod); err != nil { utilruntime.HandleError(fmt.Errorf(\"unable to queue %T: %v\", obj, err)) } } 而这个 SchedulingQueue 的实现就是 PriorityQueue ，而Add中则对 activeQ进行的操作\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 func (p *PriorityQueue) Add(pod *v1.Pod) error { p.lock.Lock() defer p.lock.Unlock() // 格式化入栈数据，包含podinfo，里会包含v1.Pod // 初始化的时间，创建的时间，以及不能被调度时的记录其plugin的名称 pInfo := p.newQueuedPodInfo(pod) // 入栈 if err := p.activeQ.Add(pInfo); err != nil { klog.ErrorS(err, \"Error adding pod to the active queue\", \"pod\", klog.KObj(pod)) return err } if p.unschedulablePods.get(pod) != nil { klog.ErrorS(nil, \"Error: pod is already in the unschedulable queue\", \"pod\", klog.KObj(pod)) p.unschedulablePods.delete(pod) } // Delete pod from backoffQ if it is backing off if err := p.podBackoffQ.Delete(pInfo); err == nil { klog.ErrorS(nil, \"Error: pod is already in the podBackoff queue\", \"pod\", klog.KObj(pod)) } metrics.SchedulerQueueIncomingPods.WithLabelValues(\"active\", PodAdd).Inc() p.PodNominator.AddNominatedPod(pInfo.PodInfo, nil) p.cond.Broadcast() return nil } 在上面看 scheduler 结构时，可以看到有一个 nextPod的，nextPod就是从队列中弹出一个pod，这个在scheduler 时会传入 MakeNextPodFunc 就是这个 nextpod\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 func MakeNextPodFunc(queue SchedulingQueue) func() *framework.QueuedPodInfo { return func() *framework.QueuedPodInfo { podInfo, err := queue.Pop() if err == nil { klog.V(4).InfoS(\"About to try and schedule pod\", \"pod\", klog.KObj(podInfo.Pod)) for plugin := range podInfo.UnschedulablePlugins { metrics.UnschedulableReason(plugin, podInfo.Pod.Spec.SchedulerName).Dec() } return podInfo } klog.ErrorS(err, \"Error while retrieving next pod from scheduling queue\") return nil } } 而这个 queue.Pop() 对应的就是 PriorityQueue 的 Pop() ，在这里会将作为 activeQ 的消费端\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 func (p *PriorityQueue) Pop() (*framework.QueuedPodInfo, error) { p.lock.Lock() defer p.lock.Unlock() for p.activeQ.Len() == 0 { // When the queue is empty, invocation of Pop() is blocked until new item is enqueued. // When Close() is called, the p.closed is set and the condition is broadcast, // which causes this loop to continue and return from the Pop(). if p.closed { return nil, fmt.Errorf(queueClosed) } p.cond.Wait() } obj, err := p.activeQ.Pop() if err != nil { return nil, err } pInfo := obj.(*framework.QueuedPodInfo) pInfo.Attempts++ p.schedulingCycle++ return pInfo, nil } 在上面入口部分也看到了，scheduleOne 和 scheduler，scheduleOne 就是去消费一个Pod，他会调用 NextPod，NextPod就是在初始化传入的 MakeNextPodFunc ，至此回到对应的 Pop来做消费。\nschedulerOne是为一个Pod做调度的流程。\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 func (sched *Scheduler) scheduleOne(ctx context.Context) { podInfo := sched.NextPod() // pod could be nil when schedulerQueue is closed if podInfo == nil || podInfo.Pod == nil { return } pod := podInfo.Pod fwk, err := sched.frameworkForPod(pod) if err != nil { // This shouldn't happen, because we only accept for scheduling the pods // which specify a scheduler name that matches one of the profiles. klog.ErrorS(err, \"Error occurred\") return } if sched.skipPodSchedule(fwk, pod) { return } ... 调度上下文 当了解了scheduler结构后，下面分析下调度上下文的过程。看看扩展点是怎么工作的。这个时候又需要提到官网的调度上下文的图。\n图1：Pod的调度上下文 Source：https://kubernetes.io/docs/concepts/scheduling-eviction/scheduling-framework 而 scheduler 对于调度上下文来就是这个 scheduleOne ，下面就是看这个调度上下文\nSort Sort 插件提供了排序功能，用于对在调度队列中待处理 Pod 进行排序。一次只能启用一个队列排序。\n在进入 scheduleOne 后，NextPod 从 activeQ 中队列中得到一个Pod，然后的 frameworkForPod 会做打分的动作就是调度上下文的第一个扩展点 sort\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 func (sched *Scheduler) scheduleOne(ctx context.Context) { podInfo := sched.NextPod() // pod could be nil when schedulerQueue is closed if podInfo == nil || podInfo.Pod == nil { return } pod := podInfo.Pod fwk, err := sched.frameworkForPod(pod) ... func (sched *Scheduler) frameworkForPod(pod *v1.Pod) (framework.Framework, error) { // 获取指定的profile fwk, ok := sched.Profiles[pod.Spec.SchedulerName] if !ok { return nil, fmt.Errorf(\"profile not found for scheduler name %q\", pod.Spec.SchedulerName) } return fwk, nil } 回顾，因为在New scheduler时会初始化这个 sort 函数\ngo 1 2 3 4 5 6 7 8 9 podQueue := internalqueue.NewSchedulingQueue( profiles[options.profiles[0].SchedulerName].QueueSortFunc(), informerFactory, internalqueue.WithPodInitialBackoffDuration(time.Duration(options.podInitialBackoffSeconds)*time.Second), internalqueue.WithPodMaxBackoffDuration(time.Duration(options.podMaxBackoffSeconds)*time.Second), internalqueue.WithPodNominator(nominator), internalqueue.WithClusterEventMap(clusterEventMap), internalqueue.WithPodMaxInUnschedulablePodsDuration(options.podMaxInUnschedulablePodsDuration), ) preFilter preFilter作为第一个扩展点，是用于在过滤之前预处理或检查 Pod 或集群的相关信息。这里会终止调度\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 func (sched *Scheduler) scheduleOne(ctx context.Context) { podInfo := sched.NextPod() // pod could be nil when schedulerQueue is closed if podInfo == nil || podInfo.Pod == nil { return } pod := podInfo.Pod fwk, err := sched.frameworkForPod(pod) if err != nil { // This shouldn't happen, because we only accept for scheduling the pods // which specify a scheduler name that matches one of the profiles. klog.ErrorS(err, \"Error occurred\") return } if sched.skipPodSchedule(fwk, pod) { return } klog.V(3).InfoS(\"Attempting to schedule pod\", \"pod\", klog.KObj(pod)) // Synchronously attempt to find a fit for the pod. start := time.Now() state := framework.NewCycleState() state.SetRecordPluginMetrics(rand.Intn(100) \u003c pluginMetricsSamplePercent) // Initialize an empty podsToActivate struct, which will be filled up by plugins or stay empty. podsToActivate := framework.NewPodsToActivate() state.Write(framework.PodsToActivateKey, podsToActivate) schedulingCycleCtx, cancel := context.WithCancel(ctx) defer cancel() // 这里将进入prefilter scheduleResult, err := sched.SchedulePod(schedulingCycleCtx, fwk, state, pod) schedulePod 尝试将给定的 pod 调度到节点列表中的节点之一。如果成功，它将返回节点的名称。\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 func (sched *Scheduler) schedulePod(ctx context.Context, fwk framework.Framework, state *framework.CycleState, pod *v1.Pod) (result ScheduleResult, err error) { trace := utiltrace.New(\"Scheduling\", utiltrace.Field{Key: \"namespace\", Value: pod.Namespace}, utiltrace.Field{Key: \"name\", Value: pod.Name}) defer trace.LogIfLong(100 * time.Millisecond) // 用于将cache更新为当前内容 if err := sched.Cache.UpdateSnapshot(sched.nodeInfoSnapshot); err != nil { return result, err } trace.Step(\"Snapshotting scheduler cache and node infos done\") if sched.nodeInfoSnapshot.NumNodes() == 0 { return result, ErrNoNodesAvailable } // 找到一个合适的pod时，会执行扩展点 feasibleNodes, diagnosis, err := sched.findNodesThatFitPod(ctx, fwk, state, pod) ... findNodesThatFitPod 会执行对应的过滤插件来找到最适合的Node，包括备注，以及方法名都可以看到，这里运行的插件😁😁，后面会分析算法内容，只对workflow学习。\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 func (sched *Scheduler) findNodesThatFitPod(ctx context.Context, fwk framework.Framework, state *framework.CycleState, pod *v1.Pod) ([]*v1.Node, framework.Diagnosis, error) { diagnosis := framework.Diagnosis{ NodeToStatusMap: make(framework.NodeToStatusMap), UnschedulablePlugins: sets.NewString(), } // Run \"prefilter\" plugins. preRes, s := fwk.RunPreFilterPlugins(ctx, state, pod) allNodes, err := sched.nodeInfoSnapshot.NodeInfos().List() if err != nil { return nil, diagnosis, err } if !s.IsSuccess() { if !s.IsUnschedulable() { return nil, diagnosis, s.AsError() } // All nodes will have the same status. Some non trivial refactoring is // needed to avoid this copy. for _, n := range allNodes { diagnosis.NodeToStatusMap[n.Node().Name] = s } // Status satisfying IsUnschedulable() gets injected into diagnosis.UnschedulablePlugins. if s.FailedPlugin() != \"\" { diagnosis.UnschedulablePlugins.Insert(s.FailedPlugin()) } return nil, diagnosis, nil } // \"NominatedNodeName\" can potentially be set in a previous scheduling cycle as a result of preemption. // This node is likely the only candidate that will fit the pod, and hence we try it first before iterating over all nodes. if len(pod.Status.NominatedNodeName) \u003e 0 { feasibleNodes, err := sched.evaluateNominatedNode(ctx, pod, fwk, state, diagnosis) if err != nil { klog.ErrorS(err, \"Evaluation failed on nominated node\", \"pod\", klog.KObj(pod), \"node\", pod.Status.NominatedNodeName) } // Nominated node passes all the filters, scheduler is good to assign this node to the pod. if len(feasibleNodes) != 0 { return feasibleNodes, diagnosis, nil } } nodes := allNodes if !preRes.AllNodes() { nodes = make([]*framework.NodeInfo, 0, len(preRes.NodeNames)) for n := range preRes.NodeNames { nInfo, err := sched.nodeInfoSnapshot.NodeInfos().Get(n) if err != nil { return nil, diagnosis, err } nodes = append(nodes, nInfo) } } feasibleNodes, err := sched.findNodesThatPassFilters(ctx, fwk, state, pod, diagnosis, nodes) if err != nil { return nil, diagnosis, err } feasibleNodes, err = findNodesThatPassExtenders(sched.Extenders, pod, feasibleNodes, diagnosis.NodeToStatusMap) if err != nil { return nil, diagnosis, err } return feasibleNodes, diagnosis, nil } filter filter插件相当于调度上下文中的 Predicates，用于排除不能运行 Pod 的节点。Filter 会按配置的顺序进行调用。如果有一个filter将节点标记位不可用，则将 Pod 标记为不可调度（即不会向下执行）。\n对于代码中来讲，filter还是处于 findNodesThatFitPod 函数中，findNodesThatPassFilters 就是获取到 FN，即可行节点，而这个过程就是 filter 扩展点\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 func (sched *Scheduler) findNodesThatFitPod(ctx context.Context, fwk framework.Framework, state *framework.CycleState, pod *v1.Pod) ([]*v1.Node, framework.Diagnosis, error) { ... feasibleNodes, err := sched.findNodesThatPassFilters(ctx, fwk, state, pod, diagnosis, nodes) if err != nil { return nil, diagnosis, err } feasibleNodes, err = findNodesThatPassExtenders(sched.Extenders, pod, feasibleNodes, diagnosis.NodeToStatusMap) if err != nil { return nil, diagnosis, err } return feasibleNodes, diagnosis, nil } Postfilter 当没有为 pod 找到FN时，该插件会按照配置的顺序进行调用。如果任何postFilter插件将 Pod 标记为schedulable，则不会调用其余插件。即 filter 成功后不会进行这步骤，那我们来验证下这里把😊\n还是在 scheduleOne 中，当我们运行的 SchedulePod 完成后（成功或失败），这时会返回一个err，而 postfilter 会根据这个 err进行选择执行或不执行，符合官方给出的说法。\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 scheduleResult, err := sched.SchedulePod(schedulingCycleCtx, fwk, state, pod) if err != nil { // SchedulePod() may have failed because the pod would not fit on any host, so we try to // preempt, with the expectation that the next time the pod is tried for scheduling it // will fit due to the preemption. It is also possible that a different pod will schedule // into the resources that were preempted, but this is harmless. var nominatingInfo *framework.NominatingInfo if fitError, ok := err.(*framework.FitError); ok { if !fwk.HasPostFilterPlugins() { klog.V(3).InfoS(\"No PostFilter plugins are registered, so no preemption will be performed\") } else { // Run PostFilter plugins to try to make the pod schedulable in a future scheduling cycle. result, status := fwk.RunPostFilterPlugins(ctx, state, pod, fitError.Diagnosis.NodeToStatusMap) if status.Code() == framework.Error { klog.ErrorS(nil, \"Status after running PostFilter plugins for pod\", \"pod\", klog.KObj(pod), \"status\", status) } else { fitError.Diagnosis.PostFilterMsg = status.Message() klog.V(5).InfoS(\"Status after running PostFilter plugins for pod\", \"pod\", klog.KObj(pod), \"status\", status) } if result != nil { nominatingInfo = result.NominatingInfo } } // Pod did not fit anywhere, so it is counted as a failure. If preemption // succeeds, the pod should get counted as a success the next time we try to // schedule it. (hopefully) metrics.PodUnschedulable(fwk.ProfileName(), metrics.SinceInSeconds(start)) } else if err == ErrNoNodesAvailable { nominatingInfo = clearNominatedNode // No nodes available is counted as unschedulable rather than an error. metrics.PodUnschedulable(fwk.ProfileName(), metrics.SinceInSeconds(start)) } else { nominatingInfo = clearNominatedNode klog.ErrorS(err, \"Error selecting node for pod\", \"pod\", klog.KObj(pod)) metrics.PodScheduleError(fwk.ProfileName(), metrics.SinceInSeconds(start)) } sched.handleSchedulingFailure(ctx, fwk, podInfo, err, v1.PodReasonUnschedulable, nominatingInfo) return } PreScore,Score 可用于进行预Score工作，作为通知性的扩展点，会在在filter完之后直接会关联 preScore 插件进行继续工作，而不是返回，如果配置的这些插件有任何一个返回失败，则Pod将被拒绝。\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 func (sched *Scheduler) schedulePod(ctx context.Context, fwk framework.Framework, state *framework.CycleState, pod *v1.Pod) (result ScheduleResult, err error) { trace := utiltrace.New(\"Scheduling\", utiltrace.Field{Key: \"namespace\", Value: pod.Namespace}, utiltrace.Field{Key: \"name\", Value: pod.Name}) defer trace.LogIfLong(100 * time.Millisecond) if err := sched.Cache.UpdateSnapshot(sched.nodeInfoSnapshot); err != nil { return result, err } trace.Step(\"Snapshotting scheduler cache and node infos done\") if sched.nodeInfoSnapshot.NumNodes() == 0 { return result, ErrNoNodesAvailable } feasibleNodes, diagnosis, err := sched.findNodesThatFitPod(ctx, fwk, state, pod) if err != nil { return result, err } trace.Step(\"Computing predicates done\") if len(feasibleNodes) == 0 { return result, \u0026framework.FitError{ Pod: pod, NumAllNodes: sched.nodeInfoSnapshot.NumNodes(), Diagnosis: diagnosis, } } // When only one node after predicate, just use it. if len(feasibleNodes) == 1 { return ScheduleResult{ SuggestedHost: feasibleNodes[0].Name, EvaluatedNodes: 1 + len(diagnosis.NodeToStatusMap), FeasibleNodes: 1, }, nil } // 这里会完成prescore，score priorityList, err := prioritizeNodes(ctx, sched.Extenders, fwk, state, pod, feasibleNodes) if err != nil { return result, err } host, err := selectHost(priorityList) trace.Step(\"Prioritizing done\") return ScheduleResult{ SuggestedHost: host, EvaluatedNodes: len(feasibleNodes) + len(diagnosis.NodeToStatusMap), FeasibleNodes: len(feasibleNodes), }, err } priorityNodes 会通过配置的插件给Node打分，并返回每个Node的分数，将每个插件打分结果计算总和获得Node的分数，最后获得节点的加权总分数。\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 func prioritizeNodes( ctx context.Context, extenders []framework.Extender, fwk framework.Framework, state *framework.CycleState, pod *v1.Pod, nodes []*v1.Node, ) (framework.NodeScoreList, error) { // If no priority configs are provided, then all nodes will have a score of one. // This is required to generate the priority list in the required format if len(extenders) == 0 \u0026\u0026 !fwk.HasScorePlugins() { result := make(framework.NodeScoreList, 0, len(nodes)) for i := range nodes { result = append(result, framework.NodeScore{ Name: nodes[i].Name, Score: 1, }) } return result, nil } // Run PreScore plugins. preScoreStatus := fwk.RunPreScorePlugins(ctx, state, pod, nodes) if !preScoreStatus.IsSuccess() { return nil, preScoreStatus.AsError() } // Run the Score plugins. scoresMap, scoreStatus := fwk.RunScorePlugins(ctx, state, pod, nodes) if !scoreStatus.IsSuccess() { return nil, scoreStatus.AsError() } // Additional details logged at level 10 if enabled. klogV := klog.V(10) if klogV.Enabled() { for plugin, nodeScoreList := range scoresMap { for _, nodeScore := range nodeScoreList { klogV.InfoS(\"Plugin scored node for pod\", \"pod\", klog.KObj(pod), \"plugin\", plugin, \"node\", nodeScore.Name, \"score\", nodeScore.Score) } } } // Summarize all scores. result := make(framework.NodeScoreList, 0, len(nodes)) for i := range nodes { result = append(result, framework.NodeScore{Name: nodes[i].Name, Score: 0}) for j := range scoresMap { result[i].Score += scoresMap[j][i].Score } } if len(extenders) != 0 \u0026\u0026 nodes != nil { var mu sync.Mutex var wg sync.WaitGroup combinedScores := make(map[string]int64, len(nodes)) for i := range extenders { if !extenders[i].IsInterested(pod) { continue } wg.Add(1) go func(extIndex int) { metrics.SchedulerGoroutines.WithLabelValues(metrics.PrioritizingExtender).Inc() defer func() { metrics.SchedulerGoroutines.WithLabelValues(metrics.PrioritizingExtender).Dec() wg.Done() }() prioritizedList, weight, err := extenders[extIndex].Prioritize(pod, nodes) if err != nil { // Prioritization errors from extender can be ignored, let k8s/other extenders determine the priorities klog.V(5).InfoS(\"Failed to run extender's priority function. No score given by this extender.\", \"error\", err, \"pod\", klog.KObj(pod), \"extender\", extenders[extIndex].Name()) return } mu.Lock() for i := range *prioritizedList { host, score := (*prioritizedList)[i].Host, (*prioritizedList)[i].Score if klogV.Enabled() { klogV.InfoS(\"Extender scored node for pod\", \"pod\", klog.KObj(pod), \"extender\", extenders[extIndex].Name(), \"node\", host, \"score\", score) } combinedScores[host] += score * weight } mu.Unlock() }(i) } // wait for all go routines to finish wg.Wait() for i := range result { // MaxExtenderPriority may diverge from the max priority used in the scheduler and defined by MaxNodeScore, // therefore we need to scale the score returned by extenders to the score range used by the scheduler. result[i].Score += combinedScores[result[i].Name] * (framework.MaxNodeScore / extenderv1.MaxExtenderPriority) } } if klogV.Enabled() { for i := range result { klogV.InfoS(\"Calculated node's final score for pod\", \"pod\", klog.KObj(pod), \"node\", result[i].Name, \"score\", result[i].Score) } } return result, nil } Reserve Reserve 因为绑定事件时异步发生的，该插件是为了避免Pod在绑定到节点前时，调度到新的Pod，使节点使用资源超过可用资源情况。如果后续阶段发生错误或失败，将触发 UnReserve 回滚（通知性扩展点）。这也是作为调度周期中最后一个状态，要么成功到 postBind ，要么失败触发 UnReserve。\ngo 1 2 3 4 5 6 7 8 9 10 11 // Run the Reserve method of reserve plugins. if sts := fwk.RunReservePluginsReserve(schedulingCycleCtx, state, assumedPod, scheduleResult.SuggestedHost); !sts.IsSuccess() { // 当处理不成功时 metrics.PodScheduleError(fwk.ProfileName(), metrics.SinceInSeconds(start)) // 触发 un-reserve 来清理相关Pod的状态 fwk.RunReservePluginsUnreserve(schedulingCycleCtx, state, assumedPod, scheduleResult.SuggestedHost) if forgetErr := sched.Cache.ForgetPod(assumedPod); forgetErr != nil { klog.ErrorS(forgetErr, \"Scheduler cache ForgetPod failed\") } sched.handleSchedulingFailure(ctx, fwk, assumedPodInfo, sts.AsError(), SchedulerError, clearNominatedNode) return } permit Permit 插件可以阻止或延迟 Pod 的绑定\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 // Run \"permit\" plugins. runPermitStatus := fwk.RunPermitPlugins(schedulingCycleCtx, state, assumedPod, scheduleResult.SuggestedHost) if !runPermitStatus.IsWait() \u0026\u0026 !runPermitStatus.IsSuccess() { var reason string if runPermitStatus.IsUnschedulable() { metrics.PodUnschedulable(fwk.ProfileName(), metrics.SinceInSeconds(start)) reason = v1.PodReasonUnschedulable } else { metrics.PodScheduleError(fwk.ProfileName(), metrics.SinceInSeconds(start)) reason = SchedulerError } // 只要其中一个插件返回的状态不是 success 或者 wait fwk.RunReservePluginsUnreserve(schedulingCycleCtx, state, assumedPod, scheduleResult.SuggestedHost) // 从cache中忘掉pod if forgetErr := sched.Cache.ForgetPod(assumedPod); forgetErr != nil { klog.ErrorS(forgetErr, \"Scheduler cache ForgetPod failed\") } sched.handleSchedulingFailure(ctx, fwk, assumedPodInfo, runPermitStatus.AsError(), reason, clearNominatedNode) return } Binding Cycle 在选择好 FN 后则做一个假设绑定，并更新到cache中，接下来回去执行真正的bind操作，也就是 binding cycle\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 func (sched *Scheduler) scheduleOne(ctx context.Context) { ... ... // binding cycle 是一个异步的操作，这里表现就是go协程 go func() { bindingCycleCtx, cancel := context.WithCancel(ctx) defer cancel() metrics.SchedulerGoroutines.WithLabelValues(metrics.Binding).Inc() defer metrics.SchedulerGoroutines.WithLabelValues(metrics.Binding).Dec() // 运行WaitOnPermit插件，如果失败则，unReserve回滚 waitOnPermitStatus := fwk.WaitOnPermit(bindingCycleCtx, assumedPod) if !waitOnPermitStatus.IsSuccess() { var reason string if waitOnPermitStatus.IsUnschedulable() { metrics.PodUnschedulable(fwk.ProfileName(), metrics.SinceInSeconds(start)) reason = v1.PodReasonUnschedulable } else { metrics.PodScheduleError(fwk.ProfileName(), metrics.SinceInSeconds(start)) reason = SchedulerError } // trigger un-reserve plugins to clean up state associated with the reserved Pod fwk.RunReservePluginsUnreserve(bindingCycleCtx, state, assumedPod, scheduleResult.SuggestedHost) if forgetErr := sched.Cache.ForgetPod(assumedPod); forgetErr != nil { klog.ErrorS(forgetErr, \"scheduler cache ForgetPod failed\") } else { // \"Forget\"ing an assumed Pod in binding cycle should be treated as a PodDelete event, // as the assumed Pod had occupied a certain amount of resources in scheduler cache. // TODO(#103853): de-duplicate the logic. // Avoid moving the assumed Pod itself as it's always Unschedulable. // It's intentional to \"defer\" this operation; otherwise MoveAllToActiveOrBackoffQueue() would // update `q.moveRequest` and thus move the assumed pod to backoffQ anyways. defer sched.SchedulingQueue.MoveAllToActiveOrBackoffQueue(internalqueue.AssignedPodDelete, func(pod *v1.Pod) bool { return assumedPod.UID != pod.UID }) } sched.handleSchedulingFailure(ctx, fwk, assumedPodInfo, waitOnPermitStatus.AsError(), reason, clearNominatedNode) return } // 运行Prebind 插件 preBindStatus := fwk.RunPreBindPlugins(bindingCycleCtx, state, assumedPod, scheduleResult.SuggestedHost) if !preBindStatus.IsSuccess() { metrics.PodScheduleError(fwk.ProfileName(), metrics.SinceInSeconds(start)) // trigger un-reserve plugins to clean up state associated with the reserved Pod fwk.RunReservePluginsUnreserve(bindingCycleCtx, state, assumedPod, scheduleResult.SuggestedHost) if forgetErr := sched.Cache.ForgetPod(assumedPod); forgetErr != nil { klog.ErrorS(forgetErr, \"scheduler cache ForgetPod failed\") } else { // \"Forget\"ing an assumed Pod in binding cycle should be treated as a PodDelete event, // as the assumed Pod had occupied a certain amount of resources in scheduler cache. // TODO(#103853): de-duplicate the logic. sched.SchedulingQueue.MoveAllToActiveOrBackoffQueue(internalqueue.AssignedPodDelete, nil) } sched.handleSchedulingFailure(ctx, fwk, assumedPodInfo, preBindStatus.AsError(), SchedulerError, clearNominatedNode) return } // bind是真正的绑定操作 err := sched.bind(bindingCycleCtx, fwk, assumedPod, scheduleResult.SuggestedHost, state) if err != nil { metrics.PodScheduleError(fwk.ProfileName(), metrics.SinceInSeconds(start)) // 如果失败了就触发 un-reserve plugins fwk.RunReservePluginsUnreserve(bindingCycleCtx, state, assumedPod, scheduleResult.SuggestedHost) if err := sched.Cache.ForgetPod(assumedPod); err != nil { klog.ErrorS(err, \"scheduler cache ForgetPod failed\") } else { // \"Forget\"ing an assumed Pod in binding cycle should be treated as a PodDelete event, // as the assumed Pod had occupied a certain amount of resources in scheduler cache. // TODO(#103853): de-duplicate the logic. sched.SchedulingQueue.MoveAllToActiveOrBackoffQueue(internalqueue.AssignedPodDelete, nil) } sched.handleSchedulingFailure(ctx, fwk, assumedPodInfo, fmt.Errorf(\"binding rejected: %w\", err), SchedulerError, clearNominatedNode) return } // Calculating nodeResourceString can be heavy. Avoid it if klog verbosity is below 2. klog.V(2).InfoS(\"Successfully bound pod to node\", \"pod\", klog.KObj(pod), \"node\", scheduleResult.SuggestedHost, \"evaluatedNodes\", scheduleResult.EvaluatedNodes, \"feasibleNodes\", scheduleResult.FeasibleNodes) metrics.PodScheduled(fwk.ProfileName(), metrics.SinceInSeconds(start)) metrics.PodSchedulingAttempts.Observe(float64(podInfo.Attempts)) metrics.PodSchedulingDuration.WithLabelValues(getAttemptsLabel(podInfo)).Observe(metrics.SinceInSeconds(podInfo.InitialAttemptTimestamp)) // 运行 \"postbind\" 插件 // 是通知性的扩展点，该插件在绑定 Pod 后调用，可用于清理相关资源（）。 fwk.RunPostBindPlugins(bindingCycleCtx, state, assumedPod, scheduleResult.SuggestedHost) // At the end of a successful binding cycle, move up Pods if needed. if len(podsToActivate.Map) != 0 { sched.SchedulingQueue.Activate(podsToActivate.Map) // Unlike the logic in scheduling cycle, we don't bother deleting the entries // as `podsToActivate.Map` is no longer consumed. } }() } 调度上下文中的失败流程 上面说到的都是正常的请求，下面会对失败的请求是如何重试的进行分析，而 scheduler 中关于失败处理方面相关的属性会涉及到上面 scheduler 结构中的 backoffQ 与 unschedulablePods backoffQ：也是一个 heap 类型的优先级队列，存放的是不可调度的Pod unschedulablePods ：保存确定不可被调度的Pod，一个map类型 backoffQ 与 unschedulablePods 会在初始化 scheduler 时初始化，\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 func NewPriorityQueue( lessFn framework.LessFunc, informerFactory informers.SharedInformerFactory, opts ...Option, ) *PriorityQueue { options := defaultPriorityQueueOptions for _, opt := range opts { opt(\u0026options) } comp := func(podInfo1, podInfo2 interface{}) bool { pInfo1 := podInfo1.(*framework.QueuedPodInfo) pInfo2 := podInfo2.(*framework.QueuedPodInfo) return lessFn(pInfo1, pInfo2) } if options.podNominator == nil { options.podNominator = NewPodNominator(informerFactory.Core().V1().Pods().Lister()) } pq := \u0026PriorityQueue{ PodNominator: options.podNominator, clock: options.clock, stop: make(chan struct{}), podInitialBackoffDuration: options.podInitialBackoffDuration, podMaxBackoffDuration: options.podMaxBackoffDuration, podMaxInUnschedulablePodsDuration: options.podMaxInUnschedulablePodsDuration, activeQ: heap.NewWithRecorder(podInfoKeyFunc, comp, metrics.NewActivePodsRecorder()), unschedulablePods: newUnschedulablePods(metrics.NewUnschedulablePodsRecorder()), moveRequestCycle: -1, clusterEventMap: options.clusterEventMap, } pq.cond.L = \u0026pq.lock // 初始化backoffQ // NewWithRecorder作为一个可选的 metricRecorder 的 Heap 对象。 // podInfoKeyFunc是一个函数，返回错误与字符串 // pq.podsCompareBackoffCompleted 比较两个pod的回退时间，如果第一个在第二个之前为true， // 反之 false pq.podBackoffQ = heap.NewWithRecorder(podInfoKeyFunc, pq.podsCompareBackoffCompleted, metrics.NewBackoffPodsRecorder()) pq.nsLister = informerFactory.Core().V1().Namespaces().Lister() return pq } 对于初始化 backoffQ 会产生的两个函数，getBackoffTime 与 calculateBackoffDuration\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 // getBackoffTime returns the time that podInfo completes backoff func (p *PriorityQueue) getBackoffTime(podInfo *framework.QueuedPodInfo) time.Time { duration := p.calculateBackoffDuration(podInfo) backoffTime := podInfo.Timestamp.Add(duration) return backoffTime } // calculateBackoffDuration is a helper function for calculating the backoffDuration // based on the number of attempts the pod has made. func (p *PriorityQueue) calculateBackoffDuration(podInfo *framework.QueuedPodInfo) time.Duration { duration := p.podInitialBackoffDuration for i := 1; i \u003c podInfo.Attempts; i++ { // Use subtraction instead of addition or multiplication to avoid overflow. if duration \u003e p.podMaxBackoffDuration-duration { return p.podMaxBackoffDuration } duration += duration } return duration } 对于整个故障错误会按照如下流程进行，在初始化 scheduler 会注册一个 Error 函数，这个函数用作对不可调度Pod进行处理，实际上被注册的函数是 MakeDefaultErrorFunc。这个函数将作为 Error 函数被调用。\ngo 1 2 3 4 5 6 7 8 9 10 11 12 sched := newScheduler( schedulerCache, extenders, internalqueue.MakeNextPodFunc(podQueue), MakeDefaultErrorFunc(client, podLister, podQueue, schedulerCache), stopEverything, podQueue, profiles, client, snapshot, options.percentageOfNodesToScore, ) 而在 调度周期中，也就是 scheduleOne 可以看到，每个扩展点操作失败后都会调用 handleSchedulingFailure 而该函数，使用了注册的 Error 函数来处理Pod\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 func (sched *Scheduler) scheduleOne(ctx context.Context) { ... defer cancel() scheduleResult, err := sched.SchedulePod(schedulingCycleCtx, fwk, state, pod) if err != nil { var nominatingInfo *framework.NominatingInfo if fitError, ok := err.(*framework.FitError); ok { if !fwk.HasPostFilterPlugins() { klog.V(3).InfoS(\"No PostFilter plugins are registered, so no preemption will be performed\") } else { result, status := fwk.RunPostFilterPlugins(ctx, state, pod, fitError.Diagnosis.NodeToStatusMap) if status.Code() == framework.Error { klog.ErrorS(nil, \"Status after running PostFilter plugins for pod\", \"pod\", klog.KObj(pod), \"status\", status) } else { fitError.Diagnosis.PostFilterMsg = status.Message() klog.V(5).InfoS(\"Status after running PostFilter plugins for pod\", \"pod\", klog.KObj(pod), \"status\", status) } if result != nil { nominatingInfo = result.NominatingInfo } } metrics.PodUnschedulable(fwk.ProfileName(), metrics.SinceInSeconds(start)) } else if err == ErrNoNodesAvailable { nominatingInfo = clearNominatedNode // No nodes available is counted as unschedulable rather than an error. metrics.PodUnschedulable(fwk.ProfileName(), metrics.SinceInSeconds(start)) } else { nominatingInfo = clearNominatedNode klog.ErrorS(err, \"Error selecting node for pod\", \"pod\", klog.KObj(pod)) metrics.PodScheduleError(fwk.ProfileName(), metrics.SinceInSeconds(start)) } // 处理不可调度Pod sched.handleSchedulingFailure(ctx, fwk, podInfo, err, v1.PodReasonUnschedulable, nominatingInfo) return } 来到了注册的 Error 函数 MakeDefaultErrorFunc\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 func MakeDefaultErrorFunc(client clientset.Interface, podLister corelisters.PodLister, podQueue internalqueue.SchedulingQueue, schedulerCache internalcache.Cache) func(*framework.QueuedPodInfo, error) { return func(podInfo *framework.QueuedPodInfo, err error) { pod := podInfo.Pod if err == ErrNoNodesAvailable { klog.V(2).InfoS(\"Unable to schedule pod; no nodes are registered to the cluster; waiting\", \"pod\", klog.KObj(pod)) } else if fitError, ok := err.(*framework.FitError); ok { // Inject UnschedulablePlugins to PodInfo, which will be used later for moving Pods between queues efficiently. podInfo.UnschedulablePlugins = fitError.Diagnosis.UnschedulablePlugins klog.V(2).InfoS(\"Unable to schedule pod; no fit; waiting\", \"pod\", klog.KObj(pod), \"err\", err) } else if apierrors.IsNotFound(err) { klog.V(2).InfoS(\"Unable to schedule pod, possibly due to node not found; waiting\", \"pod\", klog.KObj(pod), \"err\", err) if errStatus, ok := err.(apierrors.APIStatus); ok \u0026\u0026 errStatus.Status().Details.Kind == \"node\" { nodeName := errStatus.Status().Details.Name // when node is not found, We do not remove the node right away. Trying again to get // the node and if the node is still not found, then remove it from the scheduler cache. _, err := client.CoreV1().Nodes().Get(context.TODO(), nodeName, metav1.GetOptions{}) if err != nil \u0026\u0026 apierrors.IsNotFound(err) { node := v1.Node{ObjectMeta: metav1.ObjectMeta{Name: nodeName}} if err := schedulerCache.RemoveNode(\u0026node); err != nil { klog.V(4).InfoS(\"Node is not found; failed to remove it from the cache\", \"node\", node.Name) } } } } else { klog.ErrorS(err, \"Error scheduling pod; retrying\", \"pod\", klog.KObj(pod)) } // Check if the Pod exists in informer cache. cachedPod, err := podLister.Pods(pod.Namespace).Get(pod.Name) if err != nil { klog.InfoS(\"Pod doesn't exist in informer cache\", \"pod\", klog.KObj(pod), \"err\", err) return } // In the case of extender, the pod may have been bound successfully, but timed out returning its response to the scheduler. // It could result in the live version to carry .spec.nodeName, and that's inconsistent with the internal-queued version. if len(cachedPod.Spec.NodeName) != 0 { klog.InfoS(\"Pod has been assigned to node. Abort adding it back to queue.\", \"pod\", klog.KObj(pod), \"node\", cachedPod.Spec.NodeName) return } // As is from SharedInformer, we need to do a DeepCopy() here. podInfo.PodInfo = framework.NewPodInfo(cachedPod.DeepCopy()) // 添加到unschedulable队列中 if err := podQueue.AddUnschedulableIfNotPresent(podInfo, podQueue.SchedulingCycle()); err != nil { klog.ErrorS(err, \"Error occurred\") } } } 下面来到 AddUnschedulableIfNotPresent ，这个也是操作 backoffQ 和 unschedulablePods 的真正的动作\nAddUnschedulableIfNotPresent 函数会吧无法调度的 pod 插入队列，除非它已经在队列中。通常情况下，PriorityQueue 将不可调度的 Pod 放在 unschedulablePods 中。但如果最近有 move request，则将 pod 放入 podBackoffQ 中。\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 func (p *PriorityQueue) AddUnschedulableIfNotPresent(pInfo *framework.QueuedPodInfo, podSchedulingCycle int64) error { p.lock.Lock() defer p.lock.Unlock() pod := pInfo.Pod // 如果已经存在则不添加 if p.unschedulablePods.get(pod) != nil { return fmt.Errorf(\"Pod %v is already present in unschedulable queue\", klog.KObj(pod)) } // 检查是否在activeQ中 if _, exists, _ := p.activeQ.Get(pInfo); exists { return fmt.Errorf(\"Pod %v is already present in the active queue\", klog.KObj(pod)) } // 检查是否在podBackoffQ中 if _, exists, _ := p.podBackoffQ.Get(pInfo); exists { return fmt.Errorf(\"Pod %v is already present in the backoff queue\", klog.KObj(pod)) } // 在重新添加时，会刷新 Pod时间为最新操作的时间 pInfo.Timestamp = p.clock.Now() for plugin := range pInfo.UnschedulablePlugins { metrics.UnschedulableReason(plugin, pInfo.Pod.Spec.SchedulerName).Inc() } // 如果接受到move request那么则放入BackoffQ if p.moveRequestCycle \u003e= podSchedulingCycle { if err := p.podBackoffQ.Add(pInfo); err != nil { return fmt.Errorf(\"error adding pod %v to the backoff queue: %v\", pod.Name, err) } metrics.SchedulerQueueIncomingPods.WithLabelValues(\"backoff\", ScheduleAttemptFailure).Inc() } else { // 否则将放入到 unschedulablePods p.unschedulablePods.addOrUpdate(pInfo) metrics.SchedulerQueueIncomingPods.WithLabelValues(\"unschedulable\", ScheduleAttemptFailure).Inc() } p.PodNominator.AddNominatedPod(pInfo.PodInfo, nil) return nil } 在启动 scheduler 时，会将这两个队列异步启用两个loop来操作队列。表现在 Run()\ngo 1 2 3 4 func (p *PriorityQueue) Run() { go wait.Until(p.flushBackoffQCompleted, 1.0*time.Second, p.stop) go wait.Until(p.flushUnschedulablePodsLeftover, 30*time.Second, p.stop) } 可以看到 flushBackoffQCompleted 作为 BackoffQ 实现；而 flushUnschedulablePodsLeftover 作为 UnschedulablePods 实现。\nflushBackoffQCompleted 是用于将所有已完成回退的 pod 从 backoffQ 移到 activeQ 中\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 func (p *PriorityQueue) flushBackoffQCompleted() { p.lock.Lock() defer p.lock.Unlock() broadcast := false for { // 这就是heap实现的方法，窥视下，但不弹出 rawPodInfo := p.podBackoffQ.Peek() if rawPodInfo == nil { break } pod := rawPodInfo.(*framework.QueuedPodInfo).Pod boTime := p.getBackoffTime(rawPodInfo.(*framework.QueuedPodInfo)) if boTime.After(p.clock.Now()) { break } _, err := p.podBackoffQ.Pop() // 弹出一个 if err != nil { klog.ErrorS(err, \"Unable to pop pod from backoff queue despite backoff completion\", \"pod\", klog.KObj(pod)) break } p.activeQ.Add(rawPodInfo) // 放入到活动队列中 metrics.SchedulerQueueIncomingPods.WithLabelValues(\"active\", BackoffComplete).Inc() broadcast = true } if broadcast { p.cond.Broadcast() } } flushUnschedulablePodsLeftover 函数用于将在 unschedulablePods 中的存放时间超过 podMaxInUnschedulablePodsDuration 值的 pod 移动到 backoffQ 或 activeQ 中。\npodMaxInUnschedulablePodsDuration 会根据配置传入，当没有传入，也就是使用了 Deprecated 那么会为5分钟。\ngo 1 2 3 4 5 6 7 8 func NewOptions() *Options { o := \u0026Options{ SecureServing: apiserveroptions.NewSecureServingOptions().WithLoopback(), Authentication: apiserveroptions.NewDelegatingAuthenticationOptions(), Authorization: apiserveroptions.NewDelegatingAuthorizationOptions(), Deprecated: \u0026DeprecatedOptions{ PodMaxInUnschedulablePodsDuration: 5 * time.Minute, }, 对于 flushUnschedulablePodsLeftover 就是做一个时间对比，然后添加到对应的队列中\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 func (p *PriorityQueue) flushUnschedulablePodsLeftover() { p.lock.Lock() defer p.lock.Unlock() var podsToMove []*framework.QueuedPodInfo currentTime := p.clock.Now() for _, pInfo := range p.unschedulablePods.podInfoMap { lastScheduleTime := pInfo.Timestamp if currentTime.Sub(lastScheduleTime) \u003e p.podMaxInUnschedulablePodsDuration { podsToMove = append(podsToMove, pInfo) } } if len(podsToMove) \u003e 0 { p.movePodsToActiveOrBackoffQueue(podsToMove, UnschedulableTimeout) } } 总结调度上下文流程 在构建一个 scheduler 时经历如下步骤： 准备cache，informer，queue，错误处理函数等 添加事件函数，会监听资源（如Pod），当有变动则触发对应事件函数，这是入站 activeQ 构建完成后会 run，run时会run一个 SchedulingQueue，这个是作为不可调度队列 BackoffQ UnschedulablePods 不可调度队列会根据注册时定期消费队列中Pod将其添加到 activeQ 中 启动一个 scheduleOne 的loop，这个是调度上下文中所有的扩展点的执行，也是 activeQ 的消费端 scheduleOne 获取 pod 执行各个扩展点，如果出错则 Error 函数 MakeDefaultErrorFunc 将其添加到不可调度队列中 回到不可调度队列中消费部分 Reference [1] kubernetes scheduler extender\n","wordCount":"5322","inLanguage":"zh","datePublished":"2022-07-21T00:00:00Z","dateModified":"0001-01-01T00:00:00Z","author":{"@type":"Person","name":"cylon"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.oomkill.com/2022/07/ch20-schedule-workflow/"},"publisher":{"@type":"Organization","name":"Cylon's Collection","logo":{"@type":"ImageObject","url":"https://www.oomkill.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.oomkill.com/><img src=https://www.oomkill.com/favicon.ico alt aria-label=logo height=20>Cylon's Collection</a><div class=logo-switches><button id=theme-toggle><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://www.oomkill.com/archives><span>归档</span></a></li><li><a href=https://www.oomkill.com/tags><span>标签</span></a></li><li><a href=https://www.oomkill.com/search><span>搜索</span></a></li><li><a href=https://www.oomkill.com/about accesskey=/><span>关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">kube-scheduler的调度上下文</h1><div class=post-meta><span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar" style="user-select:text"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" style="user-select:text"/><line x1="16" y1="2" x2="16" y2="6" style="user-select:text"/><line x1="8" y1="2" x2="8" y2="6" style="user-select:text"/><line x1="3" y1="10" x2="21" y2="10" style="user-select:text"/></svg><span>2022-07-21</span></span>&nbsp;·&nbsp;<span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text" style="user-select:text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z" style="user-select:text"/><polyline points="14 2 14 8 20 8" style="user-select:text"/><line x1="16" y1="13" x2="8" y2="13" style="user-select:text"/><line x1="16" y1="17" x2="8" y2="17" style="user-select:text"/><polyline points="10 9 9 9 8 9" style="user-select:text"/></svg><span>5322 字</span></span>&nbsp;·&nbsp;<span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><span>25 分钟</span></span>
<span class=pe-post-meta-item>&nbsp;·&nbsp;<svg t="1714036239378" fill="currentcolor" class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="6659" width="256" height="256"><path d="M690 78.2c-18.6-18.8-49-19-67.8-.4s-19 49-.4 67.8l255.4 258.6c67.8 68.6 67.8 178.8.0 247.4L653.4 878.2c-18.6 18.8-18.4 49.2.4 67.8s49.2 18.4 67.8-.4l224-226.4c104.8-106 104.8-276.4.0-382.4L690 78.2zM485.4 101.4c-24-24-56.6-37.4-90.6-37.4H96C43 64 0 107 0 160v299c0 34 13.4 66.6 37.4 90.6l336 336c50 50 131 50 181 0l267-267c50-50 50-131 0-181l-336-336zM96 160h299c8.4.0 16.6 3.4 22.6 9.4l336 336c12.4 12.4 12.4 32.8.0 45.2l-267 267c-12.4 12.4-32.8 12.4-45.2.0l-336-336c-6-6-9.4-14.2-9.4-22.6V160zm192 128a64 64 0 10-128 0 64 64 0 10128 0z" p-id="6660"/></svg></span><ul class=pe-post-meta-item><a href=https://www.oomkill.com/tags/kubernetes-develop/>#Kubernetes Develop</a>
<a href=https://www.oomkill.com/tags/kubernetes/>#Kubernetes</a></ul></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details><summary><span class=details>目录</span></summary><div class=inner><ul><li><a href=#scheduler aria-label=Scheduler>Scheduler</a><li><a href=#schedulingqueue aria-label=SchedulingQueue>SchedulingQueue</a><li><a href=#%e8%b0%83%e5%ba%a6%e4%b8%8a%e4%b8%8b%e6%96%87 aria-label=调度上下文>调度上下文</a><ul><li><a href=#sort aria-label=Sort>Sort</a><li><a href=#prefilter aria-label=preFilter>preFilter</a><li><a href=#filter aria-label=filter>filter</a><li><a href=#postfilter aria-label=Postfilter>Postfilter</a><li><a href=#prescorescore aria-label=PreScore,Score>PreScore,Score</a><li><a href=#reserve aria-label=Reserve>Reserve</a><li><a href=#permit aria-label=permit>permit</a><li><a href=#binding-cycle aria-label="Binding Cycle">Binding Cycle</a></ul><li><a href=#%e8%b0%83%e5%ba%a6%e4%b8%8a%e4%b8%8b%e6%96%87%e4%b8%ad%e7%9a%84%e5%a4%b1%e8%b4%a5%e6%b5%81%e7%a8%8b aria-label=调度上下文中的失败流程>调度上下文中的失败流程</a><li><a href=#%e6%80%bb%e7%bb%93%e8%b0%83%e5%ba%a6%e4%b8%8a%e4%b8%8b%e6%96%87%e6%b5%81%e7%a8%8b aria-label=总结调度上下文流程>总结调度上下文流程</a><li><a href=#reference aria-label=Reference>Reference</a></li></div></details></div></aside><script src=/js/pe-toc.min.445eb1bfc5e85dd13b9519fcc2a806522e9629b6224a2974052789ba00ab78af.js integrity="sha256-RF6xv8XoXdE7lRn8wqgGUi6WKbYiSil0BSeJugCreK8="></script><div class=post-content><h2 id=scheduler>Scheduler<a hidden class=anchor aria-hidden=true href=#scheduler>#</a></h2><p><a href=https://github.com/kubernetes/kubernetes/blob/140c27533044e9e00f800d3ad0517540e3e4ecad/pkg/scheduler/scheduler.go#L64-L102 target=_blank rel="noopener nofollow noreferrer">Scheduler</a> 是整个 <code>kube-scheduler</code> 的一个 structure，提供了 <code>kube-scheduler</code> 运行所需的组件。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Scheduler</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Cache是一个抽象，会缓存pod的信息，作为scheduler进行查找，操作是基于Pod进行增加
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>Cache</span> <span class=nx>internalcache</span><span class=p>.</span><span class=nx>Cache</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Extenders 算是调度框架中提供的调度插件，会影响kubernetes中的调度策略
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>Extenders</span> <span class=p>[]</span><span class=nx>framework</span><span class=p>.</span><span class=nx>Extender</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// NextPod 作为一个函数提供，会阻塞获取下一个ke&#39;diao&#39;du
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>NextPod</span> <span class=kd>func</span><span class=p>()</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>QueuedPodInfo</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Error is called if there is an error. It is passed the pod in
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// question, and the error
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>Error</span> <span class=kd>func</span><span class=p>(</span><span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>QueuedPodInfo</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// SchedulePod 尝试将给出的pod调度到Node。
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>SchedulePod</span> <span class=kd>func</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>fwk</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>Framework</span><span class=p>,</span> <span class=nx>state</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>CycleState</span><span class=p>,</span> <span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)</span> <span class=p>(</span><span class=nx>ScheduleResult</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 关闭scheduler的信号
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>StopEverything</span> <span class=o>&lt;-</span><span class=kd>chan</span> <span class=kd>struct</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// SchedulingQueue保存要调度的Pod
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>SchedulingQueue</span> <span class=nx>internalqueue</span><span class=p>.</span><span class=nx>SchedulingQueue</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Profiles中是多个调度框架
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>Profiles</span> <span class=nx>profile</span><span class=p>.</span><span class=nx>Map</span>
</span></span><span class=line><span class=cl>	<span class=nx>client</span> <span class=nx>clientset</span><span class=p>.</span><span class=nx>Interface</span>
</span></span><span class=line><span class=cl>	<span class=nx>nodeInfoSnapshot</span> <span class=o>*</span><span class=nx>internalcache</span><span class=p>.</span><span class=nx>Snapshot</span>
</span></span><span class=line><span class=cl>	<span class=nx>percentageOfNodesToScore</span> <span class=kt>int32</span>
</span></span><span class=line><span class=cl>	<span class=nx>nextStartNodeIndex</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>作为实际执行的两个核心，<code>SchedulingQueue</code> ，与 <code>scheduleOne</code> 将会分析到这两个</p><h2 id=schedulingqueue>SchedulingQueue<a hidden class=anchor aria-hidden=true href=#schedulingqueue>#</a></h2><p>在知道 <code>kube-scheduler</code> 初始化过程后，需要对 <code>kube-scheduler</code> 的整个 <em>structure</em> 和 <em>workflow</em> 进行分析</p><p>在 <a href=https://github.com/kubernetes/kubernetes/blob/140c27533044e9e00f800d3ad0517540e3e4ecad/pkg/scheduler/scheduler.go#L336-L340 target=_blank rel="noopener nofollow noreferrer">Run</a> 中，运行的是 一个 <code>SchedulingQueue</code> 与 一个 <code>scheduleOne</code> ，从结构上看是属于 <em>Scheduler</em></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>sched</span> <span class=o>*</span><span class=nx>Scheduler</span><span class=p>)</span> <span class=nf>Run</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>sched</span><span class=p>.</span><span class=nx>SchedulingQueue</span><span class=p>.</span><span class=nf>Run</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// We need to start scheduleOne loop in a dedicated goroutine,
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// because scheduleOne function hangs on getting the next item
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// from the SchedulingQueue.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// If there are no new pods to schedule, it will be hanging there
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// and if done in this goroutine it will be blocking closing
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// SchedulingQueue, in effect causing a deadlock on shutdown.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>go</span> <span class=nx>wait</span><span class=p>.</span><span class=nf>UntilWithContext</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>sched</span><span class=p>.</span><span class=nx>scheduleOne</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=o>&lt;-</span><span class=nx>ctx</span><span class=p>.</span><span class=nf>Done</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>sched</span><span class=p>.</span><span class=nx>SchedulingQueue</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p><a href=https://github.com/kubernetes/kubernetes/blob/140c27533044e9e00f800d3ad0517540e3e4ecad/pkg/scheduler/internal/queue/scheduling_queue.go#L81-L110 target=_blank rel="noopener nofollow noreferrer">SchedulingQueue</a> 是一个队列的抽象，用于存储等待调度的Pod。该接口遵循类似于 cache.FIFO 和 cache.Heap 的模式。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>SchedulingQueue</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>framework</span><span class=p>.</span><span class=nx>PodNominator</span>
</span></span><span class=line><span class=cl>	<span class=nf>Add</span><span class=p>(</span><span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)</span> <span class=kt>error</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Activate moves the given pods to activeQ iff they&#39;re in unschedulablePods or backoffQ.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// The passed-in pods are originally compiled from plugins that want to activate Pods,
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// by injecting the pods through a reserved CycleState struct (PodsToActivate).
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>Activate</span><span class=p>(</span><span class=nx>pods</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 将不可调度的Pod重入到队列中
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>AddUnschedulableIfNotPresent</span><span class=p>(</span><span class=nx>pod</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>QueuedPodInfo</span><span class=p>,</span> <span class=nx>podSchedulingCycle</span> <span class=kt>int64</span><span class=p>)</span> <span class=kt>error</span>
</span></span><span class=line><span class=cl>	<span class=c1>// SchedulingCycle returns the current number of scheduling cycle which is
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// cached by scheduling queue. Normally, incrementing this number whenever
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// a pod is popped (e.g. called Pop()) is enough.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>SchedulingCycle</span><span class=p>()</span> <span class=kt>int64</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Pop会弹出一个pod，并从head优先级队列中删除
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>Pop</span><span class=p>()</span> <span class=p>(</span><span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>QueuedPodInfo</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nf>Update</span><span class=p>(</span><span class=nx>oldPod</span><span class=p>,</span> <span class=nx>newPod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)</span> <span class=kt>error</span>
</span></span><span class=line><span class=cl>	<span class=nf>Delete</span><span class=p>(</span><span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)</span> <span class=kt>error</span>
</span></span><span class=line><span class=cl>	<span class=nf>MoveAllToActiveOrBackoffQueue</span><span class=p>(</span><span class=nx>event</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>ClusterEvent</span><span class=p>,</span> <span class=nx>preCheck</span> <span class=nx>PreEnqueueCheck</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nf>AssignedPodAdded</span><span class=p>(</span><span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nf>AssignedPodUpdated</span><span class=p>(</span><span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nf>PendingPods</span><span class=p>()</span> <span class=p>[]</span><span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Close closes the SchedulingQueue so that the goroutine which is
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// waiting to pop items can exit gracefully.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Run starts the goroutines managing the queue.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>Run</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>而 <a href=https://github.com/kubernetes/kubernetes/blob/140c27533044e9e00f800d3ad0517540e3e4ecad/pkg/scheduler/internal/queue/scheduling_queue.go#L134-L175 target=_blank rel="noopener nofollow noreferrer">PriorityQueue</a> 是 <code>SchedulingQueue</code> 的实现，该部分的核心构成是两个子队列与一个数据结构，即 <code>activeQ</code>、<code>backoffQ</code> 和 <code>unschedulablePods</code></p><ul><li><code>activeQ</code>：是一个 <em>heap</em> 类型的优先级队列，是 <em>sheduler</em> 从中获得优先级最高的Pod进行调度</li><li><code>backoffQ</code>：也是一个 <em>heap</em> 类型的优先级队列，存放的是不可调度的Pod</li><li><code>unschedulablePods </code>：保存确定不可被调度的Pod</li></ul><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>GO</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-GO data-lang=GO><span class=line><span class=cl><span class=kd>type</span> <span class=nx>SchedulingQueue</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>framework</span><span class=p>.</span><span class=nx>PodNominator</span>
</span></span><span class=line><span class=cl>	<span class=nf>Add</span><span class=p>(</span><span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)</span> <span class=kt>error</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Activate moves the given pods to activeQ iff they&#39;re in unschedulablePods or backoffQ.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// The passed-in pods are originally compiled from plugins that want to activate Pods,
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// by injecting the pods through a reserved CycleState struct (PodsToActivate).
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>Activate</span><span class=p>(</span><span class=nx>pods</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=c1>// AddUnschedulableIfNotPresent adds an unschedulable pod back to scheduling queue.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// The podSchedulingCycle represents the current scheduling cycle number which can be
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// returned by calling SchedulingCycle().
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>AddUnschedulableIfNotPresent</span><span class=p>(</span><span class=nx>pod</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>QueuedPodInfo</span><span class=p>,</span> <span class=nx>podSchedulingCycle</span> <span class=kt>int64</span><span class=p>)</span> <span class=kt>error</span>
</span></span><span class=line><span class=cl>	<span class=c1>// SchedulingCycle returns the current number of scheduling cycle which is
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// cached by scheduling queue. Normally, incrementing this number whenever
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// a pod is popped (e.g. called Pop()) is enough.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>SchedulingCycle</span><span class=p>()</span> <span class=kt>int64</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Pop removes the head of the queue and returns it. It blocks if the
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// queue is empty and waits until a new item is added to the queue.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>Pop</span><span class=p>()</span> <span class=p>(</span><span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>QueuedPodInfo</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nf>Update</span><span class=p>(</span><span class=nx>oldPod</span><span class=p>,</span> <span class=nx>newPod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)</span> <span class=kt>error</span>
</span></span><span class=line><span class=cl>	<span class=nf>Delete</span><span class=p>(</span><span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)</span> <span class=kt>error</span>
</span></span><span class=line><span class=cl>	<span class=nf>MoveAllToActiveOrBackoffQueue</span><span class=p>(</span><span class=nx>event</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>ClusterEvent</span><span class=p>,</span> <span class=nx>preCheck</span> <span class=nx>PreEnqueueCheck</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nf>AssignedPodAdded</span><span class=p>(</span><span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nf>AssignedPodUpdated</span><span class=p>(</span><span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nf>PendingPods</span><span class=p>()</span> <span class=p>[]</span><span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Close closes the SchedulingQueue so that the goroutine which is
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// waiting to pop items can exit gracefully.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Run starts the goroutines managing the queue.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>Run</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>在New <em>scheduler</em> 时可以看到会初始化这个queue</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>podQueue</span> <span class=o>:=</span> <span class=nx>internalqueue</span><span class=p>.</span><span class=nf>NewSchedulingQueue</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 实现pod对比的一个函数即less
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>profiles</span><span class=p>[</span><span class=nx>options</span><span class=p>.</span><span class=nx>profiles</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>SchedulerName</span><span class=p>].</span><span class=nf>QueueSortFunc</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=nx>informerFactory</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>internalqueue</span><span class=p>.</span><span class=nf>WithPodInitialBackoffDuration</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nf>Duration</span><span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>podInitialBackoffSeconds</span><span class=p>)</span><span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=nx>internalqueue</span><span class=p>.</span><span class=nf>WithPodMaxBackoffDuration</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nf>Duration</span><span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>podMaxBackoffSeconds</span><span class=p>)</span><span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=nx>internalqueue</span><span class=p>.</span><span class=nf>WithPodNominator</span><span class=p>(</span><span class=nx>nominator</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=nx>internalqueue</span><span class=p>.</span><span class=nf>WithClusterEventMap</span><span class=p>(</span><span class=nx>clusterEventMap</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=nx>internalqueue</span><span class=p>.</span><span class=nf>WithPodMaxInUnschedulablePodsDuration</span><span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>podMaxInUnschedulablePodsDuration</span><span class=p>),</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></td></tr></table></div></div></div></div><p>而 <a href=https://github.com/kubernetes/kubernetes/blob/140c27533044e9e00f800d3ad0517540e3e4ecad/pkg/scheduler/internal/queue/scheduling_queue.go#L252-L289 target=_blank rel="noopener nofollow noreferrer">NewSchedulingQueue</a> 则是初始化这个 PriorityQueue</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// NewSchedulingQueue initializes a priority queue as a new scheduling queue.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>NewSchedulingQueue</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=nx>lessFn</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>LessFunc</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>informerFactory</span> <span class=nx>informers</span><span class=p>.</span><span class=nx>SharedInformerFactory</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>opts</span> <span class=o>...</span><span class=nx>Option</span><span class=p>)</span> <span class=nx>SchedulingQueue</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nf>NewPriorityQueue</span><span class=p>(</span><span class=nx>lessFn</span><span class=p>,</span> <span class=nx>informerFactory</span><span class=p>,</span> <span class=nx>opts</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// NewPriorityQueue creates a PriorityQueue object.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>NewPriorityQueue</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=nx>lessFn</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>LessFunc</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>informerFactory</span> <span class=nx>informers</span><span class=p>.</span><span class=nx>SharedInformerFactory</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>opts</span> <span class=o>...</span><span class=nx>Option</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=o>*</span><span class=nx>PriorityQueue</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>options</span> <span class=o>:=</span> <span class=nx>defaultPriorityQueueOptions</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>opt</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>opts</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>opt</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>options</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 这个就是 less函数，作为打分的一部分
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>comp</span> <span class=o>:=</span> <span class=kd>func</span><span class=p>(</span><span class=nx>podInfo1</span><span class=p>,</span> <span class=nx>podInfo2</span> <span class=kd>interface</span><span class=p>{})</span> <span class=kt>bool</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>pInfo1</span> <span class=o>:=</span> <span class=nx>podInfo1</span><span class=p>.(</span><span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>QueuedPodInfo</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>pInfo2</span> <span class=o>:=</span> <span class=nx>podInfo2</span><span class=p>.(</span><span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>QueuedPodInfo</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nf>lessFn</span><span class=p>(</span><span class=nx>pInfo1</span><span class=p>,</span> <span class=nx>pInfo2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>options</span><span class=p>.</span><span class=nx>podNominator</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>options</span><span class=p>.</span><span class=nx>podNominator</span> <span class=p>=</span> <span class=nf>NewPodNominator</span><span class=p>(</span><span class=nx>informerFactory</span><span class=p>.</span><span class=nf>Core</span><span class=p>().</span><span class=nf>V1</span><span class=p>().</span><span class=nf>Pods</span><span class=p>().</span><span class=nf>Lister</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>pq</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>PriorityQueue</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>PodNominator</span><span class=p>:</span>                      <span class=nx>options</span><span class=p>.</span><span class=nx>podNominator</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>clock</span><span class=p>:</span>                             <span class=nx>options</span><span class=p>.</span><span class=nx>clock</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>stop</span><span class=p>:</span>                              <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kd>struct</span><span class=p>{}),</span>
</span></span><span class=line><span class=cl>		<span class=nx>podInitialBackoffDuration</span><span class=p>:</span>         <span class=nx>options</span><span class=p>.</span><span class=nx>podInitialBackoffDuration</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>podMaxBackoffDuration</span><span class=p>:</span>             <span class=nx>options</span><span class=p>.</span><span class=nx>podMaxBackoffDuration</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>podMaxInUnschedulablePodsDuration</span><span class=p>:</span> <span class=nx>options</span><span class=p>.</span><span class=nx>podMaxInUnschedulablePodsDuration</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>activeQ</span><span class=p>:</span>                           <span class=nx>heap</span><span class=p>.</span><span class=nf>NewWithRecorder</span><span class=p>(</span><span class=nx>podInfoKeyFunc</span><span class=p>,</span> <span class=nx>comp</span><span class=p>,</span> <span class=nx>metrics</span><span class=p>.</span><span class=nf>NewActivePodsRecorder</span><span class=p>()),</span>
</span></span><span class=line><span class=cl>		<span class=nx>unschedulablePods</span><span class=p>:</span>                 <span class=nf>newUnschedulablePods</span><span class=p>(</span><span class=nx>metrics</span><span class=p>.</span><span class=nf>NewUnschedulablePodsRecorder</span><span class=p>()),</span>
</span></span><span class=line><span class=cl>		<span class=nx>moveRequestCycle</span><span class=p>:</span>                  <span class=o>-</span><span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>clusterEventMap</span><span class=p>:</span>                   <span class=nx>options</span><span class=p>.</span><span class=nx>clusterEventMap</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>pq</span><span class=p>.</span><span class=nx>cond</span><span class=p>.</span><span class=nx>L</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>pq</span><span class=p>.</span><span class=nx>lock</span>
</span></span><span class=line><span class=cl>	<span class=nx>pq</span><span class=p>.</span><span class=nx>podBackoffQ</span> <span class=p>=</span> <span class=nx>heap</span><span class=p>.</span><span class=nf>NewWithRecorder</span><span class=p>(</span><span class=nx>podInfoKeyFunc</span><span class=p>,</span> <span class=nx>pq</span><span class=p>.</span><span class=nx>podsCompareBackoffCompleted</span><span class=p>,</span> <span class=nx>metrics</span><span class=p>.</span><span class=nf>NewBackoffPodsRecorder</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=nx>pq</span><span class=p>.</span><span class=nx>nsLister</span> <span class=p>=</span> <span class=nx>informerFactory</span><span class=p>.</span><span class=nf>Core</span><span class=p>().</span><span class=nf>V1</span><span class=p>().</span><span class=nf>Namespaces</span><span class=p>().</span><span class=nf>Lister</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>pq</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>了解了Queue的结构，就需要知道 入队列与出队列是在哪里操作的。在初始化时，需要注册一个 <code>addEventHandlerFuncs</code> 这个时候，会注入三个动作函数，也就是controller中的概念；而在AddFunc中可以看到会入队列。</p><p>注入是对 Pod 的<a href=https://github.com/kubernetes/kubernetes/blob/140c27533044e9e00f800d3ad0517540e3e4ecad/pkg/scheduler/eventhandlers.go#L302-L305 target=_blank rel="noopener nofollow noreferrer">informer</a>注入的，注入的函数 <a href=https://github.com/kubernetes/kubernetes/blob/140c27533044e9e00f800d3ad0517540e3e4ecad/pkg/scheduler/eventhandlers.go#L114-L120 target=_blank rel="noopener nofollow noreferrer">addPodToSchedulingQueue</a> 就是入栈</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>Handler</span><span class=p>:</span> <span class=nx>cache</span><span class=p>.</span><span class=nx>ResourceEventHandlerFuncs</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>AddFunc</span><span class=p>:</span>    <span class=nx>sched</span><span class=p>.</span><span class=nx>addPodToSchedulingQueue</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>UpdateFunc</span><span class=p>:</span> <span class=nx>sched</span><span class=p>.</span><span class=nx>updatePodInSchedulingQueue</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>DeleteFunc</span><span class=p>:</span> <span class=nx>sched</span><span class=p>.</span><span class=nx>deletePodFromSchedulingQueue</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>},</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>sched</span> <span class=o>*</span><span class=nx>Scheduler</span><span class=p>)</span> <span class=nf>addPodToSchedulingQueue</span><span class=p>(</span><span class=nx>obj</span> <span class=kd>interface</span><span class=p>{})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>pod</span> <span class=o>:=</span> <span class=nx>obj</span><span class=p>.(</span><span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>3</span><span class=p>).</span><span class=nf>InfoS</span><span class=p>(</span><span class=s>&#34;Add event for unscheduled pod&#34;</span><span class=p>,</span> <span class=s>&#34;pod&#34;</span><span class=p>,</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>KObj</span><span class=p>(</span><span class=nx>pod</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nx>SchedulingQueue</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=nx>pod</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>utilruntime</span><span class=p>.</span><span class=nf>HandleError</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;unable to queue %T: %v&#34;</span><span class=p>,</span> <span class=nx>obj</span><span class=p>,</span> <span class=nx>err</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>而这个 <code>SchedulingQueue</code> 的实现就是 <code>PriorityQueue</code> ，而Add中则对 activeQ进行的操作</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>p</span> <span class=o>*</span><span class=nx>PriorityQueue</span><span class=p>)</span> <span class=nf>Add</span><span class=p>(</span><span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>p</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>p</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 格式化入栈数据，包含podinfo，里会包含v1.Pod
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 初始化的时间，创建的时间，以及不能被调度时的记录其plugin的名称
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>pInfo</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>.</span><span class=nf>newQueuedPodInfo</span><span class=p>(</span><span class=nx>pod</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 入栈
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>.</span><span class=nx>activeQ</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=nx>pInfo</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>ErrorS</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=s>&#34;Error adding pod to the active queue&#34;</span><span class=p>,</span> <span class=s>&#34;pod&#34;</span><span class=p>,</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>KObj</span><span class=p>(</span><span class=nx>pod</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>p</span><span class=p>.</span><span class=nx>unschedulablePods</span><span class=p>.</span><span class=nf>get</span><span class=p>(</span><span class=nx>pod</span><span class=p>)</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>ErrorS</span><span class=p>(</span><span class=kc>nil</span><span class=p>,</span> <span class=s>&#34;Error: pod is already in the unschedulable queue&#34;</span><span class=p>,</span> <span class=s>&#34;pod&#34;</span><span class=p>,</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>KObj</span><span class=p>(</span><span class=nx>pod</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=nx>p</span><span class=p>.</span><span class=nx>unschedulablePods</span><span class=p>.</span><span class=nb>delete</span><span class=p>(</span><span class=nx>pod</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Delete pod from backoffQ if it is backing off
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>.</span><span class=nx>podBackoffQ</span><span class=p>.</span><span class=nf>Delete</span><span class=p>(</span><span class=nx>pInfo</span><span class=p>);</span> <span class=nx>err</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>ErrorS</span><span class=p>(</span><span class=kc>nil</span><span class=p>,</span> <span class=s>&#34;Error: pod is already in the podBackoff queue&#34;</span><span class=p>,</span> <span class=s>&#34;pod&#34;</span><span class=p>,</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>KObj</span><span class=p>(</span><span class=nx>pod</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>metrics</span><span class=p>.</span><span class=nx>SchedulerQueueIncomingPods</span><span class=p>.</span><span class=nf>WithLabelValues</span><span class=p>(</span><span class=s>&#34;active&#34;</span><span class=p>,</span> <span class=nx>PodAdd</span><span class=p>).</span><span class=nf>Inc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>p</span><span class=p>.</span><span class=nx>PodNominator</span><span class=p>.</span><span class=nf>AddNominatedPod</span><span class=p>(</span><span class=nx>pInfo</span><span class=p>.</span><span class=nx>PodInfo</span><span class=p>,</span> <span class=kc>nil</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>p</span><span class=p>.</span><span class=nx>cond</span><span class=p>.</span><span class=nf>Broadcast</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>在上面看 <em>scheduler</em> 结构时，可以看到有一个 nextPod的，nextPod就是从队列中弹出一个pod，这个在<em>scheduler</em> 时会传入 <a href=https://github.com/kubernetes/kubernetes/blob/140c27533044e9e00f800d3ad0517540e3e4ecad/pkg/scheduler/internal/queue/scheduling_queue.go#L952-L965 target=_blank rel="noopener nofollow noreferrer">MakeNextPodFunc</a> 就是这个 nextpod</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>MakeNextPodFunc</span><span class=p>(</span><span class=nx>queue</span> <span class=nx>SchedulingQueue</span><span class=p>)</span> <span class=kd>func</span><span class=p>()</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>QueuedPodInfo</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kd>func</span><span class=p>()</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>QueuedPodInfo</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>podInfo</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>queue</span><span class=p>.</span><span class=nf>Pop</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>4</span><span class=p>).</span><span class=nf>InfoS</span><span class=p>(</span><span class=s>&#34;About to try and schedule pod&#34;</span><span class=p>,</span> <span class=s>&#34;pod&#34;</span><span class=p>,</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>KObj</span><span class=p>(</span><span class=nx>podInfo</span><span class=p>.</span><span class=nx>Pod</span><span class=p>))</span>
</span></span><span class=line><span class=cl>			<span class=k>for</span> <span class=nx>plugin</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>podInfo</span><span class=p>.</span><span class=nx>UnschedulablePlugins</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>metrics</span><span class=p>.</span><span class=nf>UnschedulableReason</span><span class=p>(</span><span class=nx>plugin</span><span class=p>,</span> <span class=nx>podInfo</span><span class=p>.</span><span class=nx>Pod</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>SchedulerName</span><span class=p>).</span><span class=nf>Dec</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>podInfo</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>ErrorS</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=s>&#34;Error while retrieving next pod from scheduling queue&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>而这个 <code>queue.Pop()</code> 对应的就是 <code>PriorityQueue</code> 的 <a href=https://github.com/kubernetes/kubernetes/blob/140c27533044e9e00f800d3ad0517540e3e4ecad/pkg/scheduler/internal/queue/scheduling_queue.go#L483-L503 target=_blank rel="noopener nofollow noreferrer">Pop()</a> ，在这里会将作为 activeQ 的消费端</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>p</span> <span class=o>*</span><span class=nx>PriorityQueue</span><span class=p>)</span> <span class=nf>Pop</span><span class=p>()</span> <span class=p>(</span><span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>QueuedPodInfo</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nx>p</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>   <span class=k>defer</span> <span class=nx>p</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>   <span class=k>for</span> <span class=nx>p</span><span class=p>.</span><span class=nx>activeQ</span><span class=p>.</span><span class=nf>Len</span><span class=p>()</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// When the queue is empty, invocation of Pop() is blocked until new item is enqueued.
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// When Close() is called, the p.closed is set and the condition is broadcast,
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// which causes this loop to continue and return from the Pop().
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=nx>p</span><span class=p>.</span><span class=nx>closed</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>         <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=nx>queueClosed</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=nx>p</span><span class=p>.</span><span class=nx>cond</span><span class=p>.</span><span class=nf>Wait</span><span class=p>()</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=nx>obj</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>.</span><span class=nx>activeQ</span><span class=p>.</span><span class=nf>Pop</span><span class=p>()</span>
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=nx>pInfo</span> <span class=o>:=</span> <span class=nx>obj</span><span class=p>.(</span><span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>QueuedPodInfo</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=nx>pInfo</span><span class=p>.</span><span class=nx>Attempts</span><span class=o>++</span>
</span></span><span class=line><span class=cl>   <span class=nx>p</span><span class=p>.</span><span class=nx>schedulingCycle</span><span class=o>++</span>
</span></span><span class=line><span class=cl>   <span class=k>return</span> <span class=nx>pInfo</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>在上面入口部分也看到了，scheduleOne 和 scheduler，scheduleOne 就是去消费一个Pod，他会调用 NextPod，NextPod就是在初始化传入的 <code>MakeNextPodFunc</code> ，至此回到对应的 Pop来做消费。</p><p>schedulerOne是为一个Pod做调度的流程。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>sched</span> <span class=o>*</span><span class=nx>Scheduler</span><span class=p>)</span> <span class=nf>scheduleOne</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>podInfo</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nf>NextPod</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=c1>// pod could be nil when schedulerQueue is closed
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>podInfo</span> <span class=o>==</span> <span class=kc>nil</span> <span class=o>||</span> <span class=nx>podInfo</span><span class=p>.</span><span class=nx>Pod</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>pod</span> <span class=o>:=</span> <span class=nx>podInfo</span><span class=p>.</span><span class=nx>Pod</span>
</span></span><span class=line><span class=cl>	<span class=nx>fwk</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nf>frameworkForPod</span><span class=p>(</span><span class=nx>pod</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// This shouldn&#39;t happen, because we only accept for scheduling the pods
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// which specify a scheduler name that matches one of the profiles.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>klog</span><span class=p>.</span><span class=nf>ErrorS</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=s>&#34;Error occurred&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>sched</span><span class=p>.</span><span class=nf>skipPodSchedule</span><span class=p>(</span><span class=nx>fwk</span><span class=p>,</span> <span class=nx>pod</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=o>...</span></span></span></code></pre></td></tr></table></div></div></div></div><h2 id=调度上下文>调度上下文<a hidden class=anchor aria-hidden=true href=#调度上下文>#</a></h2><p>当了解了scheduler结构后，下面分析下调度上下文的过程。看看扩展点是怎么工作的。这个时候又需要提到官网的调度上下文的图。</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/scheduling-framework-extensions.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/scheduling-framework-extensions.png#center alt=img onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><center class=podsc>图1：Pod的调度上下文</center><center><em>Source：</em>https://kubernetes.io/docs/concepts/scheduling-eviction/scheduling-framework</center><p>而 <em>scheduler</em> 对于调度上下文来就是这个 <code>scheduleOne </code>，下面就是看这个调度上下文</p><h3 id=sort>Sort<a hidden class=anchor aria-hidden=true href=#sort>#</a></h3><p><code>Sort</code> 插件提供了排序功能，用于对在调度队列中待处理 Pod 进行排序。一次只能启用一个队列排序。</p><p>在进入 <code>scheduleOne</code> 后，<code>NextPod</code> 从 <code>activeQ</code> 中队列中得到一个Pod，然后的 <code>frameworkForPod</code> 会做打分的动作就是调度上下文的第一个扩展点 <code>sort</code></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>sched</span> <span class=o>*</span><span class=nx>Scheduler</span><span class=p>)</span> <span class=nf>scheduleOne</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>podInfo</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nf>NextPod</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=c1>// pod could be nil when schedulerQueue is closed
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>podInfo</span> <span class=o>==</span> <span class=kc>nil</span> <span class=o>||</span> <span class=nx>podInfo</span><span class=p>.</span><span class=nx>Pod</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>pod</span> <span class=o>:=</span> <span class=nx>podInfo</span><span class=p>.</span><span class=nx>Pod</span>
</span></span><span class=line><span class=cl>	<span class=nx>fwk</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nf>frameworkForPod</span><span class=p>(</span><span class=nx>pod</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>sched</span> <span class=o>*</span><span class=nx>Scheduler</span><span class=p>)</span> <span class=nf>frameworkForPod</span><span class=p>(</span><span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)</span> <span class=p>(</span><span class=nx>framework</span><span class=p>.</span><span class=nx>Framework</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 获取指定的profile
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>fwk</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nx>Profiles</span><span class=p>[</span><span class=nx>pod</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>SchedulerName</span><span class=p>]</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;profile not found for scheduler name %q&#34;</span><span class=p>,</span> <span class=nx>pod</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>SchedulerName</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>fwk</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>回顾，因为在New scheduler时会初始化这个 sort 函数</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>podQueue</span> <span class=o>:=</span> <span class=nx>internalqueue</span><span class=p>.</span><span class=nf>NewSchedulingQueue</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>profiles</span><span class=p>[</span><span class=nx>options</span><span class=p>.</span><span class=nx>profiles</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>SchedulerName</span><span class=p>].</span><span class=nf>QueueSortFunc</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=nx>informerFactory</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>internalqueue</span><span class=p>.</span><span class=nf>WithPodInitialBackoffDuration</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nf>Duration</span><span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>podInitialBackoffSeconds</span><span class=p>)</span><span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=nx>internalqueue</span><span class=p>.</span><span class=nf>WithPodMaxBackoffDuration</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nf>Duration</span><span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>podMaxBackoffSeconds</span><span class=p>)</span><span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=nx>internalqueue</span><span class=p>.</span><span class=nf>WithPodNominator</span><span class=p>(</span><span class=nx>nominator</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=nx>internalqueue</span><span class=p>.</span><span class=nf>WithClusterEventMap</span><span class=p>(</span><span class=nx>clusterEventMap</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=nx>internalqueue</span><span class=p>.</span><span class=nf>WithPodMaxInUnschedulablePodsDuration</span><span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>podMaxInUnschedulablePodsDuration</span><span class=p>),</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></td></tr></table></div></div></div></div><h3 id=prefilter>preFilter<a hidden class=anchor aria-hidden=true href=#prefilter>#</a></h3><p>preFilter作为第一个扩展点，是用于在过滤之前预处理或检查 Pod 或集群的相关信息。这里会终止调度</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>sched</span> <span class=o>*</span><span class=nx>Scheduler</span><span class=p>)</span> <span class=nf>scheduleOne</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>podInfo</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nf>NextPod</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=c1>// pod could be nil when schedulerQueue is closed
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>podInfo</span> <span class=o>==</span> <span class=kc>nil</span> <span class=o>||</span> <span class=nx>podInfo</span><span class=p>.</span><span class=nx>Pod</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>pod</span> <span class=o>:=</span> <span class=nx>podInfo</span><span class=p>.</span><span class=nx>Pod</span>
</span></span><span class=line><span class=cl>	<span class=nx>fwk</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nf>frameworkForPod</span><span class=p>(</span><span class=nx>pod</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// This shouldn&#39;t happen, because we only accept for scheduling the pods
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// which specify a scheduler name that matches one of the profiles.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>klog</span><span class=p>.</span><span class=nf>ErrorS</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=s>&#34;Error occurred&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>sched</span><span class=p>.</span><span class=nf>skipPodSchedule</span><span class=p>(</span><span class=nx>fwk</span><span class=p>,</span> <span class=nx>pod</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>3</span><span class=p>).</span><span class=nf>InfoS</span><span class=p>(</span><span class=s>&#34;Attempting to schedule pod&#34;</span><span class=p>,</span> <span class=s>&#34;pod&#34;</span><span class=p>,</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>KObj</span><span class=p>(</span><span class=nx>pod</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Synchronously attempt to find a fit for the pod.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>start</span> <span class=o>:=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>state</span> <span class=o>:=</span> <span class=nx>framework</span><span class=p>.</span><span class=nf>NewCycleState</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>state</span><span class=p>.</span><span class=nf>SetRecordPluginMetrics</span><span class=p>(</span><span class=nx>rand</span><span class=p>.</span><span class=nf>Intn</span><span class=p>(</span><span class=mi>100</span><span class=p>)</span> <span class=p>&lt;</span> <span class=nx>pluginMetricsSamplePercent</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Initialize an empty podsToActivate struct, which will be filled up by plugins or stay empty.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>podsToActivate</span> <span class=o>:=</span> <span class=nx>framework</span><span class=p>.</span><span class=nf>NewPodsToActivate</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>state</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span><span class=nx>framework</span><span class=p>.</span><span class=nx>PodsToActivateKey</span><span class=p>,</span> <span class=nx>podsToActivate</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>schedulingCycleCtx</span><span class=p>,</span> <span class=nx>cancel</span> <span class=o>:=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>WithCancel</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nf>cancel</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 这里将进入prefilter
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>scheduleResult</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nf>SchedulePod</span><span class=p>(</span><span class=nx>schedulingCycleCtx</span><span class=p>,</span> <span class=nx>fwk</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>pod</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div></div></div><p><a href=https://github.com/kubernetes/kubernetes/blob/32c483ea6ee90a3a81f382563c91034470af8a4a/pkg/scheduler/schedule_one.go#L311-L360 target=_blank rel="noopener nofollow noreferrer">schedulePod</a> 尝试将给定的 pod 调度到节点列表中的节点之一。如果成功，它将返回节点的名称。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>sched</span> <span class=o>*</span><span class=nx>Scheduler</span><span class=p>)</span> <span class=nf>schedulePod</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>fwk</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>Framework</span><span class=p>,</span> <span class=nx>state</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>CycleState</span><span class=p>,</span> <span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)</span> <span class=p>(</span><span class=nx>result</span> <span class=nx>ScheduleResult</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>trace</span> <span class=o>:=</span> <span class=nx>utiltrace</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;Scheduling&#34;</span><span class=p>,</span> <span class=nx>utiltrace</span><span class=p>.</span><span class=nx>Field</span><span class=p>{</span><span class=nx>Key</span><span class=p>:</span> <span class=s>&#34;namespace&#34;</span><span class=p>,</span> <span class=nx>Value</span><span class=p>:</span> <span class=nx>pod</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>},</span> <span class=nx>utiltrace</span><span class=p>.</span><span class=nx>Field</span><span class=p>{</span><span class=nx>Key</span><span class=p>:</span> <span class=s>&#34;name&#34;</span><span class=p>,</span> <span class=nx>Value</span><span class=p>:</span> <span class=nx>pod</span><span class=p>.</span><span class=nx>Name</span><span class=p>})</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>trace</span><span class=p>.</span><span class=nf>LogIfLong</span><span class=p>(</span><span class=mi>100</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Millisecond</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 用于将cache更新为当前内容
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nx>Cache</span><span class=p>.</span><span class=nf>UpdateSnapshot</span><span class=p>(</span><span class=nx>sched</span><span class=p>.</span><span class=nx>nodeInfoSnapshot</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>result</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>trace</span><span class=p>.</span><span class=nf>Step</span><span class=p>(</span><span class=s>&#34;Snapshotting scheduler cache and node infos done&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>sched</span><span class=p>.</span><span class=nx>nodeInfoSnapshot</span><span class=p>.</span><span class=nf>NumNodes</span><span class=p>()</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>result</span><span class=p>,</span> <span class=nx>ErrNoNodesAvailable</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 找到一个合适的pod时，会执行扩展点
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>feasibleNodes</span><span class=p>,</span> <span class=nx>diagnosis</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nf>findNodesThatFitPod</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>fwk</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>pod</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>    <span class=o>...</span></span></span></code></pre></td></tr></table></div></div></div></div><p><a href=https://github.com/kubernetes/kubernetes/blob/32c483ea6ee90a3a81f382563c91034470af8a4a/pkg/scheduler/schedule_one.go#L364-L426 target=_blank rel="noopener nofollow noreferrer">findNodesThatFitPod</a> 会执行对应的过滤插件来找到最适合的Node，包括备注，以及方法名都可以看到，这里运行的插件😁😁，后面会分析算法内容，只对workflow学习。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>sched</span> <span class=o>*</span><span class=nx>Scheduler</span><span class=p>)</span> <span class=nf>findNodesThatFitPod</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>fwk</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>Framework</span><span class=p>,</span> <span class=nx>state</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>CycleState</span><span class=p>,</span> <span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)</span> <span class=p>([]</span><span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Node</span><span class=p>,</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>Diagnosis</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>diagnosis</span> <span class=o>:=</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>Diagnosis</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>NodeToStatusMap</span><span class=p>:</span>      <span class=nb>make</span><span class=p>(</span><span class=nx>framework</span><span class=p>.</span><span class=nx>NodeToStatusMap</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>UnschedulablePlugins</span><span class=p>:</span> <span class=nx>sets</span><span class=p>.</span><span class=nf>NewString</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Run &#34;prefilter&#34; plugins.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>preRes</span><span class=p>,</span> <span class=nx>s</span> <span class=o>:=</span> <span class=nx>fwk</span><span class=p>.</span><span class=nf>RunPreFilterPlugins</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>pod</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>allNodes</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nx>nodeInfoSnapshot</span><span class=p>.</span><span class=nf>NodeInfos</span><span class=p>().</span><span class=nf>List</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>diagnosis</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>!</span><span class=nx>s</span><span class=p>.</span><span class=nf>IsSuccess</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>!</span><span class=nx>s</span><span class=p>.</span><span class=nf>IsUnschedulable</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>diagnosis</span><span class=p>,</span> <span class=nx>s</span><span class=p>.</span><span class=nf>AsError</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=c1>// All nodes will have the same status. Some non trivial refactoring is
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// needed to avoid this copy.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>n</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>allNodes</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>diagnosis</span><span class=p>.</span><span class=nx>NodeToStatusMap</span><span class=p>[</span><span class=nx>n</span><span class=p>.</span><span class=nf>Node</span><span class=p>().</span><span class=nx>Name</span><span class=p>]</span> <span class=p>=</span> <span class=nx>s</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=c1>// Status satisfying IsUnschedulable() gets injected into diagnosis.UnschedulablePlugins.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nx>s</span><span class=p>.</span><span class=nf>FailedPlugin</span><span class=p>()</span> <span class=o>!=</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>diagnosis</span><span class=p>.</span><span class=nx>UnschedulablePlugins</span><span class=p>.</span><span class=nf>Insert</span><span class=p>(</span><span class=nx>s</span><span class=p>.</span><span class=nf>FailedPlugin</span><span class=p>())</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>diagnosis</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// &#34;NominatedNodeName&#34; can potentially be set in a previous scheduling cycle as a result of preemption.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// This node is likely the only candidate that will fit the pod, and hence we try it first before iterating over all nodes.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>pod</span><span class=p>.</span><span class=nx>Status</span><span class=p>.</span><span class=nx>NominatedNodeName</span><span class=p>)</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>feasibleNodes</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nf>evaluateNominatedNode</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>pod</span><span class=p>,</span> <span class=nx>fwk</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>diagnosis</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>klog</span><span class=p>.</span><span class=nf>ErrorS</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=s>&#34;Evaluation failed on nominated node&#34;</span><span class=p>,</span> <span class=s>&#34;pod&#34;</span><span class=p>,</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>KObj</span><span class=p>(</span><span class=nx>pod</span><span class=p>),</span> <span class=s>&#34;node&#34;</span><span class=p>,</span> <span class=nx>pod</span><span class=p>.</span><span class=nx>Status</span><span class=p>.</span><span class=nx>NominatedNodeName</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=c1>// Nominated node passes all the filters, scheduler is good to assign this node to the pod.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>feasibleNodes</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>feasibleNodes</span><span class=p>,</span> <span class=nx>diagnosis</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>nodes</span> <span class=o>:=</span> <span class=nx>allNodes</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>!</span><span class=nx>preRes</span><span class=p>.</span><span class=nf>AllNodes</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>nodes</span> <span class=p>=</span> <span class=nb>make</span><span class=p>([]</span><span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>NodeInfo</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>preRes</span><span class=p>.</span><span class=nx>NodeNames</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=nx>n</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>preRes</span><span class=p>.</span><span class=nx>NodeNames</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>nInfo</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nx>nodeInfoSnapshot</span><span class=p>.</span><span class=nf>NodeInfos</span><span class=p>().</span><span class=nf>Get</span><span class=p>(</span><span class=nx>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>diagnosis</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nx>nodes</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>nodes</span><span class=p>,</span> <span class=nx>nInfo</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>feasibleNodes</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nf>findNodesThatPassFilters</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>fwk</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>pod</span><span class=p>,</span> <span class=nx>diagnosis</span><span class=p>,</span> <span class=nx>nodes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>diagnosis</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>feasibleNodes</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nf>findNodesThatPassExtenders</span><span class=p>(</span><span class=nx>sched</span><span class=p>.</span><span class=nx>Extenders</span><span class=p>,</span> <span class=nx>pod</span><span class=p>,</span> <span class=nx>feasibleNodes</span><span class=p>,</span> <span class=nx>diagnosis</span><span class=p>.</span><span class=nx>NodeToStatusMap</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>diagnosis</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>feasibleNodes</span><span class=p>,</span> <span class=nx>diagnosis</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><h3 id=filter>filter<a hidden class=anchor aria-hidden=true href=#filter>#</a></h3><p>filter插件相当于<em>调度上下文</em>中的 <code>Predicates</code>，用于排除不能运行 Pod 的节点。Filter 会按配置的顺序进行调用。如果有一个filter将节点标记位不可用，则将 Pod 标记为不可调度（即不会向下执行）。</p><p>对于代码中来讲，filter还是处于 <a href=https://github.com/kubernetes/kubernetes/blob/32c483ea6ee90a3a81f382563c91034470af8a4a/pkg/scheduler/schedule_one.go#L364-L426 target=_blank rel="noopener nofollow noreferrer">findNodesThatFitPod</a> 函数中，<code>findNodesThatPassFilters</code> 就是获取到 FN，即可行节点，而这个过程就是 <em>filter</em> 扩展点</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>sched</span> <span class=o>*</span><span class=nx>Scheduler</span><span class=p>)</span> <span class=nf>findNodesThatFitPod</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>fwk</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>Framework</span><span class=p>,</span> <span class=nx>state</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>CycleState</span><span class=p>,</span> <span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)</span> <span class=p>([]</span><span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Node</span><span class=p>,</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>Diagnosis</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=o>...</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>	<span class=nx>feasibleNodes</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nf>findNodesThatPassFilters</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>fwk</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>pod</span><span class=p>,</span> <span class=nx>diagnosis</span><span class=p>,</span> <span class=nx>nodes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>diagnosis</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>feasibleNodes</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nf>findNodesThatPassExtenders</span><span class=p>(</span><span class=nx>sched</span><span class=p>.</span><span class=nx>Extenders</span><span class=p>,</span> <span class=nx>pod</span><span class=p>,</span> <span class=nx>feasibleNodes</span><span class=p>,</span> <span class=nx>diagnosis</span><span class=p>.</span><span class=nx>NodeToStatusMap</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>diagnosis</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>feasibleNodes</span><span class=p>,</span> <span class=nx>diagnosis</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><h3 id=postfilter>Postfilter<a hidden class=anchor aria-hidden=true href=#postfilter>#</a></h3><p>当没有为 pod 找到<em>FN</em>时，该插件会按照配置的顺序进行调用。如果任何<code>postFilter</code>插件将 Pod 标记为<em>schedulable</em>，则不会调用其余插件。即 <code>filter</code> 成功后不会进行这步骤，那我们来验证下这里把😊</p><p>还是在 scheduleOne 中，当我们运行的 SchedulePod 完成后（成功或失败），这时会返回一个err，而 <code>postfilter</code> 会根据这个 err进行选择执行或不执行，符合官方给出的说法。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>scheduleResult</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nf>SchedulePod</span><span class=p>(</span><span class=nx>schedulingCycleCtx</span><span class=p>,</span> <span class=nx>fwk</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>pod</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// SchedulePod() may have failed because the pod would not fit on any host, so we try to
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// preempt, with the expectation that the next time the pod is tried for scheduling it
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// will fit due to the preemption. It is also possible that a different pod will schedule
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// into the resources that were preempted, but this is harmless.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=kd>var</span> <span class=nx>nominatingInfo</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>NominatingInfo</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>fitError</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>err</span><span class=p>.(</span><span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>FitError</span><span class=p>);</span> <span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>!</span><span class=nx>fwk</span><span class=p>.</span><span class=nf>HasPostFilterPlugins</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>3</span><span class=p>).</span><span class=nf>InfoS</span><span class=p>(</span><span class=s>&#34;No PostFilter plugins are registered, so no preemption will be performed&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=c1>// Run PostFilter plugins to try to make the pod schedulable in a future scheduling cycle.
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=nx>result</span><span class=p>,</span> <span class=nx>status</span> <span class=o>:=</span> <span class=nx>fwk</span><span class=p>.</span><span class=nf>RunPostFilterPlugins</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>pod</span><span class=p>,</span> <span class=nx>fitError</span><span class=p>.</span><span class=nx>Diagnosis</span><span class=p>.</span><span class=nx>NodeToStatusMap</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nx>status</span><span class=p>.</span><span class=nf>Code</span><span class=p>()</span> <span class=o>==</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>Error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>klog</span><span class=p>.</span><span class=nf>ErrorS</span><span class=p>(</span><span class=kc>nil</span><span class=p>,</span> <span class=s>&#34;Status after running PostFilter plugins for pod&#34;</span><span class=p>,</span> <span class=s>&#34;pod&#34;</span><span class=p>,</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>KObj</span><span class=p>(</span><span class=nx>pod</span><span class=p>),</span> <span class=s>&#34;status&#34;</span><span class=p>,</span> <span class=nx>status</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>fitError</span><span class=p>.</span><span class=nx>Diagnosis</span><span class=p>.</span><span class=nx>PostFilterMsg</span> <span class=p>=</span> <span class=nx>status</span><span class=p>.</span><span class=nf>Message</span><span class=p>()</span>
</span></span><span class=line><span class=cl>					<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>5</span><span class=p>).</span><span class=nf>InfoS</span><span class=p>(</span><span class=s>&#34;Status after running PostFilter plugins for pod&#34;</span><span class=p>,</span> <span class=s>&#34;pod&#34;</span><span class=p>,</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>KObj</span><span class=p>(</span><span class=nx>pod</span><span class=p>),</span> <span class=s>&#34;status&#34;</span><span class=p>,</span> <span class=nx>status</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nx>result</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>nominatingInfo</span> <span class=p>=</span> <span class=nx>result</span><span class=p>.</span><span class=nx>NominatingInfo</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=c1>// Pod did not fit anywhere, so it is counted as a failure. If preemption
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// succeeds, the pod should get counted as a success the next time we try to
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// schedule it. (hopefully)
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>metrics</span><span class=p>.</span><span class=nf>PodUnschedulable</span><span class=p>(</span><span class=nx>fwk</span><span class=p>.</span><span class=nf>ProfileName</span><span class=p>(),</span> <span class=nx>metrics</span><span class=p>.</span><span class=nf>SinceInSeconds</span><span class=p>(</span><span class=nx>start</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=nx>err</span> <span class=o>==</span> <span class=nx>ErrNoNodesAvailable</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>nominatingInfo</span> <span class=p>=</span> <span class=nx>clearNominatedNode</span>
</span></span><span class=line><span class=cl>			<span class=c1>// No nodes available is counted as unschedulable rather than an error.
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>metrics</span><span class=p>.</span><span class=nf>PodUnschedulable</span><span class=p>(</span><span class=nx>fwk</span><span class=p>.</span><span class=nf>ProfileName</span><span class=p>(),</span> <span class=nx>metrics</span><span class=p>.</span><span class=nf>SinceInSeconds</span><span class=p>(</span><span class=nx>start</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>nominatingInfo</span> <span class=p>=</span> <span class=nx>clearNominatedNode</span>
</span></span><span class=line><span class=cl>			<span class=nx>klog</span><span class=p>.</span><span class=nf>ErrorS</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=s>&#34;Error selecting node for pod&#34;</span><span class=p>,</span> <span class=s>&#34;pod&#34;</span><span class=p>,</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>KObj</span><span class=p>(</span><span class=nx>pod</span><span class=p>))</span>
</span></span><span class=line><span class=cl>			<span class=nx>metrics</span><span class=p>.</span><span class=nf>PodScheduleError</span><span class=p>(</span><span class=nx>fwk</span><span class=p>.</span><span class=nf>ProfileName</span><span class=p>(),</span> <span class=nx>metrics</span><span class=p>.</span><span class=nf>SinceInSeconds</span><span class=p>(</span><span class=nx>start</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>sched</span><span class=p>.</span><span class=nf>handleSchedulingFailure</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>fwk</span><span class=p>,</span> <span class=nx>podInfo</span><span class=p>,</span> <span class=nx>err</span><span class=p>,</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>PodReasonUnschedulable</span><span class=p>,</span> <span class=nx>nominatingInfo</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><h3 id=prescorescore>PreScore,Score<a hidden class=anchor aria-hidden=true href=#prescorescore>#</a></h3><p>可用于进行预Score工作，作为通知性的扩展点，会在在filter完之后直接会关联 preScore 插件进行继续工作，而不是返回，如果配置的这些插件有任何一个返回失败，则Pod将被拒绝。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>sched</span> <span class=o>*</span><span class=nx>Scheduler</span><span class=p>)</span> <span class=nf>schedulePod</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>fwk</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>Framework</span><span class=p>,</span> <span class=nx>state</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>CycleState</span><span class=p>,</span> <span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)</span> <span class=p>(</span><span class=nx>result</span> <span class=nx>ScheduleResult</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>trace</span> <span class=o>:=</span> <span class=nx>utiltrace</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;Scheduling&#34;</span><span class=p>,</span> <span class=nx>utiltrace</span><span class=p>.</span><span class=nx>Field</span><span class=p>{</span><span class=nx>Key</span><span class=p>:</span> <span class=s>&#34;namespace&#34;</span><span class=p>,</span> <span class=nx>Value</span><span class=p>:</span> <span class=nx>pod</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>},</span> <span class=nx>utiltrace</span><span class=p>.</span><span class=nx>Field</span><span class=p>{</span><span class=nx>Key</span><span class=p>:</span> <span class=s>&#34;name&#34;</span><span class=p>,</span> <span class=nx>Value</span><span class=p>:</span> <span class=nx>pod</span><span class=p>.</span><span class=nx>Name</span><span class=p>})</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>trace</span><span class=p>.</span><span class=nf>LogIfLong</span><span class=p>(</span><span class=mi>100</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Millisecond</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nx>Cache</span><span class=p>.</span><span class=nf>UpdateSnapshot</span><span class=p>(</span><span class=nx>sched</span><span class=p>.</span><span class=nx>nodeInfoSnapshot</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>result</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>trace</span><span class=p>.</span><span class=nf>Step</span><span class=p>(</span><span class=s>&#34;Snapshotting scheduler cache and node infos done&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>sched</span><span class=p>.</span><span class=nx>nodeInfoSnapshot</span><span class=p>.</span><span class=nf>NumNodes</span><span class=p>()</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>result</span><span class=p>,</span> <span class=nx>ErrNoNodesAvailable</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>feasibleNodes</span><span class=p>,</span> <span class=nx>diagnosis</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nf>findNodesThatFitPod</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>fwk</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>pod</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>result</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>trace</span><span class=p>.</span><span class=nf>Step</span><span class=p>(</span><span class=s>&#34;Computing predicates done&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>feasibleNodes</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>result</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>framework</span><span class=p>.</span><span class=nx>FitError</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>Pod</span><span class=p>:</span>         <span class=nx>pod</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>NumAllNodes</span><span class=p>:</span> <span class=nx>sched</span><span class=p>.</span><span class=nx>nodeInfoSnapshot</span><span class=p>.</span><span class=nf>NumNodes</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>			<span class=nx>Diagnosis</span><span class=p>:</span>   <span class=nx>diagnosis</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// When only one node after predicate, just use it.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>feasibleNodes</span><span class=p>)</span> <span class=o>==</span> <span class=mi>1</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>ScheduleResult</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>SuggestedHost</span><span class=p>:</span>  <span class=nx>feasibleNodes</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>Name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>EvaluatedNodes</span><span class=p>:</span> <span class=mi>1</span> <span class=o>+</span> <span class=nb>len</span><span class=p>(</span><span class=nx>diagnosis</span><span class=p>.</span><span class=nx>NodeToStatusMap</span><span class=p>),</span>
</span></span><span class=line><span class=cl>			<span class=nx>FeasibleNodes</span><span class=p>:</span>  <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 这里会完成prescore，score
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>priorityList</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>prioritizeNodes</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>sched</span><span class=p>.</span><span class=nx>Extenders</span><span class=p>,</span> <span class=nx>fwk</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>pod</span><span class=p>,</span> <span class=nx>feasibleNodes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>result</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>host</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>selectHost</span><span class=p>(</span><span class=nx>priorityList</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>trace</span><span class=p>.</span><span class=nf>Step</span><span class=p>(</span><span class=s>&#34;Prioritizing done&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>ScheduleResult</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>SuggestedHost</span><span class=p>:</span>  <span class=nx>host</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>EvaluatedNodes</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=nx>feasibleNodes</span><span class=p>)</span> <span class=o>+</span> <span class=nb>len</span><span class=p>(</span><span class=nx>diagnosis</span><span class=p>.</span><span class=nx>NodeToStatusMap</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>FeasibleNodes</span><span class=p>:</span>  <span class=nb>len</span><span class=p>(</span><span class=nx>feasibleNodes</span><span class=p>),</span>
</span></span><span class=line><span class=cl>	<span class=p>},</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p><a href=https://github.com/kubernetes/kubernetes/blob/32c483ea6ee90a3a81f382563c91034470af8a4a/pkg/scheduler/schedule_one.go#L605-L705 target=_blank rel="noopener nofollow noreferrer">priorityNodes</a> 会通过配置的插件给Node打分，并返回每个Node的分数，将每个插件打分结果计算总和获得Node的分数，最后获得节点的加权总分数。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>prioritizeNodes</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>extenders</span> <span class=p>[]</span><span class=nx>framework</span><span class=p>.</span><span class=nx>Extender</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>fwk</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>Framework</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>state</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>CycleState</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>nodes</span> <span class=p>[]</span><span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Node</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>(</span><span class=nx>framework</span><span class=p>.</span><span class=nx>NodeScoreList</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// If no priority configs are provided, then all nodes will have a score of one.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// This is required to generate the priority list in the required format
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>extenders</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=p>!</span><span class=nx>fwk</span><span class=p>.</span><span class=nf>HasScorePlugins</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>result</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=nx>framework</span><span class=p>.</span><span class=nx>NodeScoreList</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>nodes</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>nodes</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>result</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>result</span><span class=p>,</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>NodeScore</span><span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>Name</span><span class=p>:</span>  <span class=nx>nodes</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>Name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=nx>Score</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=p>})</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>result</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Run PreScore plugins.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>preScoreStatus</span> <span class=o>:=</span> <span class=nx>fwk</span><span class=p>.</span><span class=nf>RunPreScorePlugins</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>pod</span><span class=p>,</span> <span class=nx>nodes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>!</span><span class=nx>preScoreStatus</span><span class=p>.</span><span class=nf>IsSuccess</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>preScoreStatus</span><span class=p>.</span><span class=nf>AsError</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Run the Score plugins.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>scoresMap</span><span class=p>,</span> <span class=nx>scoreStatus</span> <span class=o>:=</span> <span class=nx>fwk</span><span class=p>.</span><span class=nf>RunScorePlugins</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>pod</span><span class=p>,</span> <span class=nx>nodes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>!</span><span class=nx>scoreStatus</span><span class=p>.</span><span class=nf>IsSuccess</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>scoreStatus</span><span class=p>.</span><span class=nf>AsError</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Additional details logged at level 10 if enabled.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>klogV</span> <span class=o>:=</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>klogV</span><span class=p>.</span><span class=nf>Enabled</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=nx>plugin</span><span class=p>,</span> <span class=nx>nodeScoreList</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>scoresMap</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>nodeScore</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>nodeScoreList</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>klogV</span><span class=p>.</span><span class=nf>InfoS</span><span class=p>(</span><span class=s>&#34;Plugin scored node for pod&#34;</span><span class=p>,</span> <span class=s>&#34;pod&#34;</span><span class=p>,</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>KObj</span><span class=p>(</span><span class=nx>pod</span><span class=p>),</span> <span class=s>&#34;plugin&#34;</span><span class=p>,</span> <span class=nx>plugin</span><span class=p>,</span> <span class=s>&#34;node&#34;</span><span class=p>,</span> <span class=nx>nodeScore</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=s>&#34;score&#34;</span><span class=p>,</span> <span class=nx>nodeScore</span><span class=p>.</span><span class=nx>Score</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Summarize all scores.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>result</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=nx>framework</span><span class=p>.</span><span class=nx>NodeScoreList</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>nodes</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>nodes</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>result</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>result</span><span class=p>,</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>NodeScore</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=nx>nodes</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>Name</span><span class=p>,</span> <span class=nx>Score</span><span class=p>:</span> <span class=mi>0</span><span class=p>})</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=nx>j</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>scoresMap</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>result</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>Score</span> <span class=o>+=</span> <span class=nx>scoresMap</span><span class=p>[</span><span class=nx>j</span><span class=p>][</span><span class=nx>i</span><span class=p>].</span><span class=nx>Score</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>extenders</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=nx>nodes</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=kd>var</span> <span class=nx>mu</span> <span class=nx>sync</span><span class=p>.</span><span class=nx>Mutex</span>
</span></span><span class=line><span class=cl>		<span class=kd>var</span> <span class=nx>wg</span> <span class=nx>sync</span><span class=p>.</span><span class=nx>WaitGroup</span>
</span></span><span class=line><span class=cl>		<span class=nx>combinedScores</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>int64</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>nodes</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>extenders</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>!</span><span class=nx>extenders</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nf>IsInterested</span><span class=p>(</span><span class=nx>pod</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>continue</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nx>wg</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>go</span> <span class=kd>func</span><span class=p>(</span><span class=nx>extIndex</span> <span class=kt>int</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>metrics</span><span class=p>.</span><span class=nx>SchedulerGoroutines</span><span class=p>.</span><span class=nf>WithLabelValues</span><span class=p>(</span><span class=nx>metrics</span><span class=p>.</span><span class=nx>PrioritizingExtender</span><span class=p>).</span><span class=nf>Inc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>				<span class=k>defer</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>metrics</span><span class=p>.</span><span class=nx>SchedulerGoroutines</span><span class=p>.</span><span class=nf>WithLabelValues</span><span class=p>(</span><span class=nx>metrics</span><span class=p>.</span><span class=nx>PrioritizingExtender</span><span class=p>).</span><span class=nf>Dec</span><span class=p>()</span>
</span></span><span class=line><span class=cl>					<span class=nx>wg</span><span class=p>.</span><span class=nf>Done</span><span class=p>()</span>
</span></span><span class=line><span class=cl>				<span class=p>}()</span>
</span></span><span class=line><span class=cl>				<span class=nx>prioritizedList</span><span class=p>,</span> <span class=nx>weight</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>extenders</span><span class=p>[</span><span class=nx>extIndex</span><span class=p>].</span><span class=nf>Prioritize</span><span class=p>(</span><span class=nx>pod</span><span class=p>,</span> <span class=nx>nodes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=c1>// Prioritization errors from extender can be ignored, let k8s/other extenders determine the priorities
</span></span></span><span class=line><span class=cl><span class=c1></span>					<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>5</span><span class=p>).</span><span class=nf>InfoS</span><span class=p>(</span><span class=s>&#34;Failed to run extender&#39;s priority function. No score given by this extender.&#34;</span><span class=p>,</span> <span class=s>&#34;error&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>,</span> <span class=s>&#34;pod&#34;</span><span class=p>,</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>KObj</span><span class=p>(</span><span class=nx>pod</span><span class=p>),</span> <span class=s>&#34;extender&#34;</span><span class=p>,</span> <span class=nx>extenders</span><span class=p>[</span><span class=nx>extIndex</span><span class=p>].</span><span class=nf>Name</span><span class=p>())</span>
</span></span><span class=line><span class=cl>					<span class=k>return</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>				<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=k>range</span> <span class=o>*</span><span class=nx>prioritizedList</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>host</span><span class=p>,</span> <span class=nx>score</span> <span class=o>:=</span> <span class=p>(</span><span class=o>*</span><span class=nx>prioritizedList</span><span class=p>)[</span><span class=nx>i</span><span class=p>].</span><span class=nx>Host</span><span class=p>,</span> <span class=p>(</span><span class=o>*</span><span class=nx>prioritizedList</span><span class=p>)[</span><span class=nx>i</span><span class=p>].</span><span class=nx>Score</span>
</span></span><span class=line><span class=cl>					<span class=k>if</span> <span class=nx>klogV</span><span class=p>.</span><span class=nf>Enabled</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=nx>klogV</span><span class=p>.</span><span class=nf>InfoS</span><span class=p>(</span><span class=s>&#34;Extender scored node for pod&#34;</span><span class=p>,</span> <span class=s>&#34;pod&#34;</span><span class=p>,</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>KObj</span><span class=p>(</span><span class=nx>pod</span><span class=p>),</span> <span class=s>&#34;extender&#34;</span><span class=p>,</span> <span class=nx>extenders</span><span class=p>[</span><span class=nx>extIndex</span><span class=p>].</span><span class=nf>Name</span><span class=p>(),</span> <span class=s>&#34;node&#34;</span><span class=p>,</span> <span class=nx>host</span><span class=p>,</span> <span class=s>&#34;score&#34;</span><span class=p>,</span> <span class=nx>score</span><span class=p>)</span>
</span></span><span class=line><span class=cl>					<span class=p>}</span>
</span></span><span class=line><span class=cl>					<span class=nx>combinedScores</span><span class=p>[</span><span class=nx>host</span><span class=p>]</span> <span class=o>+=</span> <span class=nx>score</span> <span class=o>*</span> <span class=nx>weight</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=p>}(</span><span class=nx>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=c1>// wait for all go routines to finish
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>wg</span><span class=p>.</span><span class=nf>Wait</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>result</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// MaxExtenderPriority may diverge from the max priority used in the scheduler and defined by MaxNodeScore,
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// therefore we need to scale the score returned by extenders to the score range used by the scheduler.
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>result</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>Score</span> <span class=o>+=</span> <span class=nx>combinedScores</span><span class=p>[</span><span class=nx>result</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>Name</span><span class=p>]</span> <span class=o>*</span> <span class=p>(</span><span class=nx>framework</span><span class=p>.</span><span class=nx>MaxNodeScore</span> <span class=o>/</span> <span class=nx>extenderv1</span><span class=p>.</span><span class=nx>MaxExtenderPriority</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>klogV</span><span class=p>.</span><span class=nf>Enabled</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>result</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>klogV</span><span class=p>.</span><span class=nf>InfoS</span><span class=p>(</span><span class=s>&#34;Calculated node&#39;s final score for pod&#34;</span><span class=p>,</span> <span class=s>&#34;pod&#34;</span><span class=p>,</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>KObj</span><span class=p>(</span><span class=nx>pod</span><span class=p>),</span> <span class=s>&#34;node&#34;</span><span class=p>,</span> <span class=nx>result</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>Name</span><span class=p>,</span> <span class=s>&#34;score&#34;</span><span class=p>,</span> <span class=nx>result</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>Score</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>result</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><h3 id=reserve>Reserve<a hidden class=anchor aria-hidden=true href=#reserve>#</a></h3><p><a href=https://github.com/kubernetes/kubernetes/blob/32c483ea6ee90a3a81f382563c91034470af8a4a/pkg/scheduler/schedule_one.go#L153-L163 target=_blank rel="noopener nofollow noreferrer">Reserve</a> 因为绑定事件时异步发生的，该插件是为了避免Pod在绑定到节点前时，调度到新的Pod，使节点使用资源超过可用资源情况。如果后续阶段发生错误或失败，将触发 <code>UnReserve</code> 回滚（通知性扩展点）。这也是作为调度周期中最后一个状态，要么成功到 <code>postBind</code> ，要么失败触发 <code>UnReserve</code>。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// Run the Reserve method of reserve plugins.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>if</span> <span class=nx>sts</span> <span class=o>:=</span> <span class=nx>fwk</span><span class=p>.</span><span class=nf>RunReservePluginsReserve</span><span class=p>(</span><span class=nx>schedulingCycleCtx</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>assumedPod</span><span class=p>,</span> <span class=nx>scheduleResult</span><span class=p>.</span><span class=nx>SuggestedHost</span><span class=p>);</span> <span class=p>!</span><span class=nx>sts</span><span class=p>.</span><span class=nf>IsSuccess</span><span class=p>()</span> <span class=p>{</span> <span class=c1>// 当处理不成功时
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>metrics</span><span class=p>.</span><span class=nf>PodScheduleError</span><span class=p>(</span><span class=nx>fwk</span><span class=p>.</span><span class=nf>ProfileName</span><span class=p>(),</span> <span class=nx>metrics</span><span class=p>.</span><span class=nf>SinceInSeconds</span><span class=p>(</span><span class=nx>start</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 触发 un-reserve 来清理相关Pod的状态
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>fwk</span><span class=p>.</span><span class=nf>RunReservePluginsUnreserve</span><span class=p>(</span><span class=nx>schedulingCycleCtx</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>assumedPod</span><span class=p>,</span> <span class=nx>scheduleResult</span><span class=p>.</span><span class=nx>SuggestedHost</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>forgetErr</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nx>Cache</span><span class=p>.</span><span class=nf>ForgetPod</span><span class=p>(</span><span class=nx>assumedPod</span><span class=p>);</span> <span class=nx>forgetErr</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>klog</span><span class=p>.</span><span class=nf>ErrorS</span><span class=p>(</span><span class=nx>forgetErr</span><span class=p>,</span> <span class=s>&#34;Scheduler cache ForgetPod failed&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>sched</span><span class=p>.</span><span class=nf>handleSchedulingFailure</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>fwk</span><span class=p>,</span> <span class=nx>assumedPodInfo</span><span class=p>,</span> <span class=nx>sts</span><span class=p>.</span><span class=nf>AsError</span><span class=p>(),</span> <span class=nx>SchedulerError</span><span class=p>,</span> <span class=nx>clearNominatedNode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><h3 id=permit>permit<a hidden class=anchor aria-hidden=true href=#permit>#</a></h3><p><a href=https://github.com/kubernetes/kubernetes/blob/32c483ea6ee90a3a81f382563c91034470af8a4a/pkg/scheduler/schedule_one.go#L165-L183 target=_blank rel="noopener nofollow noreferrer">Permit</a> 插件可以阻止或延迟 Pod 的绑定</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl>	<span class=c1>// Run &#34;permit&#34; plugins.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>runPermitStatus</span> <span class=o>:=</span> <span class=nx>fwk</span><span class=p>.</span><span class=nf>RunPermitPlugins</span><span class=p>(</span><span class=nx>schedulingCycleCtx</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>assumedPod</span><span class=p>,</span> <span class=nx>scheduleResult</span><span class=p>.</span><span class=nx>SuggestedHost</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>!</span><span class=nx>runPermitStatus</span><span class=p>.</span><span class=nf>IsWait</span><span class=p>()</span> <span class=o>&amp;&amp;</span> <span class=p>!</span><span class=nx>runPermitStatus</span><span class=p>.</span><span class=nf>IsSuccess</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=kd>var</span> <span class=nx>reason</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>runPermitStatus</span><span class=p>.</span><span class=nf>IsUnschedulable</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>metrics</span><span class=p>.</span><span class=nf>PodUnschedulable</span><span class=p>(</span><span class=nx>fwk</span><span class=p>.</span><span class=nf>ProfileName</span><span class=p>(),</span> <span class=nx>metrics</span><span class=p>.</span><span class=nf>SinceInSeconds</span><span class=p>(</span><span class=nx>start</span><span class=p>))</span>
</span></span><span class=line><span class=cl>			<span class=nx>reason</span> <span class=p>=</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>PodReasonUnschedulable</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>metrics</span><span class=p>.</span><span class=nf>PodScheduleError</span><span class=p>(</span><span class=nx>fwk</span><span class=p>.</span><span class=nf>ProfileName</span><span class=p>(),</span> <span class=nx>metrics</span><span class=p>.</span><span class=nf>SinceInSeconds</span><span class=p>(</span><span class=nx>start</span><span class=p>))</span>
</span></span><span class=line><span class=cl>			<span class=nx>reason</span> <span class=p>=</span> <span class=nx>SchedulerError</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 只要其中一个插件返回的状态不是 success 或者 wait
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>fwk</span><span class=p>.</span><span class=nf>RunReservePluginsUnreserve</span><span class=p>(</span><span class=nx>schedulingCycleCtx</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>assumedPod</span><span class=p>,</span> <span class=nx>scheduleResult</span><span class=p>.</span><span class=nx>SuggestedHost</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 从cache中忘掉pod
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nx>forgetErr</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nx>Cache</span><span class=p>.</span><span class=nf>ForgetPod</span><span class=p>(</span><span class=nx>assumedPod</span><span class=p>);</span> <span class=nx>forgetErr</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>klog</span><span class=p>.</span><span class=nf>ErrorS</span><span class=p>(</span><span class=nx>forgetErr</span><span class=p>,</span> <span class=s>&#34;Scheduler cache ForgetPod failed&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>sched</span><span class=p>.</span><span class=nf>handleSchedulingFailure</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>fwk</span><span class=p>,</span> <span class=nx>assumedPodInfo</span><span class=p>,</span> <span class=nx>runPermitStatus</span><span class=p>.</span><span class=nf>AsError</span><span class=p>(),</span> <span class=nx>reason</span><span class=p>,</span> <span class=nx>clearNominatedNode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><h3 id=binding-cycle>Binding Cycle<a hidden class=anchor aria-hidden=true href=#binding-cycle>#</a></h3><p>在选择好 <em>FN</em> 后则做一个假设绑定，并更新到cache中，接下来回去执行真正的bind操作，也就是 <code>binding cycle</code></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>sched</span> <span class=o>*</span><span class=nx>Scheduler</span><span class=p>)</span> <span class=nf>scheduleOne</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>	<span class=c1>// binding cycle 是一个异步的操作，这里表现就是go协程
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>bindingCycleCtx</span><span class=p>,</span> <span class=nx>cancel</span> <span class=o>:=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>WithCancel</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>defer</span> <span class=nf>cancel</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=nx>metrics</span><span class=p>.</span><span class=nx>SchedulerGoroutines</span><span class=p>.</span><span class=nf>WithLabelValues</span><span class=p>(</span><span class=nx>metrics</span><span class=p>.</span><span class=nx>Binding</span><span class=p>).</span><span class=nf>Inc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>defer</span> <span class=nx>metrics</span><span class=p>.</span><span class=nx>SchedulerGoroutines</span><span class=p>.</span><span class=nf>WithLabelValues</span><span class=p>(</span><span class=nx>metrics</span><span class=p>.</span><span class=nx>Binding</span><span class=p>).</span><span class=nf>Dec</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 运行WaitOnPermit插件，如果失败则，unReserve回滚
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>waitOnPermitStatus</span> <span class=o>:=</span> <span class=nx>fwk</span><span class=p>.</span><span class=nf>WaitOnPermit</span><span class=p>(</span><span class=nx>bindingCycleCtx</span><span class=p>,</span> <span class=nx>assumedPod</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>!</span><span class=nx>waitOnPermitStatus</span><span class=p>.</span><span class=nf>IsSuccess</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=kd>var</span> <span class=nx>reason</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>waitOnPermitStatus</span><span class=p>.</span><span class=nf>IsUnschedulable</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>metrics</span><span class=p>.</span><span class=nf>PodUnschedulable</span><span class=p>(</span><span class=nx>fwk</span><span class=p>.</span><span class=nf>ProfileName</span><span class=p>(),</span> <span class=nx>metrics</span><span class=p>.</span><span class=nf>SinceInSeconds</span><span class=p>(</span><span class=nx>start</span><span class=p>))</span>
</span></span><span class=line><span class=cl>				<span class=nx>reason</span> <span class=p>=</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>PodReasonUnschedulable</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>metrics</span><span class=p>.</span><span class=nf>PodScheduleError</span><span class=p>(</span><span class=nx>fwk</span><span class=p>.</span><span class=nf>ProfileName</span><span class=p>(),</span> <span class=nx>metrics</span><span class=p>.</span><span class=nf>SinceInSeconds</span><span class=p>(</span><span class=nx>start</span><span class=p>))</span>
</span></span><span class=line><span class=cl>				<span class=nx>reason</span> <span class=p>=</span> <span class=nx>SchedulerError</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=c1>// trigger un-reserve plugins to clean up state associated with the reserved Pod
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>fwk</span><span class=p>.</span><span class=nf>RunReservePluginsUnreserve</span><span class=p>(</span><span class=nx>bindingCycleCtx</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>assumedPod</span><span class=p>,</span> <span class=nx>scheduleResult</span><span class=p>.</span><span class=nx>SuggestedHost</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>forgetErr</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nx>Cache</span><span class=p>.</span><span class=nf>ForgetPod</span><span class=p>(</span><span class=nx>assumedPod</span><span class=p>);</span> <span class=nx>forgetErr</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>klog</span><span class=p>.</span><span class=nf>ErrorS</span><span class=p>(</span><span class=nx>forgetErr</span><span class=p>,</span> <span class=s>&#34;scheduler cache ForgetPod failed&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=c1>// &#34;Forget&#34;ing an assumed Pod in binding cycle should be treated as a PodDelete event,
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// as the assumed Pod had occupied a certain amount of resources in scheduler cache.
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// TODO(#103853): de-duplicate the logic.
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// Avoid moving the assumed Pod itself as it&#39;s always Unschedulable.
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// It&#39;s intentional to &#34;defer&#34; this operation; otherwise MoveAllToActiveOrBackoffQueue() would
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// update `q.moveRequest` and thus move the assumed pod to backoffQ anyways.
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=k>defer</span> <span class=nx>sched</span><span class=p>.</span><span class=nx>SchedulingQueue</span><span class=p>.</span><span class=nf>MoveAllToActiveOrBackoffQueue</span><span class=p>(</span><span class=nx>internalqueue</span><span class=p>.</span><span class=nx>AssignedPodDelete</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)</span> <span class=kt>bool</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=k>return</span> <span class=nx>assumedPod</span><span class=p>.</span><span class=nx>UID</span> <span class=o>!=</span> <span class=nx>pod</span><span class=p>.</span><span class=nx>UID</span>
</span></span><span class=line><span class=cl>				<span class=p>})</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nx>sched</span><span class=p>.</span><span class=nf>handleSchedulingFailure</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>fwk</span><span class=p>,</span> <span class=nx>assumedPodInfo</span><span class=p>,</span> <span class=nx>waitOnPermitStatus</span><span class=p>.</span><span class=nf>AsError</span><span class=p>(),</span> <span class=nx>reason</span><span class=p>,</span> <span class=nx>clearNominatedNode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 运行Prebind 插件
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>preBindStatus</span> <span class=o>:=</span> <span class=nx>fwk</span><span class=p>.</span><span class=nf>RunPreBindPlugins</span><span class=p>(</span><span class=nx>bindingCycleCtx</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>assumedPod</span><span class=p>,</span> <span class=nx>scheduleResult</span><span class=p>.</span><span class=nx>SuggestedHost</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>!</span><span class=nx>preBindStatus</span><span class=p>.</span><span class=nf>IsSuccess</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>metrics</span><span class=p>.</span><span class=nf>PodScheduleError</span><span class=p>(</span><span class=nx>fwk</span><span class=p>.</span><span class=nf>ProfileName</span><span class=p>(),</span> <span class=nx>metrics</span><span class=p>.</span><span class=nf>SinceInSeconds</span><span class=p>(</span><span class=nx>start</span><span class=p>))</span>
</span></span><span class=line><span class=cl>			<span class=c1>// trigger un-reserve plugins to clean up state associated with the reserved Pod
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>fwk</span><span class=p>.</span><span class=nf>RunReservePluginsUnreserve</span><span class=p>(</span><span class=nx>bindingCycleCtx</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>assumedPod</span><span class=p>,</span> <span class=nx>scheduleResult</span><span class=p>.</span><span class=nx>SuggestedHost</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>forgetErr</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nx>Cache</span><span class=p>.</span><span class=nf>ForgetPod</span><span class=p>(</span><span class=nx>assumedPod</span><span class=p>);</span> <span class=nx>forgetErr</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>klog</span><span class=p>.</span><span class=nf>ErrorS</span><span class=p>(</span><span class=nx>forgetErr</span><span class=p>,</span> <span class=s>&#34;scheduler cache ForgetPod failed&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=c1>// &#34;Forget&#34;ing an assumed Pod in binding cycle should be treated as a PodDelete event,
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// as the assumed Pod had occupied a certain amount of resources in scheduler cache.
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// TODO(#103853): de-duplicate the logic.
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=nx>sched</span><span class=p>.</span><span class=nx>SchedulingQueue</span><span class=p>.</span><span class=nf>MoveAllToActiveOrBackoffQueue</span><span class=p>(</span><span class=nx>internalqueue</span><span class=p>.</span><span class=nx>AssignedPodDelete</span><span class=p>,</span> <span class=kc>nil</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nx>sched</span><span class=p>.</span><span class=nf>handleSchedulingFailure</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>fwk</span><span class=p>,</span> <span class=nx>assumedPodInfo</span><span class=p>,</span> <span class=nx>preBindStatus</span><span class=p>.</span><span class=nf>AsError</span><span class=p>(),</span> <span class=nx>SchedulerError</span><span class=p>,</span> <span class=nx>clearNominatedNode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=c1>// bind是真正的绑定操作
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>err</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nf>bind</span><span class=p>(</span><span class=nx>bindingCycleCtx</span><span class=p>,</span> <span class=nx>fwk</span><span class=p>,</span> <span class=nx>assumedPod</span><span class=p>,</span> <span class=nx>scheduleResult</span><span class=p>.</span><span class=nx>SuggestedHost</span><span class=p>,</span> <span class=nx>state</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>metrics</span><span class=p>.</span><span class=nf>PodScheduleError</span><span class=p>(</span><span class=nx>fwk</span><span class=p>.</span><span class=nf>ProfileName</span><span class=p>(),</span> <span class=nx>metrics</span><span class=p>.</span><span class=nf>SinceInSeconds</span><span class=p>(</span><span class=nx>start</span><span class=p>))</span>
</span></span><span class=line><span class=cl>			<span class=c1>// 如果失败了就触发 un-reserve plugins 
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>fwk</span><span class=p>.</span><span class=nf>RunReservePluginsUnreserve</span><span class=p>(</span><span class=nx>bindingCycleCtx</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>assumedPod</span><span class=p>,</span> <span class=nx>scheduleResult</span><span class=p>.</span><span class=nx>SuggestedHost</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nx>Cache</span><span class=p>.</span><span class=nf>ForgetPod</span><span class=p>(</span><span class=nx>assumedPod</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>klog</span><span class=p>.</span><span class=nf>ErrorS</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=s>&#34;scheduler cache ForgetPod failed&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=c1>// &#34;Forget&#34;ing an assumed Pod in binding cycle should be treated as a PodDelete event,
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// as the assumed Pod had occupied a certain amount of resources in scheduler cache.
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// TODO(#103853): de-duplicate the logic.
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=nx>sched</span><span class=p>.</span><span class=nx>SchedulingQueue</span><span class=p>.</span><span class=nf>MoveAllToActiveOrBackoffQueue</span><span class=p>(</span><span class=nx>internalqueue</span><span class=p>.</span><span class=nx>AssignedPodDelete</span><span class=p>,</span> <span class=kc>nil</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nx>sched</span><span class=p>.</span><span class=nf>handleSchedulingFailure</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>fwk</span><span class=p>,</span> <span class=nx>assumedPodInfo</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;binding rejected: %w&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>),</span> <span class=nx>SchedulerError</span><span class=p>,</span> <span class=nx>clearNominatedNode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=c1>// Calculating nodeResourceString can be heavy. Avoid it if klog verbosity is below 2.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>2</span><span class=p>).</span><span class=nf>InfoS</span><span class=p>(</span><span class=s>&#34;Successfully bound pod to node&#34;</span><span class=p>,</span> <span class=s>&#34;pod&#34;</span><span class=p>,</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>KObj</span><span class=p>(</span><span class=nx>pod</span><span class=p>),</span> <span class=s>&#34;node&#34;</span><span class=p>,</span> <span class=nx>scheduleResult</span><span class=p>.</span><span class=nx>SuggestedHost</span><span class=p>,</span> <span class=s>&#34;evaluatedNodes&#34;</span><span class=p>,</span> <span class=nx>scheduleResult</span><span class=p>.</span><span class=nx>EvaluatedNodes</span><span class=p>,</span> <span class=s>&#34;feasibleNodes&#34;</span><span class=p>,</span> <span class=nx>scheduleResult</span><span class=p>.</span><span class=nx>FeasibleNodes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>metrics</span><span class=p>.</span><span class=nf>PodScheduled</span><span class=p>(</span><span class=nx>fwk</span><span class=p>.</span><span class=nf>ProfileName</span><span class=p>(),</span> <span class=nx>metrics</span><span class=p>.</span><span class=nf>SinceInSeconds</span><span class=p>(</span><span class=nx>start</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=nx>metrics</span><span class=p>.</span><span class=nx>PodSchedulingAttempts</span><span class=p>.</span><span class=nf>Observe</span><span class=p>(</span><span class=nb>float64</span><span class=p>(</span><span class=nx>podInfo</span><span class=p>.</span><span class=nx>Attempts</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=nx>metrics</span><span class=p>.</span><span class=nx>PodSchedulingDuration</span><span class=p>.</span><span class=nf>WithLabelValues</span><span class=p>(</span><span class=nf>getAttemptsLabel</span><span class=p>(</span><span class=nx>podInfo</span><span class=p>)).</span><span class=nf>Observe</span><span class=p>(</span><span class=nx>metrics</span><span class=p>.</span><span class=nf>SinceInSeconds</span><span class=p>(</span><span class=nx>podInfo</span><span class=p>.</span><span class=nx>InitialAttemptTimestamp</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// 运行 &#34;postbind&#34; 插件
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// 是通知性的扩展点，该插件在绑定 Pod 后调用，可用于清理相关资源（）。
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>fwk</span><span class=p>.</span><span class=nf>RunPostBindPlugins</span><span class=p>(</span><span class=nx>bindingCycleCtx</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>assumedPod</span><span class=p>,</span> <span class=nx>scheduleResult</span><span class=p>.</span><span class=nx>SuggestedHost</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// At the end of a successful binding cycle, move up Pods if needed.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>podsToActivate</span><span class=p>.</span><span class=nx>Map</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>sched</span><span class=p>.</span><span class=nx>SchedulingQueue</span><span class=p>.</span><span class=nf>Activate</span><span class=p>(</span><span class=nx>podsToActivate</span><span class=p>.</span><span class=nx>Map</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=c1>// Unlike the logic in scheduling cycle, we don&#39;t bother deleting the entries
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// as `podsToActivate.Map` is no longer consumed.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}()</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><h2 id=调度上下文中的失败流程>调度上下文中的失败流程<a hidden class=anchor aria-hidden=true href=#调度上下文中的失败流程>#</a></h2><p>上面说到的都是正常的请求，下面会对失败的请求是如何重试的进行分析，而 <em>scheduler</em> 中关于失败处理方面相关的属性会涉及到上面 <em>scheduler</em> 结构中的 <code>backoffQ</code> 与 <code>unschedulablePods</code></p><ul><li><code>backoffQ</code>：也是一个 <em>heap</em> 类型的优先级队列，存放的是不可调度的Pod</li><li><code>unschedulablePods </code>：保存确定不可被调度的Pod，一个map类型</li></ul><p>backoffQ 与 unschedulablePods 会在初始化 <em>scheduler</em> 时初始化，</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>NewPriorityQueue</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=nx>lessFn</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>LessFunc</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>informerFactory</span> <span class=nx>informers</span><span class=p>.</span><span class=nx>SharedInformerFactory</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>opts</span> <span class=o>...</span><span class=nx>Option</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=o>*</span><span class=nx>PriorityQueue</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>options</span> <span class=o>:=</span> <span class=nx>defaultPriorityQueueOptions</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>opt</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>opts</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>opt</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>options</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>comp</span> <span class=o>:=</span> <span class=kd>func</span><span class=p>(</span><span class=nx>podInfo1</span><span class=p>,</span> <span class=nx>podInfo2</span> <span class=kd>interface</span><span class=p>{})</span> <span class=kt>bool</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>pInfo1</span> <span class=o>:=</span> <span class=nx>podInfo1</span><span class=p>.(</span><span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>QueuedPodInfo</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>pInfo2</span> <span class=o>:=</span> <span class=nx>podInfo2</span><span class=p>.(</span><span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>QueuedPodInfo</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nf>lessFn</span><span class=p>(</span><span class=nx>pInfo1</span><span class=p>,</span> <span class=nx>pInfo2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>options</span><span class=p>.</span><span class=nx>podNominator</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>options</span><span class=p>.</span><span class=nx>podNominator</span> <span class=p>=</span> <span class=nf>NewPodNominator</span><span class=p>(</span><span class=nx>informerFactory</span><span class=p>.</span><span class=nf>Core</span><span class=p>().</span><span class=nf>V1</span><span class=p>().</span><span class=nf>Pods</span><span class=p>().</span><span class=nf>Lister</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>pq</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>PriorityQueue</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>PodNominator</span><span class=p>:</span>                      <span class=nx>options</span><span class=p>.</span><span class=nx>podNominator</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>clock</span><span class=p>:</span>                             <span class=nx>options</span><span class=p>.</span><span class=nx>clock</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>stop</span><span class=p>:</span>                              <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kd>struct</span><span class=p>{}),</span>
</span></span><span class=line><span class=cl>		<span class=nx>podInitialBackoffDuration</span><span class=p>:</span>         <span class=nx>options</span><span class=p>.</span><span class=nx>podInitialBackoffDuration</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>podMaxBackoffDuration</span><span class=p>:</span>             <span class=nx>options</span><span class=p>.</span><span class=nx>podMaxBackoffDuration</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>podMaxInUnschedulablePodsDuration</span><span class=p>:</span> <span class=nx>options</span><span class=p>.</span><span class=nx>podMaxInUnschedulablePodsDuration</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>activeQ</span><span class=p>:</span>                           <span class=nx>heap</span><span class=p>.</span><span class=nf>NewWithRecorder</span><span class=p>(</span><span class=nx>podInfoKeyFunc</span><span class=p>,</span> <span class=nx>comp</span><span class=p>,</span> <span class=nx>metrics</span><span class=p>.</span><span class=nf>NewActivePodsRecorder</span><span class=p>()),</span>
</span></span><span class=line><span class=cl>		<span class=nx>unschedulablePods</span><span class=p>:</span>                 <span class=nf>newUnschedulablePods</span><span class=p>(</span><span class=nx>metrics</span><span class=p>.</span><span class=nf>NewUnschedulablePodsRecorder</span><span class=p>()),</span>
</span></span><span class=line><span class=cl>		<span class=nx>moveRequestCycle</span><span class=p>:</span>                  <span class=o>-</span><span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>clusterEventMap</span><span class=p>:</span>                   <span class=nx>options</span><span class=p>.</span><span class=nx>clusterEventMap</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>pq</span><span class=p>.</span><span class=nx>cond</span><span class=p>.</span><span class=nx>L</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>pq</span><span class=p>.</span><span class=nx>lock</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 初始化backoffQ
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// NewWithRecorder作为一个可选的 metricRecorder 的 Heap 对象。
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// podInfoKeyFunc是一个函数，返回错误与字符串
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// pq.podsCompareBackoffCompleted 比较两个pod的回退时间，如果第一个在第二个之前为true，
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 反之 false
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>pq</span><span class=p>.</span><span class=nx>podBackoffQ</span> <span class=p>=</span> <span class=nx>heap</span><span class=p>.</span><span class=nf>NewWithRecorder</span><span class=p>(</span><span class=nx>podInfoKeyFunc</span><span class=p>,</span> <span class=nx>pq</span><span class=p>.</span><span class=nx>podsCompareBackoffCompleted</span><span class=p>,</span> <span class=nx>metrics</span><span class=p>.</span><span class=nf>NewBackoffPodsRecorder</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=nx>pq</span><span class=p>.</span><span class=nx>nsLister</span> <span class=p>=</span> <span class=nx>informerFactory</span><span class=p>.</span><span class=nf>Core</span><span class=p>().</span><span class=nf>V1</span><span class=p>().</span><span class=nf>Namespaces</span><span class=p>().</span><span class=nf>Lister</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>pq</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>对于初始化 backoffQ 会产生的两个函数，<a href=https://github.com/kubernetes/kubernetes/blob/32c483ea6ee90a3a81f382563c91034470af8a4a/pkg/scheduler/internal/queue/scheduling_queue.go#L757-L761 target=_blank rel="noopener nofollow noreferrer">getBackoffTime</a> 与 <a href=https://github.com/kubernetes/kubernetes/blob/32c483ea6ee90a3a81f382563c91034470af8a4a/pkg/scheduler/internal/queue/scheduling_queue.go#L765-L775 target=_blank rel="noopener nofollow noreferrer">calculateBackoffDuration</a></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// getBackoffTime returns the time that podInfo completes backoff
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>p</span> <span class=o>*</span><span class=nx>PriorityQueue</span><span class=p>)</span> <span class=nf>getBackoffTime</span><span class=p>(</span><span class=nx>podInfo</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>QueuedPodInfo</span><span class=p>)</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>duration</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>.</span><span class=nf>calculateBackoffDuration</span><span class=p>(</span><span class=nx>podInfo</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>backoffTime</span> <span class=o>:=</span> <span class=nx>podInfo</span><span class=p>.</span><span class=nx>Timestamp</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=nx>duration</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>backoffTime</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// calculateBackoffDuration is a helper function for calculating the backoffDuration
</span></span></span><span class=line><span class=cl><span class=c1>// based on the number of attempts the pod has made.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>p</span> <span class=o>*</span><span class=nx>PriorityQueue</span><span class=p>)</span> <span class=nf>calculateBackoffDuration</span><span class=p>(</span><span class=nx>podInfo</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>QueuedPodInfo</span><span class=p>)</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>duration</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>.</span><span class=nx>podInitialBackoffDuration</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>1</span><span class=p>;</span> <span class=nx>i</span> <span class=p>&lt;</span> <span class=nx>podInfo</span><span class=p>.</span><span class=nx>Attempts</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// Use subtraction instead of addition or multiplication to avoid overflow.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nx>duration</span> <span class=p>&gt;</span> <span class=nx>p</span><span class=p>.</span><span class=nx>podMaxBackoffDuration</span><span class=o>-</span><span class=nx>duration</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>p</span><span class=p>.</span><span class=nx>podMaxBackoffDuration</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>duration</span> <span class=o>+=</span> <span class=nx>duration</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>duration</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>对于整个故障错误会按照如下流程进行，在初始化 <em>scheduler</em> 会注册一个 Error 函数，这个函数用作对不可调度Pod进行处理，实际上被注册的函数是 MakeDefaultErrorFunc。这个函数将作为 Error 函数被调用。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>sched</span> <span class=o>:=</span> <span class=nf>newScheduler</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>schedulerCache</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>extenders</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>internalqueue</span><span class=p>.</span><span class=nf>MakeNextPodFunc</span><span class=p>(</span><span class=nx>podQueue</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=nf>MakeDefaultErrorFunc</span><span class=p>(</span><span class=nx>client</span><span class=p>,</span> <span class=nx>podLister</span><span class=p>,</span> <span class=nx>podQueue</span><span class=p>,</span> <span class=nx>schedulerCache</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=nx>stopEverything</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>podQueue</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>profiles</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>client</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>snapshot</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>options</span><span class=p>.</span><span class=nx>percentageOfNodesToScore</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></td></tr></table></div></div></div></div><p>而在 调度周期中，也就是 <a href=https://github.com/kubernetes/kubernetes/blob/32c483ea6ee90a3a81f382563c91034470af8a4a/pkg/scheduler/schedule_one.go#L66-L132 target=_blank rel="noopener nofollow noreferrer">scheduleOne</a> 可以看到，每个扩展点操作失败后都会调用 <a href=https://github.com/kubernetes/kubernetes/blob/32c483ea6ee90a3a81f382563c91034470af8a4a/pkg/scheduler/schedule_one.go#L812-L834 target=_blank rel="noopener nofollow noreferrer">handleSchedulingFailure</a> 而该函数，使用了注册的 <em>Error</em> 函数来处理Pod</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>sched</span> <span class=o>*</span><span class=nx>Scheduler</span><span class=p>)</span> <span class=nf>scheduleOne</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=o>...</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nf>cancel</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>scheduleResult</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nf>SchedulePod</span><span class=p>(</span><span class=nx>schedulingCycleCtx</span><span class=p>,</span> <span class=nx>fwk</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>pod</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=kd>var</span> <span class=nx>nominatingInfo</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>NominatingInfo</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>fitError</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>err</span><span class=p>.(</span><span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>FitError</span><span class=p>);</span> <span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>!</span><span class=nx>fwk</span><span class=p>.</span><span class=nf>HasPostFilterPlugins</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>3</span><span class=p>).</span><span class=nf>InfoS</span><span class=p>(</span><span class=s>&#34;No PostFilter plugins are registered, so no preemption will be performed&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			
</span></span><span class=line><span class=cl>				<span class=nx>result</span><span class=p>,</span> <span class=nx>status</span> <span class=o>:=</span> <span class=nx>fwk</span><span class=p>.</span><span class=nf>RunPostFilterPlugins</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>pod</span><span class=p>,</span> <span class=nx>fitError</span><span class=p>.</span><span class=nx>Diagnosis</span><span class=p>.</span><span class=nx>NodeToStatusMap</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nx>status</span><span class=p>.</span><span class=nf>Code</span><span class=p>()</span> <span class=o>==</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>Error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>klog</span><span class=p>.</span><span class=nf>ErrorS</span><span class=p>(</span><span class=kc>nil</span><span class=p>,</span> <span class=s>&#34;Status after running PostFilter plugins for pod&#34;</span><span class=p>,</span> <span class=s>&#34;pod&#34;</span><span class=p>,</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>KObj</span><span class=p>(</span><span class=nx>pod</span><span class=p>),</span> <span class=s>&#34;status&#34;</span><span class=p>,</span> <span class=nx>status</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>fitError</span><span class=p>.</span><span class=nx>Diagnosis</span><span class=p>.</span><span class=nx>PostFilterMsg</span> <span class=p>=</span> <span class=nx>status</span><span class=p>.</span><span class=nf>Message</span><span class=p>()</span>
</span></span><span class=line><span class=cl>					<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>5</span><span class=p>).</span><span class=nf>InfoS</span><span class=p>(</span><span class=s>&#34;Status after running PostFilter plugins for pod&#34;</span><span class=p>,</span> <span class=s>&#34;pod&#34;</span><span class=p>,</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>KObj</span><span class=p>(</span><span class=nx>pod</span><span class=p>),</span> <span class=s>&#34;status&#34;</span><span class=p>,</span> <span class=nx>status</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nx>result</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>nominatingInfo</span> <span class=p>=</span> <span class=nx>result</span><span class=p>.</span><span class=nx>NominatingInfo</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>			<span class=nx>metrics</span><span class=p>.</span><span class=nf>PodUnschedulable</span><span class=p>(</span><span class=nx>fwk</span><span class=p>.</span><span class=nf>ProfileName</span><span class=p>(),</span> <span class=nx>metrics</span><span class=p>.</span><span class=nf>SinceInSeconds</span><span class=p>(</span><span class=nx>start</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=nx>err</span> <span class=o>==</span> <span class=nx>ErrNoNodesAvailable</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>nominatingInfo</span> <span class=p>=</span> <span class=nx>clearNominatedNode</span>
</span></span><span class=line><span class=cl>			<span class=c1>// No nodes available is counted as unschedulable rather than an error.
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>metrics</span><span class=p>.</span><span class=nf>PodUnschedulable</span><span class=p>(</span><span class=nx>fwk</span><span class=p>.</span><span class=nf>ProfileName</span><span class=p>(),</span> <span class=nx>metrics</span><span class=p>.</span><span class=nf>SinceInSeconds</span><span class=p>(</span><span class=nx>start</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>nominatingInfo</span> <span class=p>=</span> <span class=nx>clearNominatedNode</span>
</span></span><span class=line><span class=cl>			<span class=nx>klog</span><span class=p>.</span><span class=nf>ErrorS</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=s>&#34;Error selecting node for pod&#34;</span><span class=p>,</span> <span class=s>&#34;pod&#34;</span><span class=p>,</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>KObj</span><span class=p>(</span><span class=nx>pod</span><span class=p>))</span>
</span></span><span class=line><span class=cl>			<span class=nx>metrics</span><span class=p>.</span><span class=nf>PodScheduleError</span><span class=p>(</span><span class=nx>fwk</span><span class=p>.</span><span class=nf>ProfileName</span><span class=p>(),</span> <span class=nx>metrics</span><span class=p>.</span><span class=nf>SinceInSeconds</span><span class=p>(</span><span class=nx>start</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 处理不可调度Pod
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>sched</span><span class=p>.</span><span class=nf>handleSchedulingFailure</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>fwk</span><span class=p>,</span> <span class=nx>podInfo</span><span class=p>,</span> <span class=nx>err</span><span class=p>,</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>PodReasonUnschedulable</span><span class=p>,</span> <span class=nx>nominatingInfo</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>来到了注册的 <em>Error</em> 函数 <code>MakeDefaultErrorFunc</code></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>MakeDefaultErrorFunc</span><span class=p>(</span><span class=nx>client</span> <span class=nx>clientset</span><span class=p>.</span><span class=nx>Interface</span><span class=p>,</span> <span class=nx>podLister</span> <span class=nx>corelisters</span><span class=p>.</span><span class=nx>PodLister</span><span class=p>,</span> <span class=nx>podQueue</span> <span class=nx>internalqueue</span><span class=p>.</span><span class=nx>SchedulingQueue</span><span class=p>,</span> <span class=nx>schedulerCache</span> <span class=nx>internalcache</span><span class=p>.</span><span class=nx>Cache</span><span class=p>)</span> <span class=kd>func</span><span class=p>(</span><span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>QueuedPodInfo</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kd>func</span><span class=p>(</span><span class=nx>podInfo</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>QueuedPodInfo</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>pod</span> <span class=o>:=</span> <span class=nx>podInfo</span><span class=p>.</span><span class=nx>Pod</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>==</span> <span class=nx>ErrNoNodesAvailable</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>2</span><span class=p>).</span><span class=nf>InfoS</span><span class=p>(</span><span class=s>&#34;Unable to schedule pod; no nodes are registered to the cluster; waiting&#34;</span><span class=p>,</span> <span class=s>&#34;pod&#34;</span><span class=p>,</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>KObj</span><span class=p>(</span><span class=nx>pod</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=nx>fitError</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>err</span><span class=p>.(</span><span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>FitError</span><span class=p>);</span> <span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// Inject UnschedulablePlugins to PodInfo, which will be used later for moving Pods between queues efficiently.
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>podInfo</span><span class=p>.</span><span class=nx>UnschedulablePlugins</span> <span class=p>=</span> <span class=nx>fitError</span><span class=p>.</span><span class=nx>Diagnosis</span><span class=p>.</span><span class=nx>UnschedulablePlugins</span>
</span></span><span class=line><span class=cl>			<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>2</span><span class=p>).</span><span class=nf>InfoS</span><span class=p>(</span><span class=s>&#34;Unable to schedule pod; no fit; waiting&#34;</span><span class=p>,</span> <span class=s>&#34;pod&#34;</span><span class=p>,</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>KObj</span><span class=p>(</span><span class=nx>pod</span><span class=p>),</span> <span class=s>&#34;err&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=nx>apierrors</span><span class=p>.</span><span class=nf>IsNotFound</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>2</span><span class=p>).</span><span class=nf>InfoS</span><span class=p>(</span><span class=s>&#34;Unable to schedule pod, possibly due to node not found; waiting&#34;</span><span class=p>,</span> <span class=s>&#34;pod&#34;</span><span class=p>,</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>KObj</span><span class=p>(</span><span class=nx>pod</span><span class=p>),</span> <span class=s>&#34;err&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>errStatus</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>err</span><span class=p>.(</span><span class=nx>apierrors</span><span class=p>.</span><span class=nx>APIStatus</span><span class=p>);</span> <span class=nx>ok</span> <span class=o>&amp;&amp;</span> <span class=nx>errStatus</span><span class=p>.</span><span class=nf>Status</span><span class=p>().</span><span class=nx>Details</span><span class=p>.</span><span class=nx>Kind</span> <span class=o>==</span> <span class=s>&#34;node&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>nodeName</span> <span class=o>:=</span> <span class=nx>errStatus</span><span class=p>.</span><span class=nf>Status</span><span class=p>().</span><span class=nx>Details</span><span class=p>.</span><span class=nx>Name</span>
</span></span><span class=line><span class=cl>				<span class=c1>// when node is not found, We do not remove the node right away. Trying again to get
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// the node and if the node is still not found, then remove it from the scheduler cache.
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>client</span><span class=p>.</span><span class=nf>CoreV1</span><span class=p>().</span><span class=nf>Nodes</span><span class=p>().</span><span class=nf>Get</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>TODO</span><span class=p>(),</span> <span class=nx>nodeName</span><span class=p>,</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>GetOptions</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span> <span class=nx>apierrors</span><span class=p>.</span><span class=nf>IsNotFound</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>node</span> <span class=o>:=</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>Node</span><span class=p>{</span><span class=nx>ObjectMeta</span><span class=p>:</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>ObjectMeta</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=nx>nodeName</span><span class=p>}}</span>
</span></span><span class=line><span class=cl>					<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>schedulerCache</span><span class=p>.</span><span class=nf>RemoveNode</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>node</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>4</span><span class=p>).</span><span class=nf>InfoS</span><span class=p>(</span><span class=s>&#34;Node is not found; failed to remove it from the cache&#34;</span><span class=p>,</span> <span class=s>&#34;node&#34;</span><span class=p>,</span> <span class=nx>node</span><span class=p>.</span><span class=nx>Name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>					<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>klog</span><span class=p>.</span><span class=nf>ErrorS</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=s>&#34;Error scheduling pod; retrying&#34;</span><span class=p>,</span> <span class=s>&#34;pod&#34;</span><span class=p>,</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>KObj</span><span class=p>(</span><span class=nx>pod</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// Check if the Pod exists in informer cache.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>cachedPod</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>podLister</span><span class=p>.</span><span class=nf>Pods</span><span class=p>(</span><span class=nx>pod</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>).</span><span class=nf>Get</span><span class=p>(</span><span class=nx>pod</span><span class=p>.</span><span class=nx>Name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>klog</span><span class=p>.</span><span class=nf>InfoS</span><span class=p>(</span><span class=s>&#34;Pod doesn&#39;t exist in informer cache&#34;</span><span class=p>,</span> <span class=s>&#34;pod&#34;</span><span class=p>,</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>KObj</span><span class=p>(</span><span class=nx>pod</span><span class=p>),</span> <span class=s>&#34;err&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// In the case of extender, the pod may have been bound successfully, but timed out returning its response to the scheduler.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// It could result in the live version to carry .spec.nodeName, and that&#39;s inconsistent with the internal-queued version.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>cachedPod</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>NodeName</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>klog</span><span class=p>.</span><span class=nf>InfoS</span><span class=p>(</span><span class=s>&#34;Pod has been assigned to node. Abort adding it back to queue.&#34;</span><span class=p>,</span> <span class=s>&#34;pod&#34;</span><span class=p>,</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>KObj</span><span class=p>(</span><span class=nx>pod</span><span class=p>),</span> <span class=s>&#34;node&#34;</span><span class=p>,</span> <span class=nx>cachedPod</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>NodeName</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// As &lt;cachedPod&gt; is from SharedInformer, we need to do a DeepCopy() here.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>podInfo</span><span class=p>.</span><span class=nx>PodInfo</span> <span class=p>=</span> <span class=nx>framework</span><span class=p>.</span><span class=nf>NewPodInfo</span><span class=p>(</span><span class=nx>cachedPod</span><span class=p>.</span><span class=nf>DeepCopy</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 添加到unschedulable队列中
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>podQueue</span><span class=p>.</span><span class=nf>AddUnschedulableIfNotPresent</span><span class=p>(</span><span class=nx>podInfo</span><span class=p>,</span> <span class=nx>podQueue</span><span class=p>.</span><span class=nf>SchedulingCycle</span><span class=p>());</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>klog</span><span class=p>.</span><span class=nf>ErrorS</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=s>&#34;Error occurred&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>下面来到 <code>AddUnschedulableIfNotPresent</code> ，这个也是操作 <code>backoffQ</code> 和 <code>unschedulablePods </code>的真正的动作</p><p><code>AddUnschedulableIfNotPresent</code> 函数会吧无法调度的 pod 插入队列，除非它已经在队列中。通常情况下，<code>PriorityQueue</code> 将不可调度的 Pod 放在 <code>unschedulablePods</code> 中。但如果最近有 move request，则将 pod 放入 <code>podBackoffQ</code> 中。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>p</span> <span class=o>*</span><span class=nx>PriorityQueue</span><span class=p>)</span> <span class=nf>AddUnschedulableIfNotPresent</span><span class=p>(</span><span class=nx>pInfo</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>QueuedPodInfo</span><span class=p>,</span> <span class=nx>podSchedulingCycle</span> <span class=kt>int64</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>p</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>p</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>pod</span> <span class=o>:=</span> <span class=nx>pInfo</span><span class=p>.</span><span class=nx>Pod</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 如果已经存在则不添加
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>p</span><span class=p>.</span><span class=nx>unschedulablePods</span><span class=p>.</span><span class=nf>get</span><span class=p>(</span><span class=nx>pod</span><span class=p>)</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;Pod %v is already present in unschedulable queue&#34;</span><span class=p>,</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>KObj</span><span class=p>(</span><span class=nx>pod</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 检查是否在activeQ中
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>exists</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>.</span><span class=nx>activeQ</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=nx>pInfo</span><span class=p>);</span> <span class=nx>exists</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;Pod %v is already present in the active queue&#34;</span><span class=p>,</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>KObj</span><span class=p>(</span><span class=nx>pod</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 检查是否在podBackoffQ中
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>exists</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>.</span><span class=nx>podBackoffQ</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=nx>pInfo</span><span class=p>);</span> <span class=nx>exists</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;Pod %v is already present in the backoff queue&#34;</span><span class=p>,</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>KObj</span><span class=p>(</span><span class=nx>pod</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 在重新添加时，会刷新 Pod时间为最新操作的时间
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>pInfo</span><span class=p>.</span><span class=nx>Timestamp</span> <span class=p>=</span> <span class=nx>p</span><span class=p>.</span><span class=nx>clock</span><span class=p>.</span><span class=nf>Now</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>plugin</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>pInfo</span><span class=p>.</span><span class=nx>UnschedulablePlugins</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>metrics</span><span class=p>.</span><span class=nf>UnschedulableReason</span><span class=p>(</span><span class=nx>plugin</span><span class=p>,</span> <span class=nx>pInfo</span><span class=p>.</span><span class=nx>Pod</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>SchedulerName</span><span class=p>).</span><span class=nf>Inc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 如果接受到move request那么则放入BackoffQ
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>p</span><span class=p>.</span><span class=nx>moveRequestCycle</span> <span class=o>&gt;=</span> <span class=nx>podSchedulingCycle</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>.</span><span class=nx>podBackoffQ</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=nx>pInfo</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;error adding pod %v to the backoff queue: %v&#34;</span><span class=p>,</span> <span class=nx>pod</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>metrics</span><span class=p>.</span><span class=nx>SchedulerQueueIncomingPods</span><span class=p>.</span><span class=nf>WithLabelValues</span><span class=p>(</span><span class=s>&#34;backoff&#34;</span><span class=p>,</span> <span class=nx>ScheduleAttemptFailure</span><span class=p>).</span><span class=nf>Inc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 否则将放入到 unschedulablePods
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>p</span><span class=p>.</span><span class=nx>unschedulablePods</span><span class=p>.</span><span class=nf>addOrUpdate</span><span class=p>(</span><span class=nx>pInfo</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>metrics</span><span class=p>.</span><span class=nx>SchedulerQueueIncomingPods</span><span class=p>.</span><span class=nf>WithLabelValues</span><span class=p>(</span><span class=s>&#34;unschedulable&#34;</span><span class=p>,</span> <span class=nx>ScheduleAttemptFailure</span><span class=p>).</span><span class=nf>Inc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>p</span><span class=p>.</span><span class=nx>PodNominator</span><span class=p>.</span><span class=nf>AddNominatedPod</span><span class=p>(</span><span class=nx>pInfo</span><span class=p>.</span><span class=nx>PodInfo</span><span class=p>,</span> <span class=kc>nil</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>在启动 <em>scheduler</em> 时，会将这两个队列异步启用两个loop来操作队列。表现在 <a href=https://github.com/kubernetes/kubernetes/blob/32c483ea6ee90a3a81f382563c91034470af8a4a/pkg/scheduler/internal/queue/scheduling_queue.go#L292-L295 target=_blank rel="noopener nofollow noreferrer">Run()</a></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>p</span> <span class=o>*</span><span class=nx>PriorityQueue</span><span class=p>)</span> <span class=nf>Run</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>go</span> <span class=nx>wait</span><span class=p>.</span><span class=nf>Until</span><span class=p>(</span><span class=nx>p</span><span class=p>.</span><span class=nx>flushBackoffQCompleted</span><span class=p>,</span> <span class=mf>1.0</span><span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>,</span> <span class=nx>p</span><span class=p>.</span><span class=nx>stop</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>go</span> <span class=nx>wait</span><span class=p>.</span><span class=nf>Until</span><span class=p>(</span><span class=nx>p</span><span class=p>.</span><span class=nx>flushUnschedulablePodsLeftover</span><span class=p>,</span> <span class=mi>30</span><span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>,</span> <span class=nx>p</span><span class=p>.</span><span class=nx>stop</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>可以看到 <a href=https://github.com/kubernetes/kubernetes/blob/32c483ea6ee90a3a81f382563c91034470af8a4a/pkg/scheduler/internal/queue/scheduling_queue.go#L431-L458 target=_blank rel="noopener nofollow noreferrer">flushBackoffQCompleted</a> 作为 <code>BackoffQ</code> 实现；而 <a href=https://github.com/kubernetes/kubernetes/blob/32c483ea6ee90a3a81f382563c91034470af8a4a/pkg/scheduler/internal/queue/scheduling_queue.go#L462-L478 target=_blank rel="noopener nofollow noreferrer">flushUnschedulablePodsLeftover</a> 作为 <code>UnschedulablePods</code> 实现。</p><p><code>flushBackoffQCompleted</code> 是用于将所有已完成回退的 pod 从 <code>backoffQ</code> 移到 <code>activeQ</code> 中</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>p</span> <span class=o>*</span><span class=nx>PriorityQueue</span><span class=p>)</span> <span class=nf>flushBackoffQCompleted</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>p</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>p</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>broadcast</span> <span class=o>:=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=p>{</span> <span class=c1>// 这就是heap实现的方法，窥视下，但不弹出
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>rawPodInfo</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>.</span><span class=nx>podBackoffQ</span><span class=p>.</span><span class=nf>Peek</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>rawPodInfo</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>break</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>pod</span> <span class=o>:=</span> <span class=nx>rawPodInfo</span><span class=p>.(</span><span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>QueuedPodInfo</span><span class=p>).</span><span class=nx>Pod</span>
</span></span><span class=line><span class=cl>		<span class=nx>boTime</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>.</span><span class=nf>getBackoffTime</span><span class=p>(</span><span class=nx>rawPodInfo</span><span class=p>.(</span><span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>QueuedPodInfo</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>boTime</span><span class=p>.</span><span class=nf>After</span><span class=p>(</span><span class=nx>p</span><span class=p>.</span><span class=nx>clock</span><span class=p>.</span><span class=nf>Now</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>break</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>.</span><span class=nx>podBackoffQ</span><span class=p>.</span><span class=nf>Pop</span><span class=p>()</span> <span class=c1>// 弹出一个
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>klog</span><span class=p>.</span><span class=nf>ErrorS</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=s>&#34;Unable to pop pod from backoff queue despite backoff completion&#34;</span><span class=p>,</span> <span class=s>&#34;pod&#34;</span><span class=p>,</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>KObj</span><span class=p>(</span><span class=nx>pod</span><span class=p>))</span>
</span></span><span class=line><span class=cl>			<span class=k>break</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>p</span><span class=p>.</span><span class=nx>activeQ</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=nx>rawPodInfo</span><span class=p>)</span> <span class=c1>// 放入到活动队列中
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>metrics</span><span class=p>.</span><span class=nx>SchedulerQueueIncomingPods</span><span class=p>.</span><span class=nf>WithLabelValues</span><span class=p>(</span><span class=s>&#34;active&#34;</span><span class=p>,</span> <span class=nx>BackoffComplete</span><span class=p>).</span><span class=nf>Inc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=nx>broadcast</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>broadcast</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>p</span><span class=p>.</span><span class=nx>cond</span><span class=p>.</span><span class=nf>Broadcast</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p><code>flushUnschedulablePodsLeftover </code>函数用于将在 <code>unschedulablePods</code> 中的存放时间超过 <code>podMaxInUnschedulablePodsDuration</code> 值的 pod 移动到 <code>backoffQ</code> 或 <code>activeQ</code> 中。</p><p><code>podMaxInUnschedulablePodsDuration</code> 会根据配置传入，当没有传入，也就是使用了 <em><a href=https://github.com/kubernetes/kubernetes/blob/32c483ea6ee90a3a81f382563c91034470af8a4a/cmd/kube-scheduler/app/options/options.go#L77-L84 target=_blank rel="noopener nofollow noreferrer">Deprecated</a></em> 那么会为5分钟。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>NewOptions</span><span class=p>()</span> <span class=o>*</span><span class=nx>Options</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>o</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>Options</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>SecureServing</span><span class=p>:</span>  <span class=nx>apiserveroptions</span><span class=p>.</span><span class=nf>NewSecureServingOptions</span><span class=p>().</span><span class=nf>WithLoopback</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>		<span class=nx>Authentication</span><span class=p>:</span> <span class=nx>apiserveroptions</span><span class=p>.</span><span class=nf>NewDelegatingAuthenticationOptions</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>		<span class=nx>Authorization</span><span class=p>:</span>  <span class=nx>apiserveroptions</span><span class=p>.</span><span class=nf>NewDelegatingAuthorizationOptions</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>		<span class=nx>Deprecated</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>DeprecatedOptions</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>PodMaxInUnschedulablePodsDuration</span><span class=p>:</span> <span class=mi>5</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Minute</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span></span></span></code></pre></td></tr></table></div></div></div></div><p>对于 <code>flushUnschedulablePodsLeftover </code>就是做一个时间对比，然后添加到对应的队列中</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>p</span> <span class=o>*</span><span class=nx>PriorityQueue</span><span class=p>)</span> <span class=nf>flushUnschedulablePodsLeftover</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>p</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>p</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>podsToMove</span> <span class=p>[]</span><span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>QueuedPodInfo</span>
</span></span><span class=line><span class=cl>	<span class=nx>currentTime</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>.</span><span class=nx>clock</span><span class=p>.</span><span class=nf>Now</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>pInfo</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>p</span><span class=p>.</span><span class=nx>unschedulablePods</span><span class=p>.</span><span class=nx>podInfoMap</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>lastScheduleTime</span> <span class=o>:=</span> <span class=nx>pInfo</span><span class=p>.</span><span class=nx>Timestamp</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>currentTime</span><span class=p>.</span><span class=nf>Sub</span><span class=p>(</span><span class=nx>lastScheduleTime</span><span class=p>)</span> <span class=p>&gt;</span> <span class=nx>p</span><span class=p>.</span><span class=nx>podMaxInUnschedulablePodsDuration</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>podsToMove</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>podsToMove</span><span class=p>,</span> <span class=nx>pInfo</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>podsToMove</span><span class=p>)</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>p</span><span class=p>.</span><span class=nf>movePodsToActiveOrBackoffQueue</span><span class=p>(</span><span class=nx>podsToMove</span><span class=p>,</span> <span class=nx>UnschedulableTimeout</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><h2 id=总结调度上下文流程>总结调度上下文流程<a hidden class=anchor aria-hidden=true href=#总结调度上下文流程>#</a></h2><ul><li>在构建一个 <em>scheduler</em> 时经历如下步骤：<ul><li>准备cache，informer，queue，错误处理函数等</li><li>添加事件函数，会监听资源（如Pod），当有变动则触发对应事件函数，这是入站 <code>activeQ</code></li></ul></li><li>构建完成后会 run，run时会run一个 <code>SchedulingQueue</code>，这个是作为不可调度队列<ul><li><code>BackoffQ</code></li><li><code>UnschedulablePods</code></li><li>不可调度队列会根据注册时定期消费队列中Pod将其添加到 <code>activeQ</code> 中</li></ul></li><li>启动一个 <code>scheduleOne</code> 的loop，这个是调度上下文中所有的扩展点的执行，也是 <code>activeQ</code> 的消费端<ul><li><code>scheduleOne</code> 获取 pod</li><li>执行各个扩展点，如果出错则 <em>Error</em> 函数 <code>MakeDefaultErrorFunc</code> 将其添加到不可调度队列中</li><li>回到不可调度队列中消费部分</li></ul></li></ul><h2 id=reference>Reference<a hidden class=anchor aria-hidden=true href=#reference>#</a></h2><blockquote><p><sup id=1>[1]</sup> <a href=https://www.sobyte.net/post/2022-02/kubernetes-scheduling-framework-and-extender/ target=_blank rel="noopener nofollow noreferrer">kubernetes scheduler extender</a></p></blockquote></div><div class=pe-copyright><hr><blockquote><p>本文为原创内容，版权归作者所有。如需转载，请在文章中声明本文标题及链接。</p><p>文章标题：kube-scheduler的调度上下文</p><p>文章链接：<a href=https://www.oomkill.com/2022/07/ch20-schedule-workflow/ target=_blank>https://www.oomkill.com/2022/07/ch20-schedule-workflow/</a></p><p>许可协议：<a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></p></blockquote></div><div class=comments-separator></div><h3 class=relatedContentTitle>相关阅读</h3><ul class=relatedContent><li><a href=/2022/07/ch16-scheduler/><span>kubernetes的决策组件 - kube-scheduler原理分析</span></a></li><li><a href=/2022/07/ch33-admission-webhook/><span>深入理解Kubernetes 4A - Admission Control源码解析</span></a></li><li><a href=/2022/06/ch27-leader-election/><span>源码分析Kubernetes HA机制 - leader election</span></a></li><li><a href=/2022/06/ch15-controller-runtime/><span>源码分析Kubernetes controller组件 - controller-runtime</span></a></li><li><a href=/2022/06/ch04-apiserver-aggregation/><span>扩展Kubernetes API的另一种方式 - APIServer aggregation</span></a></li></ul><div class=comments-separator></div><footer class=post-footer><ul class=post-tags><li><a href=https://www.oomkill.com/tags/kubernetes-develop/>Kubernetes Develop</a></li><li><a href=https://www.oomkill.com/tags/kubernetes/>Kubernetes</a></li></ul><nav class=paginav><a class=prev href=https://www.oomkill.com/2022/07/ch21-scheduling-algorithm/><span class=title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left" style="user-select:text"><line x1="19" y1="12" x2="5" y2="12" style="user-select:text"/><polyline points="12 19 5 12 12 5" style="user-select:text"/></polyline></svg>&nbsp;</span>
<span>如何理解kubernetes调度框架与插件？</span>
</a><a class=next href=https://www.oomkill.com/2022/07/ch16-scheduler/><span class=title></span>
<span>kubernetes的决策组件 - kube-scheduler原理分析&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right" style="user-select:text"><line x1="5" y1="12" x2="19" y2="12" style="user-select:text"/><polyline points="12 5 19 12 12 19" style="user-select:text"/></svg></span></a></nav></footer><div class=pe-comments-decoration><p class=pe-comments-title></p><p class=pe-comments-subtitle></p></div><div id=pe-comments></div><script src=/js/pe-go-comment.min.86a214102576ba5f9b7bdc29eed8d58dd56e34aef80b3c65c73ea9cc88443696.js integrity="sha256-hqIUECV2ul+be9wp7tjVjdVuNK74Czxlxz6pzIhENpY="></script><script>const getStoredTheme=()=>localStorage.getItem("pref-theme")==="dark"?"dark":"light",setGiscusTheme=()=>{const e=e=>{const t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:e},"https://giscus.app")};e({setConfig:{theme:getStoredTheme()}})};document.addEventListener("DOMContentLoaded",()=>{const s={src:"https://giscus.app/client.js","data-repo":"cylonchau/blogs","data-repo-id":"R_kgDOIRlNSQ","data-category":"Announcements","data-category-id":"DIC_kwDOIRlNSc4CXy1U","data-mapping":"pathname","data-term":"posts/ch20 Schedule workflow","data-strict":"0","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"bottom","data-theme":getStoredTheme(),"data-lang":"zh-TW","data-loading":"lazy",crossorigin:"anonymous",async:""},e=document.createElement("script");Object.entries(s).forEach(([t,n])=>e.setAttribute(t,n)),document.querySelector("#pe-comments").appendChild(e);const t=document.querySelector("#theme-toggle");t&&t.addEventListener("click",setGiscusTheme);const n=document.querySelector("#theme-toggle-float");n&&n.addEventListener("click",setGiscusTheme)})</script></article></main><footer class=footer><span>&copy; 2025 <a href=https://www.oomkill.com/>Cylon's Collection</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> on
<a href=https://pages.github.com/ rel=noopener target=_blank>GitHub Pages</a> & Theme
        <a href=https://github.com/tofuwine/PaperMod-PE rel=noopener target=_blank>PaperMod-PE</a></span></footer><div class=pe-right-sidebar><a href=javascript:void(0); id=theme-toggle-float class=pe-float-btn><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</a><a href=#top class=pe-float-btn id=top-link><span id=pe-read-progress></span></a></div><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>