<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Kubernetes Pod网络排错思路 | Cylon's Collection</title>
<meta name=keywords content="kubernetes,network"><meta name=description content="Overview 本文将引入一个思路：“在Kubernetes集群发生网络异常时如何排查”。文章将引入Kubernetes 集群中网络排查的思路，包含网络异常模型，常用工具，并且提出一些案例以供学习。
Pod常见网络异常分类 网络排查工具 Pod网络异常排查思路及流程模型 CNI网络异常排查步骤 案例学习 Pod网络异常 网络异常大概分为如下几类：
网络不可达，主要现象为ping不通，其可能原因为：
源端和目的端防火墙（iptables, selinux）限制 网络路由配置不正确 源端和目的端的系统负载过高，网络连接数满，网卡队列满 网络链路故障 端口不可达：主要现象为可以ping通，但telnet端口不通，其可能原因为：
源端和目的端防火墙限制 源端和目的端的系统负载过高，网络连接数满，网卡队列满，端口耗尽 目的端应用未正常监听导致（应用未启动，或监听为127.0.0.1等） DNS解析异常：主要现象为基础网络可以连通，访问域名报错无法解析，访问IP可以正常连通。其可能原因为
Pod的DNS配置不正确 DNS服务异常 pod与DNS服务通讯异常 大数据包丢包：主要现象为基础网络和端口均可以连通，小数据包收发无异常，大数据包丢包。可能原因为：
数据包的大小超过了 dockero，CNI 插件，或者宿主机网卡的 MTU 值。 可使用 ping -s 指定数据包大小进行测试 CNI异常：主要现象为Node可以通，但Pod无法访问集群地址，可能原因有：
kube-proxy 服务异常，没有生成 iptables 策略或者 ipvs 规则导致无法访问 CIDR耗尽，无法为Node注入 PodCIDR 导致 CNI 插件异常 其他 CNI 插件问题 那么整个Pod网络异常分类可以如下图所示：
图：Pod network trouble hirarchy
总结一下，Pod最常见的网络故障有，网络不可达（ping不通）；端口不可达（telnet不通）；DNS解析异常（域名不通）与大数据包丢失（大包不通）。
常用网络排查工具 在了解到常见的网络异常后，在排查时就需要使用到一些网络工具才可以很有效的定位到网络故障原因，下面会介绍一些网络排查工具。
tcpdump [1] tcpdump网络嗅探器，将强大和简单结合到一个单一的命令行界面中，能够将网络中的报文抓取，输出到屏幕或者记录到文件中。
各系统下的安装
Ubuntu/Debian: tcpdump ；apt-get install -y tcpdump Centos/Fedora: tcpdump ；yum install -y tcpdump Apline：tcpdump ；apk add tcpdump --no-cache 查看指定接口上的所有通讯"><meta name=author content="cylon"><link rel=canonical href=https://www.oomkill.com/2022/08/pod-network-troubleshooting/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://www.oomkill.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.oomkill.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.oomkill.com/favicon-32x32.png><link rel=apple-touch-icon href=https://www.oomkill.com/favicon.ico><link rel=mask-icon href=https://www.oomkill.com/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://www.oomkill.com/2022/08/pod-network-troubleshooting/><noscript><style>#theme-toggle,#top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link crossorigin=anonymous href=/assets/css/pe.min.css rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/pe.min.js></script><link rel=stylesheet href=https://cdn.staticfile.net/font-awesome/6.5.1/css/all.min.css><link rel=stylesheet href=https://cdn.staticfile.net/font-awesome/6.5.1/css/v4-shims.min.css><script defer src=https://cdn.staticfile.net/jquery/3.5.1/jquery.min.js></script><link rel=stylesheet href=https://cdn.staticfile.net/fancybox/3.5.7/jquery.fancybox.min.css><script defer src=https://cdn.staticfile.net/fancybox/3.5.7/jquery.fancybox.min.js></script><script id=MathJax-script async src=https://cdn.staticfile.net/mathjax/3.2.2/es5/tex-chtml.js></script><script>MathJax={tex:{displayMath:[["$$","$$"]],inlineMath:[["\\$","\\$"]]}}</script><meta property="og:title" content="Kubernetes Pod网络排错思路"><meta property="og:description" content="Overview 本文将引入一个思路：“在Kubernetes集群发生网络异常时如何排查”。文章将引入Kubernetes 集群中网络排查的思路，包含网络异常模型，常用工具，并且提出一些案例以供学习。
Pod常见网络异常分类 网络排查工具 Pod网络异常排查思路及流程模型 CNI网络异常排查步骤 案例学习 Pod网络异常 网络异常大概分为如下几类：
网络不可达，主要现象为ping不通，其可能原因为：
源端和目的端防火墙（iptables, selinux）限制 网络路由配置不正确 源端和目的端的系统负载过高，网络连接数满，网卡队列满 网络链路故障 端口不可达：主要现象为可以ping通，但telnet端口不通，其可能原因为：
源端和目的端防火墙限制 源端和目的端的系统负载过高，网络连接数满，网卡队列满，端口耗尽 目的端应用未正常监听导致（应用未启动，或监听为127.0.0.1等） DNS解析异常：主要现象为基础网络可以连通，访问域名报错无法解析，访问IP可以正常连通。其可能原因为
Pod的DNS配置不正确 DNS服务异常 pod与DNS服务通讯异常 大数据包丢包：主要现象为基础网络和端口均可以连通，小数据包收发无异常，大数据包丢包。可能原因为：
数据包的大小超过了 dockero，CNI 插件，或者宿主机网卡的 MTU 值。 可使用 ping -s 指定数据包大小进行测试 CNI异常：主要现象为Node可以通，但Pod无法访问集群地址，可能原因有：
kube-proxy 服务异常，没有生成 iptables 策略或者 ipvs 规则导致无法访问 CIDR耗尽，无法为Node注入 PodCIDR 导致 CNI 插件异常 其他 CNI 插件问题 那么整个Pod网络异常分类可以如下图所示：
图：Pod network trouble hirarchy
总结一下，Pod最常见的网络故障有，网络不可达（ping不通）；端口不可达（telnet不通）；DNS解析异常（域名不通）与大数据包丢失（大包不通）。
常用网络排查工具 在了解到常见的网络异常后，在排查时就需要使用到一些网络工具才可以很有效的定位到网络故障原因，下面会介绍一些网络排查工具。
tcpdump [1] tcpdump网络嗅探器，将强大和简单结合到一个单一的命令行界面中，能够将网络中的报文抓取，输出到屏幕或者记录到文件中。
各系统下的安装
Ubuntu/Debian: tcpdump ；apt-get install -y tcpdump Centos/Fedora: tcpdump ；yum install -y tcpdump Apline：tcpdump ；apk add tcpdump --no-cache 查看指定接口上的所有通讯"><meta property="og:type" content="article"><meta property="og:url" content="https://www.oomkill.com/2022/08/pod-network-troubleshooting/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-08-17T00:00:00+00:00"><meta property="article:modified_time" content="2023-03-22T23:00:36+08:00"><meta property="og:site_name" content="Cylon's Collection"><meta name=twitter:card content="summary"><meta name=twitter:title content="Kubernetes Pod网络排错思路"><meta name=twitter:description content="Overview 本文将引入一个思路：“在Kubernetes集群发生网络异常时如何排查”。文章将引入Kubernetes 集群中网络排查的思路，包含网络异常模型，常用工具，并且提出一些案例以供学习。
Pod常见网络异常分类 网络排查工具 Pod网络异常排查思路及流程模型 CNI网络异常排查步骤 案例学习 Pod网络异常 网络异常大概分为如下几类：
网络不可达，主要现象为ping不通，其可能原因为：
源端和目的端防火墙（iptables, selinux）限制 网络路由配置不正确 源端和目的端的系统负载过高，网络连接数满，网卡队列满 网络链路故障 端口不可达：主要现象为可以ping通，但telnet端口不通，其可能原因为：
源端和目的端防火墙限制 源端和目的端的系统负载过高，网络连接数满，网卡队列满，端口耗尽 目的端应用未正常监听导致（应用未启动，或监听为127.0.0.1等） DNS解析异常：主要现象为基础网络可以连通，访问域名报错无法解析，访问IP可以正常连通。其可能原因为
Pod的DNS配置不正确 DNS服务异常 pod与DNS服务通讯异常 大数据包丢包：主要现象为基础网络和端口均可以连通，小数据包收发无异常，大数据包丢包。可能原因为：
数据包的大小超过了 dockero，CNI 插件，或者宿主机网卡的 MTU 值。 可使用 ping -s 指定数据包大小进行测试 CNI异常：主要现象为Node可以通，但Pod无法访问集群地址，可能原因有：
kube-proxy 服务异常，没有生成 iptables 策略或者 ipvs 规则导致无法访问 CIDR耗尽，无法为Node注入 PodCIDR 导致 CNI 插件异常 其他 CNI 插件问题 那么整个Pod网络异常分类可以如下图所示：
图：Pod network trouble hirarchy
总结一下，Pod最常见的网络故障有，网络不可达（ping不通）；端口不可达（telnet不通）；DNS解析异常（域名不通）与大数据包丢失（大包不通）。
常用网络排查工具 在了解到常见的网络异常后，在排查时就需要使用到一些网络工具才可以很有效的定位到网络故障原因，下面会介绍一些网络排查工具。
tcpdump [1] tcpdump网络嗅探器，将强大和简单结合到一个单一的命令行界面中，能够将网络中的报文抓取，输出到屏幕或者记录到文件中。
各系统下的安装
Ubuntu/Debian: tcpdump ；apt-get install -y tcpdump Centos/Fedora: tcpdump ；yum install -y tcpdump Apline：tcpdump ；apk add tcpdump --no-cache 查看指定接口上的所有通讯"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://www.oomkill.com/posts/"},{"@type":"ListItem","position":2,"name":"Kubernetes Pod网络排错思路","item":"https://www.oomkill.com/2022/08/pod-network-troubleshooting/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Kubernetes Pod网络排错思路","name":"Kubernetes Pod网络排错思路","description":"Overview 本文将引入一个思路：“在Kubernetes集群发生网络异常时如何排查”。文章将引入Kubernetes 集群中网络排查的思路，包含网络异常模型，常用工具，并且提出一些案例以供学习。\nPod常见网络异常分类 网络排查工具 Pod网络异常排查思路及流程模型 CNI网络异常排查步骤 案例学习 Pod网络异常 网络异常大概分为如下几类：\n网络不可达，主要现象为ping不通，其可能原因为：\n源端和目的端防火墙（iptables, selinux）限制 网络路由配置不正确 源端和目的端的系统负载过高，网络连接数满，网卡队列满 网络链路故障 端口不可达：主要现象为可以ping通，但telnet端口不通，其可能原因为：\n源端和目的端防火墙限制 源端和目的端的系统负载过高，网络连接数满，网卡队列满，端口耗尽 目的端应用未正常监听导致（应用未启动，或监听为127.0.0.1等） DNS解析异常：主要现象为基础网络可以连通，访问域名报错无法解析，访问IP可以正常连通。其可能原因为\nPod的DNS配置不正确 DNS服务异常 pod与DNS服务通讯异常 大数据包丢包：主要现象为基础网络和端口均可以连通，小数据包收发无异常，大数据包丢包。可能原因为：\n数据包的大小超过了 dockero，CNI 插件，或者宿主机网卡的 MTU 值。 可使用 ping -s 指定数据包大小进行测试 CNI异常：主要现象为Node可以通，但Pod无法访问集群地址，可能原因有：\nkube-proxy 服务异常，没有生成 iptables 策略或者 ipvs 规则导致无法访问 CIDR耗尽，无法为Node注入 PodCIDR 导致 CNI 插件异常 其他 CNI 插件问题 那么整个Pod网络异常分类可以如下图所示：\n图：Pod network trouble hirarchy\n总结一下，Pod最常见的网络故障有，网络不可达（ping不通）；端口不可达（telnet不通）；DNS解析异常（域名不通）与大数据包丢失（大包不通）。\n常用网络排查工具 在了解到常见的网络异常后，在排查时就需要使用到一些网络工具才可以很有效的定位到网络故障原因，下面会介绍一些网络排查工具。\ntcpdump [1] tcpdump网络嗅探器，将强大和简单结合到一个单一的命令行界面中，能够将网络中的报文抓取，输出到屏幕或者记录到文件中。\n各系统下的安装\nUbuntu/Debian: tcpdump ；apt-get install -y tcpdump Centos/Fedora: tcpdump ；yum install -y tcpdump Apline：tcpdump ；apk add tcpdump --no-cache 查看指定接口上的所有通讯","keywords":["kubernetes","network"],"articleBody":"Overview 本文将引入一个思路：“在Kubernetes集群发生网络异常时如何排查”。文章将引入Kubernetes 集群中网络排查的思路，包含网络异常模型，常用工具，并且提出一些案例以供学习。\nPod常见网络异常分类 网络排查工具 Pod网络异常排查思路及流程模型 CNI网络异常排查步骤 案例学习 Pod网络异常 网络异常大概分为如下几类：\n网络不可达，主要现象为ping不通，其可能原因为：\n源端和目的端防火墙（iptables, selinux）限制 网络路由配置不正确 源端和目的端的系统负载过高，网络连接数满，网卡队列满 网络链路故障 端口不可达：主要现象为可以ping通，但telnet端口不通，其可能原因为：\n源端和目的端防火墙限制 源端和目的端的系统负载过高，网络连接数满，网卡队列满，端口耗尽 目的端应用未正常监听导致（应用未启动，或监听为127.0.0.1等） DNS解析异常：主要现象为基础网络可以连通，访问域名报错无法解析，访问IP可以正常连通。其可能原因为\nPod的DNS配置不正确 DNS服务异常 pod与DNS服务通讯异常 大数据包丢包：主要现象为基础网络和端口均可以连通，小数据包收发无异常，大数据包丢包。可能原因为：\n数据包的大小超过了 dockero，CNI 插件，或者宿主机网卡的 MTU 值。 可使用 ping -s 指定数据包大小进行测试 CNI异常：主要现象为Node可以通，但Pod无法访问集群地址，可能原因有：\nkube-proxy 服务异常，没有生成 iptables 策略或者 ipvs 规则导致无法访问 CIDR耗尽，无法为Node注入 PodCIDR 导致 CNI 插件异常 其他 CNI 插件问题 那么整个Pod网络异常分类可以如下图所示：\n图：Pod network trouble hirarchy\n总结一下，Pod最常见的网络故障有，网络不可达（ping不通）；端口不可达（telnet不通）；DNS解析异常（域名不通）与大数据包丢失（大包不通）。\n常用网络排查工具 在了解到常见的网络异常后，在排查时就需要使用到一些网络工具才可以很有效的定位到网络故障原因，下面会介绍一些网络排查工具。\ntcpdump [1] tcpdump网络嗅探器，将强大和简单结合到一个单一的命令行界面中，能够将网络中的报文抓取，输出到屏幕或者记录到文件中。\n各系统下的安装\nUbuntu/Debian: tcpdump ；apt-get install -y tcpdump Centos/Fedora: tcpdump ；yum install -y tcpdump Apline：tcpdump ；apk add tcpdump --no-cache 查看指定接口上的所有通讯\n语法\n参数 说明 -i [interface] -w [flle] 第一个n表示将地址解析为数字格式而不是主机名，第二个N表示将端口解析为数字格式而不是服务名 -n 不显示IP地址 -X hex and ASCII -A ASCII（实际上是以人类可读懂的包进行显示） -XX -v 详细信息 -r 读取文件而不是实时抓包 关键字 type host（主机名，域名，IP地址）, net, port, portrange direction src, dst, src or dst , src and ds protocol ether, ip，arp, tcp, udp, wlan 捕获所有网络接口 bash 1 tcpdump -D ####按IP查找流量\n最常见的查询之一 host，可以看到来往于 1.1.1.1 的流量。\nbash 1 tcpdump host 1.1.1.1 ####按源/目的 地址过滤\n如果只想查看来自/向某方向流量，可以使用 src 和 dst。\nbash 1 tcpdump src|dst 1.1.1.1 通过网络查找数据包 使用 net 选项，来要查找出/入某个网络或子网的数据包。\nbash 1 tcpdump net 1.2.3.0/24 使用十六进制输出数据包内容 hex 可以以16进制输出包的内容\nbash 1 tcpdump -c 1 -X icmp 查看特定端口的流量 使用 port 选项来查找特定的端口流量。\nbash 1 2 tcpdump port 3389 tcpdump src port 1025 查找端口范围的流量 bash 1 tcpdump portrange 21-23 过滤包的大小 如果需要查找特定大小的数据包，可以使用以下选项。你可以使用 less，greater。\nbash 1 2 3 tcpdump less 32 tcpdump greater 64 tcpdump \u003c= 128 捕获流量输出为文件 -w 可以将数据包捕获保存到一个文件中以便将来进行分析。这些文件称为PCAP（PEE-cap）文件，它们可以由不同的工具处理，包括 Wireshark 。\nbash 1 tcpdump port 80 -w capture_file 组合条件 tcpdump也可以结合逻辑运算符进行组合条件查询\nAND and or \u0026\u0026\nOR or or ||\nEXCEPT not or !\nbash 1 2 3 4 tcpdump -i eth0 -nn host 220.181.57.216 and 10.0.0.1 # 主机之间的通讯 tcpdump -i eth0 -nn host 220.181.57.216 or 10.0.0.1 # 获取10.0.0.1与 10.0.0.9或 10.0.0.1 与10.0.0.3之间的通讯 tcpdump -i eth0 -nn host 10.0.0.1 and \\(10.0.0.9 or 10.0.0.3\\) 原始输出 并显示人类可读的内容进行输出包（不包含内容）。\nbash 1 2 tcpdump -ttnnvvS -i eth0 tcpdump -ttnnvvS -i eth0 IP到端口 让我们查找从某个IP到端口任何主机的某个端口所有流量。\nbash 1 tcpdump -nnvvS src 10.5.2.3 and dst port 3389 去除特定流量 可以将指定的流量排除，如这显示所有到192.168.0.2的 非ICMP的流量。\nbash 1 tcpdump dst 192.168.0.2 and src net and not icmp 来自非指定端口的流量，如，显示来自不是SSH流量的主机的所有流量。\nbash 1 tcpdump -vv src mars and not dst port 22 选项分组 在构建复杂查询时，必须使用单引号 '。单引号用于忽略特殊符号 () ，以便于使用其他表达式（如host, port, net等）进行分组。\nbash 1 tcpdump 'src 10.0.2.4 and (dst port 3389 or 22)' 过滤TCP标记位 TCP RST\nThe filters below find these various packets because tcp[13] looks at offset 13 in the TCP header, the number represents the location within the byte, and the !=0 means that the flag in question is set to 1, i.e. it’s on.\nbash 1 2 tcpdump 'tcp[13] \u0026 4!=0' tcpdump 'tcp[tcpflags] == tcp-rst' TCP SYN\nbash 1 2 tcpdump 'tcp[13] \u0026 2!=0' tcpdump 'tcp[tcpflags] == tcp-syn' 同时忽略SYN和ACK标志的数据包\nbash 1 tcpdump 'tcp[13]=18' TCP URG\nbash 1 2 tcpdump 'tcp[13] \u0026 32!=0' tcpdump 'tcp[tcpflags] == tcp-urg' TCP ACK\nbash 1 2 tcpdump 'tcp[13] \u0026 16!=0' tcpdump 'tcp[tcpflags] == tcp-ack' TCP PSH\nbash 1 2 tcpdump 'tcp[13] \u0026 8!=0' tcpdump 'tcp[tcpflags] == tcp-push' TCP FIN\nbash 1 2 tcpdump 'tcp[13] \u0026 1!=0' tcpdump 'tcp[tcpflags] == tcp-fin' 查找http包 查找 user-agent 信息\nbash 1 tcpdump -vvAls0 | grep 'User-Agent:' 查找只是 GET 请求的流量\nbash 1 tcpdump -vvAls0 | grep 'GET' 查找http客户端IP\nbash 1 tcpdump -vvAls0 | grep 'Host:' 查询客户端cookie\nbash 1 tcpdump -vvAls0 | grep 'Set-Cookie|Host:|Cookie:' 查找DNS流量 bash 1 tcpdump -vvAs0 port 53 查找对应流量的明文密码 bash 1 tcpdump port http or port ftp or port smtp or port imap or port pop3 or port telnet -lA | egrep -i -B5 'pass=|pwd=|log=|login=|user=|username=|pw=|passw=|passwd= |password=|pass:|user:|username:|password:|login:|pass |user ' wireshark追踪流 wireshare追踪流可以很好的了解出在一次交互过程中都发生了那些问题。\nwireshare选中包，右键选择 “追踪流“ 如果该包是允许的协议是可以打开该选项的\n关于抓包节点和抓包设备 如何抓取有用的包，以及如何找到对应的接口，有以下建议\n抓包节点：\n通常情况下会在==源端==和==目的端==两端同时抓包，观察数据包是否从源端正常发出，目的端是否接收到数据包并给源端回包，以及源端是否正常接收到回包。如果有丢包现象，则沿网络链路上各节点抓包排查。例如，A节点经过c节点到B节点，先在AB两端同时抓包，如果B节点未收到A节点的包，则在c节点同时抓包。\n抓包设备：\n对于 Kubernetes 集群中的Pod，由于容器内不便于抓包，通常视情况在Pod数据包经过的veth设备，docker0 网桥，CNI 插件设备（如cni0，flannel.1 etc..）及Pod所在节点的网卡设备上指定Pod IP进行抓包。选取的设备根据怀疑导致网络问题的原因而定，比如范围由大缩小，从源端逐渐靠近目的端，比如怀疑是 CNI 插件导致，则在 CNI 插件设备上抓包。从pod发出的包逐一经过veth设备，cni0 设备，flannel0，宿主机网卡，到达对端，抓包时可按顺序逐一抓包，定位问题节点。\n需要注意在不同设备上抓包时指定的源目IP地址需要转换，如抓取某Pod时，ping {host} 的包，在 veth 和 cni0 上可以指定 Pod IP抓包，而在宿主机网卡上如果仍然指定Pod IP会发现抓不到包，因为此时Pod IP已被转换为宿主机网卡IP。\n下图是一个使用 VxLAN 模式的 flannel 的跨界点通讯的网络模型，在抓包时需要注意对应的网络接口\n图：VxLAN in kubernetes\nnsenter nsenter是一款可以进入进程的名称空间中。例如，如果一个容器以非 root 用户身份运行，而使用 docker exec 进入其中后，但该容器没有安装 sudo 或未 netstat ，并且您想查看其当前的网络属性，如开放端口，这种场景下将如何做到这一点？nsenter 就是用来解决这个问题的。\nnsenter (namespace enter) 可以在容器的宿主机上使用 nsenter 命令进入容器的命名空间，以容器视角使用宿主机上的相应网络命令进行操作。==当然需要拥有 root 权限==\n各系统下的安装 [2]\nUbuntu/Debian: util-linux ；apt-get install -y util-linux Centos/Fedora: util-linux ；yum install -y util-linux Apline：util-linux ；apk add util-linux --no-cache nsenter 的使用语法为，nsenter -t pid -n ，-t 接 进程ID号，-n 表示进入名称空间内， 为执行的命令。更多的内容可以参考 [3]\n实例：如我们有一个Pod进程ID为30858，进入该Pod名称空间内执行 ifconfig ，如下列所示\nbash 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 $ ps -ef|grep tail root 17636 62887 0 20:19 pts/2 00:00:00 grep --color=auto tail root 30858 30838 0 15:55 ? 00:00:01 tail -f $ nsenter -t 30858 -n ifconfig eth0: flags=4163 mtu 1480 inet 192.168.1.213 netmask 255.255.255.0 broadcast 192.168.1.255 ether 5e:d5:98:af:dc:6b txqueuelen 0 (Ethernet) RX packets 92 bytes 9100 (8.8 KiB) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 92 bytes 8422 (8.2 KiB) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 lo: flags=73 mtu 65536 inet 127.0.0.1 netmask 255.0.0.0 loop txqueuelen 1000 (Local Loopback) RX packets 5 bytes 448 (448.0 B) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 5 bytes 448 (448.0 B) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 net1: flags=4163 mtu 1500 inet 10.1.0.201 netmask 255.255.255.0 broadcast 10.1.0.255 ether b2:79:f9:dd:2a:10 txqueuelen 0 (Ethernet) RX packets 228 bytes 21272 (20.7 KiB) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 216 bytes 20272 (19.7 KiB) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 如何定位Pod名称空间 首先需要确定Pod所在的节点名称\nbash 1 2 3 4 $ kubectl get pods -owide |awk '{print $1,$7}' NAME NODE netbox-85865d5556-hfg6v master-machine netbox-85865d5556-vlgr4 node01 如果Pod不在当前节点还需要用IP登录则还需要查看IP（可选）\nbash 1 2 3 4 $ kubectl get pods -owide |awk '{print $1,$6,$7}' NAME IP NODE netbox-85865d5556-hfg6v 192.168.1.213 master-machine netbox-85865d5556-vlgr4 192.168.0.4 node01 接下来，登录节点，获取容器lD，如下列所示，每个pod默认有一个 pause 容器，其他为用户yaml文件中定义的容器，理论上所有容器共享相同的网络命名空间，排查时可任选一个容器。\nbash 1 2 3 $ docker ps |grep netbox-85865d5556-hfg6v 6f8c58377aae f78dd05f11ff \"tail -f\" 45 hours ago Up 45 hours k8s_netbox_netbox-85865d5556-hfg6v_default_4a8e2da8-05d1-4c81-97a7-3d76343a323a_0 b9c732ee457e registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1 \"/pause\" 45 hours ago Up 45 hours k8s_POD_netbox-85865d5556-hfg6v_default_4a8e2da8-05d1-4c81-97a7-3d76343a323a_0 接下来获得获取容器在节点系统中对应的进程号，如下所示\nbash 1 2 $ docker inspect --format \"{{ .State.Pid }}\" 6f8c58377aae 30858 最后就可以通过 nsenter 进入容器网络空间执行命令了\npaping paping 命令可对目标地址指定端口以TCP协议进行连续ping，通过这种特性可以弥补 ping ICMP协议，以及 nmap , telnet 只能进行一次操作的的不足；通常情况下会用于测试端口连通性和丢包率\npaping download：paping\npaping 还需要安装以下依赖，这取决于你安装的 paping 版本\nRedHat/CentOS：yum install -y libstdc++.i686 glibc.i686 Ubuntu/Debian：最小化安装无需依赖 bash 1 2 3 4 5 6 7 8 9 10 11 $ paping -h paping v1.5.5 - Copyright (c) 2011 Mike Lovell Syntax: paping [options] destination Options: -?, --help display usage -p, --port N set TCP port N (required) --nocolor Disable color output -t, --timeout timeout in milliseconds (default 1000) -c, --count N set number of checks to N mtr mtr 是一个跨平台的网络诊断工具，将 traceroute 和 ping 的功能结合到一个工具。与 traceroute 不同的是 mtr 显示的信息比起 traceroute 更加丰富：通过 mtr 可以确定网络的条数，并且可以同时打印响应百分比以及网络中各跳跃点的响应时间。\n各系统下的安装 [2]\nUbuntu/Debian: mtr ；apt-get install -y mtr Centos/Fedora: mtr ；yum install -y mtr Apline：mtr ；apk add mtr --no-cache 简单的使用示例 最简单的示例，就是后接域名或IP，这将跟踪整个路由\nbash 1 2 3 4 5 6 7 8 9 10 11 $ mtr google.com Start: Thu Jun 28 12:10:13 2018 HOST: TecMint Loss% Snt Last Avg Best Wrst StDev 1.|-- 192.168.0.1 0.0% 5 0.3 0.3 0.3 0.4 0.0 2.|-- 5.5.5.211 0.0% 5 0.7 0.9 0.7 1.3 0.0 3.|-- 209.snat-111-91-120.hns.n 80.0% 5 7.1 7.1 7.1 7.1 0.0 4.|-- 72.14.194.226 0.0% 5 1.9 2.9 1.9 4.4 1.1 5.|-- 108.170.248.161 0.0% 5 2.9 3.5 2.0 4.3 0.7 6.|-- 216.239.62.237 0.0% 5 3.0 6.2 2.9 18.3 6.7 7.|-- bom05s12-in-f14.1e100.net 0.0% 5 2.1 2.4 2.0 3.8 0.5 -n 强制 mtr 打印 IP地址而不是主机名\nbash 1 2 3 4 5 6 7 8 9 10 11 $ mtr -n google.com Start: Thu Jun 28 12:12:58 2018 HOST: TecMint Loss% Snt Last Avg Best Wrst StDev 1.|-- 192.168.0.1 0.0% 5 0.3 0.3 0.3 0.4 0.0 2.|-- 5.5.5.211 0.0% 5 0.9 0.9 0.8 1.1 0.0 3.|-- ??? 100.0 5 0.0 0.0 0.0 0.0 0.0 4.|-- 72.14.194.226 0.0% 5 2.0 2.0 1.9 2.0 0.0 5.|-- 108.170.248.161 0.0% 5 2.3 2.3 2.2 2.4 0.0 6.|-- 216.239.62.237 0.0% 5 3.0 3.2 3.0 3.3 0.0 7.|-- 172.217.160.174 0.0% 5 3.7 3.6 2.0 5.3 1.4 -b 同时显示IP地址与主机名\nbash 1 2 3 4 5 6 7 8 9 10 11 $ mtr -b google.com Start: Thu Jun 28 12:14:36 2018 HOST: TecMint Loss% Snt Last Avg Best Wrst StDev 1.|-- 192.168.0.1 0.0% 5 0.3 0.3 0.3 0.4 0.0 2.|-- 5.5.5.211 0.0% 5 0.7 0.8 0.6 1.0 0.0 3.|-- 209.snat-111-91-120.hns.n 0.0% 5 1.4 1.6 1.3 2.1 0.0 4.|-- 72.14.194.226 0.0% 5 1.8 2.1 1.8 2.6 0.0 5.|-- 108.170.248.209 0.0% 5 2.0 1.9 1.8 2.0 0.0 6.|-- 216.239.56.115 0.0% 5 2.4 2.7 2.4 2.9 0.0 7.|-- bom07s15-in-f14.1e100.net 0.0% 5 3.7 2.2 1.7 3.7 0.9 -c 跟一个具体的值，这将限制 mtr ping的次数，到达次数后会退出\nbash 1 $ mtr -c5 google.com 如果需要指定次数，并且在退出后保存这些数据，使用 -r flag\nbash 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 $ mtr -r -c 5 google.com \u003e 1 $ cat 1 Start: Sun Aug 21 22:06:49 2022 HOST: xxxxx.xxxxx.xxxx.xxxx Loss% Snt Last Avg Best Wrst StDev 1.|-- gateway 0.0% 5 0.6 146.8 0.6 420.2 191.4 2.|-- 212.xx.21.241 0.0% 5 0.4 1.0 0.4 2.3 0.5 3.|-- 188.xxx.106.124 0.0% 5 0.7 1.1 0.7 2.1 0.5 4.|-- ??? 100.0 5 0.0 0.0 0.0 0.0 0.0 5.|-- 72.14.209.89 0.0% 5 43.2 43.3 43.1 43.3 0.0 6.|-- 108.xxx.250.33 0.0% 5 43.2 43.1 43.1 43.2 0.0 7.|-- 108.xxx.250.34 0.0% 5 43.7 43.6 43.5 43.7 0.0 8.|-- 142.xxx.238.82 0.0% 5 60.6 60.9 60.6 61.2 0.0 9.|-- 142.xxx.238.64 0.0% 5 59.7 67.5 59.3 89.8 13.2 10.|-- 142.xxx.37.81 0.0% 5 62.7 62.9 62.6 63.5 0.0 11.|-- 142.xxx.229.85 0.0% 5 61.0 60.9 60.7 61.3 0.0 12.|-- xx-in-f14.1e100.net 0.0% 5 59.0 58.9 58.9 59.0 0.0 默认使用的是 ICMP 协议 -i ，可以指定 -u, -t 使用其他协议\nbash 1 mtr --tcp google.com -m 指定最大的跳数\nbash 1 mtr -m 35 216.58.223.78 -s 指定包的大小\nmtr输出的数据 colum describe last 最近一次的探测延迟值 avg 探测延迟的平均值 best 探测延迟的最小值 wrst 探测延迟的最大值 stdev 标准偏差。越大说明相应节点越不稳定 丢包判断 任一节点的 Loss%（丢包率）如果不为零，则说明这一跳网络可能存在问题。导致相应节点丢包的原因通常有两种。\n运营商基于安全或性能需求，人为限制了节点的ICMP发送速率，导致丢包。 节点确实存在异常，导致丢包。可以结合异常节点及其后续节点的丢包情况，来判定丢包原因。 Notes:\n如果随后节点均没有丢包，则通常说明异常节点丢包是由于运营商策略限制所致。可以忽略相关丢包。 如果随后节点也出现丢包，则通常说明节点确实存在网络异常，导致丢包。对于这种情况，如果异常节点及其后续节点连续出现丢包，而且各节点的丢包率不同，则通常以最后几跳的丢包率为准。如链路测试在第5、6、7跳均出现了丢包。最终丢包情况以第7跳作为参考。 延迟判断 由于链路抖动或其它因素的影响，节点的 Best 和 Worst 值可能相差很大。而 Avg（平均值）统计了自链路测试以来所有探测的平均值，所以能更好的反应出相应节点的网络质量。而 StDev（标准偏差值）越高，则说明数据包在相应节点的延时值越不相同（越离散）。所以标准偏差值可用于协助判断 Avg 是否真实反应了相应节点的网络质量。例如，如果标准偏差很大，说明数据包的延迟是不确定的。可能某些数据包延迟很小（例如：25ms），而另一些延迟却很大（例如：350ms），但最终得到的平均延迟反而可能是正常的。所以此时 Avg 并不能很好的反应出实际的网络质量情况。\n这就需要结合如下情况进行判断：\n如果 StDev 很高，则同步观察相应节点的 Best 和 wrst，来判断相应节点是否存在异常。 如果StDev 不高，则通过Avg来判断相应节点是否存在异常。 Tips：对于更多的网络工具的使用可以参考这篇文章\nPod网络排查流程 Pod网络异常时排查思路，可以按照下图所示\n图：Pod network exception troubleshooting idea\n案例学习 扩容节点访问service地址不通 测试环境k8s节点扩容后无法访问集群clusterlP类型的registry服务\n环境信息：\nIP Hostname role 10.153.204.15 yxxx-xxx-xxxfu12 worknode节点（本次扩容的问题节点） 10.153.203.14 yxxx-xxx-xxxxfu31 master节点 10.61.187.42 yxxx-xxx-xxxxxxxxf8e9 master节点 10.61.187.48 yxxx-xxx-xxxxxx61e25 master节点（本次registry服务pod所在节点） cni插件：flannel vxlan\nkube-proxy工作模式为iptables\nregistry服务\n单实例部署在10.61.187.48:5000 Pod IP：10.233.65.46， Cluster IP：10.233.0.100 现象：\n所有节点之间的pod通信正常\n任意节点和Pod curl registry的Pod 的 IP:5000 均可以连通\n新扩容节点10.153.204.15 curl registry服务的 Cluster lP 10.233.0.100:5000不通，其他节点curl均可以连通\n分析思路：\n根据现象1可以初步判断 CNI 插件无异常\n根据现象2可以判断 registry 的 Pod 无异常\n根据现象3可以判断 registry 的 service 异常的可能性不大，可能是新扩容节点访问 registry 的 service 存在异常\n怀疑方向：\n问题节点的kube-proxy存在异常 问题节点的iptables规则存在异常 问题节点到service的网络层面存在异常 排查过程：\n排查问题节点的 kube-proxy 执行 kubectl get pod -owide -nkube-system l grep kube-proxy 查看 kube-proxy Pod的状态，问题节点上的 kube-proxy Pod为 running 状态 执行 kubecti logs -nkube-system 查看问题节点 kube-proxy的Pod日志，没有异常报错 在问题节点操作系统上执行 iptables -S -t nat 查看 iptables 规则 排查过程：\n确认存在到 registry 服务的 Cluster lP 10.233.0.100 的 KUBE-SERVICES 链，跳转至 KUBE-SVC-* 链做负载均衡，再跳转至 KUBE-SEP-* 链通过 DNAT 替换为服务后端Pod的IP 10.233.65.46。因此判断iptables规则无异常执行route-n查看问题节点存在访问10.233.65.46所在网段的路由，如图所示\n图：10.233.65.46路由\n查看对端的回程路由\n图：回程路由\n以上排查证明问题原因不是 cni 插件或者 kube-proxy 异常导致，因此需要在访问链路上抓包，判断问题原因、问题节点执行 curl 10.233.0.100:5000，在问题节点和后端pod所在节点的flannel.1上同时抓包发包节点一直在重传，Cluster lP已 DNAT 转换为后端Pod IP，如图所示\n图：抓包过程，发送端\n后端Pod（ registry 服务）所在节点的 flannel.1 上未抓到任何数据包，如图所示\n图：抓包过程，服务端\n请求 service 的 ClusterlP 时，在两端物理机网卡抓包，发包端如图所示，封装的源端节点IP是10.153.204.15，但一直在重传\n图：包传送过程，发送端\n收包端收到了包，但未回包，如图所示\n图：包传送过程，服务端\n由此可以知道，NAT的动作已经完成，而只是后端Pod（ registry 服务）没有回包，接下来在问题节点执行 curl 10.233.65.46:5000，在问题节点和后端（ registry 服务）Pod所在节点的 flannel.1 上同时抓包，两节点收发正常，发包如图所示\n图：正常包发送端\n图：正常包接收端\n接下来在两端物理机网卡接口抓包，因为数据包通过物理机网卡会进行 vxlan 封装，需要抓 vxlan 设备的8472端口，发包端如图所示\n发现网络链路连通，==但封装的IP不对==，封装的源端节点IP是10.153.204.228，但是存在问题节点的IP是10.153.204.15\n图：问题节点物理机网卡接口抓包\n后端Pod所在节点的物理网卡上抓包，注意需要过滤其他正常节点的请求包，如图所示；发现收到的数据包，源地址是10.153.204.228，但是问题节点的IP是10.153.204.15。\n图：对端节点物理机网卡接口抓包\n此时问题以及清楚了，是一个Pod存在两个IP，导致发包和回包时无法通过隧道设备找到对端的接口，所以发可以收到，但不能回。\n问题节点执行ip addr，发现网卡 enp26s0f0上配置了两个IP，如图所示\n图：问题节点IP\n进一步查看网卡配置文件，发现网卡既配置了静态IP，又配置了dhcp动态获取IP。如图所示\n图：问题节点网卡配置\n最终定位原因为问题节点既配置了dhcp 获取IP，又配置了静态IP，导致IP冲突，引发网络异常\n解决方法：修改网卡配置文件 /etc/sysconfig/network-scripts/ifcfg-enp26s0f0 里 BOOTPROTO=\"dhcp\" 为 BOOTPROTO=\"none\"；重启 docker 和 kubelet 问题解决。\n集群外云主机调用集群内应用超时 问题现象：Kubernetes 集群外云主机以 http post 方式访问Kubernetes 集群应用接口超时\n环境信息：Kubernetes 集群：calicoIP-IP模式，应用接口以nodeport方式对外提供服务\n客户端：Kubernetes 集群之外的云主机\n排查过程：\n在云主机telnet应用接口地址和端口，可以连通，证明网络连通正常，如图所示\n云主机上调用接口不通，在云主机和Pod所在 Kubernetes节点同时抓包，使用wireshark分析数据包\n通过抓包结果分析结果为TCP链接建立没有问题，但是在传输大数据的时候会一直重传 **1514 **大小的第一个数据包直至超时。怀疑是链路两端MTU大小不一致导致（现象：某一个固定大小的包一直超时的情况）。如图所示，1514大小的包一直在重传。\n报文1-3 TCP三次握手正常\n报文1 info中MSS字段可以看到MSS协商为1460，MTU=1460+20bytes（IP包头）+20bytes（TCP包头）=1500\n报文7 k8s主机确认了包4的数据包，但是后续再没有对数据的ACK\n报文21-29 可以看到云主机一直在发送后面的数据，但是没有收到k8s节点的ACK，结合pod未收到任何报文，表明是k8s节点和POD通信出现了问题。\n图：wireshark分析\n在云主机上使用 ping -s 指定数据包大小，发现超过1400大小的数据包无法正常发送。结合以上情况，定位是云主机网卡配置的MTU是1500，tunl0 配置的MTU是1440，导致大数据包无法发送至 tunl0 ，因此Pod没有收到报文，接口调用失败。\n解决方法：修改云主机网卡MTU值为1440，或者修改calico的MTU值为1500，保持链路两端MTU值一致。\n集群pod访问对象存储超时 环境信息：公有云环境，Kubernetes 集群节点和对象存储在同一私有网络下，网络链路无防火墙限制k8s集群开启了节点自动弹缩（CA）和Pod自动弹缩（HPA），通过域名访问对象存储，Pod使用集群DNS服务，集群DNS服务配置了用户自建上游DNS服务器\n排查过程：\n使用nsenter工具进入pod容器网络命名空间测试，ping对象存储域名不通，报错unknown server name，ping对象存储lP可以连通。\ntelnet 对象存储80/443端口可以连通。\npaping 对象存储 80/443 端口无丢包。\n为了验证Pod创建好以后的初始阶段网络连通性，将以上测试动作写入dockerfile，重新生成容器镜像并创pod，测试结果一致。\n通过上述步骤，判断Pod网络连通性无异常，超时原因为域名解析失败，怀疑问题如下：\n集群DNS服务存在异常 上游DNS服务存在异常 集群DNS服务与上游DNS通讯异常 pod访问集群DNS服务异常 根据上述方向排查，集群DNS服务状态正常，无报错。测试Pod分别使用集群DNS服务和上游DNS服务解析域名，前者解析失败，后者解析成功。至此，证明上游DNS服务正常，并且集群DNS服务日志中没有与上游DNS通讯超时的报错。定位到的问题：==Pod访问集群DNS服务超时==\n此时发现，出现问题的Pod集中在新弹出的 Kubernetes 节点上。这些节点的 kube-proxy Pod状态全部为pending，没有正常调度到节点上。因此导致该节点上其他Pod无法访问包括 dns 在内的所有Kubernetes service。\n再进一步排查发现 kube-proxy Pod没有配置priorityclass为最高优先级，导致节点资源紧张时为了将高优先级的应用Pod调度到该节点，将原本已运行在该节点的kube-proxy驱逐。\n解决方法：将 kube-proxy 设置 priorityclass 值为 system-node-critical 最高优先级，同时建议应用Pod配置就绪探针，测试可以正常连通对象存储域名后再分配任务。\nReference [1] A tcpdump Tutorial with Examples\n[2] How to install nsenter\n[3] man nsenter\n","wordCount":"1841","inLanguage":"zh","datePublished":"2022-08-17T00:00:00Z","dateModified":"2023-03-22T23:00:36+08:00","author":{"@type":"Person","name":"cylon"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.oomkill.com/2022/08/pod-network-troubleshooting/"},"publisher":{"@type":"Organization","name":"Cylon's Collection","logo":{"@type":"ImageObject","url":"https://www.oomkill.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.oomkill.com/><img src=https://www.oomkill.com/favicon.ico alt aria-label=logo height=20>Cylon's Collection</a><div class=logo-switches><button id=theme-toggle><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://www.oomkill.com/archives><span>归档</span></a></li><li><a href=https://www.oomkill.com/tags><span>标签</span></a></li><li><a href=https://www.oomkill.com/search><span>搜索</span></a></li><li><a href=https://www.oomkill.com/about accesskey=/><span>关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Kubernetes Pod网络排错思路</h1><div class=post-meta><span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar" style="user-select:text"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" style="user-select:text"/><line x1="16" y1="2" x2="16" y2="6" style="user-select:text"/><line x1="8" y1="2" x2="8" y2="6" style="user-select:text"/><line x1="3" y1="10" x2="21" y2="10" style="user-select:text"/></svg><span>2022-08-17</span></span>&nbsp;·&nbsp;<span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text" style="user-select:text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z" style="user-select:text"/><polyline points="14 2 14 8 20 8" style="user-select:text"/><line x1="16" y1="13" x2="8" y2="13" style="user-select:text"/><line x1="16" y1="17" x2="8" y2="17" style="user-select:text"/><polyline points="10 9 9 9 8 9" style="user-select:text"/></svg><span>1841 字</span></span>&nbsp;·&nbsp;<span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><span>9 分钟</span></span>
<span class=pe-post-meta-item>&nbsp;·&nbsp;<svg t="1714036239378" fill="currentcolor" class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="6659" width="256" height="256"><path d="M690 78.2c-18.6-18.8-49-19-67.8-.4s-19 49-.4 67.8l255.4 258.6c67.8 68.6 67.8 178.8.0 247.4L653.4 878.2c-18.6 18.8-18.4 49.2.4 67.8s49.2 18.4 67.8-.4l224-226.4c104.8-106 104.8-276.4.0-382.4L690 78.2zM485.4 101.4c-24-24-56.6-37.4-90.6-37.4H96C43 64 0 107 0 160v299c0 34 13.4 66.6 37.4 90.6l336 336c50 50 131 50 181 0l267-267c50-50 50-131 0-181l-336-336zM96 160h299c8.4.0 16.6 3.4 22.6 9.4l336 336c12.4 12.4 12.4 32.8.0 45.2l-267 267c-12.4 12.4-32.8 12.4-45.2.0l-336-336c-6-6-9.4-14.2-9.4-22.6V160zm192 128a64 64 0 10-128 0 64 64 0 10128 0z" p-id="6660"/></svg></span><ul class=pe-post-meta-item><a href=https://www.oomkill.com/tags/kubernetes-network/>#Kubernetes Network</a>
<a href=https://www.oomkill.com/tags/kubernetes/>#Kubernetes</a></ul></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details><summary><span class=details>目录</span></summary><div class=inner><ul><li><a href=#overview aria-label=Overview>Overview</a><li><a href=#pod%e7%bd%91%e7%bb%9c%e5%bc%82%e5%b8%b8 aria-label=Pod网络异常>Pod网络异常</a><li><a href=#%e5%b8%b8%e7%94%a8%e7%bd%91%e7%bb%9c%e6%8e%92%e6%9f%a5%e5%b7%a5%e5%85%b7 aria-label=常用网络排查工具>常用网络排查工具</a><ul><li><a href=#tcpdump-supa-href11asup aria-label="tcpdump [1]">tcpdump <sup><a href=#1>[1]</a></sup></a><ul><li><a href=#%e6%8d%95%e8%8e%b7%e6%89%80%e6%9c%89%e7%bd%91%e7%bb%9c%e6%8e%a5%e5%8f%a3 aria-label=捕获所有网络接口>捕获所有网络接口</a><li><a href=#%e9%80%9a%e8%bf%87%e7%bd%91%e7%bb%9c%e6%9f%a5%e6%89%be%e6%95%b0%e6%8d%ae%e5%8c%85 aria-label=通过网络查找数据包>通过网络查找数据包</a><li><a href=#%e4%bd%bf%e7%94%a8%e5%8d%81%e5%85%ad%e8%bf%9b%e5%88%b6%e8%be%93%e5%87%ba%e6%95%b0%e6%8d%ae%e5%8c%85%e5%86%85%e5%ae%b9 aria-label=使用十六进制输出数据包内容>使用十六进制输出数据包内容</a><li><a href=#%e6%9f%a5%e7%9c%8b%e7%89%b9%e5%ae%9a%e7%ab%af%e5%8f%a3%e7%9a%84%e6%b5%81%e9%87%8f aria-label=查看特定端口的流量>查看特定端口的流量</a><li><a href=#%e6%9f%a5%e6%89%be%e7%ab%af%e5%8f%a3%e8%8c%83%e5%9b%b4%e7%9a%84%e6%b5%81%e9%87%8f aria-label=查找端口范围的流量>查找端口范围的流量</a><li><a href=#%e8%bf%87%e6%bb%a4%e5%8c%85%e7%9a%84%e5%a4%a7%e5%b0%8f aria-label=过滤包的大小>过滤包的大小</a><li><a href=#%e6%8d%95%e8%8e%b7%e6%b5%81%e9%87%8f%e8%be%93%e5%87%ba%e4%b8%ba%e6%96%87%e4%bb%b6 aria-label=捕获流量输出为文件>捕获流量输出为文件</a><li><a href=#%e7%bb%84%e5%90%88%e6%9d%a1%e4%bb%b6 aria-label=组合条件>组合条件</a><li><a href=#%e5%8e%9f%e5%a7%8b%e8%be%93%e5%87%ba aria-label=原始输出>原始输出</a><li><a href=#ip%e5%88%b0%e7%ab%af%e5%8f%a3 aria-label=IP到端口>IP到端口</a><li><a href=#%e5%8e%bb%e9%99%a4%e7%89%b9%e5%ae%9a%e6%b5%81%e9%87%8f aria-label=去除特定流量>去除特定流量</a><li><a href=#%e9%80%89%e9%a1%b9%e5%88%86%e7%bb%84 aria-label=选项分组>选项分组</a><li><a href=#%e8%bf%87%e6%bb%a4tcp%e6%a0%87%e8%ae%b0%e4%bd%8d aria-label=过滤TCP标记位>过滤TCP标记位</a><li><a href=#%e6%9f%a5%e6%89%behttp%e5%8c%85 aria-label=查找http包>查找http包</a><li><a href=#%e6%9f%a5%e6%89%bedns%e6%b5%81%e9%87%8f aria-label=查找DNS流量>查找DNS流量</a><li><a href=#%e6%9f%a5%e6%89%be%e5%af%b9%e5%ba%94%e6%b5%81%e9%87%8f%e7%9a%84%e6%98%8e%e6%96%87%e5%af%86%e7%a0%81 aria-label=查找对应流量的明文密码>查找对应流量的明文密码</a><li><a href=#wireshark%e8%bf%bd%e8%b8%aa%e6%b5%81 aria-label=wireshark追踪流>wireshark追踪流</a><li><a href=#%e5%85%b3%e4%ba%8e%e6%8a%93%e5%8c%85%e8%8a%82%e7%82%b9%e5%92%8c%e6%8a%93%e5%8c%85%e8%ae%be%e5%a4%87 aria-label=关于抓包节点和抓包设备>关于抓包节点和抓包设备</a></ul><li><a href=#nsenter aria-label=nsenter>nsenter</a><ul><li><a href=#%e5%a6%82%e4%bd%95%e5%ae%9a%e4%bd%8dpod%e5%90%8d%e7%a7%b0%e7%a9%ba%e9%97%b4 aria-label=如何定位Pod名称空间>如何定位Pod名称空间</a></ul><li><a href=#paping aria-label=paping>paping</a><li><a href=#mtr aria-label=mtr>mtr</a><ul><li><a href=#%e7%ae%80%e5%8d%95%e7%9a%84%e4%bd%bf%e7%94%a8%e7%a4%ba%e4%be%8b aria-label=简单的使用示例>简单的使用示例</a><li><a href=#mtr%e8%be%93%e5%87%ba%e7%9a%84%e6%95%b0%e6%8d%ae aria-label=mtr输出的数据>mtr输出的数据</a><li><a href=#%e4%b8%a2%e5%8c%85%e5%88%a4%e6%96%ad aria-label=丢包判断>丢包判断</a><li><a href=#%e5%bb%b6%e8%bf%9f%e5%88%a4%e6%96%ad aria-label=延迟判断>延迟判断</a></ul></ul><li><a href=#pod%e7%bd%91%e7%bb%9c%e6%8e%92%e6%9f%a5%e6%b5%81%e7%a8%8b aria-label=Pod网络排查流程>Pod网络排查流程</a><li><a href=#%e6%a1%88%e4%be%8b%e5%ad%a6%e4%b9%a0 aria-label=案例学习>案例学习</a><ul><li><a href=#%e6%89%a9%e5%ae%b9%e8%8a%82%e7%82%b9%e8%ae%bf%e9%97%aeservice%e5%9c%b0%e5%9d%80%e4%b8%8d%e9%80%9a aria-label=扩容节点访问service地址不通>扩容节点访问service地址不通</a><li><a href=#%e9%9b%86%e7%be%a4%e5%a4%96%e4%ba%91%e4%b8%bb%e6%9c%ba%e8%b0%83%e7%94%a8%e9%9b%86%e7%be%a4%e5%86%85%e5%ba%94%e7%94%a8%e8%b6%85%e6%97%b6 aria-label=集群外云主机调用集群内应用超时>集群外云主机调用集群内应用超时</a><li><a href=#%e9%9b%86%e7%be%a4pod%e8%ae%bf%e9%97%ae%e5%af%b9%e8%b1%a1%e5%ad%98%e5%82%a8%e8%b6%85%e6%97%b6 aria-label=集群pod访问对象存储超时>集群pod访问对象存储超时</a></ul><li><a href=#reference aria-label=Reference>Reference</a></li></div></details></div></aside><script src=/js/pe-toc.min.445eb1bfc5e85dd13b9519fcc2a806522e9629b6224a2974052789ba00ab78af.js integrity="sha256-RF6xv8XoXdE7lRn8wqgGUi6WKbYiSil0BSeJugCreK8="></script><div class=post-content><h2 id=overview>Overview<a hidden class=anchor aria-hidden=true href=#overview>#</a></h2><p>本文将引入一个思路：“在Kubernetes集群发生网络异常时如何排查”。文章将引入Kubernetes 集群中网络排查的思路，包含网络异常模型，常用工具，并且提出一些案例以供学习。</p><ul><li>Pod常见网络异常分类</li><li>网络排查工具</li><li>Pod网络异常排查思路及流程模型</li><li>CNI网络异常排查步骤</li><li>案例学习</li></ul><h2 id=pod网络异常>Pod网络异常<a hidden class=anchor aria-hidden=true href=#pod网络异常>#</a></h2><p>网络异常大概分为如下几类：</p><ul><li><p><strong>网络不可达</strong>，主要现象为ping不通，其可能原因为：</p><ul><li>源端和目的端防火墙（<code>iptables</code>, <code>selinux</code>）限制</li><li>网络路由配置不正确</li><li>源端和目的端的系统负载过高，网络连接数满，网卡队列满</li><li>网络链路故障</li></ul></li><li><p><strong>端口不可达</strong>：主要现象为可以ping通，但telnet端口不通，其可能原因为：</p><ul><li>源端和目的端防火墙限制</li><li>源端和目的端的系统负载过高，网络连接数满，网卡队列满，端口耗尽</li><li>目的端应用未正常监听导致（应用未启动，或监听为127.0.0.1等）</li></ul></li><li><p><strong>DNS解析异常</strong>：主要现象为基础网络可以连通，访问域名报错无法解析，访问IP可以正常连通。其可能原因为</p><ul><li>Pod的DNS配置不正确</li><li>DNS服务异常</li><li>pod与DNS服务通讯异常</li></ul></li><li><p><strong>大数据包丢包</strong>：主要现象为基础网络和端口均可以连通，小数据包收发无异常，大数据包丢包。可能原因为：</p><ul><li>数据包的大小超过了 <em>dockero</em>，<em>CNI</em> 插件，或者宿主机网卡的 <em>MTU</em> 值。<ul><li>可使用 <code>ping -s</code> 指定数据包大小进行测试</li></ul></li></ul></li><li><p><strong>CNI异常</strong>：主要现象为Node可以通，但Pod无法访问集群地址，可能原因有：</p><ul><li><em>kube-proxy</em> 服务异常，没有生成 <em>iptables</em> 策略或者 <em>ipvs</em> 规则导致无法访问</li><li>CIDR耗尽，无法为Node注入 <code>PodCIDR</code> 导致 <em>CNI</em> 插件异常</li><li>其他 <em>CNI</em> 插件问题</li></ul></li></ul><p>那么整个Pod网络异常分类可以如下图所示：</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220821164836806.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220821164836806.png#center alt=image-20220821164836806 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><center>图：Pod network trouble hirarchy</center><br><p>总结一下，Pod最常见的网络故障有，网络不可达（ping不通）；端口不可达（telnet不通）；DNS解析异常（域名不通）与大数据包丢失（大包不通）。</p><h2 id=常用网络排查工具>常用网络排查工具<a hidden class=anchor aria-hidden=true href=#常用网络排查工具>#</a></h2><p>在了解到常见的网络异常后，在排查时就需要使用到一些网络工具才可以很有效的定位到网络故障原因，下面会介绍一些网络排查工具。</p><h3 id=tcpdump-supa-href11asup>tcpdump <sup><a href=#1>[1]</a></sup><a hidden class=anchor aria-hidden=true href=#tcpdump-supa-href11asup>#</a></h3><p>tcpdump网络嗅探器，将强大和简单结合到一个单一的命令行界面中，能够将网络中的报文抓取，输出到屏幕或者记录到文件中。</p><blockquote><p><strong>各系统下的安装</strong></p><ul><li>Ubuntu/Debian: <code>tcpdump</code> ；<code>apt-get install -y tcpdump</code></li><li>Centos/Fedora: <code>tcpdump</code> ；<code>yum install -y tcpdump</code></li><li>Apline：<code>tcpdump </code>；<code>apk add tcpdump --no-cache</code></li></ul></blockquote><p>查看指定接口上的所有通讯</p><p>语法</p><table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td>-i [interface]</td><td></td></tr><tr><td> -w [flle]</td><td>第一个n表示将地址解析为数字格式而不是主机名，第二个N表示将端口解析为数字格式而不是服务名</td></tr><tr><td>-n</td><td>不显示IP地址</td></tr><tr><td>-X</td><td>hex and ASCII</td></tr><tr><td>-A</td><td>ASCII（实际上是以人类可读懂的包进行显示）</td></tr><tr><td>-XX</td><td></td></tr><tr><td>-v</td><td>详细信息</td></tr><tr><td>-r</td><td>读取文件而不是实时抓包</td></tr><tr><td></td><td><strong>关键字</strong></td></tr><tr><td><strong>type</strong></td><td>host（主机名，域名，IP地址）, net, port, portrange</td></tr><tr><td><strong>direction</strong></td><td>src, dst, src or dst , src and ds</td></tr><tr><td><strong>protocol</strong></td><td>ether, ip，arp, tcp, udp, wlan</td></tr></tbody></table><h4 id=捕获所有网络接口>捕获所有网络接口<a hidden class=anchor aria-hidden=true href=#捕获所有网络接口>#</a></h4><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>tcpdump -D</span></span></code></pre></td></tr></table></div></div></div></div><p>####按IP查找流量</p><p>最常见的查询之一 <code>host</code>，可以看到来往于 <code>1.1.1.1</code> 的流量。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>tcpdump host 1.1.1.1</span></span></code></pre></td></tr></table></div></div></div></div><p>####按源/目的 地址过滤</p><p>如果只想查看来自/向某方向流量，可以使用 <code>src</code> 和 <code>dst</code>。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>tcpdump src<span class=p>|</span>dst 1.1.1.1</span></span></code></pre></td></tr></table></div></div></div></div><h4 id=通过网络查找数据包>通过网络查找数据包<a hidden class=anchor aria-hidden=true href=#通过网络查找数据包>#</a></h4><p>使用 <code>net</code> 选项，来要查找出/入某个网络或子网的数据包。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>tcpdump net 1.2.3.0/24</span></span></code></pre></td></tr></table></div></div></div></div><h4 id=使用十六进制输出数据包内容>使用十六进制输出数据包内容<a hidden class=anchor aria-hidden=true href=#使用十六进制输出数据包内容>#</a></h4><p><code>hex</code> 可以以16进制输出包的内容</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>tcpdump -c <span class=m>1</span> -X icmp</span></span></code></pre></td></tr></table></div></div></div></div><h4 id=查看特定端口的流量>查看特定端口的流量<a hidden class=anchor aria-hidden=true href=#查看特定端口的流量>#</a></h4><p>使用 <code>port</code> 选项来查找特定的端口流量。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>tcpdump port <span class=m>3389</span>
</span></span><span class=line><span class=cl>tcpdump src port <span class=m>1025</span></span></span></code></pre></td></tr></table></div></div></div></div><h4 id=查找端口范围的流量>查找端口范围的流量<a hidden class=anchor aria-hidden=true href=#查找端口范围的流量>#</a></h4><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>tcpdump portrange 21-23</span></span></code></pre></td></tr></table></div></div></div></div><h4 id=过滤包的大小>过滤包的大小<a hidden class=anchor aria-hidden=true href=#过滤包的大小>#</a></h4><p>如果需要查找特定大小的数据包，可以使用以下选项。你可以使用 <code>less</code>，<code>greater</code>。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>tcpdump less <span class=m>32</span>
</span></span><span class=line><span class=cl>tcpdump greater <span class=m>64</span>
</span></span><span class=line><span class=cl>tcpdump &lt;<span class=o>=</span> <span class=m>128</span></span></span></code></pre></td></tr></table></div></div></div></div><h4 id=捕获流量输出为文件>捕获流量输出为文件<a hidden class=anchor aria-hidden=true href=#捕获流量输出为文件>#</a></h4><p><code>-w</code> 可以将数据包捕获保存到一个文件中以便将来进行分析。这些文件称为<code>PCAP</code>（PEE-cap）文件，它们可以由不同的工具处理，包括 <code>Wireshark</code> 。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>tcpdump port <span class=m>80</span> -w capture_file</span></span></code></pre></td></tr></table></div></div></div></div><h4 id=组合条件>组合条件<a hidden class=anchor aria-hidden=true href=#组合条件>#</a></h4><p>tcpdump也可以结合逻辑运算符进行组合条件查询</p><ul><li><p><strong>AND</strong>
<em><code>and</code></em> or <code>&&</code></p></li><li><p><strong>OR</strong>
<em><code>or</code></em> or <code>||</code></p></li><li><p><strong>EXCEPT</strong>
<em><code>not</code></em> or <code>!</code></p></li></ul><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>tcpdump -i eth0 -nn host 220.181.57.216 and 10.0.0.1  <span class=c1># 主机之间的通讯</span>
</span></span><span class=line><span class=cl>tcpdump -i eth0 -nn host 220.181.57.216 or 10.0.0.1
</span></span><span class=line><span class=cl><span class=c1># 获取10.0.0.1与 10.0.0.9或 10.0.0.1 与10.0.0.3之间的通讯</span>
</span></span><span class=line><span class=cl>tcpdump -i eth0 -nn host 10.0.0.1 and <span class=se>\(</span>10.0.0.9 or 10.0.0.3<span class=se>\)</span></span></span></code></pre></td></tr></table></div></div></div></div><h4 id=原始输出>原始输出<a hidden class=anchor aria-hidden=true href=#原始输出>#</a></h4><p>并显示人类可读的内容进行输出包（不包含内容）。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>tcpdump -ttnnvvS -i eth0 
</span></span><span class=line><span class=cl>tcpdump -ttnnvvS -i eth0 </span></span></code></pre></td></tr></table></div></div></div></div><h4 id=ip到端口>IP到端口<a hidden class=anchor aria-hidden=true href=#ip到端口>#</a></h4><p>让我们查找从某个IP到端口任何主机的某个端口所有流量。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>tcpdump -nnvvS src 10.5.2.3 and dst port <span class=m>3389</span></span></span></code></pre></td></tr></table></div></div></div></div><h4 id=去除特定流量>去除特定流量<a hidden class=anchor aria-hidden=true href=#去除特定流量>#</a></h4><p>可以将指定的流量排除，如这显示所有到192.168.0.2的 非ICMP的流量。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>tcpdump dst 192.168.0.2 and src net and not icmp</span></span></code></pre></td></tr></table></div></div></div></div><p>来自非指定端口的流量，如，显示来自不是SSH流量的主机的所有流量。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>tcpdump -vv src mars and not dst port <span class=m>22</span></span></span></code></pre></td></tr></table></div></div></div></div><h4 id=选项分组>选项分组<a hidden class=anchor aria-hidden=true href=#选项分组>#</a></h4><p>在构建复杂查询时，必须使用单引号 <code>'</code>。单引号用于忽略特殊符号 <code>()</code> ，以便于使用其他表达式（如host, port, net等）进行分组。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>tcpdump <span class=s1>&#39;src 10.0.2.4 and (dst port 3389 or 22)&#39;</span></span></span></code></pre></td></tr></table></div></div></div></div><h4 id=过滤tcp标记位>过滤TCP标记位<a hidden class=anchor aria-hidden=true href=#过滤tcp标记位>#</a></h4><p>TCP RST</p><p>The filters below find these various packets because tcp[13] looks at offset 13 in the TCP header, the number represents the location within the byte, and the !=0 means that the flag in question is set to 1, i.e. it’s on.</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>tcpdump <span class=s1>&#39;tcp[13] &amp; 4!=0&#39;</span>
</span></span><span class=line><span class=cl>tcpdump <span class=s1>&#39;tcp[tcpflags] == tcp-rst&#39;</span></span></span></code></pre></td></tr></table></div></div></div></div><p>TCP SYN</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>tcpdump <span class=s1>&#39;tcp[13] &amp; 2!=0&#39;</span>
</span></span><span class=line><span class=cl>tcpdump <span class=s1>&#39;tcp[tcpflags] == tcp-syn&#39;</span></span></span></code></pre></td></tr></table></div></div></div></div><p>同时忽略SYN和ACK标志的数据包</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>tcpdump <span class=s1>&#39;tcp[13]=18&#39;</span></span></span></code></pre></td></tr></table></div></div></div></div><p>TCP URG</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>tcpdump <span class=s1>&#39;tcp[13] &amp; 32!=0&#39;</span>
</span></span><span class=line><span class=cl>tcpdump <span class=s1>&#39;tcp[tcpflags] == tcp-urg&#39;</span></span></span></code></pre></td></tr></table></div></div></div></div><p>TCP ACK</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>tcpdump <span class=s1>&#39;tcp[13] &amp; 16!=0&#39;</span>
</span></span><span class=line><span class=cl>tcpdump <span class=s1>&#39;tcp[tcpflags] == tcp-ack&#39;</span></span></span></code></pre></td></tr></table></div></div></div></div><p>TCP PSH</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>tcpdump <span class=s1>&#39;tcp[13] &amp; 8!=0&#39;</span>
</span></span><span class=line><span class=cl>tcpdump <span class=s1>&#39;tcp[tcpflags] == tcp-push&#39;</span></span></span></code></pre></td></tr></table></div></div></div></div><p>TCP FIN</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>tcpdump <span class=s1>&#39;tcp[13] &amp; 1!=0&#39;</span>
</span></span><span class=line><span class=cl>tcpdump <span class=s1>&#39;tcp[tcpflags] == tcp-fin&#39;</span></span></span></code></pre></td></tr></table></div></div></div></div><h4 id=查找http包>查找http包<a hidden class=anchor aria-hidden=true href=#查找http包>#</a></h4><p>查找 <code>user-agent</code> 信息</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>tcpdump -vvAls0 <span class=p>|</span> grep <span class=s1>&#39;User-Agent:&#39;</span></span></span></code></pre></td></tr></table></div></div></div></div><p>查找只是 <code>GET</code> 请求的流量</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>tcpdump -vvAls0 <span class=p>|</span> grep <span class=s1>&#39;GET&#39;</span></span></span></code></pre></td></tr></table></div></div></div></div><p>查找http客户端IP</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>tcpdump -vvAls0 <span class=p>|</span> grep <span class=s1>&#39;Host:&#39;</span></span></span></code></pre></td></tr></table></div></div></div></div><p>查询客户端cookie</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>tcpdump -vvAls0 <span class=p>|</span> grep <span class=s1>&#39;Set-Cookie|Host:|Cookie:&#39;</span></span></span></code></pre></td></tr></table></div></div></div></div><h4 id=查找dns流量>查找DNS流量<a hidden class=anchor aria-hidden=true href=#查找dns流量>#</a></h4><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>tcpdump -vvAs0 port <span class=m>53</span></span></span></code></pre></td></tr></table></div></div></div></div><h4 id=查找对应流量的明文密码>查找对应流量的明文密码<a hidden class=anchor aria-hidden=true href=#查找对应流量的明文密码>#</a></h4><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>tcpdump port http or port ftp or port smtp or port imap or port pop3 or port telnet -lA <span class=p>|</span> egrep -i -B5 <span class=s1>&#39;pass=|pwd=|log=|login=|user=|username=|pw=|passw=|passwd= |password=|pass:|user:|username:|password:|login:|pass |user &#39;</span></span></span></code></pre></td></tr></table></div></div></div></div><h4 id=wireshark追踪流>wireshark追踪流<a hidden class=anchor aria-hidden=true href=#wireshark追踪流>#</a></h4><p>wireshare追踪流可以很好的了解出在一次交互过程中都发生了那些问题。</p><p>wireshare选中包，右键选择 “追踪流“ 如果该包是允许的协议是可以打开该选项的</p><h4 id=关于抓包节点和抓包设备>关于抓包节点和抓包设备<a hidden class=anchor aria-hidden=true href=#关于抓包节点和抓包设备>#</a></h4><p>如何抓取有用的包，以及如何找到对应的接口，有以下建议</p><p><strong>抓包节点</strong>：</p><p>通常情况下会在==源端==和==目的端==两端同时抓包，观察数据包是否从源端正常发出，目的端是否接收到数据包并给源端回包，以及源端是否正常接收到回包。如果有丢包现象，则沿网络链路上各节点抓包排查。例如，A节点经过c节点到B节点，先在AB两端同时抓包，如果B节点未收到A节点的包，则在c节点同时抓包。</p><p><strong>抓包设备</strong>：</p><p>对于 Kubernetes 集群中的Pod，由于容器内不便于抓包，通常视情况在Pod数据包经过的veth设备，<em>docker0</em> 网桥，<em>CNI</em> 插件设备（如cni0，flannel.1 etc..）及Pod所在节点的网卡设备上指定Pod IP进行抓包。选取的设备根据怀疑导致网络问题的原因而定，比如范围由大缩小，从源端逐渐靠近目的端，比如怀疑是 <em>CNI</em> 插件导致，则在 <em>CNI</em> 插件设备上抓包。从pod发出的包逐一经过veth设备，<em>cni0</em> 设备，<em>flannel0</em>，宿主机网卡，到达对端，抓包时可按顺序逐一抓包，定位问题节点。</p><blockquote><p>需要注意在不同设备上抓包时指定的源目IP地址需要转换，如抓取某Pod时，ping <em>{host}</em> 的包，在 <em>veth</em> 和 <em>cni0</em> 上可以指定 Pod IP抓包，而在宿主机网卡上如果仍然指定Pod IP会发现抓不到包，因为此时Pod IP已被转换为宿主机网卡IP。</p></blockquote><p>下图是一个使用 <em>VxLAN</em> 模式的 <em>flannel</em> 的跨界点通讯的网络模型，在抓包时需要注意对应的网络接口</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220821200501496.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220821200501496.png#center alt=image-20220821200501496 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><center>图：VxLAN in kubernetes</center><br><h3 id=nsenter>nsenter<a hidden class=anchor aria-hidden=true href=#nsenter>#</a></h3><p>nsenter是一款可以进入进程的名称空间中。例如，如果一个容器以非 root 用户身份运行，而使用 <code>docker exec</code> 进入其中后，但该容器没有安装 <code>sudo</code> 或未 <code>netstat</code> ，并且您想查看其当前的网络属性，如开放端口，这种场景下将如何做到这一点？<em><strong>nsenter</strong></em> 就是用来解决这个问题的。</p><p><strong>nsenter</strong> (<em>namespace enter</em>) 可以在容器的宿主机上使用 <em>nsenter</em> 命令进入容器的命名空间，以容器视角使用宿主机上的相应网络命令进行操作。==当然需要拥有 <em>root</em> 权限==</p><blockquote><p><strong>各系统下的安装</strong> <sup><a href=#2>[2]</a></sup></p><ul><li>Ubuntu/Debian: <code>util-linux</code> ；<code>apt-get install -y util-linux</code></li><li>Centos/Fedora: <code>util-linux</code> ；<code>yum install -y util-linux</code></li><li>Apline：<code>util-linux</code> ；<code>apk add util-linux --no-cache</code></li></ul></blockquote><p><em>nsenter</em> 的使用语法为，<code>nsenter -t pid -n &lt;commond></code>，<code>-t</code> 接 进程ID号，<code>-n</code> 表示进入名称空间内，<code>&lt;commond></code> 为执行的命令。更多的内容可以参考 <sup><a href=#3>[3]</a></sup></p><p>实例：如我们有一个Pod进程ID为30858，进入该Pod名称空间内执行 <code>ifconfig</code> ，如下列所示</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ ps -ef<span class=p>|</span>grep tail
</span></span><span class=line><span class=cl>root      <span class=m>17636</span>  <span class=m>62887</span>  <span class=m>0</span> 20:19 pts/2    00:00:00 grep --color<span class=o>=</span>auto tail
</span></span><span class=line><span class=cl>root      <span class=m>30858</span>  <span class=m>30838</span>  <span class=m>0</span> 15:55 ?        00:00:01 tail -f
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ nsenter -t <span class=m>30858</span> -n ifconfig
</span></span><span class=line><span class=cl>eth0: <span class=nv>flags</span><span class=o>=</span>4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu <span class=m>1480</span>
</span></span><span class=line><span class=cl>        inet 192.168.1.213  netmask 255.255.255.0  broadcast 192.168.1.255
</span></span><span class=line><span class=cl>        ether 5e:d5:98:af:dc:6b  txqueuelen <span class=m>0</span>  <span class=o>(</span>Ethernet<span class=o>)</span>
</span></span><span class=line><span class=cl>        RX packets <span class=m>92</span>  bytes <span class=m>9100</span> <span class=o>(</span>8.8 KiB<span class=o>)</span>
</span></span><span class=line><span class=cl>        RX errors <span class=m>0</span>  dropped <span class=m>0</span>  overruns <span class=m>0</span>  frame <span class=m>0</span>
</span></span><span class=line><span class=cl>        TX packets <span class=m>92</span>  bytes <span class=m>8422</span> <span class=o>(</span>8.2 KiB<span class=o>)</span>
</span></span><span class=line><span class=cl>        TX errors <span class=m>0</span>  dropped <span class=m>0</span> overruns <span class=m>0</span>  carrier <span class=m>0</span>  collisions <span class=m>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>lo: <span class=nv>flags</span><span class=o>=</span>73&lt;UP,LOOPBACK,RUNNING&gt;  mtu <span class=m>65536</span>
</span></span><span class=line><span class=cl>        inet 127.0.0.1  netmask 255.0.0.0
</span></span><span class=line><span class=cl>        loop  txqueuelen <span class=m>1000</span>  <span class=o>(</span>Local Loopback<span class=o>)</span>
</span></span><span class=line><span class=cl>        RX packets <span class=m>5</span>  bytes <span class=m>448</span> <span class=o>(</span>448.0 B<span class=o>)</span>
</span></span><span class=line><span class=cl>        RX errors <span class=m>0</span>  dropped <span class=m>0</span>  overruns <span class=m>0</span>  frame <span class=m>0</span>
</span></span><span class=line><span class=cl>        TX packets <span class=m>5</span>  bytes <span class=m>448</span> <span class=o>(</span>448.0 B<span class=o>)</span>
</span></span><span class=line><span class=cl>        TX errors <span class=m>0</span>  dropped <span class=m>0</span> overruns <span class=m>0</span>  carrier <span class=m>0</span>  collisions <span class=m>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>net1: <span class=nv>flags</span><span class=o>=</span>4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu <span class=m>1500</span>
</span></span><span class=line><span class=cl>        inet 10.1.0.201  netmask 255.255.255.0  broadcast 10.1.0.255
</span></span><span class=line><span class=cl>        ether b2:79:f9:dd:2a:10  txqueuelen <span class=m>0</span>  <span class=o>(</span>Ethernet<span class=o>)</span>
</span></span><span class=line><span class=cl>        RX packets <span class=m>228</span>  bytes <span class=m>21272</span> <span class=o>(</span>20.7 KiB<span class=o>)</span>
</span></span><span class=line><span class=cl>        RX errors <span class=m>0</span>  dropped <span class=m>0</span>  overruns <span class=m>0</span>  frame <span class=m>0</span>
</span></span><span class=line><span class=cl>        TX packets <span class=m>216</span>  bytes <span class=m>20272</span> <span class=o>(</span>19.7 KiB<span class=o>)</span>
</span></span><span class=line><span class=cl>        TX errors <span class=m>0</span>  dropped <span class=m>0</span> overruns <span class=m>0</span>  carrier <span class=m>0</span>  collisions <span class=m>0</span></span></span></code></pre></td></tr></table></div></div></div></div><h4 id=如何定位pod名称空间>如何定位Pod名称空间<a hidden class=anchor aria-hidden=true href=#如何定位pod名称空间>#</a></h4><p>首先需要确定Pod所在的节点名称</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl get pods -owide <span class=p>|</span>awk <span class=s1>&#39;{print $1,$7}&#39;</span>
</span></span><span class=line><span class=cl>NAME NODE
</span></span><span class=line><span class=cl>netbox-85865d5556-hfg6v master-machine
</span></span><span class=line><span class=cl>netbox-85865d5556-vlgr4 node01</span></span></code></pre></td></tr></table></div></div></div></div><p>如果Pod不在当前节点还需要用IP登录则还需要查看IP（可选）</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl get pods -owide <span class=p>|</span>awk <span class=s1>&#39;{print $1,$6,$7}&#39;</span>
</span></span><span class=line><span class=cl>NAME IP NODE
</span></span><span class=line><span class=cl>netbox-85865d5556-hfg6v 192.168.1.213 master-machine
</span></span><span class=line><span class=cl>netbox-85865d5556-vlgr4 192.168.0.4 node01</span></span></code></pre></td></tr></table></div></div></div></div><p>接下来，登录节点，获取容器lD，如下列所示，每个pod默认有一个 <em>pause</em> 容器，其他为用户yaml文件中定义的容器，理论上所有容器共享相同的网络命名空间，排查时可任选一个容器。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ docker ps <span class=p>|</span>grep netbox-85865d5556-hfg6v
</span></span><span class=line><span class=cl>6f8c58377aae   f78dd05f11ff                                                    <span class=s2>&#34;tail -f&#34;</span>                <span class=m>45</span> hours ago   Up <span class=m>45</span> hours             k8s_netbox_netbox-85865d5556-hfg6v_default_4a8e2da8-05d1-4c81-97a7-3d76343a323a_0
</span></span><span class=line><span class=cl>b9c732ee457e   registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1   <span class=s2>&#34;/pause&#34;</span>                 <span class=m>45</span> hours ago   Up <span class=m>45</span> hours             k8s_POD_netbox-85865d5556-hfg6v_default_4a8e2da8-05d1-4c81-97a7-3d76343a323a_0</span></span></code></pre></td></tr></table></div></div></div></div><p>接下来获得获取容器在节点系统中对应的进程号，如下所示</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ docker inspect --format <span class=s2>&#34;{{ .State.Pid }}&#34;</span> 6f8c58377aae
</span></span><span class=line><span class=cl><span class=m>30858</span></span></span></code></pre></td></tr></table></div></div></div></div><p>最后就可以通过 <em>nsenter</em> 进入容器网络空间执行命令了</p><h3 id=paping>paping<a hidden class=anchor aria-hidden=true href=#paping>#</a></h3><p><strong>paping</strong> 命令可对目标地址指定端口以TCP协议进行连续ping，通过这种特性可以弥补 <em>ping</em> ICMP协议，以及 <em>nmap</em> , <em>telnet</em> 只能进行一次操作的的不足；通常情况下会用于测试端口连通性和丢包率</p><p>paping download：<a href=https://code.google.com/archive/p/paping/ target=_blank rel="noopener nofollow noreferrer">paping</a></p><p><em>paping</em> 还需要安装以下依赖，这取决于你安装的 <em>paping</em> 版本</p><ul><li>RedHat/CentOS：<code>yum install -y libstdc++.i686 glibc.i686</code></li><li>Ubuntu/Debian：最小化安装无需依赖</li></ul><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ paping -h
</span></span><span class=line><span class=cl>paping v1.5.5 - Copyright <span class=o>(</span>c<span class=o>)</span> <span class=m>2011</span> Mike Lovell
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Syntax: paping <span class=o>[</span>options<span class=o>]</span> destination
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Options:
</span></span><span class=line><span class=cl> -?, --help     display usage
</span></span><span class=line><span class=cl> -p, --port N   <span class=nb>set</span> TCP port N <span class=o>(</span>required<span class=o>)</span>
</span></span><span class=line><span class=cl>     --nocolor  Disable color output
</span></span><span class=line><span class=cl> -t, --timeout  timeout in milliseconds <span class=o>(</span>default 1000<span class=o>)</span>
</span></span><span class=line><span class=cl> -c, --count N  <span class=nb>set</span> number of checks to N</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=mtr>mtr<a hidden class=anchor aria-hidden=true href=#mtr>#</a></h3><p><strong>mtr</strong> 是一个跨平台的网络诊断工具，将 <strong>traceroute</strong> 和 <strong>ping</strong> 的功能结合到一个工具。与 <em>traceroute</em> 不同的是 <em>mtr</em> 显示的信息比起 <em>traceroute</em> 更加丰富：通过 <em>mtr</em> 可以确定网络的条数，并且可以同时打印响应百分比以及网络中各跳跃点的响应时间。</p><blockquote><p><strong>各系统下的安装</strong> <sup><a href=#2>[2]</a></sup></p><ul><li>Ubuntu/Debian: <code>mtr</code> ；<code>apt-get install -y mtr</code></li><li>Centos/Fedora: <code>mtr</code> ；<code>yum install -y mtr</code></li><li>Apline：<code>mtr</code> ；<code>apk add mtr --no-cache</code></li></ul></blockquote><h4 id=简单的使用示例>简单的使用示例<a hidden class=anchor aria-hidden=true href=#简单的使用示例>#</a></h4><p>最简单的示例，就是后接域名或IP，这将跟踪整个路由</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ mtr google.com
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Start: Thu Jun <span class=m>28</span> 12:10:13 <span class=m>2018</span>
</span></span><span class=line><span class=cl>HOST: TecMint                     Loss%   Snt   Last   Avg  Best  Wrst StDev
</span></span><span class=line><span class=cl>  1.<span class=p>|</span>-- 192.168.0.1                0.0%     <span class=m>5</span>    0.3   0.3   0.3   0.4   0.0
</span></span><span class=line><span class=cl>  2.<span class=p>|</span>-- 5.5.5.211                  0.0%     <span class=m>5</span>    0.7   0.9   0.7   1.3   0.0
</span></span><span class=line><span class=cl>  3.<span class=p>|</span>-- 209.snat-111-91-120.hns.n 80.0%     <span class=m>5</span>    7.1   7.1   7.1   7.1   0.0
</span></span><span class=line><span class=cl>  4.<span class=p>|</span>-- 72.14.194.226              0.0%     <span class=m>5</span>    1.9   2.9   1.9   4.4   1.1
</span></span><span class=line><span class=cl>  5.<span class=p>|</span>-- 108.170.248.161            0.0%     <span class=m>5</span>    2.9   3.5   2.0   4.3   0.7
</span></span><span class=line><span class=cl>  6.<span class=p>|</span>-- 216.239.62.237             0.0%     <span class=m>5</span>    3.0   6.2   2.9  18.3   6.7
</span></span><span class=line><span class=cl>  7.<span class=p>|</span>-- bom05s12-in-f14.1e100.net  0.0%     <span class=m>5</span>    2.1   2.4   2.0   3.8   0.5</span></span></code></pre></td></tr></table></div></div></div></div><p><code>-n</code> 强制 <em>mtr</em> 打印 IP地址而不是主机名</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ mtr -n google.com
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Start: Thu Jun <span class=m>28</span> 12:12:58 <span class=m>2018</span>
</span></span><span class=line><span class=cl>HOST: TecMint                     Loss%   Snt   Last   Avg  Best  Wrst StDev
</span></span><span class=line><span class=cl>  1.<span class=p>|</span>-- 192.168.0.1                0.0%     <span class=m>5</span>    0.3   0.3   0.3   0.4   0.0
</span></span><span class=line><span class=cl>  2.<span class=p>|</span>-- 5.5.5.211                  0.0%     <span class=m>5</span>    0.9   0.9   0.8   1.1   0.0
</span></span><span class=line><span class=cl>  3.<span class=p>|</span>-- ???                       100.0     <span class=m>5</span>    0.0   0.0   0.0   0.0   0.0
</span></span><span class=line><span class=cl>  4.<span class=p>|</span>-- 72.14.194.226              0.0%     <span class=m>5</span>    2.0   2.0   1.9   2.0   0.0
</span></span><span class=line><span class=cl>  5.<span class=p>|</span>-- 108.170.248.161            0.0%     <span class=m>5</span>    2.3   2.3   2.2   2.4   0.0
</span></span><span class=line><span class=cl>  6.<span class=p>|</span>-- 216.239.62.237             0.0%     <span class=m>5</span>    3.0   3.2   3.0   3.3   0.0
</span></span><span class=line><span class=cl>  7.<span class=p>|</span>-- 172.217.160.174            0.0%     <span class=m>5</span>    3.7   3.6   2.0   5.3   1.4</span></span></code></pre></td></tr></table></div></div></div></div><p><code>-b</code> 同时显示IP地址与主机名</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ mtr -b google.com
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Start: Thu Jun <span class=m>28</span> 12:14:36 <span class=m>2018</span>
</span></span><span class=line><span class=cl>HOST: TecMint                     Loss%   Snt   Last   Avg  Best  Wrst StDev
</span></span><span class=line><span class=cl>  1.<span class=p>|</span>-- 192.168.0.1                0.0%     <span class=m>5</span>    0.3   0.3   0.3   0.4   0.0
</span></span><span class=line><span class=cl>  2.<span class=p>|</span>-- 5.5.5.211                  0.0%     <span class=m>5</span>    0.7   0.8   0.6   1.0   0.0
</span></span><span class=line><span class=cl>  3.<span class=p>|</span>-- 209.snat-111-91-120.hns.n  0.0%     <span class=m>5</span>    1.4   1.6   1.3   2.1   0.0
</span></span><span class=line><span class=cl>  4.<span class=p>|</span>-- 72.14.194.226              0.0%     <span class=m>5</span>    1.8   2.1   1.8   2.6   0.0
</span></span><span class=line><span class=cl>  5.<span class=p>|</span>-- 108.170.248.209            0.0%     <span class=m>5</span>    2.0   1.9   1.8   2.0   0.0
</span></span><span class=line><span class=cl>  6.<span class=p>|</span>-- 216.239.56.115             0.0%     <span class=m>5</span>    2.4   2.7   2.4   2.9   0.0
</span></span><span class=line><span class=cl>  7.<span class=p>|</span>-- bom07s15-in-f14.1e100.net  0.0%     <span class=m>5</span>    3.7   2.2   1.7   3.7   0.9</span></span></code></pre></td></tr></table></div></div></div></div><p><code>-c</code> 跟一个具体的值，这将限制 <em>mtr</em> ping的次数，到达次数后会退出</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ mtr -c5 google.com</span></span></code></pre></td></tr></table></div></div></div></div><p>如果需要指定次数，并且在退出后保存这些数据，使用 <code>-r</code> flag</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ mtr -r -c <span class=m>5</span> google.com &gt;  <span class=m>1</span>
</span></span><span class=line><span class=cl>$ cat <span class=m>1</span>
</span></span><span class=line><span class=cl>Start: Sun Aug <span class=m>21</span> 22:06:49 <span class=m>2022</span>
</span></span><span class=line><span class=cl>HOST: xxxxx.xxxxx.xxxx.xxxx Loss%   Snt   Last   Avg  Best  Wrst StDev
</span></span><span class=line><span class=cl>  1.<span class=p>|</span>-- gateway                    0.0%     <span class=m>5</span>    0.6 146.8   0.6 420.2 191.4
</span></span><span class=line><span class=cl>  2.<span class=p>|</span>-- 212.xx.21.241              0.0%     <span class=m>5</span>    0.4   1.0   0.4   2.3   0.5
</span></span><span class=line><span class=cl>  3.<span class=p>|</span>-- 188.xxx.106.124            0.0%     <span class=m>5</span>    0.7   1.1   0.7   2.1   0.5
</span></span><span class=line><span class=cl>  4.<span class=p>|</span>-- ???                       100.0     <span class=m>5</span>    0.0   0.0   0.0   0.0   0.0
</span></span><span class=line><span class=cl>  5.<span class=p>|</span>-- 72.14.209.89               0.0%     <span class=m>5</span>   43.2  43.3  43.1  43.3   0.0
</span></span><span class=line><span class=cl>  6.<span class=p>|</span>-- 108.xxx.250.33             0.0%     <span class=m>5</span>   43.2  43.1  43.1  43.2   0.0
</span></span><span class=line><span class=cl>  7.<span class=p>|</span>-- 108.xxx.250.34             0.0%     <span class=m>5</span>   43.7  43.6  43.5  43.7   0.0
</span></span><span class=line><span class=cl>  8.<span class=p>|</span>-- 142.xxx.238.82             0.0%     <span class=m>5</span>   60.6  60.9  60.6  61.2   0.0
</span></span><span class=line><span class=cl>  9.<span class=p>|</span>-- 142.xxx.238.64             0.0%     <span class=m>5</span>   59.7  67.5  59.3  89.8  13.2
</span></span><span class=line><span class=cl> 10.<span class=p>|</span>-- 142.xxx.37.81              0.0%     <span class=m>5</span>   62.7  62.9  62.6  63.5   0.0
</span></span><span class=line><span class=cl> 11.<span class=p>|</span>-- 142.xxx.229.85             0.0%     <span class=m>5</span>   61.0  60.9  60.7  61.3   0.0
</span></span><span class=line><span class=cl> 12.<span class=p>|</span>-- xx-in-f14.1e100.net  0.0%     <span class=m>5</span>   59.0  58.9  58.9  59.0   0.0</span></span></code></pre></td></tr></table></div></div></div></div><p>默认使用的是 ICMP 协议 <code>-i</code> ，可以指定 <code>-u</code>, <code>-t</code> 使用其他协议</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mtr --tcp google.com</span></span></code></pre></td></tr></table></div></div></div></div><p><code>-m</code> 指定最大的跳数</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mtr -m <span class=m>35</span> 216.58.223.78</span></span></code></pre></td></tr></table></div></div></div></div><p><code>-s</code> 指定包的大小</p><h4 id=mtr输出的数据>mtr输出的数据<a hidden class=anchor aria-hidden=true href=#mtr输出的数据>#</a></h4><table><thead><tr><th>colum</th><th>describe</th></tr></thead><tbody><tr><td>last</td><td>最近一次的探测延迟值</td></tr><tr><td>avg</td><td>探测延迟的平均值</td></tr><tr><td>best</td><td>探测延迟的最小值</td></tr><tr><td>wrst</td><td>探测延迟的最大值</td></tr><tr><td>stdev</td><td>标准偏差。越大说明相应节点越不稳定</td></tr></tbody></table><h4 id=丢包判断>丢包判断<a hidden class=anchor aria-hidden=true href=#丢包判断>#</a></h4><p>任一节点的 <code>Loss%</code>（丢包率）如果不为零，则说明这一跳网络可能存在问题。导致相应节点丢包的原因通常有两种。</p><ul><li>运营商基于安全或性能需求，人为限制了节点的ICMP发送速率，导致丢包。</li><li>节点确实存在异常，导致丢包。可以结合异常节点及其后续节点的丢包情况，来判定丢包原因。</li></ul><blockquote><p>Notes:</p><ul><li>如果随后节点均没有丢包，则通常说明异常节点丢包是由于运营商策略限制所致。可以忽略相关丢包。</li><li>如果随后节点也出现丢包，则通常说明节点确实存在网络异常，导致丢包。对于这种情况，如果异常节点及其后续节点连续出现丢包，而且各节点的丢包率不同，则通常以最后几跳的丢包率为准。如链路测试在第5、6、7跳均出现了丢包。最终丢包情况以第7跳作为参考。</li></ul></blockquote><h4 id=延迟判断>延迟判断<a hidden class=anchor aria-hidden=true href=#延迟判断>#</a></h4><p>由于链路抖动或其它因素的影响，节点的 <em>Best</em> 和 <em>Worst</em> 值可能相差很大。而 <em>Avg</em>（平均值）统计了自链路测试以来所有探测的平均值，所以能更好的反应出相应节点的网络质量。而 <em>StDev</em>（标准偏差值）越高，则说明数据包在相应节点的延时值越不相同（越离散）。所以标准偏差值可用于协助判断 <em>Avg</em> 是否真实反应了相应节点的网络质量。例如，如果标准偏差很大，说明数据包的延迟是不确定的。可能某些数据包延迟很小（例如：25ms），而另一些延迟却很大（例如：350ms），但最终得到的平均延迟反而可能是正常的。所以此时 <em>Avg</em> 并不能很好的反应出实际的网络质量情况。</p><p>这就需要结合如下情况进行判断：</p><ul><li>如果 <em>StDev</em> 很高，则同步观察相应节点的 <em>Best</em> 和 <em>wrst</em>，来判断相应节点是否存在异常。</li><li>如果<em>StDev</em> 不高，则通过Avg来判断相应节点是否存在异常。</li></ul><blockquote><p>Tips：对于更多的网络工具的使用可以参考这篇<a href=https://www.cnblogs.com/Cylon/p/14946935.html target=_blank rel="noopener nofollow noreferrer">文章</a></p></blockquote><h2 id=pod网络排查流程>Pod网络排查流程<a hidden class=anchor aria-hidden=true href=#pod网络排查流程>#</a></h2><p>Pod网络异常时排查思路，可以按照下图所示</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220821225201747.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220821225201747.png#center alt=image-20220821225201747 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><center>图：Pod network exception troubleshooting idea</center><br><h2 id=案例学习>案例学习<a hidden class=anchor aria-hidden=true href=#案例学习>#</a></h2><h3 id=扩容节点访问service地址不通>扩容节点访问service地址不通<a hidden class=anchor aria-hidden=true href=#扩容节点访问service地址不通>#</a></h3><p><strong>测试环境k8s节点扩容后无法访问集群clusterlP类型的registry服务</strong></p><p>环境信息：</p><table><thead><tr><th>IP</th><th>Hostname</th><th>role</th></tr></thead><tbody><tr><td>10.153.204.15</td><td>yxxx-xxx-xxxfu12</td><td>worknode节点（本次扩容的问题节点）</td></tr><tr><td>10.153.203.14</td><td>yxxx-xxx-xxxxfu31</td><td>master节点</td></tr><tr><td>10.61.187.42</td><td>yxxx-xxx-xxxxxxxxf8e9</td><td>master节点</td></tr><tr><td>10.61.187.48</td><td>yxxx-xxx-xxxxxx61e25</td><td>master节点（本次registry服务pod所在<br>节点）</td></tr></tbody></table><ul><li><p>cni插件：flannel vxlan</p></li><li><p>kube-proxy工作模式为iptables</p></li><li><p>registry服务</p><ul><li>单实例部署在10.61.187.48:5000</li><li>Pod IP：10.233.65.46，</li><li>Cluster IP：10.233.0.100</li></ul></li></ul><p>现象：</p><ul><li><p>所有节点之间的pod通信正常</p></li><li><p>任意节点和Pod curl registry的Pod 的 <em>IP:5000</em> 均可以连通</p></li><li><p>新扩容节点10.153.204.15 curl registry服务的 Cluster lP 10.233.0.100:5000不通，其他节点curl均可以连通</p></li></ul><p>分析思路：</p><ul><li><p>根据现象1可以初步判断 <em>CNI</em> 插件无异常</p></li><li><p>根据现象2可以判断 <em>registry</em> 的 <em>Pod</em> 无异常</p></li><li><p>根据现象3可以判断 <em>registry</em> 的 <em>service</em> 异常的可能性不大，可能是新扩容节点访问 <em>registry</em> 的 <em>service</em> 存在异常</p></li></ul><p>怀疑方向：</p><ul><li>问题节点的kube-proxy存在异常</li><li>问题节点的iptables规则存在异常</li><li>问题节点到service的网络层面存在异常</li></ul><p>排查过程：</p><ul><li>排查问题节点的<code> kube-proxy</code></li><li>执行 <code>kubectl get pod -owide -nkube-system l grep kube-proxy </code>查看 <em>kube-proxy</em> Pod的状态，问题节点上的 <em>kube-proxy</em> Pod为 <em><strong>running</strong></em> 状态</li><li>执行 <code>kubecti logs &lt;nodename> &lt;kube-proxy pod name> -nkube-system</code> 查看问题节点 <em>kube-proxy</em>的Pod日志，没有异常报错</li><li>在问题节点操作系统上执行 <code>iptables -S -t nat</code> 查看 <code>iptables </code>规则</li></ul><p>排查过程：</p><p>确认存在到 <em>registry</em> 服务的 Cluster lP <em>10.233.0.100</em> 的 <em>KUBE-SERVICES</em> 链，跳转至 <em>KUBE-SVC-*</em> 链做负载均衡，再跳转至 <em>KUBE-SEP-*</em> 链通过 <em>DNAT</em> 替换为服务后端Pod的IP 10.233.65.46。因此判断iptables规则无异常执行route-n查看问题节点存在访问10.233.65.46所在网段的路由，如图所示</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220821231943753.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220821231943753.png#center alt=image-20220821231943753 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><center>图：10.233.65.46路由</center><br><p>查看对端的回程路由</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220821232111046.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220821232111046.png#center alt=image-20220821232111046 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><center>图：回程路由</center><br><p>以上排查证明问题原因不是 <em>cni</em> 插件或者 <em>kube-proxy</em> 异常导致，因此需要在访问链路上抓包，判断问题原因、问题节点执行 <code>curl 10.233.0.100:5000</code>，在问题节点和后端pod所在节点的flannel.1上同时抓包发包节点一直在重传，Cluster lP已 <em>DNAT</em> 转换为后端Pod IP，如图所示</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220821231845672.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220821231845672.png#center alt=image-20220821231845672 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><center>图：抓包过程，发送端</center><br><p>后端Pod（ <em>registry</em> 服务）所在节点的 <em>flannel.1</em> 上未抓到任何数据包，如图所示</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220821231730846.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220821231730846.png#center alt=image-20220821231730846 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><center>图：抓包过程，服务端</center><br><p>请求 <em>service</em> 的 <em>ClusterlP</em> 时，在两端物理机网卡抓包，发包端如图所示，封装的源端节点IP是10.153.204.15，但一直在重传</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220821232249344.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220821232249344.png#center alt=image-20220821232249344 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><center>图：包传送过程，发送端</center><br><p>收包端收到了包，但未回包，如图所示</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220821232338410.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220821232338410.png#center alt=image-20220821232338410 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><center>图：包传送过程，服务端</center><br><p>由此可以知道，NAT的动作已经完成，而只是后端Pod（ <em>registry</em> 服务）没有回包，接下来在问题节点执行 <code>curl 10.233.65.46:5000</code>，在问题节点和后端（ <em>registry</em> 服务）Pod所在节点的 <em>flannel.1</em> 上同时抓包，两节点收发正常，发包如图所示</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220821232550959.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220821232550959.png#center alt=image-20220821232550959 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><center>图：正常包发送端</center><br><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220821232827589.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220821232827589.png#center alt=image-20220821232827589 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><center>图：正常包接收端</center><br><p>接下来在两端物理机网卡接口抓包，因为数据包通过物理机网卡会进行 <em>vxlan</em> 封装，需要抓 <em>vxlan</em> 设备的8472端口，发包端如图所示</p><p>发现网络链路连通，==但封装的IP不对==，封装的源端节点IP是10.153.204.228，但是存在问题节点的IP是10.153.204.15</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220821233107112.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220821233107112.png#center alt=image-20220821233107112 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><center>图：问题节点物理机网卡接口抓包</center><br><p>后端Pod所在节点的物理网卡上抓包，注意需要过滤其他正常节点的请求包，如图所示；发现收到的数据包，源地址是10.153.204.228，但是问题节点的IP是10.153.204.15。</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220821233258211.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220821233258211.png#center alt=image-20220821233258211 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><center>图：对端节点物理机网卡接口抓包</center><br><p>此时问题以及清楚了，是一个Pod存在两个IP，导致发包和回包时无法通过隧道设备找到对端的接口，所以发可以收到，但不能回。</p><p>问题节点执行<code>ip addr</code>，发现网卡 <em>enp26s0f0</em>上配置了两个IP，如图所示</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220821233642903.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220821233642903.png#center alt=image-20220821233642903 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><center>图：问题节点IP</center><br><p>进一步查看网卡配置文件，发现网卡既配置了静态IP，又配置了dhcp动态获取IP。如图所示</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220821233741211.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220821233741211.png#center alt=image-20220821233741211 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><center>图：问题节点网卡配置</center><br><p>最终定位原因为问题节点既配置了dhcp 获取IP，又配置了静态IP，导致IP冲突，引发网络异常</p><p>解决方法：修改网卡配置文件 <code>/etc/sysconfig/network-scripts/ifcfg-enp26s0f0</code> 里 <code>BOOTPROTO="dhcp"</code>
为 <code>BOOTPROTO="none"</code>；重启 <em>docker</em> 和 <em>kubelet</em> 问题解决。</p><h3 id=集群外云主机调用集群内应用超时>集群外云主机调用集群内应用超时<a hidden class=anchor aria-hidden=true href=#集群外云主机调用集群内应用超时>#</a></h3><p>问题现象：Kubernetes 集群外云主机以 http post 方式访问Kubernetes 集群应用接口超时</p><p>环境信息：Kubernetes 集群：calicoIP-IP模式，应用接口以nodeport方式对外提供服务</p><p>客户端：Kubernetes 集群之外的云主机</p><p>排查过程：</p><ul><li><p>在云主机telnet应用接口地址和端口，可以连通，证明网络连通正常，如图所示</p></li><li><p>云主机上调用接口不通，在云主机和Pod所在 Kubernetes节点同时抓包，使用wireshark分析数据包</p></li></ul><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220821234238398.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220821234238398.png#center alt=image-20220821234238398 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><p>通过抓包结果分析结果为TCP链接建立没有问题，但是在传输大数据的时候会一直重传 **1514 **大小的第一个数据包直至超时。怀疑是链路两端MTU大小不一致导致（现象：某一个固定大小的包一直超时的情况）。如图所示，1514大小的包一直在重传。</p><p>报文1-3 TCP三次握手正常</p><p>报文1 info中MSS字段可以看到MSS协商为1460，MTU=1460+20bytes（IP包头）+20bytes（TCP包头）=1500</p><p>报文7 k8s主机确认了包4的数据包，但是后续再没有对数据的ACK</p><p>报文21-29 可以看到云主机一直在发送后面的数据，但是没有收到k8s节点的ACK，结合pod未收到任何报文，表明是k8s节点和POD通信出现了问题。</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220821234410926.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220821234410926.png#center alt=image-20220821234410926 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><center>图：wireshark分析</center><br><p>在云主机上使用 <code>ping -s</code> 指定数据包大小，发现超过1400大小的数据包无法正常发送。结合以上情况，定位是云主机网卡配置的MTU是1500，<em>tunl0</em> 配置的MTU是1440，导致大数据包无法发送至 <em>tunl0</em> ，因此Pod没有收到报文，接口调用失败。</p><p>解决方法：修改云主机网卡MTU值为1440，或者修改calico的MTU值为1500，保持链路两端MTU值一致。</p><h3 id=集群pod访问对象存储超时>集群pod访问对象存储超时<a hidden class=anchor aria-hidden=true href=#集群pod访问对象存储超时>#</a></h3><p>环境信息：公有云环境，Kubernetes 集群节点和对象存储在同一私有网络下，网络链路无防火墙限制k8s集群开启了节点自动弹缩（CA）和Pod自动弹缩（HPA），通过域名访问对象存储，Pod使用集群DNS服务，集群DNS服务配置了用户自建上游DNS服务器</p><p>排查过程：</p><ul><li><p>使用nsenter工具进入pod容器网络命名空间测试，ping对象存储域名不通，报错unknown server name，ping对象存储lP可以连通。</p></li><li><p><code>telnet</code> 对象存储80/443端口可以连通。</p></li><li><p><code>paping</code> 对象存储 80/443 端口无丢包。</p></li><li><p>为了验证Pod创建好以后的初始阶段网络连通性，将以上测试动作写入dockerfile，重新生成容器镜像并创pod，测试结果一致。</p></li></ul><p>通过上述步骤，判断Pod网络连通性无异常，超时原因为域名解析失败，怀疑问题如下：</p><ul><li>集群DNS服务存在异常</li><li>上游DNS服务存在异常</li><li>集群DNS服务与上游DNS通讯异常</li><li>pod访问集群DNS服务异常</li></ul><p>根据上述方向排查，集群DNS服务状态正常，无报错。测试Pod分别使用集群DNS服务和上游DNS服务解析域名，前者解析失败，后者解析成功。至此，证明上游DNS服务正常，并且集群DNS服务日志中没有与上游DNS通讯超时的报错。定位到的问题：==Pod访问集群DNS服务超时==</p><p>此时发现，出现问题的Pod集中在新弹出的 Kubernetes 节点上。这些节点的 <code>kube-proxy</code> Pod状态全部为<em>pending</em>，没有正常调度到节点上。因此导致该节点上其他Pod无法访问包括 dns 在内的所有Kubernetes service。</p><p>再进一步排查发现 <code>kube-proxy</code> Pod没有配置priorityclass为最高优先级，导致节点资源紧张时为了将高优先级的应用Pod调度到该节点，将原本已运行在该节点的kube-proxy驱逐。</p><p>解决方法：将 <code>kube-proxy</code> 设置 <code>priorityclass</code> 值为 <code>system-node-critical</code> 最高优先级，同时建议应用Pod配置就绪探针，测试可以正常连通对象存储域名后再分配任务。</p><h2 id=reference>Reference<a hidden class=anchor aria-hidden=true href=#reference>#</a></h2><blockquote><p><sup id=1>[1]</sup> <a href=https://danielmiessler.com/study/tcpdump/#basic-communication target=_blank rel="noopener nofollow noreferrer"><em>A tcpdump Tutorial with Examples</em></a></p><p><sup id=2>[2]</sup> <a href=https://laramatic.com/how-to-install-nsenter-in-debian-ubuntu-alpine-arch-kali-centos-fedora-raspbian-and-macos/ target=_blank rel="noopener nofollow noreferrer"><em>How to install nsenter</em></a></p><p><sup id=3>[3]</sup> <a href=https://man7.org/linux/man-pages/man1/nsenter.1.html target=_blank rel="noopener nofollow noreferrer"><em>man nsenter</em></a></p></blockquote></div><div class=pe-copyright><hr><blockquote><p>本文为原创内容，版权归作者所有。如需转载，请在文章中声明本文标题及链接。</p><p>文章标题：Kubernetes Pod网络排错思路</p><p>文章链接：<a href=https://www.oomkill.com/2022/08/pod-network-troubleshooting/ target=_blank>https://www.oomkill.com/2022/08/pod-network-troubleshooting/</a></p><p>许可协议：<a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></p></blockquote></div><div class=comments-separator></div><h3 class=relatedContentTitle>相关阅读</h3><ul class=relatedContent><li><a href=/2022/08/kubernetes-network-model/><span>详述Kubernetes网络模型</span></a></li><li><a href=/2021/02/calico-network-policy/><span>calico网络策略</span></a></li><li><a href=/2021/01/network-tunnel-technology/><span>网络隧道技术</span></a></li><li><a href=/2021/01/ensp-calico-bgp/><span>使用eNSP构建calico BGP网络</span></a></li><li><a href=/2021/02/calico-deploy-on-hybrid-cloud/><span>基于混合云模式的calico部署</span></a></li></ul><div class=comments-separator></div><footer class=post-footer><ul class=post-tags><li><a href=https://www.oomkill.com/tags/kubernetes-network/>Kubernetes Network</a></li><li><a href=https://www.oomkill.com/tags/kubernetes/>Kubernetes</a></li></ul><nav class=paginav><a class=prev href=https://www.oomkill.com/2022/08/ch10-token-bucket-algorithm/><span class=title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left" style="user-select:text"><line x1="19" y1="12" x2="5" y2="12" style="user-select:text"/><polyline points="12 19 5 12 12 5" style="user-select:text"/></polyline></svg>&nbsp;</span>
<span>漏桶算法与令牌桶算法</span>
</a><a class=next href=https://www.oomkill.com/2022/08/kubernetes-network-model/><span class=title></span>
<span>详述Kubernetes网络模型&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right" style="user-select:text"><line x1="5" y1="12" x2="19" y2="12" style="user-select:text"/><polyline points="12 5 19 12 12 19" style="user-select:text"/></svg></span></a></nav></footer><div class=pe-comments-decoration><p class=pe-comments-title></p><p class=pe-comments-subtitle></p></div><div id=pe-comments></div><script src=/js/pe-go-comment.min.86a214102576ba5f9b7bdc29eed8d58dd56e34aef80b3c65c73ea9cc88443696.js integrity="sha256-hqIUECV2ul+be9wp7tjVjdVuNK74Czxlxz6pzIhENpY="></script><script>const getStoredTheme=()=>localStorage.getItem("pref-theme")==="dark"?"dark":"light",setGiscusTheme=()=>{const e=e=>{const t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:e},"https://giscus.app")};e({setConfig:{theme:getStoredTheme()}})};document.addEventListener("DOMContentLoaded",()=>{const s={src:"https://giscus.app/client.js","data-repo":"cylonchau/cylonchau.github.io","data-repo-id":"R_kgDOIRlNSQ","data-category":"Announcements","data-category-id":"DIC_kwDOIRlNSc4CXy1U","data-mapping":"pathname","data-term":"posts/Pod network troubleshooting","data-strict":"0","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"top","data-theme":getStoredTheme(),"data-lang":"zh-TW","data-loading":"lazy",crossorigin:"anonymous",async:""},e=document.createElement("script");Object.entries(s).forEach(([t,n])=>e.setAttribute(t,n)),document.querySelector("#pe-comments").appendChild(e);const t=document.querySelector("#theme-toggle");t&&t.addEventListener("click",setGiscusTheme);const n=document.querySelector("#theme-toggle-float");n&&n.addEventListener("click",setGiscusTheme)})</script></article></main><footer class=footer><span>&copy; 2024 <a href=https://www.oomkill.com/>Cylon's Collection</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> on
<a href=https://pages.github.com/ rel=noopener target=_blank>GitHub Pages</a> & Theme
        <a href=https://github.com/tofuwine/PaperMod-PE rel=noopener target=_blank>PaperMod-PE</a></span></footer><div class=pe-right-sidebar><a href=javascript:void(0); id=theme-toggle-float class=pe-float-btn><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</a><a href=#top class=pe-float-btn id=top-link><span id=pe-read-progress></span></a></div><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>