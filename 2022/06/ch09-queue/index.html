<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>源码分析client-go架构 - queue | Cylon's Collection</title>
<meta name=keywords content="kubernetes,develop"><meta name=description content="通用队列 在kubernetes中，使用go的channel无法满足kubernetes的应用场景，如延迟、限速等；在kubernetes中存在三种队列通用队列 common queue ，延迟队列 delaying queue，和限速队列 rate limiters queue
Inferface Interface作为所有队列的一个抽象定义
go 1 2 3 4 5 6 7 8 type Interface interface { Add(item interface{}) Len() int Get() (item interface{}, shutdown bool) Done(item interface{}) ShutDown() ShuttingDown() bool } Implementation go 1 2 3 4 5 6 7 8 9 10 11 12 13 type Type struct { // 一个work queue queue []t // queue用slice做存储 dirty set // 脏位，定义了需要处理的元素，类似于操作系统，表示已修改但为写入 processing set // 当前正在处理的元素集合 cond *sync."><meta name=author content="cylon"><link rel=canonical href=https://www.oomkill.com/2022/06/ch09-queue/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://www.oomkill.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.oomkill.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.oomkill.com/favicon-32x32.png><link rel=apple-touch-icon href=https://www.oomkill.com/favicon.ico><link rel=mask-icon href=https://www.oomkill.com/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://www.oomkill.com/2022/06/ch09-queue/><noscript><style>#theme-toggle,#top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link crossorigin=anonymous href=/assets/css/pe.min.css rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/pe.min.js></script><link rel=stylesheet href=https://cdn.staticfile.net/font-awesome/6.5.1/css/all.min.css><link rel=stylesheet href=https://cdn.staticfile.net/font-awesome/6.5.1/css/v4-shims.min.css><script defer src=https://cdn.staticfile.net/jquery/3.5.1/jquery.min.js></script><link rel=stylesheet href=https://cdn.staticfile.net/fancybox/3.5.7/jquery.fancybox.min.css><script defer src=https://cdn.staticfile.net/fancybox/3.5.7/jquery.fancybox.min.js></script><script id=MathJax-script async src=https://cdn.staticfile.net/mathjax/3.2.2/es5/tex-chtml.js></script><script>MathJax={tex:{displayMath:[["$$","$$"]],inlineMath:[["\\$","\\$"]]}}</script><meta property="og:title" content="源码分析client-go架构 - queue"><meta property="og:description" content="通用队列 在kubernetes中，使用go的channel无法满足kubernetes的应用场景，如延迟、限速等；在kubernetes中存在三种队列通用队列 common queue ，延迟队列 delaying queue，和限速队列 rate limiters queue
Inferface Interface作为所有队列的一个抽象定义
go 1 2 3 4 5 6 7 8 type Interface interface { Add(item interface{}) Len() int Get() (item interface{}, shutdown bool) Done(item interface{}) ShutDown() ShuttingDown() bool } Implementation go 1 2 3 4 5 6 7 8 9 10 11 12 13 type Type struct { // 一个work queue queue []t // queue用slice做存储 dirty set // 脏位，定义了需要处理的元素，类似于操作系统，表示已修改但为写入 processing set // 当前正在处理的元素集合 cond *sync."><meta property="og:type" content="article"><meta property="og:url" content="https://www.oomkill.com/2022/06/ch09-queue/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-06-17T00:00:00+00:00"><meta property="article:modified_time" content="2023-03-18T23:00:36+08:00"><meta property="og:site_name" content="Cylon's Collection"><meta name=twitter:card content="summary"><meta name=twitter:title content="源码分析client-go架构 - queue"><meta name=twitter:description content="通用队列 在kubernetes中，使用go的channel无法满足kubernetes的应用场景，如延迟、限速等；在kubernetes中存在三种队列通用队列 common queue ，延迟队列 delaying queue，和限速队列 rate limiters queue
Inferface Interface作为所有队列的一个抽象定义
go 1 2 3 4 5 6 7 8 type Interface interface { Add(item interface{}) Len() int Get() (item interface{}, shutdown bool) Done(item interface{}) ShutDown() ShuttingDown() bool } Implementation go 1 2 3 4 5 6 7 8 9 10 11 12 13 type Type struct { // 一个work queue queue []t // queue用slice做存储 dirty set // 脏位，定义了需要处理的元素，类似于操作系统，表示已修改但为写入 processing set // 当前正在处理的元素集合 cond *sync."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://www.oomkill.com/posts/"},{"@type":"ListItem","position":2,"name":"源码分析client-go架构 - queue","item":"https://www.oomkill.com/2022/06/ch09-queue/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"源码分析client-go架构 - queue","name":"源码分析client-go架构 - queue","description":"通用队列 在kubernetes中，使用go的channel无法满足kubernetes的应用场景，如延迟、限速等；在kubernetes中存在三种队列通用队列 common queue ，延迟队列 delaying queue，和限速队列 rate limiters queue\nInferface Interface作为所有队列的一个抽象定义\ngo 1 2 3 4 5 6 7 8 type Interface interface { Add(item interface{}) Len() int Get() (item interface{}, shutdown bool) Done(item interface{}) ShutDown() ShuttingDown() bool } Implementation go 1 2 3 4 5 6 7 8 9 10 11 12 13 type Type struct { // 一个work queue queue []t // queue用slice做存储 dirty set // 脏位，定义了需要处理的元素，类似于操作系统，表示已修改但为写入 processing set // 当前正在处理的元素集合 cond *sync.","keywords":["kubernetes","develop"],"articleBody":"通用队列 在kubernetes中，使用go的channel无法满足kubernetes的应用场景，如延迟、限速等；在kubernetes中存在三种队列通用队列 common queue ，延迟队列 delaying queue，和限速队列 rate limiters queue\nInferface Interface作为所有队列的一个抽象定义\ngo 1 2 3 4 5 6 7 8 type Interface interface { Add(item interface{}) Len() int Get() (item interface{}, shutdown bool) Done(item interface{}) ShutDown() ShuttingDown() bool } Implementation go 1 2 3 4 5 6 7 8 9 10 11 12 13 type Type struct { // 一个work queue queue []t // queue用slice做存储 dirty set // 脏位，定义了需要处理的元素，类似于操作系统，表示已修改但为写入 processing set // 当前正在处理的元素集合 cond *sync.Cond shuttingDown bool metrics queueMetrics unfinishedWorkUpdatePeriod time.Duration clock clock.Clock } type empty struct{} type t interface{} // t queue中的元素 type set map[t]empty // dirty 和 processing中的元素 可以看到其中核心属性就是 queue , dirty , processing\n延迟队列 在研究优先级队列前，需要对 Heap 有一定的了解，因为delay queue使用了 heap 做延迟队列\nHeap Heap 是基于树属性的特殊数据结构；heap是一种完全二叉树类型，具有两种类型：\n如：B 是 A 的子节点，则 $key(A) \\geq key(B)$ 。这就意味着具有最大Key的元素始终位于根节点，这类Heap称为最大堆 MaxHeap。 父节点的值小于或等于其左右子节点的值叫做 MinHeap 二叉堆的存储规则：\n每个节点包含的元素大于或等于该节点子节点的元素。 树是完全二叉树。 那么下列图片中，那个是堆\nheap的实现\n实例：向左边添加一个值为42的元素的过程 步骤一：将新元素放入堆中的第一个可用位置。这将使结构保持为完整的二叉树，但它可能不再是堆，因为新元素可能具有比其父元素更大的值。\n步骤二：如果新元素的值大于父元素，将新元素与父元素交换，直到达到新元素到根，或者新元素大于等于其父元素的值时将停止\n这种过程被称为 向上调整 （reheapification upward）\n实例：移除根 步骤一：将根元素复制到用于返回值的变量中，将最深层的最后一个元素复制到根，然后将最后一个节点从树中取出。该元素称为 out-of-place 。\n步骤二：而将异位元素与其最大值的子元素交换，并返回在步骤1中保存的值。\n这个过程被称为向下调整 （reheapification downward）\n优先级队列 优先级队列的行为：\n元素被放置在队列中，然后被取出。 优先级队列中的每个元素都有一个关联的数字，称为优先级。 当元素离开优先级队列时，最高优先级的元素最先离开。 如何实现的：\n在优先级队列中，heap的每个节点都包含一个元素以及元素的优先级，并且维护树以便它遵循使用元素的优先级来比较节点的堆存储规则：\n每个节点包含的元素的优先级大于或等于该节点子元素的优先级。 树是完全二叉树。 实现的代码：golang priorityQueue\nReference\nheap\nClient-go 的延迟队列 在Kubernetes中对 delaying queue 的设计非常精美，通过使用 heap 实现的延迟队列，加上kubernetes中的通过队列，完成了延迟队列的功能。\ngo 1 2 3 4 5 // 注释中给了一个hot-loop热循环，通过这个loop实现了delaying type DelayingInterface interface { Interface // 继承了workqueue的功能 AddAfter(item interface{}, duration time.Duration) // 在time后将内容添加到工作队列中 } 具体实现了 DelayingInterface 的实例\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 type delayingType struct { Interface // 通用的queue clock clock.Clock // 对比的时间 ，包含一些定时器的功能 type Clock interface { PassiveClock type PassiveClock interface { Now() time.Time Since(time.Time) time.Duration } After(time.Duration) \u003c-chan time.Time NewTimer(time.Duration) Timer Sleep(time.Duration) NewTicker(time.Duration) Ticker } stopCh chan struct{} // 停止loop stopOnce sync.Once // 保证退出只会触发一次 heartbeat clock.Ticker // 一个定时器，保证了loop的最大空事件等待时间 waitingForAddCh chan *waitFor // 普通的chan，用来接收数据插入到延迟队列中 metrics retryMetrics // 重试的指数 } 那么延迟队列的整个数据结构如下图所示\n而上面部分也说到了，这个延迟队列的核心就是一个优先级队列，而优先级队列又需要满足：\n优先级队列中的每个元素都有一个关联的数字，称为优先级。 当元素离开优先级队列时，最高优先级的元素最先离开。 而 waitFor 就是这个优先级队列的数据结构\ngo 1 2 3 4 5 type waitFor struct { data t // 数据 readyAt time.Time // 加入工作队列的时间 index int // 优先级队列中的索引 } 而 waitForPriorityQueue 是对 container/heap/heap.go.Inferface 的实现，其数据结构就是使最小 readyAt 位于Root 的一个 MinHeap\ngo 1 2 3 4 5 type Interface interface { sort.Interface Push(x interface{}) // add x as element Len() Pop() interface{} // remove and return element Len() - 1. } 而这个的实现是 waitForPriorityQueue\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 type waitForPriorityQueue []*waitFor func (pq waitForPriorityQueue) Len() int { return len(pq) } // 这个也是最重要的一个，就是哪个属性是排序的关键，也是heap.down和heap.up中使用的 func (pq waitForPriorityQueue) Less(i, j int) bool { return pq[i].readyAt.Before(pq[j].readyAt) } func (pq waitForPriorityQueue) Swap(i, j int) { pq[i], pq[j] = pq[j], pq[i] pq[i].index = i pq[j].index = j } // push 和pop 必须使用heap.push 和heap.pop func (pq *waitForPriorityQueue) Push(x interface{}) { n := len(*pq) item := x.(*waitFor) item.index = n *pq = append(*pq, item) } func (pq *waitForPriorityQueue) Pop() interface{} { n := len(*pq) item := (*pq)[n-1] item.index = -1 *pq = (*pq)[0:(n - 1)] return item } // Peek returns the item at the beginning of the queue, without removing the // item or otherwise mutating the queue. It is safe to call directly. func (pq waitForPriorityQueue) Peek() interface{} { return pq[0] } 而整个延迟队列的核心就是 waitingLoop，作为了延迟队列的主要逻辑，检查 waitingForAddCh 有没有要延迟的内容，取出延迟的内容放置到 Heap 中；以及保证最大的阻塞周期\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 func (q *delayingType) waitingLoop() { defer utilruntime.HandleCrash() never := make(\u003c-chan time.Time) // 作为占位符 var nextReadyAtTimer clock.Timer // 最近一个任务要执行的定时器 waitingForQueue := \u0026waitForPriorityQueue{} // 优先级队列，heap heap.Init(waitingForQueue) waitingEntryByData := map[t]*waitFor{} // 检查是否反复添加 for { if q.Interface.ShuttingDown() { return } now := q.clock.Now() for waitingForQueue.Len() \u003e 0 { entry := waitingForQueue.Peek().(*waitFor) if entry.readyAt.After(now) { break // 时间没到则不处理 } entry = heap.Pop(waitingForQueue).(*waitFor) // 从优先级队列中取出一个 q.Add(entry.data) // 添加到延迟队列中 delete(waitingEntryByData, entry.data) // 删除map表中的数据 } // 如果存在数据则设置最近一个内容要执行的定时器 nextReadyAt := never if waitingForQueue.Len() \u003e 0 { if nextReadyAtTimer != nil { nextReadyAtTimer.Stop() } entry := waitingForQueue.Peek().(*waitFor) // 窥视[0]和值 nextReadyAtTimer = q.clock.NewTimer(entry.readyAt.Sub(now)) // 创建一个定时器 nextReadyAt = nextReadyAtTimer.C() } select { case \u003c-q.stopCh: // 退出 return case \u003c-q.heartbeat.C(): // 多久没有任何动作时重新一次循环 case \u003c-nextReadyAt: // 如果有元素时间到了，则继续执行循环，处理上面添加的操作 case waitEntry := \u003c-q.waitingForAddCh: if waitEntry.readyAt.After(q.clock.Now()) { // 时间没到，是用readyAt和now对比time.Now // 添加到延迟队列中，有两个 waitingEntryByData waitingForQueue insert(waitingForQueue, waitingEntryByData, waitEntry) } else { q.Add(waitEntry.data) } drained := false // 保证可以取完q.waitingForAddCh // addafter for !drained { select { // 这里是一个有buffer的队列，需要保障这个队列读完 case waitEntry := \u003c-q.waitingForAddCh: if waitEntry.readyAt.After(q.clock.Now()) { insert(waitingForQueue, waitingEntryByData, waitEntry) } else { q.Add(waitEntry.data) } default: // 保证可以退出，但限制于上一个分支的0~n的读取 // 如果上一个分支阻塞，则为没有数据就是取尽了，走到这个分支 // 如果上个分支不阻塞则读取到上个分支阻塞为止，代表阻塞，则走default退出 drained = true } } } } } 限速队列 限速队列 RateLimiting 是在优先级队列是在延迟队列的基础上进行扩展的一个队列\ngo 1 2 3 4 5 6 7 8 9 type RateLimitingInterface interface { DelayingInterface // 继承延迟队列 // 在限速器准备完成后（即合规后）添加条目到队列中 AddRateLimited(item interface{}) // drop掉条目，无论成功或失败 Forget(item interface{}) // 被重新放入队列中的次数 NumRequeues(item interface{}) int } 可以看到一个限速队列的抽象对应只要满足了 AddRateLimited() , Forget() , NumRequeues() 的延迟队列都是限速队列。看了解规则之后，需要对具体的实现进行分析。\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 type rateLimitingType struct { DelayingInterface rateLimiter RateLimiter } func (q *rateLimitingType) AddRateLimited(item interface{}) { q.DelayingInterface.AddAfter(item, q.rateLimiter.When(item)) } func (q *rateLimitingType) NumRequeues(item interface{}) int { return q.rateLimiter.NumRequeues(item) } func (q *rateLimitingType) Forget(item interface{}) { q.rateLimiter.Forget(item) } rateLimitingType 则是对抽象规范 RateLimitingInterface 的实现，可以看出是在延迟队列的基础上增加了一个限速器 RateLimiter\ngo 1 2 3 4 5 6 7 8 9 type RateLimiter interface { // when决定等待多长时间 When(item interface{}) time.Duration // drop掉item // or for success, we'll stop tracking it Forget(item interface{}) // 重新加入队列中的次数 NumRequeues(item interface{}) int } 抽象限速器的实现，有 BucketRateLimiter , ItemBucketRateLimiter , ItemExponentialFailureRateLimiter , ItemFastSlowRateLimiter , MaxOfRateLimiter ，下面对这些限速器进行分析\nBucketRateLimiter BucketRateLimiter 是实现 rate.Limiter 与 抽象 RateLimiter 的一个令牌桶，初始化时通过 workqueue.DefaultControllerRateLimiter() 进行初始化。\ngo 1 2 3 4 5 6 7 func DefaultControllerRateLimiter() RateLimiter { return NewMaxOfRateLimiter( NewItemExponentialFailureRateLimiter(5*time.Millisecond, 1000*time.Second), // 10 qps, 100 bucket size. This is only for retry speed and its only the overall factor (not per item) \u0026BucketRateLimiter{Limiter: rate.NewLimiter(rate.Limit(10), 100)}, ) } 更多关于令牌桶算法可以参考这里\nItemBucketRateLimiter ItemBucketRateLimiter 是作为列表存储每个令牌桶的实现，每个key都是单独的限速器\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 type ItemBucketRateLimiter struct { r rate.Limit burst int limitersLock sync.Mutex limiters map[interface{}]*rate.Limiter } func NewItemBucketRateLimiter(r rate.Limit, burst int) *ItemBucketRateLimiter { return \u0026ItemBucketRateLimiter{ r: r, burst: burst, limiters: make(map[interface{}]*rate.Limiter), } } ItemExponentialFailureRateLimiter 如名所知 ItemExponentialFailureRateLimiter 限速器是一个错误指数限速器，根据错误的次数，将指数用于delay的时长，指数的计算公式为：$baseDelay\\times2^{}$。 可以看出When绝定了流量整形的delay时间，根据错误次数为指数进行延长重试时间\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 type ItemExponentialFailureRateLimiter struct { failuresLock sync.Mutex failures map[interface{}]int // 失败的次数 baseDelay time.Duration // 延迟基数 maxDelay time.Duration // 最大延迟 } func (r *ItemExponentialFailureRateLimiter) When(item interface{}) time.Duration { r.failuresLock.Lock() defer r.failuresLock.Unlock() exp := r.failures[item] r.failures[item] = r.failures[item] + 1 // The backoff is capped such that 'calculated' value never overflows. backoff := float64(r.baseDelay.Nanoseconds()) * math.Pow(2, float64(exp)) if backoff \u003e math.MaxInt64 { return r.maxDelay } calculated := time.Duration(backoff) if calculated \u003e r.maxDelay { return r.maxDelay } return calculated } func (r *ItemExponentialFailureRateLimiter) NumRequeues(item interface{}) int { r.failuresLock.Lock() defer r.failuresLock.Unlock() return r.failures[item] } func (r *ItemExponentialFailureRateLimiter) Forget(item interface{}) { r.failuresLock.Lock() defer r.failuresLock.Unlock() delete(r.failures, item) } ItemFastSlowRateLimiter ItemFastSlowRateLimiter ，限速器先快速重试一定次数，然后慢速重试\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 type ItemFastSlowRateLimiter struct { failuresLock sync.Mutex failures map[interface{}]int maxFastAttempts int // 最大尝试次数 fastDelay time.Duration // 快的速度 slowDelay time.Duration // 慢的速度 } func NewItemFastSlowRateLimiter(fastDelay, slowDelay time.Duration, maxFastAttempts int) RateLimiter { return \u0026ItemFastSlowRateLimiter{ failures: map[interface{}]int{}, fastDelay: fastDelay, slowDelay: slowDelay, maxFastAttempts: maxFastAttempts, } } func (r *ItemFastSlowRateLimiter) When(item interface{}) time.Duration { r.failuresLock.Lock() defer r.failuresLock.Unlock() r.failures[item] = r.failures[item] + 1 // 当错误次数没超过快速的阈值使用快速，否则使用慢速 if r.failures[item] \u003c= r.maxFastAttempts { return r.fastDelay } return r.slowDelay } func (r *ItemFastSlowRateLimiter) NumRequeues(item interface{}) int { r.failuresLock.Lock() defer r.failuresLock.Unlock() return r.failures[item] } func (r *ItemFastSlowRateLimiter) Forget(item interface{}) { r.failuresLock.Lock() defer r.failuresLock.Unlock() delete(r.failures, item) } MaxOfRateLimiter MaxOfRateLimiter 是返回限速器列表中，延迟最大的那个限速器\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 type MaxOfRateLimiter struct { limiters []RateLimiter } func (r *MaxOfRateLimiter) When(item interface{}) time.Duration { ret := time.Duration(0) for _, limiter := range r.limiters { curr := limiter.When(item) if curr \u003e ret { ret = curr } } return ret } func NewMaxOfRateLimiter(limiters ...RateLimiter) RateLimiter { return \u0026MaxOfRateLimiter{limiters: limiters} } func (r *MaxOfRateLimiter) NumRequeues(item interface{}) int { ret := 0 // 找到列表內所有的NumRequeues（失败的次数），以最多次的为主。 for _, limiter := range r.limiters { curr := limiter.NumRequeues(item) if curr \u003e ret { ret = curr } } return ret } func (r *MaxOfRateLimiter) Forget(item interface{}) { for _, limiter := range r.limiters { limiter.Forget(item) } } 如何使用Kubernetes的限速器 基于流量管制的限速队列实例，可以大量突发，但是需要进行整形，添加操作会根据 When() 中设计的需要等待的时间进行添加。根据不同的队列实现不同方式的延迟\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 package main import ( \"fmt\" \"log\" \"strconv\" \"time\" \"k8s.io/client-go/util/workqueue\" ) func main() { stopCh := make(chan string) timeLayout := \"2006-01-02:15:04:05.0000\" limiter := workqueue.NewRateLimitingQueue(workqueue.DefaultControllerRateLimiter()) length := 20 // 一共请求20次 chs := make([]chan string, length) for i := 0; i \u003c length; i++ { chs[i] = make(chan string, 1) go func(taskId string, ch chan string) { item := \"Task-\" + taskId + time.Now().Format(timeLayout) log.Println(item + \" Added.\") limiter.AddRateLimited(item) // 添加会根据When() 延迟添加到工作队列中 }(strconv.FormatInt(int64(i), 10), chs[i]) go func() { for { key, quit := limiter.Get() if quit { return } log.Println(fmt.Sprintf(\"%s process done\", key)) defer limiter.Done(key) } }() } \u003c-stopCh } 因为默认的限速器不支持初始化 QPS，修改源码内的为 $BT(1, 5)$ ，执行结果可以看出，大突发流量时，超过桶内token数时，会根据token生成的速度进行放行。\n图中，任务的添加是突发性的，日志打印的是同时添加，但是在添加前输出的日志，消费端可以看到实际是被延迟了。配置的是每秒一个token，实际上放行流量也是每秒一个token。\n","wordCount":"1593","inLanguage":"zh","datePublished":"2022-06-17T00:00:00Z","dateModified":"2023-03-18T23:00:36+08:00","author":{"@type":"Person","name":"cylon"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.oomkill.com/2022/06/ch09-queue/"},"publisher":{"@type":"Organization","name":"Cylon's Collection","logo":{"@type":"ImageObject","url":"https://www.oomkill.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.oomkill.com/><img src=https://www.oomkill.com/favicon.ico alt aria-label=logo height=20>Cylon's Collection</a><div class=logo-switches><button id=theme-toggle><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://www.oomkill.com/archives><span>归档</span></a></li><li><a href=https://www.oomkill.com/tags><span>标签</span></a></li><li><a href=https://www.oomkill.com/search><span>搜索</span></a></li><li><a href=https://www.oomkill.com/about accesskey=/><span>关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">源码分析client-go架构 - queue</h1><div class=post-meta><span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar" style="user-select:text"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" style="user-select:text"/><line x1="16" y1="2" x2="16" y2="6" style="user-select:text"/><line x1="8" y1="2" x2="8" y2="6" style="user-select:text"/><line x1="3" y1="10" x2="21" y2="10" style="user-select:text"/></svg><span>2022-06-17</span></span>&nbsp;·&nbsp;<span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text" style="user-select:text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z" style="user-select:text"/><polyline points="14 2 14 8 20 8" style="user-select:text"/><line x1="16" y1="13" x2="8" y2="13" style="user-select:text"/><line x1="16" y1="17" x2="8" y2="17" style="user-select:text"/><polyline points="10 9 9 9 8 9" style="user-select:text"/></svg><span>1593 字</span></span>&nbsp;·&nbsp;<span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><span>8 分钟</span></span>
<span class=pe-post-meta-item>&nbsp;·&nbsp;<svg t="1714036239378" fill="currentcolor" class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="6659" width="256" height="256"><path d="M690 78.2c-18.6-18.8-49-19-67.8-.4s-19 49-.4 67.8l255.4 258.6c67.8 68.6 67.8 178.8.0 247.4L653.4 878.2c-18.6 18.8-18.4 49.2.4 67.8s49.2 18.4 67.8-.4l224-226.4c104.8-106 104.8-276.4.0-382.4L690 78.2zM485.4 101.4c-24-24-56.6-37.4-90.6-37.4H96C43 64 0 107 0 160v299c0 34 13.4 66.6 37.4 90.6l336 336c50 50 131 50 181 0l267-267c50-50 50-131 0-181l-336-336zM96 160h299c8.4.0 16.6 3.4 22.6 9.4l336 336c12.4 12.4 12.4 32.8.0 45.2l-267 267c-12.4 12.4-32.8 12.4-45.2.0l-336-336c-6-6-9.4-14.2-9.4-22.6V160zm192 128a64 64 0 10-128 0 64 64 0 10128 0z" p-id="6660"/></svg></span><ul class=pe-post-meta-item><a href=https://www.oomkill.com/tags/kubernetes-develop/>#Kubernetes Develop</a>
<a href=https://www.oomkill.com/tags/kubernetes/>#Kubernetes</a></ul></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details><summary><span class=details>目录</span></summary><div class=inner><ul><li><a href=#%e9%80%9a%e7%94%a8%e9%98%9f%e5%88%97 aria-label=通用队列>通用队列</a><ul><li><a href=#inferface aria-label=Inferface>Inferface</a><li><a href=#implementation aria-label=Implementation>Implementation</a></ul><li><a href=#%e5%bb%b6%e8%bf%9f%e9%98%9f%e5%88%97 aria-label=延迟队列>延迟队列</a><ul><li><a href=#heap aria-label=Heap>Heap</a><ul><li><a href=#%e5%ae%9e%e4%be%8b%e5%90%91%e5%b7%a6%e8%be%b9%e6%b7%bb%e5%8a%a0%e4%b8%80%e4%b8%aa%e5%80%bc%e4%b8%ba42%e7%9a%84%e5%85%83%e7%b4%a0%e7%9a%84%e8%bf%87%e7%a8%8b aria-label=实例：向左边添加一个值为42的元素的过程>实例：向左边添加一个值为42的元素的过程</a><li><a href=#%e5%ae%9e%e4%be%8b%e7%a7%bb%e9%99%a4%e6%a0%b9 aria-label=实例：移除根>实例：移除根</a></ul><li><a href=#%e4%bc%98%e5%85%88%e7%ba%a7%e9%98%9f%e5%88%97 aria-label=优先级队列>优先级队列</a><li><a href=#client-go-%e7%9a%84%e5%bb%b6%e8%bf%9f%e9%98%9f%e5%88%97 aria-label="Client-go 的延迟队列">Client-go 的延迟队列</a></ul><li><a href=#%e9%99%90%e9%80%9f%e9%98%9f%e5%88%97 aria-label=限速队列>限速队列</a><ul><li><a href=#bucketratelimiter aria-label=BucketRateLimiter>BucketRateLimiter</a><li><a href=#itembucketratelimiter aria-label=ItemBucketRateLimiter>ItemBucketRateLimiter</a><li><a href=#itemexponentialfailureratelimiter aria-label=ItemExponentialFailureRateLimiter>ItemExponentialFailureRateLimiter</a><li><a href=#itemfastslowratelimiter aria-label=ItemFastSlowRateLimiter>ItemFastSlowRateLimiter</a><li><a href=#maxofratelimiter aria-label=MaxOfRateLimiter>MaxOfRateLimiter</a><li><a href=#%e5%a6%82%e4%bd%95%e4%bd%bf%e7%94%a8kubernetes%e7%9a%84%e9%99%90%e9%80%9f%e5%99%a8 aria-label=如何使用Kubernetes的限速器>如何使用Kubernetes的限速器</a></li></div></details></div></aside><script src=/js/pe-toc.min.445eb1bfc5e85dd13b9519fcc2a806522e9629b6224a2974052789ba00ab78af.js integrity="sha256-RF6xv8XoXdE7lRn8wqgGUi6WKbYiSil0BSeJugCreK8="></script><div class=post-content><h2 id=通用队列>通用队列<a hidden class=anchor aria-hidden=true href=#通用队列>#</a></h2><p>在kubernetes中，使用go的channel无法满足kubernetes的应用场景，如延迟、限速等；在kubernetes中存在三种队列通用队列 <code>common queue</code> ，延迟队列 <code>delaying queue</code>，和限速队列 <code>rate limiters queue</code></p><h3 id=inferface>Inferface<a hidden class=anchor aria-hidden=true href=#inferface>#</a></h3><p>Interface作为所有队列的一个抽象定义</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Interface</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nf>Add</span><span class=p>(</span><span class=nx>item</span> <span class=kd>interface</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>	<span class=nf>Len</span><span class=p>()</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl>	<span class=nf>Get</span><span class=p>()</span> <span class=p>(</span><span class=nx>item</span> <span class=kd>interface</span><span class=p>{},</span> <span class=nx>shutdown</span> <span class=kt>bool</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nf>Done</span><span class=p>(</span><span class=nx>item</span> <span class=kd>interface</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>	<span class=nf>ShutDown</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nf>ShuttingDown</span><span class=p>()</span> <span class=kt>bool</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><h3 id=implementation>Implementation<a hidden class=anchor aria-hidden=true href=#implementation>#</a></h3><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Type</span> <span class=kd>struct</span> <span class=p>{</span> <span class=c1>// 一个work queue
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>queue</span> <span class=p>[]</span><span class=nx>t</span> <span class=c1>// queue用slice做存储
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>dirty</span> <span class=nx>set</span> <span class=c1>// 脏位，定义了需要处理的元素，类似于操作系统，表示已修改但为写入
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>processing</span> <span class=nx>set</span> <span class=c1>// 当前正在处理的元素集合
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>cond</span> <span class=o>*</span><span class=nx>sync</span><span class=p>.</span><span class=nx>Cond</span>
</span></span><span class=line><span class=cl>	<span class=nx>shuttingDown</span> <span class=kt>bool</span>
</span></span><span class=line><span class=cl>	<span class=nx>metrics</span> <span class=nx>queueMetrics</span>
</span></span><span class=line><span class=cl>	<span class=nx>unfinishedWorkUpdatePeriod</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span>
</span></span><span class=line><span class=cl>	<span class=nx>clock</span>                      <span class=nx>clock</span><span class=p>.</span><span class=nx>Clock</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>empty</span> <span class=kd>struct</span><span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>t</span> <span class=kd>interface</span><span class=p>{}</span> <span class=c1>// t queue中的元素
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>set</span> <span class=kd>map</span><span class=p>[</span><span class=nx>t</span><span class=p>]</span><span class=nx>empty</span> <span class=c1>// dirty 和 processing中的元素
</span></span></span></code></pre></td></tr></table></div></div></div></div><p>可以看到其中核心属性就是 <code>queue</code> , <code>dirty</code> , <code>processing</code></p><h2 id=延迟队列>延迟队列<a hidden class=anchor aria-hidden=true href=#延迟队列>#</a></h2><p>在研究优先级队列前，需要对 <code>Heap</code> 有一定的了解，因为delay queue使用了 <code>heap</code> 做延迟队列</p><h3 id=heap>Heap<a hidden class=anchor aria-hidden=true href=#heap>#</a></h3><p><code>Heap</code> 是基于树属性的特殊数据结构；heap是一种完全二叉树类型，具有两种类型：</p><ul><li>如：B 是 A 的子节点，则 $key(A) \geq key(B)$ 。这就意味着具有最大Key的元素始终位于根节点，这类Heap称为最大堆 <strong>MaxHeap</strong>。</li><li>父节点的值小于或等于其左右子节点的值叫做 <strong>MinHeap</strong></li></ul><p>二叉堆的存储规则：</p><ul><li>每个节点包含的元素大于或等于该节点子节点的元素。</li><li>树是完全二叉树。</li></ul><p>那么下列图片中，那个是堆</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/f.10.1.jpeg><img src=https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/f.10.1.jpeg#center alt=img onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><p>heap的实现</p><h4 id=实例向左边添加一个值为42的元素的过程>实例：向左边添加一个值为42的元素的过程<a hidden class=anchor aria-hidden=true href=#实例向左边添加一个值为42的元素的过程>#</a></h4><p><strong>步骤一</strong>：将新元素放入堆中的第一个可用位置。这将使结构保持为完整的二叉树，但它可能不再是堆，因为新元素可能具有比其父元素更大的值。</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/reheap1.jpeg><img src=https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/reheap1.jpeg#center alt=img onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><p><strong>步骤二</strong>：如果新元素的值大于父元素，将新元素与父元素交换，直到达到新元素到根，或者新元素大于等于其父元素的值时将停止</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/reheap2.jpeg><img src=https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/reheap2.jpeg#center alt=img onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><p>这种过程被称为 <strong>向上调整</strong> （<code>reheapification upward</code>）</p><h4 id=实例移除根>实例：移除根<a hidden class=anchor aria-hidden=true href=#实例移除根>#</a></h4><p><strong>步骤一</strong>：将根元素复制到用于返回值的变量中，将最深层的最后一个元素复制到根，然后将最后一个节点从树中取出。该元素称为 <code>out-of-place</code> 。</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/reheap3.jpeg><img src=https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/reheap3.jpeg#center alt=img onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><p><strong>步骤二</strong>：而将异位元素与其最大值的子元素交换，并返回在步骤1中保存的值。</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/reheap4.jpeg><img src=https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/reheap4.jpeg#center alt=img onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><p>这个过程被称为<strong>向下调整</strong> （<code>reheapification downward</code>）</p><h3 id=优先级队列>优先级队列<a hidden class=anchor aria-hidden=true href=#优先级队列>#</a></h3><p>优先级队列的行为：</p><ul><li>元素被放置在队列中，然后被取出。</li><li>优先级队列中的每个元素都有一个关联的数字，称为优先级。</li><li>当元素离开优先级队列时，最高优先级的元素最先离开。</li></ul><p>如何实现的：</p><ul><li><p>在优先级队列中，heap的每个节点都包含一个元素以及元素的优先级，并且维护树以便它遵循使用元素的优先级来比较节点的堆存储规则：</p><ul><li>每个节点包含的元素的优先级大于或等于该节点子元素的优先级。</li><li>树是完全二叉树。</li></ul></li><li><p>实现的代码：<a href=https://pkg.go.dev/container/heap#example__priorityQueue target=_blank rel="noopener nofollow noreferrer">golang priorityQueue</a></p></li></ul><blockquote><p>Reference</p><p><a href=https://www.cpp.edu/~ftang/courses/CS241/notes/heap.htm target=_blank rel="noopener nofollow noreferrer">heap</a></p></blockquote><h3 id=client-go-的延迟队列>Client-go 的延迟队列<a hidden class=anchor aria-hidden=true href=#client-go-的延迟队列>#</a></h3><p>在Kubernetes中对 <code>delaying queue</code> 的设计非常精美，通过使用 <code>heap</code> 实现的延迟队列，加上kubernetes中的通过队列，完成了延迟队列的功能。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 注释中给了一个hot-loop热循环，通过这个loop实现了delaying
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>DelayingInterface</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>Interface</span> <span class=c1>// 继承了workqueue的功能
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>AddAfter</span><span class=p>(</span><span class=nx>item</span> <span class=kd>interface</span><span class=p>{},</span> <span class=nx>duration</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span><span class=p>)</span> <span class=c1>// 在time后将内容添加到工作队列中
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>具体实现了 <code>DelayingInterface</code> 的实例</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>delayingType</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>Interface</span> <span class=c1>// 通用的queue 
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>clock</span> <span class=nx>clock</span><span class=p>.</span><span class=nx>Clock</span> <span class=c1>// 对比的时间 ，包含一些定时器的功能
</span></span></span><span class=line><span class=cl><span class=c1></span>    	<span class=kd>type</span> <span class=nx>Clock</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>PassiveClock</span>
</span></span><span class=line><span class=cl>            		<span class=kd>type</span> <span class=nx>PassiveClock</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=nf>Now</span><span class=p>()</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span>
</span></span><span class=line><span class=cl>                        <span class=nf>Since</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>)</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=nf>After</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span><span class=p>)</span> <span class=o>&lt;-</span><span class=kd>chan</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span>
</span></span><span class=line><span class=cl>            <span class=nf>NewTimer</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span><span class=p>)</span> <span class=nx>Timer</span>
</span></span><span class=line><span class=cl>            <span class=nf>Sleep</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nf>NewTicker</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span><span class=p>)</span> <span class=nx>Ticker</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>stopCh</span> <span class=kd>chan</span> <span class=kd>struct</span><span class=p>{}</span> <span class=c1>// 停止loop
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>stopOnce</span> <span class=nx>sync</span><span class=p>.</span><span class=nx>Once</span> <span class=c1>// 保证退出只会触发一次
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>heartbeat</span> <span class=nx>clock</span><span class=p>.</span><span class=nx>Ticker</span> <span class=c1>// 一个定时器，保证了loop的最大空事件等待时间
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>waitingForAddCh</span> <span class=kd>chan</span> <span class=o>*</span><span class=nx>waitFor</span> <span class=c1>// 普通的chan，用来接收数据插入到延迟队列中
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>metrics</span> <span class=nx>retryMetrics</span> <span class=c1>// 重试的指数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>那么延迟队列的整个数据结构如下图所示</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220527215559879.png><img src=https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220527215559879.png#center alt=image-20220527215559879 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><p>而上面部分也说到了，这个延迟队列的核心就是一个优先级队列，而优先级队列又需要满足：</p><ul><li>优先级队列中的每个元素都有一个关联的数字，称为优先级。</li><li>当元素离开优先级队列时，最高优先级的元素最先离开。</li></ul><p>而 <code>waitFor</code> 就是这个优先级队列的数据结构</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>waitFor</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>data</span>    <span class=nx>t</span> <span class=c1>// 数据
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>readyAt</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span> <span class=c1>// 加入工作队列的时间
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>index</span> <span class=kt>int</span> <span class=c1>// 优先级队列中的索引
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>而 <code>waitForPriorityQueue</code> 是对 <code>container/heap/heap.go.Inferface</code> 的实现，其数据结构就是使最小 <code>readyAt</code> 位于Root 的一个 <code>MinHeap</code></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Interface</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>sort</span><span class=p>.</span><span class=nx>Interface</span>
</span></span><span class=line><span class=cl>	<span class=nf>Push</span><span class=p>(</span><span class=nx>x</span> <span class=kd>interface</span><span class=p>{})</span> <span class=c1>// add x as element Len()
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>Pop</span><span class=p>()</span> <span class=kd>interface</span><span class=p>{}</span>   <span class=c1>// remove and return element Len() - 1.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>而这个的实现是 <code>waitForPriorityQueue</code></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>waitForPriorityQueue</span> <span class=p>[]</span><span class=o>*</span><span class=nx>waitFor</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>pq</span> <span class=nx>waitForPriorityQueue</span><span class=p>)</span> <span class=nf>Len</span><span class=p>()</span> <span class=kt>int</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nb>len</span><span class=p>(</span><span class=nx>pq</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 这个也是最重要的一个，就是哪个属性是排序的关键，也是heap.down和heap.up中使用的
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>pq</span> <span class=nx>waitForPriorityQueue</span><span class=p>)</span> <span class=nf>Less</span><span class=p>(</span><span class=nx>i</span><span class=p>,</span> <span class=nx>j</span> <span class=kt>int</span><span class=p>)</span> <span class=kt>bool</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>pq</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>readyAt</span><span class=p>.</span><span class=nf>Before</span><span class=p>(</span><span class=nx>pq</span><span class=p>[</span><span class=nx>j</span><span class=p>].</span><span class=nx>readyAt</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>pq</span> <span class=nx>waitForPriorityQueue</span><span class=p>)</span> <span class=nf>Swap</span><span class=p>(</span><span class=nx>i</span><span class=p>,</span> <span class=nx>j</span> <span class=kt>int</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>pq</span><span class=p>[</span><span class=nx>i</span><span class=p>],</span> <span class=nx>pq</span><span class=p>[</span><span class=nx>j</span><span class=p>]</span> <span class=p>=</span> <span class=nx>pq</span><span class=p>[</span><span class=nx>j</span><span class=p>],</span> <span class=nx>pq</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>	<span class=nx>pq</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>index</span> <span class=p>=</span> <span class=nx>i</span>
</span></span><span class=line><span class=cl>	<span class=nx>pq</span><span class=p>[</span><span class=nx>j</span><span class=p>].</span><span class=nx>index</span> <span class=p>=</span> <span class=nx>j</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// push 和pop 必须使用heap.push 和heap.pop
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>pq</span> <span class=o>*</span><span class=nx>waitForPriorityQueue</span><span class=p>)</span> <span class=nf>Push</span><span class=p>(</span><span class=nx>x</span> <span class=kd>interface</span><span class=p>{})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>n</span> <span class=o>:=</span> <span class=nb>len</span><span class=p>(</span><span class=o>*</span><span class=nx>pq</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>item</span> <span class=o>:=</span> <span class=nx>x</span><span class=p>.(</span><span class=o>*</span><span class=nx>waitFor</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>item</span><span class=p>.</span><span class=nx>index</span> <span class=p>=</span> <span class=nx>n</span>
</span></span><span class=line><span class=cl>	<span class=o>*</span><span class=nx>pq</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=o>*</span><span class=nx>pq</span><span class=p>,</span> <span class=nx>item</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>pq</span> <span class=o>*</span><span class=nx>waitForPriorityQueue</span><span class=p>)</span> <span class=nf>Pop</span><span class=p>()</span> <span class=kd>interface</span><span class=p>{}</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>n</span> <span class=o>:=</span> <span class=nb>len</span><span class=p>(</span><span class=o>*</span><span class=nx>pq</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>item</span> <span class=o>:=</span> <span class=p>(</span><span class=o>*</span><span class=nx>pq</span><span class=p>)[</span><span class=nx>n</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>	<span class=nx>item</span><span class=p>.</span><span class=nx>index</span> <span class=p>=</span> <span class=o>-</span><span class=mi>1</span>
</span></span><span class=line><span class=cl>	<span class=o>*</span><span class=nx>pq</span> <span class=p>=</span> <span class=p>(</span><span class=o>*</span><span class=nx>pq</span><span class=p>)[</span><span class=mi>0</span><span class=p>:(</span><span class=nx>n</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>item</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Peek returns the item at the beginning of the queue, without removing the
</span></span></span><span class=line><span class=cl><span class=c1>// item or otherwise mutating the queue. It is safe to call directly.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>pq</span> <span class=nx>waitForPriorityQueue</span><span class=p>)</span> <span class=nf>Peek</span><span class=p>()</span> <span class=kd>interface</span><span class=p>{}</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>pq</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>而整个延迟队列的核心就是 <code>waitingLoop</code>，作为了延迟队列的主要逻辑，检查 <code>waitingForAddCh</code> 有没有要延迟的内容，取出延迟的内容放置到 <code>Heap</code> 中；以及保证最大的阻塞周期</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>q</span> <span class=o>*</span><span class=nx>delayingType</span><span class=p>)</span> <span class=nf>waitingLoop</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>utilruntime</span><span class=p>.</span><span class=nf>HandleCrash</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>never</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=o>&lt;-</span><span class=kd>chan</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>)</span> <span class=c1>// 作为占位符
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=kd>var</span> <span class=nx>nextReadyAtTimer</span> <span class=nx>clock</span><span class=p>.</span><span class=nx>Timer</span> <span class=c1>// 最近一个任务要执行的定时器
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>waitingForQueue</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>waitForPriorityQueue</span><span class=p>{}</span> <span class=c1>// 优先级队列，heap
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>heap</span><span class=p>.</span><span class=nf>Init</span><span class=p>(</span><span class=nx>waitingForQueue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>waitingEntryByData</span> <span class=o>:=</span> <span class=kd>map</span><span class=p>[</span><span class=nx>t</span><span class=p>]</span><span class=o>*</span><span class=nx>waitFor</span><span class=p>{}</span> <span class=c1>// 检查是否反复添加
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>q</span><span class=p>.</span><span class=nx>Interface</span><span class=p>.</span><span class=nf>ShuttingDown</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>now</span> <span class=o>:=</span> <span class=nx>q</span><span class=p>.</span><span class=nx>clock</span><span class=p>.</span><span class=nf>Now</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=nx>waitingForQueue</span><span class=p>.</span><span class=nf>Len</span><span class=p>()</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>entry</span> <span class=o>:=</span> <span class=nx>waitingForQueue</span><span class=p>.</span><span class=nf>Peek</span><span class=p>().(</span><span class=o>*</span><span class=nx>waitFor</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>entry</span><span class=p>.</span><span class=nx>readyAt</span><span class=p>.</span><span class=nf>After</span><span class=p>(</span><span class=nx>now</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>break</span> <span class=c1>// 时间没到则不处理
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=nx>entry</span> <span class=p>=</span> <span class=nx>heap</span><span class=p>.</span><span class=nf>Pop</span><span class=p>(</span><span class=nx>waitingForQueue</span><span class=p>).(</span><span class=o>*</span><span class=nx>waitFor</span><span class=p>)</span> <span class=c1>// 从优先级队列中取出一个
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>q</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=nx>entry</span><span class=p>.</span><span class=nx>data</span><span class=p>)</span> <span class=c1>// 添加到延迟队列中
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nb>delete</span><span class=p>(</span><span class=nx>waitingEntryByData</span><span class=p>,</span> <span class=nx>entry</span><span class=p>.</span><span class=nx>data</span><span class=p>)</span> <span class=c1>// 删除map表中的数据
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// 如果存在数据则设置最近一个内容要执行的定时器
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>nextReadyAt</span> <span class=o>:=</span> <span class=nx>never</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>waitingForQueue</span><span class=p>.</span><span class=nf>Len</span><span class=p>()</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>nextReadyAtTimer</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>nextReadyAtTimer</span><span class=p>.</span><span class=nf>Stop</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nx>entry</span> <span class=o>:=</span> <span class=nx>waitingForQueue</span><span class=p>.</span><span class=nf>Peek</span><span class=p>().(</span><span class=o>*</span><span class=nx>waitFor</span><span class=p>)</span> <span class=c1>// 窥视[0]和值
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>nextReadyAtTimer</span> <span class=p>=</span> <span class=nx>q</span><span class=p>.</span><span class=nx>clock</span><span class=p>.</span><span class=nf>NewTimer</span><span class=p>(</span><span class=nx>entry</span><span class=p>.</span><span class=nx>readyAt</span><span class=p>.</span><span class=nf>Sub</span><span class=p>(</span><span class=nx>now</span><span class=p>))</span> <span class=c1>// 创建一个定时器
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>nextReadyAt</span> <span class=p>=</span> <span class=nx>nextReadyAtTimer</span><span class=p>.</span><span class=nf>C</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=o>&lt;-</span><span class=nx>q</span><span class=p>.</span><span class=nx>stopCh</span><span class=p>:</span> <span class=c1>// 退出
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>return</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=o>&lt;-</span><span class=nx>q</span><span class=p>.</span><span class=nx>heartbeat</span><span class=p>.</span><span class=nf>C</span><span class=p>():</span> <span class=c1>// 多久没有任何动作时重新一次循环
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>case</span> <span class=o>&lt;-</span><span class=nx>nextReadyAt</span><span class=p>:</span> <span class=c1>// 如果有元素时间到了，则继续执行循环，处理上面添加的操作
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>case</span> <span class=nx>waitEntry</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>q</span><span class=p>.</span><span class=nx>waitingForAddCh</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>waitEntry</span><span class=p>.</span><span class=nx>readyAt</span><span class=p>.</span><span class=nf>After</span><span class=p>(</span><span class=nx>q</span><span class=p>.</span><span class=nx>clock</span><span class=p>.</span><span class=nf>Now</span><span class=p>())</span> <span class=p>{</span> <span class=c1>// 时间没到，是用readyAt和now对比time.Now
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// 添加到延迟队列中，有两个 waitingEntryByData waitingForQueue
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=nf>insert</span><span class=p>(</span><span class=nx>waitingForQueue</span><span class=p>,</span> <span class=nx>waitingEntryByData</span><span class=p>,</span> <span class=nx>waitEntry</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>q</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=nx>waitEntry</span><span class=p>.</span><span class=nx>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=nx>drained</span> <span class=o>:=</span> <span class=kc>false</span> <span class=c1>// 保证可以取完q.waitingForAddCh // addafter
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>for</span> <span class=p>!</span><span class=nx>drained</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 这里是一个有buffer的队列，需要保障这个队列读完
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=k>case</span> <span class=nx>waitEntry</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>q</span><span class=p>.</span><span class=nx>waitingForAddCh</span><span class=p>:</span> 
</span></span><span class=line><span class=cl>					<span class=k>if</span> <span class=nx>waitEntry</span><span class=p>.</span><span class=nx>readyAt</span><span class=p>.</span><span class=nf>After</span><span class=p>(</span><span class=nx>q</span><span class=p>.</span><span class=nx>clock</span><span class=p>.</span><span class=nf>Now</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=nf>insert</span><span class=p>(</span><span class=nx>waitingForQueue</span><span class=p>,</span> <span class=nx>waitingEntryByData</span><span class=p>,</span> <span class=nx>waitEntry</span><span class=p>)</span>
</span></span><span class=line><span class=cl>					<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=nx>q</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=nx>waitEntry</span><span class=p>.</span><span class=nx>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>					<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=k>default</span><span class=p>:</span> <span class=c1>// 保证可以退出，但限制于上一个分支的0~n的读取
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// 如果上一个分支阻塞，则为没有数据就是取尽了，走到这个分支
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// 如果上个分支不阻塞则读取到上个分支阻塞为止，代表阻塞，则走default退出
</span></span></span><span class=line><span class=cl><span class=c1></span>					<span class=nx>drained</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><h2 id=限速队列>限速队列<a hidden class=anchor aria-hidden=true href=#限速队列>#</a></h2><p>限速队列 <code>RateLimiting</code> 是在优先级队列是在延迟队列的基础上进行扩展的一个队列</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>RateLimitingInterface</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>DelayingInterface</span> <span class=c1>// 继承延迟队列
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// 在限速器准备完成后（即合规后）添加条目到队列中
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>AddRateLimited</span><span class=p>(</span><span class=nx>item</span> <span class=kd>interface</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>	<span class=c1>// drop掉条目，无论成功或失败
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>Forget</span><span class=p>(</span><span class=nx>item</span> <span class=kd>interface</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 被重新放入队列中的次数
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>NumRequeues</span><span class=p>(</span><span class=nx>item</span> <span class=kd>interface</span><span class=p>{})</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>可以看到一个限速队列的抽象对应只要满足了 <code>AddRateLimited()</code> , <code>Forget()</code> , <code>NumRequeues()</code> 的延迟队列都是限速队列。看了解规则之后，需要对具体的实现进行分析。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>rateLimitingType</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>DelayingInterface</span>
</span></span><span class=line><span class=cl>	<span class=nx>rateLimiter</span> <span class=nx>RateLimiter</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>q</span> <span class=o>*</span><span class=nx>rateLimitingType</span><span class=p>)</span> <span class=nf>AddRateLimited</span><span class=p>(</span><span class=nx>item</span> <span class=kd>interface</span><span class=p>{})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>q</span><span class=p>.</span><span class=nx>DelayingInterface</span><span class=p>.</span><span class=nf>AddAfter</span><span class=p>(</span><span class=nx>item</span><span class=p>,</span> <span class=nx>q</span><span class=p>.</span><span class=nx>rateLimiter</span><span class=p>.</span><span class=nf>When</span><span class=p>(</span><span class=nx>item</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>q</span> <span class=o>*</span><span class=nx>rateLimitingType</span><span class=p>)</span> <span class=nf>NumRequeues</span><span class=p>(</span><span class=nx>item</span> <span class=kd>interface</span><span class=p>{})</span> <span class=kt>int</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>q</span><span class=p>.</span><span class=nx>rateLimiter</span><span class=p>.</span><span class=nf>NumRequeues</span><span class=p>(</span><span class=nx>item</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>q</span> <span class=o>*</span><span class=nx>rateLimitingType</span><span class=p>)</span> <span class=nf>Forget</span><span class=p>(</span><span class=nx>item</span> <span class=kd>interface</span><span class=p>{})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>q</span><span class=p>.</span><span class=nx>rateLimiter</span><span class=p>.</span><span class=nf>Forget</span><span class=p>(</span><span class=nx>item</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p><code>rateLimitingType</code> 则是对抽象规范 <code>RateLimitingInterface</code> 的实现，可以看出是在延迟队列的基础上增加了一个限速器 <code>RateLimiter</code></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>RateLimiter</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// when决定等待多长时间
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>When</span><span class=p>(</span><span class=nx>item</span> <span class=kd>interface</span><span class=p>{})</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span>
</span></span><span class=line><span class=cl>	<span class=c1>// drop掉item
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// or for success, we&#39;ll stop tracking it
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>Forget</span><span class=p>(</span><span class=nx>item</span> <span class=kd>interface</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 重新加入队列中的次数
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>NumRequeues</span><span class=p>(</span><span class=nx>item</span> <span class=kd>interface</span><span class=p>{})</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>抽象限速器的实现，有 <code>BucketRateLimiter</code> , <code>ItemBucketRateLimiter</code> , <code>ItemExponentialFailureRateLimiter</code> , <code>ItemFastSlowRateLimiter</code> , <code>MaxOfRateLimiter</code> ，下面对这些限速器进行分析</p><h3 id=bucketratelimiter>BucketRateLimiter<a hidden class=anchor aria-hidden=true href=#bucketratelimiter>#</a></h3><p><code>BucketRateLimiter</code> 是实现 <code>rate.Limiter</code> 与 抽象 <code>RateLimiter</code> 的一个令牌桶，初始化时通过 <code>workqueue.DefaultControllerRateLimiter()</code> 进行初始化。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>DefaultControllerRateLimiter</span><span class=p>()</span> <span class=nx>RateLimiter</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nf>NewMaxOfRateLimiter</span><span class=p>(</span>
</span></span><span class=line><span class=cl>		<span class=nf>NewItemExponentialFailureRateLimiter</span><span class=p>(</span><span class=mi>5</span><span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Millisecond</span><span class=p>,</span> <span class=mi>1000</span><span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 10 qps, 100 bucket size.  This is only for retry speed and its only the overall factor (not per item)
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=o>&amp;</span><span class=nx>BucketRateLimiter</span><span class=p>{</span><span class=nx>Limiter</span><span class=p>:</span> <span class=nx>rate</span><span class=p>.</span><span class=nf>NewLimiter</span><span class=p>(</span><span class=nx>rate</span><span class=p>.</span><span class=nf>Limit</span><span class=p>(</span><span class=mi>10</span><span class=p>),</span> <span class=mi>100</span><span class=p>)},</span>
</span></span><span class=line><span class=cl>	<span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p><a href=https://www.cnblogs.com/Cylon/p/16379709.html target=_blank rel="noopener nofollow noreferrer">更多关于令牌桶算法可以参考这里</a></p><h3 id=itembucketratelimiter>ItemBucketRateLimiter<a hidden class=anchor aria-hidden=true href=#itembucketratelimiter>#</a></h3><p><code>ItemBucketRateLimiter</code> 是作为列表存储每个令牌桶的实现，每个key都是单独的限速器</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>ItemBucketRateLimiter</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>r</span>     <span class=nx>rate</span><span class=p>.</span><span class=nx>Limit</span>
</span></span><span class=line><span class=cl>	<span class=nx>burst</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>limitersLock</span> <span class=nx>sync</span><span class=p>.</span><span class=nx>Mutex</span>
</span></span><span class=line><span class=cl>	<span class=nx>limiters</span>     <span class=kd>map</span><span class=p>[</span><span class=kd>interface</span><span class=p>{}]</span><span class=o>*</span><span class=nx>rate</span><span class=p>.</span><span class=nx>Limiter</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>NewItemBucketRateLimiter</span><span class=p>(</span><span class=nx>r</span> <span class=nx>rate</span><span class=p>.</span><span class=nx>Limit</span><span class=p>,</span> <span class=nx>burst</span> <span class=kt>int</span><span class=p>)</span> <span class=o>*</span><span class=nx>ItemBucketRateLimiter</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=o>&amp;</span><span class=nx>ItemBucketRateLimiter</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>r</span><span class=p>:</span>        <span class=nx>r</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>burst</span><span class=p>:</span>    <span class=nx>burst</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>limiters</span><span class=p>:</span> <span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kd>interface</span><span class=p>{}]</span><span class=o>*</span><span class=nx>rate</span><span class=p>.</span><span class=nx>Limiter</span><span class=p>),</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><h3 id=itemexponentialfailureratelimiter>ItemExponentialFailureRateLimiter<a hidden class=anchor aria-hidden=true href=#itemexponentialfailureratelimiter>#</a></h3><p>如名所知 <code>ItemExponentialFailureRateLimiter</code> 限速器是一个错误指数限速器，根据错误的次数，将指数用于delay的时长，指数的计算公式为：$baseDelay\times2^{<num-failures>}$。 可以看出When绝定了流量整形的delay时间，根据错误次数为指数进行延长重试时间</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>ItemExponentialFailureRateLimiter</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>failuresLock</span> <span class=nx>sync</span><span class=p>.</span><span class=nx>Mutex</span>
</span></span><span class=line><span class=cl>	<span class=nx>failures</span>     <span class=kd>map</span><span class=p>[</span><span class=kd>interface</span><span class=p>{}]</span><span class=kt>int</span> <span class=c1>// 失败的次数
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=nx>baseDelay</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span> <span class=c1>// 延迟基数
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>maxDelay</span>  <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span> <span class=c1>// 最大延迟
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>r</span> <span class=o>*</span><span class=nx>ItemExponentialFailureRateLimiter</span><span class=p>)</span> <span class=nf>When</span><span class=p>(</span><span class=nx>item</span> <span class=kd>interface</span><span class=p>{})</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>r</span><span class=p>.</span><span class=nx>failuresLock</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>r</span><span class=p>.</span><span class=nx>failuresLock</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>exp</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nx>failures</span><span class=p>[</span><span class=nx>item</span><span class=p>]</span>
</span></span><span class=line><span class=cl>	<span class=nx>r</span><span class=p>.</span><span class=nx>failures</span><span class=p>[</span><span class=nx>item</span><span class=p>]</span> <span class=p>=</span> <span class=nx>r</span><span class=p>.</span><span class=nx>failures</span><span class=p>[</span><span class=nx>item</span><span class=p>]</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// The backoff is capped such that &#39;calculated&#39; value never overflows.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>backoff</span> <span class=o>:=</span> <span class=nb>float64</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>baseDelay</span><span class=p>.</span><span class=nf>Nanoseconds</span><span class=p>())</span> <span class=o>*</span> <span class=nx>math</span><span class=p>.</span><span class=nf>Pow</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=nb>float64</span><span class=p>(</span><span class=nx>exp</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>backoff</span> <span class=p>&gt;</span> <span class=nx>math</span><span class=p>.</span><span class=nx>MaxInt64</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>r</span><span class=p>.</span><span class=nx>maxDelay</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>calculated</span> <span class=o>:=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Duration</span><span class=p>(</span><span class=nx>backoff</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>calculated</span> <span class=p>&gt;</span> <span class=nx>r</span><span class=p>.</span><span class=nx>maxDelay</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>r</span><span class=p>.</span><span class=nx>maxDelay</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>calculated</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>r</span> <span class=o>*</span><span class=nx>ItemExponentialFailureRateLimiter</span><span class=p>)</span> <span class=nf>NumRequeues</span><span class=p>(</span><span class=nx>item</span> <span class=kd>interface</span><span class=p>{})</span> <span class=kt>int</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>r</span><span class=p>.</span><span class=nx>failuresLock</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>r</span><span class=p>.</span><span class=nx>failuresLock</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>r</span><span class=p>.</span><span class=nx>failures</span><span class=p>[</span><span class=nx>item</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>r</span> <span class=o>*</span><span class=nx>ItemExponentialFailureRateLimiter</span><span class=p>)</span> <span class=nf>Forget</span><span class=p>(</span><span class=nx>item</span> <span class=kd>interface</span><span class=p>{})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>r</span><span class=p>.</span><span class=nx>failuresLock</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>r</span><span class=p>.</span><span class=nx>failuresLock</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nb>delete</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>failures</span><span class=p>,</span> <span class=nx>item</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><h3 id=itemfastslowratelimiter>ItemFastSlowRateLimiter<a hidden class=anchor aria-hidden=true href=#itemfastslowratelimiter>#</a></h3><p><code>ItemFastSlowRateLimiter </code>，限速器先快速重试一定次数，然后慢速重试</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>ItemFastSlowRateLimiter</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>failuresLock</span> <span class=nx>sync</span><span class=p>.</span><span class=nx>Mutex</span>
</span></span><span class=line><span class=cl>	<span class=nx>failures</span>     <span class=kd>map</span><span class=p>[</span><span class=kd>interface</span><span class=p>{}]</span><span class=kt>int</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>maxFastAttempts</span> <span class=kt>int</span> <span class=c1>// 最大尝试次数
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>fastDelay</span>       <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span> <span class=c1>// 快的速度
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>slowDelay</span>       <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span> <span class=c1>// 慢的速度
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>NewItemFastSlowRateLimiter</span><span class=p>(</span><span class=nx>fastDelay</span><span class=p>,</span> <span class=nx>slowDelay</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span><span class=p>,</span> <span class=nx>maxFastAttempts</span> <span class=kt>int</span><span class=p>)</span> <span class=nx>RateLimiter</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=o>&amp;</span><span class=nx>ItemFastSlowRateLimiter</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>failures</span><span class=p>:</span>        <span class=kd>map</span><span class=p>[</span><span class=kd>interface</span><span class=p>{}]</span><span class=kt>int</span><span class=p>{},</span>
</span></span><span class=line><span class=cl>		<span class=nx>fastDelay</span><span class=p>:</span>       <span class=nx>fastDelay</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>slowDelay</span><span class=p>:</span>       <span class=nx>slowDelay</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>maxFastAttempts</span><span class=p>:</span> <span class=nx>maxFastAttempts</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>r</span> <span class=o>*</span><span class=nx>ItemFastSlowRateLimiter</span><span class=p>)</span> <span class=nf>When</span><span class=p>(</span><span class=nx>item</span> <span class=kd>interface</span><span class=p>{})</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>r</span><span class=p>.</span><span class=nx>failuresLock</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>r</span><span class=p>.</span><span class=nx>failuresLock</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>r</span><span class=p>.</span><span class=nx>failures</span><span class=p>[</span><span class=nx>item</span><span class=p>]</span> <span class=p>=</span> <span class=nx>r</span><span class=p>.</span><span class=nx>failures</span><span class=p>[</span><span class=nx>item</span><span class=p>]</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 当错误次数没超过快速的阈值使用快速，否则使用慢速
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>r</span><span class=p>.</span><span class=nx>failures</span><span class=p>[</span><span class=nx>item</span><span class=p>]</span> <span class=o>&lt;=</span> <span class=nx>r</span><span class=p>.</span><span class=nx>maxFastAttempts</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>r</span><span class=p>.</span><span class=nx>fastDelay</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>r</span><span class=p>.</span><span class=nx>slowDelay</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>r</span> <span class=o>*</span><span class=nx>ItemFastSlowRateLimiter</span><span class=p>)</span> <span class=nf>NumRequeues</span><span class=p>(</span><span class=nx>item</span> <span class=kd>interface</span><span class=p>{})</span> <span class=kt>int</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>r</span><span class=p>.</span><span class=nx>failuresLock</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>r</span><span class=p>.</span><span class=nx>failuresLock</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>r</span><span class=p>.</span><span class=nx>failures</span><span class=p>[</span><span class=nx>item</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>r</span> <span class=o>*</span><span class=nx>ItemFastSlowRateLimiter</span><span class=p>)</span> <span class=nf>Forget</span><span class=p>(</span><span class=nx>item</span> <span class=kd>interface</span><span class=p>{})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>r</span><span class=p>.</span><span class=nx>failuresLock</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>r</span><span class=p>.</span><span class=nx>failuresLock</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nb>delete</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>failures</span><span class=p>,</span> <span class=nx>item</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><h3 id=maxofratelimiter>MaxOfRateLimiter<a hidden class=anchor aria-hidden=true href=#maxofratelimiter>#</a></h3><p><code>MaxOfRateLimiter</code> 是返回限速器列表中，延迟最大的那个限速器</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>MaxOfRateLimiter</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>limiters</span> <span class=p>[]</span><span class=nx>RateLimiter</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>r</span> <span class=o>*</span><span class=nx>MaxOfRateLimiter</span><span class=p>)</span> <span class=nf>When</span><span class=p>(</span><span class=nx>item</span> <span class=kd>interface</span><span class=p>{})</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>ret</span> <span class=o>:=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Duration</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>limiter</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>r</span><span class=p>.</span><span class=nx>limiters</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>curr</span> <span class=o>:=</span> <span class=nx>limiter</span><span class=p>.</span><span class=nf>When</span><span class=p>(</span><span class=nx>item</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>curr</span> <span class=p>&gt;</span> <span class=nx>ret</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>ret</span> <span class=p>=</span> <span class=nx>curr</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>ret</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>NewMaxOfRateLimiter</span><span class=p>(</span><span class=nx>limiters</span> <span class=o>...</span><span class=nx>RateLimiter</span><span class=p>)</span> <span class=nx>RateLimiter</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=o>&amp;</span><span class=nx>MaxOfRateLimiter</span><span class=p>{</span><span class=nx>limiters</span><span class=p>:</span> <span class=nx>limiters</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>r</span> <span class=o>*</span><span class=nx>MaxOfRateLimiter</span><span class=p>)</span> <span class=nf>NumRequeues</span><span class=p>(</span><span class=nx>item</span> <span class=kd>interface</span><span class=p>{})</span> <span class=kt>int</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>ret</span> <span class=o>:=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 找到列表內所有的NumRequeues（失败的次数），以最多次的为主。 
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>limiter</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>r</span><span class=p>.</span><span class=nx>limiters</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>curr</span> <span class=o>:=</span> <span class=nx>limiter</span><span class=p>.</span><span class=nf>NumRequeues</span><span class=p>(</span><span class=nx>item</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>curr</span> <span class=p>&gt;</span> <span class=nx>ret</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>ret</span> <span class=p>=</span> <span class=nx>curr</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>ret</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>r</span> <span class=o>*</span><span class=nx>MaxOfRateLimiter</span><span class=p>)</span> <span class=nf>Forget</span><span class=p>(</span><span class=nx>item</span> <span class=kd>interface</span><span class=p>{})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>limiter</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>r</span><span class=p>.</span><span class=nx>limiters</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>limiter</span><span class=p>.</span><span class=nf>Forget</span><span class=p>(</span><span class=nx>item</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><h3 id=如何使用kubernetes的限速器>如何使用Kubernetes的限速器<a hidden class=anchor aria-hidden=true href=#如何使用kubernetes的限速器>#</a></h3><p>基于流量管制的限速队列实例，可以大量突发，但是需要进行整形，添加操作会根据 <code>When()</code> 中设计的需要等待的时间进行添加。根据不同的队列实现不同方式的延迟</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;strconv&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=s>&#34;k8s.io/client-go/util/workqueue&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>stopCh</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kt>string</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>timeLayout</span> <span class=o>:=</span> <span class=s>&#34;2006-01-02:15:04:05.0000&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>limiter</span> <span class=o>:=</span> <span class=nx>workqueue</span><span class=p>.</span><span class=nf>NewRateLimitingQueue</span><span class=p>(</span><span class=nx>workqueue</span><span class=p>.</span><span class=nf>DefaultControllerRateLimiter</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=nx>length</span> <span class=o>:=</span> <span class=mi>20</span> <span class=c1>// 一共请求20次
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>chs</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=kd>chan</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>length</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=p>&lt;</span> <span class=nx>length</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>chs</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=p>=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kt>string</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>go</span> <span class=kd>func</span><span class=p>(</span><span class=nx>taskId</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>ch</span> <span class=kd>chan</span> <span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>item</span> <span class=o>:=</span> <span class=s>&#34;Task-&#34;</span> <span class=o>+</span> <span class=nx>taskId</span> <span class=o>+</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>().</span><span class=nf>Format</span><span class=p>(</span><span class=nx>timeLayout</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>item</span> <span class=o>+</span> <span class=s>&#34; Added.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nx>limiter</span><span class=p>.</span><span class=nf>AddRateLimited</span><span class=p>(</span><span class=nx>item</span><span class=p>)</span> <span class=c1>// 添加会根据When() 延迟添加到工作队列中
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>		<span class=p>}(</span><span class=nx>strconv</span><span class=p>.</span><span class=nf>FormatInt</span><span class=p>(</span><span class=nb>int64</span><span class=p>(</span><span class=nx>i</span><span class=p>),</span> <span class=mi>10</span><span class=p>),</span> <span class=nx>chs</span><span class=p>[</span><span class=nx>i</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>key</span><span class=p>,</span> <span class=nx>quit</span> <span class=o>:=</span> <span class=nx>limiter</span><span class=p>.</span><span class=nf>Get</span><span class=p>()</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nx>quit</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=k>return</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;%s process done&#34;</span><span class=p>,</span> <span class=nx>key</span><span class=p>))</span>
</span></span><span class=line><span class=cl>				<span class=k>defer</span> <span class=nx>limiter</span><span class=p>.</span><span class=nf>Done</span><span class=p>(</span><span class=nx>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}()</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=o>&lt;-</span><span class=nx>stopCh</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>因为默认的限速器不支持初始化 QPS，修改源码内的为 $BT(1, 5)$ ，执行结果可以看出，大突发流量时，超过桶内token数时，会根据token生成的速度进行放行。</p><p>图中，任务的添加是突发性的，日志打印的是同时添加，但是在添加前输出的日志，消费端可以看到实际是被延迟了。配置的是每秒一个token，实际上放行流量也是每秒一个token。</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220617173106990.png><img src=https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220617173106990.png#center alt=image-20220617173106990 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p></div><div class=pe-copyright><hr><blockquote><p>本文为原创内容，版权归作者所有。如需转载，请在文章中声明本文标题及链接。</p><p>文章标题：源码分析client-go架构 - queue</p><p>文章链接：<a href=https://www.oomkill.com/2022/06/ch09-queue/ target=_blank>https://www.oomkill.com/2022/06/ch09-queue/</a></p><p>许可协议：<a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></p></blockquote></div><div class=comments-separator></div><h3 class=relatedContentTitle>相关阅读</h3><ul class=relatedContent><li><a href=/2022/05/ch08-informer/><span>源码分析client-go架构 - 什么是informer</span></a></li><li><a href=/2022/05/ch06-client-go/><span>Kubernetes组件核心 - client-go</span></a></li><li><a href=/2022/05/ch02-kubernetes-api/><span>深入理解kubernetes API</span></a></li><li><a href=/2021/12/ch05-listwatch-mechanism/><span>理解kubernetes listwatch机制原理</span></a></li><li><a href=/2021/11/ch03-kubernetes-schema/><span>理解kubernetes schema</span></a></li></ul><div class=comments-separator></div><footer class=post-footer><ul class=post-tags><li><a href=https://www.oomkill.com/tags/kubernetes-develop/>Kubernetes Develop</a></li><li><a href=https://www.oomkill.com/tags/kubernetes/>Kubernetes</a></li></ul><nav class=paginav><a class=prev href=https://www.oomkill.com/2022/06/osi-network-basics/><span class=title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left" style="user-select:text"><line x1="19" y1="12" x2="5" y2="12" style="user-select:text"/><polyline points="12 19 5 12 12 5" style="user-select:text"/></polyline></svg>&nbsp;</span>
<span>OSI模型与IP协议</span>
</a><a class=next href=https://www.oomkill.com/2022/06/knn/><span class=title></span>
<span>KNN算法&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right" style="user-select:text"><line x1="5" y1="12" x2="19" y2="12" style="user-select:text"/><polyline points="12 5 19 12 12 19" style="user-select:text"/></svg></span></a></nav></footer><div class=pe-comments-decoration><p class=pe-comments-title></p><p class=pe-comments-subtitle></p></div><div id=pe-comments></div><script src=/js/pe-go-comment.min.86a214102576ba5f9b7bdc29eed8d58dd56e34aef80b3c65c73ea9cc88443696.js integrity="sha256-hqIUECV2ul+be9wp7tjVjdVuNK74Czxlxz6pzIhENpY="></script><script>const getStoredTheme=()=>localStorage.getItem("pref-theme")==="dark"?"dark":"light",setGiscusTheme=()=>{const e=e=>{const t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:e},"https://giscus.app")};e({setConfig:{theme:getStoredTheme()}})};document.addEventListener("DOMContentLoaded",()=>{const s={src:"https://giscus.app/client.js","data-repo":"cylonchau/cylonchau.github.io","data-repo-id":"R_kgDOIRlNSQ","data-category":"Announcements","data-category-id":"DIC_kwDOIRlNSc4CXy1U","data-mapping":"pathname","data-term":"posts/ch09 queue","data-strict":"0","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"top","data-theme":getStoredTheme(),"data-lang":"zh-TW","data-loading":"lazy",crossorigin:"anonymous",async:""},e=document.createElement("script");Object.entries(s).forEach(([t,n])=>e.setAttribute(t,n)),document.querySelector("#pe-comments").appendChild(e);const t=document.querySelector("#theme-toggle");t&&t.addEventListener("click",setGiscusTheme);const n=document.querySelector("#theme-toggle-float");n&&n.addEventListener("click",setGiscusTheme)})</script></article></main><footer class=footer><span>&copy; 2024 <a href=https://www.oomkill.com/>Cylon's Collection</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> on
<a href=https://pages.github.com/ rel=noopener target=_blank>GitHub Pages</a> & Theme
        <a href=https://github.com/tofuwine/PaperMod-PE rel=noopener target=_blank>PaperMod-PE</a></span></footer><div class=pe-right-sidebar><a href=javascript:void(0); id=theme-toggle-float class=pe-float-btn><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</a><a href=#top class=pe-float-btn id=top-link><span id=pe-read-progress></span></a></div><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>