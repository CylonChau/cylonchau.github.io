<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>扩展Kubernetes API的另一种方式 - APIServer aggregation | Cylon's Collection</title><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NP3JNCPR" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><meta name=keywords content="kubernetes,develop,扩展Kubernetes API的另一种方式 - APIServer aggregation"><meta name=description content="Overview What is Kubernetes aggregation Kubernetes apiserver aggregation AA 是Kubernetes提供的一种扩展API的方法，目前并没有GA
Difference between CRD and AA 众所周知，kubernetes扩展API的方法大概为三种：CRD、AA、手动扩展源码。根据CNCF分享中Min Kim说的AA更关注于实践，而用户无需了解底层的原理，这里使用过 kubebuilder， code-generator 的用户是很能体会到这点。官方也给出了CRD与AA的区别
API Access Control Authentication CR: All strategies supported. Configured by root apiserver. AA: Supporting all root apiserver&rsquo;s authenticating strategies but it has to be done via authentication token review api except for authentication proxy which will cause an extra cost of network RTT. Authorization CR: All strategies supported. Configured by root apiserver."><meta name=author content="cylon"><link rel=canonical href=https://www.oomkill.com/2022/06/ch04-apiserver-aggregation/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://www.oomkill.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.oomkill.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.oomkill.com/favicon-32x32.png><link rel=apple-touch-icon href=https://www.oomkill.com/favicon.ico><link rel=mask-icon href=https://www.oomkill.com/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://www.oomkill.com/2022/06/ch04-apiserver-aggregation/><noscript><style>#theme-toggle,#top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link crossorigin=anonymous href=/assets/css/pe.min.css rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/pe.min.js></script><link rel=stylesheet href=https://cdn.staticfile.net/font-awesome/6.5.1/css/all.min.css><link rel=stylesheet href=https://cdn.staticfile.net/font-awesome/6.5.1/css/v4-shims.min.css><script id=MathJax-script async src=https://cdn.staticfile.net/mathjax/3.2.2/es5/tex-chtml.js></script><script>MathJax={tex:{displayMath:[["$$","$$"]],inlineMath:[["\\$","\\$"]]}}</script><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><meta name=referrer content="no-referrer-when-downgrade"><script>(function(e,t,n,s,o){e[s]=e[s]||[],e[s].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var a=t.getElementsByTagName(n)[0],i=t.createElement(n),r=s!="dataLayer"?"&l="+s:"";i.async=!0,i.src="https://www.googletagmanager.com/gtm.js?id="+o+r,a.parentNode.insertBefore(i,a)})(window,document,"script","dataLayer","GTM-NP3JNCPR")</script><meta property="og:title" content="扩展Kubernetes API的另一种方式 - APIServer aggregation"><meta property="og:description" content="Overview What is Kubernetes aggregation Kubernetes apiserver aggregation AA 是Kubernetes提供的一种扩展API的方法，目前并没有GA
Difference between CRD and AA 众所周知，kubernetes扩展API的方法大概为三种：CRD、AA、手动扩展源码。根据CNCF分享中Min Kim说的AA更关注于实践，而用户无需了解底层的原理，这里使用过 kubebuilder， code-generator 的用户是很能体会到这点。官方也给出了CRD与AA的区别
API Access Control Authentication CR: All strategies supported. Configured by root apiserver. AA: Supporting all root apiserver&rsquo;s authenticating strategies but it has to be done via authentication token review api except for authentication proxy which will cause an extra cost of network RTT. Authorization CR: All strategies supported. Configured by root apiserver."><meta property="og:type" content="article"><meta property="og:url" content="https://www.oomkill.com/2022/06/ch04-apiserver-aggregation/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-06-22T00:00:00+00:00"><meta property="article:modified_time" content="2023-03-22T23:00:36+08:00"><meta property="og:site_name" content="Cylon's Collection"><meta name=twitter:card content="summary"><meta name=twitter:title content="扩展Kubernetes API的另一种方式 - APIServer aggregation"><meta name=twitter:description content="Overview What is Kubernetes aggregation Kubernetes apiserver aggregation AA 是Kubernetes提供的一种扩展API的方法，目前并没有GA
Difference between CRD and AA 众所周知，kubernetes扩展API的方法大概为三种：CRD、AA、手动扩展源码。根据CNCF分享中Min Kim说的AA更关注于实践，而用户无需了解底层的原理，这里使用过 kubebuilder， code-generator 的用户是很能体会到这点。官方也给出了CRD与AA的区别
API Access Control Authentication CR: All strategies supported. Configured by root apiserver. AA: Supporting all root apiserver&rsquo;s authenticating strategies but it has to be done via authentication token review api except for authentication proxy which will cause an extra cost of network RTT. Authorization CR: All strategies supported. Configured by root apiserver."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://www.oomkill.com/posts/"},{"@type":"ListItem","position":2,"name":"扩展Kubernetes API的另一种方式 - APIServer aggregation","item":"https://www.oomkill.com/2022/06/ch04-apiserver-aggregation/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"扩展Kubernetes API的另一种方式 - APIServer aggregation","name":"扩展Kubernetes API的另一种方式 - APIServer aggregation","description":"Overview What is Kubernetes aggregation Kubernetes apiserver aggregation AA 是Kubernetes提供的一种扩展API的方法，目前并没有GA\nDifference between CRD and AA 众所周知，kubernetes扩展API的方法大概为三种：CRD、AA、手动扩展源码。根据CNCF分享中Min Kim说的AA更关注于实践，而用户无需了解底层的原理，这里使用过 kubebuilder， code-generator 的用户是很能体会到这点。官方也给出了CRD与AA的区别\nAPI Access Control Authentication CR: All strategies supported. Configured by root apiserver. AA: Supporting all root apiserver\u0026rsquo;s authenticating strategies but it has to be done via authentication token review api except for authentication proxy which will cause an extra cost of network RTT. Authorization CR: All strategies supported. Configured by root apiserver.","keywords":["kubernetes","develop","扩展Kubernetes API的另一种方式 - APIServer aggregation"],"articleBody":"Overview What is Kubernetes aggregation Kubernetes apiserver aggregation AA 是Kubernetes提供的一种扩展API的方法，目前并没有GA\nDifference between CRD and AA 众所周知，kubernetes扩展API的方法大概为三种：CRD、AA、手动扩展源码。根据CNCF分享中Min Kim说的AA更关注于实践，而用户无需了解底层的原理，这里使用过 kubebuilder， code-generator 的用户是很能体会到这点。官方也给出了CRD与AA的区别\nAPI Access Control Authentication CR: All strategies supported. Configured by root apiserver. AA: Supporting all root apiserver’s authenticating strategies but it has to be done via authentication token review api except for authentication proxy which will cause an extra cost of network RTT. Authorization CR: All strategies supported. Configured by root apiserver. AA: Delegating authorization requests to root apiserver via SubjectAccessReview api. Note that this approach will also cost a network RTT. Admission Control CR: You could extend via dynamic admission control webhook (which is costing network RTT). AA: While You can develop and customize your own admission controller which is dedicated to your AA. While You can’t reuse root-apiserver’s built-in admission controllers nomore. API Schema Note: CR’s integration with OpenAPI schema is being enhanced in the future releases and it will have a stronger integration with OpenAPI mechanism.\nValidating CR: (landed in 1.12) Defined via OpenAPIv3 Schema grammar. more AA: You can customize any validating flow you want. Conversion CR: (landed in 1.13) The CR conversioning (basically from storage version to requested version) could be done via conversioning webhook. AA: Develop any conversion you want. SubResource CR: Currently only status and scale sub-resource supported. AA: You can customize any sub-resouce you want. OpenAPI Schema CR: (landed in 1.13) The corresponding CRD’s OpenAPI schema will be automatically synced to root-apiserver’s openapi doc api. AA: OpenAPI doc has to be manually generated by code-generating tools. Authentication 要想很好的使用AA，就需要对kubernetes与 AA 之间认证机制进行有一定的了解，这里涉及到一些概念\n客户端证书认证 token认证 请求头认证 在下面的说明中，所有出现的APIServer都是指Kubernetes集群组件APIServer也可以为 root APIServer；所有的AA都是指 extension apiserver，就是自行开发的 AA。\n客户端证书 客户端证书就是CA签名的证书，由客户端指定CA证书，在客户端连接时进行身份验证，在Kubernetes APIserver也使用了相同的机制。\n默认情况下，APIServer在启动时指定参数 --client-ca-file ，这时APIServer会创建一个名为 extension-apiserver-authentication ，命名空间为 kube-system 下的 configMap。\nbash 1 2 3 4 5 $ kubectl get cm -A NAMESPACE NAME DATA AGE kube-system extension-apiserver-authentication 6 21h kubectl get cm extension-apiserver-authentication -n kube-system -o yaml 由上面的命令可以看出这个configMap将被填充到客户端（AA Pod实例）中，使用此CA证书作为用于验证客户端身份的CA。这样客户端会读取这个configMap，与APIServer进行身份认证。\nbash 1 2 I0622 14:24:00.509486 1 secure_serving.go:178] Serving securely on [::]:443 I0622 14:24:00.509556 1 configmap_cafile_content.go:202] Starting client-ca::kube-system::extension-apiserver-authentication::requestheader-client-ca-file token认证 Token认证是指通过HTTP Header传入 Authorization: Bearer $TOKEN 的方式进行客户端认证，这也是Kubernetes集群内认证常用的方法。\n在这种情况下，允许对APIServer进行认证也同样可以对AA进行认证。如果不想 AA 对同一集群进行身份验证，或AA在集群外部运行，可以将参数 --authentication-kubeconfig 以指定要使用的不同 Kubeconfig 认证。\n下面实例是AA的启动参数\nbash 1 2 3 4 ./bin/apiserver -h|grep authentication-kubeconfig --authentication-kubeconfig string kubeconfig file pointing at the 'core' kubernetes server with enough righ ts to create tokenreviews.authentication.k8s.io. This is optional. If empty, all token requests are considered to be anonymous and no cli ent CA is looked up in the cluster. 请求头认证 RequestHeader 认证是指，APIServer对来自AA代理连接进行的身份认证。\n默认情况下，AA 从 extension-apiserver-authentication 中提到的 ConfigMap 中 提取 requestheader 客户端 CA 证书与 CN。如果主 Kubernetes APIServer 配置了选项 --requestheader-client-ca-file ，则它会填充此内容。\n跳过客户端认证 --authentication-skip-lookup\n授权 默认情况下，AA 服务器会通过自动注入到 Kubernetes 集群上运行的 pod 的连接信息和凭据，来连接到主 Kubernetes API 服务器。\nbash 1 E0622 11:20:12.375512 1 errors.go:77] Post \"https://192.168.0.1:443/apis/authorization.k8s.io/v1/subjectaccessreviews\": write tcp 192.168.0.36:39324-\u003e192.168.0.1:443: write: connection reset by peer 如果AA在集群外部部署，可以指定--authorization-kubeconfig 通过kubeconfig进行认证，这就类似于二进制部署中的信息。\n默认情况下，Kubernetes 集群会启用RBAC，这就意味着AA 创建多个clusterrolebinding。\n下面日志是 AA 对于集群中资源访问无权限的情况\nbash 1 2 3 E0622 09:01:26.750320 1 reflector.go:178] pkg/mod/k8s.io/client-go@v0.18.10/tools/cache/reflector.go:125: Failed to list *v1.MutatingWebhookConfiguration: mutatingwebhookconfigurations.admissionregistration.k8s.io is forbidden: User \"system:serviceaccount:default:default\" cannot list resource \"mutatingwebhookconfigurations\" in API group \"admissionregistration.k8s.io\" at the cluster scope E0622 09:01:29.357897 1 reflector.go:178] pkg/mod/k8s.io/client-go@v0.18.10/tools/cache/reflector.go:125: Failed to list *v1.Namespace: namespaces is forbidden: User \"system:serviceaccount:default:default\" cannot list resource \"namespaces\" in API group \"\" at the cluster scope E0622 09:01:39.998496 1 reflector.go:178] pkg/mod/k8s.io/client-go@v0.18.10/tools/cache/reflector.go:125: Failed to list *v1.ValidatingWebhookConfiguration: validatingwebhookconfigurations.admissionregistration.k8s.io is forbidden: User \"system:serviceaccount:default:default\" cannot list resource \"validatingwebhookconfigurations\" in API group \"admissionregistration.k8s.io\" at the cluster scope 需要手动在namespace kube-system 中创建rolebindding到 role extension-apiserver-authentication-reader 。这样就可以访问到configMap了。\napiserver-builder apiserver-builder 项目就是创建AA的工具，可以参考 installing.md 来安装\n初始化项目 初始化命令\n这个是你的API资源的组，参考 k8s.io/api 如果组的名称是域名就设置为主域名，例如内置组 /apis/authentication.k8s.io /apis/batch 生成的go mod 包名为你所在的目录的名称 例如，在firewalld目录下，go.mod 的名称为 firewalld bash 1 apiserver-boot init repo --domain 例如\nbash 1 apiserver-boot init repo --domain fedoraproject.org 注：这里–domain设置为主域名就可以了，后面生成的group会按照格式 +\ntext 1 2 apiserver-boot must be run from the directory containing the go package to bootstrap. This must be under $GOPATH/src/. 必须在 $GOPATH/src 下创建你的项目，我这里的为 GOPATH=go/src ，这时创建项目必须在目录 go/src/src/{project} 下创建\n创建一个GVK bash 1 2 3 4 apiserver-boot create group version resource \\ --group firewalld \\ --version v1 \\ --kind PortRule 在创建完成之后会生成 api-like的类型，我们只需要填充自己需要的就可以了\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 type PortRule struct { metav1.TypeMeta `json:\",inline\"` metav1.ObjectMeta `json:\"metadata,omitempty\"` Spec PortRuleSpec `json:\"spec,omitempty\"` Status PortRuleStatus `json:\"status,omitempty\"` } // PortRuleSpec defines the desired state of PortRule type PortRuleSpec struct { // 这里内容都为空的，自己添加即可 Name string `json:\"name\"` Host string `json:\"host\"` Port int `json:\"port\"` IsPremanent bool `json:\"isPremanent,omitempty\"` } // PortRuleStatus defines the observed state of PortRule type PortRuleStatus struct { } 生成代码 apiserver-boot 没有专门用来生成代码的命令，可以执行任意生成命令即可，这里使用生成二进制执行文件命令，这个过程相当长。\nbash 1 apiserver-boot build executables 如果编译错误可以使用 --generate=false 跳过生成，这样就可以节省大量时间。\n运行方式 运行方式无非三种，本地运行，集群内运行，集群外运行\nrunning_locally 本地运行需要有一个etcd服务，不用配置ca证书，这里使用docker运行\nsh 1 2 3 4 5 6 docker run -d --name Etcd-server \\ --publish 2379:2379 \\ --publish 2380:2380 \\ --env ALLOW_NONE_AUTHENTICATION=yes \\ --env ETCD_ADVERTISE_CLIENT_URLS=http://etcd-server:2379 \\ bitnami/etcd:latest 然后执行命令，执行成功后会弹出对应的访问地址\nbash 1 2 apiserver-boot build executables apiserver-boot run local running_in_cluster 构建镜像 需要先构建容器镜像，apiserver-boot build container --image 这将生成代码，构建 apiserver 和controller二进制文件，然后构建容器映像。构建完成后还需要将对应的镜像push到仓库（可选）\nbash 1 2 3 4 apiserver-boot build config \\ --name \\ --namespace \\ --image 注，这个操作需要在支持Linux内核的环境下构建，wsl不具备内核功能故会报错，需要替换为wsl2，而工具是下载的，如果需要wsl1+Docker Desktop构建，需要自己修改\n构建配置 text 1 2 3 4 apiserver-boot build config \\ --name \\ --namespace \\ --image 构建配置的操作会执行以下几个步骤：\n在 ","wordCount":"965","inLanguage":"zh","datePublished":"2022-06-22T00:00:00Z","dateModified":"2023-03-22T23:00:36+08:00","author":{"@type":"Person","name":"cylon"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.oomkill.com/2022/06/ch04-apiserver-aggregation/"},"publisher":{"@type":"Organization","name":"Cylon's Collection","logo":{"@type":"ImageObject","url":"https://www.oomkill.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.oomkill.com/><img src=https://www.oomkill.com/favicon.ico alt aria-label=logo height=20>Cylon's Collection</a><div class=logo-switches><button id=theme-toggle><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://www.oomkill.com/archives><span>归档</span></a></li><li><a href=https://www.oomkill.com/tags><span>标签</span></a></li><li><a href=https://www.oomkill.com/search><span>搜索</span></a></li><li><a href=https://www.oomkill.com/about accesskey=/><span>关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">扩展Kubernetes API的另一种方式 - APIServer aggregation</h1><div class=post-meta><span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar" style="user-select:text"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" style="user-select:text"/><line x1="16" y1="2" x2="16" y2="6" style="user-select:text"/><line x1="8" y1="2" x2="8" y2="6" style="user-select:text"/><line x1="3" y1="10" x2="21" y2="10" style="user-select:text"/></svg><span>2022-06-22</span></span>&nbsp;·&nbsp;<span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text" style="user-select:text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z" style="user-select:text"/><polyline points="14 2 14 8 20 8" style="user-select:text"/><line x1="16" y1="13" x2="8" y2="13" style="user-select:text"/><line x1="16" y1="17" x2="8" y2="17" style="user-select:text"/><polyline points="10 9 9 9 8 9" style="user-select:text"/></svg><span>965 字</span></span>&nbsp;·&nbsp;<span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><span>5 分钟</span></span>
<span class=pe-post-meta-item>&nbsp;·&nbsp;<svg t="1714036239378" fill="currentcolor" class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="6659" width="256" height="256"><path d="M690 78.2c-18.6-18.8-49-19-67.8-.4s-19 49-.4 67.8l255.4 258.6c67.8 68.6 67.8 178.8.0 247.4L653.4 878.2c-18.6 18.8-18.4 49.2.4 67.8s49.2 18.4 67.8-.4l224-226.4c104.8-106 104.8-276.4.0-382.4L690 78.2zM485.4 101.4c-24-24-56.6-37.4-90.6-37.4H96C43 64 0 107 0 160v299c0 34 13.4 66.6 37.4 90.6l336 336c50 50 131 50 181 0l267-267c50-50 50-131 0-181l-336-336zM96 160h299c8.4.0 16.6 3.4 22.6 9.4l336 336c12.4 12.4 12.4 32.8.0 45.2l-267 267c-12.4 12.4-32.8 12.4-45.2.0l-336-336c-6-6-9.4-14.2-9.4-22.6V160zm192 128a64 64 0 10-128 0 64 64 0 10128 0z" p-id="6660"/></svg></span><ul class=pe-post-meta-item><a href=https://www.oomkill.com/tags/kubernetes-develop/>#Kubernetes Develop</a>
<a href=https://www.oomkill.com/tags/kubernetes/>#Kubernetes</a></ul></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details><summary><span class=details>目录</span></summary><div class=inner><ul><li><a href=#overview aria-label=Overview>Overview</a><ul><li><a href=#what-is-kubernetes-aggregation aria-label="What is Kubernetes aggregation">What is Kubernetes aggregation</a><li><a href=#difference-between--crd-and-aa aria-label="Difference between  CRD and AA">Difference between CRD and AA</a><li><a href=#api-access-control aria-label="API Access Control">API Access Control</a><ul><ul><li><a href=#authentication aria-label=Authentication>Authentication</a><li><a href=#authorization aria-label=Authorization>Authorization</a><li><a href=#admission-control aria-label="Admission Control">Admission Control</a></ul></ul><li><a href=#api-schema aria-label="API Schema">API Schema</a><ul><ul><li><a href=#validating aria-label=Validating>Validating</a><li><a href=#conversion aria-label=Conversion>Conversion</a><li><a href=#subresource aria-label=SubResource>SubResource</a><li><a href=#openapi-schema aria-label="OpenAPI Schema">OpenAPI Schema</a></ul></ul></ul><li><a href=#authentication-1 aria-label=Authentication>Authentication</a><ul><li><a href=#%e5%ae%a2%e6%88%b7%e7%ab%af%e8%af%81%e4%b9%a6 aria-label=客户端证书>客户端证书</a><li><a href=#token%e8%ae%a4%e8%af%81 aria-label=token认证>token认证</a><li><a href=#%e8%af%b7%e6%b1%82%e5%a4%b4%e8%ae%a4%e8%af%81 aria-label=请求头认证>请求头认证</a><li><a href=#%e6%8e%88%e6%9d%83 aria-label=授权>授权</a></ul><li><a href=#apiserver-builder aria-label=apiserver-builder>apiserver-builder</a><ul><li><a href=#%e5%88%9d%e5%a7%8b%e5%8c%96%e9%a1%b9%e7%9b%ae aria-label=初始化项目>初始化项目</a><li><a href=#%e5%88%9b%e5%bb%ba%e4%b8%80%e4%b8%aagvk aria-label=创建一个GVK>创建一个GVK</a><li><a href=#%e7%94%9f%e6%88%90%e4%bb%a3%e7%a0%81 aria-label=生成代码>生成代码</a><li><a href=#%e8%bf%90%e8%a1%8c%e6%96%b9%e5%bc%8f aria-label=运行方式>运行方式</a><ul><li><a href=#running_locally aria-label=running_locally>running_locally</a><li><a href=#running_in_cluster aria-label=running_in_cluster>running_in_cluster</a><ul><li><a href=#%e6%9e%84%e5%bb%ba%e9%95%9c%e5%83%8f aria-label=构建镜像>构建镜像</a><li><a href=#%e6%9e%84%e5%bb%ba%e9%85%8d%e7%bd%ae aria-label=构建配置>构建配置</a><li><a href=#%e4%bf%ae%e6%94%b9apiserver%e7%9a%84%e9%85%8d%e7%bd%ae aria-label=修改apiserver的配置>修改apiserver的配置</a></ul></ul></ul><li><a href=#reference aria-label=Reference>Reference</a></li></div></details></div></aside><script src=/js/pe-toc.min.445eb1bfc5e85dd13b9519fcc2a806522e9629b6224a2974052789ba00ab78af.js integrity="sha256-RF6xv8XoXdE7lRn8wqgGUi6WKbYiSil0BSeJugCreK8="></script><div class=post-content><h2 id=overview>Overview<a hidden class=anchor aria-hidden=true href=#overview>#</a></h2><h3 id=what-is-kubernetes-aggregation>What is Kubernetes aggregation<a hidden class=anchor aria-hidden=true href=#what-is-kubernetes-aggregation>#</a></h3><p><strong>Kubernetes apiserver aggregation</strong> <em>AA</em> 是Kubernetes提供的一种扩展API的方法，目前并没有GA</p><h3 id=difference-between--crd-and-aa>Difference between CRD and AA<a hidden class=anchor aria-hidden=true href=#difference-between--crd-and-aa>#</a></h3><p>众所周知，kubernetes扩展API的方法大概为三种：CRD、AA、手动扩展源码。根据<a href=https://www.youtube.com/c/cloudnativefdn target=_blank rel="noopener nofollow noreferrer">CNCF分享</a>中Min Kim说的AA更关注于实践，而用户无需了解底层的原理，这里使用过 <code>kubebuilder</code>， <code>code-generator</code> 的用户是很能体会到这点。官方也给出了CRD与AA的区别</p><blockquote><h3 id=api-access-control>API Access Control<a hidden class=anchor aria-hidden=true href=#api-access-control>#</a></h3><h5 id=authentication>Authentication<a hidden class=anchor aria-hidden=true href=#authentication>#</a></h5><ul><li><strong>CR</strong>: All strategies supported. Configured by root apiserver.</li><li><strong>AA</strong>: Supporting all root apiserver&rsquo;s authenticating strategies but it has to be done via <a href=https://kubernetes.io/docs/reference/access-authn-authz/authentication/#webhook-token-authentication target=_blank rel="noopener nofollow noreferrer">authentication token review api</a> except for <a href=https://kubernetes.io/docs/reference/access-authn-authz/authentication/#authenticating-proxy target=_blank rel="noopener nofollow noreferrer">authentication proxy</a> which will cause an extra cost of network RTT.</li></ul><h5 id=authorization>Authorization<a hidden class=anchor aria-hidden=true href=#authorization>#</a></h5><ul><li><strong>CR</strong>: All strategies supported. Configured by root apiserver.</li><li><strong>AA</strong>: Delegating authorization requests to root apiserver via <a href=https://kubernetes.io/docs/reference/access-authn-authz/authorization/#checking-api-access target=_blank rel="noopener nofollow noreferrer">SubjectAccessReview api</a>. Note that this approach will also cost a network RTT.</li></ul><h5 id=admission-control>Admission Control<a hidden class=anchor aria-hidden=true href=#admission-control>#</a></h5><ul><li><strong>CR</strong>: You could extend via dynamic admission control webhook (which is costing network RTT).</li><li><strong>AA</strong>: While You can develop and customize your own admission controller which is dedicated to your AA. While You can&rsquo;t reuse root-apiserver&rsquo;s built-in admission controllers nomore.</li></ul><h3 id=api-schema>API Schema<a hidden class=anchor aria-hidden=true href=#api-schema>#</a></h3><p>Note: CR&rsquo;s integration with OpenAPI schema is being enhanced in the future releases and it will have a stronger integration with OpenAPI mechanism.</p><h5 id=validating>Validating<a hidden class=anchor aria-hidden=true href=#validating>#</a></h5><ul><li><strong>CR</strong>: (landed in 1.12) Defined via OpenAPIv3 Schema grammar. <a href=https://kubernetes.io/docs/tasks/access-kubernetes-api/custom-resources/custom-resource-definitions/#validation target=_blank rel="noopener nofollow noreferrer">more</a></li><li><strong>AA</strong>: You can customize any validating flow you want.</li></ul><h5 id=conversion>Conversion<a hidden class=anchor aria-hidden=true href=#conversion>#</a></h5><ul><li><strong>CR</strong>: (landed in 1.13) The CR conversioning (basically from storage version to requested version) could be done via conversioning webhook.</li><li><strong>AA</strong>: Develop any conversion you want.</li></ul><h5 id=subresource>SubResource<a hidden class=anchor aria-hidden=true href=#subresource>#</a></h5><ul><li><strong>CR</strong>: Currently only status and scale sub-resource supported.</li><li><strong>AA</strong>: You can customize any sub-resouce you want.</li></ul><h5 id=openapi-schema>OpenAPI Schema<a hidden class=anchor aria-hidden=true href=#openapi-schema>#</a></h5><ul><li><strong>CR</strong>: (landed in 1.13) The corresponding CRD&rsquo;s OpenAPI schema will be automatically synced to root-apiserver&rsquo;s openapi doc api.</li><li><strong>AA</strong>: OpenAPI doc has to be manually generated by code-generating tools.</li></ul></blockquote><h2 id=authentication-1>Authentication<a hidden class=anchor aria-hidden=true href=#authentication-1>#</a></h2><p>要想很好的使用AA，就需要对kubernetes与 AA 之间认证机制进行有一定的了解，这里涉及到一些概念</p><ul><li>客户端证书认证</li><li>token认证</li><li>请求头认证</li></ul><p>在下面的说明中，所有出现的APIServer都是指Kubernetes集群组件APIServer也可以为 root APIServer；所有的AA都是指 extension apiserver，就是自行开发的 AA。</p><h3 id=客户端证书>客户端证书<a hidden class=anchor aria-hidden=true href=#客户端证书>#</a></h3><p>客户端证书就是CA签名的证书，由客户端指定CA证书，在客户端连接时进行身份验证，在Kubernetes APIserver也使用了相同的机制。</p><p>默认情况下，APIServer在启动时指定参数 <code>--client-ca-file</code> ，这时APIServer会创建一个名为 <code>extension-apiserver-authentication</code> ，命名空间为 <code>kube-system</code> 下的 configMap。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl get cm -A
</span></span><span class=line><span class=cl>NAMESPACE     NAME                                 DATA   AGE
</span></span><span class=line><span class=cl>kube-system   extension-apiserver-authentication   <span class=m>6</span>      21h
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kubectl get cm extension-apiserver-authentication -n kube-system -o yaml</span></span></code></pre></td></tr></table></div></div></div></div><p>由上面的命令可以看出这个configMap将被填充到客户端（AA Pod实例）中，使用此CA证书作为用于验证客户端身份的CA。这样客户端会读取这个configMap，与APIServer进行身份认证。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>I0622 14:24:00.509486       <span class=m>1</span> secure_serving.go:178<span class=o>]</span> Serving securely on <span class=o>[</span>::<span class=o>]</span>:443
</span></span><span class=line><span class=cl>I0622 14:24:00.509556       <span class=m>1</span> configmap_cafile_content.go:202<span class=o>]</span> Starting client-ca::kube-system::extension-apiserver-authentication::requestheader-client-ca-file</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=token认证>token认证<a hidden class=anchor aria-hidden=true href=#token认证>#</a></h3><p>Token认证是指通过HTTP Header传入 <code>Authorization: Bearer $TOKEN</code> 的方式进行客户端认证，这也是Kubernetes集群内认证常用的方法。</p><p>在这种情况下，允许对APIServer进行认证也同样可以对AA进行认证。如果不想 AA 对同一集群进行身份验证，或AA在集群外部运行，可以将参数 <code>--authentication-kubeconfig</code> 以指定要使用的不同 Kubeconfig 认证。</p><p>下面实例是AA的启动参数</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>./bin/apiserver -h<span class=p>|</span>grep authentication-kubeconfig
</span></span><span class=line><span class=cl>      --authentication-kubeconfig string                        kubeconfig file pointing at the <span class=s1>&#39;core&#39;</span> kubernetes server with enough righ
</span></span><span class=line><span class=cl>ts to create tokenreviews.authentication.k8s.io. This is optional. If empty, all token requests are considered to be anonymous and no cli
</span></span><span class=line><span class=cl>ent CA is looked up in the cluster.</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=请求头认证>请求头认证<a hidden class=anchor aria-hidden=true href=#请求头认证>#</a></h3><p>RequestHeader 认证是指，APIServer对来自AA代理连接进行的身份认证。</p><p>默认情况下，AA 从 <code>extension-apiserver-authentication</code> 中提到的 ConfigMap 中 提取 requestheader 客户端 CA 证书与 CN。如果主 Kubernetes APIServer 配置了选项 <code>--requestheader-client-ca-file</code> ，则它会填充此内容。</p><p>跳过客户端认证 <code>--authentication-skip-lookup</code></p><h3 id=授权>授权<a hidden class=anchor aria-hidden=true href=#授权>#</a></h3><p>默认情况下，AA 服务器会通过自动注入到 Kubernetes 集群上运行的 pod 的连接信息和凭据，来连接到主 Kubernetes API 服务器。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>E0622 11:20:12.375512       <span class=m>1</span> errors.go:77<span class=o>]</span> Post <span class=s2>&#34;https://192.168.0.1:443/apis/authorization.k8s.io/v1/subjectaccessreviews&#34;</span>: write tcp 192.168.0.36:39324-&gt;192.168.0.1:443: write: connection reset by peer</span></span></code></pre></td></tr></table></div></div></div></div><p>如果AA在集群外部部署，可以指定<code>--authorization-kubeconfig</code> 通过kubeconfig进行认证，这就类似于二进制部署中的信息。</p><p>默认情况下，Kubernetes 集群会启用RBAC，这就意味着AA 创建多个clusterrolebinding。</p><p>下面日志是 AA 对于集群中资源访问无权限的情况</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>E0622 09:01:26.750320       <span class=m>1</span> reflector.go:178<span class=o>]</span> pkg/mod/k8s.io/client-go@v0.18.10/tools/cache/reflector.go:125: Failed to list *v1.MutatingWebhookConfiguration: mutatingwebhookconfigurations.admissionregistration.k8s.io is forbidden: User <span class=s2>&#34;system:serviceaccount:default:default&#34;</span> cannot list resource <span class=s2>&#34;mutatingwebhookconfigurations&#34;</span> in API group <span class=s2>&#34;admissionregistration.k8s.io&#34;</span> at the cluster scope
</span></span><span class=line><span class=cl>E0622 09:01:29.357897       <span class=m>1</span> reflector.go:178<span class=o>]</span> pkg/mod/k8s.io/client-go@v0.18.10/tools/cache/reflector.go:125: Failed to list *v1.Namespace: namespaces is forbidden: User <span class=s2>&#34;system:serviceaccount:default:default&#34;</span> cannot list resource <span class=s2>&#34;namespaces&#34;</span> in API group <span class=s2>&#34;&#34;</span> at the cluster scope
</span></span><span class=line><span class=cl>E0622 09:01:39.998496       <span class=m>1</span> reflector.go:178<span class=o>]</span> pkg/mod/k8s.io/client-go@v0.18.10/tools/cache/reflector.go:125: Failed to list *v1.ValidatingWebhookConfiguration: validatingwebhookconfigurations.admissionregistration.k8s.io is forbidden: User <span class=s2>&#34;system:serviceaccount:default:default&#34;</span> cannot list resource <span class=s2>&#34;validatingwebhookconfigurations&#34;</span> in API group <span class=s2>&#34;admissionregistration.k8s.io&#34;</span> at the cluster scope</span></span></code></pre></td></tr></table></div></div></div></div><p>需要手动在namespace <code>kube-system</code> 中创建rolebindding到 role <code>extension-apiserver-authentication-reader</code> 。这样就可以访问到configMap了。</p><h2 id=apiserver-builder>apiserver-builder<a hidden class=anchor aria-hidden=true href=#apiserver-builder>#</a></h2><p><code>apiserver-builder</code> 项目就是创建AA的工具，可以参考 <a href=https://github.com/kubernetes-sigs/apiserver-builder-alpha/blob/v1.18.0/docs/installing.md target=_blank rel="noopener nofollow noreferrer">installing.md</a> 来安装</p><h3 id=初始化项目>初始化项目<a hidden class=anchor aria-hidden=true href=#初始化项目>#</a></h3><p>初始化命令</p><ul><li><code>&lt;your-domain></code> 这个是你的API资源的组，参考 <code>k8s.io/api</code><ul><li>如果组的名称是域名就设置为主域名，例如内置组<ul><li><code>/apis/authentication.k8s.io</code></li><li><code>/apis/batch</code></li></ul></li></ul></li><li>生成的go mod 包名为你所在的目录的名称<ul><li>例如，在firewalld目录下，go.mod 的名称为 firewalld</li></ul></li></ul><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>apiserver-boot init repo --domain &lt;your-domain&gt;</span></span></code></pre></td></tr></table></div></div></div></div><p>例如</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>apiserver-boot init repo --domain fedoraproject.org</span></span></code></pre></td></tr></table></div></div></div></div><blockquote><p>注：这里&ndash;domain设置为主域名就可以了，后面生成的group会按照格式 <group>+<domain></p></blockquote><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>text</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>apiserver-boot must be run from the directory containing the go package to bootstrap. This must
</span></span><span class=line><span class=cl> be under $GOPATH/src/&lt;package&gt;.</span></span></code></pre></td></tr></table></div></div></div></div><p>必须在 <code>$GOPATH/src</code> 下创建你的项目，我这里的为 <code>GOPATH=go/src</code> ，这时创建项目必须在目录 <code>go/src/src/{project}</code> 下创建</p><h3 id=创建一个gvk>创建一个GVK<a hidden class=anchor aria-hidden=true href=#创建一个gvk>#</a></h3><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>apiserver-boot create group version resource <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	--group firewalld <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	--version v1 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	--kind PortRule</span></span></code></pre></td></tr></table></div></div></div></div><p>在创建完成之后会生成 api-like的类型，我们只需要填充自己需要的就可以了</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>PortRule</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>metav1</span><span class=p>.</span><span class=nx>TypeMeta</span>   <span class=s>`json:&#34;,inline&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>metav1</span><span class=p>.</span><span class=nx>ObjectMeta</span> <span class=s>`json:&#34;metadata,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>Spec</span>   <span class=nx>PortRuleSpec</span>   <span class=s>`json:&#34;spec,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>Status</span> <span class=nx>PortRuleStatus</span> <span class=s>`json:&#34;status,omitempty&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// PortRuleSpec defines the desired state of PortRule
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>PortRuleSpec</span> <span class=kd>struct</span> <span class=p>{</span> <span class=c1>// 这里内容都为空的，自己添加即可
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>Name</span>        <span class=kt>string</span> <span class=s>`json:&#34;name&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>Host</span>        <span class=kt>string</span> <span class=s>`json:&#34;host&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>Port</span>        <span class=kt>int</span>    <span class=s>`json:&#34;port&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>IsPremanent</span> <span class=kt>bool</span>   <span class=s>`json:&#34;isPremanent,omitempty&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// PortRuleStatus defines the observed state of PortRule
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>PortRuleStatus</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><h3 id=生成代码>生成代码<a hidden class=anchor aria-hidden=true href=#生成代码>#</a></h3><p><code>apiserver-boot</code> 没有专门用来生成代码的命令，可以执行任意生成命令即可，这里使用生成二进制执行文件命令，这个过程相当长。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>apiserver-boot build executables</span></span></code></pre></td></tr></table></div></div></div></div><p>如果编译错误可以使用 <code>--generate=false</code> 跳过生成，这样就可以节省大量时间。</p><h3 id=运行方式>运行方式<a hidden class=anchor aria-hidden=true href=#运行方式>#</a></h3><p>运行方式无非三种，本地运行，集群内运行，集群外运行</p><h4 id=running_locally>running_locally<a hidden class=anchor aria-hidden=true href=#running_locally>#</a></h4><p>本地运行需要有一个etcd服务，不用配置ca证书，这里使用docker运行</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>sh</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>docker run -d --name Etcd-server <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --publish 2379:2379 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --publish 2380:2380 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --env <span class=nv>ALLOW_NONE_AUTHENTICATION</span><span class=o>=</span>yes <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --env <span class=nv>ETCD_ADVERTISE_CLIENT_URLS</span><span class=o>=</span>http://etcd-server:2379 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    bitnami/etcd:latest</span></span></code></pre></td></tr></table></div></div></div></div><p>然后执行命令，执行成功后会弹出对应的访问地址</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>apiserver-boot build executables
</span></span><span class=line><span class=cl>apiserver-boot run local</span></span></code></pre></td></tr></table></div></div></div></div><h4 id=running_in_cluster>running_in_cluster<a hidden class=anchor aria-hidden=true href=#running_in_cluster>#</a></h4><h5 id=构建镜像>构建镜像<a hidden class=anchor aria-hidden=true href=#构建镜像>#</a></h5><p>需要先构建容器镜像，<code>apiserver-boot build container --image &lt;image></code> 这将生成代码，构建 apiserver 和controller二进制文件，然后构建容器映像。构建完成后还需要将对应的镜像push到仓库（可选）</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>apiserver-boot build config <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	--name &lt;servicename&gt; <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	--namespace &lt;namespace to run in&gt; <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	--image &lt;image to run&gt;</span></span></code></pre></td></tr></table></div></div></div></div><blockquote><p>注，这个操作需要在支持Linux内核的环境下构建，wsl不具备内核功能故会报错，需要替换为wsl2，而工具是下载的，如果需要wsl1+Docker Desktop构建，需要自己修改</p></blockquote><h5 id=构建配置>构建配置<a hidden class=anchor aria-hidden=true href=#构建配置>#</a></h5><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>text</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>apiserver-boot build config \
</span></span><span class=line><span class=cl>	--name &lt;servicename&gt; \
</span></span><span class=line><span class=cl>	--namespace &lt;namespace to run in&gt; \
</span></span><span class=line><span class=cl>	--image &lt;image to run&gt;</span></span></code></pre></td></tr></table></div></div></div></div><p>构建配置的操作会执行以下几个步骤：</p><ul><li>在 <code>&lt;project/config/certificates</code> 目录下创建一个 CA证书</li><li>在目录 <code>&lt;project/config/*.yaml</code> 下生成kubernetes所需的资源清单。</li></ul><blockquote><p>注：</p><p>实际上这个清单并不能完美适配任何环境，需要手动修改一下配置</p><p>运行的Pod中包含apiserver与controller，如果使用kubebuilder创建的controller可以自行修改资源清单</p></blockquote><h5 id=修改apiserver的配置>修改apiserver的配置<a hidden class=anchor aria-hidden=true href=#修改apiserver的配置>#</a></h5><p>下面参数是有关于 AA 认证的参数</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>text</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>--proxy-client-cert-file=/etc/kubernetes/pki/firewalld.crt \
</span></span><span class=line><span class=cl>--proxy-client-key-file=/etc/kubernetes/pki/firewalld.key \
</span></span><span class=line><span class=cl>--requestheader-allowed-names=kube-apiserver-kubelet-client,firewalld.default.svc,firewalld-certificate-authority \
</span></span><span class=line><span class=cl>--requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.crt \
</span></span><span class=line><span class=cl>--requestheader-extra-headers-prefix=X-Remote-Extra- \</span></span></code></pre></td></tr></table></div></div></div></div><ul><li><code>--requestheader-username-headers</code>：用于存储用户名的标头</li><li><code>--requestheader-group-headers</code>：用于存储组的标题</li><li><code>--requestheader-extra-headers-prefix</code>：附加到所有额外标头的前缀</li><li><code>--proxy-client-key-file</code> ：私钥文件</li><li><code>--proxy-client-cert-file</code>：客户端证书文件</li><li><code>--requestheader-client-ca-file</code>：签署客户端证书文件的 CA 的证书</li><li><code>--requestheader-allowed-names</code>：签名客户端证书中的CN)</li></ul><p>由以上信息得知，实际上 <code>apiserver-boot</code> 所生成的ca用不上，需要kubernetes自己的ca进行签署，这里简单提供两个命令，使用kubernetes集群证书进行颁发证书。这里kubernetes集群证书使用<a href=https://github.com/CylonChau/kubernetes-generator target=_blank rel="noopener nofollow noreferrer">kubernetes-generator</a> 生产的。这里根据这个ca再次生成用于 AA 认证的证书。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>text</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>openssl req -new \
</span></span><span class=line><span class=cl>    -key firewalld.key \
</span></span><span class=line><span class=cl>    -subj &#34;/CN=firewalld.default.svc&#34; \
</span></span><span class=line><span class=cl>    -config &lt;(cat /etc/pki/tls/openssl.cnf &lt;(printf &#34;[aa]\nsubjectAltName=DNS:firewalld, DNS:firewalld.default.svc, DNS:firewalld-certificate-authority, DNS:kubernetes.default.svc&#34;)) \
</span></span><span class=line><span class=cl>    -out firewalld.csr
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>openssl ca \
</span></span><span class=line><span class=cl>	-in firewalld.csr \
</span></span><span class=line><span class=cl>	-cert front-proxy-ca.crt \
</span></span><span class=line><span class=cl>	-keyfile front-proxy-ca.key \
</span></span><span class=line><span class=cl>	-out firewalld.crt \
</span></span><span class=line><span class=cl>	-days 3650 \
</span></span><span class=line><span class=cl>	-extensions aa \
</span></span><span class=line><span class=cl>	-extfile &lt;(cat /etc/pki/tls/openssl.cnf  &lt;(printf &#34;[aa]\nsubjectAltName=DNS:firewalld, DNS:firewalld.default.svc, DNS:firewalld-certificate-authority, DNS:kubernetes.default.svc&#34;))</span></span></code></pre></td></tr></table></div></div></div></div><p>完成后重新生成所需的yaml资源清单即可，通过资源清单来测试下扩展的API</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>yaml</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>firewalld.fedoraproject.org/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>PortRule</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>portrule-example</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;nginx&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;10.0.0.3&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span></span></span></code></pre></td></tr></table></div></div></div></div><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl apply -f http.yaml 
</span></span><span class=line><span class=cl>portrule.firewalld.fedoraproject.org/portrule-example created
</span></span><span class=line><span class=cl>$ kubectl get portrule
</span></span><span class=line><span class=cl>NAME               CREATED AT
</span></span><span class=line><span class=cl>portrule-example   2022-06-22T15:12:59Z</span></span></code></pre></td></tr></table></div></div></div></div><p>更详细的说明建议阅读下Reference，都是官方提供的详细说明文档</p><h2 id=reference>Reference<a hidden class=anchor aria-hidden=true href=#reference>#</a></h2><blockquote><p><a href=https://kubernetes.io/docs/tasks/extend-kubernetes/configure-aggregation-layer/ target=_blank rel="noopener nofollow noreferrer">aggregation layer</a></p><p><a href=https://github.com/kubernetes-sigs/apiserver-builder-alpha/tree/master/docs target=_blank rel="noopener nofollow noreferrer">apiserver-builder doc</a></p></blockquote></div><div class=pe-copyright><hr><blockquote><p>本文为原创内容，版权归作者所有。如需转载，请在文章中声明本文标题及链接。</p><p>文章标题：扩展Kubernetes API的另一种方式 - APIServer aggregation</p><p>文章链接：<a href=https://www.oomkill.com/2022/06/ch04-apiserver-aggregation/ target=_blank>https://www.oomkill.com/2022/06/ch04-apiserver-aggregation/</a></p><p>许可协议：<a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></p></blockquote></div><div class=comments-separator></div><h3 class=relatedContentTitle>相关阅读</h3><ul class=relatedContent><li><a href=/2022/06/ch14-code-generator/><span>kubernetes代码生成器 - code-generator</span></a></li><li><a href=/2022/06/ch12-controller/><span>手写一个kubernetes controller</span></a></li><li><a href=/2022/06/ch13-crd/><span>使用CRD扩展Kubernetes API</span></a></li><li><a href=/2022/06/ch09-queue/><span>源码分析client-go架构 - queue</span></a></li><li><a href=/2022/05/ch08-informer/><span>源码分析client-go架构 - 什么是informer</span></a></li></ul><div class=comments-separator></div><footer class=post-footer><ul class=post-tags><li><a href=https://www.oomkill.com/tags/kubernetes-develop/>Kubernetes Develop</a></li><li><a href=https://www.oomkill.com/tags/kubernetes/>Kubernetes</a></li></ul><nav class=paginav><a class=prev href=https://www.oomkill.com/2022/06/ch15-controller-runtime/><span class=title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left" style="user-select:text"><line x1="19" y1="12" x2="5" y2="12" style="user-select:text"/><polyline points="12 19 5 12 12 5" style="user-select:text"/></polyline></svg>&nbsp;</span>
<span>源码分析Kubernetes controller组件 - controller-runtime</span>
</a><a class=next href=https://www.oomkill.com/2022/06/ch14-code-generator/><span class=title></span>
<span>kubernetes代码生成器 - code-generator&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right" style="user-select:text"><line x1="5" y1="12" x2="19" y2="12" style="user-select:text"/><polyline points="12 5 19 12 12 19" style="user-select:text"/></svg></span></a></nav></footer><div class=pe-comments-decoration><p class=pe-comments-title></p><p class=pe-comments-subtitle></p></div><div id=pe-comments></div><script src=/js/pe-go-comment.min.86a214102576ba5f9b7bdc29eed8d58dd56e34aef80b3c65c73ea9cc88443696.js integrity="sha256-hqIUECV2ul+be9wp7tjVjdVuNK74Czxlxz6pzIhENpY="></script><script>const getStoredTheme=()=>localStorage.getItem("pref-theme")==="dark"?"dark":"light",setGiscusTheme=()=>{const e=e=>{const t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:e},"https://giscus.app")};e({setConfig:{theme:getStoredTheme()}})};document.addEventListener("DOMContentLoaded",()=>{const s={src:"https://giscus.app/client.js","data-repo":"cylonchau/cylonchau.github.io","data-repo-id":"R_kgDOIRlNSQ","data-category":"Announcements","data-category-id":"DIC_kwDOIRlNSc4CXy1U","data-mapping":"pathname","data-term":"posts/ch04 APIServer aggregation","data-strict":"0","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"top","data-theme":getStoredTheme(),"data-lang":"zh-TW","data-loading":"lazy",crossorigin:"anonymous",async:""},e=document.createElement("script");Object.entries(s).forEach(([t,n])=>e.setAttribute(t,n)),document.querySelector("#pe-comments").appendChild(e);const t=document.querySelector("#theme-toggle");t&&t.addEventListener("click",setGiscusTheme);const n=document.querySelector("#theme-toggle-float");n&&n.addEventListener("click",setGiscusTheme)})</script></article></main><footer class=footer><span>&copy; 2024 <a href=https://www.oomkill.com/>Cylon's Collection</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> on
<a href=https://pages.github.com/ rel=noopener target=_blank>GitHub Pages</a> & Theme
        <a href=https://github.com/tofuwine/PaperMod-PE rel=noopener target=_blank>PaperMod-PE</a></span></footer><div class=pe-right-sidebar><a href=javascript:void(0); id=theme-toggle-float class=pe-float-btn><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</a><a href=#top class=pe-float-btn id=top-link><span id=pe-read-progress></span></a></div><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>