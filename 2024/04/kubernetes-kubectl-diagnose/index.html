<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>探索kubectl - kubectl诊断命令集合 | Cylon's Collection</title><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NP3JNCPR" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><meta name=keywords content="kubernetes,kubectl,diagnose"><meta name=description content="Pod 检查 Pod 就绪探针
bash 1 kubectl get pods <pod-name> -n <namespace> -o jsonpath='{.status.conditions[?(@.type==&#34;Ready&#34;)].status}' 查看 Pod 事件
bash 1 kubectl get events -n <namespace> --field-selector involvedObject.name=<pod-name> 获取 Pod Affinity 和 Anti-Affinity
bash 1 kubectl get pod <pod-name> -n <namespace> -o=jsonpath='{.spec.affinity}' 列出 Pod 的 anti-affinity 规则
bash 1 kubectl get pod <pod-name> -n <namespace> -o=jsonpath='{.spec.affinity.podAntiAffinity}' Pod Network 运行 Debug Pod 进行调试
bash 1 kubectl run -it --rm --restart=Never --image=busybox net-debug-pod -- /bin/sh 测试从 Pod 到 Endpoint 的连接性"><meta name=author content="cylon"><link rel=canonical href=https://www.oomkill.com/2024/04/kubernetes-kubectl-diagnose/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://www.oomkill.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.oomkill.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.oomkill.com/favicon-32x32.png><link rel=apple-touch-icon href=https://www.oomkill.com/favicon.ico><link rel=mask-icon href=https://www.oomkill.com/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://www.oomkill.com/2024/04/kubernetes-kubectl-diagnose/><noscript><style>#theme-toggle,#top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link crossorigin=anonymous href=/assets/css/pe.min.css rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/pe.min.js></script><link rel=stylesheet href=https://cdn.staticfile.net/font-awesome/6.5.1/css/all.min.css><link rel=stylesheet href=https://cdn.staticfile.net/font-awesome/6.5.1/css/v4-shims.min.css><script id=MathJax-script async src=https://cdn.staticfile.net/mathjax/3.2.2/es5/tex-chtml.js></script><script>MathJax={tex:{displayMath:[["$$","$$"]],inlineMath:[["\\$","\\$"]]}}</script><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><meta name=referrer content="no-referrer-when-downgrade"><script>(function(e,t,n,s,o){e[s]=e[s]||[],e[s].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var a=t.getElementsByTagName(n)[0],i=t.createElement(n),r=s!="dataLayer"?"&l="+s:"";i.async=!0,i.src="https://www.googletagmanager.com/gtm.js?id="+o+r,a.parentNode.insertBefore(i,a)})(window,document,"script","dataLayer","GTM-NP3JNCPR")</script><meta property="og:title" content="探索kubectl - kubectl诊断命令集合"><meta property="og:description" content="Pod 检查 Pod 就绪探针
bash 1 kubectl get pods <pod-name> -n <namespace> -o jsonpath='{.status.conditions[?(@.type==&#34;Ready&#34;)].status}' 查看 Pod 事件
bash 1 kubectl get events -n <namespace> --field-selector involvedObject.name=<pod-name> 获取 Pod Affinity 和 Anti-Affinity
bash 1 kubectl get pod <pod-name> -n <namespace> -o=jsonpath='{.spec.affinity}' 列出 Pod 的 anti-affinity 规则
bash 1 kubectl get pod <pod-name> -n <namespace> -o=jsonpath='{.spec.affinity.podAntiAffinity}' Pod Network 运行 Debug Pod 进行调试
bash 1 kubectl run -it --rm --restart=Never --image=busybox net-debug-pod -- /bin/sh 测试从 Pod 到 Endpoint 的连接性"><meta property="og:type" content="article"><meta property="og:url" content="https://www.oomkill.com/2024/04/kubernetes-kubectl-diagnose/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-04-20T00:00:00+00:00"><meta property="article:modified_time" content="2024-11-29T23:00:36+08:00"><meta property="og:site_name" content="Cylon's Collection"><meta name=twitter:card content="summary"><meta name=twitter:title content="探索kubectl - kubectl诊断命令集合"><meta name=twitter:description content="Pod 检查 Pod 就绪探针
bash 1 kubectl get pods <pod-name> -n <namespace> -o jsonpath='{.status.conditions[?(@.type==&#34;Ready&#34;)].status}' 查看 Pod 事件
bash 1 kubectl get events -n <namespace> --field-selector involvedObject.name=<pod-name> 获取 Pod Affinity 和 Anti-Affinity
bash 1 kubectl get pod <pod-name> -n <namespace> -o=jsonpath='{.spec.affinity}' 列出 Pod 的 anti-affinity 规则
bash 1 kubectl get pod <pod-name> -n <namespace> -o=jsonpath='{.spec.affinity.podAntiAffinity}' Pod Network 运行 Debug Pod 进行调试
bash 1 kubectl run -it --rm --restart=Never --image=busybox net-debug-pod -- /bin/sh 测试从 Pod 到 Endpoint 的连接性"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://www.oomkill.com/posts/"},{"@type":"ListItem","position":2,"name":"探索kubectl - kubectl诊断命令集合","item":"https://www.oomkill.com/2024/04/kubernetes-kubectl-diagnose/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"探索kubectl - kubectl诊断命令集合","name":"探索kubectl - kubectl诊断命令集合","description":"Pod 检查 Pod 就绪探针\nbash 1 kubectl get pods \u0026lt;pod-name\u0026gt; -n \u0026lt;namespace\u0026gt; -o jsonpath=\u0026#39;{.status.conditions[?(@.type==\u0026#34;Ready\u0026#34;)].status}\u0026#39; 查看 Pod 事件\nbash 1 kubectl get events -n \u0026lt;namespace\u0026gt; --field-selector involvedObject.name=\u0026lt;pod-name\u0026gt; 获取 Pod Affinity 和 Anti-Affinity\nbash 1 kubectl get pod \u0026lt;pod-name\u0026gt; -n \u0026lt;namespace\u0026gt; -o=jsonpath=\u0026#39;{.spec.affinity}\u0026#39; 列出 Pod 的 anti-affinity 规则\nbash 1 kubectl get pod \u0026lt;pod-name\u0026gt; -n \u0026lt;namespace\u0026gt; -o=jsonpath=\u0026#39;{.spec.affinity.podAntiAffinity}\u0026#39; Pod Network 运行 Debug Pod 进行调试\nbash 1 kubectl run -it --rm --restart=Never --image=busybox net-debug-pod -- /bin/sh 测试从 Pod 到 Endpoint 的连接性","keywords":["kubernetes","kubectl","diagnose"],"articleBody":"Pod 检查 Pod 就绪探针\nbash 1 kubectl get pods -n -o jsonpath='{.status.conditions[?(@.type==\"Ready\")].status}' 查看 Pod 事件\nbash 1 kubectl get events -n --field-selector involvedObject.name= 获取 Pod Affinity 和 Anti-Affinity\nbash 1 kubectl get pod -n -o=jsonpath='{.spec.affinity}' 列出 Pod 的 anti-affinity 规则\nbash 1 kubectl get pod -n -o=jsonpath='{.spec.affinity.podAntiAffinity}' Pod Network 运行 Debug Pod 进行调试\nbash 1 kubectl run -it --rm --restart=Never --image=busybox net-debug-pod -- /bin/sh 测试从 Pod 到 Endpoint 的连接性\nbash 1 kubectl exec -it -n -- curl trace 一个 Pod 到另一个 Pod 的网络\nbash 1 kubectl exec -it -n -- traceroute 检查 Pod DNS配置\nbash 1 kubectl exec -it -n -- cat /etc/resolv.conf Workload Deployment 查看 rollout 状态\nbash 1 kubectl rollout status deployment/ -n 查看 rollout 历史记录\nbash 1 kubectl rollout history deployment/ -n 调整 deployment 数量\nbash 1 kubectl scale deploy --replicas=0 -n 调整名称空间内的所有 Deployment 工作负载数量为 0\nbash 1 2 3 for d in `kubectl get deploy -n ${ns} -o jsonpath='{range $.items[@]}{.metadata.name}{end}'`; do kubectl scale deploy ${d} --replicas=0 -n ${ns} done 调整整个集群的 Deployment 工作负载数量为 0\nbash 1 2 3 4 5 6 7 for namespace in `kubectl get ns -o jsonpath='{range $.items[*]}{.metadata.name}{\"\\n\"}{end}'` do for workload in `kubectl get deploy -n ${namespace} -o jsonpath='{range $.items[@]}{.metadata.name}{end}'` do kubectl scale deploy ${workload} --replicas=0 -n ${namespace} done done 设置 deployment 的自动缩放\nbash 1 2 3 4 5 kubectl autoscale deployment \\ --min= \\ --max= \\ --cpu-percent= \\ -n DaemonSet 调整一个 Daemonset 资源为 0\nbash 1 kubectl -n patch daemonset -p '{\"spec\": {\"template\": {\"spec\": {\"nodeSelector\": {\"disable\": \"true\"}}}}}' 恢复\nbash 1 kubectl -n patch daemonset --type json -p='[{\"op\": \"remove\", \"path\": \"/spec/template/spec/nodeSelector/disable\"}]' 调整名称空间内的所有 Daemonset 工作负载数量为 0\nbash 1 2 3 4 NAMESPACE=default for daemonset in `kubectl get daemonset -n ${NAMESPACE} -o jsonpath='{range $.items[@]}{.metadata.name}{end}'`; do kubectl -n ${NAMESPACE} patch daemonset ${daemonset} -p '{\"spec\": {\"template\": {\"spec\": {\"nodeSelector\": {\"disable\": \"true\"}}}}}' done HPA 检查 HPA 状态\nbash 1 kubectl get hpa -n CRD 批量删除 CRD 资源\nbash 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 KUBE_CMD='kubectl --kubeconfig=' for r in `${KUBE_CMD} get crd -ojsonpath='{range $.items[*]}{.metadata.name}{\"\\n\"}{end}'` do echo $r for ns in `${KUBE_CMD} get ns -o jsonpath='{range $.items[*]}{.metadata.name}{\"\\n\"}{end}'` do for crd_name in `${KUBE_CMD} get $r -n $ns -ojsonpath='{range $.items[*]}{.metadata.name}{\"\\n\"}{end}'` do ${KUBE_CMD} delete $crd_name -n $ns done done echo $n | grep \"cattle.io\" \u0026\u0026 ${KUBE_CMD} delete crd $sn --force done `` ## Networking 显示命名空间中 Pod 的 IP 地址： ```bash kubectl get pods -n ","wordCount":"2133","inLanguage":"zh","datePublished":"2024-04-20T00:00:00Z","dateModified":"2024-11-29T23:00:36+08:00","author":{"@type":"Person","name":"cylon"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.oomkill.com/2024/04/kubernetes-kubectl-diagnose/"},"publisher":{"@type":"Organization","name":"Cylon's Collection","logo":{"@type":"ImageObject","url":"https://www.oomkill.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.oomkill.com/><img src=https://www.oomkill.com/favicon.ico alt aria-label=logo height=20>Cylon's Collection</a><div class=logo-switches><button id=theme-toggle><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://www.oomkill.com/archives><span>归档</span></a></li><li><a href=https://www.oomkill.com/tags><span>标签</span></a></li><li><a href=https://www.oomkill.com/search><span>搜索</span></a></li><li><a href=https://www.oomkill.com/about accesskey=/><span>关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">探索kubectl - kubectl诊断命令集合</h1><div class=post-meta><span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar" style="user-select:text"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" style="user-select:text"/><line x1="16" y1="2" x2="16" y2="6" style="user-select:text"/><line x1="8" y1="2" x2="8" y2="6" style="user-select:text"/><line x1="3" y1="10" x2="21" y2="10" style="user-select:text"/></svg><span>2024-04-20</span></span>&nbsp;·&nbsp;<span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text" style="user-select:text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z" style="user-select:text"/><polyline points="14 2 14 8 20 8" style="user-select:text"/><line x1="16" y1="13" x2="8" y2="13" style="user-select:text"/><line x1="16" y1="17" x2="8" y2="17" style="user-select:text"/><polyline points="10 9 9 9 8 9" style="user-select:text"/></svg><span>2133 字</span></span>&nbsp;·&nbsp;<span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><span>11 分钟</span></span>
<span class=pe-post-meta-item>&nbsp;·&nbsp;<svg t="1714036239378" fill="currentcolor" class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="6659" width="256" height="256"><path d="M690 78.2c-18.6-18.8-49-19-67.8-.4s-19 49-.4 67.8l255.4 258.6c67.8 68.6 67.8 178.8.0 247.4L653.4 878.2c-18.6 18.8-18.4 49.2.4 67.8s49.2 18.4 67.8-.4l224-226.4c104.8-106 104.8-276.4.0-382.4L690 78.2zM485.4 101.4c-24-24-56.6-37.4-90.6-37.4H96C43 64 0 107 0 160v299c0 34 13.4 66.6 37.4 90.6l336 336c50 50 131 50 181 0l267-267c50-50 50-131 0-181l-336-336zM96 160h299c8.4.0 16.6 3.4 22.6 9.4l336 336c12.4 12.4 12.4 32.8.0 45.2l-267 267c-12.4 12.4-32.8 12.4-45.2.0l-336-336c-6-6-9.4-14.2-9.4-22.6V160zm192 128a64 64 0 10-128 0 64 64 0 10128 0z" p-id="6660"/></svg></span><ul class=pe-post-meta-item><a href=https://www.oomkill.com/tags/kubernetes/>#Kubernetes</a></ul></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details><summary><span class=details>目录</span></summary><div class=inner><ul><li><a href=#pod aria-label=Pod>Pod</a><li><a href=#pod-network aria-label="Pod Network">Pod Network</a><li><a href=#workload aria-label=Workload>Workload</a><ul><li><a href=#deployment aria-label=Deployment>Deployment</a><li><a href=#daemonset aria-label=DaemonSet>DaemonSet</a></ul><li><a href=#hpa aria-label=HPA>HPA</a><li><a href=#crd aria-label=CRD>CRD</a><li><a href=#node aria-label=Node>Node</a><li><a href=#resource-quotas aria-label="Resource Quotas">Resource Quotas</a><li><a href=#volumes aria-label=Volumes>Volumes</a><li><a href=#ephemeral-containers aria-label="Ephemeral Containers">Ephemeral Containers</a><li><a href=#pod-disruption-budget-pdb aria-label="Pod Disruption Budget (PDB)"><strong>Pod Disruption Budget (PDB)</strong></a><li><a href=#configmap aria-label=ConfigMap>ConfigMap</a><li><a href=#secret aria-label=Secret>Secret</a></li></div></details></div></aside><script src=/js/pe-toc.min.445eb1bfc5e85dd13b9519fcc2a806522e9629b6224a2974052789ba00ab78af.js integrity="sha256-RF6xv8XoXdE7lRn8wqgGUi6WKbYiSil0BSeJugCreK8="></script><div class=post-content><h2 id=pod>Pod<a hidden class=anchor aria-hidden=true href=#pod>#</a></h2><p>检查 Pod 就绪探针</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get pods &lt;pod-name&gt; -n &lt;namespace&gt; -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{.status.conditions[?(@.type==&#34;Ready&#34;)].status}&#39;</span></span></span></code></pre></td></tr></table></div></div></div></div><p>查看 Pod 事件</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get events -n &lt;namespace&gt; --field-selector involvedObject.name<span class=o>=</span>&lt;pod-name&gt;</span></span></code></pre></td></tr></table></div></div></div></div><p>获取 Pod Affinity 和 Anti-Affinity</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get pod &lt;pod-name&gt; -n &lt;namespace&gt; -o<span class=o>=</span><span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{.spec.affinity}&#39;</span></span></span></code></pre></td></tr></table></div></div></div></div><p>列出 Pod 的 anti-affinity 规则</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get pod &lt;pod-name&gt; -n &lt;namespace&gt; -o<span class=o>=</span><span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{.spec.affinity.podAntiAffinity}&#39;</span></span></span></code></pre></td></tr></table></div></div></div></div><h2 id=pod-network>Pod Network<a hidden class=anchor aria-hidden=true href=#pod-network>#</a></h2><p>运行 Debug Pod 进行调试</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl run -it --rm --restart<span class=o>=</span>Never --image<span class=o>=</span>busybox net-debug-pod -- /bin/sh</span></span></code></pre></td></tr></table></div></div></div></div><p>测试从 Pod 到 Endpoint 的连接性</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl <span class=nb>exec</span> -it &lt;pod-name&gt; -n &lt;namespace&gt; -- curl &lt;endpoint-url&gt;</span></span></code></pre></td></tr></table></div></div></div></div><p>trace 一个 Pod 到另一个 Pod 的网络</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl <span class=nb>exec</span> -it &lt;source-pod-name&gt; -n &lt;namespace&gt; -- traceroute &lt;destination-pod-ip&gt;</span></span></code></pre></td></tr></table></div></div></div></div><p>检查 Pod DNS配置</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl <span class=nb>exec</span> -it &lt;pod-name&gt; -n &lt;namespace&gt; -- cat /etc/resolv.conf</span></span></code></pre></td></tr></table></div></div></div></div><h2 id=workload>Workload<a hidden class=anchor aria-hidden=true href=#workload>#</a></h2><h3 id=deployment>Deployment<a hidden class=anchor aria-hidden=true href=#deployment>#</a></h3><p>查看 rollout 状态</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl rollout status deployment/&lt;deployment-name&gt; -n &lt;namespace&gt;</span></span></code></pre></td></tr></table></div></div></div></div><p>查看 rollout 历史记录</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl rollout <span class=nb>history</span> deployment/&lt;deployment-name&gt; -n &lt;namespace&gt;</span></span></code></pre></td></tr></table></div></div></div></div><p>调整 deployment 数量</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl scale deploy &lt;deployment-name&gt; --replicas<span class=o>=</span><span class=m>0</span> -n &lt;namespace&gt;</span></span></code></pre></td></tr></table></div></div></div></div><p>调整名称空间内的所有 Deployment 工作负载数量为 0</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=k>for</span> d in <span class=sb>`</span>kubectl get deploy -n <span class=si>${</span><span class=nv>ns</span><span class=si>}</span> -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{range $.items[@]}{.metadata.name}{end}&#39;</span><span class=sb>`</span><span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>  kubectl scale deploy <span class=si>${</span><span class=nv>d</span><span class=si>}</span> --replicas<span class=o>=</span><span class=m>0</span> -n <span class=si>${</span><span class=nv>ns</span><span class=si>}</span>
</span></span><span class=line><span class=cl><span class=k>done</span></span></span></code></pre></td></tr></table></div></div></div></div><p>调整整个集群的 Deployment 工作负载数量为 0</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=k>for</span> namespace in <span class=sb>`</span>kubectl get ns -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{range $.items[*]}{.metadata.name}{&#34;\n&#34;}{end}&#39;</span><span class=sb>`</span>
</span></span><span class=line><span class=cl><span class=k>do</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> workload in <span class=sb>`</span>kubectl get deploy -n <span class=si>${</span><span class=nv>namespace</span><span class=si>}</span> -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{range $.items[@]}{.metadata.name}{end}&#39;</span><span class=sb>`</span>
</span></span><span class=line><span class=cl>  <span class=k>do</span> 
</span></span><span class=line><span class=cl>    kubectl scale deploy <span class=si>${</span><span class=nv>workload</span><span class=si>}</span> --replicas<span class=o>=</span><span class=m>0</span> -n <span class=si>${</span><span class=nv>namespace</span><span class=si>}</span>
</span></span><span class=line><span class=cl>  <span class=k>done</span>
</span></span><span class=line><span class=cl><span class=k>done</span></span></span></code></pre></td></tr></table></div></div></div></div><p>设置 deployment 的自动缩放</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl autoscale deployment &lt;deployment-name&gt; <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --min<span class=o>=</span>&lt;min-pods&gt; <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --max<span class=o>=</span>&lt;max-pods&gt; <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --cpu-percent<span class=o>=</span>&lt;cpu-percent&gt; <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -n &lt;namespace&gt;</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=daemonset>DaemonSet<a hidden class=anchor aria-hidden=true href=#daemonset>#</a></h3><p>调整一个 Daemonset 资源为 0</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl -n &lt;namespace&gt; patch daemonset &lt;name-of-daemon-set&gt; -p <span class=s1>&#39;{&#34;spec&#34;: {&#34;template&#34;: {&#34;spec&#34;: {&#34;nodeSelector&#34;: {&#34;disable&#34;: &#34;true&#34;}}}}}&#39;</span></span></span></code></pre></td></tr></table></div></div></div></div><p>恢复</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl -n &lt;namespace&gt; patch daemonset &lt;name-of-daemon-set&gt; --type json -p<span class=o>=</span><span class=s1>&#39;[{&#34;op&#34;: &#34;remove&#34;, &#34;path&#34;: &#34;/spec/template/spec/nodeSelector/disable&#34;}]&#39;</span></span></span></code></pre></td></tr></table></div></div></div></div><p>调整名称空间内的所有 Daemonset 工作负载数量为 0</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>NAMESPACE</span><span class=o>=</span>default
</span></span><span class=line><span class=cl><span class=k>for</span> daemonset in <span class=sb>`</span>kubectl get daemonset -n <span class=si>${</span><span class=nv>NAMESPACE</span><span class=si>}</span> -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{range $.items[@]}{.metadata.name}{end}&#39;</span><span class=sb>`</span><span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>  kubectl -n <span class=si>${</span><span class=nv>NAMESPACE</span><span class=si>}</span> patch daemonset <span class=si>${</span><span class=nv>daemonset</span><span class=si>}</span> -p <span class=s1>&#39;{&#34;spec&#34;: {&#34;template&#34;: {&#34;spec&#34;: {&#34;nodeSelector&#34;: {&#34;disable&#34;: &#34;true&#34;}}}}}&#39;</span>
</span></span><span class=line><span class=cl><span class=k>done</span></span></span></code></pre></td></tr></table></div></div></div></div><h2 id=hpa>HPA<a hidden class=anchor aria-hidden=true href=#hpa>#</a></h2><p>检查 HPA 状态</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get hpa -n &lt;namespace&gt;</span></span></code></pre></td></tr></table></div></div></div></div><h2 id=crd>CRD<a hidden class=anchor aria-hidden=true href=#crd>#</a></h2><p>批量删除 CRD 资源</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>KUBE_CMD</span><span class=o>=</span><span class=s1>&#39;kubectl --kubeconfig=&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> r in <span class=sb>`</span><span class=si>${</span><span class=nv>KUBE_CMD</span><span class=si>}</span> get crd -ojsonpath<span class=o>=</span><span class=s1>&#39;{range $.items[*]}{.metadata.name}{&#34;\n&#34;}{end}&#39;</span><span class=sb>`</span>
</span></span><span class=line><span class=cl><span class=k>do</span>
</span></span><span class=line><span class=cl>  <span class=nb>echo</span> <span class=nv>$r</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> ns in <span class=sb>`</span><span class=si>${</span><span class=nv>KUBE_CMD</span><span class=si>}</span> get ns -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{range $.items[*]}{.metadata.name}{&#34;\n&#34;}{end}&#39;</span><span class=sb>`</span>
</span></span><span class=line><span class=cl>  <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> crd_name in <span class=sb>`</span><span class=si>${</span><span class=nv>KUBE_CMD</span><span class=si>}</span> get <span class=nv>$r</span> -n <span class=nv>$ns</span> -ojsonpath<span class=o>=</span><span class=s1>&#39;{range $.items[*]}{.metadata.name}{&#34;\n&#34;}{end}&#39;</span><span class=sb>`</span>
</span></span><span class=line><span class=cl>    <span class=k>do</span>
</span></span><span class=line><span class=cl>      <span class=si>${</span><span class=nv>KUBE_CMD</span><span class=si>}</span> delete <span class=nv>$crd_name</span> -n <span class=nv>$ns</span>
</span></span><span class=line><span class=cl>    <span class=k>done</span>
</span></span><span class=line><span class=cl>  <span class=k>done</span>
</span></span><span class=line><span class=cl>  <span class=nb>echo</span> <span class=nv>$n</span> <span class=p>|</span> grep <span class=s2>&#34;cattle.io&#34;</span> <span class=o>&amp;&amp;</span> <span class=si>${</span><span class=nv>KUBE_CMD</span><span class=si>}</span> delete crd <span class=nv>$sn</span> --force
</span></span><span class=line><span class=cl><span class=k>done</span>
</span></span><span class=line><span class=cl><span class=sb>``</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## Networking</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>显示命名空间中 Pod 的 IP 地址：
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=sb>```</span>bash
</span></span><span class=line><span class=cl>kubectl get pods -n &lt;namespace -o custom-columns<span class=o>=</span>POD:metadata.name,IP:status.podIP --no-headers</span></span></code></pre></td></tr></table></div></div></div></div><h2 id=node>Node<a hidden class=anchor aria-hidden=true href=#node>#</a></h2><p>获取特定 Node 上运行的 Pod 列表</p><p>方法1</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get pods --field-selector spec.nodeName<span class=o>=</span>&lt;node-name&gt; -n &lt;namespace&gt;</span></span></code></pre></td></tr></table></div></div></div></div><p>方法2</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get pod -n <span class=o>{</span>ns<span class=o>}</span> -o <span class=se>\ </span>
</span></span><span class=line><span class=cl>  <span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{range $.items[?(@.spec.nodeName == &#34;xxxx&#34;)]}{.metadata.name}{&#34;\n&#34;}&#39;</span></span></span></code></pre></td></tr></table></div></div></div></div><p>方法3：检查多个 Node 上运行的 Pod 列表</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get pod -A -ojson <span class=p>|</span> jq -r <span class=s1>&#39;
</span></span></span><span class=line><span class=cl><span class=s1>  .items[] |
</span></span></span><span class=line><span class=cl><span class=s1>  select(.status.hostIP as $ip | $ip == &#34;10.10.10.124&#34; or $ip == &#34;10.10.10.153&#34; )|
</span></span></span><span class=line><span class=cl><span class=s1>  .metadata.namespace + &#34;/&#34; + .metadata.name + &#34; / &#34; + .status.hostIP&#39;</span></span></span></code></pre></td></tr></table></div></div></div></div><p>方法4：使用 JQ 简化查询（test）</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>KUBE_CMD</span><span class=o>=</span><span class=s1>&#39;kubectl kubeconfig=&#39;</span>
</span></span><span class=line><span class=cl><span class=nv>EXCLUDE_NS</span><span class=o>=</span><span class=s2>&#34;^kube.*|debug|logging|monitoring|default|cattle|fleet|infra&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>HOSTS</span><span class=o>=</span><span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=si>${</span><span class=nv>KUBE_CMD</span><span class=si>}</span> get pods -A -o json <span class=p>|</span> jq --arg EXCLUDE_NS <span class=si>${</span><span class=nv>EXCLUDE_NS</span><span class=si>}</span> --arg HOSTS <span class=si>${</span><span class=nv>HOSTS</span><span class=si>}</span> -r <span class=s1>&#39;
</span></span></span><span class=line><span class=cl><span class=s1>  .items[] | 
</span></span></span><span class=line><span class=cl><span class=s1>  select( .metadata.namespace | test($EXCLUDE_NS) | not ) |
</span></span></span><span class=line><span class=cl><span class=s1>  select( .status.hostIP | test($HOSTS) ) | 
</span></span></span><span class=line><span class=cl><span class=s1>  &#34;\(.metadata.namespace)/\(.metadata.name)/\(.status.hostIP)&#34;&#39;</span></span></span></code></pre></td></tr></table></div></div></div></div><p>获取 Node 的 IP</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get node -n <span class=o>{</span>ns<span class=o>}</span> -o <span class=se>\ </span>
</span></span><span class=line><span class=cl>  -o<span class=o>=</span><span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{range $.items[*]}{.metadata.name}{&#34;\t&#34;}{.status.addresses[0].address}{&#34;\n&#34;}{end}&#39;</span></span></span></code></pre></td></tr></table></div></div></div></div><p>获取 Node 上 指定标签</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get nodes <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -o<span class=o>=</span><span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{range .items[*]}{.metadata.name}{&#34;\t&#34;}{.metadata.labels.&lt;xxx&gt;}{&#34;\n&#34;}{end}&#39;</span></span></span></code></pre></td></tr></table></div></div></div></div><p>查找属于这个标签 Node 的数量</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get node -l <span class=nv>xxx</span><span class=o>=</span>xxxx --no-headers <span class=p>|</span> wc -l</span></span></code></pre></td></tr></table></div></div></div></div><p>查看node上所有的标签，json格式</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get node -o json <span class=p>|</span> jq <span class=s1>&#39;.items[] | {name: .metadata.name, labels: .metadata.labels }&#39;</span> --compact-output <span class=p>|</span> jq -r</span></span></code></pre></td></tr></table></div></div></div></div><p>根据 NodeSelector 查询 application</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get deployment -A <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -o<span class=o>=</span><span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{range .items[*]}{@.metadata.name}{&#34;\t&#34;}{range @.spec.template.spec.nodeSelector}{.xxxx}{&#34;\n&#34;}{end}{end}&#39;</span></span></span></code></pre></td></tr></table></div></div></div></div><p>根据条件列出 Node 1.17+</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get nodes -o <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  custom-columns<span class=o>=</span>NODE:.metadata.name,READY:.status.conditions<span class=o>[</span>?<span class=o>(</span>@.type<span class=o>==</span><span class=s2>&#34;Ready&#34;</span><span class=o>)]</span>.status -l <span class=s1>&#39;node-role.kubernetes.io/worker=xxx&#39;</span></span></span></code></pre></td></tr></table></div></div></div></div><p>获取 Node 的操作系统信息</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get node &lt;node-name&gt; -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{.status.nodeInfo.osImage}&#39;</span></span></span></code></pre></td></tr></table></div></div></div></div><p>查询应用 (Deployment) 使用的 Node</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl deployment -n <span class=o>{</span>ns<span class=o>}</span> -o <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  <span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{range $.item[*]}{&#34;Deployment: &#34;}{.metadata.name}{&#34;\n&#34;}{&#34;\t&#34;}{.spec.template.spec.nodeSelector.srv-grp}{&#34;\n&#34;}{end}&#39;</span></span></span></code></pre></td></tr></table></div></div></div></div><p>仅获取 Node 的指定标签和 Pod 名称</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>k get nodes -o <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{range .items[*]}{.metadata.labels.nodeSelector.xxxxx}{&#34;\t&#34;}{.status.addresses[?(@.type==&#34;InternalIP&#34;)].address}{&#34;\n&#34;}{end}&#39;</span></span></span></code></pre></td></tr></table></div></div></div></div><p>仅获取 Node IP</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>k get nodes -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{.items[*].status.addresses[?(@.type==&#34;InternalIP&#34;)].address}&#39;</span></span></span></code></pre></td></tr></table></div></div></div></div><p>获取指定标签的 Node，并输出他的标签和 IP</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>k get nodes -o <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	<span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{range .items[?(@.metadata.labels.xxxx==&#34;xxxx&#34;)]}{.metadata.labels.srv-grp}{&#34;\t&#34;}{.status.addresses[?(@.type==&#34;InternalIP&#34;)].address}{&#34;\n&#34;}{end}&#39;</span></span></span></code></pre></td></tr></table></div></div></div></div><p>获取指定 Role 的 Node 列表，只输出他的主机名</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>k get node --all-namespaces <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -o<span class=o>=</span><span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{range .items[?(@.metadata.labels.kubernetes.io/role==&#34;xxxx&#34;)]}{.metadata.name}{&#34;\n&#34;}{end}&#39;</span></span></span></code></pre></td></tr></table></div></div></div></div><p>修改指定 Role 的 Node 的角色值 (jq)</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 假设将 k8s role 为 aaa 的主机修改为 role=bbb</span>
</span></span><span class=line><span class=cl><span class=k>for</span> n in <span class=sb>`</span>k get nodes -o json <span class=p>|</span>jq -r <span class=s1>&#39;.items[] | select(.metadata.labels.&#34;kubernetes.io/role&#34; == &#34;aaa&#34;) | .metadata.name&#39;</span><span class=sb>`</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>do</span> 
</span></span><span class=line><span class=cl>  k label node <span class=nv>$n</span> kubernetes.io/role<span class=o>=</span>bbb --overwrite
</span></span><span class=line><span class=cl><span class=k>done</span></span></span></code></pre></td></tr></table></div></div></div></div><p>修改指定 Role 的 Node 的角色值 (jsonpath)</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 假设将 k8s node 标签 xxx 为 aaa 的主机修改为 xxx=bbb</span>
</span></span><span class=line><span class=cl><span class=k>for</span> n in <span class=sb>`</span>k get nodes -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{range .items[?(@.metadata.labels.xxx==&#34;aaa&#34;)]}{.metadata.name}{&#34;\n&#34;}{end}&#39;</span><span class=sb>`</span><span class=p>;</span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=k>do</span>
</span></span><span class=line><span class=cl>  k label node <span class=nv>$n</span> <span class=nv>xxx</span><span class=o>=</span>bbb  --overwrite
</span></span><span class=line><span class=cl><span class=k>done</span></span></span></code></pre></td></tr></table></div></div></div></div><p>打印 Node 所在的 Node 不要其他垃圾字段</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get pod -A -owide --no-headers <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --field-selector<span class=o>=</span><span class=s1>&#39;metadata.namespace!=infra,metadata.namespace!=debug,metadata.namespace!=kube-system,metadata.namespace!=logging,metadata.namespace!=monitoring&#39;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -o<span class=o>=</span>custom-columns<span class=o>=</span>NODE:.spec.nodeName,NAMESPACE:.metadata.namespace,NAME:.metadata.name<span class=p>|</span>grep <span class=si>${</span><span class=nv>n</span><span class=si>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>打印 所需要的 Node 不要其他垃圾字段</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>NODES</span><span class=o>=</span><span class=s2>&#34;xxxx xxxx xxxx&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> n in <span class=si>${</span><span class=nv>NODES</span><span class=si>}</span>
</span></span><span class=line><span class=cl><span class=k>do</span>
</span></span><span class=line><span class=cl>  <span class=nb>echo</span> <span class=si>${</span><span class=nv>n</span><span class=si>}</span>
</span></span><span class=line><span class=cl>  kubectl get pod -A -owide --no-headers <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --field-selector<span class=o>=</span><span class=s1>&#39;metadata.namespace!=infra,metadata.namespace!=debug,metadata.namespace!=kube-system,metadata.namespace!=logging,metadata.namespace!=monitoring&#39;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -o<span class=o>=</span>custom-columns<span class=o>=</span>NODE:.spec.nodeName,NAMESPACE:.metadata.namespace,NAME:.metadata.name<span class=p>|</span>grep <span class=si>${</span><span class=nv>n</span><span class=si>}</span>
</span></span><span class=line><span class=cl><span class=k>done</span></span></span></code></pre></td></tr></table></div></div></div></div><h2 id=resource-quotas>Resource Quotas<a hidden class=anchor aria-hidden=true href=#resource-quotas>#</a></h2><p>列出命名空间中的资源配额</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get resourcequotas -n &lt;namespace&gt;</span></span></code></pre></td></tr></table></div></div></div></div><p>查看资源配额详情</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl describe resourcequota &lt;resource-quota-name&gt; -n &lt;namespace&gt;</span></span></code></pre></td></tr></table></div></div></div></div><h2 id=volumes>Volumes<a hidden class=anchor aria-hidden=true href=#volumes>#</a></h2><p>按容量排序的列出PV</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get pv --sort-by<span class=o>=</span>.spec.capacity.storage</span></span></code></pre></td></tr></table></div></div></div></div><p>检查 PV reclaim policy</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get pv &lt;pv-name&gt; -o<span class=o>=</span><span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{.spec.persistentVolumeReclaimPolicy}&#39;</span></span></span></code></pre></td></tr></table></div></div></div></div><h2 id=ephemeral-containers>Ephemeral Containers<a hidden class=anchor aria-hidden=true href=#ephemeral-containers>#</a></h2><p>1.18+</p><p>运行一个 ephemeral debugging 容器</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl debug -it &lt;pod-name&gt; -n &lt;namespace&gt; --image<span class=o>=</span>&lt;debug-image&gt; -- /bin/sh</span></span></code></pre></td></tr></table></div></div></div></div><h2 id=pod-disruption-budget-pdb><strong>Pod Disruption Budget (PDB)</strong><a hidden class=anchor aria-hidden=true href=#pod-disruption-budget-pdb>#</a></h2><p>列出一个ns内的PDB</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get pdb -n &lt;namespace&gt;</span></span></code></pre></td></tr></table></div></div></div></div><h2 id=configmap>ConfigMap<a hidden class=anchor aria-hidden=true href=#configmap>#</a></h2><p>批量备份所有 configmap</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>KUBE_CMD</span><span class=o>=</span><span class=s1>&#39;kubectl --kubeconfig=&#39;</span>
</span></span><span class=line><span class=cl><span class=nv>BACKUP_PATH</span><span class=o>={</span>your backup path<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> ns in <span class=sb>`</span><span class=si>${</span><span class=nv>KUBE_CMD</span><span class=si>}</span> get ns -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{range $.items[*]}{.metadata.name}{&#34;\n&#34;}{end}&#39;</span><span class=sb>`</span>
</span></span><span class=line><span class=cl><span class=k>do</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> cn in <span class=sb>`</span><span class=si>${</span><span class=nv>KUBE_CMD</span><span class=si>}</span> get cm -n <span class=si>${</span><span class=nv>ns</span><span class=si>}</span> -ojsonpath<span class=o>=</span><span class=s1>&#39;{range $.items[*]}{.metadata.name}{&#34;\n&#34;}{end}&#39;</span><span class=sb>`</span>
</span></span><span class=line><span class=cl>  <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=si>${</span><span class=nv>KUBE_CMD</span><span class=si>}</span> get cm -n <span class=si>${</span><span class=nv>ns</span><span class=si>}</span> <span class=si>${</span><span class=nv>cn</span><span class=si>}</span> -o yaml <span class=p>|</span> sed -e <span class=s1>&#39;/resourceVersion:/d; /uid:/d; /selfLink:/d ; /creationTimestamp:/d; /lifecycle.cattle.io/d&#39;</span> &gt; <span class=si>${</span><span class=nv>BACKUP_PATH</span><span class=si>}</span>/<span class=nv>$ns</span>.<span class=nv>$sn</span>.yaml
</span></span><span class=line><span class=cl>  <span class=k>done</span>
</span></span><span class=line><span class=cl><span class=k>done</span></span></span></code></pre></td></tr></table></div></div></div></div><h2 id=secret>Secret<a hidden class=anchor aria-hidden=true href=#secret>#</a></h2><p>从一个 namespace 导出所有 secret 到另一个 namespace</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>OLD_NS</span><span class=o>=</span>
</span></span><span class=line><span class=cl><span class=nv>NEW_NS</span><span class=o>=</span>
</span></span><span class=line><span class=cl><span class=nv>KUBE_CMD</span><span class=o>=</span><span class=s1>&#39;kubectl --kubeconfig=&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> n in <span class=sb>`</span><span class=si>${</span><span class=nv>KUBE_CMD</span><span class=si>}</span> get secret -n <span class=si>${</span><span class=nv>OLD_NS</span><span class=si>}</span> -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{range $.items[*]}{.metadata.name}{&#34;\n&#34;}{end}&#39;</span><span class=sb>`</span><span class=p>;</span><span class=k>do</span>
</span></span><span class=line><span class=cl>  <span class=si>${</span><span class=nv>KUBE_CMD</span><span class=si>}</span> get secret -n <span class=si>${</span><span class=nv>OLD_NS</span><span class=si>}</span> <span class=nv>$n</span> -o yaml <span class=p>|</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  sed -e <span class=s1>&#39;/resourceVersion:/d;/uid:/d; /selfLink:/d; /creationTimestamp:/d; /namespace: /d;&#39;</span> <span class=p>|</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  <span class=si>${</span><span class=nv>KUBE_CMD</span><span class=si>}</span> create -n <span class=si>${</span><span class=nv>NEW_NS</span><span class=si>}</span> -f -
</span></span><span class=line><span class=cl><span class=k>done</span></span></span></code></pre></td></tr></table></div></div></div></div><p>其他方式</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>KUBE_CMD</span><span class=o>=</span><span class=s1>&#39;kubectl --kubeconfig=&#39;</span>
</span></span><span class=line><span class=cl><span class=nv>NAMESPACE</span><span class=o>=</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> n in <span class=sb>`</span><span class=si>${</span><span class=nv>KUBE_CMD</span><span class=si>}</span> get secret -n <span class=si>${</span><span class=nv>NAMESPACE</span><span class=si>}</span> -ojson <span class=p>|</span> jq -r <span class=s1>&#39;.items[].metadata.name&#39;</span><span class=sb>`</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>do</span>
</span></span><span class=line><span class=cl>  <span class=si>${</span><span class=nv>KUBE_CMD</span><span class=si>}</span> get secret -n <span class=si>${</span><span class=nv>NAMESPACE</span><span class=si>}</span> <span class=nv>$n</span> -o json <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  <span class=p>|</span> jq -r <span class=s1>&#39;del(.metadata[&#34;creationTimestamp&#34;,&#34;resourceVersion&#34;,&#34;selfLink&#34;,&#34;uid&#34;,&#34;annotations&#34;, namespace])&#39;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  <span class=si>${</span><span class=nv>KUBE_CMD</span><span class=si>}</span> create -n <span class=si>${</span><span class=nv>NAMESPACE</span><span class=si>}</span> -f -
</span></span><span class=line><span class=cl><span class=k>done</span>
</span></span><span class=line><span class=cl><span class=sb>```</span></span></span></code></pre></td></tr></table></div></div></div></div><p>复制集群中所有 namespace 的 secret 到另外一个新集群，并排除部分 namespace</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>KUBE_CMD</span><span class=o>=</span><span class=s1>&#39;kubectl --kubeconfig=&#39;</span>
</span></span><span class=line><span class=cl><span class=nv>NAMESPACE</span><span class=o>=</span>
</span></span><span class=line><span class=cl><span class=nv>EXCLUDE_NS</span><span class=o>=</span><span class=s1>&#39;default|debug|cattle|test|local|logging|skywalking|gke|ingress|kube|infra|opentelemetry&#39;</span>
</span></span><span class=line><span class=cl><span class=nv>KUBE_CMD_NEW</span><span class=o>=</span>kubectl --kubeconfig<span class=o>=</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> namespace in <span class=sb>`</span><span class=si>${</span><span class=nv>KUBE_CMD</span><span class=si>}</span> get ns -ojsonpath<span class=o>=</span><span class=s1>&#39;{range .items[*]}{.metadata.name}{&#34;\n&#34;}{end}&#39;</span><span class=p>|</span>grep -Ev <span class=si>${</span><span class=nv>EXCLUDE_NS</span><span class=si>}</span><span class=sb>`</span><span class=p>;</span> 
</span></span><span class=line><span class=cl><span class=k>do</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> n in <span class=sb>`</span><span class=si>${</span><span class=nv>KUBE_CMD</span><span class=si>}</span> get secret -n <span class=si>${</span><span class=nv>namespace</span><span class=si>}</span> -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{range $.items[*]}{.metadata.name}{&#34;\n&#34;}{end}&#39;</span><span class=sb>`</span><span class=p>;</span><span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=si>${</span><span class=nv>KUBE_CMD</span><span class=si>}</span> get secret -n <span class=si>${</span><span class=nv>namespace</span><span class=si>}</span> <span class=nv>$n</span> -o json <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      <span class=p>|</span> jq -r <span class=s1>&#39;del(.metadata[&#34;creationTimestamp&#34;,&#34;resourceVersion&#34;,&#34;selfLink&#34;,&#34;uid&#34;,&#34;finalizers&#34;,&#34;generation&#34;],.metadata.annotations[&#34;kubectl.kubernetes.io/last-applied-configuration&#34;])&#39;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      <span class=p>|</span> <span class=si>${</span><span class=nv>KUBE_CMD_NEW</span><span class=si>}</span> apply -f -	
</span></span><span class=line><span class=cl>  <span class=k>done</span>
</span></span><span class=line><span class=cl><span class=k>done</span></span></span></code></pre></td></tr></table></div></div></div></div><p>拷贝一个 secret 到 另外一个名称空间内</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>SRC_NS</span><span class=o>=</span>
</span></span><span class=line><span class=cl><span class=nv>DST_NS</span><span class=o>=</span>
</span></span><span class=line><span class=cl><span class=nv>SECRET_NAME</span><span class=o>=</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kubectl get secret -n <span class=si>${</span><span class=nv>SRC_NS</span><span class=si>}</span> <span class=si>${</span><span class=nv>SECRET_NAME</span><span class=si>}</span> -o json <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  <span class=p>|</span> jq -r <span class=s1>&#39;del(.metadata[&#34;creationTimestamp&#34;,&#34;resourceVersion&#34;,&#34;selfLink&#34;,&#34;uid&#34;,&#34;annotations&#34;,&#34;namespace&#34;])&#39;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  <span class=p>|</span> kubectl create -n <span class=si>${</span><span class=nv>DST_NS</span><span class=si>}</span> -f -</span></span></code></pre></td></tr></table></div></div></div></div><p>拷贝一个集群所有名称空间的 secret 到另一个集群</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>KUBE_CMD</span><span class=o>=</span><span class=s1>&#39;kubectl --kubeconfig=&#39;</span>
</span></span><span class=line><span class=cl><span class=nv>KUBE_CMD_NEW</span><span class=o>=</span><span class=s1>&#39;kubectl --kubeconfig=&#39;</span>
</span></span><span class=line><span class=cl><span class=nv>EXCLUDE_NS</span><span class=o>=</span><span class=s1>&#39;default|debug|cattle|test|local|logging|skywalking|spinnaker|gke.*|ingress|kube|infra|cicd|opentelemetry&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> i in <span class=sb>`</span><span class=si>${</span><span class=nv>KUBE_CMD</span><span class=si>}</span> get ns -ojsonpath<span class=o>=</span><span class=s1>&#39;{range .items[*]}{.metadata.name}{&#34;\n&#34;}{end}&#39;</span> <span class=p>|</span> grep -Ev <span class=si>${</span><span class=nv>EXCLUDE_NS</span><span class=si>}</span><span class=sb>`</span><span class=p>;</span> 
</span></span><span class=line><span class=cl><span class=k>do</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> n in <span class=sb>`</span><span class=si>${</span><span class=nv>KUBE_CMD</span><span class=si>}</span> get secert -n <span class=si>${</span><span class=nv>i</span><span class=si>}</span> -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{range $.items[*]}{.metadata.name}{&#34;\n&#34;}{end}&#39;</span><span class=sb>`</span><span class=p>;</span><span class=k>do</span>
</span></span><span class=line><span class=cl>  <span class=si>${</span><span class=nv>KUBE_CMD</span><span class=si>}</span> get secert -n <span class=si>${</span><span class=nv>i</span><span class=si>}</span> <span class=nv>$n</span> -o json <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=p>|</span> jq -r <span class=s1>&#39;del(.metadata[&#34;creationTimestamp&#34;,&#34;resourceVersion&#34;,&#34;selfLink&#34;,&#34;uid&#34;,&#34;finalizers&#34;,&#34;generation&#34;],.status,.spec.clusterIP,.spec.clusterIPs,.metadata.annotations[&#34;kubectl.kubernetes.io/last-applied-configuration&#34;])&#39;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=p>|</span> <span class=si>${</span><span class=nv>KUBE_CMD_NEW</span><span class=si>}</span> apply -f -	
</span></span><span class=line><span class=cl>  <span class=k>done</span>
</span></span><span class=line><span class=cl><span class=k>done</span></span></span></code></pre></td></tr></table></div></div></div></div><p>查看 secret 域名是多少</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>NAMESPACE</span><span class=o>=</span>bussniss
</span></span><span class=line><span class=cl><span class=nv>SECRET_NAME</span><span class=o>=</span>chinamobile.com
</span></span><span class=line><span class=cl><span class=nv>KEYWORKS</span><span class=o>=</span>crt
</span></span><span class=line><span class=cl><span class=nv>KUBE_CMD</span><span class=o>=</span><span class=s2>&#34;kubectl --kubeconfig=&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>openssl x509 -in &lt;<span class=o>(</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  <span class=si>${</span><span class=nv>KUBE_CMD</span><span class=si>}</span> get secret -n <span class=si>${</span><span class=nv>NAMESPACE</span><span class=si>}</span> <span class=si>${</span><span class=nv>SECRET_NAME</span><span class=si>}</span> -ojson <span class=p>|</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  jq --arg secret_key <span class=k>$(</span>
</span></span><span class=line><span class=cl>    <span class=si>${</span><span class=nv>KUBE_CMD</span><span class=si>}</span> get secret -n <span class=si>${</span><span class=nv>NAMESPACE</span><span class=si>}</span> <span class=si>${</span><span class=nv>SECRET_NAME</span><span class=si>}</span> -ojson <span class=p>|</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    jq -r <span class=s1>&#39;.data | keys[]&#39;</span> <span class=p>|</span> awk -v <span class=nv>kw</span><span class=o>=</span><span class=si>${</span><span class=nv>KEYWORKS</span><span class=si>}</span> <span class=s1>&#39;$0 ~ kw { print }&#39;</span>
</span></span><span class=line><span class=cl>  <span class=k>)</span> -r <span class=s1>&#39;.data | .[$secret_key]&#39;</span> <span class=p>|</span> base64 -d 
</span></span><span class=line><span class=cl><span class=o>)</span> -text -noout <span class=p>|</span> grep -i <span class=s2>&#34;subject: &#34;</span></span></span></code></pre></td></tr></table></div></div></div></div><p>查看证书是否过期</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>openssl x509 -in &lt;<span class=o>(</span>kubectl get secret -n bussniss xxx -ojson <span class=p>|</span>jq -r <span class=s1>&#39;.data.&#34;tls.crt&#34;&#39;</span><span class=p>|</span>base64 -d<span class=o>)</span> -text -noout<span class=p>|</span>grep <span class=s1>&#39;Not After&#39;</span></span></span></code></pre></td></tr></table></div></div></div></div><p>查看一个名称空间内的证书是否过期</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>KUBE_CMD</span><span class=o>=</span><span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl><span class=nv>KEYWORDS</span><span class=o>=</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> ns in <span class=sb>`</span><span class=si>${</span><span class=nv>KUBE_CMD</span><span class=si>}</span> get ns -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{range $.items[*]}{.metadata.name}{&#34;\n&#34;}{end}&#39;</span><span class=sb>`</span>
</span></span><span class=line><span class=cl><span class=k>do</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> sn in <span class=sb>`</span><span class=si>${</span><span class=nv>KUBE_CMD</span><span class=si>}</span> get secret -n <span class=nv>$ns</span> -o json<span class=p>|</span>jq -r <span class=s1>&#39;.items[] | select( .type == &#34;kubernetes.io/tls&#34;) | .metadata.name&#39;</span><span class=p>|</span>awk <span class=s1>&#39;$1 ~ /$KEYWORDS/ { print }&#39;</span><span class=sb>`</span>
</span></span><span class=line><span class=cl>  <span class=k>do</span> 
</span></span><span class=line><span class=cl>    openssl x509 -in &lt;<span class=o>(</span><span class=si>${</span><span class=nv>KUBE_CMD</span><span class=si>}</span> get secret -n <span class=nv>$ns</span> <span class=nv>$sn</span> -ojson <span class=p>|</span>jq -r <span class=s1>&#39;.data.&#34;tls.crt&#34;&#39;</span><span class=p>|</span>base64 -d<span class=o>)</span> -text -noout<span class=p>|</span>grep <span class=s1>&#39;Not After&#39;</span>
</span></span><span class=line><span class=cl>  <span class=k>done</span>
</span></span><span class=line><span class=cl><span class=k>done</span></span></span></code></pre></td></tr></table></div></div></div></div><p>查询所有tls的secret的域名</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>KUBE_CMD</span><span class=o>=</span><span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> n in <span class=sb>`</span><span class=si>${</span><span class=nv>KUBE_CMD</span><span class=si>}</span> get secret -A -o json<span class=p>|</span>jq -r <span class=s1>&#39;.items[] | select( .type == &#34;kubernetes.io/tls&#34; ) | .data | select(keys[0] == &#34;tls.crt&#34;) | .&#34;tls.crt&#34;&#39;</span><span class=sb>`</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>do</span>
</span></span><span class=line><span class=cl>  openssl x509 -in &lt;<span class=o>(</span><span class=nb>echo</span> <span class=nv>$n</span><span class=p>|</span>base64 -d<span class=o>)</span> -text -noout<span class=p>|</span>grep -i <span class=s1>&#39;subject&#39;</span>
</span></span><span class=line><span class=cl><span class=k>done</span></span></span></code></pre></td></tr></table></div></div></div></div><p>批量备份集群内指定类型的 secret 命令</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>KUBE_CMD</span><span class=o>=</span><span class=s1>&#39;kubectl --kubeconfig=&#39;</span>
</span></span><span class=line><span class=cl><span class=nv>KEYWORDS</span><span class=o>=</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> ns in <span class=sb>`</span><span class=si>${</span><span class=nv>KUBE_CMD</span><span class=si>}</span> get ns -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{range $.items[*]}{.metadata.name}{&#34;\n&#34;}{end}&#39;</span><span class=sb>`</span>
</span></span><span class=line><span class=cl><span class=k>do</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> secret_name in <span class=sb>`</span><span class=si>${</span><span class=nv>KUBE_CMD</span><span class=si>}</span> get secret -n <span class=nv>$ns</span> -o json <span class=p>|</span> jq -r <span class=s1>&#39;.items[] | select( .type == &#34;kubernetes.io/tls&#34;) | .metadata.name&#39;</span><span class=sb>`</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>  <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;[</span><span class=nv>$ns</span><span class=s2>]/[</span><span class=nv>$secret_name</span><span class=s2>]&#34;</span>
</span></span><span class=line><span class=cl>    openssl x509 -in &lt;<span class=o>(</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      <span class=si>${</span><span class=nv>KUBE_CMD</span><span class=si>}</span> get secret -n <span class=nv>$ns</span> <span class=nv>$secret_name</span> -ojson <span class=p>|</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      jq --arg secret_key <span class=k>$(</span><span class=si>${</span><span class=nv>KUBE_CMD</span><span class=si>}</span> get secret -n <span class=nv>$ns</span> <span class=nv>$secret_name</span> -ojson <span class=p>|</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      jq -r <span class=s1>&#39;.data|keys[]&#39;</span> <span class=p>|</span> awk <span class=s1>&#39;$0 ~ /crt/ { print }&#39;</span>
</span></span><span class=line><span class=cl>    <span class=k>)</span> -r <span class=s1>&#39;.data|.[]&#39;</span> <span class=p>|</span> base64 -d<span class=o>)</span> -text -noout <span class=p>|</span> grep -i <span class=s1>&#39;subject: &#39;</span> <span class=p>|</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    awk -v <span class=nv>ns</span><span class=o>=</span><span class=nv>$ns</span> -v <span class=nv>secret_name</span><span class=o>=</span><span class=nv>$secret_name</span> -v <span class=nv>kw</span><span class=o>=</span><span class=si>${</span><span class=nv>KEYWORDS</span><span class=si>}</span> -v <span class=nv>cmd</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>KUBE_CMD</span><span class=si>}</span><span class=s2>&#34;</span> <span class=s1>&#39;index($0, kw) &gt; 0 {
</span></span></span><span class=line><span class=cl><span class=s1>      system(cmd &#34; get secret &#34; secret_name &#34; -n &#34; ns &#34; -oyaml &gt; primetive/&#34; ns &#34;.&#34; secret_name &#34;.yaml&#34;)
</span></span></span><span class=line><span class=cl><span class=s1>    }&#39;</span> 
</span></span><span class=line><span class=cl>  <span class=k>done</span>
</span></span><span class=line><span class=cl><span class=k>done</span></span></span></code></pre></td></tr></table></div></div></div></div><p>查询 tls 签发域名，并进行替换</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>KEYWORDS</span><span class=o>=</span>
</span></span><span class=line><span class=cl><span class=nv>KUBE_CMD</span><span class=o>=</span><span class=s1>&#39;kubectl --kubeconfig=&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> ns in <span class=sb>`</span><span class=si>${</span><span class=nv>KUBE_CMD</span><span class=si>}</span> get ns -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;range $.items[*]}{.metadata.name}{&#34;\n&#34;}{&#34;end&#34;}&#39;</span>
</span></span><span class=line><span class=cl><span class=k>do</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> secret_name in <span class=sb>`</span><span class=si>${</span><span class=nv>KUBE_CMD</span><span class=si>}</span> get secret -n <span class=nv>$ns</span> -o json<span class=p>|</span>jq -r <span class=s1>&#39;.items[] | select( .type == &#34;kubernetes.io/tls&#34;) | .metadta.name&#39;</span><span class=sb>`</span>
</span></span><span class=line><span class=cl>  <span class=k>do</span>  
</span></span><span class=line><span class=cl>    openssl x509 -n &lt;<span class=o>(</span>
</span></span><span class=line><span class=cl>      <span class=si>${</span><span class=nv>KUBE_CMD</span><span class=si>}</span> get secret -n <span class=si>${</span><span class=nv>ns</span><span class=si>}</span> <span class=si>${</span><span class=nv>secret_name</span><span class=si>}</span> -ojson <span class=p>|</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      jq --arg secret_key <span class=k>$(</span><span class=si>${</span><span class=nv>KUBE_CMD</span><span class=si>}</span> get secret -n <span class=si>${</span><span class=nv>ns</span><span class=si>}</span> <span class=si>${</span><span class=nv>secret_name</span><span class=si>}</span> -ojson <span class=p>|</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      jq -r <span class=s1>&#39;.data | .keys[]&#39;</span> <span class=p>|</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      awk <span class=s1>&#39;$0 ~ /crt/ { print }&#39;</span> -r <span class=s1>&#39;.data|.[$secret_key]&#39;</span><span class=p>|</span>base64 -d
</span></span><span class=line><span class=cl>    <span class=k>)</span> -text -noout <span class=p>|</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    grep -i <span class=s2>&#34;subject: &#34;</span><span class=p>|</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    awk -v <span class=nv>ns</span><span class=o>=</span><span class=si>${</span><span class=nv>ns</span><span class=si>}</span> -v <span class=nv>secret_name</span><span class=o>=</span><span class=si>${</span><span class=nv>secret_name</span><span class=si>}</span> -v <span class=nv>commond</span><span class=o>=</span><span class=si>${</span><span class=nv>KUBE_CMD</span><span class=si>}</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      <span class=s1>&#39;$0 ~ ${KEYWORDS} { system(
</span></span></span><span class=line><span class=cl><span class=s1>        command&#34; create secret tls -n &#34;ns&#34; &#34;secret_name&#34; --cert=ca.crt --key=key.key --dry-run -oyaml|command&#34; replace -f -&#34;
</span></span></span><span class=line><span class=cl><span class=s1>      )}&#39;</span>
</span></span><span class=line><span class=cl>  <span class=k>done</span>
</span></span><span class=line><span class=cl><span class=k>done</span></span></span></code></pre></td></tr></table></div></div></div></div><p>使用本地固定证书作为新证书，替换集群内符合条件的secret</p><p>本命令只是打印生产的执行命令，主要使用 print</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>KUBE_CMD</span><span class=o>=</span>kubectl --kubeconfig<span class=o>=</span>
</span></span><span class=line><span class=cl><span class=nv>KEYWORDS</span><span class=o>=</span><span class=s2>&#34;chinamobile&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> ns in <span class=sb>`</span><span class=si>${</span><span class=nv>KUBE_CMD</span><span class=si>}</span> get ns -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{range $.items[*]}{.metadata.name}{&#34;\n&#34;}{end}&#39;</span><span class=sb>`</span>
</span></span><span class=line><span class=cl><span class=k>do</span>	
</span></span><span class=line><span class=cl>  <span class=k>for</span> secret_name in <span class=sb>`</span><span class=si>${</span><span class=nv>KUBE_CMD</span><span class=si>}</span> get secret -n <span class=nv>$ns</span> -o json<span class=p>|</span>jq -r <span class=s1>&#39;.items[] | select( .type == &#34;kubernetes.io/tls&#34;) | .metadata.name&#39;</span><span class=sb>`</span><span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>    openssl x509 -in &lt;<span class=o>(</span>
</span></span><span class=line><span class=cl>      <span class=si>${</span><span class=nv>KUBE_CMD</span><span class=si>}</span> get secret -n <span class=nv>$ns</span> <span class=nv>$secret_name</span> -ojson <span class=p>|</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>        jq --arg secret_key <span class=k>$(</span><span class=si>${</span><span class=nv>KUBE_CMD</span><span class=si>}</span> get secret -n <span class=nv>$ns</span> <span class=nv>$secret_name</span> -ojson <span class=p>|</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>        jq -r <span class=s1>&#39;.data|keys[]&#39;</span> <span class=p>|</span> awk <span class=s1>&#39;$0 ~ /crt/ { print }&#39;</span>
</span></span><span class=line><span class=cl>      <span class=k>)</span> -r <span class=s1>&#39;.data|.[$secret_key]&#39;</span> <span class=p>|</span> base64 -d
</span></span><span class=line><span class=cl>    <span class=o>)</span> -text -noout <span class=p>|</span> grep -i <span class=s1>&#39;subject: &#39;</span> <span class=p>|</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    awk -v <span class=nv>ns</span><span class=o>=</span><span class=nv>$ns</span> -v <span class=nv>secret_name</span><span class=o>=</span><span class=nv>$secret_name</span> -v <span class=nv>cmd</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>KUBE_CMD</span><span class=si>}</span><span class=s2>&#34;</span> -v <span class=nv>kw</span><span class=o>=</span><span class=si>${</span><span class=nv>KEYWORDS</span><span class=si>}</span> <span class=s1>&#39;$0 ~ kw { 
</span></span></span><span class=line><span class=cl><span class=s1>      print &#34;kubectl create secret tls &#34; secret_name &#34; -n &#34; ns &#34; --cert=xxx.crt --key=xxx.key --dry-run -oyaml | &#34; cmd &#34; replace -f -&#34; 
</span></span></span><span class=line><span class=cl><span class=s1>    }&#39;</span>
</span></span><span class=line><span class=cl>  <span class=k>done</span>
</span></span><span class=line><span class=cl><span class=k>done</span></span></span></code></pre></td></tr></table></div></div></div></div><div class="pe-details admonition tip open"><div class="pe-details-summary admonition-title"><i class="icon fas fa-lightbulb fa-fw" aria-hidden=true></i>tip<i class="pe-details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=pe-details-content><div class=admonition-content><p>该命令中用到的技巧</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get secret -n ms chinamobile.com -ojson <span class=p>|</span> jq -r <span class=s1>&#39;.data|keys[]&#39;</span> 
</span></span><span class=line><span class=cl><span class=c1># 获取 data下面所有属性的key</span>
</span></span><span class=line><span class=cl>awk <span class=s1>&#39;$0 ~ /crt/ { print }&#39;</span>
</span></span><span class=line><span class=cl><span class=c1># 匹配有crt的行，这里是正则，不能编写变量</span>
</span></span><span class=line><span class=cl>jq --arg secret_key <span class=k>$(</span>kubectl get secret -n monitoring chinamobile.com -ojson <span class=p>|</span> jq -r <span class=s1>&#39;.data|keys[]&#39;</span> <span class=p>|</span> awk <span class=s1>&#39;$0 ~ /crt/ { print }&#39;</span><span class=k>)</span> -r <span class=s1>&#39;.data|.[$secret_key]&#39;</span>
</span></span><span class=line><span class=cl><span class=c1># 前面获取到的json，然后定义变量 secret_key 他的值就是这个 json 内的 xxx.crt 最后通过 -r 解析原始json .data.[$secret_key] 就是拿到 xxx.crt 的 base64值</span></span></span></code></pre></td></tr></table></div></div></div></div></div></div></div><p>本命令是真实执行的命令</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>KUBE_CMD</span><span class=o>=</span>kubectl --kubeconfig<span class=o>=</span>
</span></span><span class=line><span class=cl><span class=nv>KEYWORDS</span><span class=o>=</span><span class=s2>&#34;chinamobile&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> ns in <span class=sb>`</span><span class=si>${</span><span class=nv>KUBE_CMD</span><span class=si>}</span> get ns -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{range $.items[*]}{.metadata.name}{&#34;\n&#34;}{end}&#39;</span><span class=sb>`</span><span class=p>;</span> <span class=k>do</span>	
</span></span><span class=line><span class=cl>  <span class=k>for</span> secret_name in <span class=sb>`</span><span class=si>${</span><span class=nv>KUBE_CMD</span><span class=si>}</span> get secret -n <span class=nv>$ns</span> -o json<span class=p>|</span>jq -r <span class=s1>&#39;.items[] | select( .type == &#34;kubernetes.io/tls&#34;) | .metadata.name&#39;</span><span class=sb>`</span><span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>    openssl x509 -in &lt;<span class=o>(</span>
</span></span><span class=line><span class=cl>      <span class=si>${</span><span class=nv>KUBE_CMD</span><span class=si>}</span> get secret -n <span class=nv>$ns</span> <span class=nv>$secret_name</span> -ojson <span class=p>|</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>        jq --arg secret_key <span class=k>$(</span><span class=si>${</span><span class=nv>KUBE_CMD</span><span class=si>}</span> get secret -n <span class=nv>$ns</span> <span class=nv>$secret_name</span> -ojson <span class=p>|</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>        jq -r <span class=s1>&#39;.data|keys[]&#39;</span> <span class=p>|</span> awk <span class=s1>&#39;$0 ~ /crt/ { print }&#39;</span>
</span></span><span class=line><span class=cl>      <span class=k>)</span> -r <span class=s1>&#39;.data|.[$secret_key]&#39;</span> <span class=p>|</span> base64 -d
</span></span><span class=line><span class=cl>    <span class=o>)</span> -text -noout <span class=p>|</span> grep -i <span class=s1>&#39;subject: &#39;</span> <span class=p>|</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    awk -v <span class=nv>ns</span><span class=o>=</span><span class=nv>$ns</span> -v <span class=nv>secret_name</span><span class=o>=</span><span class=nv>$secret_name</span> -v <span class=nv>cmd</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>KUBE_CMD</span><span class=si>}</span><span class=s2>&#34;</span> -v <span class=nv>kw</span><span class=o>=</span><span class=si>${</span><span class=nv>KEYWORDS</span><span class=si>}</span> <span class=s1>&#39;$0 ~ kw { 
</span></span></span><span class=line><span class=cl><span class=s1>      system(&#34;${KUBE_CMD} create secret tls &#34; secret_name &#34; -n &#34; ns &#34; --cert=ca.crt --key=chinamobile.key --dry-run -oyaml | &#34; cmd &#34; replace -f -&#34;)
</span></span></span><span class=line><span class=cl><span class=s1>    }&#39;</span>
</span></span><span class=line><span class=cl>  <span class=k>done</span>
</span></span><span class=line><span class=cl><span class=k>done</span></span></span></code></pre></td></tr></table></div></div></div></div></div><div class=pe-copyright><hr><blockquote><p>本文为原创内容，版权归作者所有。如需转载，请在文章中声明本文标题及链接。</p><p>文章标题：探索kubectl - kubectl诊断命令集合</p><p>文章链接：<a href=https://www.oomkill.com/2024/04/kubernetes-kubectl-diagnose/ target=_blank>https://www.oomkill.com/2024/04/kubernetes-kubectl-diagnose/</a></p><p>许可协议：<a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></p></blockquote></div><div class=comments-separator></div><h3 class=relatedContentTitle>相关阅读</h3><ul class=relatedContent><li><a href=/2023/02/ch23-extend-kube-proxy/><span>深入理解Kubernetes service - 如何扩展现有的kube-proxy架构？</span></a></li><li><a href=/2024/02/kubernetes-update-secert/><span>Kubernetes维护 - secret批量更新</span></a></li><li><a href=/2024/02/k8s-jsonnet/><span>k8s - jsonnet从入门到放弃</span></a></li><li><a href=/2024/01/ch30-oomkill/><span>深入理解Kubernetes - 基于OOMKill的QoS的设计</span></a></li><li><a href=/2023/11/ch07-in-cluster-pod/><span>client-go - Pod使用in-cluster方式访问集群</span></a></li></ul><div class=comments-separator></div><footer class=post-footer><ul class=post-tags><li><a href=https://www.oomkill.com/tags/kubernetes/>Kubernetes</a></li></ul><nav class=paginav><a class=prev href=https://www.oomkill.com/2024/05/gke-vpc-firewall/><span class=title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left" style="user-select:text"><line x1="19" y1="12" x2="5" y2="12" style="user-select:text"/><polyline points="12 19 5 12 12 5" style="user-select:text"/></polyline></svg>&nbsp;</span>
<span>GKE - 为GKE集群增加VPC防火墙规则</span>
</a><a class=next href=https://www.oomkill.com/2024/03/upgrade-harbor/><span class=title></span>
<span>批量更新harbor版本 1.10 to 2.10&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right" style="user-select:text"><line x1="5" y1="12" x2="19" y2="12" style="user-select:text"/><polyline points="12 5 19 12 12 19" style="user-select:text"/></svg></span></a></nav></footer><div class=pe-comments-decoration><p class=pe-comments-title></p><p class=pe-comments-subtitle></p></div><div id=pe-comments></div><script src=/js/pe-go-comment.min.86a214102576ba5f9b7bdc29eed8d58dd56e34aef80b3c65c73ea9cc88443696.js integrity="sha256-hqIUECV2ul+be9wp7tjVjdVuNK74Czxlxz6pzIhENpY="></script><script>const getStoredTheme=()=>localStorage.getItem("pref-theme")==="dark"?"dark":"light",setGiscusTheme=()=>{const e=e=>{const t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:e},"https://giscus.app")};e({setConfig:{theme:getStoredTheme()}})};document.addEventListener("DOMContentLoaded",()=>{const s={src:"https://giscus.app/client.js","data-repo":"cylonchau/cylonchau.github.io","data-repo-id":"R_kgDOIRlNSQ","data-category":"Announcements","data-category-id":"DIC_kwDOIRlNSc4CXy1U","data-mapping":"pathname","data-term":"posts/Kubernetes-kubectl-diagnose","data-strict":"0","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"top","data-theme":getStoredTheme(),"data-lang":"zh-TW","data-loading":"lazy",crossorigin:"anonymous",async:""},e=document.createElement("script");Object.entries(s).forEach(([t,n])=>e.setAttribute(t,n)),document.querySelector("#pe-comments").appendChild(e);const t=document.querySelector("#theme-toggle");t&&t.addEventListener("click",setGiscusTheme);const n=document.querySelector("#theme-toggle-float");n&&n.addEventListener("click",setGiscusTheme)})</script></article></main><footer class=footer><span>&copy; 2024 <a href=https://www.oomkill.com/>Cylon's Collection</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> on
<a href=https://pages.github.com/ rel=noopener target=_blank>GitHub Pages</a> & Theme
        <a href=https://github.com/tofuwine/PaperMod-PE rel=noopener target=_blank>PaperMod-PE</a></span></footer><div class=pe-right-sidebar><a href=javascript:void(0); id=theme-toggle-float class=pe-float-btn><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</a><a href=#top class=pe-float-btn id=top-link><span id=pe-read-progress></span></a></div><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>