<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>深入解析Kubernetes监控体系与prometheus-adapter | Cylon's Collection</title><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NP3JNCPR" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><meta name=keywords content="prometheus,monitor,adapter"><meta name=description content="Kubernetes监控架构设计 k8s监控设计背景说明 根据 Kubernetes监控架构 1，Kubernetes 集群中的 metrcis 可以分为 系统指标 (Core Metrics) 和 服务指标 (service metrics) ; 系统指标(System metrics) 是通用的指标，通常可以从每一个被监控的实体中获得（例如，容器和节点的CPU和内存使用情况）。服务指标(Service metrics) 是在应用程序代码中显式定义并暴露的 (例如，API Server 处理的 500 错误数量)。
Kubernetes将系统指标分为两部分：
核心指标 (core metrics) 是 Kubernetes 理解和用于其内部组件和核心工具操作的指标，例如：用于调度的指标 (包括资源估算算法的输入, 初始资源/VPA (vertical autoscaling)，集群自动扩缩 (cluster autoscaling)，水平Pod自动扩缩 (horizontal pod autoscaling ) 除自定义指标之外的指标)；Kube Dashboard 使用的指标，以及 “kubectl top” 命令使用的指标。 非核心指标 (non-core metrics) 是指不被 Kubernetes 解释的指标。我们一般假设这些指标包含核心指标 (但不一定是 Kubernetes 可理解的格式)，以及其他额外的指标。 所以，kubernetes monitoring 的架构被设计拥有如下特点：
通过标准的主 API (当前为主监控 API) 提供关于Node, Pod 和容器的核心系统指标，使得核心 Kubernetes 功能不依赖于非核心组件 kubelet 只导出有限的指标集，即核心 Kubernetes 组件正常运行所需的指标。 &mldr; 监控管道 Kubernetes 监控管道分为两个："><meta name=author content="cylon"><link rel=canonical href=https://www.oomkill.com/2024/05/prometheus-adapter-intro/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://www.oomkill.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.oomkill.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.oomkill.com/favicon-32x32.png><link rel=apple-touch-icon href=https://www.oomkill.com/favicon.ico><link rel=mask-icon href=https://www.oomkill.com/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://www.oomkill.com/2024/05/prometheus-adapter-intro/><noscript><style>#theme-toggle,#top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link crossorigin=anonymous href=/assets/css/pe.min.css rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/pe.min.js></script><link rel=stylesheet href=https://cdn.staticfile.net/font-awesome/6.5.1/css/all.min.css><link rel=stylesheet href=https://cdn.staticfile.net/font-awesome/6.5.1/css/v4-shims.min.css><script id=MathJax-script async src=https://cdn.staticfile.net/mathjax/3.2.2/es5/tex-chtml.js></script><script>MathJax={tex:{displayMath:[["$$","$$"]],inlineMath:[["\\$","\\$"]]}}</script><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><meta name=referrer content="no-referrer-when-downgrade"><script>(function(e,t,n,s,o){e[s]=e[s]||[],e[s].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var a=t.getElementsByTagName(n)[0],i=t.createElement(n),r=s!="dataLayer"?"&l="+s:"";i.async=!0,i.src="https://www.googletagmanager.com/gtm.js?id="+o+r,a.parentNode.insertBefore(i,a)})(window,document,"script","dataLayer","GTM-NP3JNCPR")</script><meta property="og:title" content="深入解析Kubernetes监控体系与prometheus-adapter"><meta property="og:description" content="Kubernetes监控架构设计 k8s监控设计背景说明 根据 Kubernetes监控架构 1，Kubernetes 集群中的 metrcis 可以分为 系统指标 (Core Metrics) 和 服务指标 (service metrics) ; 系统指标(System metrics) 是通用的指标，通常可以从每一个被监控的实体中获得（例如，容器和节点的CPU和内存使用情况）。服务指标(Service metrics) 是在应用程序代码中显式定义并暴露的 (例如，API Server 处理的 500 错误数量)。
Kubernetes将系统指标分为两部分：
核心指标 (core metrics) 是 Kubernetes 理解和用于其内部组件和核心工具操作的指标，例如：用于调度的指标 (包括资源估算算法的输入, 初始资源/VPA (vertical autoscaling)，集群自动扩缩 (cluster autoscaling)，水平Pod自动扩缩 (horizontal pod autoscaling ) 除自定义指标之外的指标)；Kube Dashboard 使用的指标，以及 “kubectl top” 命令使用的指标。 非核心指标 (non-core metrics) 是指不被 Kubernetes 解释的指标。我们一般假设这些指标包含核心指标 (但不一定是 Kubernetes 可理解的格式)，以及其他额外的指标。 所以，kubernetes monitoring 的架构被设计拥有如下特点：
通过标准的主 API (当前为主监控 API) 提供关于Node, Pod 和容器的核心系统指标，使得核心 Kubernetes 功能不依赖于非核心组件 kubelet 只导出有限的指标集，即核心 Kubernetes 组件正常运行所需的指标。 &mldr; 监控管道 Kubernetes 监控管道分为两个："><meta property="og:type" content="article"><meta property="og:url" content="https://www.oomkill.com/2024/05/prometheus-adapter-intro/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-05-31T00:00:00+00:00"><meta property="og:site_name" content="Cylon's Collection"><meta name=twitter:card content="summary"><meta name=twitter:title content="深入解析Kubernetes监控体系与prometheus-adapter"><meta name=twitter:description content="Kubernetes监控架构设计 k8s监控设计背景说明 根据 Kubernetes监控架构 1，Kubernetes 集群中的 metrcis 可以分为 系统指标 (Core Metrics) 和 服务指标 (service metrics) ; 系统指标(System metrics) 是通用的指标，通常可以从每一个被监控的实体中获得（例如，容器和节点的CPU和内存使用情况）。服务指标(Service metrics) 是在应用程序代码中显式定义并暴露的 (例如，API Server 处理的 500 错误数量)。
Kubernetes将系统指标分为两部分：
核心指标 (core metrics) 是 Kubernetes 理解和用于其内部组件和核心工具操作的指标，例如：用于调度的指标 (包括资源估算算法的输入, 初始资源/VPA (vertical autoscaling)，集群自动扩缩 (cluster autoscaling)，水平Pod自动扩缩 (horizontal pod autoscaling ) 除自定义指标之外的指标)；Kube Dashboard 使用的指标，以及 “kubectl top” 命令使用的指标。 非核心指标 (non-core metrics) 是指不被 Kubernetes 解释的指标。我们一般假设这些指标包含核心指标 (但不一定是 Kubernetes 可理解的格式)，以及其他额外的指标。 所以，kubernetes monitoring 的架构被设计拥有如下特点：
通过标准的主 API (当前为主监控 API) 提供关于Node, Pod 和容器的核心系统指标，使得核心 Kubernetes 功能不依赖于非核心组件 kubelet 只导出有限的指标集，即核心 Kubernetes 组件正常运行所需的指标。 &mldr; 监控管道 Kubernetes 监控管道分为两个："><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://www.oomkill.com/posts/"},{"@type":"ListItem","position":2,"name":"深入解析Kubernetes监控体系与prometheus-adapter","item":"https://www.oomkill.com/2024/05/prometheus-adapter-intro/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"深入解析Kubernetes监控体系与prometheus-adapter","name":"深入解析Kubernetes监控体系与prometheus-adapter","description":"Kubernetes监控架构设计 k8s监控设计背景说明 根据 Kubernetes监控架构 1，Kubernetes 集群中的 metrcis 可以分为 系统指标 (Core Metrics) 和 服务指标 (service metrics) ; 系统指标(System metrics) 是通用的指标，通常可以从每一个被监控的实体中获得（例如，容器和节点的CPU和内存使用情况）。服务指标(Service metrics) 是在应用程序代码中显式定义并暴露的 (例如，API Server 处理的 500 错误数量)。\nKubernetes将系统指标分为两部分：\n核心指标 (core metrics) 是 Kubernetes 理解和用于其内部组件和核心工具操作的指标，例如：用于调度的指标 (包括资源估算算法的输入, 初始资源/VPA (vertical autoscaling)，集群自动扩缩 (cluster autoscaling)，水平Pod自动扩缩 (horizontal pod autoscaling ) 除自定义指标之外的指标)；Kube Dashboard 使用的指标，以及 “kubectl top” 命令使用的指标。 非核心指标 (non-core metrics) 是指不被 Kubernetes 解释的指标。我们一般假设这些指标包含核心指标 (但不一定是 Kubernetes 可理解的格式)，以及其他额外的指标。 所以，kubernetes monitoring 的架构被设计拥有如下特点：\n通过标准的主 API (当前为主监控 API) 提供关于Node, Pod 和容器的核心系统指标，使得核心 Kubernetes 功能不依赖于非核心组件 kubelet 只导出有限的指标集，即核心 Kubernetes 组件正常运行所需的指标。 \u0026hellip; 监控管道 Kubernetes 监控管道分为两个：","keywords":["prometheus","monitor","adapter"],"articleBody":"Kubernetes监控架构设计 k8s监控设计背景说明 根据 Kubernetes监控架构 1，Kubernetes 集群中的 metrcis 可以分为 系统指标 (Core Metrics) 和 服务指标 (service metrics) ; 系统指标(System metrics) 是通用的指标，通常可以从每一个被监控的实体中获得（例如，容器和节点的CPU和内存使用情况）。服务指标(Service metrics) 是在应用程序代码中显式定义并暴露的 (例如，API Server 处理的 500 错误数量)。\nKubernetes将系统指标分为两部分：\n核心指标 (core metrics) 是 Kubernetes 理解和用于其内部组件和核心工具操作的指标，例如：用于调度的指标 (包括资源估算算法的输入, 初始资源/VPA (vertical autoscaling)，集群自动扩缩 (cluster autoscaling)，水平Pod自动扩缩 (horizontal pod autoscaling ) 除自定义指标之外的指标)；Kube Dashboard 使用的指标，以及 “kubectl top” 命令使用的指标。 非核心指标 (non-core metrics) 是指不被 Kubernetes 解释的指标。我们一般假设这些指标包含核心指标 (但不一定是 Kubernetes 可理解的格式)，以及其他额外的指标。 所以，kubernetes monitoring 的架构被设计拥有如下特点：\n通过标准的主 API (当前为主监控 API) 提供关于Node, Pod 和容器的核心系统指标，使得核心 Kubernetes 功能不依赖于非核心组件 kubelet 只导出有限的指标集，即核心 Kubernetes 组件正常运行所需的指标。 … 监控管道 Kubernetes 监控管道分为两个：\n核心指标管道 (core metrics pipeline) 由 Kubelet、资源估算器, 一个精简版 Heapster (metrics-server)，以及 api-server 中 master metrics API 组成。这些指标被核心系统组件使用，例如调度逻辑（如调度器和基于系统指标的HPA）和一些简单 UI 组件（如 kubectl top），这个管道并不打算与第三方监控系统集成。 监控管道：一个用于收集系统中的各种指标并将其暴露给最终用户端，以及通过适配器暴露给 HPA(用于自定义指标) 和 Infrastore 的。用户可以选择多种监控系统供应商（例如 Prometheus, metric-server），也可以完全不使用。 Core Metrics Pipeline 根据 kubernetes 监控设计文档可以得知，核心指标指\n使用这组核心指标，由Kubelet收集，并仅供 Kubernetes 系统组件使用，支持\"第一类资源隔离和利用特性\"。 不设计成面向用户的 API，而是尽可能通用，以支持未来的用户级组件。 核心指标的包含三类：\nCpuUsage: 记录从创建对象开始的累计CPU使用时间。 MemoryUsage: 记录工作集内存使用量。 FilesystemUsage: 记录文件系统使用情况,包括已用字节数和已用Inode数。 Monitoring Pipeline 根据 Kubernetes 监控设计文档 1 得知，监控管道用于与核心Kubernetes组件分开的系统，可以更加灵活。并且监控管道可以收集不同类型的指标：\nCore system metrics Non-core system metrics Service metrics from user application containers Service metrics from Kubernetes infrastructure containers (using Prometheus instrumentation) 监控管道主要用于根据自定义指标进行 HPA，监控管道提供了一个无状态的 API Adapter，用于拉去监控给 HPA\n指标API API类别 根据监控架构设计文档，Kubernetes 定义了两套指标 API，资源指标 API 和 自定义指标 API；Kubernetes 为资源指标 API 提供了两种实现：Heapster 和 metrics-server，而自定义指标 API 由不同的监控供应商实现。下面将详细描述每个 API。\n资源指标 API (Resource Metrics API)：该 API 允许消费者访问 Pod 和 Node 的资源指标（CPU \u0026 Memory）\nThe API is implemented by metrics-server and prometheus-adapter. 自定义指标 API (Custom Metrics API)：该 API 允许消费者访问描述 Kubernetes 资源的任意指标。\n用户可以根据 kubernetes-sigs/custom-metrics-apiserver 仓库来自定义 API-server API的访问 资源指标，该 API 是在 /apis/metrics.k8s.io/ ，可以使用 kubectl proxy --port 8080 代理后进行访问，\nbash 1 2 $ kubectl proxy --port=8080 $ curl localhost:8080/apis/metrics.k8s.io/v1beta1/nodes 或者使用 kubectl get --raw 进行获取\nbash 1 $ kubectl get --raw \"/apis/metrics.k8s.io/v1beta1/nodes\" | jq 自定义指标，该 API 是在 /apis/custom.metrics.k8s.io/ ，访问的方式相同，用户通过该 PATH 进行访问。\nbash 1 2 # 查看有哪些指标可用 $ kubectl get --raw \"/apis/custom.metrics.k8s.io/v1beta1/\" | jq Prometheus-adapter 通过上一章节介绍了kubernetes监控体系，这已经可以了解到了 prometheus-adapter 的定位；prometheus-adapter 是通过 kubernetes custom-metrics-apiserver 标准实现的一个 custom.metrics.k8s.io API，用于提供给 HPA 的一种指标适配器，可以将任何指标转化为 HPA 可用的指标。他全名为 Kubernetes Custom Metrics Adapter for Prometheus。\nprometheus-adapter配置文件详解 prometheus-adapter负责确定哪些指标以及如何去发现这些指标，根据这个标准，配置文件分为四个步骤来完成这套 “发现” 规则\n每一个指标可以大致分为四个部分，对应在配置文件中：\nDiscovery ，用于指定 adapter 应如何查找此规则的所有Prometheus指标。 Association ，用于指定 adapter 应如何确定特定指标与哪些 Kubernetes 资源相关联。 Naming ，用于指定 adapter 应如何在自定义指标 API 中公开该指标。 Querying ，用于指定如何将针对一个或多个 Kubernetes 对象的特定指标请求转换为对 Prometheus 的查询。 配置文件如下所示，这是官方给出的样板配置文件（文章编写时版本为0.12）\nyaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 rules: # Each rule represents a some naming and discovery logic. # Each rule is executed independently of the others, so # take care to avoid overlap. As an optimization, rules # with the same `seriesQuery` but different # `name` or `seriesFilters` will use only one query to # Prometheus for discovery. # some of these rules are taken from the \"default\" configuration, which # can be found in pkg/config/default.go # this rule matches cumulative cAdvisor metrics measured in seconds - seriesQuery: '{__name__=~\"^container_.*\",container!=\"POD\",namespace!=\"\",pod!=\"\"}' resources: # skip specifying generic resource\u003c-\u003elabel mappings, and just # attach only pod and namespace resources by mapping label names to group-resources overrides: namespace: {resource: \"namespace\"} pod: {resource: \"pod\"} # specify that the `container_` and `_seconds_total` suffixes should be removed. # this also introduces an implicit filter on metric family names name: # we use the value of the capture group implicitly as the API name # we could also explicitly write `as: \"$1\"` matches: \"^container_(.*)_seconds_total$\" # specify how to construct a query to fetch samples for a given series # This is a Go template where the `.Series` and `.LabelMatchers` string values # are available, and the delimiters are `\u003c\u003c` and `\u003e\u003e` to avoid conflicts with # the prometheus query language metricsQuery: \"sum(rate(\u003c\u003c.Series\u003e\u003e{\u003c\u003c.LabelMatchers\u003e\u003e,container!=\"POD\"}[2m])) by (\u003c\u003c.GroupBy\u003e\u003e)\" # this rule matches cumulative cAdvisor metrics not measured in seconds - seriesQuery: '{__name__=~\"^container_.*_total\",container!=\"POD\",namespace!=\"\",pod!=\"\"}' resources: overrides: namespace: {resource: \"namespace\"} pod: {resource: \"pod\"} seriesFilters: # since this is a superset of the query above, we introduce an additional filter here - isNot: \"^container_.*_seconds_total$\" name: {matches: \"^container_(.*)_total$\"} metricsQuery: \"sum(rate(\u003c\u003c.Series\u003e\u003e{\u003c\u003c.LabelMatchers\u003e\u003e,container!=\"POD\"}[2m])) by (\u003c\u003c.GroupBy\u003e\u003e)\" # this rule matches cumulative non-cAdvisor metrics - seriesQuery: '{namespace!=\"\",__name__!=\"^container_.*\"}' name: {matches: \"^(.*)_total$\"} resources: # specify an a generic mapping between resources and labels. This # is a template, like the `metricsQuery` template, except with the `.Group` # and `.Resource` strings available. It will also be used to match labels, # so avoid using template functions which truncate the group or resource. # Group will be converted to a form acceptible for use as a label automatically. template: \"\u003c\u003c.Resource\u003e\u003e\" # if we wanted to, we could also specify overrides here metricsQuery: \"sum(rate(\u003c\u003c.Series\u003e\u003e{\u003c\u003c.LabelMatchers\u003e\u003e,container!=\"POD\"}[2m])) by (\u003c\u003c.GroupBy\u003e\u003e)\" # this rule matches only a single metric, explicitly naming it something else # It's series query *must* return only a single metric family - seriesQuery: 'cheddar{sharp=\"true\"}' # this metric will appear as \"cheesy_goodness\" in the custom metrics API name: {as: \"cheesy_goodness\"} resources: overrides: # this should still resolve in our cluster brand: {group: \"cheese.io\", resource: \"brand\"} metricsQuery: 'count(cheddar{sharp=\"true\"})' # external rules are not tied to a Kubernetes resource and can reference any metric # https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough/#autoscaling-on-metrics-not-related-to-kubernetes-objects externalRules: - seriesQuery: '{__name__=\"queue_consumer_lag\",name!=\"\"}' metricsQuery: sum(\u003c\u003c.Series\u003e\u003e{\u003c\u003c.LabelMatchers\u003e\u003e}) by (name) - seriesQuery: '{__name__=\"queue_depth\",topic!=\"\"}' metricsQuery: sum(\u003c\u003c.Series\u003e\u003e{\u003c\u003c.LabelMatchers\u003e\u003e}) by (name) # Kubernetes metric queries include a namespace in the query by default # but you can explicitly disable namespaces if needed with \"namespaced: false\" # this is useful if you have an HPA with an external metric in namespace A # but want to query for metrics from namespace B resources: namespaced: false # TODO: should we be able to map to a constant instance of a resource # (e.g. `resources: {constant: [{resource: \"namespace\", name: \"kube-system\"}}]`)? Discovery Discovery 部分控制了查找要在自定义指标 API 中公开的指标的过程。其中有两个关键字段：seriesQuery 和 seriesFilters。\nseriesQuery 指定了用于查找某些 Prometheus series 的 Prometheus series 查询(作为传递给 Prometheus /api/v1/series)。适配器将从这些系列中剥离标签值，然后在后续步骤中使用得到的“指标名称—标签名称”的组合。\n在许多情况下，seriesQuery 就足以缩小 Prometheus series 的列表。但有时(特别是当两个规则可能重叠时)，对指标名称进行额外的过滤是很有用的。在这种情况下,可以使用 seriesFilters。在从 seriesQuery 返回 series 列表后，每个 series 的指标名称都会通过指定的任何过滤器进行过滤。\n过滤器可以是以下两种形式之一:\nis: ，匹配名称符合指定正则表达式的任何序列。 isNot: ，匹配名称不符合指定正则表达式的任何序列。 例如\nyaml 1 2 3 4 # match all cAdvisor metrics that aren't measured in seconds seriesQuery: '{__name__=~\"^container_.*_total\",container!=\"POD\",namespace!=\"\",pod!=\"\"}' seriesFilters: - isNot: \"^container_.*_seconds_total\" Association Association 部分控制了确定序列指标可以附加到哪些 Kubernetes 资源的过程。resources 字段控制了这个过程。\n有两种方式来关联资源与特定指标。在这两种情况下,标签的值都会成为特定对象的名称。\n一种方式是指定，任何符合某个特定模式的标签名称都指向基于标签名称的某个“group_resource”。这可以使用 template 字段来完成。pattern 被指定为一个 Go 模板，其中 Group 和 Resource 字段分别代表“组”和“资源”。\nyaml 1 2 3 # any label `kube__` becomes . in Kubernetes resources: template: \"kube_\u003c\u003c.Group\u003e\u003e_\u003c\u003c.Resource\u003e\u003e\" 另一种方式是指定某个特定标签代表某个特定的 Kubernetes 资源。这可以使用 overrides 字段来完成。每个 override 将一个 Prometheus 标签映射到一个 Kubernetes group-resource。例如:\nyaml 1 2 3 4 5 6 # the microservice label corresponds to the apps.deployment resource resources: overrides: microservice: group: \"apps\" resource: \"deployment\" Association 部分提供了两种关联 Prometheus 指标和 Kubernetes 资源的方式，可以根据需要灵活地组合使用。这是实现自定义指标 API 的关键一环。\nNaming Naming 部分控制了将 Prometheus 指标名称转换为自定义指标 API 中的指标，这是通过 name 字段来实现的。\nNaming 的控制通过指定一个从 Prometheus 名称中提取 API 名称的模式，以及对提取值进行的可选转换来实现。\n模式由 matches 字段指定，这是一个正则表达式。如果没有指定,它默认为 .* 。\n转换由 as 字段指定。你可以使用 matches 字段中定义的任何捕获组。如果 matches 字段没有捕获组，as 字段默认为 $0 。如果只包含一个捕获组，as 字段默认为 $1 。否则，如果没有指定 as 字段就会出错。例如\nyaml 1 2 3 4 5 # match turn any name _total to _per_second # e.g. http_requests_total becomes http_requests_per_second name: matches: \"^(.*)_total$\" as: \"${1}_per_second\" Querying Querying 部分控制了实际获取特定指标值的过程。它由 metricsQuery 字段来控制。\nmetricsQuery 字段是一个 Go 模板,它会被转换成一个 Prometheus 查询，使用从特定的自定义指标 API 调用获取的输入数据。对自定义指标 API 的一次调用会被简化为一个指标名称、一个 “group-resource” 和一个或多个该 “group-resource” 的对象。这些会被转换成模板中的以下字段:\nSeries: 指标名称 LabelMatchers: 一个逗号分隔的标签匹配器列表，匹配给定的对象。当前包括特定的 “group-resource” 标签，以及 namespace 标。 GroupBy: 一个逗号分隔的用于分组的标签列表。当前包括用于 LabelMatchers 的组-资源标签。 例如，假设我们有一个 http_requests_total 序列 (在 API 中公开为 http_requests_per_second )，具有 service、pod、ingress、namespace 和 verb 标签。前四个对应于 Kubernetes 资源。那么,如果有人请求了 pods/http_request_per_second 指标，那么针对 somens 命名空间中的 pod1 和 pod2，我们会有:\nSeries: “http_requests_total” LabelMatchers: \"pod=~\"pod1|pod2\",namespace=\"somens\"\" GroupBy: pod 对应 prometheus promql 如下所示\nbash 1 sum(http_requests_total{pod=~\"pod1|pod2\",namespace=\"somens\"}) by (pod) 此外,还有两个高级字段是其他字段的\"原始\"形式:\nLabelValuesByName: 映射。将 LabelMatchers 字段中的标签和值对应起来。值是用 | 预先连接的 (用于在 Prometheus 中使用 =~ 匹配器)。 GroupBySlice: GroupBy 字段的切片形式。 通常，我们可能会想使用 Series、LabelMatchers 和 GroupBy 字段。其他两个是用于高级用法的。\nQuerying 预计会为每个请求的对象返回一个值。适配器会使用返回的系列上的标签，将给定的系列关联回其相应的对象。例如:\nbash 1 2 # convert cumulative cAdvisor metrics into rates calculated over 2 minutes metricsQuery: \"sum(rate(\u003c\u003c.Series\u003e\u003e{\u003c\u003c.LabelMatchers\u003e\u003e,container!=\"POD\"}[2m])) by (\u003c\u003c.GroupBy\u003e\u003e)\" 完整的配置文件实例 例如，我们想使用 springboot 的 actuator 提供的 jvm_memory_used_bytes 和 jvm_memory_max_bytes 计算内存使用率，如下所式\nyaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 rules: - seriesQuery: 'jvm_memory_used_bytes' resources: overrides: namespace: resource: \"namespace\" pod: resource: \"pod\" name: matches: 'jvm_memory_used_bytes' as: memory_percent metricsQuery: 'sum(jvm_memory_used_bytes{\u003c\u003c.LabelMatchers\u003e\u003e}) by (\u003c\u003c.GroupBy\u003e\u003e) / sum(jvm_memory_max_bytes{\u003c\u003c.LabelMatchers\u003e\u003e}) by (\u003c\u003c.GroupBy\u003e\u003e) * 100' - seriesQuery: 'process_cpu_usage' resources: overrides: namespace: resource: \"namespace\" pod: resource: \"pod\" name: matches: 'process_cpu_usage' as: process_cpu_percent metricsQuery: 'sum(avg_over_time(process_cpu_usage{\u003c\u003c.LabelMatchers\u003e\u003e}[1m])) by (\u003c\u003c.GroupBy\u003e\u003e)' 这里用到了一个技巧，就是使用查询多个指标，这里参考了 prometheus-adapter 的说明 4\n这很好理解,虽然一开始可能看起来不太明显。\n基本上，你只需要选择一个指标作为 “Discovery” 和 “naming” 指标，然后使用它来配置配置中的 “discovery” 和 “naming” 部分。之后，你就可以在 metricsQuery 中写任何你想要的指标了！ ==Querying 的序列可以包含任何你想要的指标，只要它们有正确的标签集合即可==。\n例如，假设你有两个指标 foo_total 和 foo_count，它们都有一个标签 system_name，用于表示节点资源，那么如下配置所示\nyaml 1 2 3 4 5 6 7 rules: - seriesQuery: 'foo_total' resources: {overrides: {system_name: {resource: \"node\"}}} name: matches: 'foo_total' as: 'foo' metricsQuery: 'sum(foo_total{\u003c\u003c.LabelMatchers\u003e\u003e}) by (\u003c\u003c.GroupBy\u003e\u003e) / sum(foo_count{\u003c\u003c.LabelMatchers\u003e\u003e}) by (\u003c\u003c.GroupBy\u003e\u003e)' 由于我们使用了 jvm_memory_used_bytes 和 jvm_memory_max_bytes ，那么我们可以在 “discovery” 和 “naming” 部分写任意指标，在 ”quering“ 中使用真是的指标进行替换，就可以完成\n查询 kubernetes 的指标 完成配置后，可以使用下面命令进行查询\nbash 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 kubectl get --raw \"/apis/custom.metrics.k8s.io/v1beta1\"|jq { \"kind\": \"APIResourceList\", \"apiVersion\": \"v1\", \"groupVersion\": \"custom.metrics.k8s.io/v1beta1\", \"resources\": [ { \"name\": \"pods/process_cpu_percent\", \"singularName\": \"\", \"namespaced\": true, \"kind\": \"MetricValueList\", \"verbs\": [ \"get\" ] }, { \"name\": \"pods/memory_percent\", \"singularName\": \"\", \"namespaced\": true, \"kind\": \"MetricValueList\", \"verbs\": [ \"get\" ] }, { \"name\": \"namespaces/memory_percent\", \"singularName\": \"\", \"namespaced\": false, \"kind\": \"MetricValueList\", \"verbs\": [ \"get\" ] }, { \"name\": \"namespaces/process_cpu_percent\", \"singularName\": \"\", \"namespaced\": false, \"kind\": \"MetricValueList\", \"verbs\": [ \"get\" ] } ] } 可以通过 custom API 进程查询具体获取的值，如下所示\nbash 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 $ kubectl get --raw \"/apis/custom.metrics.k8s.io/v1beta1/namespaces/public/pods/*/process_cpu_percent\"|jq { \"kind\": \"MetricValueList\", \"apiVersion\": \"custom.metrics.k8s.io/v1beta1\", \"metadata\": {}, \"items\": [ { \"describedObject\": { \"kind\": \"Pod\", \"namespace\": \"msg\", \"name\": \"message-gateway-api-78c4d5cdbf-9k2g7\", \"apiVersion\": \"/v1\" }, \"metricName\": \"process_cpu_percent\", \"timestamp\": \"2024-05-31T11:40:25Z\", \"value\": \"404m\", \"selector\": null }, ... { \"describedObject\": { \"kind\": \"Pod\", \"namespace\": \"msg\", \"name\": \"message-core-79fdc6fdd-lkpdm\", \"apiVersion\": \"/v1\" }, \"metricName\": \"process_cpu_percent\", \"timestamp\": \"2024-05-31T11:40:25Z\", \"value\": \"31m\", \"selector\": null }, { \"describedObject\": { \"kind\": \"Pod\", \"namespace\": \"msg\", \"name\": \"message-push-admin-554f5d96fd-xlnhj\", \"apiVersion\": \"/v1\" }, \"metricName\": \"process_cpu_percent\", \"timestamp\": \"2024-05-31T11:40:25Z\", \"value\": \"487m\", \"selector\": null } ] } 我们可以看到，返回值是带有 ”m“ 的单位，这里 issue 是这样回答的\nThe m-suffix means milli, Quantity Values are explained here: https://github.com/kubernetes-sigs/prometheus-adapter/blob/master/docs/walkthrough.md#quantity-values 5\n在指标 API 中最常见的是 m 后缀,它表示毫单位，即单位的千分之一；由于我们返回值是一个百分比，例如 4.87%，那么实际值是 0.0487，那么他的毫单位为就是 “487m” ，和上面返回值一样。\nPrometheus-adapter的安装 在这里采用 helm 方式进行安装，只需要修改对应参数即可\nbash 1 2 3 4 helm install prometheus-adapter -n monitoring prometheus-community/prometheus-adapter \\ --set prometheus.url=http://prometheus.default.svc \\ --set logLevel=2 \\ --set rules.external=xxx # 如果使用外部规则替换默认的config.yaml,则需要提前创建一个configmap，然后这里指定这个名称 Reference [1] Kubernetes monitoring architecture\n[2] core-metrics-pipeline\n[3] kubernetes/metrics\n[4] my-query-contains-multiple-metrics-how-do-i-make-that-work\n[5] why i request rest-api, returned requeslt for item value has ’m’ unit!! #376\n[6] Guide to Kubernetes Metrics\n[7] Kubernetes 监控架构(译)\n","wordCount":"1688","inLanguage":"zh","datePublished":"2024-05-31T00:00:00Z","dateModified":"0001-01-01T00:00:00Z","author":{"@type":"Person","name":"cylon"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.oomkill.com/2024/05/prometheus-adapter-intro/"},"publisher":{"@type":"Organization","name":"Cylon's Collection","logo":{"@type":"ImageObject","url":"https://www.oomkill.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.oomkill.com/><img src=https://www.oomkill.com/favicon.ico alt aria-label=logo height=20>Cylon's Collection</a><div class=logo-switches><button id=theme-toggle><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://www.oomkill.com/archives><span>归档</span></a></li><li><a href=https://www.oomkill.com/tags><span>标签</span></a></li><li><a href=https://www.oomkill.com/search><span>搜索</span></a></li><li><a href=https://www.oomkill.com/about accesskey=/><span>关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">深入解析Kubernetes监控体系与prometheus-adapter</h1><div class=post-meta><span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar" style="user-select:text"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" style="user-select:text"/><line x1="16" y1="2" x2="16" y2="6" style="user-select:text"/><line x1="8" y1="2" x2="8" y2="6" style="user-select:text"/><line x1="3" y1="10" x2="21" y2="10" style="user-select:text"/></svg><span>2024-05-31</span></span>&nbsp;·&nbsp;<span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text" style="user-select:text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z" style="user-select:text"/><polyline points="14 2 14 8 20 8" style="user-select:text"/><line x1="16" y1="13" x2="8" y2="13" style="user-select:text"/><line x1="16" y1="17" x2="8" y2="17" style="user-select:text"/><polyline points="10 9 9 9 8 9" style="user-select:text"/></svg><span>1688 字</span></span>&nbsp;·&nbsp;<span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><span>8 分钟</span></span>
<span class=pe-post-meta-item>&nbsp;·&nbsp;<svg t="1714036239378" fill="currentcolor" class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="6659" width="256" height="256"><path d="M690 78.2c-18.6-18.8-49-19-67.8-.4s-19 49-.4 67.8l255.4 258.6c67.8 68.6 67.8 178.8.0 247.4L653.4 878.2c-18.6 18.8-18.4 49.2.4 67.8s49.2 18.4 67.8-.4l224-226.4c104.8-106 104.8-276.4.0-382.4L690 78.2zM485.4 101.4c-24-24-56.6-37.4-90.6-37.4H96C43 64 0 107 0 160v299c0 34 13.4 66.6 37.4 90.6l336 336c50 50 131 50 181 0l267-267c50-50 50-131 0-181l-336-336zM96 160h299c8.4.0 16.6 3.4 22.6 9.4l336 336c12.4 12.4 12.4 32.8.0 45.2l-267 267c-12.4 12.4-32.8 12.4-45.2.0l-336-336c-6-6-9.4-14.2-9.4-22.6V160zm192 128a64 64 0 10-128 0 64 64 0 10128 0z" p-id="6660"/></svg></span><ul class=pe-post-meta-item><a href=https://www.oomkill.com/tags/monitor/>#Monitor</a>
<a href=https://www.oomkill.com/tags/kubernetes/>#Kubernetes</a></ul></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details><summary><span class=details>目录</span></summary><div class=inner><ul><li><a href=#kubernetes%e7%9b%91%e6%8e%a7%e6%9e%b6%e6%9e%84%e8%ae%be%e8%ae%a1 aria-label=Kubernetes监控架构设计>Kubernetes监控架构设计</a><ul><li><a href=#k8s%e7%9b%91%e6%8e%a7%e8%ae%be%e8%ae%a1%e8%83%8c%e6%99%af%e8%af%b4%e6%98%8e aria-label=k8s监控设计背景说明>k8s监控设计背景说明</a><li><a href=#%e7%9b%91%e6%8e%a7%e7%ae%a1%e9%81%93 aria-label=监控管道>监控管道</a><ul><li><a href=#core-metrics-pipeline aria-label="Core Metrics Pipeline">Core Metrics Pipeline</a><li><a href=#monitoring-pipeline aria-label="Monitoring Pipeline">Monitoring Pipeline</a></ul><li><a href=#%e6%8c%87%e6%a0%87api aria-label=指标API>指标API</a><ul><li><a href=#api%e7%b1%bb%e5%88%ab aria-label=API类别>API类别</a><li><a href=#api%e7%9a%84%e8%ae%bf%e9%97%ae aria-label=API的访问>API的访问</a></ul></ul><li><a href=#prometheus-adapter aria-label=Prometheus-adapter>Prometheus-adapter</a><ul><li><a href=#prometheus-adapter%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6%e8%af%a6%e8%a7%a3 aria-label=prometheus-adapter配置文件详解>prometheus-adapter配置文件详解</a><ul><li><a href=#discovery aria-label=Discovery>Discovery</a><li><a href=#association aria-label=Association>Association</a><li><a href=#naming aria-label=Naming>Naming</a><li><a href=#querying aria-label=Querying>Querying</a></ul><li><a href=#%e5%ae%8c%e6%95%b4%e7%9a%84%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6%e5%ae%9e%e4%be%8b aria-label=完整的配置文件实例>完整的配置文件实例</a><ul><li><a href=#%e6%9f%a5%e8%af%a2-kubernetes-%e7%9a%84%e6%8c%87%e6%a0%87 aria-label="查询 kubernetes 的指标">查询 kubernetes 的指标</a></ul><li><a href=#prometheus-adapter%e7%9a%84%e5%ae%89%e8%a3%85 aria-label=Prometheus-adapter的安装>Prometheus-adapter的安装</a></ul><li><a href=#reference aria-label=Reference>Reference</a></li></div></details></div></aside><script src=/js/pe-toc.min.445eb1bfc5e85dd13b9519fcc2a806522e9629b6224a2974052789ba00ab78af.js integrity="sha256-RF6xv8XoXdE7lRn8wqgGUi6WKbYiSil0BSeJugCreK8="></script><div class=post-content><h2 id=kubernetes监控架构设计>Kubernetes监控架构设计<a hidden class=anchor aria-hidden=true href=#kubernetes监控架构设计>#</a></h2><h3 id=k8s监控设计背景说明>k8s监控设计背景说明<a hidden class=anchor aria-hidden=true href=#k8s监控设计背景说明>#</a></h3><p>根据 Kubernetes监控架构 <sup><a href=#1>1</a></sup>，Kubernetes 集群中的 metrcis 可以分为 <strong>系统指标</strong> (Core Metrics) 和 <strong>服务指标</strong> (service metrics) ; 系统指标(System metrics) 是通用的指标，通常可以从每一个被监控的实体中获得（例如，容器和节点的CPU和内存使用情况）。服务指标(Service metrics) 是在应用程序代码中显式定义并暴露的 (例如，API Server 处理的 500 错误数量)。</p><p>Kubernetes将系统指标分为两部分：</p><ul><li>核心指标 (core metrics) 是 Kubernetes 理解和用于其内部组件和核心工具操作的指标，例如：用于调度的指标 (包括资源估算算法的输入, 初始资源/VPA (vertical autoscaling)，集群自动扩缩 (cluster autoscaling)，水平Pod自动扩缩 (horizontal pod autoscaling ) 除自定义指标之外的指标)；Kube Dashboard 使用的指标，以及 “kubectl top” 命令使用的指标。</li><li>非核心指标 (non-core metrics) 是指不被 Kubernetes 解释的指标。我们一般假设这些指标包含核心指标 (但不一定是 Kubernetes 可理解的格式)，以及其他额外的指标。</li></ul><p>所以，kubernetes monitoring 的架构被设计拥有如下特点：</p><ul><li>通过标准的主 API (当前为主监控 API) 提供关于Node, Pod 和容器的核心系统指标，使得核心 Kubernetes 功能不依赖于非核心组件</li><li>kubelet 只导出有限的指标集，即核心 Kubernetes 组件正常运行所需的指标。</li><li>&mldr;</li></ul><h3 id=监控管道>监控管道<a hidden class=anchor aria-hidden=true href=#监控管道>#</a></h3><p>Kubernetes 监控管道分为两个：</p><ul><li>核心指标管道 (<strong>core metrics pipeline</strong>) 由 Kubelet、资源估算器, 一个精简版 Heapster (metrics-server)，以及 api-server 中 master metrics API 组成。这些指标被核心系统组件使用，例如调度逻辑（如调度器和基于系统指标的HPA）和一些简单 UI 组件（如 kubectl top），这个管道并不打算与第三方监控系统集成。</li><li>监控管道：一个用于收集系统中的各种指标并将其暴露给最终用户端，以及通过适配器暴露给 HPA(用于自定义指标) 和 Infrastore 的。用户可以选择多种监控系统供应商（例如 Prometheus, metric-server），也可以完全不使用。</li></ul><h4 id=core-metrics-pipeline>Core Metrics Pipeline<a hidden class=anchor aria-hidden=true href=#core-metrics-pipeline>#</a></h4><p>根据 kubernetes 监控设计文档可以得知，核心指标指</p><ul><li>使用这组核心指标，由Kubelet收集，并仅供 Kubernetes 系统组件使用，支持"第一类资源隔离和利用特性"。</li><li>不设计成面向用户的 API，而是尽可能通用，以支持未来的用户级组件。</li></ul><p>核心指标的包含三类：</p><ul><li>CpuUsage: 记录从创建对象开始的累计CPU使用时间。</li><li>MemoryUsage: 记录工作集内存使用量。</li><li>FilesystemUsage: 记录文件系统使用情况,包括已用字节数和已用Inode数。</li></ul><h4 id=monitoring-pipeline>Monitoring Pipeline<a hidden class=anchor aria-hidden=true href=#monitoring-pipeline>#</a></h4><p>根据 Kubernetes 监控设计文档 <sup><a href=#1>1</a></sup> 得知，监控管道用于与核心Kubernetes组件分开的系统，可以更加灵活。并且监控管道可以收集不同类型的指标：</p><ul><li>Core system metrics</li><li>Non-core system metrics</li><li>Service metrics from user application containers</li><li>Service metrics from Kubernetes infrastructure containers (using Prometheus instrumentation)</li></ul><p>监控管道主要用于根据自定义指标进行 HPA，监控管道提供了一个无状态的 API Adapter，用于拉去监控给 HPA</p><h3 id=指标api>指标API<a hidden class=anchor aria-hidden=true href=#指标api>#</a></h3><h4 id=api类别>API类别<a hidden class=anchor aria-hidden=true href=#api类别>#</a></h4><p>根据监控架构设计文档，Kubernetes 定义了两套指标 API，资源指标 API 和 自定义指标 API；Kubernetes 为资源指标 API 提供了两种实现：Heapster 和 metrics-server，而自定义指标 API 由不同的监控供应商实现。下面将详细描述每个 API。</p><ul><li><p>资源指标 API (Resource Metrics API)：该 API 允许消费者访问 Pod 和 Node 的资源指标（CPU & Memory）</p><ul><li>The API is implemented by metrics-server and prometheus-adapter.</li></ul></li><li><p>自定义指标 API (Custom Metrics API)：该 API 允许消费者访问描述 Kubernetes 资源的任意指标。</p><ul><li>用户可以根据 <a href=https://github.com/kubernetes-sigs/custom-metrics-apiserver target=_blank rel="noopener nofollow noreferrer">kubernetes-sigs/custom-metrics-apiserver </a>仓库来自定义 API-server</li></ul></li></ul><h4 id=api的访问>API的访问<a hidden class=anchor aria-hidden=true href=#api的访问>#</a></h4><p>资源指标，该 API 是在 <code>/apis/metrics.k8s.io/</code> ，可以使用 <code>kubectl proxy --port 8080</code> 代理后进行访问，</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl proxy --port<span class=o>=</span><span class=m>8080</span>
</span></span><span class=line><span class=cl>$ curl localhost:8080/apis/metrics.k8s.io/v1beta1/nodes</span></span></code></pre></td></tr></table></div></div></div></div><p>或者使用 <code>kubectl get --raw</code> 进行获取</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl get --raw <span class=s2>&#34;/apis/metrics.k8s.io/v1beta1/nodes&#34;</span> <span class=p>|</span> jq </span></span></code></pre></td></tr></table></div></div></div></div><p>自定义指标，该 API 是在 <code>/apis/custom.metrics.k8s.io/</code> ，访问的方式相同，用户通过该 PATH 进行访问。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 查看有哪些指标可用</span>
</span></span><span class=line><span class=cl>$ kubectl get --raw <span class=s2>&#34;/apis/custom.metrics.k8s.io/v1beta1/&#34;</span> <span class=p>|</span> jq</span></span></code></pre></td></tr></table></div></div></div></div><h2 id=prometheus-adapter>Prometheus-adapter<a hidden class=anchor aria-hidden=true href=#prometheus-adapter>#</a></h2><p>通过上一章节介绍了kubernetes监控体系，这已经可以了解到了 prometheus-adapter 的定位；prometheus-adapter 是通过 kubernetes custom-metrics-apiserver 标准实现的一个 custom.metrics.k8s.io API，用于提供给 HPA 的一种指标适配器，可以将任何指标转化为 HPA 可用的指标。他全名为 <strong>Kubernetes Custom Metrics Adapter for Prometheus</strong>。</p><h3 id=prometheus-adapter配置文件详解>prometheus-adapter配置文件详解<a hidden class=anchor aria-hidden=true href=#prometheus-adapter配置文件详解>#</a></h3><p>prometheus-adapter负责确定哪些指标以及如何去发现这些指标，根据这个标准，配置文件分为四个步骤来完成这套 “发现” 规则</p><p>每一个指标可以大致分为四个部分，对应在配置文件中：</p><ul><li><em>Discovery</em> ，用于指定 adapter 应如何查找此规则的所有Prometheus指标。</li><li><em>Association</em> ，用于指定 adapter 应如何确定特定指标与哪些 Kubernetes 资源相关联。</li><li><em>Naming</em> ，用于指定 adapter 应如何在自定义指标 API 中公开该指标。</li><li><em>Querying</em> ，用于指定如何将针对一个或多个 Kubernetes 对象的特定指标请求转换为对 Prometheus 的查询。</li></ul><p>配置文件如下所示，这是官方给出的样板<a href=https://github.com/kubernetes-sigs/prometheus-adapter/blob/v0.12.0/docs/sample-config.yaml target=_blank rel="noopener nofollow noreferrer">配置文件</a>（文章编写时版本为0.12）</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>yaml</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Each rule represents a some naming and discovery logic.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Each rule is executed independently of the others, so</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># take care to avoid overlap.  As an optimization, rules</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># with the same `seriesQuery` but different</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># `name` or `seriesFilters` will use only one query to</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Prometheus for discovery.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># some of these rules are taken from the &#34;default&#34; configuration, which</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># can be found in pkg/config/default.go</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># this rule matches cumulative cAdvisor metrics measured in seconds</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>seriesQuery</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;{__name__=~&#34;^container_.*&#34;,container!=&#34;POD&#34;,namespace!=&#34;&#34;,pod!=&#34;&#34;}&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># skip specifying generic resource&lt;-&gt;label mappings, and just</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># attach only pod and namespace resources by mapping label names to group-resources</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>overrides</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span>{<span class=nt>resource</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;namespace&#34;</span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>pod</span><span class=p>:</span><span class=w> </span>{<span class=nt>resource</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;pod&#34;</span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># specify that the `container_` and `_seconds_total` suffixes should be removed.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># this also introduces an implicit filter on metric family names</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># we use the value of the capture group implicitly as the API name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># we could also explicitly write `as: &#34;$1&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matches</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;^container_(.*)_seconds_total$&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># specify how to construct a query to fetch samples for a given series</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># This is a Go template where the `.Series` and `.LabelMatchers` string values</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># are available, and the delimiters are `&lt;&lt;` and `&gt;&gt;` to avoid conflicts with</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># the prometheus query language</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>metricsQuery</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;sum(rate(&lt;&lt;.Series&gt;&gt;{&lt;&lt;.LabelMatchers&gt;&gt;,container!=&#34;</span><span class=l>POD&#34;}[2m])) by (&lt;&lt;.GroupBy&gt;&gt;)&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># this rule matches cumulative cAdvisor metrics not measured in seconds</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>seriesQuery</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;{__name__=~&#34;^container_.*_total&#34;,container!=&#34;POD&#34;,namespace!=&#34;&#34;,pod!=&#34;&#34;}&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>overrides</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span>{<span class=nt>resource</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;namespace&#34;</span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>pod</span><span class=p>:</span><span class=w> </span>{<span class=nt>resource</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;pod&#34;</span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>seriesFilters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># since this is a superset of the query above, we introduce an additional filter here</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>isNot</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;^container_.*_seconds_total$&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span>{<span class=nt>matches</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;^container_(.*)_total$&#34;</span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>metricsQuery</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;sum(rate(&lt;&lt;.Series&gt;&gt;{&lt;&lt;.LabelMatchers&gt;&gt;,container!=&#34;</span><span class=l>POD&#34;}[2m])) by (&lt;&lt;.GroupBy&gt;&gt;)&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># this rule matches cumulative non-cAdvisor metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>seriesQuery</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;{namespace!=&#34;&#34;,__name__!=&#34;^container_.*&#34;}&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span>{<span class=nt>matches</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;^(.*)_total$&#34;</span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># specify an a generic mapping between resources and labels.  This</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># is a template, like the `metricsQuery` template, except with the `.Group`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># and `.Resource` strings available.  It will also be used to match labels,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># so avoid using template functions which truncate the group or resource.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># Group will be converted to a form acceptible for use as a label automatically.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>template</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&lt;&lt;.Resource&gt;&gt;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># if we wanted to, we could also specify overrides here</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>metricsQuery</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;sum(rate(&lt;&lt;.Series&gt;&gt;{&lt;&lt;.LabelMatchers&gt;&gt;,container!=&#34;</span><span class=l>POD&#34;}[2m])) by (&lt;&lt;.GroupBy&gt;&gt;)&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># this rule matches only a single metric, explicitly naming it something else</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># It&#39;s series query *must* return only a single metric family</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>seriesQuery</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;cheddar{sharp=&#34;true&#34;}&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># this metric will appear as &#34;cheesy_goodness&#34; in the custom metrics API</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span>{<span class=nt>as</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;cheesy_goodness&#34;</span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>overrides</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># this should still resolve in our cluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>brand</span><span class=p>:</span><span class=w> </span>{<span class=nt>group</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;cheese.io&#34;</span><span class=nt>, resource</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;brand&#34;</span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>metricsQuery</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;count(cheddar{sharp=&#34;true&#34;})&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># external rules are not tied to a Kubernetes resource and can reference any metric</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough/#autoscaling-on-metrics-not-related-to-kubernetes-objects</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>externalRules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>seriesQuery</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;{__name__=&#34;queue_consumer_lag&#34;,name!=&#34;&#34;}&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>metricsQuery</span><span class=p>:</span><span class=w> </span><span class=l>sum(&lt;&lt;.Series&gt;&gt;{&lt;&lt;.LabelMatchers&gt;&gt;}) by (name)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>seriesQuery</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;{__name__=&#34;queue_depth&#34;,topic!=&#34;&#34;}&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>metricsQuery</span><span class=p>:</span><span class=w> </span><span class=l>sum(&lt;&lt;.Series&gt;&gt;{&lt;&lt;.LabelMatchers&gt;&gt;}) by (name)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Kubernetes metric queries include a namespace in the query by default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># but you can explicitly disable namespaces if needed with &#34;namespaced: false&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># this is useful if you have an HPA with an external metric in namespace A</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># but want to query for metrics from namespace B</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>namespaced</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># TODO: should we be able to map to a constant instance of a resource</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># (e.g. `resources: {constant: [{resource: &#34;namespace&#34;, name: &#34;kube-system&#34;}}]`)?</span></span></span></code></pre></td></tr></table></div></div></div></div><h4 id=discovery>Discovery<a hidden class=anchor aria-hidden=true href=#discovery>#</a></h4><p>Discovery 部分控制了查找要在自定义指标 API 中公开的指标的过程。其中有两个关键字段：<code>seriesQuery</code> 和 <code>seriesFilters</code>。</p><p><strong>seriesQuery</strong> 指定了用于查找某些 Prometheus series 的 Prometheus series 查询(作为传递给 Prometheus <code>/api/v1/series</code>)。适配器将从这些系列中剥离标签值，然后在后续步骤中使用得到的“指标名称—标签名称”的组合。</p><p>在许多情况下，seriesQuery 就足以缩小 Prometheus series 的列表。但有时(特别是当两个规则可能重叠时)，对指标名称进行额外的过滤是很有用的。在这种情况下,可以使用 seriesFilters。在从 seriesQuery 返回 series 列表后，每个 series 的指标名称都会通过指定的任何过滤器进行过滤。</p><p>过滤器可以是以下两种形式之一:</p><ul><li>is: <regex>，匹配名称符合指定正则表达式的任何序列。</li><li>isNot: <regex>，匹配名称不符合指定正则表达式的任何序列。</li></ul><p>例如</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>yaml</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># match all cAdvisor metrics that aren&#39;t measured in seconds</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>seriesQuery</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;{__name__=~&#34;^container_.*_total&#34;,container!=&#34;POD&#34;,namespace!=&#34;&#34;,pod!=&#34;&#34;}&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>seriesFilters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>isNot</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;^container_.*_seconds_total&#34;</span></span></span></code></pre></td></tr></table></div></div></div></div><h4 id=association>Association<a hidden class=anchor aria-hidden=true href=#association>#</a></h4><p>Association 部分控制了确定序列指标可以附加到哪些 Kubernetes 资源的过程。resources 字段控制了这个过程。</p><p>有两种方式来关联资源与特定指标。在这两种情况下,标签的值都会成为特定对象的名称。</p><p>一种方式是指定，任何符合某个特定模式的标签名称都指向基于标签名称的某个“group_resource”。这可以使用 template 字段来完成。pattern 被指定为一个 Go 模板，其中 Group 和 Resource 字段分别代表“组”和“资源”。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>yaml</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># any label `kube_&lt;group&gt;_&lt;resource&gt;` becomes &lt;group&gt;.&lt;resource&gt; in Kubernetes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;kube_&lt;&lt;.Group&gt;&gt;_&lt;&lt;.Resource&gt;&gt;&#34;</span></span></span></code></pre></td></tr></table></div></div></div></div><p>另一种方式是指定某个特定标签代表某个特定的 Kubernetes 资源。这可以使用 overrides 字段来完成。每个 override 将一个 Prometheus 标签映射到一个 Kubernetes group-resource。例如:</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>yaml</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># the microservice label corresponds to the apps.deployment resource</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>overrides</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>microservice</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>group</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;apps&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>resource</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;deployment&#34;</span></span></span></code></pre></td></tr></table></div></div></div></div><p>Association 部分提供了两种关联 Prometheus 指标和 Kubernetes 资源的方式，可以根据需要灵活地组合使用。这是实现自定义指标 API 的关键一环。</p><h4 id=naming>Naming<a hidden class=anchor aria-hidden=true href=#naming>#</a></h4><p>Naming 部分控制了将 Prometheus 指标名称转换为自定义指标 API 中的指标，这是通过 name 字段来实现的。</p><p>Naming 的控制通过指定一个从 Prometheus 名称中提取 API 名称的模式，以及对提取值进行的可选转换来实现。</p><p>模式由 <code>matches</code> 字段指定，这是一个正则表达式。如果没有指定,它默认为 .* 。</p><p>转换由 <code>as</code> 字段指定。你可以使用 <code>matches</code> 字段中定义的任何捕获组。如果 <code>matches</code> 字段没有捕获组，as 字段默认为 <code>$0</code> 。如果只包含一个捕获组，as 字段默认为 <code>$1</code> 。否则，如果没有指定 as 字段就会出错。例如</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>yaml</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># match turn any name &lt;name&gt;_total to &lt;name&gt;_per_second</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># e.g. http_requests_total becomes http_requests_per_second</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>name</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>matches</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;^(.*)_total$&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>as</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;${1}_per_second&#34;</span></span></span></code></pre></td></tr></table></div></div></div></div><h4 id=querying>Querying<a hidden class=anchor aria-hidden=true href=#querying>#</a></h4><p>Querying 部分控制了实际获取特定指标值的过程。它由 <code>metricsQuery</code> 字段来控制。</p><p>metricsQuery 字段是一个 Go 模板,它会被转换成一个 Prometheus 查询，使用从特定的自定义指标 API 调用获取的输入数据。对自定义指标 API 的一次调用会被简化为一个指标名称、一个 “group-resource” 和一个或多个该 “group-resource” 的对象。这些会被转换成模板中的以下字段:</p><ul><li>Series: 指标名称</li><li>LabelMatchers: 一个逗号分隔的标签匹配器列表，匹配给定的对象。当前包括特定的 “group-resource” 标签，以及 namespace 标。</li><li>GroupBy: 一个逗号分隔的用于分组的标签列表。当前包括用于 LabelMatchers 的组-资源标签。</li></ul><p>例如，假设我们有一个 <code>http_requests_total</code> 序列 (在 API 中公开为 http_requests_per_second )，具有 service、pod、ingress、namespace 和 verb 标签。前四个对应于 Kubernetes 资源。那么,如果有人请求了 <code>pods/http_request_per_second</code> 指标，那么针对 somens 命名空间中的 pod1 和 pod2，我们会有:</p><ul><li>Series: &ldquo;http_requests_total&rdquo;</li><li>LabelMatchers: <code>"pod=~"pod1|pod2",namespace="somens""</code></li><li>GroupBy: pod</li></ul><p>对应 prometheus promql 如下所示</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sum<span class=o>(</span>http_requests_total<span class=o>{</span><span class=nv>pod</span><span class=o>=</span>~<span class=s2>&#34;pod1|pod2&#34;</span>,namespace<span class=o>=</span><span class=s2>&#34;somens&#34;</span><span class=o>})</span> by <span class=o>(</span>pod<span class=o>)</span></span></span></code></pre></td></tr></table></div></div></div></div><p>此外,还有两个高级字段是其他字段的"原始"形式:</p><ul><li>LabelValuesByName: 映射。将 LabelMatchers 字段中的标签和值对应起来。值是用 <code>|</code> 预先连接的 (用于在 Prometheus 中使用 =~ 匹配器)。</li><li>GroupBySlice: GroupBy 字段的切片形式。</li></ul><p>通常，我们可能会想使用 Series、LabelMatchers 和 GroupBy 字段。其他两个是用于高级用法的。</p><p>Querying 预计会为每个请求的对象返回一个值。适配器会使用返回的系列上的标签，将给定的系列关联回其相应的对象。例如:</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># convert cumulative cAdvisor metrics into rates calculated over 2 minutes</span>
</span></span><span class=line><span class=cl>metricsQuery: <span class=s2>&#34;sum(rate(&lt;&lt;.Series&gt;&gt;{&lt;&lt;.LabelMatchers&gt;&gt;,container!=&#34;</span>POD<span class=s2>&#34;}[2m])) by (&lt;&lt;.GroupBy&gt;&gt;)&#34;</span></span></span></code></pre></td></tr></table></div></div></div></div><h3 id=完整的配置文件实例>完整的配置文件实例<a hidden class=anchor aria-hidden=true href=#完整的配置文件实例>#</a></h3><p>例如，我们想使用 springboot 的 actuator 提供的 <code>jvm_memory_used_bytes</code> 和 <code>jvm_memory_max_bytes</code> 计算内存使用率，如下所式</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>yaml</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>seriesQuery</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;jvm_memory_used_bytes&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>overrides</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>namespace</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>resource</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;namespace&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>pod</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>resource</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;pod&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matches</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;jvm_memory_used_bytes&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>as</span><span class=p>:</span><span class=w> </span><span class=l>memory_percent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>metricsQuery</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;sum(jvm_memory_used_bytes{&lt;&lt;.LabelMatchers&gt;&gt;}) by (&lt;&lt;.GroupBy&gt;&gt;) / sum(jvm_memory_max_bytes{&lt;&lt;.LabelMatchers&gt;&gt;}) by (&lt;&lt;.GroupBy&gt;&gt;) * 100&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>seriesQuery</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;process_cpu_usage&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>overrides</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>namespace</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>resource</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;namespace&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>pod</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>resource</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;pod&#34;</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matches</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;process_cpu_usage&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>as</span><span class=p>:</span><span class=w> </span><span class=l>process_cpu_percent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>metricsQuery</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;sum(avg_over_time(process_cpu_usage{&lt;&lt;.LabelMatchers&gt;&gt;}[1m])) by (&lt;&lt;.GroupBy&gt;&gt;)&#39;</span></span></span></code></pre></td></tr></table></div></div></div></div><p>这里用到了一个技巧，就是使用查询多个指标，这里参考了 prometheus-adapter 的说明 <sup><a href=#4>4</a></sup></p><blockquote><p>这很好理解,虽然一开始可能看起来不太明显。</p><p>基本上，你只需要选择一个指标作为 &ldquo;Discovery&rdquo; 和 &ldquo;naming&rdquo; 指标，然后使用它来配置配置中的 &ldquo;discovery&rdquo; 和 &ldquo;naming&rdquo; 部分。之后，你就可以在 metricsQuery 中写任何你想要的指标了！ ==<strong>Querying 的序列可以包含任何你想要的指标，只要它们有正确的标签集合即可</strong>==。</p></blockquote><p>例如，假设你有两个指标 foo_total 和 foo_count，它们都有一个标签 <code>system_name</code>，用于表示节点资源，那么如下配置所示</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>yaml</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>seriesQuery</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;foo_total&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span>{<span class=nt>overrides</span><span class=p>:</span><span class=w> </span>{<span class=nt>system_name</span><span class=p>:</span><span class=w> </span>{<span class=nt>resource</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;node&#34;</span>}}}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matches</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;foo_total&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>as</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;foo&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>metricsQuery</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;sum(foo_total{&lt;&lt;.LabelMatchers&gt;&gt;}) by (&lt;&lt;.GroupBy&gt;&gt;) / sum(foo_count{&lt;&lt;.LabelMatchers&gt;&gt;}) by (&lt;&lt;.GroupBy&gt;&gt;)&#39;</span></span></span></code></pre></td></tr></table></div></div></div></div><p>由于我们使用了 <code>jvm_memory_used_bytes</code> 和 <code>jvm_memory_max_bytes</code> ，那么我们可以在 &ldquo;discovery&rdquo; 和 &ldquo;naming&rdquo; 部分写任意指标，在 ”quering“ 中使用真是的指标进行替换，就可以完成</p><h4 id=查询-kubernetes-的指标>查询 kubernetes 的指标<a hidden class=anchor aria-hidden=true href=#查询-kubernetes-的指标>#</a></h4><p>完成配置后，可以使用下面命令进行查询</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get --raw <span class=s2>&#34;/apis/custom.metrics.k8s.io/v1beta1&#34;</span><span class=p>|</span>jq
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;kind&#34;</span>: <span class=s2>&#34;APIResourceList&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;apiVersion&#34;</span>: <span class=s2>&#34;v1&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;groupVersion&#34;</span>: <span class=s2>&#34;custom.metrics.k8s.io/v1beta1&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;resources&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>    <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;name&#34;</span>: <span class=s2>&#34;pods/process_cpu_percent&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;singularName&#34;</span>: <span class=s2>&#34;&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;namespaced&#34;</span>: true,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;kind&#34;</span>: <span class=s2>&#34;MetricValueList&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;verbs&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;get&#34;</span>
</span></span><span class=line><span class=cl>      <span class=o>]</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>,
</span></span><span class=line><span class=cl>    <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;name&#34;</span>: <span class=s2>&#34;pods/memory_percent&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;singularName&#34;</span>: <span class=s2>&#34;&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;namespaced&#34;</span>: true,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;kind&#34;</span>: <span class=s2>&#34;MetricValueList&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;verbs&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;get&#34;</span>
</span></span><span class=line><span class=cl>      <span class=o>]</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>,
</span></span><span class=line><span class=cl>    <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;name&#34;</span>: <span class=s2>&#34;namespaces/memory_percent&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;singularName&#34;</span>: <span class=s2>&#34;&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;namespaced&#34;</span>: false,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;kind&#34;</span>: <span class=s2>&#34;MetricValueList&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;verbs&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;get&#34;</span>
</span></span><span class=line><span class=cl>      <span class=o>]</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>,
</span></span><span class=line><span class=cl>    <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;name&#34;</span>: <span class=s2>&#34;namespaces/process_cpu_percent&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;singularName&#34;</span>: <span class=s2>&#34;&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;namespaced&#34;</span>: false,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;kind&#34;</span>: <span class=s2>&#34;MetricValueList&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;verbs&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;get&#34;</span>
</span></span><span class=line><span class=cl>      <span class=o>]</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>可以通过 custom API 进程查询具体获取的值，如下所示</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl get --raw <span class=s2>&#34;/apis/custom.metrics.k8s.io/v1beta1/namespaces/public/pods/*/process_cpu_percent&#34;</span><span class=p>|</span>jq
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;kind&#34;</span>: <span class=s2>&#34;MetricValueList&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;apiVersion&#34;</span>: <span class=s2>&#34;custom.metrics.k8s.io/v1beta1&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;metadata&#34;</span>: <span class=o>{}</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;items&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>    <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;describedObject&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;kind&#34;</span>: <span class=s2>&#34;Pod&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;namespace&#34;</span>: <span class=s2>&#34;msg&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;name&#34;</span>: <span class=s2>&#34;message-gateway-api-78c4d5cdbf-9k2g7&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;apiVersion&#34;</span>: <span class=s2>&#34;/v1&#34;</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;metricName&#34;</span>: <span class=s2>&#34;process_cpu_percent&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;timestamp&#34;</span>: <span class=s2>&#34;2024-05-31T11:40:25Z&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;value&#34;</span>: <span class=s2>&#34;404m&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;selector&#34;</span>: null
</span></span><span class=line><span class=cl>    <span class=o>}</span>,
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;describedObject&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;kind&#34;</span>: <span class=s2>&#34;Pod&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;namespace&#34;</span>: <span class=s2>&#34;msg&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;name&#34;</span>: <span class=s2>&#34;message-core-79fdc6fdd-lkpdm&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;apiVersion&#34;</span>: <span class=s2>&#34;/v1&#34;</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;metricName&#34;</span>: <span class=s2>&#34;process_cpu_percent&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;timestamp&#34;</span>: <span class=s2>&#34;2024-05-31T11:40:25Z&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;value&#34;</span>: <span class=s2>&#34;31m&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;selector&#34;</span>: null
</span></span><span class=line><span class=cl>    <span class=o>}</span>,
</span></span><span class=line><span class=cl>    <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;describedObject&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;kind&#34;</span>: <span class=s2>&#34;Pod&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;namespace&#34;</span>: <span class=s2>&#34;msg&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;name&#34;</span>: <span class=s2>&#34;message-push-admin-554f5d96fd-xlnhj&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;apiVersion&#34;</span>: <span class=s2>&#34;/v1&#34;</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;metricName&#34;</span>: <span class=s2>&#34;process_cpu_percent&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;timestamp&#34;</span>: <span class=s2>&#34;2024-05-31T11:40:25Z&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;value&#34;</span>: <span class=s2>&#34;487m&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;selector&#34;</span>: null
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>我们可以看到，返回值是带有 ”m“ 的单位，这里 issue 是这样回答的</p><blockquote><p>The <code>m</code>-suffix means milli, Quantity Values are explained here: <a href=https://github.com/kubernetes-sigs/prometheus-adapter/blob/master/docs/walkthrough.md#quantity-values target=_blank rel="noopener nofollow noreferrer">https://github.com/kubernetes-sigs/prometheus-adapter/blob/master/docs/walkthrough.md#quantity-values</a> <sup><a href=#5>5</a></sup></p></blockquote><p>在指标 API 中最常见的是 m 后缀,它表示毫单位，即单位的千分之一；由于我们返回值是一个百分比，例如 4.87%，那么实际值是 0.0487，那么他的毫单位为就是 “487m” ，和上面返回值一样。</p><h3 id=prometheus-adapter的安装>Prometheus-adapter的安装<a hidden class=anchor aria-hidden=true href=#prometheus-adapter的安装>#</a></h3><p>在这里采用 helm 方式进行安装，只需要修改对应参数即可</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>helm install prometheus-adapter -n monitoring  prometheus-community/prometheus-adapter <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	--set prometheus.url<span class=o>=</span>http://prometheus.default.svc <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	--set <span class=nv>logLevel</span><span class=o>=</span><span class=m>2</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	--set rules.external<span class=o>=</span>xxx <span class=c1># 如果使用外部规则替换默认的config.yaml,则需要提前创建一个configmap，然后这里指定这个名称</span></span></span></code></pre></td></tr></table></div></div></div></div><h2 id=reference>Reference<a hidden class=anchor aria-hidden=true href=#reference>#</a></h2><p><sup id=1>[1]</sup> <a href=https://github.com/kubernetes/design-proposals-archive/blob/main/instrumentation/monitoring_architecture.md target=_blank rel="noopener nofollow noreferrer">Kubernetes monitoring architecture</a></p><p><sup id=2>[2]</sup> <a href=https://github.com/kubernetes/design-proposals-archive/blob/main/instrumentation/core-metrics-pipeline.md target=_blank rel="noopener nofollow noreferrer">core-metrics-pipeline</a></p><p><sup id=3>[3]</sup> <a href=https://github.com/kubernetes/metrics target=_blank rel="noopener nofollow noreferrer">kubernetes/metrics</a></p><p><sup id=4>[4]</sup> <a href="https://github.com/kubernetes-sigs/prometheus-adapter/tree/v0.12.0?tab=readme-ov-file#my-query-contains-multiple-metrics-how-do-i-make-that-work" target=_blank rel="noopener nofollow noreferrer">my-query-contains-multiple-metrics-how-do-i-make-that-work</a></p><p><sup id=5>[5]</sup> <a href=https://github.com/kubernetes-sigs/prometheus-adapter/issues/376 target=_blank rel="noopener nofollow noreferrer">why i request rest-api, returned requeslt for item value has &rsquo;m&rsquo; unit!! #376</a></p><p><sup id=6>[6]</sup> <a href=https://medium.com/@congliu.thu/complete-guide-to-kubernetes-metrics-24a8782c34cd target=_blank rel="noopener nofollow noreferrer">Guide to Kubernetes Metrics</a></p><p><sup id=7>[7]</sup> <a href=https://www.geekgame.site/post/k8s/monitoring_arch/ target=_blank rel="noopener nofollow noreferrer">Kubernetes 监控架构(译)</a></p></div><div class=pe-copyright><hr><blockquote><p>本文为原创内容，版权归作者所有。如需转载，请在文章中声明本文标题及链接。</p><p>文章标题：深入解析Kubernetes监控体系与prometheus-adapter</p><p>文章链接：<a href=https://www.oomkill.com/2024/05/prometheus-adapter-intro/ target=_blank>https://www.oomkill.com/2024/05/prometheus-adapter-intro/</a></p><p>许可协议：<a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></p></blockquote></div><div class=comments-separator></div><h3 class=relatedContentTitle>相关阅读</h3><ul class=relatedContent><li><a href=/2020/11/prometheus-operator/><span>prometheus operator使用</span></a></li><li><a href=/2019/06/prometheus-golang_client/><span>prometheus golang_client开发Exporter</span></a></li><li><a href=/2019/04/prometheus-install/><span>prometheus传统架构安装</span></a></li><li><a href=/2023/07/blackbox_exporter-in-k8s/><span>在 Kubernetes 集群中使用 blackbox exporter监控外部IP</span></a></li><li><a href=/2023/07/using-thanos-improve-prometheus.md/><span>使用Thanos强化Prometheus</span></a></li></ul><div class=comments-separator></div><footer class=post-footer><ul class=post-tags><li><a href=https://www.oomkill.com/tags/monitor/>Monitor</a></li><li><a href=https://www.oomkill.com/tags/kubernetes/>Kubernetes</a></li></ul><nav class=paginav><a class=prev href=https://www.oomkill.com/2024/06/docker-push-gcr/><span class=title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left" style="user-select:text"><line x1="19" y1="12" x2="5" y2="12" style="user-select:text"/><polyline points="12 19 5 12 12 5" style="user-select:text"/></polyline></svg>&nbsp;</span>
<span>使用docker管理谷歌物件仓库gcr上的镜像</span>
</a><a class=next href=https://www.oomkill.com/2024/05/stackstorm-sensors/><span class=title></span>
<span>StackStorm自动化 - 工作流模型&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right" style="user-select:text"><line x1="5" y1="12" x2="19" y2="12" style="user-select:text"/><polyline points="12 5 19 12 12 19" style="user-select:text"/></svg></span></a></nav></footer><div class=pe-comments-decoration><p class=pe-comments-title></p><p class=pe-comments-subtitle></p></div><div id=pe-comments></div><script src=/js/pe-go-comment.min.86a214102576ba5f9b7bdc29eed8d58dd56e34aef80b3c65c73ea9cc88443696.js integrity="sha256-hqIUECV2ul+be9wp7tjVjdVuNK74Czxlxz6pzIhENpY="></script><script>const getStoredTheme=()=>localStorage.getItem("pref-theme")==="dark"?"dark":"light",setGiscusTheme=()=>{const e=e=>{const t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:e},"https://giscus.app")};e({setConfig:{theme:getStoredTheme()}})};document.addEventListener("DOMContentLoaded",()=>{const s={src:"https://giscus.app/client.js","data-repo":"cylonchau/cylonchau.github.io","data-repo-id":"R_kgDOIRlNSQ","data-category":"Announcements","data-category-id":"DIC_kwDOIRlNSc4CXy1U","data-mapping":"pathname","data-term":"posts/prometheus-adapter-intro","data-strict":"0","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"top","data-theme":getStoredTheme(),"data-lang":"zh-TW","data-loading":"lazy",crossorigin:"anonymous",async:""},e=document.createElement("script");Object.entries(s).forEach(([t,n])=>e.setAttribute(t,n)),document.querySelector("#pe-comments").appendChild(e);const t=document.querySelector("#theme-toggle");t&&t.addEventListener("click",setGiscusTheme);const n=document.querySelector("#theme-toggle-float");n&&n.addEventListener("click",setGiscusTheme)})</script></article></main><footer class=footer><span>&copy; 2024 <a href=https://www.oomkill.com/>Cylon's Collection</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> on
<a href=https://pages.github.com/ rel=noopener target=_blank>GitHub Pages</a> & Theme
        <a href=https://github.com/tofuwine/PaperMod-PE rel=noopener target=_blank>PaperMod-PE</a></span></footer><div class=pe-right-sidebar><a href=javascript:void(0); id=theme-toggle-float class=pe-float-btn><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</a><a href=#top class=pe-float-btn id=top-link><span id=pe-read-progress></span></a></div><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>