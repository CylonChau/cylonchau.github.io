<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>grafana loki的理解与配置(2.9) | Cylon's Collection</title><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NP3JNCPR" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><meta name=keywords content="log,elk,loki,grafana"><meta name=description content="loki的部署模式 grafana loki 在 helm 中版本变化很大，理解部署模式有助于快速 run 一组 loki 服务；loki 服务是一个单体二进制文件运行的微服务架构模式，具体运行的角色通过 -target 参数来区分运行什么组件。
单体模式 单体模式又称整体模式，源自官网 (Monolithic mode)，这个模式指的是 -target=all 时运行的服务。需要注意的是单体模式下，每天读写量为 20GB.
Monolithic mode is useful for getting started quickly to experiment with Loki, as well as for small read/write volumes of up to approximately 20GB per day. [1]
该模式下loki 所有的组件都为二进制文件或者容器作为单一进程运行。
SSD SSD (Simple Scalable deployment mode) 简单可扩展部署模式，是 loki 对内部组件进行分类，当参数 target 我i -target=write , -target=read, -target=backend 时，是作为 SSD mode 启动。其中 write 和 backend 是有状态服务，read 是无状态服务。"><meta name=author content="cylon"><link rel=canonical href=https://www.oomkill.com/2024/12/grafana-loki-2-9/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://www.oomkill.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.oomkill.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.oomkill.com/favicon-32x32.png><link rel=apple-touch-icon href=https://www.oomkill.com/favicon.ico><link rel=mask-icon href=https://www.oomkill.com/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://www.oomkill.com/2024/12/grafana-loki-2-9/><noscript><style>#theme-toggle,#top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link crossorigin=anonymous href=/assets/css/pe.min.css rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/pe.min.js></script><link rel=stylesheet href=https://cdn.staticfile.net/font-awesome/6.5.1/css/all.min.css><link rel=stylesheet href=https://cdn.staticfile.net/font-awesome/6.5.1/css/v4-shims.min.css><script id=MathJax-script async src=https://cdn.staticfile.net/mathjax/3.2.2/es5/tex-chtml.js></script><script>MathJax={tex:{displayMath:[["$$","$$"]],inlineMath:[["\\$","\\$"]]}}</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-H94HZ5S19Y"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-H94HZ5S19Y")</script><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><meta name=referrer content="no-referrer-when-downgrade"><meta property="og:title" content="grafana loki的理解与配置(2.9)"><meta property="og:description" content="loki的部署模式 grafana loki 在 helm 中版本变化很大，理解部署模式有助于快速 run 一组 loki 服务；loki 服务是一个单体二进制文件运行的微服务架构模式，具体运行的角色通过 -target 参数来区分运行什么组件。
单体模式 单体模式又称整体模式，源自官网 (Monolithic mode)，这个模式指的是 -target=all 时运行的服务。需要注意的是单体模式下，每天读写量为 20GB.
Monolithic mode is useful for getting started quickly to experiment with Loki, as well as for small read/write volumes of up to approximately 20GB per day. [1]
该模式下loki 所有的组件都为二进制文件或者容器作为单一进程运行。
SSD SSD (Simple Scalable deployment mode) 简单可扩展部署模式，是 loki 对内部组件进行分类，当参数 target 我i -target=write , -target=read, -target=backend 时，是作为 SSD mode 启动。其中 write 和 backend 是有状态服务，read 是无状态服务。"><meta property="og:type" content="article"><meta property="og:url" content="https://www.oomkill.com/2024/12/grafana-loki-2-9/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-12-25T00:00:00+00:00"><meta property="article:modified_time" content="2024-12-25T23:00:36+08:00"><meta property="og:site_name" content="Cylon's Collection"><meta name=twitter:card content="summary"><meta name=twitter:title content="grafana loki的理解与配置(2.9)"><meta name=twitter:description content="loki的部署模式 grafana loki 在 helm 中版本变化很大，理解部署模式有助于快速 run 一组 loki 服务；loki 服务是一个单体二进制文件运行的微服务架构模式，具体运行的角色通过 -target 参数来区分运行什么组件。
单体模式 单体模式又称整体模式，源自官网 (Monolithic mode)，这个模式指的是 -target=all 时运行的服务。需要注意的是单体模式下，每天读写量为 20GB.
Monolithic mode is useful for getting started quickly to experiment with Loki, as well as for small read/write volumes of up to approximately 20GB per day. [1]
该模式下loki 所有的组件都为二进制文件或者容器作为单一进程运行。
SSD SSD (Simple Scalable deployment mode) 简单可扩展部署模式，是 loki 对内部组件进行分类，当参数 target 我i -target=write , -target=read, -target=backend 时，是作为 SSD mode 启动。其中 write 和 backend 是有状态服务，read 是无状态服务。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://www.oomkill.com/posts/"},{"@type":"ListItem","position":2,"name":"grafana loki的理解与配置(2.9)","item":"https://www.oomkill.com/2024/12/grafana-loki-2-9/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"grafana loki的理解与配置(2.9)","name":"grafana loki的理解与配置(2.9)","description":"loki的部署模式 grafana loki 在 helm 中版本变化很大，理解部署模式有助于快速 run 一组 loki 服务；loki 服务是一个单体二进制文件运行的微服务架构模式，具体运行的角色通过 -target 参数来区分运行什么组件。\n单体模式 单体模式又称整体模式，源自官网 (Monolithic mode)，这个模式指的是 -target=all 时运行的服务。需要注意的是单体模式下，每天读写量为 20GB.\nMonolithic mode is useful for getting started quickly to experiment with Loki, as well as for small read/write volumes of up to approximately 20GB per day. [1]\n该模式下loki 所有的组件都为二进制文件或者容器作为单一进程运行。\nSSD SSD (Simple Scalable deployment mode) 简单可扩展部署模式，是 loki 对内部组件进行分类，当参数 target 我i -target=write , -target=read, -target=backend 时，是作为 SSD mode 启动。其中 write 和 backend 是有状态服务，read 是无状态服务。","keywords":["log","elk","loki","grafana"],"articleBody":"loki的部署模式 grafana loki 在 helm 中版本变化很大，理解部署模式有助于快速 run 一组 loki 服务；loki 服务是一个单体二进制文件运行的微服务架构模式，具体运行的角色通过 -target 参数来区分运行什么组件。\n单体模式 单体模式又称整体模式，源自官网 (Monolithic mode)，这个模式指的是 -target=all 时运行的服务。需要注意的是单体模式下，每天读写量为 20GB.\nMonolithic mode is useful for getting started quickly to experiment with Loki, as well as for small read/write volumes of up to approximately 20GB per day. [1]\n该模式下loki 所有的组件都为二进制文件或者容器作为单一进程运行。\nSSD SSD (Simple Scalable deployment mode) 简单可扩展部署模式，是 loki 对内部组件进行分类，当参数 target 我i -target=write , -target=read, -target=backend 时，是作为 SSD mode 启动。其中 write 和 backend 是有状态服务，read 是无状态服务。\n微服务模式 微服务模式 (Microservices mode) 指的是，参数 target 制定了对应的组件名字，即每个组件作为独立的微服务运行。可以通过 -list-targets 参数来获取 loki 所有组件。\nbash 1 2 docker run docker.io/grafana/loki:2.9.2 \\ -config.file=/etc/loki/local-config.yaml -list-targets 微服务模式官方推荐在大规模 loki 集群时使用。\nMicroservices mode is only recommended for very large Loki clusters or for operators who need more precise control over scaling and cluster operations. [2]\nLoki的存储 Loki存储日志的方式是将日志的元数据信息作为类似 Prometheus 的 key/value 对的格式进行索引，而日志内容不索引进行存储，大致一条信息的组成为：\ntext 1 2 3 4 5 6 2024-12-25T10:01:02.123456789Z {key1=\"value\", key2=\"value2\"} GET /ping |______________________________| |_____________________________| |____________| 时间戳 Prometheus-style label 日志内容 nano second precision Key/Value Paris logline |______________________________________________________________| |____________| Indexed Unindented 在 Loki 2.0 之前版本，loki存储将索引数据和未索引数据分别存储，索引数据包含了相对应的标签，常见为 {app=\"api\", env=\"production\", filename=\"/var/logs/app.log\"} 这种起了唯一的标识；对象存储则负责存储和压缩日志。索引提供负责快速查询的标签。\n在 Loki 2.0 后的版本提供了 Single Store，这里存储了包含“索引数据”和“非索引数据”，即只提供了一个存储。\nnote 这里均提到了“对象存储”的概念，这里对象存储和传统理解上的 S3 是有区别的。Loki 中提到的对象存储是 块存储 Chunk storage，包含了 “文件系统” 和 “对象存储”，这里的 “对象存储” 才是传统意义上的 S3 [3] Helm 安装 Loki 2.9 添加 loki 仓库\nbash 1 helm repo add grafana https://grafana.github.io/helm-charts helm的版本差异 loki helm 有很多不同的模式，官方也提供了诸如 SSD 的 helm，这里采用 loki helm 进行安装。在安装时需要区分版本，loki helm 2.x (最高对应 loki 2.6.1 版本)，这里 helm 运行为单一进程的。在 loki helm 3 以上，编默认作为 SSD 模式运行，如果还想运行为“单体模式” 需要自行修改。\n下面时 loki helm 2.16.0 的 helm values.yaml\nyaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 299 300 301 302 303 304 305 306 307 308 309 310 311 312 313 314 315 316 317 318 319 320 321 322 323 324 325 326 327 328 329 330 331 332 333 334 335 336 337 338 339 340 341 342 343 344 image: repository: grafana/loki tag: 2.6.1 pullPolicy: IfNotPresent ## Optionally specify an array of imagePullSecrets. ## Secrets must be manually created in the namespace. ## ref: https://kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry/ ## # pullSecrets: # - myRegistryKeySecretName ingress: enabled: false # For Kubernetes \u003e= 1.18 you should specify the ingress-controller via the field ingressClassName # See https://kubernetes.io/blog/2020/04/02/improvements-to-the-ingress-api-in-kubernetes-1.18/#specifying-the-class-of-an-ingress # ingressClassName: nginx annotations: {} # kubernetes.io/ingress.class: nginx # kubernetes.io/tls-acme: \"true\" hosts: - host: chart-example.local paths: [] tls: [] # - secretName: chart-example-tls # hosts: # - chart-example.local ## Affinity for pod assignment ## ref: https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#affinity-and-anti-affinity affinity: {} # podAntiAffinity: # requiredDuringSchedulingIgnoredDuringExecution: # - labelSelector: # matchExpressions: # - key: app # operator: In # values: # - loki # topologyKey: \"kubernetes.io/hostname\" ## StatefulSet annotations annotations: {} # enable tracing for debug, need install jaeger and specify right jaeger_agent_host tracing: jaegerAgentHost: config: # existingSecret: auth_enabled: false memberlist: join_members: # the value must be defined as string to be evaluated when secret manifest is being generating - '{{ include \"loki.fullname\" . }}-memberlist' ingester: chunk_idle_period: 3m chunk_block_size: 262144 chunk_retain_period: 1m max_transfer_retries: 0 wal: dir: /data/loki/wal lifecycler: ring: replication_factor: 1 ## Different ring configs can be used. E.g. Consul # ring: # store: consul # replication_factor: 1 # consul: # host: \"consul:8500\" # prefix: \"\" # http_client_timeout: \"20s\" # consistent_reads: true limits_config: enforce_metric_name: false reject_old_samples: true reject_old_samples_max_age: 168h max_entries_limit_per_query: 5000 schema_config: configs: - from: 2020-10-24 store: boltdb-shipper object_store: filesystem schema: v11 index: prefix: index_ period: 24h server: http_listen_port: 3100 grpc_listen_port: 9095 storage_config: boltdb_shipper: active_index_directory: /data/loki/boltdb-shipper-active cache_location: /data/loki/boltdb-shipper-cache cache_ttl: 24h # Can be increased for faster performance over longer query periods, uses more disk space shared_store: filesystem filesystem: directory: /data/loki/chunks chunk_store_config: max_look_back_period: 0s table_manager: retention_deletes_enabled: false retention_period: 0s compactor: working_directory: /data/loki/boltdb-shipper-compactor shared_store: filesystem # Needed for Alerting: https://grafana.com/docs/loki/latest/rules/ # This is just a simple example, for more details: https://grafana.com/docs/loki/latest/configuration/#ruler_config # ruler: # storage: # type: local # local: # directory: /rules # rule_path: /tmp/scratch # alertmanager_url: http://alertmanager.svc.namespace:9093 # ring: # kvstore: # store: inmemory # enable_api: true ## Additional Loki container arguments, e.g. log level (debug, info, warn, error) extraArgs: {} # log.level: debug extraEnvFrom: [] livenessProbe: httpGet: path: /ready port: http-metrics initialDelaySeconds: 45 ## ref: https://kubernetes.io/docs/concepts/services-networking/network-policies/ networkPolicy: enabled: false ## The app name of loki clients client: {} # name: ## ref: https://kubernetes.io/docs/concepts/configuration/assign-pod-node/ nodeSelector: {} ## ref: https://kubernetes.io/docs/concepts/storage/persistent-volumes/ ## If you set enabled as \"True\", you need : ## - create a pv which above 10Gi and has same namespace with loki ## - keep storageClassName same with below setting persistence: enabled: false accessModes: - ReadWriteOnce size: 10Gi labels: {} annotations: {} # selector: # matchLabels: # app.kubernetes.io/name: loki # subPath: \"\" # existingClaim: # storageClassName: ## Pod Labels podLabels: {} ## Pod Annotations podAnnotations: prometheus.io/scrape: \"true\" prometheus.io/port: \"http-metrics\" podManagementPolicy: OrderedReady ## Assign a PriorityClassName to pods if set # priorityClassName: rbac: create: true pspEnabled: true readinessProbe: httpGet: path: /ready port: http-metrics initialDelaySeconds: 45 replicas: 1 resources: {} # limits: # cpu: 200m # memory: 256Mi # requests: # cpu: 100m # memory: 128Mi securityContext: fsGroup: 10001 runAsGroup: 10001 runAsNonRoot: true runAsUser: 10001 containerSecurityContext: readOnlyRootFilesystem: true service: type: ClusterIP nodePort: port: 3100 annotations: {} labels: {} targetPort: http-metrics serviceAccount: create: true name: annotations: {} automountServiceAccountToken: true terminationGracePeriodSeconds: 4800 ## Tolerations for pod assignment ## ref: https://kubernetes.io/docs/concepts/configuration/taint-and-toleration/ tolerations: [] ## Topology spread constraint for multi-zone clusters ## ref: https://kubernetes.io/docs/concepts/workloads/pods/pod-topology-spread-constraints/ topologySpreadConstraints: enabled: false # The values to set in the PodDisruptionBudget spec # If not set then a PodDisruptionBudget will not be created podDisruptionBudget: {} # minAvailable: 1 # maxUnavailable: 1 updateStrategy: type: RollingUpdate serviceMonitor: enabled: false interval: \"\" additionalLabels: {} annotations: {} # scrapeTimeout: 10s # path: /metrics scheme: null tlsConfig: {} prometheusRule: enabled: false additionalLabels: {} # namespace: rules: [] # Some examples from https://awesome-prometheus-alerts.grep.to/rules.html#loki # - alert: LokiProcessTooManyRestarts # expr: changes(process_start_time_seconds{job=~\"loki\"}[15m]) \u003e 2 # for: 0m # labels: # severity: warning # annotations: # summary: Loki process too many restarts (instance {{ $labels.instance }}) # description: \"A loki process had too many restarts (target {{ $labels.instance }})\\n VALUE = {{ $value }}\\n LABELS = {{ $labels }}\" # - alert: LokiRequestErrors # expr: 100 * sum(rate(loki_request_duration_seconds_count{status_code=~\"5..\"}[1m])) by (namespace, job, route) / sum(rate(loki_request_duration_seconds_count[1m])) by (namespace, job, route) \u003e 10 # for: 15m # labels: # severity: critical # annotations: # summary: Loki request errors (instance {{ $labels.instance }}) # description: \"The {{ $labels.job }} and {{ $labels.route }} are experiencing errors\\n VALUE = {{ $value }}\\n LABELS = {{ $labels }}\" # - alert: LokiRequestPanic # expr: sum(increase(loki_panic_total[10m])) by (namespace, job) \u003e 0 # for: 5m # labels: # severity: critical # annotations: # summary: Loki request panic (instance {{ $labels.instance }}) # description: \"The {{ $labels.job }} is experiencing {{ printf \\\"%.2f\\\" $value }}% increase of panics\\n VALUE = {{ $value }}\\n LABELS = {{ $labels }}\" # - alert: LokiRequestLatency # expr: (histogram_quantile(0.99, sum(rate(loki_request_duration_seconds_bucket{route!~\"(?i).*tail.*\"}[5m])) by (le))) \u003e 1 # for: 5m # labels: # severity: critical # annotations: # summary: Loki request latency (instance {{ $labels.instance }}) # description: \"The {{ $labels.job }} {{ $labels.route }} is experiencing {{ printf \\\"%.2f\\\" $value }}s 99th percentile latency\\n VALUE = {{ $value }}\\n LABELS = {{ $labels }}\" initContainers: [] ## Init containers to be added to the loki pod. # - name: my-init-container # image: busybox:latest # command: ['sh', '-c', 'echo hello'] extraContainers: [] ## Additional containers to be added to the loki pod. # - name: reverse-proxy # image: angelbarrera92/basic-auth-reverse-proxy:dev # args: # - \"serve\" # - \"--upstream=http://localhost:3100\" # - \"--auth-config=/etc/reverse-proxy-conf/authn.yaml\" # ports: # - name: http # containerPort: 11811 # protocol: TCP # volumeMounts: # - name: reverse-proxy-auth-config # mountPath: /etc/reverse-proxy-conf extraVolumes: [] ## Additional volumes to the loki pod. # - name: reverse-proxy-auth-config # secret: # secretName: reverse-proxy-auth-config ## Extra volume mounts that will be added to the loki container extraVolumeMounts: [] extraPorts: [] ## Additional ports to the loki services. Useful to expose extra container ports. # - port: 11811 # protocol: TCP # name: http # targetPort: http # Extra env variables to pass to the loki container env: [] # Specify Loki Alerting rules based on this documentation: https://grafana.com/docs/loki/latest/rules/ # When specified, you also need to add a ruler config section above. An example is shown in the rules docs. alerting_groups: [] # - name: example # rules: # - alert: HighThroughputLogStreams # expr: sum by(container) (rate({job=~\"loki-dev/.*\"}[1m])) \u003e 1000 # for: 2m useExistingAlertingGroup: enabled: false configmapName: \"\" 单体模式进行部署 修改 values.yaml, 搜索 singleBinary，修改为 true\ntext 1 2 3 4 5 6 singleBinary: # -- Number of replicas for the single binary replicas: 0 autoscaling: # -- Enable autoscaling enabled: false 注意修改存储模式，在使用到单体的状态下，通常都是进行最小化部署，所以使用 “文件系统” 模式，这里修改文件系统模式\nyaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 # -- Storage config. Providing this will automatically populate all necessary storage configs in the templated config. storage: bucketNames: chunks: chunks ruler: ruler admin: admin # type 这里修改为 filesystem type: filesystem # s3可以是 minio, ceph rgw等 s3: s3: null endpoint: null region: null secretAccessKey: null accessKeyId: null signatureVersion: null s3ForcePathStyle: false insecure: false http_config: {} gcs: chunkBufferSize: 0 requestTimeout: \"0s\" enableHttp2: true azure: accountName: null accountKey: null useManagedIdentity: false useFederatedToken: false userAssignedId: null requestTimeout: null endpointSuffix: null filesystem: chunks_directory: /var/loki/chunks rules_directory: /var/loki/rules 需要注意的是，使用了 filesystem，对应的你的 k8s 集群需要提供 storageClass，以供应用自动获取 pvc\nyaml 1 2 3 4 5 6 7 8 9 10 11 12 13 persistence: # -- Enable StatefulSetAutoDeletePVC feature enableStatefulSetAutoDeletePVC: false # -- Size of persistent disk size: 10Gi # -- Storage class to be used. # If defined, storageClassName: . # If set to \"-\", storageClassName: \"\", which disables dynamic provisioning. # If empty or set to null, no storageClassName spec is # set, choosing the default provisioner (gp2 on AWS, standard on GKE, AWS, and OpenStack). storageClass: null # -- Selector for persistent disk selector: null 部署 Loki\nbash 1 2 3 4 5 6 7 ## 部署 Loki helm upgrade --install loki \\ --namespace logging \\ --create-namespace \\ -f values.yaml \\ --version {loki version} \\ grafana/loki SSD模式部署 默认模式下，就是 SSD 模式，\nyaml 1 2 3 4 5 commonConfig: path_prefix: /var/loki # 系数决定了，后面的 read, write, backend 是最少需要多少个实例 replication_factor: 3 compactor_address: '{{ include \"loki.compactorAddress\" . }}' 而 Ingress 中会根据用户启用了什么模式而分配不同的路由，在文件 grafana/loki/blob/v2.9.2/production/helm/loki/templates/ingress.yaml 中定义\nyaml 1 2 3 4 5 6 7 rules: {{- range $.Values.ingress.hosts }} - host: {{ . | quote }} http: paths: {{- include \"loki.ingress.servicePaths\" $ | indent 10}} {{- end }} 在文件 grafana/loki/blob/v2.9.2/production/helm/loki/templates/_helpers.tpl 可以看到\nyaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 {{/* Generate list of ingress service paths based on deployment type */}} {{- define \"loki.ingress.servicePaths\" -}} {{- if (eq (include \"loki.deployment.isScalable\" .) \"true\") -}} {{- include \"loki.ingress.scalableServicePaths\" . }} {{- else -}} {{- include \"loki.ingress.singleBinaryServicePaths\" . }} {{- end -}} {{- end -}} {{/* Ingress service paths for scalable deployment */}} {{- define \"loki.ingress.scalableServicePaths\" -}} {{- include \"loki.ingress.servicePath\" (dict \"ctx\" . \"svcName\" \"read\" \"paths\" .Values.ingress.paths.read )}} {{- include \"loki.ingress.servicePath\" (dict \"ctx\" . \"svcName\" \"write\" \"paths\" .Values.ingress.paths.write )}} {{- end -}} # 上面传入了 key/value的值，例如 svcName=write, path=.Values.ingress.paths.write # 下面会根据路由选择对应的service # https://github.com/grafana/loki/blob/v2.9.2/production/helm/loki/templates/_helpers.tpl#L471C1-L486C12 {{- range .paths }} - path: {{ . }} {{- if $ingressSupportsPathType }} pathType: Prefix {{- end }} backend: {{- if $ingressApiIsStable }} {{- $serviceName := include \"loki.ingress.serviceName\" (dict \"ctx\" $.ctx \"svcName\" $.svcName) }} service: name: {{ $serviceName }} port: number: 3100 {{- else }} serviceName: {{ $serviceName }} servicePort: 3100 {{- end -}} # isScalable就是 singleBinary 为0，或者使用了对象存储 {{- define \"loki.deployment.isScalable\" -}} {{- and (eq (include \"loki.isUsingObjectStorage\" . ) \"true\") (eq (int .Values.singleBinary.replicas) 0) }} {{- end -}} {{/* Determine if deployment is using object storage */}} {{- define \"loki.isUsingObjectStorage\" -}} {{- or (eq .Values.loki.storage.type \"gcs\") (eq .Values.loki.storage.type \"s3\") (eq .Values.loki.storage.type \"azure\") -}} {{- end -}} 最后就是 values.yaml 中定义的路由，根据不同的服务，吧请求路由转发到对应的服务上。\nyaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 paths: write: - /api/prom/push - /loki/api/v1/push read: - /api/prom/tail - /loki/api/v1/tail - /loki/api - /api/prom/rules - /loki/api/v1/rules - /prometheus/api/v1/rules - /prometheus/api/v1/alerts singleBinary: - /api/prom/push - /loki/api/v1/push - /api/prom/tail - /loki/api/v1/tail - /loki/api - /api/prom/rules - /loki/api/v1/rules - /prometheus/api/v1/rules - /prometheus/api/v1/alerts 后面就配置你要启用的服务即可，read, write, backend, gateway, loki有维护一个表格，包含了该模式下的组件有哪些，backend可以看到是不属于 read, write 模式。\nComponent individual all read write backend Distributor x x x Ingester x x x Query Frontend x x x Query Scheduler x x x Querier x x x Index Gateway x x Compactor x x x Ruler x x x Bloom Planner (Experimental) x x Bloom Builder (Experimental) x x Bloom Gateway (Experimental) x x 表：loki部署模式中包含的组件 Source：https://grafana.com/docs/loki/latest/get-started/components/\n官方也有提供一些简单的部署模式在文件夹 production/helm/loki/ci\n至此 loki 使用 helm 部署的两种模式就完成了部署，再配合 data ingestion, 例如 Promtail, Filebeat 等就可以完成日志的收集。\nReference [1] Loki deployment modes\n[2] Microservices mode\n[3] Chunk storage\n[4] Loki components\n","wordCount":"2376","inLanguage":"zh","datePublished":"2024-12-25T00:00:00Z","dateModified":"2024-12-25T23:00:36+08:00","author":{"@type":"Person","name":"cylon"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.oomkill.com/2024/12/grafana-loki-2-9/"},"publisher":{"@type":"Organization","name":"Cylon's Collection","logo":{"@type":"ImageObject","url":"https://www.oomkill.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.oomkill.com/><img src=https://www.oomkill.com/favicon.ico alt aria-label=logo height=20>Cylon's Collection</a><div class=logo-switches><button id=theme-toggle><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://www.oomkill.com/archives><span>归档</span></a></li><li><a href=https://www.oomkill.com/tags><span>标签</span></a></li><li><a href=https://www.oomkill.com/search><span>搜索</span></a></li><li><a href=https://www.oomkill.com/about accesskey=/><span>关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">grafana loki的理解与配置(2.9)</h1><div class=post-meta><span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar" style="user-select:text"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" style="user-select:text"/><line x1="16" y1="2" x2="16" y2="6" style="user-select:text"/><line x1="8" y1="2" x2="8" y2="6" style="user-select:text"/><line x1="3" y1="10" x2="21" y2="10" style="user-select:text"/></svg><span>2024-12-25</span></span>&nbsp;·&nbsp;<span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text" style="user-select:text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z" style="user-select:text"/><polyline points="14 2 14 8 20 8" style="user-select:text"/><line x1="16" y1="13" x2="8" y2="13" style="user-select:text"/><line x1="16" y1="17" x2="8" y2="17" style="user-select:text"/><polyline points="10 9 9 9 8 9" style="user-select:text"/></svg><span>2376 字</span></span>&nbsp;·&nbsp;<span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><span>12 分钟</span></span>
<span class=pe-post-meta-item>&nbsp;·&nbsp;<svg t="1714036239378" fill="currentcolor" class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="6659" width="256" height="256"><path d="M690 78.2c-18.6-18.8-49-19-67.8-.4s-19 49-.4 67.8l255.4 258.6c67.8 68.6 67.8 178.8.0 247.4L653.4 878.2c-18.6 18.8-18.4 49.2.4 67.8s49.2 18.4 67.8-.4l224-226.4c104.8-106 104.8-276.4.0-382.4L690 78.2zM485.4 101.4c-24-24-56.6-37.4-90.6-37.4H96C43 64 0 107 0 160v299c0 34 13.4 66.6 37.4 90.6l336 336c50 50 131 50 181 0l267-267c50-50 50-131 0-181l-336-336zM96 160h299c8.4.0 16.6 3.4 22.6 9.4l336 336c12.4 12.4 12.4 32.8.0 45.2l-267 267c-12.4 12.4-32.8 12.4-45.2.0l-336-336c-6-6-9.4-14.2-9.4-22.6V160zm192 128a64 64 0 10-128 0 64 64 0 10128 0z" p-id="6660"/></svg></span><ul class=pe-post-meta-item><a href=https://www.oomkill.com/tags/log/>#Log</a></ul></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details><summary><span class=details>目录</span></summary><div class=inner><ul><li><a href=#loki%e7%9a%84%e9%83%a8%e7%bd%b2%e6%a8%a1%e5%bc%8f aria-label=loki的部署模式>loki的部署模式</a><ul><li><a href=#%e5%8d%95%e4%bd%93%e6%a8%a1%e5%bc%8f aria-label=单体模式>单体模式</a><li><a href=#ssd aria-label=SSD>SSD</a><li><a href=#%e5%be%ae%e6%9c%8d%e5%8a%a1%e6%a8%a1%e5%bc%8f aria-label=微服务模式>微服务模式</a></ul><li><a href=#loki%e7%9a%84%e5%ad%98%e5%82%a8 aria-label=Loki的存储>Loki的存储</a><li><a href=#helm-%e5%ae%89%e8%a3%85-loki-29 aria-label="Helm 安装 Loki 2.9">Helm 安装 Loki 2.9</a><ul><li><a href=#helm%e7%9a%84%e7%89%88%e6%9c%ac%e5%b7%ae%e5%bc%82 aria-label=helm的版本差异>helm的版本差异</a><li><a href=#%e5%8d%95%e4%bd%93%e6%a8%a1%e5%bc%8f%e8%bf%9b%e8%a1%8c%e9%83%a8%e7%bd%b2 aria-label=单体模式进行部署>单体模式进行部署</a><li><a href=#ssd%e6%a8%a1%e5%bc%8f%e9%83%a8%e7%bd%b2 aria-label=SSD模式部署>SSD模式部署</a></ul><li><a href=#reference aria-label=Reference>Reference</a></li></div></details></div></aside><script src=/js/pe-toc.min.445eb1bfc5e85dd13b9519fcc2a806522e9629b6224a2974052789ba00ab78af.js integrity="sha256-RF6xv8XoXdE7lRn8wqgGUi6WKbYiSil0BSeJugCreK8="></script><div class=post-content><h2 id=loki的部署模式>loki的部署模式<a hidden class=anchor aria-hidden=true href=#loki的部署模式>#</a></h2><p>grafana loki 在 helm 中版本变化很大，理解部署模式有助于快速 run 一组 loki 服务；loki 服务是一个单体二进制文件运行的微服务架构模式，具体运行的角色通过 <code>-target</code> 参数来区分运行什么组件。</p><h3 id=单体模式>单体模式<a hidden class=anchor aria-hidden=true href=#单体模式>#</a></h3><p>单体模式又称整体模式，源自官网 (Monolithic mode)，这个模式指的是 <code>-target=all</code> 时运行的服务。需要注意的是单体模式下，每天读写量为 20GB.</p><blockquote><p>Monolithic mode is useful for getting started quickly to experiment with Loki, as well as for small read/write volumes of up to approximately 20GB per day. <sup><a href=#1>[1]</a></sup></p></blockquote><p>该模式下loki 所有的组件都为二进制文件或者容器作为单一进程运行。</p><h3 id=ssd>SSD<a hidden class=anchor aria-hidden=true href=#ssd>#</a></h3><p>SSD (Simple Scalable deployment mode) <em>简单可扩展部署模式</em>，是 loki 对内部组件进行分类，当参数 target 我i <code>-target=write</code> , <code>-target=read</code>, <code>-target=backend</code> 时，是作为 SSD mode 启动。其中 <strong>write</strong> 和 <strong>backend</strong> 是有状态服务，<strong>read</strong> 是无状态服务。</p><h3 id=微服务模式>微服务模式<a hidden class=anchor aria-hidden=true href=#微服务模式>#</a></h3><p>微服务模式 (Microservices mode) 指的是，参数 target 制定了对应的组件名字，即每个组件作为独立的微服务运行。可以通过 -list-targets 参数来获取 loki 所有组件。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker run docker.io/grafana/loki:2.9.2 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	-config.file<span class=o>=</span>/etc/loki/local-config.yaml -list-targets</span></span></code></pre></td></tr></table></div></div></div></div><p>微服务模式官方推荐在大规模 loki 集群时使用。</p><blockquote><p>Microservices mode is only recommended for very large Loki clusters or for operators who need more precise control over scaling and cluster operations. <sup><a href=#2>[2]</a></sup></p></blockquote><h2 id=loki的存储>Loki的存储<a hidden class=anchor aria-hidden=true href=#loki的存储>#</a></h2><p>Loki存储日志的方式是将日志的元数据信息作为类似 Prometheus 的 key/value 对的格式进行索引，而日志内容不索引进行存储，大致一条信息的组成为：</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>text</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl> 2024-12-25T10:01:02.123456789Z   {key1=&#34;value&#34;, key2=&#34;value2&#34;}    GET /ping
</span></span><span class=line><span class=cl>|______________________________| |_____________________________| |____________|
</span></span><span class=line><span class=cl>  时间戳                            Prometheus-style label           日志内容
</span></span><span class=line><span class=cl>  nano second precision            Key/Value Paris                  logline
</span></span><span class=line><span class=cl>|______________________________________________________________| |____________|
</span></span><span class=line><span class=cl>                             Indexed                               Unindented</span></span></code></pre></td></tr></table></div></div></div></div><p>在 Loki 2.0 之前版本，loki存储将索引数据和未索引数据分别存储，索引数据包含了相对应的标签，常见为 <code>{app="api", env="production", filename="/var/logs/app.log"}</code> 这种起了唯一的标识；对象存储则负责存储和压缩日志。索引提供负责快速查询的标签。</p><p>在 Loki 2.0 后的版本提供了 Single Store，这里存储了包含“索引数据”和“非索引数据”，即只提供了一个存储。</p><div class="pe-details admonition note open"><div class="pe-details-summary admonition-title"><i class="icon fas fa-pencil-alt fa-fw" aria-hidden=true></i>note<i class="pe-details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=pe-details-content><div class=admonition-content>这里均提到了“对象存储”的概念，这里对象存储和传统理解上的 S3 是有区别的。Loki 中提到的对象存储是 块存储 <em><strong>Chunk storage</strong></em>，包含了 “文件系统” 和 “对象存储”，这里的 “对象存储” 才是传统意义上的 S3 <sup><a href=#3>[3]</a></sup></div></div></div><h2 id=helm-安装-loki-29>Helm 安装 Loki 2.9<a hidden class=anchor aria-hidden=true href=#helm-安装-loki-29>#</a></h2><p>添加 loki 仓库</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>helm repo add grafana https://grafana.github.io/helm-charts</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=helm的版本差异>helm的版本差异<a hidden class=anchor aria-hidden=true href=#helm的版本差异>#</a></h3><p>loki helm 有很多不同的模式，官方也提供了诸如 SSD 的 helm，这里采用 loki helm 进行安装。在安装时需要区分版本，loki helm 2.x (最高对应 loki 2.6.1 版本)，这里 helm 运行为单一进程的。在 loki helm 3 以上，编默认作为 SSD 模式运行，如果还想运行为“单体模式” 需要自行修改。</p><p>下面时 loki helm 2.16.0 的 helm <a href=https://github.com/grafana/helm-charts/blob/loki-2.16.0/charts/loki/values.yaml target=_blank rel="noopener nofollow noreferrer">values.yaml</a></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>yaml</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span><span class=lnt>231
</span><span class=lnt>232
</span><span class=lnt>233
</span><span class=lnt>234
</span><span class=lnt>235
</span><span class=lnt>236
</span><span class=lnt>237
</span><span class=lnt>238
</span><span class=lnt>239
</span><span class=lnt>240
</span><span class=lnt>241
</span><span class=lnt>242
</span><span class=lnt>243
</span><span class=lnt>244
</span><span class=lnt>245
</span><span class=lnt>246
</span><span class=lnt>247
</span><span class=lnt>248
</span><span class=lnt>249
</span><span class=lnt>250
</span><span class=lnt>251
</span><span class=lnt>252
</span><span class=lnt>253
</span><span class=lnt>254
</span><span class=lnt>255
</span><span class=lnt>256
</span><span class=lnt>257
</span><span class=lnt>258
</span><span class=lnt>259
</span><span class=lnt>260
</span><span class=lnt>261
</span><span class=lnt>262
</span><span class=lnt>263
</span><span class=lnt>264
</span><span class=lnt>265
</span><span class=lnt>266
</span><span class=lnt>267
</span><span class=lnt>268
</span><span class=lnt>269
</span><span class=lnt>270
</span><span class=lnt>271
</span><span class=lnt>272
</span><span class=lnt>273
</span><span class=lnt>274
</span><span class=lnt>275
</span><span class=lnt>276
</span><span class=lnt>277
</span><span class=lnt>278
</span><span class=lnt>279
</span><span class=lnt>280
</span><span class=lnt>281
</span><span class=lnt>282
</span><span class=lnt>283
</span><span class=lnt>284
</span><span class=lnt>285
</span><span class=lnt>286
</span><span class=lnt>287
</span><span class=lnt>288
</span><span class=lnt>289
</span><span class=lnt>290
</span><span class=lnt>291
</span><span class=lnt>292
</span><span class=lnt>293
</span><span class=lnt>294
</span><span class=lnt>295
</span><span class=lnt>296
</span><span class=lnt>297
</span><span class=lnt>298
</span><span class=lnt>299
</span><span class=lnt>300
</span><span class=lnt>301
</span><span class=lnt>302
</span><span class=lnt>303
</span><span class=lnt>304
</span><span class=lnt>305
</span><span class=lnt>306
</span><span class=lnt>307
</span><span class=lnt>308
</span><span class=lnt>309
</span><span class=lnt>310
</span><span class=lnt>311
</span><span class=lnt>312
</span><span class=lnt>313
</span><span class=lnt>314
</span><span class=lnt>315
</span><span class=lnt>316
</span><span class=lnt>317
</span><span class=lnt>318
</span><span class=lnt>319
</span><span class=lnt>320
</span><span class=lnt>321
</span><span class=lnt>322
</span><span class=lnt>323
</span><span class=lnt>324
</span><span class=lnt>325
</span><span class=lnt>326
</span><span class=lnt>327
</span><span class=lnt>328
</span><span class=lnt>329
</span><span class=lnt>330
</span><span class=lnt>331
</span><span class=lnt>332
</span><span class=lnt>333
</span><span class=lnt>334
</span><span class=lnt>335
</span><span class=lnt>336
</span><span class=lnt>337
</span><span class=lnt>338
</span><span class=lnt>339
</span><span class=lnt>340
</span><span class=lnt>341
</span><span class=lnt>342
</span><span class=lnt>343
</span><span class=lnt>344
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>image</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>repository</span><span class=p>:</span><span class=w> </span><span class=l>grafana/loki</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tag</span><span class=p>:</span><span class=w> </span><span class=m>2.6.1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>pullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>## Optionally specify an array of imagePullSecrets.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>## Secrets must be manually created in the namespace.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>## ref: https://kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>##</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># pullSecrets:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#   - myRegistryKeySecretName</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>ingress</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># For Kubernetes &gt;= 1.18 you should specify the ingress-controller via the field ingressClassName</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># See https://kubernetes.io/blog/2020/04/02/improvements-to-the-ingress-api-in-kubernetes-1.18/#specifying-the-class-of-an-ingress</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># ingressClassName: nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># kubernetes.io/ingress.class: nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># kubernetes.io/tls-acme: &#34;true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hosts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>chart-example.local</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>paths</span><span class=p>:</span><span class=w> </span><span class=p>[]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tls</span><span class=p>:</span><span class=w> </span><span class=p>[]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#  - secretName: chart-example-tls</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#    hosts:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#      - chart-example.local</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>## Affinity for pod assignment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>## ref: https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#affinity-and-anti-affinity</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>affinity</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># podAntiAffinity:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   requiredDuringSchedulingIgnoredDuringExecution:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   - labelSelector:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#       matchExpressions:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#       - key: app</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#         operator: In</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#         values:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#         - loki</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#     topologyKey: &#34;kubernetes.io/hostname&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>## StatefulSet annotations</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>annotations</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># enable tracing for debug, need install jaeger and specify right jaeger_agent_host</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>tracing</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>jaegerAgentHost</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># existingSecret:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>auth_enabled</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>memberlist</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>join_members</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># the value must be defined as string to be evaluated when secret manifest is being generating</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;{{ include &#34;loki.fullname&#34; . }}-memberlist&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ingester</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>chunk_idle_period</span><span class=p>:</span><span class=w> </span><span class=l>3m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>chunk_block_size</span><span class=p>:</span><span class=w> </span><span class=m>262144</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>chunk_retain_period</span><span class=p>:</span><span class=w> </span><span class=l>1m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>max_transfer_retries</span><span class=p>:</span><span class=w> </span><span class=m>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>wal</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>dir</span><span class=p>:</span><span class=w> </span><span class=l>/data/loki/wal</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>lifecycler</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>ring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>replication_factor</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>## Different ring configs can be used. E.g. Consul</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># ring:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#   store: consul</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#   replication_factor: 1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#   consul:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#     host: &#34;consul:8500&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#     prefix: &#34;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#     http_client_timeout: &#34;20s&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#     consistent_reads: true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>limits_config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>enforce_metric_name</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>reject_old_samples</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>reject_old_samples_max_age</span><span class=p>:</span><span class=w> </span><span class=l>168h</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>max_entries_limit_per_query</span><span class=p>:</span><span class=w> </span><span class=m>5000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>schema_config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>from</span><span class=p>:</span><span class=w> </span><span class=ld>2020-10-24</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>store</span><span class=p>:</span><span class=w> </span><span class=l>boltdb-shipper</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>object_store</span><span class=p>:</span><span class=w> </span><span class=l>filesystem</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>schema</span><span class=p>:</span><span class=w> </span><span class=l>v11</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>index</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>prefix</span><span class=p>:</span><span class=w> </span><span class=l>index_</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>period</span><span class=p>:</span><span class=w> </span><span class=l>24h</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>server</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>http_listen_port</span><span class=p>:</span><span class=w> </span><span class=m>3100</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>grpc_listen_port</span><span class=p>:</span><span class=w> </span><span class=m>9095</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>storage_config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>boltdb_shipper</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>active_index_directory</span><span class=p>:</span><span class=w> </span><span class=l>/data/loki/boltdb-shipper-active</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>cache_location</span><span class=p>:</span><span class=w> </span><span class=l>/data/loki/boltdb-shipper-cache</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>cache_ttl</span><span class=p>:</span><span class=w> </span><span class=l>24h        </span><span class=w> </span><span class=c># Can be increased for faster performance over longer query periods, uses more disk space</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>shared_store</span><span class=p>:</span><span class=w> </span><span class=l>filesystem</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>filesystem</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>directory</span><span class=p>:</span><span class=w> </span><span class=l>/data/loki/chunks</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>chunk_store_config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>max_look_back_period</span><span class=p>:</span><span class=w> </span><span class=l>0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>table_manager</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>retention_deletes_enabled</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>retention_period</span><span class=p>:</span><span class=w> </span><span class=l>0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>compactor</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>working_directory</span><span class=p>:</span><span class=w> </span><span class=l>/data/loki/boltdb-shipper-compactor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>shared_store</span><span class=p>:</span><span class=w> </span><span class=l>filesystem</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Needed for Alerting: https://grafana.com/docs/loki/latest/rules/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># This is just a simple example, for more details: https://grafana.com/docs/loki/latest/configuration/#ruler_config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#  ruler:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#    storage:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#      type: local</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#      local:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#        directory: /rules</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#    rule_path: /tmp/scratch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#    alertmanager_url: http://alertmanager.svc.namespace:9093</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#    ring:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#      kvstore:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#        store: inmemory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#    enable_api: true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>## Additional Loki container arguments, e.g. log level (debug, info, warn, error)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>extraArgs</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># log.level: debug</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>extraEnvFrom</span><span class=p>:</span><span class=w> </span><span class=p>[]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>livenessProbe</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>httpGet</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/ready</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=l>http-metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class=m>45</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>## ref: https://kubernetes.io/docs/concepts/services-networking/network-policies/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>networkPolicy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>## The app name of loki clients</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>client</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># name:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>## ref: https://kubernetes.io/docs/concepts/configuration/assign-pod-node/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>nodeSelector</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>## ref: https://kubernetes.io/docs/concepts/storage/persistent-volumes/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>## If you set enabled as &#34;True&#34;, you need :</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>## - create a pv which above 10Gi and has same namespace with loki</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>## - keep storageClassName same with below setting</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>persistence</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>accessModes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>ReadWriteOnce</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>size</span><span class=p>:</span><span class=w> </span><span class=l>10Gi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># selector:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#   matchLabels:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#     app.kubernetes.io/name: loki</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># subPath: &#34;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># existingClaim:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># storageClassName:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>## Pod Labels</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>podLabels</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>## Pod Annotations</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>podAnnotations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>prometheus.io/scrape</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>prometheus.io/port</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;http-metrics&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>podManagementPolicy</span><span class=p>:</span><span class=w> </span><span class=l>OrderedReady</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>## Assign a PriorityClassName to pods if set</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># priorityClassName:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>rbac</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>create</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>pspEnabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>readinessProbe</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>httpGet</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/ready</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=l>http-metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class=m>45</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>resources</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># limits:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   cpu: 200m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   memory: 256Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># requests:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   cpu: 100m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   memory: 128Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>securityContext</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>fsGroup</span><span class=p>:</span><span class=w> </span><span class=m>10001</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>runAsGroup</span><span class=p>:</span><span class=w> </span><span class=m>10001</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>runAsNonRoot</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>runAsUser</span><span class=p>:</span><span class=w> </span><span class=m>10001</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>containerSecurityContext</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>readOnlyRootFilesystem</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>ClusterIP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nodePort</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>3100</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=l>http-metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>serviceAccount</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>create</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>automountServiceAccountToken</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>terminationGracePeriodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>4800</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>## Tolerations for pod assignment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>## ref: https://kubernetes.io/docs/concepts/configuration/taint-and-toleration/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>tolerations</span><span class=p>:</span><span class=w> </span><span class=p>[]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>## Topology spread constraint for multi-zone clusters</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>## ref: https://kubernetes.io/docs/concepts/workloads/pods/pod-topology-spread-constraints/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>topologySpreadConstraints</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># The values to set in the PodDisruptionBudget spec</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># If not set then a PodDisruptionBudget will not be created</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>podDisruptionBudget</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># minAvailable: 1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># maxUnavailable: 1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>updateStrategy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>RollingUpdate</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>serviceMonitor</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>additionalLabels</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># scrapeTimeout: 10s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># path: /metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>scheme</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tlsConfig</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>prometheusRule</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>additionalLabels</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#  namespace:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>rules</span><span class=p>:</span><span class=w> </span><span class=p>[]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#  Some examples from https://awesome-prometheus-alerts.grep.to/rules.html#loki</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#  - alert: LokiProcessTooManyRestarts</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#    expr: changes(process_start_time_seconds{job=~&#34;loki&#34;}[15m]) &gt; 2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#    for: 0m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#    labels:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#      severity: warning</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#    annotations:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#      summary: Loki process too many restarts (instance {{ $labels.instance }})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#      description: &#34;A loki process had too many restarts (target {{ $labels.instance }})\n  VALUE = {{ $value }}\n  LABELS = {{ $labels }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#  - alert: LokiRequestErrors</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#    expr: 100 * sum(rate(loki_request_duration_seconds_count{status_code=~&#34;5..&#34;}[1m])) by (namespace, job, route) / sum(rate(loki_request_duration_seconds_count[1m])) by (namespace, job, route) &gt; 10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#    for: 15m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#    labels:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#      severity: critical</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#    annotations:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#      summary: Loki request errors (instance {{ $labels.instance }})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#      description: &#34;The {{ $labels.job }} and {{ $labels.route }} are experiencing errors\n  VALUE = {{ $value }}\n  LABELS = {{ $labels }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#  - alert: LokiRequestPanic</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#    expr: sum(increase(loki_panic_total[10m])) by (namespace, job) &gt; 0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#    for: 5m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#    labels:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#      severity: critical</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#    annotations:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#      summary: Loki request panic (instance {{ $labels.instance }})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#      description: &#34;The {{ $labels.job }} is experiencing {{ printf \&#34;%.2f\&#34; $value }}% increase of panics\n  VALUE = {{ $value }}\n  LABELS = {{ $labels }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#  - alert: LokiRequestLatency</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#    expr: (histogram_quantile(0.99, sum(rate(loki_request_duration_seconds_bucket{route!~&#34;(?i).*tail.*&#34;}[5m])) by (le)))  &gt; 1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#    for: 5m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#    labels:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#      severity: critical</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#    annotations:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#      summary: Loki request latency (instance {{ $labels.instance }})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#      description: &#34;The {{ $labels.job }} {{ $labels.route }} is experiencing {{ printf \&#34;%.2f\&#34; $value }}s 99th percentile latency\n  VALUE = {{ $value }}\n  LABELS = {{ $labels }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>initContainers</span><span class=p>:</span><span class=w> </span><span class=p>[]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>## Init containers to be added to the loki pod.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># - name: my-init-container</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   image: busybox:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   command: [&#39;sh&#39;, &#39;-c&#39;, &#39;echo hello&#39;]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>extraContainers</span><span class=p>:</span><span class=w> </span><span class=p>[]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>## Additional containers to be added to the loki pod.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># - name: reverse-proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   image: angelbarrera92/basic-auth-reverse-proxy:dev</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   args:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#     - &#34;serve&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#     - &#34;--upstream=http://localhost:3100&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#     - &#34;--auth-config=/etc/reverse-proxy-conf/authn.yaml&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   ports:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#     - name: http</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#       containerPort: 11811</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#       protocol: TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   volumeMounts:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#     - name: reverse-proxy-auth-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#       mountPath: /etc/reverse-proxy-conf</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>extraVolumes</span><span class=p>:</span><span class=w> </span><span class=p>[]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>## Additional volumes to the loki pod.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># - name: reverse-proxy-auth-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   secret:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#     secretName: reverse-proxy-auth-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>## Extra volume mounts that will be added to the loki container</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>extraVolumeMounts</span><span class=p>:</span><span class=w> </span><span class=p>[]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>extraPorts</span><span class=p>:</span><span class=w> </span><span class=p>[]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>## Additional ports to the loki services. Useful to expose extra container ports.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># - port: 11811</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   protocol: TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   name: http</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#   targetPort: http</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Extra env variables to pass to the loki container</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>env</span><span class=p>:</span><span class=w> </span><span class=p>[]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Specify Loki Alerting rules based on this documentation: https://grafana.com/docs/loki/latest/rules/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># When specified, you also need to add a ruler config section above. An example is shown in the rules docs.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>alerting_groups</span><span class=p>:</span><span class=w> </span><span class=p>[]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#  - name: example</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#    rules:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#    - alert: HighThroughputLogStreams</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#      expr: sum by(container) (rate({job=~&#34;loki-dev/.*&#34;}[1m])) &gt; 1000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#      for: 2m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>useExistingAlertingGroup</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>configmapName</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&#34;</span></span></span></code></pre></td></tr></table></div></div></div></div><h3 id=单体模式进行部署>单体模式进行部署<a hidden class=anchor aria-hidden=true href=#单体模式进行部署>#</a></h3><p>修改 values.yaml, 搜索 singleBinary，修改为 true</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>text</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>singleBinary:
</span></span><span class=line><span class=cl>  # -- Number of replicas for the single binary
</span></span><span class=line><span class=cl>  replicas: 0
</span></span><span class=line><span class=cl>  autoscaling:
</span></span><span class=line><span class=cl>    # -- Enable autoscaling
</span></span><span class=line><span class=cl>    enabled: false </span></span></code></pre></td></tr></table></div></div></div></div><p>注意修改存储模式，在使用到单体的状态下，通常都是进行最小化部署，所以使用 “文件系统” 模式，这里修改文件系统模式</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>yaml</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># -- Storage config. Providing this will automatically populate all necessary storage configs in the templated config.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>storage</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>bucketNames</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>chunks</span><span class=p>:</span><span class=w> </span><span class=l>chunks</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>ruler</span><span class=p>:</span><span class=w> </span><span class=l>ruler</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>admin</span><span class=p>:</span><span class=w> </span><span class=l>admin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># type 这里修改为 filesystem</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>filesystem</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># s3可以是 minio, ceph rgw等</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>s3</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>s3</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>region</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>secretAccessKey</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>accessKeyId</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>signatureVersion</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>s3ForcePathStyle</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>insecure</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>http_config</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>gcs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>chunkBufferSize</span><span class=p>:</span><span class=w> </span><span class=m>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>requestTimeout</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;0s&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>enableHttp2</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>azure</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>accountName</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>accountKey</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>useManagedIdentity</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>useFederatedToken</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>userAssignedId</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>requestTimeout</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>endpointSuffix</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>filesystem</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>chunks_directory</span><span class=p>:</span><span class=w> </span><span class=l>/var/loki/chunks</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>rules_directory</span><span class=p>:</span><span class=w> </span><span class=l>/var/loki/rules</span></span></span></code></pre></td></tr></table></div></div></div></div><blockquote><p>需要注意的是，使用了 filesystem，对应的你的 k8s 集群需要提供 storageClass，以供应用自动获取 pvc</p></blockquote><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>yaml</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>  </span><span class=nt>persistence</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># -- Enable StatefulSetAutoDeletePVC feature</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>enableStatefulSetAutoDeletePVC</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># -- Size of persistent disk</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>size</span><span class=p>:</span><span class=w> </span><span class=l>10Gi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># -- Storage class to be used.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># If defined, storageClassName: &lt;storageClass&gt;.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># If set to &#34;-&#34;, storageClassName: &#34;&#34;, which disables dynamic provisioning.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># If empty or set to null, no storageClassName spec is</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># set, choosing the default provisioner (gp2 on AWS, standard on GKE, AWS, and OpenStack).</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>storageClass</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># -- Selector for persistent disk</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>selector</span><span class=p>:</span><span class=w> </span><span class=kc>null</span></span></span></code></pre></td></tr></table></div></div></div></div><p>部署 Loki</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1>## 部署 Loki</span>
</span></span><span class=line><span class=cl>helm upgrade --install loki  <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --namespace logging <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --create-namespace <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -f values.yaml <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --version <span class=o>{</span>loki version<span class=o>}</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  grafana/loki</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=ssd模式部署>SSD模式部署<a hidden class=anchor aria-hidden=true href=#ssd模式部署>#</a></h3><p>默认模式下，就是 SSD 模式，</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>yaml</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>  </span><span class=nt>commonConfig</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path_prefix</span><span class=p>:</span><span class=w> </span><span class=l>/var/loki</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># 系数决定了，后面的 read, write, backend 是最少需要多少个实例</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>replication_factor</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>compactor_address</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;{{ include &#34;loki.compactorAddress&#34; . }}&#39;</span></span></span></code></pre></td></tr></table></div></div></div></div><p>而 Ingress 中会根据用户启用了什么模式而分配不同的路由，在文件 <a href=grafana/loki/blob/v2.9.2/production/helm/loki/templates/ingress.yaml>grafana/loki/blob/v2.9.2/production/helm/loki/templates/ingress.yaml</a> 中定义</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>yaml</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>  </span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>{{- <span class=l>range $.Values.ingress.hosts }}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>host</span><span class=p>:</span><span class=w> </span>{{<span class=w> </span><span class=l>. | quote }}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>http</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>paths</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>{{- <span class=l>include &#34;loki.ingress.servicePaths&#34; $ | indent 10}}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>{{- <span class=l>end }}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>在文件 <a href=grafana/loki/blob/v2.9.2/production/helm/loki/templates/_helpers.tpl>grafana/loki/blob/v2.9.2/production/helm/loki/templates/_helpers.tpl</a> 可以看到</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>yaml</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl>{{<span class=l>/*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>Generate list of ingress service paths based on deployment type</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>*/}}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>{{- <span class=l>define &#34;loki.ingress.servicePaths&#34; -}}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>{{- <span class=l>if (eq (include &#34;loki.deployment.isScalable&#34; .) &#34;true&#34;) -}}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>{{- <span class=l>include &#34;loki.ingress.scalableServicePaths&#34; . }}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>{{- <span class=l>else -}}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>{{- <span class=l>include &#34;loki.ingress.singleBinaryServicePaths&#34; . }}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>{{- <span class=l>end -}}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>{{- <span class=l>end -}}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>{{<span class=l>/*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>Ingress service paths for scalable deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>*/}}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>{{- <span class=l>define &#34;loki.ingress.scalableServicePaths&#34; -}}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>{{- <span class=l>include &#34;loki.ingress.servicePath&#34; (dict &#34;ctx&#34; . &#34;svcName&#34; &#34;read&#34; &#34;paths&#34; .Values.ingress.paths.read )}}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>{{- <span class=l>include &#34;loki.ingress.servicePath&#34; (dict &#34;ctx&#34; . &#34;svcName&#34; &#34;write&#34; &#34;paths&#34; .Values.ingress.paths.write )}}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>{{- <span class=l>end -}}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 上面传入了 key/value的值，例如 svcName=write, path=.Values.ingress.paths.write</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 下面会根据路由选择对应的service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># https://github.com/grafana/loki/blob/v2.9.2/production/helm/loki/templates/_helpers.tpl#L471C1-L486C12</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>{{- <span class=l>range .paths }}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>path</span><span class=p>:</span><span class=w> </span>{{<span class=w> </span><span class=l>. }}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>{{- <span class=l>if $ingressSupportsPathType }}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>pathType</span><span class=p>:</span><span class=w> </span><span class=l>Prefix</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>{{- <span class=l>end }}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>backend</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>{{- <span class=l>if $ingressApiIsStable }}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>{{- <span class=l>$serviceName := include &#34;loki.ingress.serviceName&#34; (dict &#34;ctx&#34; $.ctx &#34;svcName&#34; $.svcName) }}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span>{{<span class=w> </span><span class=l>$serviceName }}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>port</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>number</span><span class=p>:</span><span class=w> </span><span class=m>3100</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>{{- <span class=l>else }}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>serviceName</span><span class=p>:</span><span class=w> </span>{{<span class=w> </span><span class=l>$serviceName }}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>servicePort</span><span class=p>:</span><span class=w> </span><span class=m>3100</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>{{- <span class=l>end -}}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># isScalable就是 singleBinary 为0，或者使用了对象存储</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>{{- <span class=l>define &#34;loki.deployment.isScalable&#34; -}}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>{{- <span class=l>and (eq (include &#34;loki.isUsingObjectStorage&#34; . ) &#34;true&#34;) (eq (int .Values.singleBinary.replicas) 0) }}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>{{- <span class=l>end -}}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>{{<span class=l>/* Determine if deployment is using object storage */}}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>{{- <span class=l>define &#34;loki.isUsingObjectStorage&#34; -}}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>{{- <span class=l>or (eq .Values.loki.storage.type &#34;gcs&#34;) (eq .Values.loki.storage.type &#34;s3&#34;) (eq .Values.loki.storage.type &#34;azure&#34;) -}}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>{{- <span class=l>end -}}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>最后就是 <a href=https://github.com/grafana/loki/blob/v2.9.2/production/helm/loki/values.yaml#L1133C1-L1154C34 target=_blank rel="noopener nofollow noreferrer">values.yaml</a> 中定义的路由，根据不同的服务，吧请求路由转发到对应的服务上。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>yaml</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>  </span><span class=nt>paths</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>write</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/api/prom/push</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/loki/api/v1/push</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>read</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/api/prom/tail</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/loki/api/v1/tail</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/loki/api</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/api/prom/rules</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/loki/api/v1/rules</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/prometheus/api/v1/rules</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/prometheus/api/v1/alerts</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>singleBinary</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/api/prom/push</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/loki/api/v1/push</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/api/prom/tail</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/loki/api/v1/tail</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/loki/api</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/api/prom/rules</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/loki/api/v1/rules</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/prometheus/api/v1/rules</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/prometheus/api/v1/alerts</span></span></span></code></pre></td></tr></table></div></div></div></div><p>后面就配置你要启用的服务即可，read, write, backend, gateway, loki有维护一个表格，包含了该模式下的组件有哪些，backend可以看到是不属于 read, write 模式。</p><table><thead><tr><th>Component</th><th><em>individual</em></th><th>all</th><th>read</th><th>write</th><th>backend</th></tr></thead><tbody><tr><td><a href=https://grafana.com/docs/loki/latest/get-started/components/#distributor target=_blank rel="noopener nofollow noreferrer">Distributor</a></td><td>x</td><td>x</td><td></td><td>x</td><td></td></tr><tr><td><a href=https://grafana.com/docs/loki/latest/get-started/components/#ingester target=_blank rel="noopener nofollow noreferrer">Ingester</a></td><td>x</td><td>x</td><td></td><td>x</td><td></td></tr><tr><td><a href=https://grafana.com/docs/loki/latest/get-started/components/#query-frontend target=_blank rel="noopener nofollow noreferrer">Query Frontend</a></td><td>x</td><td>x</td><td>x</td><td></td><td></td></tr><tr><td><a href=https://grafana.com/docs/loki/latest/get-started/components/#query-scheduler target=_blank rel="noopener nofollow noreferrer">Query Scheduler</a></td><td>x</td><td>x</td><td></td><td></td><td>x</td></tr><tr><td><a href=https://grafana.com/docs/loki/latest/get-started/components/#querier target=_blank rel="noopener nofollow noreferrer">Querier</a></td><td>x</td><td>x</td><td>x</td><td></td><td></td></tr><tr><td><a href=https://grafana.com/docs/loki/latest/get-started/components/#index-gateway target=_blank rel="noopener nofollow noreferrer">Index Gateway</a></td><td>x</td><td></td><td></td><td></td><td>x</td></tr><tr><td><a href=https://grafana.com/docs/loki/latest/get-started/components/#compactor target=_blank rel="noopener nofollow noreferrer">Compactor</a></td><td>x</td><td>x</td><td></td><td></td><td>x</td></tr><tr><td><a href=https://grafana.com/docs/loki/latest/get-started/components/#ruler target=_blank rel="noopener nofollow noreferrer">Ruler</a></td><td>x</td><td>x</td><td></td><td></td><td>x</td></tr><tr><td><a href=https://grafana.com/docs/loki/latest/get-started/components/#bloom-planner target=_blank rel="noopener nofollow noreferrer">Bloom Planner (Experimental)</a></td><td>x</td><td></td><td></td><td></td><td>x</td></tr><tr><td><a href=https://grafana.com/docs/loki/latest/get-started/components/#bloom-builder target=_blank rel="noopener nofollow noreferrer">Bloom Builder (Experimental)</a></td><td>x</td><td></td><td></td><td></td><td>x</td></tr><tr><td><a href=https://grafana.com/docs/loki/latest/get-started/components/#bloom-gateway target=_blank rel="noopener nofollow noreferrer">Bloom Gateway (Experimental)</a></td><td>x</td><td></td><td></td><td></td><td>x</td></tr></tbody></table><center>表：loki部署模式中包含的组件</center><center><em>Source：</em>https://grafana.com/docs/loki/latest/get-started/components/</center><br><p>官方也有提供一些简单的部署模式在文件夹 <a href=https://github.com/grafana/loki/tree/v2.9.2/production/helm/loki/ci target=_blank rel="noopener nofollow noreferrer">production/helm/loki/ci</a></p><p>至此 loki 使用 helm 部署的两种模式就完成了部署，再配合 data ingestion, 例如 Promtail, Filebeat 等就可以完成日志的收集。</p><h2 id=reference>Reference<a hidden class=anchor aria-hidden=true href=#reference>#</a></h2><p><sup id=1>[1]</sup> <a href=https://grafana.com/docs/loki/latest/get-started/deployment-modes/ target=_blank rel="noopener nofollow noreferrer">Loki deployment modes</a></p><p><sup id=2>[2]</sup> <a href=https://grafana.com/docs/loki/latest/get-started/deployment-modes/#microservices-mode target=_blank rel="noopener nofollow noreferrer">Microservices mode</a></p><p><sup id=3>[3]</sup> <a href=https://grafana.com/docs/loki/latest/configure/storage/#chunk-storage target=_blank rel="noopener nofollow noreferrer">Chunk storage</a></p><p><sup id=4>[4]</sup> <a href=https://grafana.com/docs/loki/latest/get-started/components/ target=_blank rel="noopener nofollow noreferrer">Loki components</a></p></div><div class=pe-copyright><hr><blockquote><p>本文为原创内容，版权归作者所有。如需转载，请在文章中声明本文标题及链接。</p><p>文章标题：grafana loki的理解与配置(2.9)</p><p>文章链接：<a href=https://www.oomkill.com/2024/12/grafana-loki-2-9/ target=_blank>https://www.oomkill.com/2024/12/grafana-loki-2-9/</a></p><p>许可协议：<a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></p></blockquote></div><div class=comments-separator></div><h3 class=relatedContentTitle>相关阅读</h3><ul class=relatedContent><li><a href=/2023/12/grafana-keycloak/><span>使用keycloak作为grafana的OAuth2认证</span></a></li><li><a href=/2023/08/kubernetes-node-label-dashboard/><span>记录kubernetes node label的面板实施</span></a></li><li><a href=/2021/12/grafana-8.0/><span>grafana v8.0+ 隐藏表格字段</span></a></li><li><a href=/2017/05/ch04-mysql-log/><span>ch04 - MySQL数据库服务日志类型</span></a></li><li><a href=/2017/05/ch6-mysql-replication/><span>ch06 - MySQL主从复制</span></a></li></ul><div class=comments-separator></div><footer class=post-footer><ul class=post-tags><li><a href=https://www.oomkill.com/tags/log/>Log</a></li></ul><nav class=paginav><a class=prev href=https://www.oomkill.com/2025/01/filebeat/><span class=title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left" style="user-select:text"><line x1="19" y1="12" x2="5" y2="12" style="user-select:text"/><polyline points="12 19 5 12 12 5" style="user-select:text"/></polyline></svg>&nbsp;</span>
<span>filebeat helm chart多配置文件配置</span>
</a><a class=next href=https://www.oomkill.com/2024/11/hugo-add-tag-cloud/><span class=title></span>
<span>Hugo博客添加标签云&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right" style="user-select:text"><line x1="5" y1="12" x2="19" y2="12" style="user-select:text"/><polyline points="12 5 19 12 12 19" style="user-select:text"/></svg></span></a></nav></footer><div class=pe-comments-decoration><p class=pe-comments-title></p><p class=pe-comments-subtitle></p></div><div id=pe-comments></div><script src=/js/pe-go-comment.min.86a214102576ba5f9b7bdc29eed8d58dd56e34aef80b3c65c73ea9cc88443696.js integrity="sha256-hqIUECV2ul+be9wp7tjVjdVuNK74Czxlxz6pzIhENpY="></script><script>const getStoredTheme=()=>localStorage.getItem("pref-theme")==="dark"?"dark":"light",setGiscusTheme=()=>{const e=e=>{const t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:e},"https://giscus.app")};e({setConfig:{theme:getStoredTheme()}})};document.addEventListener("DOMContentLoaded",()=>{const s={src:"https://giscus.app/client.js","data-repo":"cylonchau/blogs","data-repo-id":"R_kgDOIRlNSQ","data-category":"Announcements","data-category-id":"DIC_kwDOIRlNSc4CXy1U","data-mapping":"pathname","data-term":"posts/grafana-loki-2-9","data-strict":"0","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"bottom","data-theme":getStoredTheme(),"data-lang":"zh-TW","data-loading":"lazy",crossorigin:"anonymous",async:""},e=document.createElement("script");Object.entries(s).forEach(([t,n])=>e.setAttribute(t,n)),document.querySelector("#pe-comments").appendChild(e);const t=document.querySelector("#theme-toggle");t&&t.addEventListener("click",setGiscusTheme);const n=document.querySelector("#theme-toggle-float");n&&n.addEventListener("click",setGiscusTheme)})</script></article></main><footer class=footer><span>&copy; 2025 <a href=https://www.oomkill.com/>Cylon's Collection</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> on
<a href=https://pages.github.com/ rel=noopener target=_blank>GitHub Pages</a> & Theme
        <a href=https://github.com/tofuwine/PaperMod-PE rel=noopener target=_blank>PaperMod-PE</a></span></footer><div class=pe-right-sidebar><a href=javascript:void(0); id=theme-toggle-float class=pe-float-btn><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</a><a href=#top class=pe-float-btn id=top-link><span id=pe-read-progress></span></a></div><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>