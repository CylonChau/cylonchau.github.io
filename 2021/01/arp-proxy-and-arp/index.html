<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>ARP与ARP Proxy | Cylon's Collection</title><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NP3JNCPR" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><meta name=keywords content="arp,network"><meta name=description content='什么是arp 地址解析协议，Address Resolution Protoco，使用ARP协议可实现通过IP地址获得对应主机的的物理地址（MAC）
在TCP/IP的网络环境下，每个互联网的主机都会被分配一个32位的IP地址，这种互联网地址是在网际范围标识主机的一种逻辑地址。为了让报文在物理网路上传输，还补习要知道对方目的主机的物理地址才行。这样就存在把IP地址变换成物理地址的地址转换问题。
在以太网环境，为了正确地向目的主机传送报文，必须把目的主机的32为IP地址转换成为目的主机48位以太网地址(MAC),这个就需要在互联层有一个服务或功能将IP地址转换为相应的物理地址(MAC)，这个服务就是ARP协议.
所谓的"地址解析"，就是主机在发送帧之前将目标IP地址转换成目标MAC地址的过程。ARP协议的基本功能就是通过目标设备的IP地址，查询目标设备的MAC地址，以保证主机间互相通信的顺利进行.
ARP协议和DNS有相像之处。不同点是：DNS实在域名和IP之间解析，另外ARP协议不需要配置服务，而DNS要配置服务才行。
ARP缓存表 在每台安装有TCP/IP协议的设备都会有一个ARP缓存表（windows命令提示符里输入arp -a即可）， 表里的IP地址与MAC地址是一一对应的。
bash 1 2 3 4 5 6 7 8 9 10 C:\Users\CM>arp -a 接口: 192.168.1.103 --- 0x3 Internet 地址 物理地址 类型 192.168.1.1 3c-46-d8-5d-53-87 动态 192.168.1.255 ff-ff-ff-ff-ff-ff 静态 224.0.0.22 01-00-5e-00-00-16 静态 224.0.0.251 01-00-5e-00-00-fb 静态 224.0.0.252 01-00-5e-00-00-fc 静态 239.11.20.1 01-00-5e-0b-14-01 静态 239.255.255.250 01-00-5e-7f-ff-fa 静态 arp常用命令 arp -a 查看所有记录
arp -d 清除arp表
arp -s $ip $mac 将绑定IP和MAC
arp -n 不解析名称打印arp表
ARP缓存是把双刃剑 主机有了arp缓存表，可以加快arp的解析速度，减少局域网内广播风暴。'><meta name=author content="cylon"><link rel=canonical href=https://www.oomkill.com/2021/01/arp-proxy-and-arp/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://www.oomkill.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.oomkill.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.oomkill.com/favicon-32x32.png><link rel=apple-touch-icon href=https://www.oomkill.com/favicon.ico><link rel=mask-icon href=https://www.oomkill.com/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://www.oomkill.com/2021/01/arp-proxy-and-arp/><noscript><style>#theme-toggle,#top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link crossorigin=anonymous href=/assets/css/pe.min.css rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/pe.min.js></script><link rel=stylesheet href=https://cdn.staticfile.net/font-awesome/6.5.1/css/all.min.css><link rel=stylesheet href=https://cdn.staticfile.net/font-awesome/6.5.1/css/v4-shims.min.css><script defer src=https://cdn.staticfile.net/jquery/3.5.1/jquery.min.js></script><link rel=stylesheet href=https://cdn.staticfile.net/fancybox/3.5.7/jquery.fancybox.min.css><script defer src=https://cdn.staticfile.net/fancybox/3.5.7/jquery.fancybox.min.js></script><script id=MathJax-script async src=https://cdn.staticfile.net/mathjax/3.2.2/es5/tex-chtml.js></script><script>MathJax={tex:{displayMath:[["$$","$$"]],inlineMath:[["\\$","\\$"]]}}</script><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><meta name=referrer content="no-referrer-when-downgrade"><script>(function(e,t,n,s,o){e[s]=e[s]||[],e[s].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var a=t.getElementsByTagName(n)[0],i=t.createElement(n),r=s!="dataLayer"?"&l="+s:"";i.async=!0,i.src="https://www.googletagmanager.com/gtm.js?id="+o+r,a.parentNode.insertBefore(i,a)})(window,document,"script","dataLayer","GTM-NP3JNCPR")</script><meta property="og:title" content="ARP与ARP Proxy"><meta property="og:description" content='什么是arp 地址解析协议，Address Resolution Protoco，使用ARP协议可实现通过IP地址获得对应主机的的物理地址（MAC）
在TCP/IP的网络环境下，每个互联网的主机都会被分配一个32位的IP地址，这种互联网地址是在网际范围标识主机的一种逻辑地址。为了让报文在物理网路上传输，还补习要知道对方目的主机的物理地址才行。这样就存在把IP地址变换成物理地址的地址转换问题。
在以太网环境，为了正确地向目的主机传送报文，必须把目的主机的32为IP地址转换成为目的主机48位以太网地址(MAC),这个就需要在互联层有一个服务或功能将IP地址转换为相应的物理地址(MAC)，这个服务就是ARP协议.
所谓的"地址解析"，就是主机在发送帧之前将目标IP地址转换成目标MAC地址的过程。ARP协议的基本功能就是通过目标设备的IP地址，查询目标设备的MAC地址，以保证主机间互相通信的顺利进行.
ARP协议和DNS有相像之处。不同点是：DNS实在域名和IP之间解析，另外ARP协议不需要配置服务，而DNS要配置服务才行。
ARP缓存表 在每台安装有TCP/IP协议的设备都会有一个ARP缓存表（windows命令提示符里输入arp -a即可）， 表里的IP地址与MAC地址是一一对应的。
bash 1 2 3 4 5 6 7 8 9 10 C:\Users\CM>arp -a 接口: 192.168.1.103 --- 0x3 Internet 地址 物理地址 类型 192.168.1.1 3c-46-d8-5d-53-87 动态 192.168.1.255 ff-ff-ff-ff-ff-ff 静态 224.0.0.22 01-00-5e-00-00-16 静态 224.0.0.251 01-00-5e-00-00-fb 静态 224.0.0.252 01-00-5e-00-00-fc 静态 239.11.20.1 01-00-5e-0b-14-01 静态 239.255.255.250 01-00-5e-7f-ff-fa 静态 arp常用命令 arp -a 查看所有记录
arp -d 清除arp表
arp -s $ip $mac 将绑定IP和MAC
arp -n 不解析名称打印arp表
ARP缓存是把双刃剑 主机有了arp缓存表，可以加快arp的解析速度，减少局域网内广播风暴。'><meta property="og:type" content="article"><meta property="og:url" content="https://www.oomkill.com/2021/01/arp-proxy-and-arp/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-01-20T00:00:00+00:00"><meta property="article:modified_time" content="2023-03-22T23:00:36+08:00"><meta property="og:site_name" content="Cylon's Collection"><meta name=twitter:card content="summary"><meta name=twitter:title content="ARP与ARP Proxy"><meta name=twitter:description content='什么是arp 地址解析协议，Address Resolution Protoco，使用ARP协议可实现通过IP地址获得对应主机的的物理地址（MAC）
在TCP/IP的网络环境下，每个互联网的主机都会被分配一个32位的IP地址，这种互联网地址是在网际范围标识主机的一种逻辑地址。为了让报文在物理网路上传输，还补习要知道对方目的主机的物理地址才行。这样就存在把IP地址变换成物理地址的地址转换问题。
在以太网环境，为了正确地向目的主机传送报文，必须把目的主机的32为IP地址转换成为目的主机48位以太网地址(MAC),这个就需要在互联层有一个服务或功能将IP地址转换为相应的物理地址(MAC)，这个服务就是ARP协议.
所谓的"地址解析"，就是主机在发送帧之前将目标IP地址转换成目标MAC地址的过程。ARP协议的基本功能就是通过目标设备的IP地址，查询目标设备的MAC地址，以保证主机间互相通信的顺利进行.
ARP协议和DNS有相像之处。不同点是：DNS实在域名和IP之间解析，另外ARP协议不需要配置服务，而DNS要配置服务才行。
ARP缓存表 在每台安装有TCP/IP协议的设备都会有一个ARP缓存表（windows命令提示符里输入arp -a即可）， 表里的IP地址与MAC地址是一一对应的。
bash 1 2 3 4 5 6 7 8 9 10 C:\Users\CM>arp -a 接口: 192.168.1.103 --- 0x3 Internet 地址 物理地址 类型 192.168.1.1 3c-46-d8-5d-53-87 动态 192.168.1.255 ff-ff-ff-ff-ff-ff 静态 224.0.0.22 01-00-5e-00-00-16 静态 224.0.0.251 01-00-5e-00-00-fb 静态 224.0.0.252 01-00-5e-00-00-fc 静态 239.11.20.1 01-00-5e-0b-14-01 静态 239.255.255.250 01-00-5e-7f-ff-fa 静态 arp常用命令 arp -a 查看所有记录
arp -d 清除arp表
arp -s $ip $mac 将绑定IP和MAC
arp -n 不解析名称打印arp表
ARP缓存是把双刃剑 主机有了arp缓存表，可以加快arp的解析速度，减少局域网内广播风暴。'><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://www.oomkill.com/posts/"},{"@type":"ListItem","position":2,"name":"ARP与ARP Proxy","item":"https://www.oomkill.com/2021/01/arp-proxy-and-arp/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"ARP与ARP Proxy","name":"ARP与ARP Proxy","description":"什么是arp 地址解析协议，Address Resolution Protoco，使用ARP协议可实现通过IP地址获得对应主机的的物理地址（MAC）\n在TCP/IP的网络环境下，每个互联网的主机都会被分配一个32位的IP地址，这种互联网地址是在网际范围标识主机的一种逻辑地址。为了让报文在物理网路上传输，还补习要知道对方目的主机的物理地址才行。这样就存在把IP地址变换成物理地址的地址转换问题。\n在以太网环境，为了正确地向目的主机传送报文，必须把目的主机的32为IP地址转换成为目的主机48位以太网地址(MAC),这个就需要在互联层有一个服务或功能将IP地址转换为相应的物理地址(MAC)，这个服务就是ARP协议.\n所谓的\u0026quot;地址解析\u0026quot;，就是主机在发送帧之前将目标IP地址转换成目标MAC地址的过程。ARP协议的基本功能就是通过目标设备的IP地址，查询目标设备的MAC地址，以保证主机间互相通信的顺利进行.\nARP协议和DNS有相像之处。不同点是：DNS实在域名和IP之间解析，另外ARP协议不需要配置服务，而DNS要配置服务才行。\nARP缓存表 在每台安装有TCP/IP协议的设备都会有一个ARP缓存表（windows命令提示符里输入arp -a即可）， 表里的IP地址与MAC地址是一一对应的。\nbash 1 2 3 4 5 6 7 8 9 10 C:\\Users\\CM\u0026gt;arp -a 接口: 192.168.1.103 --- 0x3 Internet 地址 物理地址 类型 192.168.1.1 3c-46-d8-5d-53-87 动态 192.168.1.255 ff-ff-ff-ff-ff-ff 静态 224.0.0.22 01-00-5e-00-00-16 静态 224.0.0.251 01-00-5e-00-00-fb 静态 224.0.0.252 01-00-5e-00-00-fc 静态 239.11.20.1 01-00-5e-0b-14-01 静态 239.255.255.250 01-00-5e-7f-ff-fa 静态 arp常用命令 arp -a 查看所有记录\narp -d 清除arp表\narp -s $ip $mac 将绑定IP和MAC\narp -n 不解析名称打印arp表\nARP缓存是把双刃剑 主机有了arp缓存表，可以加快arp的解析速度，减少局域网内广播风暴。","keywords":["arp","network"],"articleBody":"什么是arp 地址解析协议，Address Resolution Protoco，使用ARP协议可实现通过IP地址获得对应主机的的物理地址（MAC）\n在TCP/IP的网络环境下，每个互联网的主机都会被分配一个32位的IP地址，这种互联网地址是在网际范围标识主机的一种逻辑地址。为了让报文在物理网路上传输，还补习要知道对方目的主机的物理地址才行。这样就存在把IP地址变换成物理地址的地址转换问题。\n在以太网环境，为了正确地向目的主机传送报文，必须把目的主机的32为IP地址转换成为目的主机48位以太网地址(MAC),这个就需要在互联层有一个服务或功能将IP地址转换为相应的物理地址(MAC)，这个服务就是ARP协议.\n所谓的\"地址解析\"，就是主机在发送帧之前将目标IP地址转换成目标MAC地址的过程。ARP协议的基本功能就是通过目标设备的IP地址，查询目标设备的MAC地址，以保证主机间互相通信的顺利进行.\nARP协议和DNS有相像之处。不同点是：DNS实在域名和IP之间解析，另外ARP协议不需要配置服务，而DNS要配置服务才行。\nARP缓存表 在每台安装有TCP/IP协议的设备都会有一个ARP缓存表（windows命令提示符里输入arp -a即可）， 表里的IP地址与MAC地址是一一对应的。\nbash 1 2 3 4 5 6 7 8 9 10 C:\\Users\\CM\u003earp -a 接口: 192.168.1.103 --- 0x3 Internet 地址 物理地址 类型 192.168.1.1 3c-46-d8-5d-53-87 动态 192.168.1.255 ff-ff-ff-ff-ff-ff 静态 224.0.0.22 01-00-5e-00-00-16 静态 224.0.0.251 01-00-5e-00-00-fb 静态 224.0.0.252 01-00-5e-00-00-fc 静态 239.11.20.1 01-00-5e-0b-14-01 静态 239.255.255.250 01-00-5e-7f-ff-fa 静态 arp常用命令 arp -a 查看所有记录\narp -d 清除arp表\narp -s $ip $mac 将绑定IP和MAC\narp -n 不解析名称打印arp表\nARP缓存是把双刃剑 主机有了arp缓存表，可以加快arp的解析速度，减少局域网内广播风暴。\n正是有了arp缓存表，给恶意黑客带来了攻击服务器主机的风险，这个就是arp欺骗攻击\n切换路由器，负载均衡器等设备时，可能会导致短时网络中断（发送广播）。\n为什么要使用ARP协议 OSI模型把网络工作分为七层，彼此不直接打交道，只通过接口(layer interface)。IP地址工作在第三层，MAC地址工作在第二层。在局域网中，当主机或其它三层网络设备有数据要发送给另一台主机或三层网络设备时，它需要知道对方的网络层地址（即IP地址）。但是仅有IP地址是不够的，因为IP报文必须封装成帧才能通过物理网络发送，因此发送方还需要知道接收方的物理地址（即MAC地址），但又不能跨第二、三层，所以需要用ARP协议服务，来帮助获取到目的节点的MAC地址。ARP可以实现将IP地址解析为MAC地址。主机或三层网络设备上会维护一张ARP表，用于存储IP地址和MAC地址的关系。一般ARP表项包括动态ARP表项和静态ARP表项。\n模拟一个环境抓包分析arp数据包的内容 text 1 2 3 4 5 6 [Huawei] 系统视图 用户视图，开机命令行进入的就是用户视图 system-view 用户视图切换系统视图 interface g0/0/0 选择接口 display arp all 查看arp表 arp-porxy enable 开启代理ARP功能 bash 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 dis this # return # 设置g0/0/0接口ip [Huawei-GigabitEthernet0/0/0]ip a 192.168.0.1 24 Jan 19 2021 17:56:33-08:00 Huawei %%01IFNET/4/LINK_STATE(l)[0]:The line protocol IP on the interface GigabitEthernet0/0/0 has entered the UP state. [Huawei-GigabitEthernet0/0/0] [Huawei-GigabitEthernet0/0/0]dis this [V200R003C00] # interface GigabitEthernet0/0/0 ip address 192.168.0.1 255.255.255.0 # return # 设置g0/0/1 ip [Huawei-GigabitEthernet0/0/0]int g0/0/1 [Huawei-GigabitEthernet0/0/1]ip a 192.168.1.1 24 Jan 19 2021 17:57:02-08:00 Huawei %%01IFNET/4/LINK_STATE(l)[1]:The line protocol IP on the interface GigabitEthernet0/0/1 has entered the UP state. 此时查看pc与路由器的arp表\ntext 1 2 3 4 5 $ arp -a Internet Address Physical Address Type $ ping另外一台设备 192.168.2.2\ntext 1 2 3 4 5 6 7 8 9 10 11 12 $ ping 192.168.1.2 Ping 192.168.1.2: 32 data bytes, Press Ctrl_C to break Request timeout! From 192.168.1.2: bytes=32 seq=2 ttl=127 time=15 ms From 192.168.1.2: bytes=32 seq=3 ttl=127 time=16 ms --- 192.168.1.2 ping statistics --- 3 packet(s) transmitted 2 packet(s) received 33.33% packet loss round-trip min/avg/max = 0/15/16 ms 另外一段抓包可以看到对应收到的广播\n以太网arp数据包段说明\n目的mac地址 源mac地址 帧类型 硬件类型 上层协议类型 mac地址长度 ip地址长度 操作类型 源mac地址 源ip地址 目的mac地址 目的ip地址 HuaweiTe_c7:73:db (54:89:98:c7:73:db) HuaweiTe_58:37:e8 (00:e0:fc:58:37:e8) ARP Ethernet IPv4 6 4 2 HuaweiTe_58:37:e8 (00:e0:fc:58:37:e8) 192.168.0.1 HuaweiTe_c7:73:db (54:89:98:c7:73:db) 192.168.0.2 arp广播是通过网关进行传递的，本机arp表缓存的为网关的mac地址\ntext 1 2 3 4 $ arp -a Internet Address Physical Address Type 192.168.1.1 00-E0-FC-58-37-E9 dynamic op操作类型说明\n代码 说明 1 arp请求 2 arp应答 3 rarp请求 4 rarp应答 动态ARP表项 动态ARP表项由ARP协议通过ARP报文自动生成和维护，可以被老化，可以被新的ARP报文更新，也可以被静态ARP表项所覆盖。当到达老化时间或接口关闭时会删除相应的动态ARP表项。\n静态ARP表项 静态ARP表项通过手工配置（通过对应设备的IP地址与MAC地址绑定命定进行）和维护。不会被老化，也不会被动态ARP表项覆盖。配置静态ARP表项可以增加通信的安全性，因为静态ARP可以限定和指定IP地址的设备通信时只使用指定的MAC地址（也就是我们通常所说的IP地址和MAC地址的绑定），此时攻击报文无法修改此表项的IP地址和MAC地址的映射关系，从而保护了本设备和指定设备间正常通信。静态ARP表项又分为短静态ARP表项和长静态ARP表项\n短静态ARP表项 在配置短静态ARP表项时，只需要配置IP地址和MAC地址项。如果出接口是三层以太网接口，短静态ARP表项可以直接用于报文转发；如果出接口是VLAN虚接口，短静态ARP表项不能直接用于报文转发，当要发送IP数据包时，先发送ARP请求报文，如果收到的相应报文中的源IP地址和源MAC地址与所配置的IP地址和MAC地址相同，则将接受ARP响应报文的接口加入该静态表项中，之后就可以用于IP数据包的转发了。\n长静态ARP表项 在配置长静态ARP表项时，除了配置IP地址和MAC地址项外，还必须配置该ARP表所对应的VLAN（虚拟局域网）和出接口。也就是长静态ARP表项同事绑定了IP地址、MAC地址、VLAN和端口，可以直接用于报文转发。\napr欺骗 ARP病毒，ARP欺骗\n高可用服务器对之间切换时要考虑ARP缓存问题\n路由器等设备无缝迁移时要考虑ARP缓存的问题，例如：更换办公室的路由器.\nARP欺骗原理 ARP攻击就是通过伪造IP地址和MAC地址对实现ARP欺骗的，如果一台主机中了ARP病毒，那么它就能够在网络中产生大量的ARP通信量（它会以很快的频率进行广播），以至于使网络阻塞，攻击者只要持续不断的发出伪造ARP响应包就能更改局域网中目标主机ARP缓存中的IP-MAC条目，造成网络中断或中间人攻击。\nARP攻击主要是存在于局域网网络中，局域网中若有一个人感染ARP木马，则感染该ARP木马的系统将会试图通过“ARP欺骗”手段截获所在网络内其他计算机的通信故障。\n服务器切换ARP问题\n当网络中一台提供服务的机器宕机后，当在其他运行正常的机器添加宕机的机器的IP时，会因为客户端的ARP table cache的地址解析还是宕机的机器的MAC地址。从而导致，即使在其他运行正常的机器添加宕机的机器的IP，也会发生客户依然无法访问的情况。\n解决方法是：当宕机时，IP地址迁移到其他机器上时，需要通过arping命令来通知所有网络内机器清除其本地的ARP table cache，从而使得客户机访问时重新广播获取MAC地址.\n几乎所有的高可用软件都会考虑这个问题。\nARP广播而进行新的地址解析。\nlinux下具体命令：\ntext 1 2 arping -I eth0 -c 3 -s 10.0.0.162 10.0.0.253 arping -U -I eth0 10.0.0.162 proxy arp 代理ARP的原理就是当出现跨网段的ARP请求时，路由器将自己的MAC返回给发送ARP广播请求发送者，实现MAC地址代理（善意的欺骗），最终使得主机能够通信。\n如一个网络中设备D1 (192.168.0.2/24) 与设备D2 (192.168.1.2/24)，D1和D2在相互通信时，D1先发送了ARP广播，请求D2的mac地址，但是由于两个设备处于不同网，也就是说D1的ARP请求会被R1拦截到，然后R1会封装自己的mac地址为目的地址发送一个ARP回应数据报给R1（善意的欺骗），然后R1就会代替D1去访问D2。\n如上述arp抓包图，首先广播收到回复为R1192.168.0.1\n如果R1关闭了arp的代理功能，那么R1再访问R3的时候，R2并不会把自己的mac地址给R1，那么R1和R3之间就无法通信。默认情况下，思科的设备是开启了arp代理功能，也就是说，R2会作为中间代理实现R1和R3之间跨网段通信。\n实验：通过命名空间模拟容器网络的代理arp数据包 实验前所需掌握的知识接口作用域 interface scope与链路本地地址（Link-local address)\n接口作用域 路由的接口作用域，这个配置可以解释为路由的范围会影响源数据（源地址）请求的选择。当主机存在多个网络接口和地址时，route scope控制ip数据寻址和广播的范围。\nglobal：如果来自不同的端口（可以理解为网卡等）可以转发。\nlink：仅在此设备有效，即只有来自这个网络接口设备的流量才走这条路由（发送和接收为同一端口）\nhost：本地回环，仅用于在主机内部进行通信。\nsite：ipv6独有。\nreference http://linux-ip.net/html/tools-ip-address.html\n链路本地地址 169.254.0.0/16 保留地址块，在169.254.1.0 ~ 169.254.254.255 中随机选择一个地址进行ARP广播，如果收到回复，表示IP地址已经使用。\n在Kubernetes Calico网络中，当一个数据包的目的地址不是本网络时，会先发起ARP广播，网关设置即169.254.1.1收到会将自己的mac地址返回给发送端，后续的请求由这个veth对进行完成，使用代理arp做了arp欺骗。这样做抑制了arp广播攻击，并且通过代理arp也可以进行跨网络的访问。\n实验目的：模拟calico网络，使用代理arp欺骗完成网络的跨网段通信\n在准备的两个主机进行相应的设置\nbash 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 # 添加网络名称空间 ip netns add net1 # 创建一个虚拟以太网对 ip link add veth1 type veth peer name eth1 # 将一端关联至网络名称空间内 ip link set eth1 netns net1 # 设置一个IP地址 ip netns exec net1 ip addr add 192.168.1.10/24 dev eth1 # 启动这个网卡 ip netns exec net1 ip link set eth1 up # 添加一个自动寻址IP，作为网关 ip netns exec net1 ip route add 169.254.1.1 dev eth1 scope link # 所有的流量都通过这个网关进行进出 ip netns exec net1 ip route add default via 169.254.1.1 dev eth1 ip netns exec net1 ip route ip netns exec net1 ip link set eth1 up # 设置主机端的网络对 ip link set veth1 up # 所有通过192.168.1.10的数据包进出都走veth1 ip route add 192.168.1.10 dev veth1 scope link # 通往192.168.2.10的数据的下一挑是10.0.0.3（对端主机IP） ip route add 192.168.2.10 via 10.0.0.3 dev eth0 ## 设置另外一台设备 ip netns add net1 ip link add veth1 type veth peer name eth1 ip link set eth1 netns net1 ip netns exec net1 ip addr add 192.168.2.10/24 dev eth1 ip netns exec net1 ip link set eth1 up ip netns exec net1 ip route add 169.254.1.1 dev eth1 scope link ip netns exec net1 ip route add default via 169.254.1.1 dev eth1 ip netns exec net1 ip route ip link set veth1 up ip route add 192.168.2.10 dev veth1 scope link ip route add 192.168.1.10 via 10.0.0.4 dev eth0 开启对应内核设置\nbash 1 2 3 4 5 6 # 代理arp echo 1 \u003e /proc/sys/net/ipv4/conf/veth1/proxy_arp # 专用VLAN代理arp。基本上允许代理arp回复到同一接口 echo 1 \u003e /proc/sys/net/ipv4/conf/veth1/proxy_arp_pvlan # 内核转发 echo 1 \u003e /proc/sys/net/ipv4/ip_forward reference\nlinux proxy arp\n169.254-ip-address\n​\n","wordCount":"683","inLanguage":"zh","datePublished":"2021-01-20T00:00:00Z","dateModified":"2023-03-22T23:00:36+08:00","author":{"@type":"Person","name":"cylon"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.oomkill.com/2021/01/arp-proxy-and-arp/"},"publisher":{"@type":"Organization","name":"Cylon's Collection","logo":{"@type":"ImageObject","url":"https://www.oomkill.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.oomkill.com/><img src=https://www.oomkill.com/favicon.ico alt aria-label=logo height=20>Cylon's Collection</a><div class=logo-switches><button id=theme-toggle><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://www.oomkill.com/archives><span>归档</span></a></li><li><a href=https://www.oomkill.com/tags><span>标签</span></a></li><li><a href=https://www.oomkill.com/search><span>搜索</span></a></li><li><a href=https://www.oomkill.com/about accesskey=/><span>关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">ARP与ARP Proxy</h1><div class=post-meta><span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar" style="user-select:text"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" style="user-select:text"/><line x1="16" y1="2" x2="16" y2="6" style="user-select:text"/><line x1="8" y1="2" x2="8" y2="6" style="user-select:text"/><line x1="3" y1="10" x2="21" y2="10" style="user-select:text"/></svg><span>2021-01-20</span></span>&nbsp;·&nbsp;<span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text" style="user-select:text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z" style="user-select:text"/><polyline points="14 2 14 8 20 8" style="user-select:text"/><line x1="16" y1="13" x2="8" y2="13" style="user-select:text"/><line x1="16" y1="17" x2="8" y2="17" style="user-select:text"/><polyline points="10 9 9 9 8 9" style="user-select:text"/></svg><span>683 字</span></span>&nbsp;·&nbsp;<span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><span>4 分钟</span></span>
<span class=pe-post-meta-item>&nbsp;·&nbsp;<svg t="1714036239378" fill="currentcolor" class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="6659" width="256" height="256"><path d="M690 78.2c-18.6-18.8-49-19-67.8-.4s-19 49-.4 67.8l255.4 258.6c67.8 68.6 67.8 178.8.0 247.4L653.4 878.2c-18.6 18.8-18.4 49.2.4 67.8s49.2 18.4 67.8-.4l224-226.4c104.8-106 104.8-276.4.0-382.4L690 78.2zM485.4 101.4c-24-24-56.6-37.4-90.6-37.4H96C43 64 0 107 0 160v299c0 34 13.4 66.6 37.4 90.6l336 336c50 50 131 50 181 0l267-267c50-50 50-131 0-181l-336-336zM96 160h299c8.4.0 16.6 3.4 22.6 9.4l336 336c12.4 12.4 12.4 32.8.0 45.2l-267 267c-12.4 12.4-32.8 12.4-45.2.0l-336-336c-6-6-9.4-14.2-9.4-22.6V160zm192 128a64 64 0 10-128 0 64 64 0 10128 0z" p-id="6660"/></svg></span><ul class=pe-post-meta-item><a href=https://www.oomkill.com/tags/network/>#Network</a></ul></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details><summary><span class=details>目录</span></summary><div class=inner><ul><li><a href=#%e4%bb%80%e4%b9%88%e6%98%afarp aria-label=什么是arp>什么是arp</a><ul><li><a href=#arp%e7%bc%93%e5%ad%98%e8%a1%a8 aria-label=ARP缓存表>ARP缓存表</a><li><a href=#arp%e5%b8%b8%e7%94%a8%e5%91%bd%e4%bb%a4 aria-label=arp常用命令>arp常用命令</a><li><a href=#arp%e7%bc%93%e5%ad%98%e6%98%af%e6%8a%8a%e5%8f%8c%e5%88%83%e5%89%91 aria-label=ARP缓存是把双刃剑>ARP缓存是把双刃剑</a><li><a href=#%e4%b8%ba%e4%bb%80%e4%b9%88%e8%a6%81%e4%bd%bf%e7%94%a8arp%e5%8d%8f%e8%ae%ae aria-label=为什么要使用ARP协议>为什么要使用ARP协议</a></ul><li><a href=#%e6%a8%a1%e6%8b%9f%e4%b8%80%e4%b8%aa%e7%8e%af%e5%a2%83%e6%8a%93%e5%8c%85%e5%88%86%e6%9e%90arp%e6%95%b0%e6%8d%ae%e5%8c%85%e7%9a%84%e5%86%85%e5%ae%b9 aria-label=模拟一个环境抓包分析arp数据包的内容>模拟一个环境抓包分析arp数据包的内容</a><ul><li><a href=#%e5%8a%a8%e6%80%81arp%e8%a1%a8%e9%a1%b9 aria-label=动态ARP表项>动态ARP表项</a><li><a href=#%e9%9d%99%e6%80%81arp%e8%a1%a8%e9%a1%b9 aria-label=静态ARP表项>静态ARP表项</a><li><a href=#%e7%9f%ad%e9%9d%99%e6%80%81arp%e8%a1%a8%e9%a1%b9 aria-label=短静态ARP表项>短静态ARP表项</a><li><a href=#%e9%95%bf%e9%9d%99%e6%80%81arp%e8%a1%a8%e9%a1%b9 aria-label=长静态ARP表项>长静态ARP表项</a><li><a href=#apr%e6%ac%ba%e9%aa%97 aria-label=apr欺骗>apr欺骗</a><li><a href=#arp%e6%ac%ba%e9%aa%97%e5%8e%9f%e7%90%86 aria-label=ARP欺骗原理>ARP欺骗原理</a></ul><li><a href=#proxy-arp aria-label="proxy arp">proxy arp</a><ul><li><a href=#%e5%ae%9e%e9%aa%8c%e9%80%9a%e8%bf%87%e5%91%bd%e5%90%8d%e7%a9%ba%e9%97%b4%e6%a8%a1%e6%8b%9f%e5%ae%b9%e5%99%a8%e7%bd%91%e7%bb%9c%e7%9a%84%e4%bb%a3%e7%90%86arp%e6%95%b0%e6%8d%ae%e5%8c%85 aria-label=实验：通过命名空间模拟容器网络的代理arp数据包>实验：通过命名空间模拟容器网络的代理arp数据包</a><ul><li><a href=#%e6%8e%a5%e5%8f%a3%e4%bd%9c%e7%94%a8%e5%9f%9f aria-label=接口作用域>接口作用域</a><li><a href=#%e9%93%be%e8%b7%af%e6%9c%ac%e5%9c%b0%e5%9c%b0%e5%9d%80 aria-label=链路本地地址>链路本地地址</a></li></div></details></div></aside><script src=/js/pe-toc.min.445eb1bfc5e85dd13b9519fcc2a806522e9629b6224a2974052789ba00ab78af.js integrity="sha256-RF6xv8XoXdE7lRn8wqgGUi6WKbYiSil0BSeJugCreK8="></script><div class=post-content><h2 id=什么是arp>什么是arp<a hidden class=anchor aria-hidden=true href=#什么是arp>#</a></h2><p>地址解析协议，<code>Address Resolution Protoco</code>，使用ARP协议可实现通过IP地址获得对应主机的的物理地址（MAC）</p><p>在TCP/IP的网络环境下，每个互联网的主机都会被分配一个32位的IP地址，这种互联网地址是在网际范围标识主机的一种逻辑地址。为了让报文在物理网路上传输，还补习要知道对方目的主机的物理地址才行。这样就存在把IP地址变换成物理地址的地址转换问题。</p><p>在以太网环境，为了正确地向目的主机传送报文，必须把目的主机的32为IP地址转换成为目的主机48位以太网地址(MAC),这个就需要在互联层有一个服务或功能将IP地址转换为相应的物理地址(MAC)，这个服务就是ARP协议.</p><p>所谓的"地址解析"，就是主机在发送帧之前将目标IP地址转换成目标MAC地址的过程。ARP协议的基本功能就是通过目标设备的IP地址，查询目标设备的MAC地址，以保证主机间互相通信的顺利进行.</p><p>ARP协议和DNS有相像之处。不同点是：DNS实在域名和IP之间解析，另外ARP协议不需要配置服务，而DNS要配置服务才行。</p><h3 id=arp缓存表>ARP缓存表<a hidden class=anchor aria-hidden=true href=#arp缓存表>#</a></h3><p>在每台安装有TCP/IP协议的设备都会有一个ARP缓存表（windows命令提示符里输入<code>arp -a</code>即可）， 表里的IP地址与MAC地址是一一对应的。</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20221025172742176.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20221025172742176.png#center alt=image-20221025172742176 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>C:<span class=se>\U</span>sers<span class=se>\C</span>M&gt;arp -a
</span></span><span class=line><span class=cl>接口: 192.168.1.103 --- 0x3
</span></span><span class=line><span class=cl>  Internet 地址         	物理地址              	类型
</span></span><span class=line><span class=cl>  192.168.1.1           	3c-46-d8-5d-53-87     	动态
</span></span><span class=line><span class=cl>  192.168.1.255         	ff-ff-ff-ff-ff-ff    	静态
</span></span><span class=line><span class=cl>  224.0.0.22            	01-00-5e-00-00-16     	静态
</span></span><span class=line><span class=cl>  224.0.0.251           	01-00-5e-00-00-fb    	静态
</span></span><span class=line><span class=cl>  224.0.0.252           	01-00-5e-00-00-fc     	静态
</span></span><span class=line><span class=cl>  239.11.20.1           	01-00-5e-0b-14-01     	静态
</span></span><span class=line><span class=cl>  239.255.255.250       	01-00-5e-7f-ff-fa     	静态</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=arp常用命令>arp常用命令<a hidden class=anchor aria-hidden=true href=#arp常用命令>#</a></h3><p><code>arp -a</code> 查看所有记录</p><p><code>arp -d</code> 清除arp表</p><p><code>arp -s $ip $mac</code> 将绑定IP和MAC</p><p><code>arp -n</code> 不解析名称打印arp表</p><h3 id=arp缓存是把双刃剑>ARP缓存是把双刃剑<a hidden class=anchor aria-hidden=true href=#arp缓存是把双刃剑>#</a></h3><p>主机有了arp缓存表，可以加快arp的解析速度，减少局域网内广播风暴。</p><p>正是有了arp缓存表，给恶意黑客带来了攻击服务器主机的风险，这个就是arp欺骗攻击</p><p>切换路由器，负载均衡器等设备时，可能会导致短时网络中断（发送广播）。</p><h3 id=为什么要使用arp协议>为什么要使用ARP协议<a hidden class=anchor aria-hidden=true href=#为什么要使用arp协议>#</a></h3><p>OSI模型把网络工作分为七层，彼此不直接打交道，只通过接口(layer interface)。IP地址工作在第三层，MAC地址工作在第二层。在局域网中，当主机或其它三层网络设备有数据要发送给另一台主机或三层网络设备时，它需要知道对方的网络层地址（即IP地址）。但是仅有IP地址是不够的，因为IP报文必须封装成帧才能通过物理网络发送，因此发送方还需要知道接收方的物理地址（即MAC地址），但又不能跨第二、三层，所以需要用ARP协议服务，来帮助获取到目的节点的MAC地址。ARP可以实现将IP地址解析为MAC地址。主机或三层网络设备上会维护一张ARP表，用于存储IP地址和MAC地址的关系。一般ARP表项包括动态ARP表项和静态ARP表项。</p><h2 id=模拟一个环境抓包分析arp数据包的内容>模拟一个环境抓包分析arp数据包的内容<a hidden class=anchor aria-hidden=true href=#模拟一个环境抓包分析arp数据包的内容>#</a></h2><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>text</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>[Huawei]         系统视图
</span></span><span class=line><span class=cl>&lt;Huawei&gt;         用户视图，开机命令行进入的就是用户视图
</span></span><span class=line><span class=cl>system-view      用户视图切换系统视图
</span></span><span class=line><span class=cl>interface g0/0/0 选择接口
</span></span><span class=line><span class=cl>display arp all  查看arp表
</span></span><span class=line><span class=cl>arp-porxy enable 开启代理ARP功能</span></span></code></pre></td></tr></table></div></div></div></div><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>&lt;Huawei&gt;dis this 
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=k>return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 设置g0/0/0接口ip</span>
</span></span><span class=line><span class=cl><span class=o>[</span>Huawei-GigabitEthernet0/0/0<span class=o>]</span>ip a 192.168.0.1 <span class=m>24</span>
</span></span><span class=line><span class=cl>Jan <span class=m>19</span> <span class=m>2021</span> 17:56:33-08:00 Huawei %%01IFNET/4/LINK_STATE<span class=o>(</span>l<span class=o>)[</span>0<span class=o>]</span>:The line protocol
</span></span><span class=line><span class=cl> IP on the interface GigabitEthernet0/0/0 has entered the UP state. 
</span></span><span class=line><span class=cl><span class=o>[</span>Huawei-GigabitEthernet0/0/0<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>[</span>Huawei-GigabitEthernet0/0/0<span class=o>]</span>dis this
</span></span><span class=line><span class=cl><span class=o>[</span>V200R003C00<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl>interface GigabitEthernet0/0/0
</span></span><span class=line><span class=cl> ip address 192.168.0.1 255.255.255.0 
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=k>return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 设置g0/0/1 ip</span>
</span></span><span class=line><span class=cl><span class=o>[</span>Huawei-GigabitEthernet0/0/0<span class=o>]</span>int g0/0/1
</span></span><span class=line><span class=cl><span class=o>[</span>Huawei-GigabitEthernet0/0/1<span class=o>]</span>ip a 192.168.1.1 <span class=m>24</span>
</span></span><span class=line><span class=cl>Jan <span class=m>19</span> <span class=m>2021</span> 17:57:02-08:00 Huawei %%01IFNET/4/LINK_STATE<span class=o>(</span>l<span class=o>)[</span>1<span class=o>]</span>:The line protocol
</span></span><span class=line><span class=cl> IP on the interface GigabitEthernet0/0/1 has entered the UP state. </span></span></code></pre></td></tr></table></div></div></div></div><p>此时查看pc与路由器的arp表</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>text</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>$ arp -a
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Internet Address    Physical Address    Type
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ </span></span></code></pre></td></tr></table></div></div></div></div><p>ping另外一台设备 192.168.2.2</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>text</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>$ ping 192.168.1.2
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Ping 192.168.1.2: 32 data bytes, Press Ctrl_C to break
</span></span><span class=line><span class=cl>Request timeout!
</span></span><span class=line><span class=cl>From 192.168.1.2: bytes=32 seq=2 ttl=127 time=15 ms
</span></span><span class=line><span class=cl>From 192.168.1.2: bytes=32 seq=3 ttl=127 time=16 ms
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>--- 192.168.1.2 ping statistics ---
</span></span><span class=line><span class=cl>  3 packet(s) transmitted
</span></span><span class=line><span class=cl>  2 packet(s) received
</span></span><span class=line><span class=cl>  33.33% packet loss
</span></span><span class=line><span class=cl>  round-trip min/avg/max = 0/15/16 ms</span></span></code></pre></td></tr></table></div></div></div></div><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20210119185418021.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20210119185418021.png#center alt=image-20210119185418021 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><p>另外一段抓包可以看到对应收到的广播</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20210119185433046.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20210119185433046.png#center alt=image-20210119185433046 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><p>以太网arp数据包段说明</p><table><thead><tr><th>目的mac地址</th><th>源mac地址</th><th>帧类型</th><th>硬件类型</th><th>上层协议类型</th><th>mac地址长度</th><th>ip地址长度</th><th>操作类型</th><th>源mac地址</th><th>源ip地址</th><th>目的mac地址</th><th>目的ip地址</th></tr></thead><tbody><tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>HuaweiTe_c7:73:db (54:89:98:c7:73:db)</td><td>HuaweiTe_58:37:e8 (00:e0:fc:58:37:e8)</td><td>ARP</td><td>Ethernet</td><td>IPv4</td><td>6</td><td>4</td><td>2</td><td>HuaweiTe_58:37:e8 (00:e0:fc:58:37:e8)</td><td>192.168.0.1</td><td>HuaweiTe_c7:73:db (54:89:98:c7:73:db)</td><td>192.168.0.2</td></tr></tbody></table><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20210119191143883.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20210119191143883.png#center alt=image-20210119191143883 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><p>arp广播是通过网关进行传递的，本机arp表缓存的为网关的mac地址</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20210119191157808.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20210119191157808.png#center alt=image-20210119191157808 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>text</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>$ arp -a
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Internet Address    Physical Address    Type
</span></span><span class=line><span class=cl>192.168.1.1         00-E0-FC-58-37-E9   dynamic</span></span></code></pre></td></tr></table></div></div></div></div><p>op操作类型说明</p><table><thead><tr><th>代码</th><th>说明</th></tr></thead><tbody><tr><td>1</td><td>arp请求</td></tr><tr><td>2</td><td>arp应答</td></tr><tr><td>3</td><td>rarp请求</td></tr><tr><td>4</td><td>rarp应答</td></tr></tbody></table><h3 id=动态arp表项>动态ARP表项<a hidden class=anchor aria-hidden=true href=#动态arp表项>#</a></h3><p>动态ARP表项由ARP协议通过ARP报文自动生成和维护，可以被老化，可以被新的ARP报文更新，也可以被静态ARP表项所覆盖。当到达老化时间或接口关闭时会删除相应的动态ARP表项。</p><h3 id=静态arp表项>静态ARP表项<a hidden class=anchor aria-hidden=true href=#静态arp表项>#</a></h3><p>静态ARP表项通过手工配置（通过对应设备的IP地址与MAC地址绑定命定进行）和维护。不会被老化，也不会被动态ARP表项覆盖。配置静态ARP表项可以增加通信的安全性，因为静态ARP可以限定和指定IP地址的设备通信时只使用指定的MAC地址（也就是我们通常所说的IP地址和MAC地址的绑定），此时攻击报文无法修改此表项的IP地址和MAC地址的映射关系，从而保护了本设备和指定设备间正常通信。静态ARP表项又分为短静态ARP表项和长静态ARP表项</p><h3 id=短静态arp表项>短静态ARP表项<a hidden class=anchor aria-hidden=true href=#短静态arp表项>#</a></h3><p>在配置短静态ARP表项时，只需要配置IP地址和MAC地址项。如果出接口是三层以太网接口，短静态ARP表项可以直接用于报文转发；如果出接口是VLAN虚接口，短静态ARP表项不能直接用于报文转发，当要发送IP数据包时，先发送ARP请求报文，如果收到的相应报文中的源IP地址和源MAC地址与所配置的IP地址和MAC地址相同，则将接受ARP响应报文的接口加入该静态表项中，之后就可以用于IP数据包的转发了。</p><h3 id=长静态arp表项>长静态ARP表项<a hidden class=anchor aria-hidden=true href=#长静态arp表项>#</a></h3><p>在配置长静态ARP表项时，除了配置IP地址和MAC地址项外，还必须配置该ARP表所对应的VLAN（虚拟局域网）和出接口。也就是长静态ARP表项同事绑定了IP地址、MAC地址、VLAN和端口，可以直接用于报文转发。</p><h3 id=apr欺骗>apr欺骗<a hidden class=anchor aria-hidden=true href=#apr欺骗>#</a></h3><p>ARP病毒，ARP欺骗</p><p>高可用服务器对之间切换时要考虑ARP缓存问题</p><p>路由器等设备无缝迁移时要考虑ARP缓存的问题，例如：更换办公室的路由器.</p><h3 id=arp欺骗原理>ARP欺骗原理<a hidden class=anchor aria-hidden=true href=#arp欺骗原理>#</a></h3><p>ARP攻击就是通过伪造IP地址和MAC地址对实现ARP欺骗的，如果一台主机中了ARP病毒，那么它就能够在网络中产生大量的ARP通信量（它会以很快的频率进行广播），以至于使网络阻塞，攻击者只要持续不断的发出伪造ARP响应包就能更改局域网中目标主机ARP缓存中的IP-MAC条目，造成网络中断或中间人攻击。</p><p>ARP攻击主要是存在于局域网网络中，局域网中若有一个人感染ARP木马，则感染该ARP木马的系统将会试图通过“ARP欺骗”手段截获所在网络内其他计算机的通信故障。</p><p>服务器切换ARP问题</p><p>当网络中一台提供服务的机器宕机后，当在其他运行正常的机器添加宕机的机器的IP时，会因为客户端的ARP table cache的地址解析还是宕机的机器的MAC地址。从而导致，即使在其他运行正常的机器添加宕机的机器的IP，也会发生客户依然无法访问的情况。</p><p>解决方法是：当宕机时，IP地址迁移到其他机器上时，需要通过arping命令来通知所有网络内机器清除其本地的ARP table cache，从而使得客户机访问时重新广播获取MAC地址.</p><p>几乎所有的高可用软件都会考虑这个问题。</p><p>ARP广播而进行新的地址解析。</p><p>linux下具体命令：</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>text</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>arping -I eth0 -c 3 -s 10.0.0.162 10.0.0.253
</span></span><span class=line><span class=cl>arping -U -I eth0 10.0.0.162</span></span></code></pre></td></tr></table></div></div></div></div><h2 id=proxy-arp>proxy arp<a hidden class=anchor aria-hidden=true href=#proxy-arp>#</a></h2><p>代理ARP的原理就是当出现跨网段的ARP请求时，路由器将自己的MAC返回给发送ARP广播请求发送者，实现MAC地址代理（善意的欺骗），最终使得主机能够通信。</p><p>如一个网络中设备D1 (<code>192.168.0.2/24</code>) 与设备D2 (<code>192.168.1.2/24</code>)，D1和D2在相互通信时，D1先发送了ARP广播，请求D2的mac地址，但是由于两个设备处于不同网，也就是说D1的ARP请求会被R1拦截到，然后R1会封装自己的mac地址为目的地址发送一个ARP回应数据报给R1（善意的欺骗），然后R1就会代替D1去访问D2。</p><p>如上述arp抓包图，首先广播收到回复为R1<code>192.168.0.1</code></p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20210119192807856.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20210119192807856.png#center alt=image-20210119192807856 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><p>如果R1关闭了arp的代理功能，那么R1再访问R3的时候，R2并不会把自己的mac地址给R1，那么R1和R3之间就无法通信。默认情况下，思科的设备是开启了arp代理功能，也就是说，R2会作为中间代理实现R1和R3之间跨网段通信。</p><h3 id=实验通过命名空间模拟容器网络的代理arp数据包>实验：通过命名空间模拟容器网络的代理arp数据包<a hidden class=anchor aria-hidden=true href=#实验通过命名空间模拟容器网络的代理arp数据包>#</a></h3><p>实验前所需掌握的知识<strong>接口作用域 interface scope</strong>与<strong>链路本地地址（Link-local address)</strong></p><h4 id=接口作用域>接口作用域<a hidden class=anchor aria-hidden=true href=#接口作用域>#</a></h4><p>路由的接口作用域，这个配置可以解释为路由的范围会影响源数据（源地址）请求的选择。当主机存在多个网络接口和地址时，route scope控制ip数据寻址和广播的范围。</p><ul><li><p>global：如果来自不同的端口（可以理解为网卡等）可以转发。</p></li><li><p>link：仅在此设备有效，即只有来自这个网络接口设备的流量才走这条路由（发送和接收为同一端口）</p></li><li><p>host：本地回环，仅用于在主机内部进行通信。</p></li><li><p>site：ipv6独有。</p><p>reference <a href=http://linux-ip.net/html/tools-ip-address.html target=_blank rel="noopener nofollow noreferrer">http://linux-ip.net/html/tools-ip-address.html</a></p></li></ul><h4 id=链路本地地址>链路本地地址<a hidden class=anchor aria-hidden=true href=#链路本地地址>#</a></h4><p><code>169.254.0.0/16</code> 保留地址块，在<code>169.254.1.0</code> ~ <code>169.254.254.255</code> 中随机选择一个地址进行ARP广播，如果收到回复，表示IP地址已经使用。</p><p>在Kubernetes Calico网络中，当一个数据包的目的地址不是本网络时，会先发起ARP广播，网关设置即<code>169.254.1.1</code>收到会将自己的mac地址返回给发送端，后续的请求由这个veth对进行完成，使用代理arp做了arp欺骗。这样做抑制了arp广播攻击，并且通过代理arp也可以进行跨网络的访问。</p><p><strong>实验目的</strong>：模拟calico网络，使用代理arp欺骗完成网络的跨网段通信</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20210120214626798.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20210120214626798.png#center alt=image-20210120214626798 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><p>在准备的两个主机进行相应的设置</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 添加网络名称空间</span>
</span></span><span class=line><span class=cl>ip netns add net1
</span></span><span class=line><span class=cl><span class=c1># 创建一个虚拟以太网对</span>
</span></span><span class=line><span class=cl>ip link add veth1 <span class=nb>type</span> veth peer name eth1
</span></span><span class=line><span class=cl><span class=c1># 将一端关联至网络名称空间内</span>
</span></span><span class=line><span class=cl>ip link <span class=nb>set</span> eth1 netns net1
</span></span><span class=line><span class=cl><span class=c1># 设置一个IP地址</span>
</span></span><span class=line><span class=cl>ip netns <span class=nb>exec</span> net1 ip addr add 192.168.1.10/24 dev eth1
</span></span><span class=line><span class=cl><span class=c1># 启动这个网卡</span>
</span></span><span class=line><span class=cl>ip netns <span class=nb>exec</span> net1 ip link <span class=nb>set</span> eth1 up
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 添加一个自动寻址IP，作为网关</span>
</span></span><span class=line><span class=cl>ip netns <span class=nb>exec</span> net1 ip route add 169.254.1.1 dev eth1 scope link
</span></span><span class=line><span class=cl><span class=c1># 所有的流量都通过这个网关进行进出</span>
</span></span><span class=line><span class=cl>ip netns <span class=nb>exec</span> net1 ip route add default via 169.254.1.1 dev eth1
</span></span><span class=line><span class=cl>ip netns <span class=nb>exec</span> net1 ip route 
</span></span><span class=line><span class=cl>ip netns <span class=nb>exec</span> net1 ip link <span class=nb>set</span> eth1 up
</span></span><span class=line><span class=cl><span class=c1># 设置主机端的网络对</span>
</span></span><span class=line><span class=cl>ip link <span class=nb>set</span> veth1 up
</span></span><span class=line><span class=cl><span class=c1># 所有通过192.168.1.10的数据包进出都走veth1</span>
</span></span><span class=line><span class=cl>ip route add 192.168.1.10 dev veth1 scope link
</span></span><span class=line><span class=cl><span class=c1># 通往192.168.2.10的数据的下一挑是10.0.0.3（对端主机IP）</span>
</span></span><span class=line><span class=cl>ip route add 192.168.2.10 via 10.0.0.3 dev eth0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## 设置另外一台设备</span>
</span></span><span class=line><span class=cl>ip netns add net1
</span></span><span class=line><span class=cl>ip link add veth1 <span class=nb>type</span> veth peer name eth1
</span></span><span class=line><span class=cl>ip link <span class=nb>set</span> eth1 netns net1
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ip netns <span class=nb>exec</span> net1 ip addr add 192.168.2.10/24 dev eth1
</span></span><span class=line><span class=cl>ip netns <span class=nb>exec</span> net1 ip link <span class=nb>set</span> eth1 up
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ip netns <span class=nb>exec</span> net1 ip route add 169.254.1.1 dev eth1 scope link
</span></span><span class=line><span class=cl>ip netns <span class=nb>exec</span> net1 ip route add default via 169.254.1.1 dev eth1
</span></span><span class=line><span class=cl>ip netns <span class=nb>exec</span> net1 ip route 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ip link <span class=nb>set</span> veth1 up
</span></span><span class=line><span class=cl>ip route add 192.168.2.10 dev veth1 scope link
</span></span><span class=line><span class=cl>ip route add 192.168.1.10 via 10.0.0.4 dev eth0</span></span></code></pre></td></tr></table></div></div></div></div><p>开启对应内核设置</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 代理arp</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=m>1</span> &gt; /proc/sys/net/ipv4/conf/veth1/proxy_arp
</span></span><span class=line><span class=cl><span class=c1># 专用VLAN代理arp。基本上允许代理arp回复到同一接口</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=m>1</span> &gt; /proc/sys/net/ipv4/conf/veth1/proxy_arp_pvlan
</span></span><span class=line><span class=cl><span class=c1># 内核转发</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=m>1</span> &gt; /proc/sys/net/ipv4/ip_forward</span></span></code></pre></td></tr></table></div></div></div></div><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20210120215702370.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20210120215702370.png#center alt=image-20210120215702370 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20210120215729933.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20210120215729933.png#center alt=image-20210120215729933 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><p>reference</p><p><a href=http://linux-ip.net/html/ether-arp-proxy.html target=_blank rel="noopener nofollow noreferrer">linux proxy arp</a></p><p><a href=https://nova.moe/note-on-169-254-ip-addresses/ target=_blank rel="noopener nofollow noreferrer">169.254-ip-address</a></p><p>​</p></div><div class=pe-copyright><hr><blockquote><p>本文为原创内容，版权归作者所有。如需转载，请在文章中声明本文标题及链接。</p><p>文章标题：ARP与ARP Proxy</p><p>文章链接：<a href=https://www.oomkill.com/2021/01/arp-proxy-and-arp/ target=_blank>https://www.oomkill.com/2021/01/arp-proxy-and-arp/</a></p><p>许可协议：<a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></p></blockquote></div><div class=comments-separator></div><h3 class=relatedContentTitle>相关阅读</h3><ul class=relatedContent><li><a href=/2021/01/dynamic-routing-bgp/><span>动态路由- BGP</span></a></li><li><a href=/2021/01/virtual-networking/><span>Linux虚拟网络技术</span></a></li><li><a href=/2021/01/network-tunnel-technology/><span>网络隧道技术</span></a></li><li><a href=/2021/01/static-routing/><span>静态路由</span></a></li><li><a href=/2021/01/dynamic-routing-ospf/><span>动态路由 - OSPF</span></a></li></ul><div class=comments-separator></div><footer class=post-footer><ul class=post-tags><li><a href=https://www.oomkill.com/tags/network/>Network</a></li></ul><nav class=paginav><a class=prev href=https://www.oomkill.com/2021/01/pass-base-dashboard-k8s/><span class=title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left" style="user-select:text"><line x1="19" y1="12" x2="5" y2="12" style="user-select:text"/><polyline points="12 19 5 12 12 5" style="user-select:text"/></polyline></svg>&nbsp;</span>
<span>基于Kubernetes的PaaS平台提供dashboard支持的一种方案</span>
</a><a class=next href=https://www.oomkill.com/2021/01/dynamic-routing-bgp/><span class=title></span>
<span>动态路由- BGP&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right" style="user-select:text"><line x1="5" y1="12" x2="19" y2="12" style="user-select:text"/><polyline points="12 5 19 12 12 19" style="user-select:text"/></svg></span></a></nav></footer><div class=pe-comments-decoration><p class=pe-comments-title></p><p class=pe-comments-subtitle></p></div><div id=pe-comments></div><script src=/js/pe-go-comment.min.86a214102576ba5f9b7bdc29eed8d58dd56e34aef80b3c65c73ea9cc88443696.js integrity="sha256-hqIUECV2ul+be9wp7tjVjdVuNK74Czxlxz6pzIhENpY="></script><script>const getStoredTheme=()=>localStorage.getItem("pref-theme")==="dark"?"dark":"light",setGiscusTheme=()=>{const e=e=>{const t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:e},"https://giscus.app")};e({setConfig:{theme:getStoredTheme()}})};document.addEventListener("DOMContentLoaded",()=>{const s={src:"https://giscus.app/client.js","data-repo":"cylonchau/cylonchau.github.io","data-repo-id":"R_kgDOIRlNSQ","data-category":"Announcements","data-category-id":"DIC_kwDOIRlNSc4CXy1U","data-mapping":"pathname","data-term":"posts/arp proxy and arp","data-strict":"0","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"top","data-theme":getStoredTheme(),"data-lang":"zh-TW","data-loading":"lazy",crossorigin:"anonymous",async:""},e=document.createElement("script");Object.entries(s).forEach(([t,n])=>e.setAttribute(t,n)),document.querySelector("#pe-comments").appendChild(e);const t=document.querySelector("#theme-toggle");t&&t.addEventListener("click",setGiscusTheme);const n=document.querySelector("#theme-toggle-float");n&&n.addEventListener("click",setGiscusTheme)})</script></article></main><footer class=footer><span>&copy; 2024 <a href=https://www.oomkill.com/>Cylon's Collection</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> on
<a href=https://pages.github.com/ rel=noopener target=_blank>GitHub Pages</a> & Theme
        <a href=https://github.com/tofuwine/PaperMod-PE rel=noopener target=_blank>PaperMod-PE</a></span></footer><div class=pe-right-sidebar><a href=javascript:void(0); id=theme-toggle-float class=pe-float-btn><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</a><a href=#top class=pe-float-btn id=top-link><span id=pe-read-progress></span></a></div><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>