<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Linux虚拟网络技术 | Cylon&#39;s Collection</title>
<meta name="keywords" content="linux, network, kubernetes network">
<meta name="description" content="Linux虚拟网络技术 - Cylon&#39;s Collection">
<meta name="author" content="cylon">
<link rel="canonical" href="https://www.oomkill.com/2021/01/virtual-networking/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.df0e7f0648f287aca44f5b657ff5602f436346895340daaa6589b3049a979f73.css" integrity="sha256-3w5/Bkjyh6ykT1tlf/VgL0NjRolTQNqqZYmzBJqXn3M=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://www.oomkill.com/favicon.ico">
<link rel="apple-touch-icon" href="https://www.oomkill.com/apple-touch-icon.png">

<meta name="twitter:title" content="Linux虚拟网络技术 | Cylon&#39;s Collection" />
<meta name="twitter:description" content="" />
<meta property="og:title" content="Linux虚拟网络技术 | Cylon&#39;s Collection" />
<meta property="og:description" content="" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.oomkill.com/2021/01/virtual-networking/" />
<meta property="article:section" content="posts" />
  <meta property="article:published_time" content="2021-01-18T00:00:00&#43;00:00" />
  <meta property="article:modified_time" content="2023-03-22T23:00:36&#43;08:00" />


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Posts",
      "item": "https://www.oomkill.com/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "Linux虚拟网络技术",
      "item": "https://www.oomkill.com/2021/01/virtual-networking/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Linux虚拟网络技术 | Cylon's Collection",
  "name": "Linux虚拟网络技术",
  "description": "",
  "keywords": [
    "linux", "network", "kubernetes network"
  ],
  "wordCount" : "8033",
  "inLanguage": "zh",
  "datePublished": "2021-01-18T00:00:00Z",
  "dateModified": "2023-03-22T23:00:36+08:00",
  "author":{
    "@type": "Person",
    "name": "cylon"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://www.oomkill.com/2021/01/virtual-networking/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Cylon's Collection",
    "logo": {
      "@type": "ImageObject",
      "url": "https://www.oomkill.com/favicon.ico"
    }
  }
}
</script><script type="text/javascript"
        async
        src="https://cdn.bootcss.com/mathjax/2.7.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\[\[','\]\]']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
});

MathJax.Hub.Queue(function() {
    
    
    
    var all = MathJax.Hub.getAllJax(), i;
    for(i = 0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
});
</script>

<style>
code.has-jax {
    font: inherit;
    font-size: 100%;
    background: inherit;
    border: inherit;
    color: #515151;
}
</style>
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary-bg: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list-page {
                background: var(--theme);
            }

            .list-page:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list-page:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>

</head>

<body class=" type-posts kind-page layout-" id="top"><script data-no-instant>
function switchTheme(theme) {
  switch (theme) {
    case 'light':
      document.body.classList.remove('dark');
      break;
    case 'dark':
      document.body.classList.add('dark');
      break;
    
    default:
      if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
      }
  }
}

function isDarkTheme() {
  return document.body.className.includes("dark");
}

function getPrefTheme() {
  return localStorage.getItem("pref-theme");
}

function setPrefTheme(theme) {
  switchTheme(theme)
  localStorage.setItem("pref-theme", theme);
}

const toggleThemeCallbacks = {}
toggleThemeCallbacks['main'] = (isDark) => {
  
  if (isDark) {
    setPrefTheme('light');
  } else {
    setPrefTheme('dark');
  }
}




window.addEventListener('toggle-theme', function() {
  
  const isDark = isDarkTheme()
  for (const key in toggleThemeCallbacks) {
    toggleThemeCallbacks[key](isDark)
  }
});


function toggleThemeListener() {
  
  window.dispatchEvent(new CustomEvent('toggle-theme'));
}

</script>
<script>
  
  (function() {
    const defaultTheme = 'auto';
    const prefTheme = getPrefTheme();
    const theme = prefTheme ? prefTheme : defaultTheme;

    switchTheme(theme);
  })();
</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://www.oomkill.com" accesskey="h" title="Cylon&#39;s Collection (Alt + H)">Cylon&#39;s Collection</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="https://www.oomkill.com/archives/" title="归档"
                >归档
                </a>
            </li>
            <li>
                <a href="https://www.oomkill.com/tags/" title="标签"
                >标签
                </a>
            </li>
            <li>
                <a href="https://www.oomkill.com/search/" title="搜索 (Alt &#43; /)"data-no-instant accesskey=/
                >搜索
                </a>
            </li>
            <li>
                <a href="https://www.oomkill.com/about/" title="关于"
                >关于
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main post">

<article class="post-single">
  <header class="post-header"><h1 class="post-title">Linux虚拟网络技术</h1>
    <div class="post-meta"><span class="meta-item">
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar" style="user-select: text;"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" style="user-select: text;"></rect><line x1="16" y1="2" x2="16" y2="6" style="user-select: text;"></line><line x1="8" y1="2" x2="8" y2="6" style="user-select: text;"></line><line x1="3" y1="10" x2="21" y2="10" style="user-select: text;"></line></svg>
  <span>2021-01-18</span></span><span class="meta-item">
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar" style="user-select: text;"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" style="user-select: text;"></rect><line x1="16" y1="2" x2="16" y2="6" style="user-select: text;"></line><line x1="8" y1="2" x2="8" y2="6" style="user-select: text;"></line><line x1="3" y1="10" x2="21" y2="10" style="user-select: text;"></line></svg>
  <span>Edited on 2023-03-22</span></span><span class="meta-item">
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon" style="user-select: text;"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z" style="user-select: text;"></path><line x1="7" y1="7" x2="7" y2="7" style="user-select: text;"></line></svg>
  <span class="post-tags"><a href="https://www.oomkill.com/tags/network/">network</a><a href="https://www.oomkill.com/tags/kubernetes-network/">kubernetes network</a></span></span><span class="meta-item">
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><circle cx="12" cy="12" r="9"></circle><polyline points="12 7 12 12 15 15"></polyline></svg>
  <span>17 分钟</span></span>

      
      
    </div>
  </header> <div class="toc side right">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">目录</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#overview" aria-label="Overview">Overview</a></li>
                <li>
                    <a href="#vlan" aria-label="VLAN">VLAN</a></li>
                <li>
                    <a href="#veth-supa-href11asup" aria-label="VETH [1]">VETH <sup><a href="#1">[1]</a></sup></a></li>
                <li>
                    <a href="#bridge" aria-label="Bridge">Bridge</a></li>
                <li>
                    <a href="#%e7%9b%ae%e7%9a%84" aria-label="目的">目的</a></li>
                <li>
                    <a href="#macvlan-supa-href22asup" aria-label="MACVLAN [2]">MACVLAN <sup><a href="#2">[2]</a></sup></a><ul>
                        
                <li>
                    <a href="#macvlan%e7%9a%84%e9%99%90%e5%88%b6" aria-label="MACVLAN的限制">MACVLAN的限制</a></li>
                <li>
                    <a href="#macvlan%e7%9a%84%e6%a8%a1%e5%bc%8f" aria-label="MACVLAN的模式">MACVLAN的模式</a><ul>
                        
                <li>
                    <a href="#private-mode" aria-label="Private mode">Private mode</a></li>
                <li>
                    <a href="#vpea-mode" aria-label="VPEA mode">VPEA mode</a></li>
                <li>
                    <a href="#bridge-mode" aria-label="Bridge mode">Bridge mode</a></li>
                <li>
                    <a href="#passthru" aria-label="Passthru">Passthru</a></li>
                <li>
                    <a href="#source" aria-label="Source">Source</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#ipvlan" aria-label="IPVLAN">IPVLAN</a><ul>
                        
                <li>
                    <a href="#ipvlan-modes" aria-label="IPVLAN modes">IPVLAN modes</a><ul>
                        
                <li>
                    <a href="#l2" aria-label="L2">L2</a></li>
                <li>
                    <a href="#l3" aria-label="L3">L3</a></li></ul>
                </li>
                <li>
                    <a href="#ipvlan%e4%b8%8emacvlan%e5%a6%82%e4%bd%95%e9%80%89%e6%8b%a9" aria-label="IPVLAN与MACVLAN如何选择">IPVLAN与MACVLAN如何选择</a></li></ul>
                </li>
                <li>
                    <a href="#vxlan" aria-label="VxLAN">VxLAN</a><ul>
                        
                <li>
                    <a href="#vxlan-introduction" aria-label="VxLAN Introduction">VxLAN Introduction</a><ul>
                        
                <li>
                    <a href="#%e4%b8%ba%e4%bb%80%e4%b9%88%e5%b0%86-vxlan-%e8%a7%86%e4%b8%bal2%e7%bd%91%e7%bb%9c%e5%91%a2" aria-label="为什么将 VxLAN 视为L2网络呢？">为什么将 <em><strong>VxLAN</strong></em> 视为L2网络呢？</a></li>
                <li>
                    <a href="#vni" aria-label="VNI">VNI</a></li>
                <li>
                    <a href="#vept" aria-label="VEPT">VEPT</a></li>
                <li>
                    <a href="#preliminary-knowledge-%e4%b8%89%e5%b1%82%e5%88%86%e7%ba%a7%e7%bd%91%e7%bb%9c-supa-href44asup" aria-label="Preliminary knowledge 三层分级网络 [4]">Preliminary knowledge 三层分级网络 <sup><a href="#4">[4]</a></sup></a><ul>
                        
                <li>
                    <a href="#%e4%b8%89%e5%b1%82%e5%88%86%e7%ba%a7%e7%bd%91%e7%bb%9c" aria-label="三层分级网络?">三层分级网络?</a></li></ul>
                </li>
                <li>
                    <a href="#%e4%b8%ba%e4%bb%80%e4%b9%88%e9%9c%80%e8%a6%81vxlan-supa-href55asup" aria-label="为什么需要VxLAN [5]">为什么需要VxLAN <sup><a href="#5">[5]</a></sup></a></li></ul>
                </li>
                <li>
                    <a href="#vxlan-in-linux" aria-label="VxLAN in Linux">VxLAN in Linux</a><ul>
                        
                <li>
                    <a href="#linux%e5%ae%9e%e7%8e%b0vxlan%e7%bd%91%e7%bb%9c" aria-label="linux实现VxLAN网络">linux实现VxLAN网络</a></li>
                <li>
                    <a href="#%e5%a4%9a%e6%92%ad%e6%a8%a1%e5%bc%8f%e7%9a%84-vxlan" aria-label="多播模式的 vxlan">多播模式的 vxlan</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e5%ae%9e%e9%aa%8c%e4%b8%80linux-bridgel2" aria-label="实验一：Linux Bridge[L2]">实验一：Linux Bridge[L2]</a></li>
                <li>
                    <a href="#%e5%ae%9e%e9%aa%8c%e4%ba%8cipvlan-l2" aria-label="实验二：IPVLAN L2">实验二：IPVLAN L2</a><ul>
                        
                <li>
                    <a href="#%e5%ae%9e%e9%aa%8c%e4%b8%89ipvlan-l3" aria-label="实验三：IPVLAN L3">实验三：IPVLAN L3</a></li>
                <li>
                    <a href="#%e5%ae%9e%e9%aa%8c%e5%9b%9bmacvlan" aria-label="实验四：MACVLAN">实验四：MACVLAN</a></li></ul>
                </li>
                <li>
                    <a href="#reference" aria-label="Reference">Reference</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content">
    





<div class="copyrightTopBlock">
    <p>本文发布于<a href="https://www.oomkill.com/about" target="_blank">Cylon的收藏册</a>，转载请著名原文链接~</p>
    <div class="articleSuffix-bg"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 147.78 155.96"> <path d="M10.5,99.81a1.9,1.9,0,0,0-.53-.09,1.66,1.66,0,0,0-1.64,1.65A1.64,1.64,0,0,0,10,103a1.57,1.57,0,0,0,.87-.25l26.76,26.82.45-1.08L11.52,101.91A1.65,1.65,0,0,0,10.5,99.81Zm-.13,2a.57.57,0,0,1-.8,0,.58.58,0,0,1-.17-.41.58.58,0,0,1,.57-.57h0a.57.57,0,0,1,.56.58A.55.55,0,0,1,10.37,101.77Z" style="fill:#c5c9e0"></path><path d="M56.15,117.58H39.06l0-.09a1.65,1.65,0,0,0-1.36-1H37.5a1.65,1.65,0,1,0,1.56,2.19H55.7L92.92,156h41.44v-1.08h-41Zm-18.25.94a.56.56,0,0,1-.79,0,.58.58,0,0,1-.17-.41.57.57,0,0,1,.56-.57h0a.58.58,0,0,1,.57.58A.54.54,0,0,1,37.9,118.52Z" style="fill:#c5c9e0"></path><path d="M23.52,50.32a1.65,1.65,0,0,0,1.55-1.11H55.28l48-48.13h31.06V0H102.85l-48,48.13H25.07a1.64,1.64,0,0,0-2.09-1,1.64,1.64,0,0,0,.54,3.2Zm0-2.21a.57.57,0,0,1,0,1.13.57.57,0,1,1,0-1.13Z" style="fill:#c5c9e0"></path><polygon points="102.86 0 102.86 0 102.86 0 102.86 0" style="fill:#c5c9e0"></polygon><path d="M107.72,12.14h26.64V11.07H107.27L57.4,61H3.09a1.66,1.66,0,0,0-1.45-.86H1.52A1.65,1.65,0,1,0,2.81,63a1.59,1.59,0,0,0,.45-.87H57.85ZM2.05,62.23a.57.57,0,0,1-.8,0,.58.58,0,0,1-.17-.41.57.57,0,0,1,.56-.57h.09a.57.57,0,0,1,.32,1Z" style="fill:#c5c9e0"></path><path d="M134.36,43.22V42.14h-22.3l-9.62,9.63a1.64,1.64,0,0,0-2.19.77,1.61,1.61,0,0,0-.17.71,1.65,1.65,0,1,0,3.29,0,1.61,1.61,0,0,0-.16-.72l9.3-9.32Zm-32.64,10.6a.57.57,0,0,1,0-1.13.57.57,0,0,1,0,1.13Z" style="fill:#c5c9e0"></path><path d="M147,52.3l-9,9H111.48a1.64,1.64,0,0,0-1.61-1.33h-.14a1.65,1.65,0,1,0,1.6,2.41h27.19l9.26-9.29L147,52.3Zm-37.15,9.85a.56.56,0,0,1-.56-.57h0a.56.56,0,0,1,.56-.56h0a.57.57,0,1,1,0,1.13Z" style="fill:#c5c9e0"></path><path d="M66.79,75.35l11,11.06h56.53V85.33H78.27l-11-11.06H49.49L37.12,86.67a1.64,1.64,0,0,0-2.09,1,1.61,1.61,0,0,0-.09.54,1.65,1.65,0,0,0,3.29,0,1.68,1.68,0,0,0-.26-.89l12-12ZM36.58,88.79a.57.57,0,1,1,.57-.56A.57.57,0,0,1,36.58,88.79Z" style="fill:#c5c9e0"></path><path d="M110.61,95.55,92.8,113.4a1.62,1.62,0,1,0,.77.76l17.49-17.53h23.31V95.55ZM92.49,115.28a.56.56,0,0,1-.8,0,.58.58,0,0,1-.17-.41.57.57,0,0,1,.57-.57h0a.58.58,0,0,1,.56.58A.55.55,0,0,1,92.49,115.28Z" style="fill:#c5c9e0"></path><path d="M97.89,122.3H76.62L64.2,109.85a1.65,1.65,0,0,0-.77-2.2,1.77,1.77,0,0,0-.72-.17h-.14a1.65,1.65,0,0,0,.15,3.29,1.58,1.58,0,0,0,.71-.17l12.74,12.77H98.34l17.48-17.52h18.54v-1.08h-19ZM63.12,109.53a.56.56,0,0,1-.8,0,.58.58,0,0,1-.17-.41.57.57,0,0,1,1.14,0A.54.54,0,0,1,63.12,109.53Z" style="fill:#c5c9e0"></path> </svg> </div>
</div><h2 id="overview">Overview<a hidden class="anchor" aria-hidden="true" href="#overview">¶</a></h2>
<p>本文将介绍Kubernetes中使用的相关虚拟网络功能，目的是为了任何无相关网络背景经历的人都可以了解这些技术在kubernetes中式如何应用的。</p>
<h2 id="vlan">VLAN<a hidden class="anchor" aria-hidden="true" href="#vlan">¶</a></h2>
<p><em><strong>VLAN</strong></em> (Virtual local area networks)是逻辑上的LAN而不受限于同一物理网络交换机上。同样的VLAN也可以将同一台交换机/网桥下的设备/划分为不同的子网。</p>
<p><em><strong>VLAN</strong></em> 区分的广播域的标准是VLAN ID，此功能是Linux内核3.8中引入的</p>
<p>在Linux中创建一个VLAN</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ip link add link eth0 name eth0.2 <span class="nb">type</span> vlan id <span class="m">2</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="veth-supa-href11asup">VETH <sup><a href="#1">[1]</a></sup><a hidden class="anchor" aria-hidden="true" href="#veth-supa-href11asup">¶</a></h2>
<p><em><strong>VETH</strong></em> (Virtual Ethernet device)，是一个本地的以太网隧道，创建出的设备是成对的，通常会存在两个名称空间内，例如在docker中创建出的设备一端在root名称空间内，一端被挂在到容器的名称空间内。</p>
<p>
  <img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/1tOiYnJv7sx0twVBJGX_zgg.png" alt="img"  /></p>
<center>图：veth topology</center>
<center><em>Source：</em>https://medium.com/@arpitkh96/basics-of-container-networking-with-linux-part-1-3a3cdc64c87a</center><br>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ip link add &lt;p1-name&gt; <span class="nb">type</span> veth peer name &lt;p2-name&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="bridge">Bridge<a hidden class="anchor" aria-hidden="true" href="#bridge">¶</a></h2>
<h2 id="目的">目的<a hidden class="anchor" aria-hidden="true" href="#目的">¶</a></h2>
<p>Linux <strong>bridge</strong>（又称为网桥、VLAN交换机）是Linux内核中集成的功能，用来做tcp/ip做二层协议交换的设备，虽然是软件实现的，但它与普通的二层物理交换机功能一样。<em><strong>bridge</strong></em>  就是为了解决虚拟机网卡连接问题。可以添加若干个网络设备到 <em><strong>bridge</strong></em> 上作为其接口，添加到 <em><strong>bridge</strong></em> 上的设备被设置为只接受二层数据帧并且转发所有收到的数据包到 <em><strong>bridge</strong></em> 中。</p>
<p>由于 Linux <em><strong>bridge</strong></em> 是二层设备，故数据包是根据MAC地址而不是IP转发的。因此所有协议都可以透明地通过网桥。Linux <em><strong>bridge</strong></em> 广泛用于虚拟机，名称空间等。</p>
<p>
  <img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/1NZpkyrCpcQMxkUHNsNtFVA.png" alt="img"  /></p>
<center>图：Linux Bridge</center>
<center><em>Source：</em>https://kbespalov.medium.com/linux-linux-bridge-7e0e887edd01</center><br>
<h2 id="macvlan-supa-href22asup">MACVLAN <sup><a href="#2">[2]</a></sup><a hidden class="anchor" aria-hidden="true" href="#macvlan-supa-href22asup">¶</a></h2>
<p><em><strong>MACVLAN</strong></em> 允许在一个物理接口创建多个子接口，并且每个子接口都拥有一个随机生成的MAC地址，与IP地址。</p>
<p><em><strong>MACVLAN</strong></em> 中子接口不能与与父接口直接通讯，例如在虚拟化环境中，容器是不能ping通宿主机的IP，如果子接口需要和父接口进行通讯，需要将子接口分配给父接口。</p>
<p>
  <img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/linux-macvlan.png" alt="Linux macvlan"  /></p>
<center>图：MACVLAN</center>
<center><em>Source：</em>https://hicu.be/bridge-vs-macvlan</center><br>
<p>从 Linux 内核3.0起，MAC已经是linux内核中的一部分。</p>
<ul>
<li>
<p>查看内核是否加载 <code>lsmod | grep macvlan</code></p>
</li>
<li>
<p>加载macvlan模块 <code>modprobe macvlan</code></p>
</li>
<li>
<p>如果需要每次启动时都加载该模块，<code>echo &quot;macvlan&quot; &gt;&gt; /etc/modules</code></p>
</li>
</ul>
<h3 id="macvlan的限制">MACVLAN的限制<a hidden class="anchor" aria-hidden="true" href="#macvlan的限制">¶</a></h3>
<p>限制：</p>
<ul>
<li>使用MACVLAN技术需要开启网卡的混杂模式</li>
<li>授予NIC支持的MAC数量限制，超出限制会影响性能</li>
<li>MACVLAN不能工作在wireless网络环境中 <sup><a href="#3">[3]</a></sup></li>
</ul>
<h3 id="macvlan的模式">MACVLAN的模式<a hidden class="anchor" aria-hidden="true" href="#macvlan的模式">¶</a></h3>
<p>MACVLAN又五种类型：</p>
<ul>
<li>Private</li>
<li>VEPA</li>
<li>Bridge</li>
<li>Passthru</li>
<li>Source</li>
</ul>
<h4 id="private-mode">Private mode<a hidden class="anchor" aria-hidden="true" href="#private-mode">¶</a></h4>
<p>Private模式下的同一物理接口下的子接口将不允许通讯，即使物理设备支持hairpin也不行。</p>
<p>
  <img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/linux-macvlan-private-mode.png" alt="Macvlan 私有模式"  /></p>
<center>图：MACVLAN Private mod</center>
<center><em>Source：</em>https://hicu.be/bridge-vs-macvlan</center><br>
<blockquote>
<p><em><strong>hairpin</strong></em> 有多个名称，<em><strong>U-turn NAT</strong></em>, <em><strong>NAT loopback</strong></em>，实际上就是一种网络转换，在一个网络中的两个设备使用外部IP进行通讯。在MACVLAN这个例子中，veth1发往veth2的流量通过外部设备switch进行一个回转，这个行为称为为 <em><strong>hairpin turn</strong></em>。从上图也可以看出，是一个U形的转换。</p>
</blockquote>
<h4 id="vpea-mode">VPEA mode<a hidden class="anchor" aria-hidden="true" href="#vpea-mode">¶</a></h4>
<p><em><strong>VPEA</strong></em> 将会将来自子接口的通过父接口转发，这将要求物理交换机需要支持 <em><strong>hairpin</strong></em></p>
<p>
  <img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/linux-macvlan-802.1qbg-vepa-mode.png" alt="Macvlan 802.1qbg VEPA 模式"  /></p>
<center>图：MACVLAN VPEA mode</center>
<center><em>Source：</em>https://hicu.be/bridge-vs-macvlan</center><br>
<h4 id="bridge-mode">Bridge mode<a hidden class="anchor" aria-hidden="true" href="#bridge-mode">¶</a></h4>
<p><em><strong>Bridge</strong></em> 是指父接口与所有子接口是通过网桥相连的，因为连接在网桥上，不需要学习MAC地址。这也是容器网络中常用到的模式</p>
<p>
  <img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/linux-macvlan-bridge-mode.png" alt="Macvlan 桥接模式"  /></p>
<center>图：MACVLAN bridge mode</center>
<center><em>Source：</em>https://hicu.be/bridge-vs-macvlan</center><br>
<h4 id="passthru">Passthru<a hidden class="anchor" aria-hidden="true" href="#passthru">¶</a></h4>
<p><em><strong>passthru</strong></em> 是 pass through，由名字也可以得知，是指允许单个VM与物理接口连接。</p>
<p>
  <img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/linux-macvlan-passthru-mode.png" alt="Macvlan 直通模式"  /></p>
<center>图：MACVLAN passthru mode</center>
<center><em>Source：</em>https://hicu.be/bridge-vs-macvlan</center><br>
<h4 id="source">Source<a hidden class="anchor" aria-hidden="true" href="#source">¶</a></h4>
<p>这个模式是Linux中的一个 Patch，是流量仅允许被允许的MAC地址列表</p>
<h2 id="ipvlan">IPVLAN<a hidden class="anchor" aria-hidden="true" href="#ipvlan">¶</a></h2>
<p>IPVLAN与MACVLAN类似，只有一个不同的地方是，IPVLAN所有的MAC地址都是一样的，就是使用相同的MAC地址去创建子接口。</p>
<p>
  <img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/linux-ipvlan.png" alt="Linux Ipvlan"  /></p>
<center>图：IPVLAN</center>
<center><em>Source：</em>https://hicu.be/bridge-vs-macvlan</center><br>
<h3 id="ipvlan-modes">IPVLAN modes<a hidden class="anchor" aria-hidden="true" href="#ipvlan-modes">¶</a></h3>
<p>在使用IPVLAN时，只能选择下面两种模式中的一种，选择后，所有的子节接口将工作在这个模式下。</p>
<h4 id="l2">L2<a hidden class="anchor" aria-hidden="true" href="#l2">¶</a></h4>
<p><em><strong>IPVLAN</strong></em> L2模式与 <em><strong>MACVLAN</strong></em> 的 <em><strong>brigde</strong></em> 模式工作原理很相似，父接口是作为交换机的角色，同一个物理接口上的子接口可以通过父接口来转发数据，而如果要发送数据到其他的网络，报文则会通过父接口的路由转发出去。</p>
<p>
  <img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/linux-ipvlan-l2-mode.png" alt="Linux Ipvlan - L2 模式"  /></p>
<center>图：IPVLAN L2</center>
<center><em>Source：</em>https://hicu.be/bridge-vs-macvlan</center><br>
<blockquote>
<p>Notes: IPVLAN 是 linux kernel 比较新的特性，linux kernel 3.19 开始支持 ipvlan，但是比较稳定推荐的版本是 &gt;=4.2</p>
</blockquote>
<h4 id="l3">L3<a hidden class="anchor" aria-hidden="true" href="#l3">¶</a></h4>
<p>在 <em><strong>L3</strong></em> 模式下也就是 物理接口 是作为路由器，这种情况下就要求子接口之间需要处在不同子网中才可以。因为广播域是 <em><strong>L2</strong></em> 的，所以 <em><strong>IPVLAN L3</strong></em> 不支持多播和广播。</p>
<p>
  <img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/linux-ipvlan-l3-mode-1.png" alt="Linux Ipvlan - L3 模式"  /></p>
<center>图：IPVLAN L3</center>
<center><em>Source：</em>https://hicu.be/bridge-vs-macvlan</center><br>
<h3 id="ipvlan与macvlan如何选择">IPVLAN与MACVLAN如何选择<a hidden class="anchor" aria-hidden="true" href="#ipvlan与macvlan如何选择">¶</a></h3>
<ul>
<li>在于<em><strong>MACVLAN</strong></em>在wireless环境中的不友好，wireless选择 <em><strong>IPVLAN</strong></em></li>
<li>对于外部设备有MAC地址限制的，或者混杂模式限制NIC性能</li>
</ul>
<h2 id="vxlan">VxLAN<a hidden class="anchor" aria-hidden="true" href="#vxlan">¶</a></h2>
<h3 id="vxlan-introduction">VxLAN Introduction<a hidden class="anchor" aria-hidden="true" href="#vxlan-introduction">¶</a></h3>
<p><em><strong>VxLAN</strong></em> (Virtual eXtensible Local Area Network) 是一种 <code>MAC-over-IP</code> 或者称为 UDP隧道机制，本质上来说是使用网络隧道技术将L3网络扩展为一个L2网络。</p>
<h4 id="为什么将-vxlan-视为l2网络呢">为什么将 <em><strong>VxLAN</strong></em> 视为L2网络呢？<a hidden class="anchor" aria-hidden="true" href="#为什么将-vxlan-视为l2网络呢">¶</a></h4>
<p>虽说 <em><strong>VxLAN</strong></em> 是将L2的以太网帧封装到UDP报文中（L2 over L4）中，并在L3网络中传输。但是 <em><strong>VxLAN</strong></em> 最终是基于 <em><strong>MAC</strong></em> 地址的二层网络（可以无需路由设备），而不像 <em><strong>IPIP</strong></em> 的隧道技术网络通讯是基于路由的。</p>
<p>下图是一个使用 <em><strong>VxLAN</strong></em> 技术的网络拓扑，整个篮筐部分可以视为一个二层的虚拟交换机，连接的各设备都可以直连。</p>
<p>
  <img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/download-16615328145948.png" alt="img"  /></p>
<center>图：VXLAN tunneling technology</center>
<center><em>Source：</em>https://support.huawei.com/enterprise/en/doc/EDOC1100086966</center><br>
<h4 id="vni">VNI<a hidden class="anchor" aria-hidden="true" href="#vni">¶</a></h4>
<p><em><strong>VNI</strong></em> (VXLAN Network Identifier) 是类似于VLAN ID的标识符，不同的<em><strong>VNI</strong></em> 之间不能进行二层通讯</p>
<h4 id="vept">VEPT<a hidden class="anchor" aria-hidden="true" href="#vept">¶</a></h4>
<p><em><strong>VTEP</strong></em> (VxLAN tunnel endpoint) 是指数据包封包与解包的实体，<em><strong>VTEP</strong></em> 既可以是一台独立的网络设备，也可以是一个基于软件的虚拟交换机。当源服务器发出包时，会在 <em><strong>VTEP</strong></em> 上封装成 <em><strong>VxLAN</strong></em> 格式的报文；当传送到对端时，会在对端的 <em><strong>VTEP</strong></em> 进行解包</p>
<p>下图是一个VxLAN网络拓扑图，其中建立隧道的两端就是 <em><strong>VTEP</strong></em>，这里的 <em><strong>VTEP</strong></em> 是两台 TOR 交换机，通过两个 <em><strong>VTEP</strong></em> 来对数据包的解封装。</p>
<p>
  <img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/download-16615321616635.png" alt="img"  /></p>
<center>图：VXLAN network model</center>
<center><em>Source：</em>https://support.huawei.com/enterprise/en/doc/EDOC1100086966</center><br>
<p>下图是Linux <em><strong>VxLAN</strong></em> 类型的网络拓扑，<em><strong>VTEP</strong></em> 可以理解为是一种网络接口，通过该接口与内核功能进行解封包，而实际的流量也是通过物理设备进行传输。</p>
<p>
  <img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/vxlan%20in%20linux.png" alt="vxlan in linux"  /></p>
<center>图：VxLAN in Linux</center>
<h4 id="preliminary-knowledge-三层分级网络-supa-href44asup">Preliminary knowledge 三层分级网络 <sup><a href="#4">[4]</a></sup><a hidden class="anchor" aria-hidden="true" href="#preliminary-knowledge-三层分级网络-supa-href44asup">¶</a></h4>
<h5 id="三层分级网络">三层分级网络?<a hidden class="anchor" aria-hidden="true" href="#三层分级网络">¶</a></h5>
<p>思科的三层分级网络(<em><strong>three-layer hierarchical model</strong></em>) 包含三层：</p>
<ul>
<li>核心层 (<em><strong>Core</strong></em>)：网络骨干，提供不同分布层之间的高速连接和最优传送路径</li>
<li>分布层 (<em><strong>distribution</strong></em>) 将连接接入层到核心层，并且实施安全，流量负载和路由相关的策略</li>
<li>接入层 (<em><strong>access</strong></em>) 为用户终端初始网络的接入点。</li>
</ul>
<p>
  <img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/distribution-layer-diagram-1621937301-ES7wiU19cL.jpg" alt="img"  /></p>
<center>图：three-layer hierarchical model</center>
<center><em>Source：</em>https://community.fs.com/blog/how-to-choose-the-right-distribution-switch.html</center><br>
<h4 id="为什么需要vxlan-supa-href55asup">为什么需要VxLAN <sup><a href="#5">[5]</a></sup><a hidden class="anchor" aria-hidden="true" href="#为什么需要vxlan-supa-href55asup">¶</a></h4>
<p>下图是一个 <em><strong>CSP</strong></em> (Cloud Service Provider ) 的 <em><strong>DC</strong></em> 网络，</p>
<ul>
<li>接入层：48口交换机20个</li>
<li>分布层：两台分布式交换机，共同组成一个虚拟化交换机。默认网关位于分布式交换机中。</li>
<li>核心层：两个核心交换机</li>
</ul>
<blockquote>
<p>Notes：工作在分布层的交换机被称为分布式交换机 (<em><strong>Distribution Switch</strong></em>)，分布式交换机会将来自访问层的流量转发至核心层，并提供一些连接策略。</p>
</blockquote>
<p>每台接入交换机连接48台物理服务器。这些服务器中的每一个都包含五个不同的租户，它们拥有自己的虚拟路由 (VRF)。一个租户由三个广播域组成：<code>Presiontation</code>， <code>Application</code> 和 <code>Database</code> ，每层都是互备的。在管理租户时，可以定义 <em><strong>VLAN ID</strong></em>、虚拟机的 <em><strong>MAC</strong></em> 地址和 <em><strong>IP</strong></em> 地址。虚拟机时可移动的，存在如下信息：</p>
<p>
  <img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/Figure1-1_Topology.jpeg" alt="img"  /></p>
<center>图：CSP DC network</center>
<center><em>Source：</em>https://nwktimes.blogspot.com/2018/02/vxlan-part-i-why-vxlan-is-needed.html</center><br>
<p>通过上述信息可以得知有如下：</p>
<ul>
<li>服务器：$20\times48=960$, 20为ToR交换机数量，48为每个ToR的接口</li>
<li>虚拟机/MAC地址/ARP：28800个虚拟机（每个物理机30个虚拟机）</li>
<li>广播域：每个租户+每个租户的VLAN+所拥有的物理机，$5\times3\times960=14400$</li>
<li>VRF：4800，5个租户+960个虚拟机</li>
</ul>
<p>在这种网络中存在的挑战如下：</p>
<ul>
<li><strong>VLAN ID的限制</strong>，通常来说VLAN ID只有12位，4096个，这意味着不够用</li>
<li><strong>多租户</strong>，多租户场景下，广播域等都是用户自己定义的，此时可能发生客户定义的ID为相同的</li>
<li><strong>MAC表大小限制</strong>，在一个租户下有28800个机器，意味着交换机MAC地址表存放28800个MAC地址。会出现老化过程。（Notes：<em>Cisco Nexus 9500/9300</em> 系列支持90000个MAC地址表）</li>
<li><strong>APR表大小限制</strong>，分布式交换机中存在超过28800条MAC-IP的数量（ Notes：<em>Cisco Nexus 9500</em>系列交换机支持 60,000 个 IPv4 ARP 和 30,000 个 IPv6 ND）</li>
<li><strong>生成树协议</strong>，在这种网络拓扑结构下，由于 STP 不支持链路之间的负载均衡，因此某些链路可能不会用于流量传输，这种情况下使带宽利用率下降。</li>
</ul>
<p>由于 <em><strong>VxLAN</strong></em> 通过L3建立隧道，因此不需要生成树协议。在基于 <em><strong>VxLAN</strong></em> 技术的 DC 中，VLAN将不再具有意义，因为 VLAN 是交换机甚至交换机端口特定的。</p>
<p>在基于 <em><strong>VxLAN</strong></em>  <em><strong>Leaf-Spine</strong></em> 的网络架构中，通过将网络压缩为一个L2的网络架构，所有的节点在访问其他节点时，都将仅需要两部，因此除了Leaf交换机之外，其余并不清楚虚拟机的MAC地址。</p>
<p>下图是<em><strong>Leaf-Spine</strong></em>网络拓扑图， 在该架构中，每个较低级别的接入（leaf）交换机都以全网状连接到每个较高级别的核心（spine）交换机。</p>
<p>
  <img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/Tripp_Lite_3.2.width-880.png" alt="Tripp 精简版 3.2.png"  /></p>
<center>图：spine-leaf network</center>
<center><em>Source：</em>https://www.datacenterdynamics.com/en/marketwatch/spine-and-leaf-network-architecture-explained/</center><br>
<h3 id="vxlan-in-linux">VxLAN in Linux<a hidden class="anchor" aria-hidden="true" href="#vxlan-in-linux">¶</a></h3>
<p>Linux 对 VxLAN 协议的支持时间并不久，2012 年 Stephen Hemminger 才把相关的工作合并到 kernel 中，并最终出现在 kernel 3.7.0 版本。为了稳定性和很多的功能，你可以会看到某些软件推荐在 3.9.0 或者 3.10.0 以后版本的 kernel 上使用 vxlan。</p>
<h4 id="linux实现vxlan网络">linux实现VxLAN网络<a hidden class="anchor" aria-hidden="true" href="#linux实现vxlan网络">¶</a></h4>
<p>两台机器构成一个VxLAN网络，每台机器上有一个 VTEP，VTEP 通过它们的 IP 互相通信。</p>
<p>
  <img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/vxlan%20in%20linux.png" alt="vxlan in linux"  /></p>
<center>图：VxLAN in Linux</center>
<p>这个图创建的VxLAN0设备模拟了VTEP隧道端点，实现了一个大二层域，突破了虚拟化网络的物理界限。</p>
<p>node01</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ip link add vxlan1 <span class="nb">type</span> vxlan id <span class="m">1</span> remote 10.0.0.3 dstport <span class="m">4789</span> dev ens33
</span></span><span class="line"><span class="cl">ip link <span class="nb">set</span> vxlan1 up
</span></span><span class="line"><span class="cl">ip addr add 192.168.100.1/24 dev vxlan1
</span></span></code></pre></td></tr></table>
</div>
</div><p>node02</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">ip link add vxlan1 type vxlan id 1 remote 10.0.0.14 dstport 4789 dev eth0
</span></span><span class="line"><span class="cl">ip link set vxlan1 up
</span></span><span class="line"><span class="cl">ip addr add 192.168.100.2/24 dev vxlan1
</span></span></code></pre></td></tr></table>
</div>
</div><p>上述命令创建了一个类型为vxlan，名为vxlan1的网络接口，期后面的为配置这个网络设备的内容：</p>
<ul>
<li><code>id 1</code>  类似CE设备的<code>vxlan vni 10</code> 设置的桥接域，只有相同的VNI之间可以直接进行二层通信。</li>
<li><code>dstport</code> VTEP 通信的端口，这里会监听一个udp端口</li>
<li><code>remote 10.0.0.3</code> 类似<code>vni 10 head-end peer-list 2.2.2.2</code> 用来设置隧道对端的 VTEP 地址，因为这里使用的为单播模式。</li>
<li><code>local 10.0.0.4</code> 与 <code>dev eth0</code> 类似于 <code>source 1.1.1.1</code> 配置源VTEP的IP地址。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ tcpdump -np -i vxlan1 -vv
</span></span><span class="line"><span class="cl">tcpdump: listening on vxlan1, link-type EN10MB <span class="o">(</span>Ethernet<span class="o">)</span>, snapshot length <span class="m">262144</span> bytes
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">05:07:20.589942 ARP, Ethernet <span class="o">(</span>len 6<span class="o">)</span>, IPv4 <span class="o">(</span>len 4<span class="o">)</span>, Request who-has 192.168.100.1 tell 192.168.100.2, length <span class="m">28</span>
</span></span><span class="line"><span class="cl">05:07:20.589963 ARP, Ethernet <span class="o">(</span>len 6<span class="o">)</span>, IPv4 <span class="o">(</span>len 4<span class="o">)</span>, Reply 192.168.100.1 is-at ca:21:c6:01:f9:d5, length <span class="m">28</span>
</span></span><span class="line"><span class="cl">05:07:20.590509 IP <span class="o">(</span>tos 0x0, ttl 64, id 26921, offset 0, flags <span class="o">[</span>DF<span class="o">]</span>, proto ICMP <span class="o">(</span>1<span class="o">)</span>, length 84<span class="o">)</span>
</span></span><span class="line"><span class="cl">    192.168.100.2 &gt; 192.168.100.1: ICMP <span class="nb">echo</span> request, id 1225, seq 1, length <span class="m">64</span>
</span></span><span class="line"><span class="cl">05:07:20.590525 IP <span class="o">(</span>tos 0x0, ttl 64, id 1264, offset 0, flags <span class="o">[</span>none<span class="o">]</span>, proto ICMP <span class="o">(</span>1<span class="o">)</span>, length 84<span class="o">)</span>
</span></span><span class="line"><span class="cl">    192.168.100.1 &gt; 192.168.100.2: ICMP <span class="nb">echo</span> reply, id 1225, seq 1, length <span class="m">64</span>
</span></span><span class="line"><span class="cl">05:07:21.593791 IP <span class="o">(</span>tos 0x0, ttl 64, id 27468, offset 0, flags <span class="o">[</span>DF<span class="o">]</span>, proto ICMP <span class="o">(</span>1<span class="o">)</span>, length 84<span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>抓包查看对应的数据包  [vxlan_linux.cap](......\images\vxlan in linux\vxlan_linux.cap)</p>
<p>
  <img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20210203232317906.png" alt="image-20210203232317906"  /></p>
<p>清理数据</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">ip link set vxlan1 down
</span></span><span class="line"><span class="cl">ip link delete vxlan1
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="多播模式的-vxlan">多播模式的 vxlan<a hidden class="anchor" aria-hidden="true" href="#多播模式的-vxlan">¶</a></h4>
<p>“多播”即“多点传送”(multicast)，也就是一台主机发出的包可以同时被其他多个有资格的主机接收，这台主机和那些有资格的主机就形成了一个组，他们在组内的通信是广播式的。多播的工作原理是，将一个网络上的某些主机的网卡设置成多播传送工作模式，指定其不过滤以某一个多播传送地址作为目的物理地址的数据帧，这样，这些主机的驱动程序中就可以同时接收以该多播传送地址作为目的物理地址的数据帧，而其他主机的驱动程序却接收不到，这些主机在逻辑上便形成了一个“多播”组。采用这种技术，相对广播而言，可有效减轻网络上“多播”组之外的其他主机的负担，因为发送给“多播”组的数据不会被传送到它们的驱动程序中去处理，避免资源的无谓浪费。</p>
<p>多播的IP范围为：从224.0.0.0到239.255.255.255。能够接收发往一个特定多播组地址数据的主机集合称为主机组 (host group)。一个主机组可跨越多个网络。主机组中成员可随时加入或离开主机组。主机组中对主机的数量没有限制，同时不属于某一主机组的主机可以向该组发送信息。</p>
<p><code>239.1.1.1</code> IIANA保留地址用于多播（多点传送）的IP，其mac地址为 <code>01:00:5e:01:01:01</code>(参考：<a href="https://blog.51cto.com/361531/891466">组播地址</a>)</p>
<p>要组成同一个 vxlan 网络，vtep 必须能感知到彼此的存在。多播组本来的功能就是把网络中的某些节点组成一个虚拟的组。</p>
<p>实验使用的为多播组组成一个虚拟的整体，通过多播组，组成可容纳多个主机组成 vxlan 网络</p>
<p>
  <img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20210203232408799.png" alt="image-20210203232408799"  /></p>
<center>图：muticast VxLAN in Linux</center>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ip link add vxlan2 <span class="nb">type</span> vxlan id <span class="m">10</span> group 239.1.1.1 dstport <span class="m">4789</span> dev eth0
</span></span><span class="line"><span class="cl">ip link <span class="nb">set</span> vxlan2 up
</span></span><span class="line"><span class="cl">ip addr add 192.168.100.10/24 dev vxlan2
</span></span></code></pre></td></tr></table>
</div>
</div><p>node01</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ip link add vxlan2 <span class="nb">type</span> vxlan id <span class="m">10</span> group 239.1.1.1 dstport <span class="m">4789</span> dev eth0
</span></span><span class="line"><span class="cl">ip link <span class="nb">set</span> vxlan2 up
</span></span><span class="line"><span class="cl">ip addr add 192.168.100.20/24 dev vxlan2
</span></span></code></pre></td></tr></table>
</div>
</div><p><em><strong>FDB</strong></em> 是 Linux 网桥维护的一个二层转发表，用于保存远端虚拟机/容器的 MAC地址，远端 VTEP IP，以及 VNI 的映射关系，可以通过 <code>bridge fdb</code> 命令来对 <code>FDB</code> 表进行操作：</p>
<p>vxlan接口在创建后，fdb只有一个表项，就是所有<code>vxlan2</code>的流量都发往多播组</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ bridge fdb
</span></span><span class="line"><span class="cl">33:33:00:00:00:01 dev eth0 self permanent
</span></span><span class="line"><span class="cl">01:00:5e:00:00:01 dev eth0 self permanent
</span></span><span class="line"><span class="cl">01:00:5e:01:01:01 dev eth0 self permanent
</span></span><span class="line"><span class="cl">00:00:00:00:00:00 dev vxlan2 dst 239.1.1.1 via eth0 self permanent
</span></span></code></pre></td></tr></table>
</div>
</div><p>组播路由方式过程</p>
<ol>
<li>当发送<code>ping 192.168.100.10</code>时在同一个局域网内会先发送ARP广播，为组播方式，node1与node2（10.0.0.4）均受到广播，而node3（10.0.0.6）未受到</li>
<li>ARP报文要获得的内容为vxlan的mac地址，目的地址为全1的广播地址</li>
<li>vxlan隧道封装VNI=10，因为不知道目的地址，所以会发送多播报文</li>
<li>受到报文后进行解包，取出真实的报文，如果发现是自己的，经由隧道封装后传递</li>
<li>vtep 通过源报文学习到了 vtep 所在的主机，因此会直接单播发送给目的 vtep。发送方主机根据 VNI 把报文转发给 vtep，vtep 解包取出 ARP 应答报文，添加 arp 缓存到内核。并根据报文学习到目的 vtep 所在的主机地址，添加到 fdb 表中</li>
</ol>
<p>
  <img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20210204010726897.png" alt="image-20210204010726897"  /></p>
<p>而没在多播组中的同网段主机没有受到对应的ARP广播</p>
<p>而在加入多播组中会受到多播的信息，确定不是自己后没有reply</p>
<p>
  <img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20210204010149338.png" alt="image-20210204010149338"  /></p>
<p>此实验的报文内容</p>
<p>[192.168.10.30 加入同多播组](......\images\vxlan in linux\10.30.cap)</p>
<p>[192.168.10.20 发起端](......\images\vxlan in linux\10.20.cap)</p>
<p>[192.168.10.30 不在多播组内的报文](......\images\vxlan in linux\10.30 exit multicast.cap)</p>
<p>清除配置</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ip link <span class="nb">set</span> vxlan2 down
</span></span><span class="line"><span class="cl">ip link delete vxlan2 
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="实验一linux-bridgel2">实验一：Linux Bridge[L2]<a hidden class="anchor" aria-hidden="true" href="#实验一linux-bridgel2">¶</a></h2>
<p>该实验包含 <em><strong>veth</strong></em>, <em><strong>vlan</strong></em>, <em><strong>Linux bridge</strong></em> 方面的</p>
<p>
  <img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20210201195306279-166133333718927.png" alt="image-20210201195306279"  /></p>
<center>图：L2 vn topology</center><br>
<p>加载vlan模块</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">modprobe 8021q
</span></span><span class="line"><span class="cl"><span class="c1">## 查看核心是否提供VLAN 功能</span>
</span></span><span class="line"><span class="cl">dmesg <span class="p">|</span> grep -i <span class="m">802</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>    1.592802<span class="o">]</span> pci 0000:00:15.0: PME# supported from D0 D3hot D3cold
</span></span><span class="line"><span class="cl"><span class="o">[</span> 1755.995461<span class="o">]</span> 8021q: 802.1Q VLAN Support v1.8
</span></span><span class="line"><span class="cl"><span class="o">[</span> 1755.995485<span class="o">]</span> 8021q: adding VLAN <span class="m">0</span> to HW filter on device eth0
</span></span></code></pre></td></tr></table>
</div>
</div><p>安装命令</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">yum install vconfig -y
</span></span><span class="line"><span class="cl">apt install vlan
</span></span></code></pre></td></tr></table>
</div>
</div><p>创建vlan</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 创建bridge</span>
</span></span><span class="line"><span class="cl">brctl addbr vlan10
</span></span><span class="line"><span class="cl">brctl show
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">ip link add veth01 <span class="nb">type</span> veth peer name eth01
</span></span><span class="line"><span class="cl">ip link add veth02 <span class="nb">type</span> veth peer name eth02
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 将veth对的一端加入网桥</span>
</span></span><span class="line"><span class="cl">brctl addif vlan10 veth01
</span></span><span class="line"><span class="cl">brctl addif vlan10 veth02
</span></span><span class="line"><span class="cl"><span class="c1"># 启动对应设备</span>
</span></span><span class="line"><span class="cl">ip link <span class="nb">set</span> dev vlan10 up
</span></span><span class="line"><span class="cl">ip link <span class="nb">set</span> dev veth01 up
</span></span><span class="line"><span class="cl">ip link <span class="nb">set</span> dev veth02 up
</span></span><span class="line"><span class="cl">ip link <span class="nb">set</span> dev eth01 up
</span></span><span class="line"><span class="cl">ip link <span class="nb">set</span> dev eth02 up
</span></span><span class="line"><span class="cl"><span class="c1"># 创建ns</span>
</span></span><span class="line"><span class="cl">ip netns add net1
</span></span><span class="line"><span class="cl">ip netns add net2
</span></span><span class="line"><span class="cl"><span class="c1"># 将veth关联到对应名称空间内</span>
</span></span><span class="line"><span class="cl">ip link <span class="nb">set</span> eth01 netns net1
</span></span><span class="line"><span class="cl">ip link <span class="nb">set</span> eth02 netns net2
</span></span></code></pre></td></tr></table>
</div>
</div><p>网络名称空间net1内的操作，在vlan一端添加接口，与关联到该名称空间内的 <em>veth</em> 关联</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">vconfig add eth01 3001
</span></span><span class="line"><span class="cl">vconfig add eth01 3002
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ip link set eth01 up
</span></span><span class="line"><span class="cl">ip link set eth01.3001 up
</span></span><span class="line"><span class="cl">ip link set eth01.3002 up
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ip addr add 192.168.100.1/24 dev eth01.3001
</span></span><span class="line"><span class="cl">ip addr add 192.168.100.2/24 dev eth01.3002
</span></span></code></pre></td></tr></table>
</div>
</div><p>网络名称空间net2与net1的类似</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">vconfig add eth02 3001
</span></span><span class="line"><span class="cl">vconfig add eth02 3002
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ip link set dev eth02 up
</span></span><span class="line"><span class="cl">ip link set dev eth02.3001 up
</span></span><span class="line"><span class="cl">ip link set dev eth02.3002 up
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ip addr add 192.168.100.10/24 dev eth02.3001
</span></span><span class="line"><span class="cl">ip addr add 192.168.100.11/24 dev eth02.3002
</span></span></code></pre></td></tr></table>
</div>
</div><p>验证连通性，可以看到发送的包带有tag的标签</p>
<p>
  <img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20210201211400463-166133333718928.png" alt="image-20210201211400463"  /></p>
<h2 id="实验二ipvlan-l2">实验二：IPVLAN L2<a hidden class="anchor" aria-hidden="true" href="#实验二ipvlan-l2">¶</a></h2>
<p>实验结果，通过namespace模拟Pod的网络，做到各Pod间的网络通讯。</p>
<p><code>ip netns list</code> 查看网络命名空间</p>
<p><code>ip netns add net2</code> 创建一个网络命名空间</p>
<p><code>ip link add &lt;name&gt; link eth0 type ipvlan mode l2</code> 在当前名称空间创建一个类型为IPVLAN L2模式的接口，将该接口关联至父接口eth0上。</p>
<p><code>ip link set $name netns $nsName</code> 将接口加入到对应网络名称空间内</p>
<p><code>ip netns exec $nsName $cmd</code>  在对应的网络名称空间内运行命令</p>
<p>创建两个网络名称空间</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ ip netns add net1
</span></span><span class="line"><span class="cl">$ ip netns add net2
</span></span><span class="line"><span class="cl">$ ip netns list
</span></span><span class="line"><span class="cl">net2
</span></span><span class="line"><span class="cl">net1
</span></span></code></pre></td></tr></table>
</div>
</div><p>创建 IPVLAN 接口</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ ip link add ipvlan01 link eth0 <span class="nb">type</span> ipvlan mode l2
</span></span><span class="line"><span class="cl">$ ip link add ipvlan02 link eth0 <span class="nb">type</span> ipvlan mode l2
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ ip link <span class="nb">set</span> ipvlan01 netns net1
</span></span><span class="line"><span class="cl">$ ip link <span class="nb">set</span> ipvlan02 netns net2
</span></span></code></pre></td></tr></table>
</div>
</div><p>给对应接口添加IP地址</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ip netns <span class="nb">exec</span> net1 ifconfig ipvlan01 192.168.0.1/24 up
</span></span><span class="line"><span class="cl">ip netns <span class="nb">exec</span> net2 ifconfig ipvlan02 192.168.0.2/24 up
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 这两个名称空间内的mac地址是一样的</span>
</span></span><span class="line"><span class="cl">$ ip netns <span class="nb">exec</span> net2 ifconfig
</span></span><span class="line"><span class="cl">ipvlan02: <span class="nv">flags</span><span class="o">=</span>4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu <span class="m">1500</span>
</span></span><span class="line"><span class="cl">        inet 192.168.0.2  netmask 255.255.255.0  broadcast 192.168.0.255
</span></span><span class="line"><span class="cl">        inet6 fe80::da78:c800:27a:fb26  prefixlen <span class="m">64</span>  scopeid 0x20&lt;link&gt;
</span></span><span class="line"><span class="cl">        ether da:78:c8:7a:fb:26  txqueuelen <span class="m">1000</span>  <span class="o">(</span>Ethernet<span class="o">)</span>
</span></span><span class="line"><span class="cl">        RX packets <span class="m">39007</span>  bytes <span class="m">2394577</span> <span class="o">(</span>2.2 MiB<span class="o">)</span>
</span></span><span class="line"><span class="cl">        RX errors <span class="m">0</span>  dropped <span class="m">27</span>  overruns <span class="m">0</span>  frame <span class="m">0</span>
</span></span><span class="line"><span class="cl">        TX packets <span class="m">11</span>  bytes <span class="m">866</span> <span class="o">(</span>866.0 B<span class="o">)</span>
</span></span><span class="line"><span class="cl">        TX errors <span class="m">0</span>  dropped <span class="m">0</span> overruns <span class="m">0</span>  carrier <span class="m">0</span>  collisions <span class="m">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ ip netns <span class="nb">exec</span> net1 ifconfig
</span></span><span class="line"><span class="cl">ipvlan01: <span class="nv">flags</span><span class="o">=</span>4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu <span class="m">1500</span>
</span></span><span class="line"><span class="cl">        inet 192.168.0.1  netmask 255.255.255.0  broadcast 192.168.0.255
</span></span><span class="line"><span class="cl">        inet6 fe80::da78:c800:17a:fb26  prefixlen <span class="m">64</span>  scopeid 0x20&lt;link&gt;
</span></span><span class="line"><span class="cl">        ether da:78:c8:7a:fb:26  txqueuelen <span class="m">1000</span>  <span class="o">(</span>Ethernet<span class="o">)</span>
</span></span><span class="line"><span class="cl">        RX packets <span class="m">132823</span>  bytes <span class="m">8184548</span> <span class="o">(</span>7.8 MiB<span class="o">)</span>
</span></span><span class="line"><span class="cl">        RX errors <span class="m">0</span>  dropped <span class="m">93</span>  overruns <span class="m">0</span>  frame <span class="m">0</span>
</span></span><span class="line"><span class="cl">        TX packets <span class="m">12</span>  bytes <span class="m">936</span> <span class="o">(</span>936.0 B<span class="o">)</span>
</span></span><span class="line"><span class="cl">        TX errors <span class="m">0</span>  dropped <span class="m">0</span> overruns <span class="m">0</span>  carrier <span class="m">0</span>  collisions <span class="m">0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>测试两个名称空间是否互通</p>
<p>结论：可以看到两个名称空间内的子接口 (<em><strong>sub-interface</strong></em>) 通过其父接口 (<em><strong>parent-interface</strong></em>) 可以达到互通。子接口与父接口之间的不互通。<strong>IPVLAN L2模式仅限于子接口之间的互通</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ ip netns <span class="nb">exec</span> net1 ping 192.168.0.2
</span></span><span class="line"><span class="cl">PING 192.168.0.2 <span class="o">(</span>192.168.0.2<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
</span></span><span class="line"><span class="cl"><span class="m">64</span> bytes from 192.168.0.2: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.285 ms
</span></span><span class="line"><span class="cl"><span class="m">64</span> bytes from 192.168.0.2: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">2</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.077 ms
</span></span><span class="line"><span class="cl">^C
</span></span><span class="line"><span class="cl">--- 192.168.0.2 ping statistics ---
</span></span><span class="line"><span class="cl"><span class="m">2</span> packets transmitted, <span class="m">2</span> received, 0% packet loss, <span class="nb">time</span> 1027ms
</span></span><span class="line"><span class="cl">rtt min/avg/max/mdev <span class="o">=</span> 0.077/0.181/0.285/0.104 ms
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ ip netns <span class="nb">exec</span> net2 ping 192.168.0.1
</span></span><span class="line"><span class="cl">PING 192.168.0.1 <span class="o">(</span>192.168.0.1<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
</span></span><span class="line"><span class="cl"><span class="m">64</span> bytes from 192.168.0.1: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.051 ms
</span></span><span class="line"><span class="cl"><span class="m">64</span> bytes from 192.168.0.1: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">2</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.059 ms
</span></span><span class="line"><span class="cl">^C
</span></span><span class="line"><span class="cl">--- 192.168.0.1 ping statistics ---
</span></span><span class="line"><span class="cl"><span class="m">2</span> packets transmitted, <span class="m">2</span> received, 0% packet loss, <span class="nb">time</span> 1056ms
</span></span><span class="line"><span class="cl">rtt min/avg/max/mdev <span class="o">=</span> 0.051/0.055/0.059/0.004 ms
</span></span></code></pre></td></tr></table>
</div>
</div><p>遇到问题</p>
<ul>
<li>
<p><strong>RTNETLINK answers: Operation not supported</strong>： CentOS 7默认内核版本为3.10 IPVLAN 3.19开始支持，推荐内核为4.2+</p>
</li>
<li>
<p>子接口ping父接口不通，源MAC与目标MAC是一致，而mac接口是mac地址与接口绑定，因为三个接口的mac地址都相同，此时区分不了是哪个接口。</p>
</li>
<li>
<p>ping公网地址不通，查看路由表中没有对外的路由，手动添加即可</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ip netns <span class="nb">exec</span> net1 route -n
</span></span><span class="line"><span class="cl">ip netns <span class="nb">exec</span> net1 route add -net 0.0.0.0/0 gw 10.0.0.2
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>IPVLAN L2模式中，父接口是可以没有IP地址的。不影响子接口的使用</p>
</li>
</ul>
<p>清除所有网络名称空间</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="k">for</span> n in <span class="k">$(</span>ip netns list<span class="p">|</span>awk <span class="s1">&#39;{print $1}&#39;</span><span class="k">)</span><span class="p">;</span><span class="k">do</span> ip netns del <span class="nv">$n</span><span class="p">;</span><span class="k">done</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="实验三ipvlan-l3">实验三：IPVLAN L3<a hidden class="anchor" aria-hidden="true" href="#实验三ipvlan-l3">¶</a></h3>
<p>先创建两个用做测试的 network namespace</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ip netns add net3
</span></span><span class="line"><span class="cl">ip netns add net4
</span></span></code></pre></td></tr></table>
</div>
</div><p>创建出 IPVLAN 的虚拟网卡接口，创建 IPVLAN 虚拟接口的命令和 MACVLAN 格式相同：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ip link add ipvl01 link ens33 <span class="nb">type</span> ipvlan mode l3
</span></span><span class="line"><span class="cl">ip link add ipvl02 link ens33 <span class="nb">type</span> ipvlan mode l3
</span></span></code></pre></td></tr></table>
</div>
</div><p>把 IPVLAN 接口放到前面创建好的 namespace 中</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ip link <span class="nb">set</span> ipvl01 netns net3
</span></span><span class="line"><span class="cl">ip link <span class="nb">set</span> ipvl02 netns net4
</span></span><span class="line"><span class="cl"><span class="c1"># 给对应设备设置IP地址</span>
</span></span><span class="line"><span class="cl">ip netns <span class="nb">exec</span> net3 ifconfig ipvl01 192.168.10.1/24 up
</span></span><span class="line"><span class="cl">ip netns <span class="nb">exec</span> net4 ifconfig ipvl02 192.168.20.1/24 up
</span></span><span class="line"><span class="cl"><span class="c1"># 设置对应的路由</span>
</span></span><span class="line"><span class="cl">ip netns <span class="nb">exec</span> net4 route add -net 192.168.10.0/24 dev ipvl02
</span></span><span class="line"><span class="cl">ip netns <span class="nb">exec</span> net3 route add -net 192.168.20.0/24 dev ipvl01
</span></span></code></pre></td></tr></table>
</div>
</div><p>结果是可以通的</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ ip netns <span class="nb">exec</span> net3 ping 192.168.20.1
</span></span><span class="line"><span class="cl">PING 192.168.20.1 <span class="o">(</span>192.168.20.1<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
</span></span><span class="line"><span class="cl"><span class="m">64</span> bytes from 192.168.20.1: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.026 ms
</span></span><span class="line"><span class="cl"><span class="m">64</span> bytes from 192.168.20.1: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">2</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span>0.119 ms
</span></span><span class="line"><span class="cl">^C
</span></span><span class="line"><span class="cl">--- 192.168.20.1 ping statistics ---
</span></span><span class="line"><span class="cl"><span class="m">2</span> packets transmitted, <span class="m">2</span> received, 0% packet loss, <span class="nb">time</span> 1028ms
</span></span><span class="line"><span class="cl">rtt min/avg/max/mdev <span class="o">=</span> 0.026/0.072/0.119/0.046 ms
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="实验四macvlan">实验四：MACVLAN<a hidden class="anchor" aria-hidden="true" href="#实验四macvlan">¶</a></h3>
<p>创建两个名称空间</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ip netns add net1
</span></span><span class="line"><span class="cl">ip netns add net2
</span></span></code></pre></td></tr></table>
</div>
</div><p>创建两个 MACVLAN 接口</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ip link add link eth0 name macv1 <span class="nb">type</span> macvlan mode bridge
</span></span><span class="line"><span class="cl">ip link add link eth0 name macv2 <span class="nb">type</span> macvlan mode bridge
</span></span><span class="line"><span class="cl"><span class="c1">## 持久化创建</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;ip link add eth0 eth0.1 address 52:54:00:cc:ee:aa link enp0s31f6 type macvlan&#34;</span> &gt; /sbin/ifup-pre-local2
</span></span></code></pre></td></tr></table>
</div>
</div><p>把 MACVLAN 接口放到前面创建好的 namespace 中</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ip link <span class="nb">set</span> macv1 netns net1
</span></span><span class="line"><span class="cl">ip link <span class="nb">set</span> macv2 netns net2
</span></span><span class="line"><span class="cl"><span class="c1"># 给对应设备设置IP地址</span>
</span></span><span class="line"><span class="cl">ip netns <span class="nb">exec</span> net1 ifconfig ipvl01 192.168.10.1/24 up
</span></span><span class="line"><span class="cl">ip netns <span class="nb">exec</span> net2 ifconfig ipvl02 192.168.20.1/24 up
</span></span><span class="line"><span class="cl"><span class="c1"># 设置对应的路由</span>
</span></span><span class="line"><span class="cl">ip netns <span class="nb">exec</span> net1 route add -net 192.168.10.0/24 dev ipvl02
</span></span><span class="line"><span class="cl">ip netns <span class="nb">exec</span> net2 route add -net 192.168.20.0/24 dev ipvl01
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看到两个网卡的MAC地址是不同的</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ ip netns <span class="nb">exec</span> net2 ifconfig
</span></span><span class="line"><span class="cl">macv2: <span class="nv">flags</span><span class="o">=</span>4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu <span class="m">1500</span>
</span></span><span class="line"><span class="cl">        inet 192.168.10.1  netmask 255.255.255.0  broadcast 192.168.10.255
</span></span><span class="line"><span class="cl">        inet6 fe80::a830:c9ff:fe9a:7c33  prefixlen <span class="m">64</span>  scopeid 0x20&lt;link&gt;
</span></span><span class="line"><span class="cl">        ether aa:30:c9:9a:7c:33  txqueuelen <span class="m">1000</span>  <span class="o">(</span>Ethernet<span class="o">)</span>
</span></span><span class="line"><span class="cl">        RX packets <span class="m">0</span>  bytes <span class="m">0</span> <span class="o">(</span>0.0 B<span class="o">)</span>
</span></span><span class="line"><span class="cl">        RX errors <span class="m">0</span>  dropped <span class="m">0</span>  overruns <span class="m">0</span>  frame <span class="m">0</span>
</span></span><span class="line"><span class="cl">        TX packets <span class="m">7</span>  bytes <span class="m">586</span> <span class="o">(</span>586.0 B<span class="o">)</span>
</span></span><span class="line"><span class="cl">        TX errors <span class="m">0</span>  dropped <span class="m">0</span> overruns <span class="m">0</span>  carrier <span class="m">0</span>  collisions <span class="m">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ ip netns <span class="nb">exec</span> net1 ifconfig
</span></span><span class="line"><span class="cl">macv1: <span class="nv">flags</span><span class="o">=</span>4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu <span class="m">1500</span>
</span></span><span class="line"><span class="cl">        inet 192.168.10.1  netmask 255.255.255.0  broadcast 192.168.10.255
</span></span><span class="line"><span class="cl">        inet6 fe80::d448:c5ff:fec7:76a3  prefixlen <span class="m">64</span>  scopeid 0x20&lt;link&gt;
</span></span><span class="line"><span class="cl">        ether d6:48:c5:c7:76:a3  txqueuelen <span class="m">1000</span>  <span class="o">(</span>Ethernet<span class="o">)</span>
</span></span><span class="line"><span class="cl">        RX packets <span class="m">0</span>  bytes <span class="m">0</span> <span class="o">(</span>0.0 B<span class="o">)</span>
</span></span><span class="line"><span class="cl">        RX errors <span class="m">0</span>  dropped <span class="m">0</span>  overruns <span class="m">0</span>  frame <span class="m">0</span>
</span></span><span class="line"><span class="cl">        TX packets <span class="m">8</span>  bytes <span class="m">656</span> <span class="o">(</span>656.0 B<span class="o">)</span>
</span></span><span class="line"><span class="cl">        TX errors <span class="m">0</span>  dropped <span class="m">0</span> overruns <span class="m">0</span>  carrier <span class="m">0</span>  collisions <span class="m">0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="reference">Reference<a hidden class="anchor" aria-hidden="true" href="#reference">¶</a></h2>
<blockquote>
<p><sup id="1">[1]</sup> <a href="https://man7.org/linux/man-pages/man4/veth.4.html">man veth</a></p>
<p><sup id="2">[2]</sup> <a href="https://hicu.be/bridge-vs-macvlan">macvlan</a></p>
<p><sup id="3">[3]</sup> <a href="https://superuser.com/questions/1113812/how-to-configure-macvlan-interface-for-getting-the-ip">how to configure macvlan interface for getting the IP?</a></p>
<p><sup id="4">[4]</sup> <a href="https://community.fs.com/blog/how-to-choose-the-right-distribution-switch.html">distribution switch</a></p>
<p><sup id="5">[5]</sup> <a href="https://nwktimes.blogspot.com/2018/02/vxlan-part-i-why-vxlan-is-needed.html">why vxlan is needed</a></p>
<p><sup id="4">[4]</sup> <a href="">distribution switch</a></p>
</blockquote>


    
    


<div class="copyrightBlock" >
    <div class="articleSuffix-bg"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 147.78 155.96"> <path d="M10.5,99.81a1.9,1.9,0,0,0-.53-.09,1.66,1.66,0,0,0-1.64,1.65A1.64,1.64,0,0,0,10,103a1.57,1.57,0,0,0,.87-.25l26.76,26.82.45-1.08L11.52,101.91A1.65,1.65,0,0,0,10.5,99.81Zm-.13,2a.57.57,0,0,1-.8,0,.58.58,0,0,1-.17-.41.58.58,0,0,1,.57-.57h0a.57.57,0,0,1,.56.58A.55.55,0,0,1,10.37,101.77Z" style="fill:#c5c9e0"></path><path d="M56.15,117.58H39.06l0-.09a1.65,1.65,0,0,0-1.36-1H37.5a1.65,1.65,0,1,0,1.56,2.19H55.7L92.92,156h41.44v-1.08h-41Zm-18.25.94a.56.56,0,0,1-.79,0,.58.58,0,0,1-.17-.41.57.57,0,0,1,.56-.57h0a.58.58,0,0,1,.57.58A.54.54,0,0,1,37.9,118.52Z" style="fill:#c5c9e0"></path><path d="M23.52,50.32a1.65,1.65,0,0,0,1.55-1.11H55.28l48-48.13h31.06V0H102.85l-48,48.13H25.07a1.64,1.64,0,0,0-2.09-1,1.64,1.64,0,0,0,.54,3.2Zm0-2.21a.57.57,0,0,1,0,1.13.57.57,0,1,1,0-1.13Z" style="fill:#c5c9e0"></path><polygon points="102.86 0 102.86 0 102.86 0 102.86 0" style="fill:#c5c9e0"></polygon><path d="M107.72,12.14h26.64V11.07H107.27L57.4,61H3.09a1.66,1.66,0,0,0-1.45-.86H1.52A1.65,1.65,0,1,0,2.81,63a1.59,1.59,0,0,0,.45-.87H57.85ZM2.05,62.23a.57.57,0,0,1-.8,0,.58.58,0,0,1-.17-.41.57.57,0,0,1,.56-.57h.09a.57.57,0,0,1,.32,1Z" style="fill:#c5c9e0"></path><path d="M134.36,43.22V42.14h-22.3l-9.62,9.63a1.64,1.64,0,0,0-2.19.77,1.61,1.61,0,0,0-.17.71,1.65,1.65,0,1,0,3.29,0,1.61,1.61,0,0,0-.16-.72l9.3-9.32Zm-32.64,10.6a.57.57,0,0,1,0-1.13.57.57,0,0,1,0,1.13Z" style="fill:#c5c9e0"></path><path d="M147,52.3l-9,9H111.48a1.64,1.64,0,0,0-1.61-1.33h-.14a1.65,1.65,0,1,0,1.6,2.41h27.19l9.26-9.29L147,52.3Zm-37.15,9.85a.56.56,0,0,1-.56-.57h0a.56.56,0,0,1,.56-.56h0a.57.57,0,1,1,0,1.13Z" style="fill:#c5c9e0"></path><path d="M66.79,75.35l11,11.06h56.53V85.33H78.27l-11-11.06H49.49L37.12,86.67a1.64,1.64,0,0,0-2.09,1,1.61,1.61,0,0,0-.09.54,1.65,1.65,0,0,0,3.29,0,1.68,1.68,0,0,0-.26-.89l12-12ZM36.58,88.79a.57.57,0,1,1,.57-.56A.57.57,0,0,1,36.58,88.79Z" style="fill:#c5c9e0"></path><path d="M110.61,95.55,92.8,113.4a1.62,1.62,0,1,0,.77.76l17.49-17.53h23.31V95.55ZM92.49,115.28a.56.56,0,0,1-.8,0,.58.58,0,0,1-.17-.41.57.57,0,0,1,.57-.57h0a.58.58,0,0,1,.56.58A.55.55,0,0,1,92.49,115.28Z" style="fill:#c5c9e0"></path><path d="M97.89,122.3H76.62L64.2,109.85a1.65,1.65,0,0,0-.77-2.2,1.77,1.77,0,0,0-.72-.17h-.14a1.65,1.65,0,0,0,.15,3.29,1.58,1.58,0,0,0,.71-.17l12.74,12.77H98.34l17.48-17.52h18.54v-1.08h-19ZM63.12,109.53a.56.56,0,0,1-.8,0,.58.58,0,0,1-.17-.41.57.57,0,0,1,1.14,0A.54.54,0,0,1,63.12,109.53Z" style="fill:#c5c9e0"></path> </svg> </div>
    <p>本文发布于<a href="https://www.oomkill.com/about" target="_blank">Cylon的收藏册</a>，转载请著名原文链接~</p>
    <p>链接：<a href="https://www.oomkill.com/2021/01/virtual-networking/" target="_blank">https://www.oomkill.com/2021/01/virtual-networking/</a></p>
    <p style="margin-bottom: 0px;">版权：本作品采用<a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">「署名-非商业性使用-相同方式共享 4.0 国际」</a> 许可协议进行许可。</p>
    </div>
</div>
  </div>

  <footer class="post-footer">
    
<nav class="paginav">
  <a class="prev" href="https://www.oomkill.com/2021/01/calico-network-cni/">
    <span class="title"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left" style="user-select: text;"><line x1="19" y1="12" x2="5" y2="12" style="user-select: text;"></line><polyline points="12 19 5 12 12 5" style="user-select: text;"></polyline>
      </polyline></svg>&nbsp; </span>
    
    <span>calico network cni网络方案</span>
  </a>
  <a class="next" href="https://www.oomkill.com/2021/01/static-routing/" >
    <span class="title"> </span>
    
    <span>静态路由&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right" style="user-select: text;"><line x1="5" y1="12" x2="19" y2="12" style="user-select: text;"></line><polyline points="12 5 19 12 12 19" style="user-select: text;"></polyline></svg></span>
  </a>
</nav>

  </footer>

  
  <div class="pagination__title">
    <span class="pagination__title-h"></span>
  </div>
  
  
  
  
    <div class="comments-separator"></div>
    

<h3>相关阅读</h3>
<ul>
	
	<li><a href="/2021/01/ensp-calico-bgp/">使用eNSP构建calico BGP网络</a></li>
	
	<li><a href="/2021/01/network-tunnel-technology/">网络隧道技术</a></li>
	
	<li><a href="/2021/01/linux-network-command/">长期总结 - Linux网络命令合集</a></li>
	
	<li><a href="/2021/01/static-routing/">静态路由</a></li>
	
	<li><a href="/2021/01/dynamic-routing-ospf/">动态路由 - OSPF</a></li>
	
</ul>

  

  
    
      <div class="comments-separator"></div>
<div class="comments">
    <script>
    function loadComment() {
        let theme = localStorage.getItem('pref-theme') === 'dark' ? 'dark' : 'light';
        let s = document.createElement('script');
        s.src = 'https://giscus.app/client.js';
        s.setAttribute('data-repo', 'cylonchau\/cylonchau.github.io');
        s.setAttribute('data-repo-id', 'R_kgDOIRlNSQ');
        s.setAttribute('data-category', 'Announcements');
        s.setAttribute('data-category-id', 'DIC_kwDOIRlNSc4CXy1U');
        s.setAttribute('data-mapping', 'title');
        s.setAttribute('data-reactions-enabled', '1');
        s.setAttribute('data-emit-metadata', '1');
        s.setAttribute('data-input-position', 'top');
        s.setAttribute('data-lang', 'zh-TW');
        s.setAttribute('data-theme', theme);
        s.setAttribute('crossorigin', 'anonymous');
        s.setAttribute('async', '');
        document.querySelector('div.comments').innerHTML = '';
        document.querySelector('div.comments').appendChild(s);
    }
    loadComment();
    </script>
</div>
</article>
    </main>
    
<footer class="footer">
  <p>
  Copyright
  <span>&copy; 2024 <a href="https://www.oomkill.com">Cylon&#39;s Collection</a></span></p>
  <span style="display: inline-block; margin-left: 1em;">
    Powered by
    <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> on github-page & Theme
    <a href="https://github.com/reorx/hugo-PaperModX/" rel="noopener" target="_blank">PaperModX</a>
  </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <span class="topInner">
        <svg class="topSvg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z"/>
        </svg>
        <span id="read_progress"></span>
    </span>
</a>

<script>
  (function() {
     
    const disableThemeToggle = '' == '1';
    if (disableThemeToggle) {
      return;
    }

    let button = document.getElementById("theme-toggle")
    
    button.removeEventListener('click', toggleThemeListener)
    
    button.addEventListener('click', toggleThemeListener)
  })();
</script>

<script>
  (function () {
    let menu = document.getElementById('menu')
    if (menu) {
      menu.scrollLeft = localStorage.getItem("menu-scroll-position");
      menu.onscroll = function () {
        localStorage.setItem("menu-scroll-position", menu.scrollLeft);
      }
    }

    const disableSmoothScroll = '' == '1';
    const enableInstantClick = '1' == '1';
    
    if (window.matchMedia('(prefers-reduced-motion: reduce)').matches || disableSmoothScroll || enableInstantClick) {
      return;
    }
    
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
      anchor.addEventListener("click", function (e) {
        e.preventDefault();
        var id = this.getAttribute("href").substr(1);
        document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
          behavior: "smooth"
        });
        if (id === "top") {
          history.replaceState(null, null, " ");
        } else {
          history.pushState(null, null, `#${id}`);
        }
      });
    });
  })();
</script>

<script>
  document.addEventListener('scroll', function (e) {
      const readProgress = document.getElementById("read_progress");
      const scrollHeight = document.documentElement.scrollHeight;
      const clientHeight = document.documentElement.clientHeight;
      const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
      readProgress.innerText = ((scrollTop / (scrollHeight - clientHeight)).toFixed(2) * 100).toFixed(0);
  })
</script>

<script>
  var menu = document.getElementById('menu')
  if (menu) {
      menu.scrollLeft = localStorage.getItem("menu-scroll-position");
      menu.onscroll = function () {
          localStorage.setItem("menu-scroll-position", menu.scrollLeft);
      }
  }

  document.querySelectorAll('a[href^="#"]').forEach(anchor => {
      anchor.addEventListener("click", function (e) {
          e.preventDefault();
          var id = this.getAttribute("href").substr(1);
          if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
              document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                  behavior: "smooth"
              });
          } else {
              document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
          }
          if (id === "top") {
              history.replaceState(null, null, " ");
          } else {
              history.pushState(null, null, `#${id}`);
          }
      });
  });
</script>
<script>
  var mybutton = document.getElementById("top-link");
  window.onscroll = function () {
      if (document.body.scrollTop > 200 || document.documentElement.scrollTop > 200) {
          mybutton.style.visibility = "visible";
          mybutton.style.opacity = "1";
      } else {
          mybutton.style.visibility = "hidden";
          mybutton.style.opacity = "0";
      }
  };
</script>
<script>
  if (window.scrollListeners) {
    
    for (const listener of scrollListeners) {
      window.removeEventListener('scroll', listener)
    }
  }
  window.scrollListeners = []
</script>



<script src="/js/medium-zoom.min.js" data-no-instant
></script>
<script>
  document.querySelectorAll('pre > code').forEach((codeblock) => {
    const container = codeblock.parentNode.parentNode;

    const copybutton = document.createElement('button');
    copybutton.classList.add('copy-code');
    copybutton.innerText = 'copy';

    function copyingDone() {
      copybutton.innerText = 'copied';
      setTimeout(() => {
        copybutton.innerText = 'copy';
      }, 2000);
    }

    copybutton.addEventListener('click', (cb) => {
      if ('clipboard' in navigator) {
        navigator.clipboard.writeText(codeblock.textContent);
        copyingDone();
        return;
      }

      const range = document.createRange();
      range.selectNodeContents(codeblock);
      const selection = window.getSelection();
      selection.removeAllRanges();
      selection.addRange(range);
      try {
        document.execCommand('copy');
        copyingDone();
      } catch (e) { };
      selection.removeRange(range);
    });

    if (container.classList.contains("highlight")) {
      container.appendChild(copybutton);
    } else if (container.parentNode.firstChild == container) {
      
    } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
      
      codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
    } else {
      
      codeblock.parentNode.appendChild(copybutton);
    }
  });
</script>




<script>
  
  
  (function() {
    const enableTocScroll = '1' == '1'
    if (!enableTocScroll) {
      return
    }
    if (!document.querySelector('.toc')) {
      console.log('no toc found, ignore toc scroll')
      return
    }
    

    
    const scrollListeners = window.scrollListeners
    const headings = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id]');
    const activeClass = 'active';

    
    let activeHeading = headings[0];
    getLinkByHeading(activeHeading).classList.add(activeClass);

    const onScroll = () => {
      const passedHeadings = [];
      for (const h of headings) {
        
        if (getOffsetTop(h) < 5) {
          passedHeadings.push(h)
        } else {
          break;
        }
      }
      if (passedHeadings.length > 0) {
        newActiveHeading = passedHeadings[passedHeadings.length - 1];
      } else {
        newActiveHeading = headings[0];
      }
      if (activeHeading != newActiveHeading) {
        getLinkByHeading(activeHeading).classList.remove(activeClass);
        activeHeading = newActiveHeading;
        getLinkByHeading(activeHeading).classList.add(activeClass);
      }
    }

    let timer = null;
    const scrollListener = () => {
      if (timer !== null) {
        clearTimeout(timer)
      }
      timer = setTimeout(onScroll, 50)
    }
    window.addEventListener('scroll', scrollListener, false);
    scrollListeners.push(scrollListener)

    function getLinkByHeading(heading) {
      const id = encodeURI(heading.getAttribute('id')).toLowerCase();
      return document.querySelector(`.toc ul li a[href="#${id}"]`);
    }

    function getOffsetTop(heading) {
      if (!heading.getClientRects().length) {
        return 0;
      }
      let rect = heading.getBoundingClientRect();
      return rect.top
    }
  })();
  </script>

<script src="/js/instantclick.min.js" data-no-instant
></script>
<script data-no-instant>
  
  
  
  
  
  
  InstantClick.init();
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/8.6.0/mermaid.min.js" crossorigin="anonymous"></script>
<script>
    mermaid.init(undefined, '.language-mermaid');
</script>
</body>

</html>
