<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Linux虚拟网络技术 | Cylon's Collection</title>
<meta name=keywords content="linux,network,kubernetes network"><meta name=description content="Overview 本文将介绍Kubernetes中使用的相关虚拟网络功能，目的是为了任何无相关网络背景经历的人都可以了解这些技术在kubernetes中式如何应用的。
VLAN VLAN (Virtual local area networks)是逻辑上的LAN而不受限于同一物理网络交换机上。同样的VLAN也可以将同一台交换机/网桥下的设备/划分为不同的子网。
VLAN 区分的广播域的标准是VLAN ID，此功能是Linux内核3.8中引入的
在Linux中创建一个VLAN
bash 1 ip link add link eth0 name eth0.2 type vlan id 2 VETH [1] VETH (Virtual Ethernet device)，是一个本地的以太网隧道，创建出的设备是成对的，通常会存在两个名称空间内，例如在docker中创建出的设备一端在root名称空间内，一端被挂在到容器的名称空间内。
图：veth topology Source：https://medium.com/@arpitkh96/basics-of-container-networking-with-linux-part-1-3a3cdc64c87a
bash 1 ip link add <p1-name> type veth peer name <p2-name> Bridge 目的 Linux bridge（又称为网桥、VLAN交换机）是Linux内核中集成的功能，用来做tcp/ip做二层协议交换的设备，虽然是软件实现的，但它与普通的二层物理交换机功能一样。bridge 就是为了解决虚拟机网卡连接问题。可以添加若干个网络设备到 bridge 上作为其接口，添加到 bridge 上的设备被设置为只接受二层数据帧并且转发所有收到的数据包到 bridge 中。
由于 Linux bridge 是二层设备，故数据包是根据MAC地址而不是IP转发的。因此所有协议都可以透明地通过网桥。Linux bridge 广泛用于虚拟机，名称空间等。
图：Linux Bridge Source：https://kbespalov.medium.com/linux-linux-bridge-7e0e887edd01
MACVLAN [2] MACVLAN 允许在一个物理接口创建多个子接口，并且每个子接口都拥有一个随机生成的MAC地址，与IP地址。
MACVLAN 中子接口不能与与父接口直接通讯，例如在虚拟化环境中，容器是不能ping通宿主机的IP，如果子接口需要和父接口进行通讯，需要将子接口分配给父接口。"><meta name=author content="cylon"><link rel=canonical href=https://www.oomkill.com/2021/01/virtual-networking/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://www.oomkill.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.oomkill.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.oomkill.com/favicon-32x32.png><link rel=apple-touch-icon href=https://www.oomkill.com/favicon.ico><link rel=mask-icon href=https://www.oomkill.com/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://www.oomkill.com/2021/01/virtual-networking/><noscript><style>#theme-toggle,#top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link crossorigin=anonymous href=/assets/css/pe.min.css rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/pe.min.js></script><link rel=stylesheet href=https://cdn.staticfile.net/font-awesome/6.5.1/css/all.min.css><link rel=stylesheet href=https://cdn.staticfile.net/font-awesome/6.5.1/css/v4-shims.min.css><script defer src=https://cdn.staticfile.net/jquery/3.5.1/jquery.min.js></script><link rel=stylesheet href=https://cdn.staticfile.net/fancybox/3.5.7/jquery.fancybox.min.css><script defer src=https://cdn.staticfile.net/fancybox/3.5.7/jquery.fancybox.min.js></script><script id=MathJax-script async src=https://cdn.staticfile.net/mathjax/3.2.2/es5/tex-chtml.js></script><script>MathJax={tex:{displayMath:[["$$","$$"]],inlineMath:[["\\$","\\$"]]}}</script><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><meta name=referrer content="no-referrer-when-downgrade"><meta property="og:title" content="Linux虚拟网络技术"><meta property="og:description" content="Overview 本文将介绍Kubernetes中使用的相关虚拟网络功能，目的是为了任何无相关网络背景经历的人都可以了解这些技术在kubernetes中式如何应用的。
VLAN VLAN (Virtual local area networks)是逻辑上的LAN而不受限于同一物理网络交换机上。同样的VLAN也可以将同一台交换机/网桥下的设备/划分为不同的子网。
VLAN 区分的广播域的标准是VLAN ID，此功能是Linux内核3.8中引入的
在Linux中创建一个VLAN
bash 1 ip link add link eth0 name eth0.2 type vlan id 2 VETH [1] VETH (Virtual Ethernet device)，是一个本地的以太网隧道，创建出的设备是成对的，通常会存在两个名称空间内，例如在docker中创建出的设备一端在root名称空间内，一端被挂在到容器的名称空间内。
图：veth topology Source：https://medium.com/@arpitkh96/basics-of-container-networking-with-linux-part-1-3a3cdc64c87a
bash 1 ip link add <p1-name> type veth peer name <p2-name> Bridge 目的 Linux bridge（又称为网桥、VLAN交换机）是Linux内核中集成的功能，用来做tcp/ip做二层协议交换的设备，虽然是软件实现的，但它与普通的二层物理交换机功能一样。bridge 就是为了解决虚拟机网卡连接问题。可以添加若干个网络设备到 bridge 上作为其接口，添加到 bridge 上的设备被设置为只接受二层数据帧并且转发所有收到的数据包到 bridge 中。
由于 Linux bridge 是二层设备，故数据包是根据MAC地址而不是IP转发的。因此所有协议都可以透明地通过网桥。Linux bridge 广泛用于虚拟机，名称空间等。
图：Linux Bridge Source：https://kbespalov.medium.com/linux-linux-bridge-7e0e887edd01
MACVLAN [2] MACVLAN 允许在一个物理接口创建多个子接口，并且每个子接口都拥有一个随机生成的MAC地址，与IP地址。
MACVLAN 中子接口不能与与父接口直接通讯，例如在虚拟化环境中，容器是不能ping通宿主机的IP，如果子接口需要和父接口进行通讯，需要将子接口分配给父接口。"><meta property="og:type" content="article"><meta property="og:url" content="https://www.oomkill.com/2021/01/virtual-networking/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-01-18T00:00:00+00:00"><meta property="article:modified_time" content="2023-03-22T23:00:36+08:00"><meta property="og:site_name" content="Cylon's Collection"><meta name=twitter:card content="summary"><meta name=twitter:title content="Linux虚拟网络技术"><meta name=twitter:description content="Overview 本文将介绍Kubernetes中使用的相关虚拟网络功能，目的是为了任何无相关网络背景经历的人都可以了解这些技术在kubernetes中式如何应用的。
VLAN VLAN (Virtual local area networks)是逻辑上的LAN而不受限于同一物理网络交换机上。同样的VLAN也可以将同一台交换机/网桥下的设备/划分为不同的子网。
VLAN 区分的广播域的标准是VLAN ID，此功能是Linux内核3.8中引入的
在Linux中创建一个VLAN
bash 1 ip link add link eth0 name eth0.2 type vlan id 2 VETH [1] VETH (Virtual Ethernet device)，是一个本地的以太网隧道，创建出的设备是成对的，通常会存在两个名称空间内，例如在docker中创建出的设备一端在root名称空间内，一端被挂在到容器的名称空间内。
图：veth topology Source：https://medium.com/@arpitkh96/basics-of-container-networking-with-linux-part-1-3a3cdc64c87a
bash 1 ip link add <p1-name> type veth peer name <p2-name> Bridge 目的 Linux bridge（又称为网桥、VLAN交换机）是Linux内核中集成的功能，用来做tcp/ip做二层协议交换的设备，虽然是软件实现的，但它与普通的二层物理交换机功能一样。bridge 就是为了解决虚拟机网卡连接问题。可以添加若干个网络设备到 bridge 上作为其接口，添加到 bridge 上的设备被设置为只接受二层数据帧并且转发所有收到的数据包到 bridge 中。
由于 Linux bridge 是二层设备，故数据包是根据MAC地址而不是IP转发的。因此所有协议都可以透明地通过网桥。Linux bridge 广泛用于虚拟机，名称空间等。
图：Linux Bridge Source：https://kbespalov.medium.com/linux-linux-bridge-7e0e887edd01
MACVLAN [2] MACVLAN 允许在一个物理接口创建多个子接口，并且每个子接口都拥有一个随机生成的MAC地址，与IP地址。
MACVLAN 中子接口不能与与父接口直接通讯，例如在虚拟化环境中，容器是不能ping通宿主机的IP，如果子接口需要和父接口进行通讯，需要将子接口分配给父接口。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://www.oomkill.com/posts/"},{"@type":"ListItem","position":2,"name":"Linux虚拟网络技术","item":"https://www.oomkill.com/2021/01/virtual-networking/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Linux虚拟网络技术","name":"Linux虚拟网络技术","description":"Overview 本文将介绍Kubernetes中使用的相关虚拟网络功能，目的是为了任何无相关网络背景经历的人都可以了解这些技术在kubernetes中式如何应用的。\nVLAN VLAN (Virtual local area networks)是逻辑上的LAN而不受限于同一物理网络交换机上。同样的VLAN也可以将同一台交换机/网桥下的设备/划分为不同的子网。\nVLAN 区分的广播域的标准是VLAN ID，此功能是Linux内核3.8中引入的\n在Linux中创建一个VLAN\nbash 1 ip link add link eth0 name eth0.2 type vlan id 2 VETH [1] VETH (Virtual Ethernet device)，是一个本地的以太网隧道，创建出的设备是成对的，通常会存在两个名称空间内，例如在docker中创建出的设备一端在root名称空间内，一端被挂在到容器的名称空间内。\n图：veth topology Source：https://medium.com/@arpitkh96/basics-of-container-networking-with-linux-part-1-3a3cdc64c87a\nbash 1 ip link add \u0026lt;p1-name\u0026gt; type veth peer name \u0026lt;p2-name\u0026gt; Bridge 目的 Linux bridge（又称为网桥、VLAN交换机）是Linux内核中集成的功能，用来做tcp/ip做二层协议交换的设备，虽然是软件实现的，但它与普通的二层物理交换机功能一样。bridge 就是为了解决虚拟机网卡连接问题。可以添加若干个网络设备到 bridge 上作为其接口，添加到 bridge 上的设备被设置为只接受二层数据帧并且转发所有收到的数据包到 bridge 中。\n由于 Linux bridge 是二层设备，故数据包是根据MAC地址而不是IP转发的。因此所有协议都可以透明地通过网桥。Linux bridge 广泛用于虚拟机，名称空间等。\n图：Linux Bridge Source：https://kbespalov.medium.com/linux-linux-bridge-7e0e887edd01\nMACVLAN [2] MACVLAN 允许在一个物理接口创建多个子接口，并且每个子接口都拥有一个随机生成的MAC地址，与IP地址。\nMACVLAN 中子接口不能与与父接口直接通讯，例如在虚拟化环境中，容器是不能ping通宿主机的IP，如果子接口需要和父接口进行通讯，需要将子接口分配给父接口。","keywords":["linux","network","kubernetes network"],"articleBody":"Overview 本文将介绍Kubernetes中使用的相关虚拟网络功能，目的是为了任何无相关网络背景经历的人都可以了解这些技术在kubernetes中式如何应用的。\nVLAN VLAN (Virtual local area networks)是逻辑上的LAN而不受限于同一物理网络交换机上。同样的VLAN也可以将同一台交换机/网桥下的设备/划分为不同的子网。\nVLAN 区分的广播域的标准是VLAN ID，此功能是Linux内核3.8中引入的\n在Linux中创建一个VLAN\nbash 1 ip link add link eth0 name eth0.2 type vlan id 2 VETH [1] VETH (Virtual Ethernet device)，是一个本地的以太网隧道，创建出的设备是成对的，通常会存在两个名称空间内，例如在docker中创建出的设备一端在root名称空间内，一端被挂在到容器的名称空间内。\n图：veth topology Source：https://medium.com/@arpitkh96/basics-of-container-networking-with-linux-part-1-3a3cdc64c87a\nbash 1 ip link add type veth peer name Bridge 目的 Linux bridge（又称为网桥、VLAN交换机）是Linux内核中集成的功能，用来做tcp/ip做二层协议交换的设备，虽然是软件实现的，但它与普通的二层物理交换机功能一样。bridge 就是为了解决虚拟机网卡连接问题。可以添加若干个网络设备到 bridge 上作为其接口，添加到 bridge 上的设备被设置为只接受二层数据帧并且转发所有收到的数据包到 bridge 中。\n由于 Linux bridge 是二层设备，故数据包是根据MAC地址而不是IP转发的。因此所有协议都可以透明地通过网桥。Linux bridge 广泛用于虚拟机，名称空间等。\n图：Linux Bridge Source：https://kbespalov.medium.com/linux-linux-bridge-7e0e887edd01\nMACVLAN [2] MACVLAN 允许在一个物理接口创建多个子接口，并且每个子接口都拥有一个随机生成的MAC地址，与IP地址。\nMACVLAN 中子接口不能与与父接口直接通讯，例如在虚拟化环境中，容器是不能ping通宿主机的IP，如果子接口需要和父接口进行通讯，需要将子接口分配给父接口。\n图：MACVLAN Source：https://hicu.be/bridge-vs-macvlan\n从 Linux 内核3.0起，MAC已经是linux内核中的一部分。\n查看内核是否加载 lsmod | grep macvlan\n加载macvlan模块 modprobe macvlan\n如果需要每次启动时都加载该模块，echo \"macvlan\" \u003e\u003e /etc/modules\nMACVLAN的限制 限制：\n使用MACVLAN技术需要开启网卡的混杂模式 授予NIC支持的MAC数量限制，超出限制会影响性能 MACVLAN不能工作在wireless网络环境中 [3] MACVLAN的模式 MACVLAN又五种类型：\nPrivate VEPA Bridge Passthru Source Private mode Private模式下的同一物理接口下的子接口将不允许通讯，即使物理设备支持hairpin也不行。\n图：MACVLAN Private mod Source：https://hicu.be/bridge-vs-macvlan\nhairpin 有多个名称，U-turn NAT, NAT loopback，实际上就是一种网络转换，在一个网络中的两个设备使用外部IP进行通讯。在MACVLAN这个例子中，veth1发往veth2的流量通过外部设备switch进行一个回转，这个行为称为为 hairpin turn。从上图也可以看出，是一个U形的转换。\nVPEA mode VPEA 将会将来自子接口的通过父接口转发，这将要求物理交换机需要支持 hairpin\n图：MACVLAN VPEA mode Source：https://hicu.be/bridge-vs-macvlan\nBridge mode Bridge 是指父接口与所有子接口是通过网桥相连的，因为连接在网桥上，不需要学习MAC地址。这也是容器网络中常用到的模式\n图：MACVLAN bridge mode Source：https://hicu.be/bridge-vs-macvlan\nPassthru passthru 是 pass through，由名字也可以得知，是指允许单个VM与物理接口连接。\n图：MACVLAN passthru mode Source：https://hicu.be/bridge-vs-macvlan\nSource 这个模式是Linux中的一个 Patch，是流量仅允许被允许的MAC地址列表\nIPVLAN IPVLAN与MACVLAN类似，只有一个不同的地方是，IPVLAN所有的MAC地址都是一样的，就是使用相同的MAC地址去创建子接口。\n图：IPVLAN Source：https://hicu.be/bridge-vs-macvlan\nIPVLAN modes 在使用IPVLAN时，只能选择下面两种模式中的一种，选择后，所有的子节接口将工作在这个模式下。\nL2 IPVLAN L2模式与 MACVLAN 的 brigde 模式工作原理很相似，父接口是作为交换机的角色，同一个物理接口上的子接口可以通过父接口来转发数据，而如果要发送数据到其他的网络，报文则会通过父接口的路由转发出去。\n图：IPVLAN L2 Source：https://hicu.be/bridge-vs-macvlan\nNotes: IPVLAN 是 linux kernel 比较新的特性，linux kernel 3.19 开始支持 ipvlan，但是比较稳定推荐的版本是 \u003e=4.2\nL3 在 L3 模式下也就是 物理接口 是作为路由器，这种情况下就要求子接口之间需要处在不同子网中才可以。因为广播域是 L2 的，所以 IPVLAN L3 不支持多播和广播。\n图：IPVLAN L3 Source：https://hicu.be/bridge-vs-macvlan\nIPVLAN与MACVLAN如何选择 在于MACVLAN在wireless环境中的不友好，wireless选择 IPVLAN 对于外部设备有MAC地址限制的，或者混杂模式限制NIC性能 VxLAN VxLAN Introduction VxLAN (Virtual eXtensible Local Area Network) 是一种 MAC-over-IP 或者称为 UDP隧道机制，本质上来说是使用网络隧道技术将L3网络扩展为一个L2网络。\n为什么将 VxLAN 视为L2网络呢？ 虽说 VxLAN 是将L2的以太网帧封装到UDP报文中（L2 over L4）中，并在L3网络中传输。但是 VxLAN 最终是基于 MAC 地址的二层网络（可以无需路由设备），而不像 IPIP 的隧道技术网络通讯是基于路由的。\n下图是一个使用 VxLAN 技术的网络拓扑，整个篮筐部分可以视为一个二层的虚拟交换机，连接的各设备都可以直连。\n图：VXLAN tunneling technology Source：https://support.huawei.com/enterprise/en/doc/EDOC1100086966\nVNI VNI (VXLAN Network Identifier) 是类似于VLAN ID的标识符，不同的VNI 之间不能进行二层通讯\nVEPT VTEP (VxLAN tunnel endpoint) 是指数据包封包与解包的实体，VTEP 既可以是一台独立的网络设备，也可以是一个基于软件的虚拟交换机。当源服务器发出包时，会在 VTEP 上封装成 VxLAN 格式的报文；当传送到对端时，会在对端的 VTEP 进行解包\n下图是一个VxLAN网络拓扑图，其中建立隧道的两端就是 VTEP，这里的 VTEP 是两台 TOR 交换机，通过两个 VTEP 来对数据包的解封装。\n图：VXLAN network model Source：https://support.huawei.com/enterprise/en/doc/EDOC1100086966\n下图是Linux VxLAN 类型的网络拓扑，VTEP 可以理解为是一种网络接口，通过该接口与内核功能进行解封包，而实际的流量也是通过物理设备进行传输。\n图：VxLAN in Linux Preliminary knowledge 三层分级网络 [4] 三层分级网络? 思科的三层分级网络(three-layer hierarchical model) 包含三层：\n核心层 (Core)：网络骨干，提供不同分布层之间的高速连接和最优传送路径 分布层 (distribution) 将连接接入层到核心层，并且实施安全，流量负载和路由相关的策略 接入层 (access) 为用户终端初始网络的接入点。 图：three-layer hierarchical model Source：https://community.fs.com/blog/how-to-choose-the-right-distribution-switch.html\n为什么需要VxLAN [5] 下图是一个 CSP (Cloud Service Provider ) 的 DC 网络，\n接入层：48口交换机20个 分布层：两台分布式交换机，共同组成一个虚拟化交换机。默认网关位于分布式交换机中。 核心层：两个核心交换机 Notes：工作在分布层的交换机被称为分布式交换机 (Distribution Switch)，分布式交换机会将来自访问层的流量转发至核心层，并提供一些连接策略。\n每台接入交换机连接48台物理服务器。这些服务器中的每一个都包含五个不同的租户，它们拥有自己的虚拟路由 (VRF)。一个租户由三个广播域组成：Presiontation， Application 和 Database ，每层都是互备的。在管理租户时，可以定义 VLAN ID、虚拟机的 MAC 地址和 IP 地址。虚拟机时可移动的，存在如下信息：\n图：CSP DC network Source：https://nwktimes.blogspot.com/2018/02/vxlan-part-i-why-vxlan-is-needed.html\n通过上述信息可以得知有如下：\n服务器：$20\\times48=960$, 20为ToR交换机数量，48为每个ToR的接口 虚拟机/MAC地址/ARP：28800个虚拟机（每个物理机30个虚拟机） 广播域：每个租户+每个租户的VLAN+所拥有的物理机，$5\\times3\\times960=14400$ VRF：4800，5个租户+960个虚拟机 在这种网络中存在的挑战如下：\nVLAN ID的限制，通常来说VLAN ID只有12位，4096个，这意味着不够用 多租户，多租户场景下，广播域等都是用户自己定义的，此时可能发生客户定义的ID为相同的 MAC表大小限制，在一个租户下有28800个机器，意味着交换机MAC地址表存放28800个MAC地址。会出现老化过程。（Notes：Cisco Nexus 9500/9300 系列支持90000个MAC地址表） APR表大小限制，分布式交换机中存在超过28800条MAC-IP的数量（ Notes：Cisco Nexus 9500系列交换机支持 60,000 个 IPv4 ARP 和 30,000 个 IPv6 ND） 生成树协议，在这种网络拓扑结构下，由于 STP 不支持链路之间的负载均衡，因此某些链路可能不会用于流量传输，这种情况下使带宽利用率下降。 由于 VxLAN 通过L3建立隧道，因此不需要生成树协议。在基于 VxLAN 技术的 DC 中，VLAN将不再具有意义，因为 VLAN 是交换机甚至交换机端口特定的。\n在基于 VxLAN Leaf-Spine 的网络架构中，通过将网络压缩为一个L2的网络架构，所有的节点在访问其他节点时，都将仅需要两部，因此除了Leaf交换机之外，其余并不清楚虚拟机的MAC地址。\n下图是Leaf-Spine网络拓扑图， 在该架构中，每个较低级别的接入（leaf）交换机都以全网状连接到每个较高级别的核心（spine）交换机。\n图：spine-leaf network Source：https://www.datacenterdynamics.com/en/marketwatch/spine-and-leaf-network-architecture-explained/\nVxLAN in Linux Linux 对 VxLAN 协议的支持时间并不久，2012 年 Stephen Hemminger 才把相关的工作合并到 kernel 中，并最终出现在 kernel 3.7.0 版本。为了稳定性和很多的功能，你可以会看到某些软件推荐在 3.9.0 或者 3.10.0 以后版本的 kernel 上使用 vxlan。\nlinux实现VxLAN网络 两台机器构成一个VxLAN网络，每台机器上有一个 VTEP，VTEP 通过它们的 IP 互相通信。\n图：VxLAN in Linux 这个图创建的VxLAN0设备模拟了VTEP隧道端点，实现了一个大二层域，突破了虚拟化网络的物理界限。\nnode01\nbash 1 2 3 ip link add vxlan1 type vxlan id 1 remote 10.0.0.3 dstport 4789 dev ens33 ip link set vxlan1 up ip addr add 192.168.100.1/24 dev vxlan1 node02\ntext 1 2 3 ip link add vxlan1 type vxlan id 1 remote 10.0.0.14 dstport 4789 dev eth0 ip link set vxlan1 up ip addr add 192.168.100.2/24 dev vxlan1 上述命令创建了一个类型为vxlan，名为vxlan1的网络接口，期后面的为配置这个网络设备的内容：\nid 1 类似CE设备的vxlan vni 10 设置的桥接域，只有相同的VNI之间可以直接进行二层通信。 dstport VTEP 通信的端口，这里会监听一个udp端口 remote 10.0.0.3 类似vni 10 head-end peer-list 2.2.2.2 用来设置隧道对端的 VTEP 地址，因为这里使用的为单播模式。 local 10.0.0.4 与 dev eth0 类似于 source 1.1.1.1 配置源VTEP的IP地址。 bash 1 2 3 4 5 6 7 8 9 10 $ tcpdump -np -i vxlan1 -vv tcpdump: listening on vxlan1, link-type EN10MB (Ethernet), snapshot length 262144 bytes 05:07:20.589942 ARP, Ethernet (len 6), IPv4 (len 4), Request who-has 192.168.100.1 tell 192.168.100.2, length 28 05:07:20.589963 ARP, Ethernet (len 6), IPv4 (len 4), Reply 192.168.100.1 is-at ca:21:c6:01:f9:d5, length 28 05:07:20.590509 IP (tos 0x0, ttl 64, id 26921, offset 0, flags [DF], proto ICMP (1), length 84) 192.168.100.2 \u003e 192.168.100.1: ICMP echo request, id 1225, seq 1, length 64 05:07:20.590525 IP (tos 0x0, ttl 64, id 1264, offset 0, flags [none], proto ICMP (1), length 84) 192.168.100.1 \u003e 192.168.100.2: ICMP echo reply, id 1225, seq 1, length 64 05:07:21.593791 IP (tos 0x0, ttl 64, id 27468, offset 0, flags [DF], proto ICMP (1), length 84) 抓包查看对应的数据包 [vxlan_linux.cap](......\\images\\vxlan in linux\\vxlan_linux.cap)\n清理数据\ntext 1 2 ip link set vxlan1 down ip link delete vxlan1 多播模式的 vxlan “多播”即“多点传送”(multicast)，也就是一台主机发出的包可以同时被其他多个有资格的主机接收，这台主机和那些有资格的主机就形成了一个组，他们在组内的通信是广播式的。多播的工作原理是，将一个网络上的某些主机的网卡设置成多播传送工作模式，指定其不过滤以某一个多播传送地址作为目的物理地址的数据帧，这样，这些主机的驱动程序中就可以同时接收以该多播传送地址作为目的物理地址的数据帧，而其他主机的驱动程序却接收不到，这些主机在逻辑上便形成了一个“多播”组。采用这种技术，相对广播而言，可有效减轻网络上“多播”组之外的其他主机的负担，因为发送给“多播”组的数据不会被传送到它们的驱动程序中去处理，避免资源的无谓浪费。\n多播的IP范围为：从224.0.0.0到239.255.255.255。能够接收发往一个特定多播组地址数据的主机集合称为主机组 (host group)。一个主机组可跨越多个网络。主机组中成员可随时加入或离开主机组。主机组中对主机的数量没有限制，同时不属于某一主机组的主机可以向该组发送信息。\n239.1.1.1 IIANA保留地址用于多播（多点传送）的IP，其mac地址为 01:00:5e:01:01:01(参考：组播地址)\n要组成同一个 vxlan 网络，vtep 必须能感知到彼此的存在。多播组本来的功能就是把网络中的某些节点组成一个虚拟的组。\n实验使用的为多播组组成一个虚拟的整体，通过多播组，组成可容纳多个主机组成 vxlan 网络\n图：muticast VxLAN in Linux bash 1 2 3 ip link add vxlan2 type vxlan id 10 group 239.1.1.1 dstport 4789 dev eth0 ip link set vxlan2 up ip addr add 192.168.100.10/24 dev vxlan2 node01\nbash 1 2 3 ip link add vxlan2 type vxlan id 10 group 239.1.1.1 dstport 4789 dev eth0 ip link set vxlan2 up ip addr add 192.168.100.20/24 dev vxlan2 FDB 是 Linux 网桥维护的一个二层转发表，用于保存远端虚拟机/容器的 MAC地址，远端 VTEP IP，以及 VNI 的映射关系，可以通过 bridge fdb 命令来对 FDB 表进行操作：\nvxlan接口在创建后，fdb只有一个表项，就是所有vxlan2的流量都发往多播组\ntext 1 2 3 4 5 $ bridge fdb 33:33:00:00:00:01 dev eth0 self permanent 01:00:5e:00:00:01 dev eth0 self permanent 01:00:5e:01:01:01 dev eth0 self permanent 00:00:00:00:00:00 dev vxlan2 dst 239.1.1.1 via eth0 self permanent 组播路由方式过程\n当发送ping 192.168.100.10时在同一个局域网内会先发送ARP广播，为组播方式，node1与node2（10.0.0.4）均受到广播，而node3（10.0.0.6）未受到 ARP报文要获得的内容为vxlan的mac地址，目的地址为全1的广播地址 vxlan隧道封装VNI=10，因为不知道目的地址，所以会发送多播报文 受到报文后进行解包，取出真实的报文，如果发现是自己的，经由隧道封装后传递 vtep 通过源报文学习到了 vtep 所在的主机，因此会直接单播发送给目的 vtep。发送方主机根据 VNI 把报文转发给 vtep，vtep 解包取出 ARP 应答报文，添加 arp 缓存到内核。并根据报文学习到目的 vtep 所在的主机地址，添加到 fdb 表中 而没在多播组中的同网段主机没有受到对应的ARP广播\n而在加入多播组中会受到多播的信息，确定不是自己后没有reply\n此实验的报文内容\n[192.168.10.30 加入同多播组](......\\images\\vxlan in linux\\10.30.cap)\n[192.168.10.20 发起端](......\\images\\vxlan in linux\\10.20.cap)\n[192.168.10.30 不在多播组内的报文](......\\images\\vxlan in linux\\10.30 exit multicast.cap)\n清除配置\nbash 1 2 ip link set vxlan2 down ip link delete vxlan2 实验一：Linux Bridge[L2] 该实验包含 veth, vlan, Linux bridge 方面的\n图：L2 vn topology\n加载vlan模块\nbash 1 2 3 4 5 6 modprobe 8021q ## 查看核心是否提供VLAN 功能 dmesg | grep -i 802 [ 1.592802] pci 0000:00:15.0: PME# supported from D0 D3hot D3cold [ 1755.995461] 8021q: 802.1Q VLAN Support v1.8 [ 1755.995485] 8021q: adding VLAN 0 to HW filter on device eth0 安装命令\nbash 1 2 yum install vconfig -y apt install vlan 创建vlan\nbash 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 # 创建bridge brctl addbr vlan10 brctl show ip link add veth01 type veth peer name eth01 ip link add veth02 type veth peer name eth02 # 将veth对的一端加入网桥 brctl addif vlan10 veth01 brctl addif vlan10 veth02 # 启动对应设备 ip link set dev vlan10 up ip link set dev veth01 up ip link set dev veth02 up ip link set dev eth01 up ip link set dev eth02 up # 创建ns ip netns add net1 ip netns add net2 # 将veth关联到对应名称空间内 ip link set eth01 netns net1 ip link set eth02 netns net2 网络名称空间net1内的操作，在vlan一端添加接口，与关联到该名称空间内的 veth 关联\ntext 1 2 3 4 5 6 7 8 9 vconfig add eth01 3001 vconfig add eth01 3002 ip link set eth01 up ip link set eth01.3001 up ip link set eth01.3002 up ip addr add 192.168.100.1/24 dev eth01.3001 ip addr add 192.168.100.2/24 dev eth01.3002 网络名称空间net2与net1的类似\ntext 1 2 3 4 5 6 7 8 9 vconfig add eth02 3001 vconfig add eth02 3002 ip link set dev eth02 up ip link set dev eth02.3001 up ip link set dev eth02.3002 up ip addr add 192.168.100.10/24 dev eth02.3001 ip addr add 192.168.100.11/24 dev eth02.3002 验证连通性，可以看到发送的包带有tag的标签\n实验二：IPVLAN L2 实验结果，通过namespace模拟Pod的网络，做到各Pod间的网络通讯。\nip netns list 查看网络命名空间\nip netns add net2 创建一个网络命名空间\nip link add link eth0 type ipvlan mode l2 在当前名称空间创建一个类型为IPVLAN L2模式的接口，将该接口关联至父接口eth0上。\nip link set $name netns $nsName 将接口加入到对应网络名称空间内\nip netns exec $nsName $cmd 在对应的网络名称空间内运行命令\n创建两个网络名称空间\nbash 1 2 3 4 5 $ ip netns add net1 $ ip netns add net2 $ ip netns list net2 net1 创建 IPVLAN 接口\nbash 1 2 3 4 5 $ ip link add ipvlan01 link eth0 type ipvlan mode l2 $ ip link add ipvlan02 link eth0 type ipvlan mode l2 $ ip link set ipvlan01 netns net1 $ ip link set ipvlan02 netns net2 给对应接口添加IP地址\nbash 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 ip netns exec net1 ifconfig ipvlan01 192.168.0.1/24 up ip netns exec net2 ifconfig ipvlan02 192.168.0.2/24 up # 这两个名称空间内的mac地址是一样的 $ ip netns exec net2 ifconfig ipvlan02: flags=4163 mtu 1500 inet 192.168.0.2 netmask 255.255.255.0 broadcast 192.168.0.255 inet6 fe80::da78:c800:27a:fb26 prefixlen 64 scopeid 0x20 ether da:78:c8:7a:fb:26 txqueuelen 1000 (Ethernet) RX packets 39007 bytes 2394577 (2.2 MiB) RX errors 0 dropped 27 overruns 0 frame 0 TX packets 11 bytes 866 (866.0 B) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 $ ip netns exec net1 ifconfig ipvlan01: flags=4163 mtu 1500 inet 192.168.0.1 netmask 255.255.255.0 broadcast 192.168.0.255 inet6 fe80::da78:c800:17a:fb26 prefixlen 64 scopeid 0x20 ether da:78:c8:7a:fb:26 txqueuelen 1000 (Ethernet) RX packets 132823 bytes 8184548 (7.8 MiB) RX errors 0 dropped 93 overruns 0 frame 0 TX packets 12 bytes 936 (936.0 B) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 测试两个名称空间是否互通\n结论：可以看到两个名称空间内的子接口 (sub-interface) 通过其父接口 (parent-interface) 可以达到互通。子接口与父接口之间的不互通。IPVLAN L2模式仅限于子接口之间的互通\nbash 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 $ ip netns exec net1 ping 192.168.0.2 PING 192.168.0.2 (192.168.0.2) 56(84) bytes of data. 64 bytes from 192.168.0.2: icmp_seq=1 ttl=64 time=0.285 ms 64 bytes from 192.168.0.2: icmp_seq=2 ttl=64 time=0.077 ms ^C --- 192.168.0.2 ping statistics --- 2 packets transmitted, 2 received, 0% packet loss, time 1027ms rtt min/avg/max/mdev = 0.077/0.181/0.285/0.104 ms $ ip netns exec net2 ping 192.168.0.1 PING 192.168.0.1 (192.168.0.1) 56(84) bytes of data. 64 bytes from 192.168.0.1: icmp_seq=1 ttl=64 time=0.051 ms 64 bytes from 192.168.0.1: icmp_seq=2 ttl=64 time=0.059 ms ^C --- 192.168.0.1 ping statistics --- 2 packets transmitted, 2 received, 0% packet loss, time 1056ms rtt min/avg/max/mdev = 0.051/0.055/0.059/0.004 ms 遇到问题\nRTNETLINK answers: Operation not supported： CentOS 7默认内核版本为3.10 IPVLAN 3.19开始支持，推荐内核为4.2+\n子接口ping父接口不通，源MAC与目标MAC是一致，而mac接口是mac地址与接口绑定，因为三个接口的mac地址都相同，此时区分不了是哪个接口。\nping公网地址不通，查看路由表中没有对外的路由，手动添加即可\nbash 1 2 ip netns exec net1 route -n ip netns exec net1 route add -net 0.0.0.0/0 gw 10.0.0.2 IPVLAN L2模式中，父接口是可以没有IP地址的。不影响子接口的使用\n清除所有网络名称空间\nbash 1 for n in $(ip netns list|awk '{print $1}');do ip netns del $n;done 实验三：IPVLAN L3 先创建两个用做测试的 network namespace\nbash 1 2 ip netns add net3 ip netns add net4 创建出 IPVLAN 的虚拟网卡接口，创建 IPVLAN 虚拟接口的命令和 MACVLAN 格式相同：\nbash 1 2 ip link add ipvl01 link ens33 type ipvlan mode l3 ip link add ipvl02 link ens33 type ipvlan mode l3 把 IPVLAN 接口放到前面创建好的 namespace 中\nbash 1 2 3 4 5 6 7 8 ip link set ipvl01 netns net3 ip link set ipvl02 netns net4 # 给对应设备设置IP地址 ip netns exec net3 ifconfig ipvl01 192.168.10.1/24 up ip netns exec net4 ifconfig ipvl02 192.168.20.1/24 up # 设置对应的路由 ip netns exec net4 route add -net 192.168.10.0/24 dev ipvl02 ip netns exec net3 route add -net 192.168.20.0/24 dev ipvl01 结果是可以通的\nbash 1 2 3 4 5 6 7 8 $ ip netns exec net3 ping 192.168.20.1 PING 192.168.20.1 (192.168.20.1) 56(84) bytes of data. 64 bytes from 192.168.20.1: icmp_seq=1 ttl=64 time=0.026 ms 64 bytes from 192.168.20.1: icmp_seq=2 ttl=64 time=0.119 ms ^C --- 192.168.20.1 ping statistics --- 2 packets transmitted, 2 received, 0% packet loss, time 1028ms rtt min/avg/max/mdev = 0.026/0.072/0.119/0.046 ms 实验四：MACVLAN 创建两个名称空间\nbash 1 2 ip netns add net1 ip netns add net2 创建两个 MACVLAN 接口\nbash 1 2 3 4 ip link add link eth0 name macv1 type macvlan mode bridge ip link add link eth0 name macv2 type macvlan mode bridge ## 持久化创建 echo \"ip link add eth0 eth0.1 address 52:54:00:cc:ee:aa link enp0s31f6 type macvlan\" \u003e /sbin/ifup-pre-local2 把 MACVLAN 接口放到前面创建好的 namespace 中\nbash 1 2 3 4 5 6 7 8 ip link set macv1 netns net1 ip link set macv2 netns net2 # 给对应设备设置IP地址 ip netns exec net1 ifconfig ipvl01 192.168.10.1/24 up ip netns exec net2 ifconfig ipvl02 192.168.20.1/24 up # 设置对应的路由 ip netns exec net1 route add -net 192.168.10.0/24 dev ipvl02 ip netns exec net2 route add -net 192.168.20.0/24 dev ipvl01 可以看到两个网卡的MAC地址是不同的\nbash 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 $ ip netns exec net2 ifconfig macv2: flags=4163 mtu 1500 inet 192.168.10.1 netmask 255.255.255.0 broadcast 192.168.10.255 inet6 fe80::a830:c9ff:fe9a:7c33 prefixlen 64 scopeid 0x20 ether aa:30:c9:9a:7c:33 txqueuelen 1000 (Ethernet) RX packets 0 bytes 0 (0.0 B) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 7 bytes 586 (586.0 B) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 $ ip netns exec net1 ifconfig macv1: flags=4163 mtu 1500 inet 192.168.10.1 netmask 255.255.255.0 broadcast 192.168.10.255 inet6 fe80::d448:c5ff:fec7:76a3 prefixlen 64 scopeid 0x20 ether d6:48:c5:c7:76:a3 txqueuelen 1000 (Ethernet) RX packets 0 bytes 0 (0.0 B) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 8 bytes 656 (656.0 B) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 Reference [1] man veth\n[2] macvlan\n[3] how to configure macvlan interface for getting the IP?\n[4] distribution switch\n[5] why vxlan is needed\n[4] distribution switch\n","wordCount":"2013","inLanguage":"zh","datePublished":"2021-01-18T00:00:00Z","dateModified":"2023-03-22T23:00:36+08:00","author":{"@type":"Person","name":"cylon"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.oomkill.com/2021/01/virtual-networking/"},"publisher":{"@type":"Organization","name":"Cylon's Collection","logo":{"@type":"ImageObject","url":"https://www.oomkill.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.oomkill.com/><img src=https://www.oomkill.com/favicon.ico alt aria-label=logo height=20>Cylon's Collection</a><div class=logo-switches><button id=theme-toggle><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://www.oomkill.com/archives><span>归档</span></a></li><li><a href=https://www.oomkill.com/tags><span>标签</span></a></li><li><a href=https://www.oomkill.com/search><span>搜索</span></a></li><li><a href=https://www.oomkill.com/about accesskey=/><span>关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Linux虚拟网络技术</h1><div class=post-meta><span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar" style="user-select:text"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" style="user-select:text"/><line x1="16" y1="2" x2="16" y2="6" style="user-select:text"/><line x1="8" y1="2" x2="8" y2="6" style="user-select:text"/><line x1="3" y1="10" x2="21" y2="10" style="user-select:text"/></svg><span>2021-01-18</span></span>&nbsp;·&nbsp;<span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text" style="user-select:text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z" style="user-select:text"/><polyline points="14 2 14 8 20 8" style="user-select:text"/><line x1="16" y1="13" x2="8" y2="13" style="user-select:text"/><line x1="16" y1="17" x2="8" y2="17" style="user-select:text"/><polyline points="10 9 9 9 8 9" style="user-select:text"/></svg><span>2013 字</span></span>&nbsp;·&nbsp;<span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><span>10 分钟</span></span>
<span class=pe-post-meta-item>&nbsp;·&nbsp;<svg t="1714036239378" fill="currentcolor" class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="6659" width="256" height="256"><path d="M690 78.2c-18.6-18.8-49-19-67.8-.4s-19 49-.4 67.8l255.4 258.6c67.8 68.6 67.8 178.8.0 247.4L653.4 878.2c-18.6 18.8-18.4 49.2.4 67.8s49.2 18.4 67.8-.4l224-226.4c104.8-106 104.8-276.4.0-382.4L690 78.2zM485.4 101.4c-24-24-56.6-37.4-90.6-37.4H96C43 64 0 107 0 160v299c0 34 13.4 66.6 37.4 90.6l336 336c50 50 131 50 181 0l267-267c50-50 50-131 0-181l-336-336zM96 160h299c8.4.0 16.6 3.4 22.6 9.4l336 336c12.4 12.4 12.4 32.8.0 45.2l-267 267c-12.4 12.4-32.8 12.4-45.2.0l-336-336c-6-6-9.4-14.2-9.4-22.6V160zm192 128a64 64 0 10-128 0 64 64 0 10128 0z" p-id="6660"/></svg></span><ul class=pe-post-meta-item><a href=https://www.oomkill.com/tags/network/>#Network</a>
<a href=https://www.oomkill.com/tags/kubernetes-network/>#Kubernetes Network</a></ul>&nbsp;·&nbsp;<span id=busuanzi_container_page_pv>本文阅读量 <span id=busuanzi_value_page_pv></span> 次</span></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details><summary><span class=details>目录</span></summary><div class=inner><ul><li><a href=#overview aria-label=Overview>Overview</a><li><a href=#vlan aria-label=VLAN>VLAN</a><li><a href=#veth-supa-href11asup aria-label="VETH [1]">VETH <sup><a href=#1>[1]</a></sup></a><li><a href=#bridge aria-label=Bridge>Bridge</a><li><a href=#%e7%9b%ae%e7%9a%84 aria-label=目的>目的</a><li><a href=#macvlan-supa-href22asup aria-label="MACVLAN [2]">MACVLAN <sup><a href=#2>[2]</a></sup></a><ul><li><a href=#macvlan%e7%9a%84%e9%99%90%e5%88%b6 aria-label=MACVLAN的限制>MACVLAN的限制</a><li><a href=#macvlan%e7%9a%84%e6%a8%a1%e5%bc%8f aria-label=MACVLAN的模式>MACVLAN的模式</a><ul><li><a href=#private-mode aria-label="Private mode">Private mode</a><li><a href=#vpea-mode aria-label="VPEA mode">VPEA mode</a><li><a href=#bridge-mode aria-label="Bridge mode">Bridge mode</a><li><a href=#passthru aria-label=Passthru>Passthru</a><li><a href=#source aria-label=Source>Source</a></ul></ul><li><a href=#ipvlan aria-label=IPVLAN>IPVLAN</a><ul><li><a href=#ipvlan-modes aria-label="IPVLAN modes">IPVLAN modes</a><ul><li><a href=#l2 aria-label=L2>L2</a><li><a href=#l3 aria-label=L3>L3</a></ul><li><a href=#ipvlan%e4%b8%8emacvlan%e5%a6%82%e4%bd%95%e9%80%89%e6%8b%a9 aria-label=IPVLAN与MACVLAN如何选择>IPVLAN与MACVLAN如何选择</a></ul><li><a href=#vxlan aria-label=VxLAN>VxLAN</a><ul><li><a href=#vxlan-introduction aria-label="VxLAN Introduction">VxLAN Introduction</a><ul><li><a href=#%e4%b8%ba%e4%bb%80%e4%b9%88%e5%b0%86-vxlan-%e8%a7%86%e4%b8%bal2%e7%bd%91%e7%bb%9c%e5%91%a2 aria-label="为什么将 VxLAN 视为L2网络呢？">为什么将 <em><strong>VxLAN</strong></em> 视为L2网络呢？</a><li><a href=#vni aria-label=VNI>VNI</a><li><a href=#vept aria-label=VEPT>VEPT</a><li><a href=#preliminary-knowledge-%e4%b8%89%e5%b1%82%e5%88%86%e7%ba%a7%e7%bd%91%e7%bb%9c-supa-href44asup aria-label="Preliminary knowledge 三层分级网络 [4]">Preliminary knowledge 三层分级网络 <sup><a href=#4>[4]</a></sup></a><ul><li><a href=#%e4%b8%89%e5%b1%82%e5%88%86%e7%ba%a7%e7%bd%91%e7%bb%9c aria-label=三层分级网络?>三层分级网络?</a></ul><li><a href=#%e4%b8%ba%e4%bb%80%e4%b9%88%e9%9c%80%e8%a6%81vxlan-supa-href55asup aria-label="为什么需要VxLAN [5]">为什么需要VxLAN <sup><a href=#5>[5]</a></sup></a></ul><li><a href=#vxlan-in-linux aria-label="VxLAN in Linux">VxLAN in Linux</a><ul><li><a href=#linux%e5%ae%9e%e7%8e%b0vxlan%e7%bd%91%e7%bb%9c aria-label=linux实现VxLAN网络>linux实现VxLAN网络</a><li><a href=#%e5%a4%9a%e6%92%ad%e6%a8%a1%e5%bc%8f%e7%9a%84-vxlan aria-label="多播模式的 vxlan">多播模式的 vxlan</a></ul></ul><li><a href=#%e5%ae%9e%e9%aa%8c%e4%b8%80linux-bridgel2 aria-label="实验一：Linux Bridge[L2]">实验一：Linux Bridge[L2]</a><li><a href=#%e5%ae%9e%e9%aa%8c%e4%ba%8cipvlan-l2 aria-label="实验二：IPVLAN L2">实验二：IPVLAN L2</a><ul><li><a href=#%e5%ae%9e%e9%aa%8c%e4%b8%89ipvlan-l3 aria-label="实验三：IPVLAN L3">实验三：IPVLAN L3</a><li><a href=#%e5%ae%9e%e9%aa%8c%e5%9b%9bmacvlan aria-label=实验四：MACVLAN>实验四：MACVLAN</a></ul><li><a href=#reference aria-label=Reference>Reference</a></li></div></details></div></aside><script src=/js/pe-toc.min.445eb1bfc5e85dd13b9519fcc2a806522e9629b6224a2974052789ba00ab78af.js integrity="sha256-RF6xv8XoXdE7lRn8wqgGUi6WKbYiSil0BSeJugCreK8="></script><div class=post-content><h2 id=overview>Overview<a hidden class=anchor aria-hidden=true href=#overview>#</a></h2><p>本文将介绍Kubernetes中使用的相关虚拟网络功能，目的是为了任何无相关网络背景经历的人都可以了解这些技术在kubernetes中式如何应用的。</p><h2 id=vlan>VLAN<a hidden class=anchor aria-hidden=true href=#vlan>#</a></h2><p><em><strong>VLAN</strong></em> (Virtual local area networks)是逻辑上的LAN而不受限于同一物理网络交换机上。同样的VLAN也可以将同一台交换机/网桥下的设备/划分为不同的子网。</p><p><em><strong>VLAN</strong></em> 区分的广播域的标准是VLAN ID，此功能是Linux内核3.8中引入的</p><p>在Linux中创建一个VLAN</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ip link add link eth0 name eth0.2 <span class=nb>type</span> vlan id <span class=m>2</span></span></span></code></pre></td></tr></table></div></div></div></div><h2 id=veth-supa-href11asup>VETH <sup><a href=#1>[1]</a></sup><a hidden class=anchor aria-hidden=true href=#veth-supa-href11asup>#</a></h2><p><em><strong>VETH</strong></em> (Virtual Ethernet device)，是一个本地的以太网隧道，创建出的设备是成对的，通常会存在两个名称空间内，例如在docker中创建出的设备一端在root名称空间内，一端被挂在到容器的名称空间内。</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/1tOiYnJv7sx0twVBJGX_zgg.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/1tOiYnJv7sx0twVBJGX_zgg.png#center alt=img onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><center>图：veth topology</center><center><em>Source：</em>https://medium.com/@arpitkh96/basics-of-container-networking-with-linux-part-1-3a3cdc64c87a</center><br><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ip link add &lt;p1-name&gt; <span class=nb>type</span> veth peer name &lt;p2-name&gt;</span></span></code></pre></td></tr></table></div></div></div></div><h2 id=bridge>Bridge<a hidden class=anchor aria-hidden=true href=#bridge>#</a></h2><h2 id=目的>目的<a hidden class=anchor aria-hidden=true href=#目的>#</a></h2><p>Linux <strong>bridge</strong>（又称为网桥、VLAN交换机）是Linux内核中集成的功能，用来做tcp/ip做二层协议交换的设备，虽然是软件实现的，但它与普通的二层物理交换机功能一样。<em><strong>bridge</strong></em> 就是为了解决虚拟机网卡连接问题。可以添加若干个网络设备到 <em><strong>bridge</strong></em> 上作为其接口，添加到 <em><strong>bridge</strong></em> 上的设备被设置为只接受二层数据帧并且转发所有收到的数据包到 <em><strong>bridge</strong></em> 中。</p><p>由于 Linux <em><strong>bridge</strong></em> 是二层设备，故数据包是根据MAC地址而不是IP转发的。因此所有协议都可以透明地通过网桥。Linux <em><strong>bridge</strong></em> 广泛用于虚拟机，名称空间等。</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/1NZpkyrCpcQMxkUHNsNtFVA.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/1NZpkyrCpcQMxkUHNsNtFVA.png#center alt=img onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><center>图：Linux Bridge</center><center><em>Source：</em>https://kbespalov.medium.com/linux-linux-bridge-7e0e887edd01</center><br><h2 id=macvlan-supa-href22asup>MACVLAN <sup><a href=#2>[2]</a></sup><a hidden class=anchor aria-hidden=true href=#macvlan-supa-href22asup>#</a></h2><p><em><strong>MACVLAN</strong></em> 允许在一个物理接口创建多个子接口，并且每个子接口都拥有一个随机生成的MAC地址，与IP地址。</p><p><em><strong>MACVLAN</strong></em> 中子接口不能与与父接口直接通讯，例如在虚拟化环境中，容器是不能ping通宿主机的IP，如果子接口需要和父接口进行通讯，需要将子接口分配给父接口。</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/linux-macvlan.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/linux-macvlan.png#center alt="Linux macvlan" onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><center>图：MACVLAN</center><center><em>Source：</em>https://hicu.be/bridge-vs-macvlan</center><br><p>从 Linux 内核3.0起，MAC已经是linux内核中的一部分。</p><ul><li><p>查看内核是否加载 <code>lsmod | grep macvlan</code></p></li><li><p>加载macvlan模块 <code>modprobe macvlan</code></p></li><li><p>如果需要每次启动时都加载该模块，<code>echo "macvlan" >> /etc/modules</code></p></li></ul><h3 id=macvlan的限制>MACVLAN的限制<a hidden class=anchor aria-hidden=true href=#macvlan的限制>#</a></h3><p>限制：</p><ul><li>使用MACVLAN技术需要开启网卡的混杂模式</li><li>授予NIC支持的MAC数量限制，超出限制会影响性能</li><li>MACVLAN不能工作在wireless网络环境中 <sup><a href=#3>[3]</a></sup></li></ul><h3 id=macvlan的模式>MACVLAN的模式<a hidden class=anchor aria-hidden=true href=#macvlan的模式>#</a></h3><p>MACVLAN又五种类型：</p><ul><li>Private</li><li>VEPA</li><li>Bridge</li><li>Passthru</li><li>Source</li></ul><h4 id=private-mode>Private mode<a hidden class=anchor aria-hidden=true href=#private-mode>#</a></h4><p>Private模式下的同一物理接口下的子接口将不允许通讯，即使物理设备支持hairpin也不行。</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/linux-macvlan-private-mode.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/linux-macvlan-private-mode.png#center alt="Macvlan 私有模式" onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><center>图：MACVLAN Private mod</center><center><em>Source：</em>https://hicu.be/bridge-vs-macvlan</center><br><blockquote><p><em><strong>hairpin</strong></em> 有多个名称，<em><strong>U-turn NAT</strong></em>, <em><strong>NAT loopback</strong></em>，实际上就是一种网络转换，在一个网络中的两个设备使用外部IP进行通讯。在MACVLAN这个例子中，veth1发往veth2的流量通过外部设备switch进行一个回转，这个行为称为为 <em><strong>hairpin turn</strong></em>。从上图也可以看出，是一个U形的转换。</p></blockquote><h4 id=vpea-mode>VPEA mode<a hidden class=anchor aria-hidden=true href=#vpea-mode>#</a></h4><p><em><strong>VPEA</strong></em> 将会将来自子接口的通过父接口转发，这将要求物理交换机需要支持 <em><strong>hairpin</strong></em></p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/linux-macvlan-802.1qbg-vepa-mode.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/linux-macvlan-802.1qbg-vepa-mode.png#center alt="Macvlan 802.1qbg VEPA 模式" onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><center>图：MACVLAN VPEA mode</center><center><em>Source：</em>https://hicu.be/bridge-vs-macvlan</center><br><h4 id=bridge-mode>Bridge mode<a hidden class=anchor aria-hidden=true href=#bridge-mode>#</a></h4><p><em><strong>Bridge</strong></em> 是指父接口与所有子接口是通过网桥相连的，因为连接在网桥上，不需要学习MAC地址。这也是容器网络中常用到的模式</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/linux-macvlan-bridge-mode.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/linux-macvlan-bridge-mode.png#center alt="Macvlan 桥接模式" onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><center>图：MACVLAN bridge mode</center><center><em>Source：</em>https://hicu.be/bridge-vs-macvlan</center><br><h4 id=passthru>Passthru<a hidden class=anchor aria-hidden=true href=#passthru>#</a></h4><p><em><strong>passthru</strong></em> 是 pass through，由名字也可以得知，是指允许单个VM与物理接口连接。</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/linux-macvlan-passthru-mode.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/linux-macvlan-passthru-mode.png#center alt="Macvlan 直通模式" onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><center>图：MACVLAN passthru mode</center><center><em>Source：</em>https://hicu.be/bridge-vs-macvlan</center><br><h4 id=source>Source<a hidden class=anchor aria-hidden=true href=#source>#</a></h4><p>这个模式是Linux中的一个 Patch，是流量仅允许被允许的MAC地址列表</p><h2 id=ipvlan>IPVLAN<a hidden class=anchor aria-hidden=true href=#ipvlan>#</a></h2><p>IPVLAN与MACVLAN类似，只有一个不同的地方是，IPVLAN所有的MAC地址都是一样的，就是使用相同的MAC地址去创建子接口。</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/linux-ipvlan.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/linux-ipvlan.png#center alt="Linux Ipvlan" onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><center>图：IPVLAN</center><center><em>Source：</em>https://hicu.be/bridge-vs-macvlan</center><br><h3 id=ipvlan-modes>IPVLAN modes<a hidden class=anchor aria-hidden=true href=#ipvlan-modes>#</a></h3><p>在使用IPVLAN时，只能选择下面两种模式中的一种，选择后，所有的子节接口将工作在这个模式下。</p><h4 id=l2>L2<a hidden class=anchor aria-hidden=true href=#l2>#</a></h4><p><em><strong>IPVLAN</strong></em> L2模式与 <em><strong>MACVLAN</strong></em> 的 <em><strong>brigde</strong></em> 模式工作原理很相似，父接口是作为交换机的角色，同一个物理接口上的子接口可以通过父接口来转发数据，而如果要发送数据到其他的网络，报文则会通过父接口的路由转发出去。</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/linux-ipvlan-l2-mode.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/linux-ipvlan-l2-mode.png#center alt="Linux Ipvlan - L2 模式" onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><center>图：IPVLAN L2</center><center><em>Source：</em>https://hicu.be/bridge-vs-macvlan</center><br><blockquote><p>Notes: IPVLAN 是 linux kernel 比较新的特性，linux kernel 3.19 开始支持 ipvlan，但是比较稳定推荐的版本是 >=4.2</p></blockquote><h4 id=l3>L3<a hidden class=anchor aria-hidden=true href=#l3>#</a></h4><p>在 <em><strong>L3</strong></em> 模式下也就是 物理接口 是作为路由器，这种情况下就要求子接口之间需要处在不同子网中才可以。因为广播域是 <em><strong>L2</strong></em> 的，所以 <em><strong>IPVLAN L3</strong></em> 不支持多播和广播。</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/linux-ipvlan-l3-mode-1.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/linux-ipvlan-l3-mode-1.png#center alt="Linux Ipvlan - L3 模式" onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><center>图：IPVLAN L3</center><center><em>Source：</em>https://hicu.be/bridge-vs-macvlan</center><br><h3 id=ipvlan与macvlan如何选择>IPVLAN与MACVLAN如何选择<a hidden class=anchor aria-hidden=true href=#ipvlan与macvlan如何选择>#</a></h3><ul><li>在于<em><strong>MACVLAN</strong></em>在wireless环境中的不友好，wireless选择 <em><strong>IPVLAN</strong></em></li><li>对于外部设备有MAC地址限制的，或者混杂模式限制NIC性能</li></ul><h2 id=vxlan>VxLAN<a hidden class=anchor aria-hidden=true href=#vxlan>#</a></h2><h3 id=vxlan-introduction>VxLAN Introduction<a hidden class=anchor aria-hidden=true href=#vxlan-introduction>#</a></h3><p><em><strong>VxLAN</strong></em> (Virtual eXtensible Local Area Network) 是一种 <code>MAC-over-IP</code> 或者称为 UDP隧道机制，本质上来说是使用网络隧道技术将L3网络扩展为一个L2网络。</p><h4 id=为什么将-vxlan-视为l2网络呢>为什么将 <em><strong>VxLAN</strong></em> 视为L2网络呢？<a hidden class=anchor aria-hidden=true href=#为什么将-vxlan-视为l2网络呢>#</a></h4><p>虽说 <em><strong>VxLAN</strong></em> 是将L2的以太网帧封装到UDP报文中（L2 over L4）中，并在L3网络中传输。但是 <em><strong>VxLAN</strong></em> 最终是基于 <em><strong>MAC</strong></em> 地址的二层网络（可以无需路由设备），而不像 <em><strong>IPIP</strong></em> 的隧道技术网络通讯是基于路由的。</p><p>下图是一个使用 <em><strong>VxLAN</strong></em> 技术的网络拓扑，整个篮筐部分可以视为一个二层的虚拟交换机，连接的各设备都可以直连。</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/download-16615328145948.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/download-16615328145948.png#center alt=img onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><center>图：VXLAN tunneling technology</center><center><em>Source：</em>https://support.huawei.com/enterprise/en/doc/EDOC1100086966</center><br><h4 id=vni>VNI<a hidden class=anchor aria-hidden=true href=#vni>#</a></h4><p><em><strong>VNI</strong></em> (VXLAN Network Identifier) 是类似于VLAN ID的标识符，不同的<em><strong>VNI</strong></em> 之间不能进行二层通讯</p><h4 id=vept>VEPT<a hidden class=anchor aria-hidden=true href=#vept>#</a></h4><p><em><strong>VTEP</strong></em> (VxLAN tunnel endpoint) 是指数据包封包与解包的实体，<em><strong>VTEP</strong></em> 既可以是一台独立的网络设备，也可以是一个基于软件的虚拟交换机。当源服务器发出包时，会在 <em><strong>VTEP</strong></em> 上封装成 <em><strong>VxLAN</strong></em> 格式的报文；当传送到对端时，会在对端的 <em><strong>VTEP</strong></em> 进行解包</p><p>下图是一个VxLAN网络拓扑图，其中建立隧道的两端就是 <em><strong>VTEP</strong></em>，这里的 <em><strong>VTEP</strong></em> 是两台 TOR 交换机，通过两个 <em><strong>VTEP</strong></em> 来对数据包的解封装。</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/download-16615321616635.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/download-16615321616635.png#center alt=img onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><center>图：VXLAN network model</center><center><em>Source：</em>https://support.huawei.com/enterprise/en/doc/EDOC1100086966</center><br><p>下图是Linux <em><strong>VxLAN</strong></em> 类型的网络拓扑，<em><strong>VTEP</strong></em> 可以理解为是一种网络接口，通过该接口与内核功能进行解封包，而实际的流量也是通过物理设备进行传输。</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/vxlan%20in%20linux.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/vxlan%20in%20linux.png#center alt="vxlan in linux" onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><center>图：VxLAN in Linux</center><h4 id=preliminary-knowledge-三层分级网络-supa-href44asup>Preliminary knowledge 三层分级网络 <sup><a href=#4>[4]</a></sup><a hidden class=anchor aria-hidden=true href=#preliminary-knowledge-三层分级网络-supa-href44asup>#</a></h4><h5 id=三层分级网络>三层分级网络?<a hidden class=anchor aria-hidden=true href=#三层分级网络>#</a></h5><p>思科的三层分级网络(<em><strong>three-layer hierarchical model</strong></em>) 包含三层：</p><ul><li>核心层 (<em><strong>Core</strong></em>)：网络骨干，提供不同分布层之间的高速连接和最优传送路径</li><li>分布层 (<em><strong>distribution</strong></em>) 将连接接入层到核心层，并且实施安全，流量负载和路由相关的策略</li><li>接入层 (<em><strong>access</strong></em>) 为用户终端初始网络的接入点。</li></ul><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/distribution-layer-diagram-1621937301-ES7wiU19cL.jpg><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/distribution-layer-diagram-1621937301-ES7wiU19cL.jpg#center alt=img onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><center>图：three-layer hierarchical model</center><center><em>Source：</em>https://community.fs.com/blog/how-to-choose-the-right-distribution-switch.html</center><br><h4 id=为什么需要vxlan-supa-href55asup>为什么需要VxLAN <sup><a href=#5>[5]</a></sup><a hidden class=anchor aria-hidden=true href=#为什么需要vxlan-supa-href55asup>#</a></h4><p>下图是一个 <em><strong>CSP</strong></em> (Cloud Service Provider ) 的 <em><strong>DC</strong></em> 网络，</p><ul><li>接入层：48口交换机20个</li><li>分布层：两台分布式交换机，共同组成一个虚拟化交换机。默认网关位于分布式交换机中。</li><li>核心层：两个核心交换机</li></ul><blockquote><p>Notes：工作在分布层的交换机被称为分布式交换机 (<em><strong>Distribution Switch</strong></em>)，分布式交换机会将来自访问层的流量转发至核心层，并提供一些连接策略。</p></blockquote><p>每台接入交换机连接48台物理服务器。这些服务器中的每一个都包含五个不同的租户，它们拥有自己的虚拟路由 (VRF)。一个租户由三个广播域组成：<code>Presiontation</code>， <code>Application</code> 和 <code>Database</code> ，每层都是互备的。在管理租户时，可以定义 <em><strong>VLAN ID</strong></em>、虚拟机的 <em><strong>MAC</strong></em> 地址和 <em><strong>IP</strong></em> 地址。虚拟机时可移动的，存在如下信息：</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/Figure1-1_Topology.jpeg><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/Figure1-1_Topology.jpeg#center alt=img onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><center>图：CSP DC network</center><center><em>Source：</em>https://nwktimes.blogspot.com/2018/02/vxlan-part-i-why-vxlan-is-needed.html</center><br><p>通过上述信息可以得知有如下：</p><ul><li>服务器：$20\times48=960$, 20为ToR交换机数量，48为每个ToR的接口</li><li>虚拟机/MAC地址/ARP：28800个虚拟机（每个物理机30个虚拟机）</li><li>广播域：每个租户+每个租户的VLAN+所拥有的物理机，$5\times3\times960=14400$</li><li>VRF：4800，5个租户+960个虚拟机</li></ul><p>在这种网络中存在的挑战如下：</p><ul><li><strong>VLAN ID的限制</strong>，通常来说VLAN ID只有12位，4096个，这意味着不够用</li><li><strong>多租户</strong>，多租户场景下，广播域等都是用户自己定义的，此时可能发生客户定义的ID为相同的</li><li><strong>MAC表大小限制</strong>，在一个租户下有28800个机器，意味着交换机MAC地址表存放28800个MAC地址。会出现老化过程。（Notes：<em>Cisco Nexus 9500/9300</em> 系列支持90000个MAC地址表）</li><li><strong>APR表大小限制</strong>，分布式交换机中存在超过28800条MAC-IP的数量（ Notes：<em>Cisco Nexus 9500</em>系列交换机支持 60,000 个 IPv4 ARP 和 30,000 个 IPv6 ND）</li><li><strong>生成树协议</strong>，在这种网络拓扑结构下，由于 STP 不支持链路之间的负载均衡，因此某些链路可能不会用于流量传输，这种情况下使带宽利用率下降。</li></ul><p>由于 <em><strong>VxLAN</strong></em> 通过L3建立隧道，因此不需要生成树协议。在基于 <em><strong>VxLAN</strong></em> 技术的 DC 中，VLAN将不再具有意义，因为 VLAN 是交换机甚至交换机端口特定的。</p><p>在基于 <em><strong>VxLAN</strong></em> <em><strong>Leaf-Spine</strong></em> 的网络架构中，通过将网络压缩为一个L2的网络架构，所有的节点在访问其他节点时，都将仅需要两部，因此除了Leaf交换机之外，其余并不清楚虚拟机的MAC地址。</p><p>下图是<em><strong>Leaf-Spine</strong></em>网络拓扑图， 在该架构中，每个较低级别的接入（leaf）交换机都以全网状连接到每个较高级别的核心（spine）交换机。</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/Tripp_Lite_3.2.width-880.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/Tripp_Lite_3.2.width-880.png#center alt="Tripp 精简版 3.2.png" onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><center>图：spine-leaf network</center><center><em>Source：</em>https://www.datacenterdynamics.com/en/marketwatch/spine-and-leaf-network-architecture-explained/</center><br><h3 id=vxlan-in-linux>VxLAN in Linux<a hidden class=anchor aria-hidden=true href=#vxlan-in-linux>#</a></h3><p>Linux 对 VxLAN 协议的支持时间并不久，2012 年 Stephen Hemminger 才把相关的工作合并到 kernel 中，并最终出现在 kernel 3.7.0 版本。为了稳定性和很多的功能，你可以会看到某些软件推荐在 3.9.0 或者 3.10.0 以后版本的 kernel 上使用 vxlan。</p><h4 id=linux实现vxlan网络>linux实现VxLAN网络<a hidden class=anchor aria-hidden=true href=#linux实现vxlan网络>#</a></h4><p>两台机器构成一个VxLAN网络，每台机器上有一个 VTEP，VTEP 通过它们的 IP 互相通信。</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/vxlan%20in%20linux.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/vxlan%20in%20linux.png#center alt="vxlan in linux" onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><center>图：VxLAN in Linux</center><p>这个图创建的VxLAN0设备模拟了VTEP隧道端点，实现了一个大二层域，突破了虚拟化网络的物理界限。</p><p>node01</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ip link add vxlan1 <span class=nb>type</span> vxlan id <span class=m>1</span> remote 10.0.0.3 dstport <span class=m>4789</span> dev ens33
</span></span><span class=line><span class=cl>ip link <span class=nb>set</span> vxlan1 up
</span></span><span class=line><span class=cl>ip addr add 192.168.100.1/24 dev vxlan1</span></span></code></pre></td></tr></table></div></div></div></div><p>node02</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>text</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>ip link add vxlan1 type vxlan id 1 remote 10.0.0.14 dstport 4789 dev eth0
</span></span><span class=line><span class=cl>ip link set vxlan1 up
</span></span><span class=line><span class=cl>ip addr add 192.168.100.2/24 dev vxlan1</span></span></code></pre></td></tr></table></div></div></div></div><p>上述命令创建了一个类型为vxlan，名为vxlan1的网络接口，期后面的为配置这个网络设备的内容：</p><ul><li><code>id 1</code> 类似CE设备的<code>vxlan vni 10</code> 设置的桥接域，只有相同的VNI之间可以直接进行二层通信。</li><li><code>dstport</code> VTEP 通信的端口，这里会监听一个udp端口</li><li><code>remote 10.0.0.3</code> 类似<code>vni 10 head-end peer-list 2.2.2.2</code> 用来设置隧道对端的 VTEP 地址，因为这里使用的为单播模式。</li><li><code>local 10.0.0.4</code> 与 <code>dev eth0</code> 类似于 <code>source 1.1.1.1</code> 配置源VTEP的IP地址。</li></ul><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ tcpdump -np -i vxlan1 -vv
</span></span><span class=line><span class=cl>tcpdump: listening on vxlan1, link-type EN10MB <span class=o>(</span>Ethernet<span class=o>)</span>, snapshot length <span class=m>262144</span> bytes
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>05:07:20.589942 ARP, Ethernet <span class=o>(</span>len 6<span class=o>)</span>, IPv4 <span class=o>(</span>len 4<span class=o>)</span>, Request who-has 192.168.100.1 tell 192.168.100.2, length <span class=m>28</span>
</span></span><span class=line><span class=cl>05:07:20.589963 ARP, Ethernet <span class=o>(</span>len 6<span class=o>)</span>, IPv4 <span class=o>(</span>len 4<span class=o>)</span>, Reply 192.168.100.1 is-at ca:21:c6:01:f9:d5, length <span class=m>28</span>
</span></span><span class=line><span class=cl>05:07:20.590509 IP <span class=o>(</span>tos 0x0, ttl 64, id 26921, offset 0, flags <span class=o>[</span>DF<span class=o>]</span>, proto ICMP <span class=o>(</span>1<span class=o>)</span>, length 84<span class=o>)</span>
</span></span><span class=line><span class=cl>    192.168.100.2 &gt; 192.168.100.1: ICMP <span class=nb>echo</span> request, id 1225, seq 1, length <span class=m>64</span>
</span></span><span class=line><span class=cl>05:07:20.590525 IP <span class=o>(</span>tos 0x0, ttl 64, id 1264, offset 0, flags <span class=o>[</span>none<span class=o>]</span>, proto ICMP <span class=o>(</span>1<span class=o>)</span>, length 84<span class=o>)</span>
</span></span><span class=line><span class=cl>    192.168.100.1 &gt; 192.168.100.2: ICMP <span class=nb>echo</span> reply, id 1225, seq 1, length <span class=m>64</span>
</span></span><span class=line><span class=cl>05:07:21.593791 IP <span class=o>(</span>tos 0x0, ttl 64, id 27468, offset 0, flags <span class=o>[</span>DF<span class=o>]</span>, proto ICMP <span class=o>(</span>1<span class=o>)</span>, length 84<span class=o>)</span></span></span></code></pre></td></tr></table></div></div></div></div><p>抓包查看对应的数据包 [vxlan_linux.cap](......\images\vxlan in linux\vxlan_linux.cap)</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20210203232317906.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20210203232317906.png#center alt=image-20210203232317906 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><p>清理数据</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>text</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>ip link set vxlan1 down
</span></span><span class=line><span class=cl>ip link delete vxlan1</span></span></code></pre></td></tr></table></div></div></div></div><h4 id=多播模式的-vxlan>多播模式的 vxlan<a hidden class=anchor aria-hidden=true href=#多播模式的-vxlan>#</a></h4><p>“多播”即“多点传送”(multicast)，也就是一台主机发出的包可以同时被其他多个有资格的主机接收，这台主机和那些有资格的主机就形成了一个组，他们在组内的通信是广播式的。多播的工作原理是，将一个网络上的某些主机的网卡设置成多播传送工作模式，指定其不过滤以某一个多播传送地址作为目的物理地址的数据帧，这样，这些主机的驱动程序中就可以同时接收以该多播传送地址作为目的物理地址的数据帧，而其他主机的驱动程序却接收不到，这些主机在逻辑上便形成了一个“多播”组。采用这种技术，相对广播而言，可有效减轻网络上“多播”组之外的其他主机的负担，因为发送给“多播”组的数据不会被传送到它们的驱动程序中去处理，避免资源的无谓浪费。</p><p>多播的IP范围为：从224.0.0.0到239.255.255.255。能够接收发往一个特定多播组地址数据的主机集合称为主机组 (host group)。一个主机组可跨越多个网络。主机组中成员可随时加入或离开主机组。主机组中对主机的数量没有限制，同时不属于某一主机组的主机可以向该组发送信息。</p><p><code>239.1.1.1</code> IIANA保留地址用于多播（多点传送）的IP，其mac地址为 <code>01:00:5e:01:01:01</code>(参考：<a href=https://blog.51cto.com/361531/891466 target=_blank rel="noopener nofollow noreferrer">组播地址</a>)</p><p>要组成同一个 vxlan 网络，vtep 必须能感知到彼此的存在。多播组本来的功能就是把网络中的某些节点组成一个虚拟的组。</p><p>实验使用的为多播组组成一个虚拟的整体，通过多播组，组成可容纳多个主机组成 vxlan 网络</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20210203232408799.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20210203232408799.png#center alt=image-20210203232408799 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><center>图：muticast VxLAN in Linux</center><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ip link add vxlan2 <span class=nb>type</span> vxlan id <span class=m>10</span> group 239.1.1.1 dstport <span class=m>4789</span> dev eth0
</span></span><span class=line><span class=cl>ip link <span class=nb>set</span> vxlan2 up
</span></span><span class=line><span class=cl>ip addr add 192.168.100.10/24 dev vxlan2</span></span></code></pre></td></tr></table></div></div></div></div><p>node01</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ip link add vxlan2 <span class=nb>type</span> vxlan id <span class=m>10</span> group 239.1.1.1 dstport <span class=m>4789</span> dev eth0
</span></span><span class=line><span class=cl>ip link <span class=nb>set</span> vxlan2 up
</span></span><span class=line><span class=cl>ip addr add 192.168.100.20/24 dev vxlan2</span></span></code></pre></td></tr></table></div></div></div></div><p><em><strong>FDB</strong></em> 是 Linux 网桥维护的一个二层转发表，用于保存远端虚拟机/容器的 MAC地址，远端 VTEP IP，以及 VNI 的映射关系，可以通过 <code>bridge fdb</code> 命令来对 <code>FDB</code> 表进行操作：</p><p>vxlan接口在创建后，fdb只有一个表项，就是所有<code>vxlan2</code>的流量都发往多播组</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>text</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>$ bridge fdb
</span></span><span class=line><span class=cl>33:33:00:00:00:01 dev eth0 self permanent
</span></span><span class=line><span class=cl>01:00:5e:00:00:01 dev eth0 self permanent
</span></span><span class=line><span class=cl>01:00:5e:01:01:01 dev eth0 self permanent
</span></span><span class=line><span class=cl>00:00:00:00:00:00 dev vxlan2 dst 239.1.1.1 via eth0 self permanent</span></span></code></pre></td></tr></table></div></div></div></div><p>组播路由方式过程</p><ol><li>当发送<code>ping 192.168.100.10</code>时在同一个局域网内会先发送ARP广播，为组播方式，node1与node2（10.0.0.4）均受到广播，而node3（10.0.0.6）未受到</li><li>ARP报文要获得的内容为vxlan的mac地址，目的地址为全1的广播地址</li><li>vxlan隧道封装VNI=10，因为不知道目的地址，所以会发送多播报文</li><li>受到报文后进行解包，取出真实的报文，如果发现是自己的，经由隧道封装后传递</li><li>vtep 通过源报文学习到了 vtep 所在的主机，因此会直接单播发送给目的 vtep。发送方主机根据 VNI 把报文转发给 vtep，vtep 解包取出 ARP 应答报文，添加 arp 缓存到内核。并根据报文学习到目的 vtep 所在的主机地址，添加到 fdb 表中</li></ol><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20210204010726897.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20210204010726897.png#center alt=image-20210204010726897 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><p>而没在多播组中的同网段主机没有受到对应的ARP广播</p><p>而在加入多播组中会受到多播的信息，确定不是自己后没有reply</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20210204010149338.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20210204010149338.png#center alt=image-20210204010149338 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><p>此实验的报文内容</p><p>[192.168.10.30 加入同多播组](......\images\vxlan in linux\10.30.cap)</p><p>[192.168.10.20 发起端](......\images\vxlan in linux\10.20.cap)</p><p>[192.168.10.30 不在多播组内的报文](......\images\vxlan in linux\10.30 exit multicast.cap)</p><p>清除配置</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ip link <span class=nb>set</span> vxlan2 down
</span></span><span class=line><span class=cl>ip link delete vxlan2 </span></span></code></pre></td></tr></table></div></div></div></div><h2 id=实验一linux-bridgel2>实验一：Linux Bridge[L2]<a hidden class=anchor aria-hidden=true href=#实验一linux-bridgel2>#</a></h2><p>该实验包含 <em><strong>veth</strong></em>, <em><strong>vlan</strong></em>, <em><strong>Linux bridge</strong></em> 方面的</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20210201195306279-166133333718927.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20210201195306279-166133333718927.png#center alt=image-20210201195306279 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><center>图：L2 vn topology</center><br><p>加载vlan模块</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>modprobe 8021q
</span></span><span class=line><span class=cl><span class=c1>## 查看核心是否提供VLAN 功能</span>
</span></span><span class=line><span class=cl>dmesg <span class=p>|</span> grep -i <span class=m>802</span>
</span></span><span class=line><span class=cl><span class=o>[</span>    1.592802<span class=o>]</span> pci 0000:00:15.0: PME# supported from D0 D3hot D3cold
</span></span><span class=line><span class=cl><span class=o>[</span> 1755.995461<span class=o>]</span> 8021q: 802.1Q VLAN Support v1.8
</span></span><span class=line><span class=cl><span class=o>[</span> 1755.995485<span class=o>]</span> 8021q: adding VLAN <span class=m>0</span> to HW filter on device eth0</span></span></code></pre></td></tr></table></div></div></div></div><p>安装命令</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>yum install vconfig -y
</span></span><span class=line><span class=cl>apt install vlan</span></span></code></pre></td></tr></table></div></div></div></div><p>创建vlan</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 创建bridge</span>
</span></span><span class=line><span class=cl>brctl addbr vlan10
</span></span><span class=line><span class=cl>brctl show
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>ip link add veth01 <span class=nb>type</span> veth peer name eth01
</span></span><span class=line><span class=cl>ip link add veth02 <span class=nb>type</span> veth peer name eth02
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 将veth对的一端加入网桥</span>
</span></span><span class=line><span class=cl>brctl addif vlan10 veth01
</span></span><span class=line><span class=cl>brctl addif vlan10 veth02
</span></span><span class=line><span class=cl><span class=c1># 启动对应设备</span>
</span></span><span class=line><span class=cl>ip link <span class=nb>set</span> dev vlan10 up
</span></span><span class=line><span class=cl>ip link <span class=nb>set</span> dev veth01 up
</span></span><span class=line><span class=cl>ip link <span class=nb>set</span> dev veth02 up
</span></span><span class=line><span class=cl>ip link <span class=nb>set</span> dev eth01 up
</span></span><span class=line><span class=cl>ip link <span class=nb>set</span> dev eth02 up
</span></span><span class=line><span class=cl><span class=c1># 创建ns</span>
</span></span><span class=line><span class=cl>ip netns add net1
</span></span><span class=line><span class=cl>ip netns add net2
</span></span><span class=line><span class=cl><span class=c1># 将veth关联到对应名称空间内</span>
</span></span><span class=line><span class=cl>ip link <span class=nb>set</span> eth01 netns net1
</span></span><span class=line><span class=cl>ip link <span class=nb>set</span> eth02 netns net2</span></span></code></pre></td></tr></table></div></div></div></div><p>网络名称空间net1内的操作，在vlan一端添加接口，与关联到该名称空间内的 <em>veth</em> 关联</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>text</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>vconfig add eth01 3001
</span></span><span class=line><span class=cl>vconfig add eth01 3002
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ip link set eth01 up
</span></span><span class=line><span class=cl>ip link set eth01.3001 up
</span></span><span class=line><span class=cl>ip link set eth01.3002 up
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ip addr add 192.168.100.1/24 dev eth01.3001
</span></span><span class=line><span class=cl>ip addr add 192.168.100.2/24 dev eth01.3002</span></span></code></pre></td></tr></table></div></div></div></div><p>网络名称空间net2与net1的类似</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>text</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>vconfig add eth02 3001
</span></span><span class=line><span class=cl>vconfig add eth02 3002
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ip link set dev eth02 up
</span></span><span class=line><span class=cl>ip link set dev eth02.3001 up
</span></span><span class=line><span class=cl>ip link set dev eth02.3002 up
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ip addr add 192.168.100.10/24 dev eth02.3001
</span></span><span class=line><span class=cl>ip addr add 192.168.100.11/24 dev eth02.3002</span></span></code></pre></td></tr></table></div></div></div></div><p>验证连通性，可以看到发送的包带有tag的标签</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20210201211400463-166133333718928.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20210201211400463-166133333718928.png#center alt=image-20210201211400463 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><h2 id=实验二ipvlan-l2>实验二：IPVLAN L2<a hidden class=anchor aria-hidden=true href=#实验二ipvlan-l2>#</a></h2><p>实验结果，通过namespace模拟Pod的网络，做到各Pod间的网络通讯。</p><p><code>ip netns list</code> 查看网络命名空间</p><p><code>ip netns add net2</code> 创建一个网络命名空间</p><p><code>ip link add &lt;name> link eth0 type ipvlan mode l2</code> 在当前名称空间创建一个类型为IPVLAN L2模式的接口，将该接口关联至父接口eth0上。</p><p><code>ip link set $name netns $nsName</code> 将接口加入到对应网络名称空间内</p><p><code>ip netns exec $nsName $cmd</code> 在对应的网络名称空间内运行命令</p><p>创建两个网络名称空间</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ ip netns add net1
</span></span><span class=line><span class=cl>$ ip netns add net2
</span></span><span class=line><span class=cl>$ ip netns list
</span></span><span class=line><span class=cl>net2
</span></span><span class=line><span class=cl>net1</span></span></code></pre></td></tr></table></div></div></div></div><p>创建 IPVLAN 接口</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ ip link add ipvlan01 link eth0 <span class=nb>type</span> ipvlan mode l2
</span></span><span class=line><span class=cl>$ ip link add ipvlan02 link eth0 <span class=nb>type</span> ipvlan mode l2
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ ip link <span class=nb>set</span> ipvlan01 netns net1
</span></span><span class=line><span class=cl>$ ip link <span class=nb>set</span> ipvlan02 netns net2</span></span></code></pre></td></tr></table></div></div></div></div><p>给对应接口添加IP地址</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ip netns <span class=nb>exec</span> net1 ifconfig ipvlan01 192.168.0.1/24 up
</span></span><span class=line><span class=cl>ip netns <span class=nb>exec</span> net2 ifconfig ipvlan02 192.168.0.2/24 up
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 这两个名称空间内的mac地址是一样的</span>
</span></span><span class=line><span class=cl>$ ip netns <span class=nb>exec</span> net2 ifconfig
</span></span><span class=line><span class=cl>ipvlan02: <span class=nv>flags</span><span class=o>=</span>4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu <span class=m>1500</span>
</span></span><span class=line><span class=cl>        inet 192.168.0.2  netmask 255.255.255.0  broadcast 192.168.0.255
</span></span><span class=line><span class=cl>        inet6 fe80::da78:c800:27a:fb26  prefixlen <span class=m>64</span>  scopeid 0x20&lt;link&gt;
</span></span><span class=line><span class=cl>        ether da:78:c8:7a:fb:26  txqueuelen <span class=m>1000</span>  <span class=o>(</span>Ethernet<span class=o>)</span>
</span></span><span class=line><span class=cl>        RX packets <span class=m>39007</span>  bytes <span class=m>2394577</span> <span class=o>(</span>2.2 MiB<span class=o>)</span>
</span></span><span class=line><span class=cl>        RX errors <span class=m>0</span>  dropped <span class=m>27</span>  overruns <span class=m>0</span>  frame <span class=m>0</span>
</span></span><span class=line><span class=cl>        TX packets <span class=m>11</span>  bytes <span class=m>866</span> <span class=o>(</span>866.0 B<span class=o>)</span>
</span></span><span class=line><span class=cl>        TX errors <span class=m>0</span>  dropped <span class=m>0</span> overruns <span class=m>0</span>  carrier <span class=m>0</span>  collisions <span class=m>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ ip netns <span class=nb>exec</span> net1 ifconfig
</span></span><span class=line><span class=cl>ipvlan01: <span class=nv>flags</span><span class=o>=</span>4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu <span class=m>1500</span>
</span></span><span class=line><span class=cl>        inet 192.168.0.1  netmask 255.255.255.0  broadcast 192.168.0.255
</span></span><span class=line><span class=cl>        inet6 fe80::da78:c800:17a:fb26  prefixlen <span class=m>64</span>  scopeid 0x20&lt;link&gt;
</span></span><span class=line><span class=cl>        ether da:78:c8:7a:fb:26  txqueuelen <span class=m>1000</span>  <span class=o>(</span>Ethernet<span class=o>)</span>
</span></span><span class=line><span class=cl>        RX packets <span class=m>132823</span>  bytes <span class=m>8184548</span> <span class=o>(</span>7.8 MiB<span class=o>)</span>
</span></span><span class=line><span class=cl>        RX errors <span class=m>0</span>  dropped <span class=m>93</span>  overruns <span class=m>0</span>  frame <span class=m>0</span>
</span></span><span class=line><span class=cl>        TX packets <span class=m>12</span>  bytes <span class=m>936</span> <span class=o>(</span>936.0 B<span class=o>)</span>
</span></span><span class=line><span class=cl>        TX errors <span class=m>0</span>  dropped <span class=m>0</span> overruns <span class=m>0</span>  carrier <span class=m>0</span>  collisions <span class=m>0</span></span></span></code></pre></td></tr></table></div></div></div></div><p>测试两个名称空间是否互通</p><p>结论：可以看到两个名称空间内的子接口 (<em><strong>sub-interface</strong></em>) 通过其父接口 (<em><strong>parent-interface</strong></em>) 可以达到互通。子接口与父接口之间的不互通。<strong>IPVLAN L2模式仅限于子接口之间的互通</strong></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ ip netns <span class=nb>exec</span> net1 ping 192.168.0.2
</span></span><span class=line><span class=cl>PING 192.168.0.2 <span class=o>(</span>192.168.0.2<span class=o>)</span> 56<span class=o>(</span>84<span class=o>)</span> bytes of data.
</span></span><span class=line><span class=cl><span class=m>64</span> bytes from 192.168.0.2: <span class=nv>icmp_seq</span><span class=o>=</span><span class=m>1</span> <span class=nv>ttl</span><span class=o>=</span><span class=m>64</span> <span class=nv>time</span><span class=o>=</span>0.285 ms
</span></span><span class=line><span class=cl><span class=m>64</span> bytes from 192.168.0.2: <span class=nv>icmp_seq</span><span class=o>=</span><span class=m>2</span> <span class=nv>ttl</span><span class=o>=</span><span class=m>64</span> <span class=nv>time</span><span class=o>=</span>0.077 ms
</span></span><span class=line><span class=cl>^C
</span></span><span class=line><span class=cl>--- 192.168.0.2 ping statistics ---
</span></span><span class=line><span class=cl><span class=m>2</span> packets transmitted, <span class=m>2</span> received, 0% packet loss, <span class=nb>time</span> 1027ms
</span></span><span class=line><span class=cl>rtt min/avg/max/mdev <span class=o>=</span> 0.077/0.181/0.285/0.104 ms
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ ip netns <span class=nb>exec</span> net2 ping 192.168.0.1
</span></span><span class=line><span class=cl>PING 192.168.0.1 <span class=o>(</span>192.168.0.1<span class=o>)</span> 56<span class=o>(</span>84<span class=o>)</span> bytes of data.
</span></span><span class=line><span class=cl><span class=m>64</span> bytes from 192.168.0.1: <span class=nv>icmp_seq</span><span class=o>=</span><span class=m>1</span> <span class=nv>ttl</span><span class=o>=</span><span class=m>64</span> <span class=nv>time</span><span class=o>=</span>0.051 ms
</span></span><span class=line><span class=cl><span class=m>64</span> bytes from 192.168.0.1: <span class=nv>icmp_seq</span><span class=o>=</span><span class=m>2</span> <span class=nv>ttl</span><span class=o>=</span><span class=m>64</span> <span class=nv>time</span><span class=o>=</span>0.059 ms
</span></span><span class=line><span class=cl>^C
</span></span><span class=line><span class=cl>--- 192.168.0.1 ping statistics ---
</span></span><span class=line><span class=cl><span class=m>2</span> packets transmitted, <span class=m>2</span> received, 0% packet loss, <span class=nb>time</span> 1056ms
</span></span><span class=line><span class=cl>rtt min/avg/max/mdev <span class=o>=</span> 0.051/0.055/0.059/0.004 ms</span></span></code></pre></td></tr></table></div></div></div></div><p>遇到问题</p><ul><li><p><strong>RTNETLINK answers: Operation not supported</strong>： CentOS 7默认内核版本为3.10 IPVLAN 3.19开始支持，推荐内核为4.2+</p></li><li><p>子接口ping父接口不通，源MAC与目标MAC是一致，而mac接口是mac地址与接口绑定，因为三个接口的mac地址都相同，此时区分不了是哪个接口。</p></li><li><p>ping公网地址不通，查看路由表中没有对外的路由，手动添加即可</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ip netns <span class=nb>exec</span> net1 route -n
</span></span><span class=line><span class=cl>ip netns <span class=nb>exec</span> net1 route add -net 0.0.0.0/0 gw 10.0.0.2</span></span></code></pre></td></tr></table></div></div></div></div></li><li><p>IPVLAN L2模式中，父接口是可以没有IP地址的。不影响子接口的使用</p></li></ul><p>清除所有网络名称空间</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=k>for</span> n in <span class=k>$(</span>ip netns list<span class=p>|</span>awk <span class=s1>&#39;{print $1}&#39;</span><span class=k>)</span><span class=p>;</span><span class=k>do</span> ip netns del <span class=nv>$n</span><span class=p>;</span><span class=k>done</span></span></span></code></pre></td></tr></table></div></div></div></div><h3 id=实验三ipvlan-l3>实验三：IPVLAN L3<a hidden class=anchor aria-hidden=true href=#实验三ipvlan-l3>#</a></h3><p>先创建两个用做测试的 network namespace</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ip netns add net3
</span></span><span class=line><span class=cl>ip netns add net4</span></span></code></pre></td></tr></table></div></div></div></div><p>创建出 IPVLAN 的虚拟网卡接口，创建 IPVLAN 虚拟接口的命令和 MACVLAN 格式相同：</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ip link add ipvl01 link ens33 <span class=nb>type</span> ipvlan mode l3
</span></span><span class=line><span class=cl>ip link add ipvl02 link ens33 <span class=nb>type</span> ipvlan mode l3</span></span></code></pre></td></tr></table></div></div></div></div><p>把 IPVLAN 接口放到前面创建好的 namespace 中</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ip link <span class=nb>set</span> ipvl01 netns net3
</span></span><span class=line><span class=cl>ip link <span class=nb>set</span> ipvl02 netns net4
</span></span><span class=line><span class=cl><span class=c1># 给对应设备设置IP地址</span>
</span></span><span class=line><span class=cl>ip netns <span class=nb>exec</span> net3 ifconfig ipvl01 192.168.10.1/24 up
</span></span><span class=line><span class=cl>ip netns <span class=nb>exec</span> net4 ifconfig ipvl02 192.168.20.1/24 up
</span></span><span class=line><span class=cl><span class=c1># 设置对应的路由</span>
</span></span><span class=line><span class=cl>ip netns <span class=nb>exec</span> net4 route add -net 192.168.10.0/24 dev ipvl02
</span></span><span class=line><span class=cl>ip netns <span class=nb>exec</span> net3 route add -net 192.168.20.0/24 dev ipvl01</span></span></code></pre></td></tr></table></div></div></div></div><p>结果是可以通的</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ ip netns <span class=nb>exec</span> net3 ping 192.168.20.1
</span></span><span class=line><span class=cl>PING 192.168.20.1 <span class=o>(</span>192.168.20.1<span class=o>)</span> 56<span class=o>(</span>84<span class=o>)</span> bytes of data.
</span></span><span class=line><span class=cl><span class=m>64</span> bytes from 192.168.20.1: <span class=nv>icmp_seq</span><span class=o>=</span><span class=m>1</span> <span class=nv>ttl</span><span class=o>=</span><span class=m>64</span> <span class=nv>time</span><span class=o>=</span>0.026 ms
</span></span><span class=line><span class=cl><span class=m>64</span> bytes from 192.168.20.1: <span class=nv>icmp_seq</span><span class=o>=</span><span class=m>2</span> <span class=nv>ttl</span><span class=o>=</span><span class=m>64</span> <span class=nv>time</span><span class=o>=</span>0.119 ms
</span></span><span class=line><span class=cl>^C
</span></span><span class=line><span class=cl>--- 192.168.20.1 ping statistics ---
</span></span><span class=line><span class=cl><span class=m>2</span> packets transmitted, <span class=m>2</span> received, 0% packet loss, <span class=nb>time</span> 1028ms
</span></span><span class=line><span class=cl>rtt min/avg/max/mdev <span class=o>=</span> 0.026/0.072/0.119/0.046 ms</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=实验四macvlan>实验四：MACVLAN<a hidden class=anchor aria-hidden=true href=#实验四macvlan>#</a></h3><p>创建两个名称空间</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ip netns add net1
</span></span><span class=line><span class=cl>ip netns add net2</span></span></code></pre></td></tr></table></div></div></div></div><p>创建两个 MACVLAN 接口</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ip link add link eth0 name macv1 <span class=nb>type</span> macvlan mode bridge
</span></span><span class=line><span class=cl>ip link add link eth0 name macv2 <span class=nb>type</span> macvlan mode bridge
</span></span><span class=line><span class=cl><span class=c1>## 持久化创建</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;ip link add eth0 eth0.1 address 52:54:00:cc:ee:aa link enp0s31f6 type macvlan&#34;</span> &gt; /sbin/ifup-pre-local2</span></span></code></pre></td></tr></table></div></div></div></div><p>把 MACVLAN 接口放到前面创建好的 namespace 中</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ip link <span class=nb>set</span> macv1 netns net1
</span></span><span class=line><span class=cl>ip link <span class=nb>set</span> macv2 netns net2
</span></span><span class=line><span class=cl><span class=c1># 给对应设备设置IP地址</span>
</span></span><span class=line><span class=cl>ip netns <span class=nb>exec</span> net1 ifconfig ipvl01 192.168.10.1/24 up
</span></span><span class=line><span class=cl>ip netns <span class=nb>exec</span> net2 ifconfig ipvl02 192.168.20.1/24 up
</span></span><span class=line><span class=cl><span class=c1># 设置对应的路由</span>
</span></span><span class=line><span class=cl>ip netns <span class=nb>exec</span> net1 route add -net 192.168.10.0/24 dev ipvl02
</span></span><span class=line><span class=cl>ip netns <span class=nb>exec</span> net2 route add -net 192.168.20.0/24 dev ipvl01</span></span></code></pre></td></tr></table></div></div></div></div><p>可以看到两个网卡的MAC地址是不同的</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ ip netns <span class=nb>exec</span> net2 ifconfig
</span></span><span class=line><span class=cl>macv2: <span class=nv>flags</span><span class=o>=</span>4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu <span class=m>1500</span>
</span></span><span class=line><span class=cl>        inet 192.168.10.1  netmask 255.255.255.0  broadcast 192.168.10.255
</span></span><span class=line><span class=cl>        inet6 fe80::a830:c9ff:fe9a:7c33  prefixlen <span class=m>64</span>  scopeid 0x20&lt;link&gt;
</span></span><span class=line><span class=cl>        ether aa:30:c9:9a:7c:33  txqueuelen <span class=m>1000</span>  <span class=o>(</span>Ethernet<span class=o>)</span>
</span></span><span class=line><span class=cl>        RX packets <span class=m>0</span>  bytes <span class=m>0</span> <span class=o>(</span>0.0 B<span class=o>)</span>
</span></span><span class=line><span class=cl>        RX errors <span class=m>0</span>  dropped <span class=m>0</span>  overruns <span class=m>0</span>  frame <span class=m>0</span>
</span></span><span class=line><span class=cl>        TX packets <span class=m>7</span>  bytes <span class=m>586</span> <span class=o>(</span>586.0 B<span class=o>)</span>
</span></span><span class=line><span class=cl>        TX errors <span class=m>0</span>  dropped <span class=m>0</span> overruns <span class=m>0</span>  carrier <span class=m>0</span>  collisions <span class=m>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ ip netns <span class=nb>exec</span> net1 ifconfig
</span></span><span class=line><span class=cl>macv1: <span class=nv>flags</span><span class=o>=</span>4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu <span class=m>1500</span>
</span></span><span class=line><span class=cl>        inet 192.168.10.1  netmask 255.255.255.0  broadcast 192.168.10.255
</span></span><span class=line><span class=cl>        inet6 fe80::d448:c5ff:fec7:76a3  prefixlen <span class=m>64</span>  scopeid 0x20&lt;link&gt;
</span></span><span class=line><span class=cl>        ether d6:48:c5:c7:76:a3  txqueuelen <span class=m>1000</span>  <span class=o>(</span>Ethernet<span class=o>)</span>
</span></span><span class=line><span class=cl>        RX packets <span class=m>0</span>  bytes <span class=m>0</span> <span class=o>(</span>0.0 B<span class=o>)</span>
</span></span><span class=line><span class=cl>        RX errors <span class=m>0</span>  dropped <span class=m>0</span>  overruns <span class=m>0</span>  frame <span class=m>0</span>
</span></span><span class=line><span class=cl>        TX packets <span class=m>8</span>  bytes <span class=m>656</span> <span class=o>(</span>656.0 B<span class=o>)</span>
</span></span><span class=line><span class=cl>        TX errors <span class=m>0</span>  dropped <span class=m>0</span> overruns <span class=m>0</span>  carrier <span class=m>0</span>  collisions <span class=m>0</span></span></span></code></pre></td></tr></table></div></div></div></div><h2 id=reference>Reference<a hidden class=anchor aria-hidden=true href=#reference>#</a></h2><blockquote><p><sup id=1>[1]</sup> <a href=https://man7.org/linux/man-pages/man4/veth.4.html target=_blank rel="noopener nofollow noreferrer">man veth</a></p><p><sup id=2>[2]</sup> <a href=https://hicu.be/bridge-vs-macvlan target=_blank rel="noopener nofollow noreferrer">macvlan</a></p><p><sup id=3>[3]</sup> <a href=https://superuser.com/questions/1113812/how-to-configure-macvlan-interface-for-getting-the-ip target=_blank rel="noopener nofollow noreferrer">how to configure macvlan interface for getting the IP?</a></p><p><sup id=4>[4]</sup> <a href=https://community.fs.com/blog/how-to-choose-the-right-distribution-switch.html target=_blank rel="noopener nofollow noreferrer">distribution switch</a></p><p><sup id=5>[5]</sup> <a href=https://nwktimes.blogspot.com/2018/02/vxlan-part-i-why-vxlan-is-needed.html target=_blank rel="noopener nofollow noreferrer">why vxlan is needed</a></p><p><sup id=4>[4]</sup> <a href>distribution switch</a></p></blockquote></div><div class=pe-copyright><hr><blockquote><p>本文为原创内容，版权归作者所有。如需转载，请在文章中声明本文标题及链接。</p><p>文章标题：Linux虚拟网络技术</p><p>文章链接：<a href=https://www.oomkill.com/2021/01/virtual-networking/ target=_blank>https://www.oomkill.com/2021/01/virtual-networking/</a></p><p>许可协议：<a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></p></blockquote></div><div class=comments-separator></div><h3 class=relatedContentTitle>相关阅读</h3><ul class=relatedContent><li><a href=/2021/01/network-tunnel-technology/><span>网络隧道技术</span></a></li><li><a href=/2021/01/ensp-calico-bgp/><span>使用eNSP构建calico BGP网络</span></a></li><li><a href=/2021/01/linux-network-command/><span>长期总结 - Linux网络命令合集</span></a></li><li><a href=/2021/01/static-routing/><span>静态路由</span></a></li><li><a href=/2021/01/dynamic-routing-ospf/><span>动态路由 - OSPF</span></a></li></ul><div class=comments-separator></div><footer class=post-footer><ul class=post-tags><li><a href=https://www.oomkill.com/tags/network/>Network</a></li><li><a href=https://www.oomkill.com/tags/kubernetes-network/>Kubernetes Network</a></li></ul><nav class=paginav><a class=prev href=https://www.oomkill.com/2021/01/calico-network-cni/><span class=title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left" style="user-select:text"><line x1="19" y1="12" x2="5" y2="12" style="user-select:text"/><polyline points="12 19 5 12 12 5" style="user-select:text"/></polyline></svg>&nbsp;</span>
<span>calico network cni网络方案</span>
</a><a class=next href=https://www.oomkill.com/2021/01/static-routing/><span class=title></span>
<span>静态路由&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right" style="user-select:text"><line x1="5" y1="12" x2="19" y2="12" style="user-select:text"/><polyline points="12 5 19 12 12 19" style="user-select:text"/></svg></span></a></nav></footer><div class=pe-comments-decoration><p class=pe-comments-title></p><p class=pe-comments-subtitle></p></div><div id=pe-comments></div><script src=/js/pe-go-comment.min.86a214102576ba5f9b7bdc29eed8d58dd56e34aef80b3c65c73ea9cc88443696.js integrity="sha256-hqIUECV2ul+be9wp7tjVjdVuNK74Czxlxz6pzIhENpY="></script><script>const getStoredTheme=()=>localStorage.getItem("pref-theme")==="dark"?"dark":"light",setGiscusTheme=()=>{const e=e=>{const t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:e},"https://giscus.app")};e({setConfig:{theme:getStoredTheme()}})};document.addEventListener("DOMContentLoaded",()=>{const s={src:"https://giscus.app/client.js","data-repo":"cylonchau/cylonchau.github.io","data-repo-id":"R_kgDOIRlNSQ","data-category":"Announcements","data-category-id":"DIC_kwDOIRlNSc4CXy1U","data-mapping":"pathname","data-term":"posts/virtual networking","data-strict":"0","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"top","data-theme":getStoredTheme(),"data-lang":"zh-TW","data-loading":"lazy",crossorigin:"anonymous",async:""},e=document.createElement("script");Object.entries(s).forEach(([t,n])=>e.setAttribute(t,n)),document.querySelector("#pe-comments").appendChild(e);const t=document.querySelector("#theme-toggle");t&&t.addEventListener("click",setGiscusTheme);const n=document.querySelector("#theme-toggle-float");n&&n.addEventListener("click",setGiscusTheme)})</script></article></main><footer class=footer><span>&copy; 2024 <a href=https://www.oomkill.com/>Cylon's Collection</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> on
<a href=https://pages.github.com/ rel=noopener target=_blank>GitHub Pages</a> & Theme
        <a href=https://github.com/tofuwine/PaperMod-PE rel=noopener target=_blank>PaperMod-PE</a></span><div class=busuanzi-footer style="font-family:helvetica neue,Helvetica,Arial,sans-serif;text-align:center;padding:4px 0;color:#999"><span id=busuanzi_container_site_pv style=margin-right:8px;font-size:.85em>本站总访问量<span id=busuanzi_value_site_pv style=font-weight:500>0</span>次
</span><span id=busuanzi_container_site_uv style=font-size:.85em>本站访客数<span id=busuanzi_value_site_uv style=font-weight:500>0</span>人次</span></div></footer><div class=pe-right-sidebar><a href=javascript:void(0); id=theme-toggle-float class=pe-float-btn><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</a><a href=#top class=pe-float-btn id=top-link><span id=pe-read-progress></span></a></div><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>