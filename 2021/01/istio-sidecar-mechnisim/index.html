<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>istio sidecar流量处理机制及配置 | Cylon's Collection</title>
<meta name=keywords content="istio"><meta name=description content="sidecar 介绍 在istio的流量管理等功能，都需要通过下发的配置应用到应用运行环境执行后生效，负责执行配置规则的组件在service mesh中承载应用代理的实体被称为side-car
Istio对流量策略管理等功能无须对应用程序做变动，
这种对应用服务完全非侵入的方式完全依赖于Side-car，应用的流量有Sidecar拦截并进行认证、鉴权、策略执行等治理功能。在Kubernetes平台中，Side-car容器于应用容器在同一个Pod中并共享网络名词控件，因此Side-car容易可以通过iptables规则拦截进出流量进行管理。
sidecar的注入 sidecar是service mesh无侵入式架构的应用模式，在使用sidecar部署服务网格时，无需再每个应用节点运行服务代理，但是需要在每个应用程序中部署一个sidecar容器，来接管所有进出流量。
Sidecar会将额外容器注入到 Pod 模板中。Istio中的数据平面组件所需的容器有：
istio-init 用于设置容器的iptables规则，目的是为了接管进出流量。在应用容器前启动并运行完成其生命周期，多个init容器按顺序依次完成。 istio-proxy 基于envoy的sidecar的代理。 sidecar被注入的方式 手动注入，使用 istioctl 修改容器模板并添加前面提到的两个容器的配置。不论是手动注入还是自动注入，Istio 都从 istio-sidecar-injector 和的 istio 两个 Configmap 对象中获取配置。 refer-istio-sidecar-injector
自动注入，在部署应用是，istio自动将sidecar注入到pod。这是istio推荐的方法，Istio在基于Kubernetes平台之上，需要在部署应用之前，对要标记部署应用程序的名称空间标记 kubectl label namespace default istio-injection=enabled 这个操作是对名称空间级别生效的。而后所部署的Pod中会注入sidecar执行上面sidecar容器的操作。
istio injector 注入原理 Sidecar Injector是Istio中实现自动注入Sidecar的组件，它是以Kubernetes准入控制器 AdmissionController 的形式运行的。Admission Controller 的基本工作原理是拦截Kube-apiserver的请求，在对象持久化之前、认证鉴权之后进行拦截。
Admission Controller有两种：一种是内置的，另一种是用户自定义的。
Kubernetes允许用户以Webhook的方式自定义准入控制器，Sidecar Injector就是这样一种特殊的MutatingAdmissionWebhook。
Sidecar Injector只在创建Pod时进行Sidecar容器注入，在Pod的创建请求到达 Kube-apiserver 后，首先进行认证鉴权，然后在准入控制阶段，Kube-apiserver以REST的方式同步调用Sidecar Injector Webhook服务进行init与istio-proxy容器的注入，最后将Pod对象持久化存储到etcd中。
sidecar容器 sidecar容器内部运行着 pilot-agent 与 envoy
Pilot-agent：基于kubernetesAPI资源对象为envoy初始化可用的bootstrap配置进行启动，在运行后管理envoy运行状态，如配置变更，出错重启等。
envoy：数据平面的执行层，由 pilot-agent 所启动的，从xDS API动态获取配置信息。Envoy并通过流量拦截机制处理入栈及出栈的流量。
envoy的listener 在运行在Kubernetes平台之上的istio，Envoy是通过Pilot将Kubernetes CRD资源 DestnationRule VirtualService Gateway等资源提供的配置，生成对应的Envoy配置。"><meta name=author content="cylon"><link rel=canonical href=https://www.oomkill.com/2021/01/istio-sidecar-mechnisim/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://www.oomkill.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.oomkill.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.oomkill.com/favicon-32x32.png><link rel=apple-touch-icon href=https://www.oomkill.com/favicon.ico><link rel=mask-icon href=https://www.oomkill.com/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://www.oomkill.com/2021/01/istio-sidecar-mechnisim/><noscript><style>#theme-toggle,#top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link crossorigin=anonymous href=/assets/css/pe.min.css rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/pe.min.js></script><link rel=stylesheet href=https://cdn.staticfile.net/font-awesome/6.5.1/css/all.min.css><link rel=stylesheet href=https://cdn.staticfile.net/font-awesome/6.5.1/css/v4-shims.min.css><script id=MathJax-script async src=https://cdn.staticfile.net/mathjax/3.2.2/es5/tex-chtml.js></script><script>MathJax={tex:{displayMath:[["$$","$$"]],inlineMath:[["\\$","\\$"]]}}</script><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><meta name=referrer content="no-referrer-when-downgrade"><meta property="og:title" content="istio sidecar流量处理机制及配置"><meta property="og:description" content="sidecar 介绍 在istio的流量管理等功能，都需要通过下发的配置应用到应用运行环境执行后生效，负责执行配置规则的组件在service mesh中承载应用代理的实体被称为side-car
Istio对流量策略管理等功能无须对应用程序做变动，
这种对应用服务完全非侵入的方式完全依赖于Side-car，应用的流量有Sidecar拦截并进行认证、鉴权、策略执行等治理功能。在Kubernetes平台中，Side-car容器于应用容器在同一个Pod中并共享网络名词控件，因此Side-car容易可以通过iptables规则拦截进出流量进行管理。
sidecar的注入 sidecar是service mesh无侵入式架构的应用模式，在使用sidecar部署服务网格时，无需再每个应用节点运行服务代理，但是需要在每个应用程序中部署一个sidecar容器，来接管所有进出流量。
Sidecar会将额外容器注入到 Pod 模板中。Istio中的数据平面组件所需的容器有：
istio-init 用于设置容器的iptables规则，目的是为了接管进出流量。在应用容器前启动并运行完成其生命周期，多个init容器按顺序依次完成。 istio-proxy 基于envoy的sidecar的代理。 sidecar被注入的方式 手动注入，使用 istioctl 修改容器模板并添加前面提到的两个容器的配置。不论是手动注入还是自动注入，Istio 都从 istio-sidecar-injector 和的 istio 两个 Configmap 对象中获取配置。 refer-istio-sidecar-injector
自动注入，在部署应用是，istio自动将sidecar注入到pod。这是istio推荐的方法，Istio在基于Kubernetes平台之上，需要在部署应用之前，对要标记部署应用程序的名称空间标记 kubectl label namespace default istio-injection=enabled 这个操作是对名称空间级别生效的。而后所部署的Pod中会注入sidecar执行上面sidecar容器的操作。
istio injector 注入原理 Sidecar Injector是Istio中实现自动注入Sidecar的组件，它是以Kubernetes准入控制器 AdmissionController 的形式运行的。Admission Controller 的基本工作原理是拦截Kube-apiserver的请求，在对象持久化之前、认证鉴权之后进行拦截。
Admission Controller有两种：一种是内置的，另一种是用户自定义的。
Kubernetes允许用户以Webhook的方式自定义准入控制器，Sidecar Injector就是这样一种特殊的MutatingAdmissionWebhook。
Sidecar Injector只在创建Pod时进行Sidecar容器注入，在Pod的创建请求到达 Kube-apiserver 后，首先进行认证鉴权，然后在准入控制阶段，Kube-apiserver以REST的方式同步调用Sidecar Injector Webhook服务进行init与istio-proxy容器的注入，最后将Pod对象持久化存储到etcd中。
sidecar容器 sidecar容器内部运行着 pilot-agent 与 envoy
Pilot-agent：基于kubernetesAPI资源对象为envoy初始化可用的bootstrap配置进行启动，在运行后管理envoy运行状态，如配置变更，出错重启等。
envoy：数据平面的执行层，由 pilot-agent 所启动的，从xDS API动态获取配置信息。Envoy并通过流量拦截机制处理入栈及出栈的流量。
envoy的listener 在运行在Kubernetes平台之上的istio，Envoy是通过Pilot将Kubernetes CRD资源 DestnationRule VirtualService Gateway等资源提供的配置，生成对应的Envoy配置。"><meta property="og:type" content="article"><meta property="og:url" content="https://www.oomkill.com/2021/01/istio-sidecar-mechnisim/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-01-09T00:00:00+00:00"><meta property="article:modified_time" content="2023-03-22T23:00:36+08:00"><meta property="og:site_name" content="Cylon's Collection"><meta name=twitter:card content="summary"><meta name=twitter:title content="istio sidecar流量处理机制及配置"><meta name=twitter:description content="sidecar 介绍 在istio的流量管理等功能，都需要通过下发的配置应用到应用运行环境执行后生效，负责执行配置规则的组件在service mesh中承载应用代理的实体被称为side-car
Istio对流量策略管理等功能无须对应用程序做变动，
这种对应用服务完全非侵入的方式完全依赖于Side-car，应用的流量有Sidecar拦截并进行认证、鉴权、策略执行等治理功能。在Kubernetes平台中，Side-car容器于应用容器在同一个Pod中并共享网络名词控件，因此Side-car容易可以通过iptables规则拦截进出流量进行管理。
sidecar的注入 sidecar是service mesh无侵入式架构的应用模式，在使用sidecar部署服务网格时，无需再每个应用节点运行服务代理，但是需要在每个应用程序中部署一个sidecar容器，来接管所有进出流量。
Sidecar会将额外容器注入到 Pod 模板中。Istio中的数据平面组件所需的容器有：
istio-init 用于设置容器的iptables规则，目的是为了接管进出流量。在应用容器前启动并运行完成其生命周期，多个init容器按顺序依次完成。 istio-proxy 基于envoy的sidecar的代理。 sidecar被注入的方式 手动注入，使用 istioctl 修改容器模板并添加前面提到的两个容器的配置。不论是手动注入还是自动注入，Istio 都从 istio-sidecar-injector 和的 istio 两个 Configmap 对象中获取配置。 refer-istio-sidecar-injector
自动注入，在部署应用是，istio自动将sidecar注入到pod。这是istio推荐的方法，Istio在基于Kubernetes平台之上，需要在部署应用之前，对要标记部署应用程序的名称空间标记 kubectl label namespace default istio-injection=enabled 这个操作是对名称空间级别生效的。而后所部署的Pod中会注入sidecar执行上面sidecar容器的操作。
istio injector 注入原理 Sidecar Injector是Istio中实现自动注入Sidecar的组件，它是以Kubernetes准入控制器 AdmissionController 的形式运行的。Admission Controller 的基本工作原理是拦截Kube-apiserver的请求，在对象持久化之前、认证鉴权之后进行拦截。
Admission Controller有两种：一种是内置的，另一种是用户自定义的。
Kubernetes允许用户以Webhook的方式自定义准入控制器，Sidecar Injector就是这样一种特殊的MutatingAdmissionWebhook。
Sidecar Injector只在创建Pod时进行Sidecar容器注入，在Pod的创建请求到达 Kube-apiserver 后，首先进行认证鉴权，然后在准入控制阶段，Kube-apiserver以REST的方式同步调用Sidecar Injector Webhook服务进行init与istio-proxy容器的注入，最后将Pod对象持久化存储到etcd中。
sidecar容器 sidecar容器内部运行着 pilot-agent 与 envoy
Pilot-agent：基于kubernetesAPI资源对象为envoy初始化可用的bootstrap配置进行启动，在运行后管理envoy运行状态，如配置变更，出错重启等。
envoy：数据平面的执行层，由 pilot-agent 所启动的，从xDS API动态获取配置信息。Envoy并通过流量拦截机制处理入栈及出栈的流量。
envoy的listener 在运行在Kubernetes平台之上的istio，Envoy是通过Pilot将Kubernetes CRD资源 DestnationRule VirtualService Gateway等资源提供的配置，生成对应的Envoy配置。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://www.oomkill.com/posts/"},{"@type":"ListItem","position":2,"name":"istio sidecar流量处理机制及配置","item":"https://www.oomkill.com/2021/01/istio-sidecar-mechnisim/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"istio sidecar流量处理机制及配置","name":"istio sidecar流量处理机制及配置","description":"sidecar 介绍 在istio的流量管理等功能，都需要通过下发的配置应用到应用运行环境执行后生效，负责执行配置规则的组件在service mesh中承载应用代理的实体被称为side-car\nIstio对流量策略管理等功能无须对应用程序做变动，\n这种对应用服务完全非侵入的方式完全依赖于Side-car，应用的流量有Sidecar拦截并进行认证、鉴权、策略执行等治理功能。在Kubernetes平台中，Side-car容器于应用容器在同一个Pod中并共享网络名词控件，因此Side-car容易可以通过iptables规则拦截进出流量进行管理。\nsidecar的注入 sidecar是service mesh无侵入式架构的应用模式，在使用sidecar部署服务网格时，无需再每个应用节点运行服务代理，但是需要在每个应用程序中部署一个sidecar容器，来接管所有进出流量。\nSidecar会将额外容器注入到 Pod 模板中。Istio中的数据平面组件所需的容器有：\nistio-init 用于设置容器的iptables规则，目的是为了接管进出流量。在应用容器前启动并运行完成其生命周期，多个init容器按顺序依次完成。 istio-proxy 基于envoy的sidecar的代理。 sidecar被注入的方式 手动注入，使用 istioctl 修改容器模板并添加前面提到的两个容器的配置。不论是手动注入还是自动注入，Istio 都从 istio-sidecar-injector 和的 istio 两个 Configmap 对象中获取配置。 refer-istio-sidecar-injector\n自动注入，在部署应用是，istio自动将sidecar注入到pod。这是istio推荐的方法，Istio在基于Kubernetes平台之上，需要在部署应用之前，对要标记部署应用程序的名称空间标记 kubectl label namespace default istio-injection=enabled 这个操作是对名称空间级别生效的。而后所部署的Pod中会注入sidecar执行上面sidecar容器的操作。\nistio injector 注入原理 Sidecar Injector是Istio中实现自动注入Sidecar的组件，它是以Kubernetes准入控制器 AdmissionController 的形式运行的。Admission Controller 的基本工作原理是拦截Kube-apiserver的请求，在对象持久化之前、认证鉴权之后进行拦截。\nAdmission Controller有两种：一种是内置的，另一种是用户自定义的。\nKubernetes允许用户以Webhook的方式自定义准入控制器，Sidecar Injector就是这样一种特殊的MutatingAdmissionWebhook。\nSidecar Injector只在创建Pod时进行Sidecar容器注入，在Pod的创建请求到达 Kube-apiserver 后，首先进行认证鉴权，然后在准入控制阶段，Kube-apiserver以REST的方式同步调用Sidecar Injector Webhook服务进行init与istio-proxy容器的注入，最后将Pod对象持久化存储到etcd中。\nsidecar容器 sidecar容器内部运行着 pilot-agent 与 envoy\nPilot-agent：基于kubernetesAPI资源对象为envoy初始化可用的bootstrap配置进行启动，在运行后管理envoy运行状态，如配置变更，出错重启等。\nenvoy：数据平面的执行层，由 pilot-agent 所启动的，从xDS API动态获取配置信息。Envoy并通过流量拦截机制处理入栈及出栈的流量。\nenvoy的listener 在运行在Kubernetes平台之上的istio，Envoy是通过Pilot将Kubernetes CRD资源 DestnationRule VirtualService Gateway等资源提供的配置，生成对应的Envoy配置。","keywords":["istio"],"articleBody":"sidecar 介绍 在istio的流量管理等功能，都需要通过下发的配置应用到应用运行环境执行后生效，负责执行配置规则的组件在service mesh中承载应用代理的实体被称为side-car\nIstio对流量策略管理等功能无须对应用程序做变动，\n这种对应用服务完全非侵入的方式完全依赖于Side-car，应用的流量有Sidecar拦截并进行认证、鉴权、策略执行等治理功能。在Kubernetes平台中，Side-car容器于应用容器在同一个Pod中并共享网络名词控件，因此Side-car容易可以通过iptables规则拦截进出流量进行管理。\nsidecar的注入 sidecar是service mesh无侵入式架构的应用模式，在使用sidecar部署服务网格时，无需再每个应用节点运行服务代理，但是需要在每个应用程序中部署一个sidecar容器，来接管所有进出流量。\nSidecar会将额外容器注入到 Pod 模板中。Istio中的数据平面组件所需的容器有：\nistio-init 用于设置容器的iptables规则，目的是为了接管进出流量。在应用容器前启动并运行完成其生命周期，多个init容器按顺序依次完成。 istio-proxy 基于envoy的sidecar的代理。 sidecar被注入的方式 手动注入，使用 istioctl 修改容器模板并添加前面提到的两个容器的配置。不论是手动注入还是自动注入，Istio 都从 istio-sidecar-injector 和的 istio 两个 Configmap 对象中获取配置。 refer-istio-sidecar-injector\n自动注入，在部署应用是，istio自动将sidecar注入到pod。这是istio推荐的方法，Istio在基于Kubernetes平台之上，需要在部署应用之前，对要标记部署应用程序的名称空间标记 kubectl label namespace default istio-injection=enabled 这个操作是对名称空间级别生效的。而后所部署的Pod中会注入sidecar执行上面sidecar容器的操作。\nistio injector 注入原理 Sidecar Injector是Istio中实现自动注入Sidecar的组件，它是以Kubernetes准入控制器 AdmissionController 的形式运行的。Admission Controller 的基本工作原理是拦截Kube-apiserver的请求，在对象持久化之前、认证鉴权之后进行拦截。\nAdmission Controller有两种：一种是内置的，另一种是用户自定义的。\nKubernetes允许用户以Webhook的方式自定义准入控制器，Sidecar Injector就是这样一种特殊的MutatingAdmissionWebhook。\nSidecar Injector只在创建Pod时进行Sidecar容器注入，在Pod的创建请求到达 Kube-apiserver 后，首先进行认证鉴权，然后在准入控制阶段，Kube-apiserver以REST的方式同步调用Sidecar Injector Webhook服务进行init与istio-proxy容器的注入，最后将Pod对象持久化存储到etcd中。\nsidecar容器 sidecar容器内部运行着 pilot-agent 与 envoy\nPilot-agent：基于kubernetesAPI资源对象为envoy初始化可用的bootstrap配置进行启动，在运行后管理envoy运行状态，如配置变更，出错重启等。\nenvoy：数据平面的执行层，由 pilot-agent 所启动的，从xDS API动态获取配置信息。Envoy并通过流量拦截机制处理入栈及出栈的流量。\nenvoy的listener 在运行在Kubernetes平台之上的istio，Envoy是通过Pilot将Kubernetes CRD资源 DestnationRule VirtualService Gateway等资源提供的配置，生成对应的Envoy配置。\n每个sidecar中的envoy都会生成众多的配置，这些配置在每一个网格中会对对应的流量进行拦截管理。\n通过envoy admin interface查看对应生产的envoy资源配置信息\nbash 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 $ kubectl exec reviews-v1-6549ddccc5-k995p -c istio-proxy -- curl -s 127.0.0.1:15000/listeners 97591f7a-0cbf-469a-a5f2-c9a76a3d0ced::0.0.0.0:15090 e523c9a4-da71-439f-885f-020f70349f21::0.0.0.0:15021 10.96.56.243_10251::10.96.56.243:10251 10.0.0.6_10250::10.0.0.6:10250 10.244.0.51_8443::10.244.0.51:8443 10.0.0.5_10250::10.0.0.5:10250 10.97.190.96_10252::10.97.190.96:10252 10.96.0.1_443::10.96.0.1:443 10.96.0.10_53::10.96.0.10:53 10.105.226.65_80::10.105.226.65:80 10.105.226.65_82::10.105.226.65:82 0.0.0.0_80::0.0.0.0:80 10.0.0.6_4194::10.0.0.6:4194 10.105.226.65_443::10.105.226.65:443 10.105.226.65_81::10.105.226.65:81 10.0.0.5_4194::10.0.0.5:4194 10.102.134.81_14250::10.102.134.81:14250 10.107.39.113_9090::10.107.39.113:9090 0.0.0.0_10255::0.0.0.0:10255 0.0.0.0_20001::0.0.0.0:20001 0.0.0.0_9090::0.0.0.0:9090 10.96.0.10_9153::10.96.0.10:9153 10.102.134.81_14268::10.102.134.81:14268 0.0.0.0_9411::0.0.0.0:9411 10.101.93.145_8000::10.101.93.145:8000 10.99.79.173_443::10.99.79.173:443 10.105.226.65_8080::10.105.226.65:8080 0.0.0.0_9080::0.0.0.0:9080 10.108.161.174_3000::10.108.161.174:3000 virtualOutbound::0.0.0.0:15001 virtualInbound::0.0.0.0:15006 .. istio使用的端口\nPort Protocol Description Pod-internal only 15000 TCP envoy管理端口 Yes 15001 TCP envoy出站端口 No 15006 TCP envoy入站端口 No 15008 TCP envoy隧道端口 No 15020 HTTP 从istio-agent envoy 应用 合并prometheus遥测 No 15021 HTTP 健康检查端口 No 15090 HTTP Envoy Prometheus telemetry No envoy的listener通过绑定与IP Socket或者Unix Domain Socket，接收转发来的数据。\nVirtualOutboundListener | VirtualIntboundListener 通过一个端口接收所有出/入站流量，并根据目标端口来区分使用哪个Listener进行处理。\niptables通过对应规则拦截发往所在Pod的流量并转发到对应的Envoy接收端口（如入站流量为15006），该Listener通过配置将请求转发到请求原目标地址关联的Listener之上。envoy原始目标地址\n若不存在对应的listener则根据全局配置选项进行处理\nALLOW_ANY：允许外发至任何服务的请求，没有匹配到目标Listener的流量则由tcp_proxy过滤器指向的PassthroughCluster。 REGISTRY_ONLY：仅允许外发请求至注册过的服务，没有匹配到目标Listener的流量，则由tcp_proxy通过BlackHoleCluster丢弃。 监听端口配置参数bind_to_port的值为false，意味着该Listener并未真正绑定套接字上，而是通过对应的入站/出站Linstener接收兵转发流量。\nsidecar 流量的拦截 sidecar通过注入到Pod中的init，执行在 pod 命名空间中设置 iptable 规则来完成流量捕获并管理。\n通过查看nsenter 命令可以查看对应实现的内容。\niptables在NAT表中新建了4条链，ISTIO_INBOUND、ISTIO_IN_REDIRECT、ISTIO_OUTPUT 和 ISTIO_REDIRECT\n当进入Pod的流量会被PREROUTING 拦截处理。根据规则将数据包转发到ISOTIO_INBOUND。-A PREROUTING -p tcp -j ISTIO_INBOUND ISTIO_INBOUND处理对应的规则，当遇到15008 , 22 15090 15021 15020 不做处理，return给上一个链。 关于iptables return 剩余流量从ISTIO_INBOUND 转交给 ISTIO_IN_REDIRECT -A ISTIO_INBOUND -p tcp -j ISTIO_IN_REDIRECT ISTIO_IN_REDIRECT 将流量交给15006端口应用处理。 Envoy根据数据包的目的地址查看 Inbound方向的监听器配置，根据监听器及路由、Cluster、 Endpoint等配置，决定是否将数据包转发到应用。 OUTPUT的流量由规则 -A OUTPUT -p tcp -j ISTIO_OUTPUT 由 ISTIO_OUTPUT ` 链处理。 bash 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 $ nsenter -t `ps -ef|grep details|grep envoy|awk '{print $2}'` -n iptables -t nat -S -P PREROUTING ACCEPT -P INPUT ACCEPT -P OUTPUT ACCEPT -P POSTROUTING ACCEPT -N ISTIO_INBOUND -N ISTIO_IN_REDIRECT -N ISTIO_OUTPUT -N ISTIO_REDIRECT -A PREROUTING -p tcp -j ISTIO_INBOUND -A OUTPUT -p tcp -j ISTIO_OUTPUT -A ISTIO_INBOUND -p tcp -m tcp --dport 15008 -j RETURN -A ISTIO_INBOUND -p tcp -m tcp --dport 22 -j RETURN -A ISTIO_INBOUND -p tcp -m tcp --dport 15090 -j RETURN -A ISTIO_INBOUND -p tcp -m tcp --dport 15021 -j RETURN -A ISTIO_INBOUND -p tcp -m tcp --dport 15020 -j RETURN -A ISTIO_INBOUND -p tcp -j ISTIO_IN_REDIRECT # 到此入栈流量处理完成 -A ISTIO_IN_REDIRECT -p tcp -j REDIRECT --to-ports 15006 # 这里开始执行出站流量 # 原地址为127.0.0.6/32 不做处理 -A ISTIO_OUTPUT -s 127.0.0.6/32 -o lo -j RETURN # 默认目标127.0.0.1/32--uid-owner 1337的由ISTIO_IN_REDIRECT处理 -A ISTIO_OUTPUT ! -d 127.0.0.1/32 -o lo -m owner --uid-owner 1337 -j ISTIO_IN_REDIRECT -A ISTIO_OUTPUT -o lo -m owner ! --uid-owner 1337 -j RETURN -A ISTIO_OUTPUT -m owner --uid-owner 1337 -j RETURN -A ISTIO_OUTPUT ! -d 127.0.0.1/32 -o lo -m owner --gid-owner 1337 -j ISTIO_IN_REDIRECT # 这些流量都不做处理。继续默认操作 -A ISTIO_OUTPUT -o lo -m owner ! --gid-owner 1337 -j RETURN -A ISTIO_OUTPUT -m owner --gid-owner 1337 -j RETURN -A ISTIO_OUTPUT -d 127.0.0.1/32 -j RETURN # 默认所有ISTIO_OUTPUT链的流量都由ISTIO_REDIRECT -A ISTIO_OUTPUT -j ISTIO_REDIRECT # ISTIO_REDIRECT 的流量 默认有envoy进行处理转发到对应的应用 -A ISTIO_REDIRECT -p tcp -j REDIRECT --to-ports 15001 Istio中目前有两种流量拦截模式：REDIRECT模式和TPROXY模式。\nTPROXY transparent proxy 透明代理，操作的是mangle表，同时需要原始客户端socket设置 IP_TRANSPARENT选项，此模式同时保留源IP地址和目标IP地址和端口。\nREDIRECT ：端口重定向，将流量NAT至envoy，此模式会丢失源IP。\nsidecar资源配置 Sidecar这个资源清单描述了Sidecar代理的配置，从而管理他所连接的workload实例的流量。\nworkloadSelector：选择sidecar应用此配置的Pod，如省略则为该名称空间的所有workload lables: 配置pod的标签 ingress：用于指定连接workload的入站流量的sidecar配置，如省略，则从默认获取。 port：Listener关联的端口 bind：Listener绑定的IP，ingress不允许unix套接字 captureMode： 流量捕获模式，仅Listener绑定到IP时适用。 DEFAULT 环境定义默认配置 IPTABLES ：使用IPtables重定向流量 NONE 不捕获。 egress: 用于指定workload的出站流量的sidecar配置，如省略，则继承默认值 port：Listener关联的端口 bind：Listener绑定的IP或套接字 captureMode： 流量捕获模式，仅Listener绑定到IP时适用。 DEFAULT 环境定义默认配置 IPTABLES ：使用IPtables重定向流量 NONE 不捕获。 hosts：目标地址，namespace/dnsName格式显示的一台或多台服务主机 outboundTrafficPolicy：出站流量策略的配置，不指定则继承默认值。 mode： REGISTRY_ONLY：仅允许注册到pilot的服务通过。 ALLOW_ANY：没有配置的，允许流量的出站。 声明一个出站流量 下面的示例在Sidecar名为的根命名空间中声明了全局默认配置istio-config，该配置在所有命名空间中配置了sidecars，以仅允许将流量发送到同一命名空间中的其他workload以及istio-system命名空间中的服务 。\nyaml 1 2 3 4 5 6 7 8 9 10 apiVersion: networking.istio.io/v1alpha3 kind: Sidecar metadata: name: default namespace: istio-config spec: egress: - hosts: - \"./*\" - \"istio-system/*\" 以下示例配置一个应用的出站与入站规则；在名称空间prod-us1中声明所有app: ratings 属于该prod-us1/ratings 带有标签的Pod 。workload在端口9080上接受入站HTTP通信。然后，将通信转发到侦听Unix套接字的附加workload实例。在出口流量，除了允许发给istio-system 名称空间任何端口任何Pod的流量，如果是9080端口，允许发送给prod-us1名称空间下的所有的服务。\nyaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 apiVersion: networking.istio.io/v1alpha3 kind: Sidecar metadata: name: ratings namespace: prod-us1 spec: workloadSelector: labels: app: ratings ingress: - port: number: 9080 protocol: HTTP name: somename defaultEndpoint: unix:///var/run/someuds.sock egress: - port: number: 9080 protocol: HTTP name: egresshttp hosts: - \"prod-us1/*\" - hosts: - \"istio-system/*\" ","wordCount":"654","inLanguage":"zh","datePublished":"2021-01-09T00:00:00Z","dateModified":"2023-03-22T23:00:36+08:00","author":{"@type":"Person","name":"cylon"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.oomkill.com/2021/01/istio-sidecar-mechnisim/"},"publisher":{"@type":"Organization","name":"Cylon's Collection","logo":{"@type":"ImageObject","url":"https://www.oomkill.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.oomkill.com/><img src=https://www.oomkill.com/favicon.ico alt aria-label=logo height=20>Cylon's Collection</a><div class=logo-switches><button id=theme-toggle><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://www.oomkill.com/archives><span>归档</span></a></li><li><a href=https://www.oomkill.com/tags><span>标签</span></a></li><li><a href=https://www.oomkill.com/search><span>搜索</span></a></li><li><a href=https://www.oomkill.com/about accesskey=/><span>关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">istio sidecar流量处理机制及配置</h1><div class=post-meta><span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar" style="user-select:text"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" style="user-select:text"/><line x1="16" y1="2" x2="16" y2="6" style="user-select:text"/><line x1="8" y1="2" x2="8" y2="6" style="user-select:text"/><line x1="3" y1="10" x2="21" y2="10" style="user-select:text"/></svg><span>2021-01-09</span></span>&nbsp;·&nbsp;<span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text" style="user-select:text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z" style="user-select:text"/><polyline points="14 2 14 8 20 8" style="user-select:text"/><line x1="16" y1="13" x2="8" y2="13" style="user-select:text"/><line x1="16" y1="17" x2="8" y2="17" style="user-select:text"/><polyline points="10 9 9 9 8 9" style="user-select:text"/></svg><span>654 字</span></span>&nbsp;·&nbsp;<span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><span>4 分钟</span></span>
<span class=pe-post-meta-item>&nbsp;·&nbsp;<svg t="1714036239378" fill="currentcolor" class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="6659" width="256" height="256"><path d="M690 78.2c-18.6-18.8-49-19-67.8-.4s-19 49-.4 67.8l255.4 258.6c67.8 68.6 67.8 178.8.0 247.4L653.4 878.2c-18.6 18.8-18.4 49.2.4 67.8s49.2 18.4 67.8-.4l224-226.4c104.8-106 104.8-276.4.0-382.4L690 78.2zM485.4 101.4c-24-24-56.6-37.4-90.6-37.4H96C43 64 0 107 0 160v299c0 34 13.4 66.6 37.4 90.6l336 336c50 50 131 50 181 0l267-267c50-50 50-131 0-181l-336-336zM96 160h299c8.4.0 16.6 3.4 22.6 9.4l336 336c12.4 12.4 12.4 32.8.0 45.2l-267 267c-12.4 12.4-32.8 12.4-45.2.0l-336-336c-6-6-9.4-14.2-9.4-22.6V160zm192 128a64 64 0 10-128 0 64 64 0 10128 0z" p-id="6660"/></svg></span><ul class=pe-post-meta-item><a href=https://www.oomkill.com/tags/service-mech/>#Service Mech</a></ul>&nbsp;·&nbsp;<span id=busuanzi_container_page_pv>本文阅读量 <span id=busuanzi_value_page_pv></span> 次</span></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details><summary><span class=details>目录</span></summary><div class=inner><ul><li><a href=#sidecar-%e4%bb%8b%e7%bb%8d aria-label="sidecar 介绍">sidecar 介绍</a><li><a href=#sidecar%e7%9a%84%e6%b3%a8%e5%85%a5 aria-label=sidecar的注入>sidecar的注入</a><ul><li><a href=#sidecar%e8%a2%ab%e6%b3%a8%e5%85%a5%e7%9a%84%e6%96%b9%e5%bc%8f aria-label=sidecar被注入的方式>sidecar被注入的方式</a></ul><li><a href=#istio-injector-%e6%b3%a8%e5%85%a5%e5%8e%9f%e7%90%86 aria-label="istio injector 注入原理">istio injector 注入原理</a><li><a href=#sidecar%e5%ae%b9%e5%99%a8 aria-label=sidecar容器>sidecar容器</a><li><a href=#envoy%e7%9a%84listener aria-label=envoy的listener>envoy的listener</a><li><a href=#sidecar-%e6%b5%81%e9%87%8f%e7%9a%84%e6%8b%a6%e6%88%aa aria-label="sidecar 流量的拦截">sidecar 流量的拦截</a><li><a href=#sidecar%e8%b5%84%e6%ba%90%e9%85%8d%e7%bd%ae aria-label=sidecar资源配置>sidecar资源配置</a><ul><li><a href=#%e5%a3%b0%e6%98%8e%e4%b8%80%e4%b8%aa%e5%87%ba%e7%ab%99%e6%b5%81%e9%87%8f aria-label=声明一个出站流量>声明一个出站流量</a></li></div></details></div></aside><script src=/js/pe-toc.min.445eb1bfc5e85dd13b9519fcc2a806522e9629b6224a2974052789ba00ab78af.js integrity="sha256-RF6xv8XoXdE7lRn8wqgGUi6WKbYiSil0BSeJugCreK8="></script><div class=post-content><h2 id=sidecar-介绍>sidecar 介绍<a hidden class=anchor aria-hidden=true href=#sidecar-介绍>#</a></h2><p>在istio的流量管理等功能，都需要通过下发的配置应用到应用运行环境执行后生效，负责执行配置规则的组件在service mesh中承载应用代理的实体被称为<code>side-car</code></p><p>Istio对流量策略管理等功能无须对应用程序做变动，</p><p>这种对应用服务完全非侵入的方式完全依赖于Side-car，应用的流量有Sidecar拦截并进行认证、鉴权、策略执行等治理功能。在Kubernetes平台中，Side-car容器于应用容器在同一个Pod中并共享网络名词控件，因此Side-car容易可以通过iptables规则拦截进出流量进行管理。</p><h2 id=sidecar的注入>sidecar的注入<a hidden class=anchor aria-hidden=true href=#sidecar的注入>#</a></h2><p>sidecar是service mesh无侵入式架构的应用模式，在使用sidecar部署服务网格时，无需再每个应用节点运行服务代理，但是需要在每个应用程序中部署一个sidecar容器，来接管所有进出流量。</p><p>Sidecar会将额外容器注入到 Pod 模板中。Istio中的数据平面组件所需的容器有：</p><ul><li><code>istio-init</code> 用于设置容器的iptables规则，目的是为了接管进出流量。在应用容器前启动并运行完成其生命周期，多个init容器按顺序依次完成。</li><li><code>istio-proxy</code> 基于envoy的sidecar的代理。</li></ul><h3 id=sidecar被注入的方式>sidecar被注入的方式<a hidden class=anchor aria-hidden=true href=#sidecar被注入的方式>#</a></h3><ul><li><p>手动注入，使用 <a href=https://istio.io/latest/zh/docs/reference/commands/istioctl target=_blank rel="noopener nofollow noreferrer"><code>istioctl</code></a> 修改容器模板并添加前面提到的两个容器的配置。不论是手动注入还是自动注入，Istio 都从 <code>istio-sidecar-injector</code> 和的 <code>istio</code> 两个 Configmap 对象中获取配置。 <a href=https://istio.io/latest/zh/blog/2019/data-plane-setup/#manual-injection target=_blank rel="noopener nofollow noreferrer">refer-istio-sidecar-injector</a></p></li><li><p>自动注入，在部署应用是，istio自动将sidecar注入到pod。这是istio推荐的方法，Istio在基于Kubernetes平台之上，需要在部署应用之前，对要标记部署应用程序的名称空间标记 <code>kubectl label namespace default istio-injection=enabled</code> <strong>这个操作是对名称空间级别生效的</strong>。而后所部署的Pod中会注入sidecar执行上面sidecar容器的操作。</p></li></ul><h2 id=istio-injector-注入原理>istio injector 注入原理<a hidden class=anchor aria-hidden=true href=#istio-injector-注入原理>#</a></h2><p>Sidecar Injector是Istio中实现自动注入Sidecar的组件，它是以Kubernetes准入控制器 AdmissionController 的形式运行的。Admission Controller 的基本工作原理是拦截Kube-apiserver的请求，在对象持久化之前、认证鉴权之后进行拦截。</p><p>Admission Controller有两种：一种是内置的，另一种是用户自定义的。</p><p>Kubernetes允许用户以Webhook的方式自定义准入控制器，Sidecar Injector就是这样一种特殊的MutatingAdmissionWebhook。</p><p>Sidecar Injector只在创建Pod时进行Sidecar容器注入，在Pod的创建请求到达 Kube-apiserver 后，首先进行认证鉴权，然后在准入控制阶段，Kube-apiserver以REST的方式同步调用Sidecar Injector Webhook服务进行init与istio-proxy容器的注入，最后将Pod对象持久化存储到etcd中。</p><h2 id=sidecar容器>sidecar容器<a hidden class=anchor aria-hidden=true href=#sidecar容器>#</a></h2><p>sidecar容器内部运行着 <code>pilot-agent</code> 与 <code>envoy</code></p><p>Pilot-agent：基于kubernetesAPI资源对象为envoy初始化可用的bootstrap配置进行启动，在运行后管理envoy运行状态，如配置变更，出错重启等。</p><p>envoy：数据平面的执行层，由 <code>pilot-agent</code> 所启动的，从xDS API动态获取配置信息。Envoy并通过流量拦截机制处理入栈及出栈的流量。</p><h2 id=envoy的listener>envoy的listener<a hidden class=anchor aria-hidden=true href=#envoy的listener>#</a></h2><p>在运行在Kubernetes平台之上的istio，Envoy是通过Pilot将Kubernetes CRD资源 <code>DestnationRule</code> <code>VirtualService</code> <code>Gateway</code>等资源提供的配置，生成对应的Envoy配置。</p><p>每个sidecar中的envoy都会生成众多的配置，这些配置在每一个网格中会对对应的流量进行拦截管理。</p><p>通过envoy admin interface查看对应生产的envoy资源配置信息</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl <span class=nb>exec</span> reviews-v1-6549ddccc5-k995p -c istio-proxy -- curl -s 127.0.0.1:15000/listeners
</span></span><span class=line><span class=cl>97591f7a-0cbf-469a-a5f2-c9a76a3d0ced::0.0.0.0:15090
</span></span><span class=line><span class=cl>e523c9a4-da71-439f-885f-020f70349f21::0.0.0.0:15021
</span></span><span class=line><span class=cl>10.96.56.243_10251::10.96.56.243:10251
</span></span><span class=line><span class=cl>10.0.0.6_10250::10.0.0.6:10250
</span></span><span class=line><span class=cl>10.244.0.51_8443::10.244.0.51:8443
</span></span><span class=line><span class=cl>10.0.0.5_10250::10.0.0.5:10250
</span></span><span class=line><span class=cl>10.97.190.96_10252::10.97.190.96:10252
</span></span><span class=line><span class=cl>10.96.0.1_443::10.96.0.1:443
</span></span><span class=line><span class=cl>10.96.0.10_53::10.96.0.10:53
</span></span><span class=line><span class=cl>10.105.226.65_80::10.105.226.65:80
</span></span><span class=line><span class=cl>10.105.226.65_82::10.105.226.65:82
</span></span><span class=line><span class=cl>0.0.0.0_80::0.0.0.0:80
</span></span><span class=line><span class=cl>10.0.0.6_4194::10.0.0.6:4194
</span></span><span class=line><span class=cl>10.105.226.65_443::10.105.226.65:443
</span></span><span class=line><span class=cl>10.105.226.65_81::10.105.226.65:81
</span></span><span class=line><span class=cl>10.0.0.5_4194::10.0.0.5:4194
</span></span><span class=line><span class=cl>10.102.134.81_14250::10.102.134.81:14250
</span></span><span class=line><span class=cl>10.107.39.113_9090::10.107.39.113:9090
</span></span><span class=line><span class=cl>0.0.0.0_10255::0.0.0.0:10255
</span></span><span class=line><span class=cl>0.0.0.0_20001::0.0.0.0:20001
</span></span><span class=line><span class=cl>0.0.0.0_9090::0.0.0.0:9090
</span></span><span class=line><span class=cl>10.96.0.10_9153::10.96.0.10:9153
</span></span><span class=line><span class=cl>10.102.134.81_14268::10.102.134.81:14268
</span></span><span class=line><span class=cl>0.0.0.0_9411::0.0.0.0:9411
</span></span><span class=line><span class=cl>10.101.93.145_8000::10.101.93.145:8000
</span></span><span class=line><span class=cl>10.99.79.173_443::10.99.79.173:443
</span></span><span class=line><span class=cl>10.105.226.65_8080::10.105.226.65:8080
</span></span><span class=line><span class=cl>0.0.0.0_9080::0.0.0.0:9080
</span></span><span class=line><span class=cl>10.108.161.174_3000::10.108.161.174:3000
</span></span><span class=line><span class=cl>virtualOutbound::0.0.0.0:15001
</span></span><span class=line><span class=cl>virtualInbound::0.0.0.0:15006
</span></span><span class=line><span class=cl>..</span></span></code></pre></td></tr></table></div></div></div></div><p><a href=https://istio.io/latest/docs/ops/deployment/requirements/ target=_blank rel="noopener nofollow noreferrer">istio使用的端口</a></p><table><thead><tr><th>Port</th><th>Protocol</th><th>Description</th><th>Pod-internal only</th></tr></thead><tbody><tr><td>15000</td><td>TCP</td><td>envoy管理端口</td><td>Yes</td></tr><tr><td>15001</td><td>TCP</td><td>envoy出站端口</td><td>No</td></tr><tr><td>15006</td><td>TCP</td><td>envoy入站端口</td><td>No</td></tr><tr><td>15008</td><td>TCP</td><td>envoy隧道端口</td><td>No</td></tr><tr><td>15020</td><td>HTTP</td><td>从istio-agent envoy 应用 合并prometheus遥测</td><td>No</td></tr><tr><td>15021</td><td>HTTP</td><td>健康检查端口</td><td>No</td></tr><tr><td>15090</td><td>HTTP</td><td>Envoy Prometheus telemetry</td><td>No</td></tr></tbody></table><p>envoy的listener通过绑定与IP Socket或者Unix Domain Socket，接收转发来的数据。</p><p><code>VirtualOutboundListener</code> | <code>VirtualIntboundListener </code>通过一个端口接收所有出/入站流量，并根据目标端口来区分使用哪个Listener进行处理。</p><p>iptables通过对应规则拦截发往所在Pod的流量并转发到对应的Envoy接收端口（如入站流量为15006），该Listener通过配置将请求转发到请求原目标地址关联的Listener之上。<a href=https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/upstream/load_balancing/original_dst target=_blank rel="noopener nofollow noreferrer">envoy原始目标地址</a></p><p>若不存在对应的listener则根据全局配置选项进行处理</p><ul><li>ALLOW_ANY：允许外发至任何服务的请求，没有匹配到目标Listener的流量则由tcp_proxy过滤器指向的PassthroughCluster。</li><li>REGISTRY_ONLY：仅允许外发请求至注册过的服务，没有匹配到目标Listener的流量，则由tcp_proxy通过BlackHoleCluster丢弃。</li></ul><p>监听端口配置参数<code>bind_to_port</code>的值为false，意味着该Listener并未真正绑定套接字上，而是通过对应的入站/出站Linstener接收兵转发流量。</p><h2 id=sidecar-流量的拦截>sidecar 流量的拦截<a hidden class=anchor aria-hidden=true href=#sidecar-流量的拦截>#</a></h2><p>sidecar通过注入到Pod中的init，执行在 pod 命名空间中设置 <code>iptable</code> 规则来完成流量捕获并管理。</p><p>通过查看<code>nsenter</code> 命令可以查看对应实现的内容。</p><p>iptables在NAT表中新建了4条链，ISTIO_INBOUND、ISTIO_IN_REDIRECT、ISTIO_OUTPUT
和 ISTIO_REDIRECT</p><ul><li>当进入Pod的流量会被<code>PREROUTING</code> 拦截处理。根据规则将数据包转发到<code>ISOTIO_INBOUND</code>。<code>-A PREROUTING -p tcp -j ISTIO_INBOUND</code></li><li><code>ISTIO_INBOUND</code>处理对应的规则，当遇到<code>15008</code> , <code>22</code> <code>15090</code> <code>15021</code> <code>15020</code> 不做处理，return给上一个链。 <a href=https://bbs.csdn.net/topics/340237926 target=_blank rel="noopener nofollow noreferrer">关于iptables return</a></li><li>剩余流量从<code>ISTIO_INBOUND</code> 转交给 <code>ISTIO_IN_REDIRECT</code> <code>-A ISTIO_INBOUND -p tcp -j ISTIO_IN_REDIRECT</code></li><li><code>ISTIO_IN_REDIRECT</code> 将流量交给15006端口应用处理。</li><li>Envoy根据数据包的目的地址查看 Inbound方向的监听器配置，根据监听器及路由、Cluster、
Endpoint等配置，决定是否将数据包转发到应用。</li><li>OUTPUT的流量由规则 <code>-A OUTPUT -p tcp -j ISTIO_OUTPUT</code> 由 <code>ISTIO_OUTPUT</code> ` 链处理。</li></ul><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ nsenter -t <span class=sb>`</span>ps -ef<span class=p>|</span>grep details<span class=p>|</span>grep envoy<span class=p>|</span>awk <span class=s1>&#39;{print $2}&#39;</span><span class=sb>`</span> -n iptables -t nat -S 
</span></span><span class=line><span class=cl>-P PREROUTING ACCEPT
</span></span><span class=line><span class=cl>-P INPUT ACCEPT
</span></span><span class=line><span class=cl>-P OUTPUT ACCEPT
</span></span><span class=line><span class=cl>-P POSTROUTING ACCEPT
</span></span><span class=line><span class=cl>-N ISTIO_INBOUND
</span></span><span class=line><span class=cl>-N ISTIO_IN_REDIRECT
</span></span><span class=line><span class=cl>-N ISTIO_OUTPUT
</span></span><span class=line><span class=cl>-N ISTIO_REDIRECT
</span></span><span class=line><span class=cl>-A PREROUTING -p tcp -j ISTIO_INBOUND
</span></span><span class=line><span class=cl>-A OUTPUT -p tcp -j ISTIO_OUTPUT
</span></span><span class=line><span class=cl>-A ISTIO_INBOUND -p tcp -m tcp --dport <span class=m>15008</span> -j RETURN
</span></span><span class=line><span class=cl>-A ISTIO_INBOUND -p tcp -m tcp --dport <span class=m>22</span> -j RETURN
</span></span><span class=line><span class=cl>-A ISTIO_INBOUND -p tcp -m tcp --dport <span class=m>15090</span> -j RETURN
</span></span><span class=line><span class=cl>-A ISTIO_INBOUND -p tcp -m tcp --dport <span class=m>15021</span> -j RETURN
</span></span><span class=line><span class=cl>-A ISTIO_INBOUND -p tcp -m tcp --dport <span class=m>15020</span> -j RETURN
</span></span><span class=line><span class=cl>-A ISTIO_INBOUND -p tcp -j ISTIO_IN_REDIRECT 
</span></span><span class=line><span class=cl><span class=c1># 到此入栈流量处理完成</span>
</span></span><span class=line><span class=cl>-A ISTIO_IN_REDIRECT -p tcp -j REDIRECT --to-ports <span class=m>15006</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 这里开始执行出站流量</span>
</span></span><span class=line><span class=cl><span class=c1># 原地址为127.0.0.6/32 不做处理</span>
</span></span><span class=line><span class=cl>-A ISTIO_OUTPUT -s 127.0.0.6/32 -o lo -j RETURN
</span></span><span class=line><span class=cl><span class=c1># 默认目标127.0.0.1/32--uid-owner 1337的由ISTIO_IN_REDIRECT处理</span>
</span></span><span class=line><span class=cl>-A ISTIO_OUTPUT ! -d 127.0.0.1/32 -o lo -m owner --uid-owner <span class=m>1337</span> -j ISTIO_IN_REDIRECT
</span></span><span class=line><span class=cl>-A ISTIO_OUTPUT -o lo -m owner ! --uid-owner <span class=m>1337</span> -j RETURN
</span></span><span class=line><span class=cl>-A ISTIO_OUTPUT -m owner --uid-owner <span class=m>1337</span> -j RETURN
</span></span><span class=line><span class=cl>-A ISTIO_OUTPUT ! -d 127.0.0.1/32 -o lo -m owner --gid-owner <span class=m>1337</span> -j ISTIO_IN_REDIRECT
</span></span><span class=line><span class=cl><span class=c1># 这些流量都不做处理。继续默认操作</span>
</span></span><span class=line><span class=cl>-A ISTIO_OUTPUT -o lo -m owner ! --gid-owner <span class=m>1337</span> -j RETURN
</span></span><span class=line><span class=cl>-A ISTIO_OUTPUT -m owner --gid-owner <span class=m>1337</span> -j RETURN
</span></span><span class=line><span class=cl>-A ISTIO_OUTPUT -d 127.0.0.1/32 -j RETURN
</span></span><span class=line><span class=cl><span class=c1># 默认所有ISTIO_OUTPUT链的流量都由ISTIO_REDIRECT</span>
</span></span><span class=line><span class=cl>-A ISTIO_OUTPUT -j ISTIO_REDIRECT
</span></span><span class=line><span class=cl><span class=c1># ISTIO_REDIRECT 的流量 默认有envoy进行处理转发到对应的应用</span>
</span></span><span class=line><span class=cl>-A ISTIO_REDIRECT -p tcp -j REDIRECT --to-ports <span class=m>15001</span></span></span></code></pre></td></tr></table></div></div></div></div><p>Istio中目前有两种流量拦截模式：REDIRECT模式和TPROXY模式。</p><p>TPROXY transparent proxy 透明代理，操作的是mangle表，同时需要原始客户端socket设置
IP_TRANSPARENT选项，此模式同时保留源IP地址和目标IP地址和端口。</p><p>REDIRECT ：端口重定向，将流量NAT至envoy，此模式会丢失源IP。</p><h2 id=sidecar资源配置>sidecar资源配置<a hidden class=anchor aria-hidden=true href=#sidecar资源配置>#</a></h2><p><code>Sidecar</code>这个资源清单描述了Sidecar代理的配置，从而管理他所连接的workload实例的流量。</p><ul><li><code>workloadSelector</code>：选择sidecar应用此配置的Pod，如省略则为该名称空间的所有workload<ul><li>lables: 配置pod的标签</li></ul></li><li><a href=https://istio.io/latest/docs/reference/config/networking/sidecar/#IstioIngressListener target=_blank rel="noopener nofollow noreferrer">ingress</a>：用于指定连接workload的入站流量的sidecar配置，如省略，则从默认获取。<ul><li>port：Listener关联的端口</li><li>bind：Listener绑定的IP，ingress不允许unix套接字</li><li><a href=https://istio.io/latest/docs/reference/config/networking/sidecar/#CaptureMode target=_blank rel="noopener nofollow noreferrer">captureMode</a>： 流量捕获模式，仅Listener绑定到IP时适用。<ul><li><code>DEFAULT</code> 环境定义默认配置</li><li><code>IPTABLES</code> ：使用IPtables重定向流量</li><li><code>NONE</code> 不捕获。</li></ul></li></ul></li><li><code>egress</code>: 用于指定workload的出站流量的sidecar配置，如省略，则继承默认值<ul><li><a href=https://istio.io/latest/docs/reference/config/networking/gateway/#Port target=_blank rel="noopener nofollow noreferrer">port</a>：Listener关联的端口</li><li>bind：Listener绑定的IP或套接字</li><li><a href=https://istio.io/latest/docs/reference/config/networking/sidecar/#CaptureMode target=_blank rel="noopener nofollow noreferrer">captureMode</a>： 流量捕获模式，仅Listener绑定到IP时适用。<ul><li><code>DEFAULT</code> 环境定义默认配置</li><li><code>IPTABLES</code> ：使用IPtables重定向流量</li><li><code>NONE</code> 不捕获。</li></ul></li><li>hosts：目标地址，<code>namespace/dnsName</code>格式显示的一台或多台服务主机</li></ul></li><li><a href=https://istio.io/latest/docs/reference/config/networking/sidecar/#OutboundTrafficPolicy target=_blank rel="noopener nofollow noreferrer">outboundTrafficPolicy</a>：出站流量策略的配置，不指定则继承默认值。<ul><li><a href=https://istio.io/latest/docs/reference/config/networking/sidecar/#OutboundTrafficPolicy-Mode target=_blank rel="noopener nofollow noreferrer">mode</a>：<ul><li>REGISTRY_ONLY：仅允许注册到pilot的服务通过。</li><li>ALLOW_ANY：没有配置的，允许流量的出站。</li></ul></li></ul></li></ul><h3 id=声明一个出站流量>声明一个出站流量<a hidden class=anchor aria-hidden=true href=#声明一个出站流量>#</a></h3><p>下面的示例在<code>Sidecar</code>名为的根命名空间中声明了全局默认配置<code>istio-config</code>，该配置在所有命名空间中配置了sidecars，以仅允许将流量发送到同一命名空间中的其他<code>workload</code>以及<code>istio-system</code>命名空间中的服务 。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>yaml</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.istio.io/v1alpha3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Sidecar</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>istio-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>egress</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>hosts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=s2>&#34;./*&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=s2>&#34;istio-system/*&#34;</span></span></span></code></pre></td></tr></table></div></div></div></div><p>以下示例配置一个应用的出站与入站规则；在名称空间<code>prod-us1</code>中声明所有<code>app: ratings</code> 属于该<code>prod-us1/ratings</code> 带有标签的Pod 。workload在端口9080上接受入站HTTP通信。然后，将通信转发到侦听Unix套接字的附加workload实例。在出口流量，除了允许发给<code>istio-system</code> 名称空间任何端口任何Pod的流量，如果是9080端口，允许发送给<code>prod-us1</code>名称空间下的所有的服务。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>yaml</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.istio.io/v1alpha3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Sidecar</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ratings</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>prod-us1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>workloadSelector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>ratings</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ingress</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>port</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>number</span><span class=p>:</span><span class=w> </span><span class=m>9080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>HTTP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>somename</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>defaultEndpoint</span><span class=p>:</span><span class=w> </span><span class=l>unix:///var/run/someuds.sock</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>egress</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>port</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>number</span><span class=p>:</span><span class=w> </span><span class=m>9080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>HTTP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>egresshttp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>hosts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=s2>&#34;prod-us1/*&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>hosts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=s2>&#34;istio-system/*&#34;</span></span></span></code></pre></td></tr></table></div></div></div></div></div><div class=pe-copyright><hr><blockquote><p>本文为原创内容，版权归作者所有。如需转载，请在文章中声明本文标题及链接。</p><p>文章标题：istio sidecar流量处理机制及配置</p><p>文章链接：<a href=https://www.oomkill.com/2021/01/istio-sidecar-mechnisim/ target=_blank>https://www.oomkill.com/2021/01/istio-sidecar-mechnisim/</a></p><p>许可协议：<a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></p></blockquote></div><div class=comments-separator></div><h3 class=relatedContentTitle>相关阅读</h3><ul class=relatedContent><li><a href=/2021/01/istio-deployment-qa/><span>istio部署问题Q&amp;A</span></a></li><li><a href=/2020/12/istio-introduction/><span>istio流量管理：非侵入式流量治理</span></a></li><li><a href=/2020/08/istio-cli/><span>istio命令</span></a></li><li><a href=/2020/08/istio-install/><span>istio安装</span></a></li></ul><div class=comments-separator></div><footer class=post-footer><ul class=post-tags><li><a href=https://www.oomkill.com/tags/service-mech/>Service Mech</a></li></ul><nav class=paginav><a class=prev href=https://www.oomkill.com/2021/01/linux-network-command/><span class=title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left" style="user-select:text"><line x1="19" y1="12" x2="5" y2="12" style="user-select:text"/><polyline points="12 19 5 12 12 5" style="user-select:text"/></polyline></svg>&nbsp;</span>
<span>长期总结 - Linux网络命令合集</span>
</a><a class=next href=https://www.oomkill.com/2021/01/istio-deployment-qa/><span class=title></span>
<span>istio部署问题Q&amp;A&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right" style="user-select:text"><line x1="5" y1="12" x2="19" y2="12" style="user-select:text"/><polyline points="12 5 19 12 12 19" style="user-select:text"/></svg></span></a></nav></footer><div class=pe-comments-decoration><p class=pe-comments-title></p><p class=pe-comments-subtitle></p></div><div id=pe-comments></div><script src=/js/pe-go-comment.min.86a214102576ba5f9b7bdc29eed8d58dd56e34aef80b3c65c73ea9cc88443696.js integrity="sha256-hqIUECV2ul+be9wp7tjVjdVuNK74Czxlxz6pzIhENpY="></script><script>const getStoredTheme=()=>localStorage.getItem("pref-theme")==="dark"?"dark":"light",setGiscusTheme=()=>{const e=e=>{const t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:e},"https://giscus.app")};e({setConfig:{theme:getStoredTheme()}})};document.addEventListener("DOMContentLoaded",()=>{const s={src:"https://giscus.app/client.js","data-repo":"cylonchau/cylonchau.github.io","data-repo-id":"R_kgDOIRlNSQ","data-category":"Announcements","data-category-id":"DIC_kwDOIRlNSc4CXy1U","data-mapping":"pathname","data-term":"posts/istio sidecar mechnisim","data-strict":"0","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"top","data-theme":getStoredTheme(),"data-lang":"zh-TW","data-loading":"lazy",crossorigin:"anonymous",async:""},e=document.createElement("script");Object.entries(s).forEach(([t,n])=>e.setAttribute(t,n)),document.querySelector("#pe-comments").appendChild(e);const t=document.querySelector("#theme-toggle");t&&t.addEventListener("click",setGiscusTheme);const n=document.querySelector("#theme-toggle-float");n&&n.addEventListener("click",setGiscusTheme)})</script></article></main><footer class=footer><span>&copy; 2024 <a href=https://www.oomkill.com/>Cylon's Collection</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> on
<a href=https://pages.github.com/ rel=noopener target=_blank>GitHub Pages</a> & Theme
        <a href=https://github.com/tofuwine/PaperMod-PE rel=noopener target=_blank>PaperMod-PE</a></span><div class=busuanzi-footer style="font-family:helvetica neue,Helvetica,Arial,sans-serif;text-align:center;padding:4px 0;color:#999"><span id=busuanzi_container_site_pv style=margin-right:8px;font-size:.85em>本站总访问量<span id=busuanzi_value_site_pv style=font-weight:500>0</span>次
</span><span id=busuanzi_container_site_uv style=font-size:.85em>本站访客数<span id=busuanzi_value_site_uv style=font-weight:500>0</span>人次</span></div></footer><div class=pe-right-sidebar><a href=javascript:void(0); id=theme-toggle-float class=pe-float-btn><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</a><a href=#top class=pe-float-btn id=top-link><span id=pe-read-progress></span></a></div><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>