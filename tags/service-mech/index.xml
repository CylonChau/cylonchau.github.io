<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>service mech on Cylon&#39;s Collection</title>
    <link>https://www.oomkill.com/tags/service-mech/</link>
    <description>Recent content in service mech on Cylon&#39;s Collection</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>zh-cn</language>
    <lastBuildDate>Sat, 09 Jan 2021 00:00:00 +0000</lastBuildDate><atom:link href="https://www.oomkill.com/tags/service-mech/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>istio sidecar流量处理机制及配置</title>
      <link>https://www.oomkill.com/2021/01/istio-sidecar-mechnisim/</link>
      <pubDate>Sat, 09 Jan 2021 00:00:00 +0000</pubDate>
      
      <guid>https://www.oomkill.com/2021/01/istio-sidecar-mechnisim/</guid>
      <description></description>
      <content:encoded><![CDATA[<h2 id="sidecar-介绍">sidecar 介绍</h2>
<p>在istio的流量管理等功能，都需要通过下发的配置应用到应用运行环境执行后生效，负责执行配置规则的组件在service mesh中承载应用代理的实体被称为<code>side-car</code></p>
<p>Istio对流量策略管理等功能无须对应用程序做变动，</p>
<p>这种对应用服务完全非侵入的方式完全依赖于Side-car，应用的流量有Sidecar拦截并进行认证、鉴权、策略执行等治理功能。在Kubernetes平台中，Side-car容器于应用容器在同一个Pod中并共享网络名词控件，因此Side-car容易可以通过iptables规则拦截进出流量进行管理。</p>
<h2 id="sidecar的注入">sidecar的注入</h2>
<p>sidecar是service mesh无侵入式架构的应用模式，在使用sidecar部署服务网格时，无需再每个应用节点运行服务代理，但是需要在每个应用程序中部署一个sidecar容器，来接管所有进出流量。</p>
<p>Sidecar会将额外容器注入到 Pod 模板中。Istio中的数据平面组件所需的容器有：</p>
<ul>
<li><code>istio-init</code> 用于设置容器的iptables规则，目的是为了接管进出流量。在应用容器前启动并运行完成其生命周期，多个init容器按顺序依次完成。</li>
<li><code>istio-proxy</code> 基于envoy的sidecar的代理。</li>
</ul>
<h3 id="sidecar被注入的方式">sidecar被注入的方式</h3>
<ul>
<li>
<p>手动注入，使用 <a href="https://istio.io/latest/zh/docs/reference/commands/istioctl" target="_blank"
   rel="noopener nofollow noreferrer" ><code>istioctl</code></a> 修改容器模板并添加前面提到的两个容器的配置。不论是手动注入还是自动注入，Istio 都从 <code>istio-sidecar-injector</code> 和的 <code>istio</code> 两个 Configmap 对象中获取配置。 <a href="https://istio.io/latest/zh/blog/2019/data-plane-setup/#manual-injection" target="_blank"
   rel="noopener nofollow noreferrer" >refer-istio-sidecar-injector</a></p>
</li>
<li>
<p>自动注入，在部署应用是，istio自动将sidecar注入到pod。这是istio推荐的方法，Istio在基于Kubernetes平台之上，需要在部署应用之前，对要标记部署应用程序的名称空间标记 <code>kubectl label namespace default istio-injection=enabled</code> <strong>这个操作是对名称空间级别生效的</strong>。而后所部署的Pod中会注入sidecar执行上面sidecar容器的操作。</p>
</li>
</ul>
<h2 id="istio-injector-注入原理">istio injector 注入原理</h2>
<p>Sidecar  Injector是Istio中实现自动注入Sidecar的组件，它是以Kubernetes准入控制器  AdmissionController 的形式运行的。Admission Controller 的基本工作原理是拦截Kube-apiserver的请求，在对象持久化之前、认证鉴权之后进行拦截。</p>
<p>Admission Controller有两种：一种是内置的，另一种是用户自定义的。</p>
<p>Kubernetes允许用户以Webhook的方式自定义准入控制器，Sidecar  Injector就是这样一种特殊的MutatingAdmissionWebhook。</p>
<p>Sidecar  Injector只在创建Pod时进行Sidecar容器注入，在Pod的创建请求到达  Kube-apiserver  后，首先进行认证鉴权，然后在准入控制阶段，Kube-apiserver以REST的方式同步调用Sidecar Injector Webhook服务进行init与istio-proxy容器的注入，最后将Pod对象持久化存储到etcd中。</p>
<h2 id="sidecar容器">sidecar容器</h2>
<p>sidecar容器内部运行着 <code>pilot-agent</code> 与 <code>envoy</code></p>
<p>Pilot-agent：基于kubernetesAPI资源对象为envoy初始化可用的bootstrap配置进行启动，在运行后管理envoy运行状态，如配置变更，出错重启等。</p>
<p>envoy：数据平面的执行层，由 <code>pilot-agent</code> 所启动的，从xDS API动态获取配置信息。Envoy并通过流量拦截机制处理入栈及出栈的流量。</p>
<h2 id="envoy的listener">envoy的listener</h2>
<p>在运行在Kubernetes平台之上的istio，Envoy是通过Pilot将Kubernetes CRD资源 <code>DestnationRule</code> <code>VirtualService</code> <code>Gateway</code>等资源提供的配置，生成对应的Envoy配置。</p>
<p>每个sidecar中的envoy都会生成众多的配置，这些配置在每一个网格中会对对应的流量进行拦截管理。</p>
<p>通过envoy admin interface查看对应生产的envoy资源配置信息</p>
<pre><code class="language-bash">$ kubectl exec reviews-v1-6549ddccc5-k995p -c istio-proxy -- curl -s 127.0.0.1:15000/listeners
97591f7a-0cbf-469a-a5f2-c9a76a3d0ced::0.0.0.0:15090
e523c9a4-da71-439f-885f-020f70349f21::0.0.0.0:15021
10.96.56.243_10251::10.96.56.243:10251
10.0.0.6_10250::10.0.0.6:10250
10.244.0.51_8443::10.244.0.51:8443
10.0.0.5_10250::10.0.0.5:10250
10.97.190.96_10252::10.97.190.96:10252
10.96.0.1_443::10.96.0.1:443
10.96.0.10_53::10.96.0.10:53
10.105.226.65_80::10.105.226.65:80
10.105.226.65_82::10.105.226.65:82
0.0.0.0_80::0.0.0.0:80
10.0.0.6_4194::10.0.0.6:4194
10.105.226.65_443::10.105.226.65:443
10.105.226.65_81::10.105.226.65:81
10.0.0.5_4194::10.0.0.5:4194
10.102.134.81_14250::10.102.134.81:14250
10.107.39.113_9090::10.107.39.113:9090
0.0.0.0_10255::0.0.0.0:10255
0.0.0.0_20001::0.0.0.0:20001
0.0.0.0_9090::0.0.0.0:9090
10.96.0.10_9153::10.96.0.10:9153
10.102.134.81_14268::10.102.134.81:14268
0.0.0.0_9411::0.0.0.0:9411
10.101.93.145_8000::10.101.93.145:8000
10.99.79.173_443::10.99.79.173:443
10.105.226.65_8080::10.105.226.65:8080
0.0.0.0_9080::0.0.0.0:9080
10.108.161.174_3000::10.108.161.174:3000
virtualOutbound::0.0.0.0:15001
virtualInbound::0.0.0.0:15006
..
</code></pre>
<p><a href="https://istio.io/latest/docs/ops/deployment/requirements/" target="_blank"
   rel="noopener nofollow noreferrer" >istio使用的端口</a></p>
<table>
<thead>
<tr>
<th>Port</th>
<th>Protocol</th>
<th>Description</th>
<th>Pod-internal only</th>
</tr>
</thead>
<tbody>
<tr>
<td>15000</td>
<td>TCP</td>
<td>envoy管理端口</td>
<td>Yes</td>
</tr>
<tr>
<td>15001</td>
<td>TCP</td>
<td>envoy出站端口</td>
<td>No</td>
</tr>
<tr>
<td>15006</td>
<td>TCP</td>
<td>envoy入站端口</td>
<td>No</td>
</tr>
<tr>
<td>15008</td>
<td>TCP</td>
<td>envoy隧道端口</td>
<td>No</td>
</tr>
<tr>
<td>15020</td>
<td>HTTP</td>
<td>从istio-agent envoy 应用 合并prometheus遥测</td>
<td>No</td>
</tr>
<tr>
<td>15021</td>
<td>HTTP</td>
<td>健康检查端口</td>
<td>No</td>
</tr>
<tr>
<td>15090</td>
<td>HTTP</td>
<td>Envoy Prometheus telemetry</td>
<td>No</td>
</tr>
</tbody>
</table>
<p>envoy的listener通过绑定与IP Socket或者Unix Domain Socket，接收转发来的数据。</p>
<p><code>VirtualOutboundListener</code> | <code>VirtualIntboundListener </code>通过一个端口接收所有出/入站流量，并根据目标端口来区分使用哪个Listener进行处理。</p>
<p>iptables通过对应规则拦截发往所在Pod的流量并转发到对应的Envoy接收端口（如入站流量为15006），该Listener通过配置将请求转发到请求原目标地址关联的Listener之上。<a href="https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/upstream/load_balancing/original_dst" target="_blank"
   rel="noopener nofollow noreferrer" >envoy原始目标地址</a></p>
<p>若不存在对应的listener则根据全局配置选项进行处理</p>
<ul>
<li>ALLOW_ANY：允许外发至任何服务的请求，没有匹配到目标Listener的流量则由tcp_proxy过滤器指向的PassthroughCluster。</li>
<li>REGISTRY_ONLY：仅允许外发请求至注册过的服务，没有匹配到目标Listener的流量，则由tcp_proxy通过BlackHoleCluster丢弃。</li>
</ul>
<p>监听端口配置参数<code>bind_to_port</code>的值为false，意味着该Listener并未真正绑定套接字上，而是通过对应的入站/出站Linstener接收兵转发流量。</p>
<h2 id="sidecar-流量的拦截">sidecar 流量的拦截</h2>
<p>sidecar通过注入到Pod中的init，执行在 pod 命名空间中设置 <code>iptable</code> 规则来完成流量捕获并管理。</p>
<p>通过查看<code>nsenter</code> 命令可以查看对应实现的内容。</p>
<p>iptables在NAT表中新建了4条链，ISTIO_INBOUND、ISTIO_IN_REDIRECT、ISTIO_OUTPUT
和 ISTIO_REDIRECT</p>
<ul>
<li>当进入Pod的流量会被<code>PREROUTING</code> 拦截处理。根据规则将数据包转发到<code>ISOTIO_INBOUND</code>。<code>-A PREROUTING -p tcp -j ISTIO_INBOUND</code></li>
<li><code>ISTIO_INBOUND</code>处理对应的规则，当遇到<code>15008</code> , <code>22</code>  <code>15090</code>  <code>15021</code>  <code>15020</code> 不做处理，return给上一个链。 <a href="https://bbs.csdn.net/topics/340237926" target="_blank"
   rel="noopener nofollow noreferrer" >关于iptables return</a></li>
<li>剩余流量从<code>ISTIO_INBOUND</code> 转交给 <code>ISTIO_IN_REDIRECT</code> <code>-A ISTIO_INBOUND -p tcp -j ISTIO_IN_REDIRECT</code></li>
<li><code>ISTIO_IN_REDIRECT</code> 将流量交给15006端口应用处理。</li>
<li>Envoy根据数据包的目的地址查看  Inbound方向的监听器配置，根据监听器及路由、Cluster、
Endpoint等配置，决定是否将数据包转发到应用。</li>
<li>OUTPUT的流量由规则 <code>-A OUTPUT -p tcp -j ISTIO_OUTPUT</code> 由 <code>ISTIO_OUTPUT</code> ` 链处理。</li>
</ul>
<pre><code class="language-bash">$ nsenter -t `ps -ef|grep details|grep envoy|awk '{print $2}'` -n iptables -t nat -S 
-P PREROUTING ACCEPT
-P INPUT ACCEPT
-P OUTPUT ACCEPT
-P POSTROUTING ACCEPT
-N ISTIO_INBOUND
-N ISTIO_IN_REDIRECT
-N ISTIO_OUTPUT
-N ISTIO_REDIRECT
-A PREROUTING -p tcp -j ISTIO_INBOUND
-A OUTPUT -p tcp -j ISTIO_OUTPUT
-A ISTIO_INBOUND -p tcp -m tcp --dport 15008 -j RETURN
-A ISTIO_INBOUND -p tcp -m tcp --dport 22 -j RETURN
-A ISTIO_INBOUND -p tcp -m tcp --dport 15090 -j RETURN
-A ISTIO_INBOUND -p tcp -m tcp --dport 15021 -j RETURN
-A ISTIO_INBOUND -p tcp -m tcp --dport 15020 -j RETURN
-A ISTIO_INBOUND -p tcp -j ISTIO_IN_REDIRECT 
# 到此入栈流量处理完成
-A ISTIO_IN_REDIRECT -p tcp -j REDIRECT --to-ports 15006

# 这里开始执行出站流量
# 原地址为127.0.0.6/32 不做处理
-A ISTIO_OUTPUT -s 127.0.0.6/32 -o lo -j RETURN
# 默认目标127.0.0.1/32--uid-owner 1337的由ISTIO_IN_REDIRECT处理
-A ISTIO_OUTPUT ! -d 127.0.0.1/32 -o lo -m owner --uid-owner 1337 -j ISTIO_IN_REDIRECT
-A ISTIO_OUTPUT -o lo -m owner ! --uid-owner 1337 -j RETURN
-A ISTIO_OUTPUT -m owner --uid-owner 1337 -j RETURN
-A ISTIO_OUTPUT ! -d 127.0.0.1/32 -o lo -m owner --gid-owner 1337 -j ISTIO_IN_REDIRECT
# 这些流量都不做处理。继续默认操作
-A ISTIO_OUTPUT -o lo -m owner ! --gid-owner 1337 -j RETURN
-A ISTIO_OUTPUT -m owner --gid-owner 1337 -j RETURN
-A ISTIO_OUTPUT -d 127.0.0.1/32 -j RETURN
# 默认所有ISTIO_OUTPUT链的流量都由ISTIO_REDIRECT
-A ISTIO_OUTPUT -j ISTIO_REDIRECT
# ISTIO_REDIRECT 的流量 默认有envoy进行处理转发到对应的应用
-A ISTIO_REDIRECT -p tcp -j REDIRECT --to-ports 15001
</code></pre>
<p>Istio中目前有两种流量拦截模式：REDIRECT模式和TPROXY模式。</p>
<p>TPROXY transparent proxy 透明代理，操作的是mangle表，同时需要原始客户端socket设置
IP_TRANSPARENT选项，此模式同时保留源IP地址和目标IP地址和端口。</p>
<p>REDIRECT ：端口重定向，将流量NAT至envoy，此模式会丢失源IP。</p>
<h2 id="sidecar资源配置">sidecar资源配置</h2>
<p><code>Sidecar</code>这个资源清单描述了Sidecar代理的配置，从而管理他所连接的workload实例的流量。</p>
<ul>
<li><code>workloadSelector</code>：选择sidecar应用此配置的Pod，如省略则为该名称空间的所有workload
<ul>
<li>lables: 配置pod的标签</li>
</ul>
</li>
<li><a href="https://istio.io/latest/docs/reference/config/networking/sidecar/#IstioIngressListener" target="_blank"
   rel="noopener nofollow noreferrer" >ingress</a>：用于指定连接workload的入站流量的sidecar配置，如省略，则从默认获取。
<ul>
<li>port：Listener关联的端口</li>
<li>bind：Listener绑定的IP，ingress不允许unix套接字</li>
<li><a href="https://istio.io/latest/docs/reference/config/networking/sidecar/#CaptureMode" target="_blank"
   rel="noopener nofollow noreferrer" >captureMode</a>： 流量捕获模式，仅Listener绑定到IP时适用。
<ul>
<li><code>DEFAULT</code> 环境定义默认配置</li>
<li><code>IPTABLES</code> ：使用IPtables重定向流量</li>
<li><code>NONE</code> 不捕获。</li>
</ul>
</li>
</ul>
</li>
<li><code>egress</code>:  用于指定workload的出站流量的sidecar配置，如省略，则继承默认值
<ul>
<li><a href="https://istio.io/latest/docs/reference/config/networking/gateway/#Port" target="_blank"
   rel="noopener nofollow noreferrer" >port</a>：Listener关联的端口</li>
<li>bind：Listener绑定的IP或套接字</li>
<li><a href="https://istio.io/latest/docs/reference/config/networking/sidecar/#CaptureMode" target="_blank"
   rel="noopener nofollow noreferrer" >captureMode</a>： 流量捕获模式，仅Listener绑定到IP时适用。
<ul>
<li><code>DEFAULT</code> 环境定义默认配置</li>
<li><code>IPTABLES</code> ：使用IPtables重定向流量</li>
<li><code>NONE</code> 不捕获。</li>
</ul>
</li>
<li>hosts：目标地址，<code>namespace/dnsName</code>格式显示的一台或多台服务主机</li>
</ul>
</li>
<li><a href="https://istio.io/latest/docs/reference/config/networking/sidecar/#OutboundTrafficPolicy" target="_blank"
   rel="noopener nofollow noreferrer" >outboundTrafficPolicy</a>：出站流量策略的配置，不指定则继承默认值。
<ul>
<li><a href="https://istio.io/latest/docs/reference/config/networking/sidecar/#OutboundTrafficPolicy-Mode" target="_blank"
   rel="noopener nofollow noreferrer" >mode</a>：
<ul>
<li>REGISTRY_ONLY：仅允许注册到pilot的服务通过。</li>
<li>ALLOW_ANY：没有配置的，允许流量的出站。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="声明一个出站流量">声明一个出站流量</h3>
<p>下面的示例在<code>Sidecar</code>名为的根命名空间中声明了全局默认配置<code>istio-config</code>，该配置在所有命名空间中配置了sidecars，以仅允许将流量发送到同一命名空间中的其他<code>workload</code>以及<code>istio-system</code>命名空间中的服务 。</p>
<pre><code class="language-yaml">apiVersion: networking.istio.io/v1alpha3
kind: Sidecar
metadata:
  name: default
  namespace: istio-config
spec:
  egress:
  - hosts:
    - &quot;./*&quot;
    - &quot;istio-system/*&quot;
</code></pre>
<p>以下示例配置一个应用的出站与入站规则；在名称空间<code>prod-us1</code>中声明所有<code>app: ratings</code> 属于该<code>prod-us1/ratings</code> 带有标签的Pod 。workload在端口9080上接受入站HTTP通信。然后，将通信转发到侦听Unix套接字的附加workload实例。在出口流量，除了允许发给<code>istio-system</code> 名称空间任何端口任何Pod的流量，如果是9080端口，允许发送给<code>prod-us1</code>名称空间下的所有的服务。</p>
<pre><code class="language-yaml">apiVersion: networking.istio.io/v1alpha3
kind: Sidecar
metadata:
  name: ratings
  namespace: prod-us1
spec:
  workloadSelector:
    labels:
      app: ratings
  ingress:
  - port:
      number: 9080
      protocol: HTTP
      name: somename
    defaultEndpoint: unix:///var/run/someuds.sock
  egress:
  - port:
      number: 9080
      protocol: HTTP
      name: egresshttp
    hosts:
    - &quot;prod-us1/*&quot;
  - hosts:
    - &quot;istio-system/*&quot;
</code></pre>
]]></content:encoded>
    </item>
    
    <item>
      <title>istio部署问题Q&amp;A</title>
      <link>https://www.oomkill.com/2021/01/istio-deployment-qa/</link>
      <pubDate>Sun, 03 Jan 2021 00:00:00 +0000</pubDate>
      
      <guid>https://www.oomkill.com/2021/01/istio-deployment-qa/</guid>
      <description></description>
      <content:encoded><![CDATA[<h2 id="端口绑定无权限">端口绑定无权限</h2>
<p>创建Gateway，提示绑定端口无权限。</p>
<pre><code>2020-12-27T12:25:30.974288Z	warning	envoy config	
gRPC config for type.googleapis.com/envoy.config.listener.v3.Listener rejected: 
Error adding/updating listener(s) 0.0.0.0_90: cannot bind '0.0.0.0:90': Permission denied
</code></pre>
<p>问题原因：容器内默认权限不能使用非特权端口（&lt;1024</p>
<h2 id="导出部署清单部署失败">导出部署清单部署失败</h2>
<pre><code class="language-bash">istioctl manifest generate &gt; generated-manifest.yaml
</code></pre>
<p>如果尝试使用来安装和管理Istio istioctl manifest generate，请注意以下警告：</p>
<ul>
<li>Istio名称空间（istio-system默认情况下）必须手动创建。</li>
<li><code>istioctl install</code> 会从Kubernetes上下文中自动检测特定于环境的设置。如需手动安装需要执行如下步骤：
<ul>
<li><code>--set values.global.jwtPolicy=third-party-jwt</code></li>
<li><code>--set values.global.jwtPolicy=first-party-jwt</code></li>
</ul>
</li>
</ul>
<blockquote>
<p>refer</p>
<p><a href="https://istio.io/latest/docs/ops/best-practices/security/#configure-third-party-service-account-tokens" target="_blank"
   rel="noopener nofollow noreferrer" >token</a></p>
<p><a href="https://istio.io/latest/docs/setup/install/istioctl/#generate-a-manifest-before-installation" target="_blank"
   rel="noopener nofollow noreferrer" >Generate a manifest</a></p>
</blockquote>
]]></content:encoded>
    </item>
    
    <item>
      <title>istio流量管理：非侵入式流量治理</title>
      <link>https://www.oomkill.com/2020/12/istio-introduction/</link>
      <pubDate>Wed, 30 Dec 2020 00:00:00 +0000</pubDate>
      
      <guid>https://www.oomkill.com/2020/12/istio-introduction/</guid>
      <description></description>
      <content:encoded><![CDATA[<p>　　在服务治理中，流量管理是一个广泛的话题，一般情况下，常用的包括：</p>
<ul>
<li>动态修改服务访问的负载均衡策略，比如根据某个请求特征做会话保持；</li>
<li>同一个服务有多版本管理，将一部分流量切到某个版本上；</li>
<li>对服务进行保护，例如限制并发连接数、限制请求数、隔离故障服务实例等；</li>
<li>动态修改服务中的内容，或者模拟一个服务运行故障等。</li>
</ul>
<p>　　在Istio中实现这些服务治理功能时无须修改任何应用的代码。较之微服务的SDK方式，Istio以一种更轻便、透明的方式向用户提供了这些功能。用户可以用自己喜欢的任意语言和框架进行开发，专注于自己的业务，完全不用嵌入任何治理逻辑。只要应用运行在Istio的基础设施上，就可以使用这些治理能力。</p>
<p>　　总结Istio流量治理的目标：以基础设施的方式提供给用户非侵入的流量治理能力，用户只需关注自己的业务逻辑开发，无须关注服务访问管理。</p>
<h2 id="istio流量治理的核心组件pilot">istio流量治理的核心组件Pilot</h2>
<p>　　在istio1.8中，istio的分为 <code>envoy</code> （数据平面） 、<code>istiod</code> （控制平面） 、<code>addons</code>（管理插件） 及 <code>istioctl</code> （命令行工具，用于安装、配置、诊断分析等操作）组成。</p>
<p>　　Pilot是Istio控制平面流量管理的核心组件，管理和配置部署在Istio服务网格中的所有Envoy代理实例。</p>
<p>　　pilot-discovery为envoy sidecar提供服务发现，用于路由及流量的管理。通过kubernetes CRD资源获取网格的配置信息将其转换为xDS接口的标准数据格式后，通过gRPC分发至相关的envoy sidecar</p>
<p>　　Pilot组件包含工作在控制平面中的 <code>pilot-discovery</code> 和工作与数据平面的<code>pilot-agent </code> 与Envoy(istio-proxy)</p>
<p>　　pilot-discovery主要完成如下功能：<br></p>
<ul>
<li>从service registry中获取服务信息</li>
<li>从apiserver中获取配置信息。</li>
<li>将服务信息与配置信息适配为xDS接口的标准数据格式，通过xDS api完成配置分发。</li>
</ul>
<p>　　pilot-agent 主要完成如下功能<br></p>
<ul>
<li>
<p>基于kubernetes apiserver为envoy初始化可用的boostrap配置文件并启动envoy。</p>
</li>
<li>
<p>管理监控envoy的云兄状态及配置重载。</p>
</li>
</ul>
<p>envoy</p>
<ul>
<li>每个sidecar中的envoy是由pilot-agent基于生产的bootstrap配置进行启动，并根据指定的pilot地址，通过xDS api动态获取配置。</li>
<li>sidecar形式的envoy通过流量拦截机制为应用程序实现入站和出站的代理功能。</li>
</ul>
<h3 id="pilot的实现">Pilot的实现</h3>
<p>　　在istio中的管理策略都是基于Kubernetes CRD的实现，其中有关于流量管理的CRD资源包括 <code>VirtualService</code> <code>EnvoyFilter</code>  <code>Gateway</code> <code>ServiceEntry</code>  <code>Sidecar</code> <code>DestinationRule</code> <code>WorkloadEntry</code> <code>WorkloadGroup</code>。<a href="https://istio.io/latest/docs/reference/config/networking/" target="_blank"
   rel="noopener nofollow noreferrer" >reference istio-networking-crd-resouces</a></p>
<ul>
<li>
<p>VirtualServices：用于定义路由，可以理解为envoy的 <code>listener</code> =&gt; <code>filter</code> =&gt; <code>route_config</code></p>
</li>
<li>
<p>DestinationRule：用于定义集群，可以理解为envoy 的 cluster</p>
</li>
<li>
<p>Gateway：用于定义作用于<code>istio-ingress-gateway</code></p>
</li>
<li>
<p>ServiceEntry：用于定义出站的路由，作用于<code>istio-egress-gateway</code></p>
</li>
<li>
<p>EnvoyFilter：为envoy添加过滤器或过滤器链。</p>
</li>
<li>
<p>Sidecar：用于定义运行在sidecar之上的envoy配置。</p>
</li>
</ul>
<p>Virtual Services和 Destination Rules是Istio流量路由功能的核心组件</p>
<h3 id="istio流量流程概要">istio流量流程概要</h3>
<p>　　在控制面会经过如下流程：</p>
<ul>
<li>（1）管理员通过命令行或者API创建流量规则；</li>
<li>（2）Pilot将流量规则转换为Envoy的标准格式；</li>
<li>（3）Pilot将规则下发给Envoy。</li>
</ul>
<p>　　在数据面会经过如下流程：</p>
<ul>
<li>（1）Envoy拦截Pod上本地容器的Inbound流量和Outbound流量；</li>
<li>（2）在流量经过Envoy时执行对应的流量规则，对流量进行治理。</li>
</ul>
<h2 id="路由规则-virtual-services">路由规则 ：Virtual Services</h2>
<p><code>VirtualServices</code>是istio用于在其运行平台Kubernetes定义的配置，用来影响流量的路由规则；其本质就是为集群中envoy提供路由配置的。</p>
<h3 id="virtualservices名词解释">VirtualServices名词解释</h3>
<p>VirtualServices中一些流量路由定义的关键术语。</p>
<ul>
<li>
<p>Services：服务的唯一应用名称的单位，在Kubernetes之上 Services通常为Kubernetes Services资源。</p>
</li>
<li>
<p>Source：在上文中，下游发起请求的客户端服务。</p>
</li>
<li>
<p>Host：客户端请求服务时使用的地址</p>
</li>
<li>
<p>Service versions：service允许的不同版本的子集（通常为流量管理中的概念，如AB等）每个Service都有一个包含所有实例的默认版本。</p>
</li>
</ul>
<h3 id="virtualservices资源说明">VirtualServices资源说明</h3>
<p>VirtualServices中主要有这些配置用于配置流量的路由定义。 <a href="https://istio.io/latest/docs/reference/config/networking/virtual-service/" target="_blank"
   rel="noopener nofollow noreferrer" >reference virtual services</a></p>
<ul>
<li>
<p>hosts：string[] 目标主机，可以是带有统配符的DNS Name或IP</p>
</li>
<li>
<p>gateways：string[]，这些资源生效的网关和sidecar的名称。默认为名称空间级别，跨名称空间使用 <code>&lt;gateway namespace&gt;/&lt;gateway name&gt;</code></p>
<ul>
<li>
<p><code>mesh</code> 默认值，表示生效与网格内所有sidecar</p>
</li>
<li>
<p>仅应用于Gateway，该字段设置为Gateway的名称。</p>
</li>
<li>
<p>忽略此字段：将应用于网格内部所有的sidecar</p>
</li>
</ul>
</li>
<li>
<p><a href="https://istio.io/latest/docs/reference/config/networking/virtual-service/" target="_blank"
   rel="noopener nofollow noreferrer" >http</a>： HTTP协议流量的路由规则表。</p>
<ul>
<li><a href="https://istio.io/latest/docs/reference/config/networking/virtual-service/#HTTPMatchRequest" target="_blank"
   rel="noopener nofollow noreferrer" >match</a>：[] 匹配的条件。一个列表内单项内容的条件具有AND，整个列表的条件为OR。
<ul>
<li>name：</li>
<li>uri：匹配值区分大小写
<ul>
<li><code>exact:</code> 精确匹配。</li>
<li><code>prefix</code>：用于前缀匹配。</li>
<li><code>regex</code>：基于正则表达式匹配。</li>
</ul>
</li>
<li>method：HTTP方法，参数与uri相同。</li>
<li>&hellip;</li>
</ul>
</li>
<li><a href="https://istio.io/latest/docs/reference/config/networking/virtual-service/#HTTPRouteDestination" target="_blank"
   rel="noopener nofollow noreferrer" >route</a>：[] 设置的http流量的转发规则
<ul>
<li>destination：请求转发到的唯一标识符。
<ul>
<li>host：允许平台及ServiceEntry的服务名称，Kubernetes中为短名称<code>reviews.default.svc.cluster.local</code></li>
<li>subset，在DestinationRule中定义的子集</li>
<li>port：可选，公开服务的端口</li>
</ul>
</li>
<li>weight：转发流量的比例0-100 ，各目标的和应为100。</li>
<li>headers：操作头规则。</li>
</ul>
</li>
<li><a href="https://istio.io/latest/docs/reference/config/networking/virtual-service/#HTTPRedirect" target="_blank"
   rel="noopener nofollow noreferrer" >redirect</a>：重定向规则</li>
<li>delegate：只能在<code>Route</code>和<code>Redirect</code>为空时设置，委托的<code>VirtualServices</code> 名称</li>
<li>rewrite：重写HTTP URI。</li>
<li>timeout：HTTP请求超时，默认禁用。</li>
<li>retries：HTTP请求重试策略。</li>
<li>fault：故障注入</li>
<li>mirror：流量镜像</li>
<li>mirrorPercentage：对应mirror的比例</li>
<li>headers：操作http头的规则</li>
<li>&hellip;</li>
</ul>
</li>
<li>
<p>tcp：TCP流量的路由规则的有序列表</p>
</li>
<li>
<p>exportTo：允许 <code>VirtualServices</code> 其他名称空间的sidecar与gateway使用。</p>
</li>
</ul>
<h3 id="virtualservices配置实例">VirtualServices配置实例</h3>
<p>　　基于HTTP header的请求，将请求为<code>/ratings/v2/</code> 路径，并且请求头包含 <code>end-user</code>  值为<code>jason</code> 。</p>
<pre><code class="language-yaml">apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: ratings-route
spec:
  hosts:
  - ratings.prod.svc.cluster.local
  http:
  - match:
    - headers:
        end-user:
          exact: jason
      uri:
        prefix: &quot;/ratings/v2/&quot;
      ignoreUriCase: true # 是否区分大小写，仅exact和prefix生效。
    route:
    - destination:
        host: ratings.prod.svc.cluster.local
</code></pre>
<p>委托其他virtualServices处理</p>
<pre><code class="language-yaml">apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: bookinfo
spec:
  hosts:
  - &quot;bookinfo.com&quot;
  gateways:
  - mygateway
  http:
  - match:
    - uri:
        prefix: &quot;/productpage&quot;
    delegate:
       name: productpage
       namespace: nsA
  - match:
    - uri:
        prefix: &quot;/reviews&quot;
    delegate:
        name: reviews
        namespace: nsB
</code></pre>
<pre><code class="language-yaml">apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: productpage
  namespace: nsA
spec:
  http:
  - match:
     - uri:
        prefix: &quot;/productpage/v1/&quot;
    route:
    - destination:
        host: productpage-v1.nsA.svc.cluster.local
  - route:
    - destination:
        host: productpage.nsA.svc.cluster.local
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews
  namespace: nsB
spec:
  http:
  - route:
    - destination:
        host: reviews.nsB.svc.cluster.local
</code></pre>
<h2 id="目标规则destinationrule">目标规则：DestinationRule</h2>
<p>　　<a href="https://istio.io/latest/docs/reference/config/networking/destination-rule/" target="_blank"
   rel="noopener nofollow noreferrer" >DestinationRule</a>定义在完成路由配置后应用于服务流量的策略，即如何将流量调度至集群内，可以理解为DestinationRule定义的是envoy中的cluster。应用的内容也是envoy中cluster段的配置，如负载均衡配置，sidecar连接值及离群检测。</p>
<h3 id="destinationrule字段说明">DestinationRule字段说明</h3>
<ul>
<li>host: 注册表中的服务名称，kubernetes平台中使用短名称</li>
<li><a href="https://istio.io/latest/docs/reference/config/networking/destination-rule/#TrafficPolicy" target="_blank"
   rel="noopener nofollow noreferrer" >trafficPolicy</a>：应用的流量策略。
<ul>
<li>loadBalancer：使用的负载均衡算法，
<ul>
<li>simple
<ul>
<li>ROUND_ROBIN</li>
<li>LEAST_CONN</li>
<li>RANDOM</li>
<li>PASSTHROUGH</li>
</ul>
</li>
</ul>
</li>
<li>connectionPool：一致性hash</li>
<li><a href="https://istio.io/latest/docs/reference/config/networking/destination-rule/#OutlierDetection" target="_blank"
   rel="noopener nofollow noreferrer" >outlierDetection</a>：离群值检测
<ul>
<li>consecutiveGatewayErrors：满足502 503 504 错误数弹出。</li>
<li>consecutive5xxErrors： 满足5xx错误数弹出。</li>
<li>interval：探测时间间隔</li>
<li>baseEjectionTime：最小逐出时间。主机被驱逐的时间等于<code>baseEjectionTime</code> * 退出次数。</li>
<li>maxEjectionPercent：最大驱逐比例，默认10%。</li>
<li>minHealthPercent：最少健康比例，默认为0%</li>
</ul>
</li>
<li>tls</li>
<li>portLevelSettings</li>
</ul>
</li>
<li>subsets：[] 服务各个版本命名集。
<ul>
<li>name：子集的名称</li>
<li>labels：标签过滤器</li>
<li>trafficPolicy：子集流量策略，继承DestinationRule级别流量策略。</li>
</ul>
</li>
<li>exportTo：跨名称空间使用。</li>
</ul>
<h3 id="destinationrule配置实例">DestinationRule配置实例</h3>
<p>基于服务子集的配置</p>
<pre><code class="language-yaml">apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: bookinfo-ratings
spec:
  host: ratings.prod.svc.cluster.local
  trafficPolicy:
    loadBalancer:
      simple: LEAST_CONN
  subsets:
  - name: testversionv3
    labels:
      version: v3
  - name: testversionv2
    labels:
      version: v2
    trafficPolicy:
      loadBalancer:
        simple: ROUND_ROBIN
</code></pre>
<p>配置离群值</p>
<pre><code class="language-yaml">apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: reviews-cb-policy
spec:
  host: reviews.prod.svc.cluster.local
  trafficPolicy:
    connectionPool:
      tcp:
        maxConnections: 100
      http:
        http2MaxRequests: 1000
        maxRequestsPerConnection: 10
    outlierDetection:
      consecutiveErrors: 7
      interval: 5m
      baseEjectionTime: 15m
</code></pre>
<h2 id="集群网关入口gateway">集群网关入口：Gateway</h2>
<p>　　Istio还提供了一种配置模型 <a href="https://istio.io/latest/docs/reference/config/networking/gateway/" target="_blank"
   rel="noopener nofollow noreferrer" >Istio Gateway</a>。<code>Gateway</code> 与<code> KubernetesIngress</code> 相比，Gateway有高度的定制化与灵活性，并且允许将Istio功能应用于集群流量入口。</p>
<p>Gateway中运行的程序为envoy，它从控制平面接收相应的配置，并完成相关流量的传输；Gateway资源只负责网络入口点的相关功能，具体的路由实现则由VirtualService完成。</p>
<h3 id="gateway-配置说明">Gateway 配置说明</h3>
<p>　　Gateway定义了一个集群入口的负载均衡器，该负载均衡为运行在网格的边缘代理，负责将外部流量引入集群的内部。</p>
<p>　　Gateway资源生效于<code>Ingress</code> | <code>Egress</code> Envoy Pod的标签选择器，使用selector定义：<code>selector: app=istio-ingressgateway</code>。</p>
<pre><code class="language-yaml">apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: study-gateway
  namespace: default
spec:
  selector: # 基于名称空间中匹配pod的标签从而生效的应用
    app: istio-ingressgateway # 标签可以是一个或多个
  servers: # 描述对应的envoy的lintener的配置。
  - port:  # 设置envoy lintener
      number: 90 #  端口号 (Required)
      targetPort: # 可选 (Optional)
      name: envoy_end # 分配给端口的标签。
      protocol: HTTP # 端口服务协议，HTTP|HTTPS|GRPC|HTTP2|MONGO|TCP|TLS
    hosts: [ &quot;*&quot; , &quot;text.studyenvoy.com&quot; ] # 设置dnsName 可选的名称空间，*|. 
    tls: # 与TLS相关的选项集 (Optional)
    name: # 服务器的可选名称，必须唯一 (Optional)
</code></pre>
<h3 id="gateway配置实例">Gateway配置实例</h3>
<p>基于istio Bookinfo示例的<a href="https://istio.io/latest/docs/examples/bookinfo/" target="_blank"
   rel="noopener nofollow noreferrer" >Gateway</a>资源清单。</p>
<pre><code class="language-yaml">apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: bookinfo-gateway
spec:
  selector:
    istio: ingressgateway # use istio default controller
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - &quot;*&quot;
</code></pre>
<p>这里可以看到istio-ingress-gateway的pod的标签 <code>app=istio-ingressgateway</code></p>
<pre><code>$ kubectl get pods -n istio-system --show-labels
NAME                                    READY   STATUS    RESTARTS   AGE   LABELS
istio-ingressgateway-78b47bc88b-xqqpn   1/1     Running   0          22d   app=istio-ingressgateway, 
chart=gateways, 
heritage=Tiller, install.operator.istio.io/owning-resource=unknown,
istio.io/rev=default,istio=ingressgateway,
operator.istio.io/component=IngressGateways,
pod-template-hash=78b47bc88b,
release=istio,service.istio.io/canonical-name=istio-ingressgateway,
service.istio.io/canonical-revision=latest
</code></pre>
<h2 id="外部服务引入配置serviceentry">外部服务引入配置：ServiceEntry</h2>
<p>　　在Istio中提供了<a href="https://istio.io/latest/docs/reference/config/networking/service-entry/" target="_blank"
   rel="noopener nofollow noreferrer" >ServiceEntry</a>，可将网格外的服务加入网格中，像网格内的服务一样进行管理。</p>
<p>　　在实现上就是把外部服务加入 Istio 的服务发现，这些外部服务因为各种原因不能被直接注册到网格中。</p>
<h3 id="serviceentry字段说明">ServiceEntry字段说明</h3>
<ul>
<li>host：与ServiceEntry关联的主机</li>
<li>addresses：与服务关联的虚拟IP地址。</li>
<li>ports：
<ul>
<li>number：服务的端口。</li>
<li>protocol：服务公开的协议。HTTP|HTTPS|GRPC|HTTP2|MONGO|TCP| TLS之一。</li>
<li>targetPort：目标端口号。</li>
</ul>
</li>
<li>location：<code>MESH_EXTERNAL </code> | <code>MESH_INTERNAL</code>，决定是网格内部还是外部。</li>
<li>resolution：服务发现机制。
<ul>
<li>NONE：</li>
<li>STATIC：指定静态IP地址。</li>
<li>DNS：通过DNS发现。</li>
</ul>
</li>
<li>endpoints：服务关联的端点，<code>workloadSelector</code> 与 <code>endpoints</code> 二选一。</li>
<li>exportTo：共享其他名称空间</li>
<li>subjectAltNames：如指定，将验证服务器证书的使用者备用名称是否与指定值之一匹配。</li>
</ul>
<h2 id="使用istio-ingress-gateway-配置一个网格外部的应用">使用istio ingress gateway 配置一个网格外部的应用</h2>
<h3 id="部署应用程序">部署应用程序</h3>
<p>准备一个后端的应用</p>
<pre><code class="language-yaml">apiVersion: apps/v1
kind: Deployment
metadata:
  name: httpend-deply
  namespace: kube-system
  labels:
    app: httpend-deply
spec:
  replicas: 1
  selector:
    matchLabels:
      app: httpend-deply
  template:
    metadata:
      namespace: kube-system
      name: httpend-deply
      labels:
        app: httpend-deply
    spec:
      containers:
        - name: envoy-end
          image: cylonchau/envoy-end
          imagePullPolicy: IfNotPresent
          livenessProbe:
            initialDelaySeconds: 3 # 首次探测延迟时间
            periodSeconds: 2 # 定期重试
            failureThreshold: 1 # 失败重试次数
            httpGet:
              port: 90
              path: ping
      restartPolicy: Always
---
apiVersion: v1
kind: Service
metadata:
  name: envoy-end
  labels:
    app: envoy-end
  namespace: kube-system
spec:
  type: NodePort # nodeport是为了验证服务是否正常
  ports:
    - port: 90
      name: envoy-end
      targetPort: 90
      nodePort: 30102
  selector:
    app: httpend-deply
</code></pre>
<p>应用Gateway和VirtualServices</p>
<pre><code class="language-yaml">apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: envoyend-gateway
  namespace: kube-system
spec:
  selector:
    istio: ingressgateway
  servers:
    - port:
        number: 1090
        name: http
        protocol: HTTP
      hosts:
        - &quot;*&quot;
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: envoy-end
  namespace: kube-system
spec:
  hosts:
    - &quot;*&quot;
  gateways:
    - envoyend-gateway
  http:
    - match:
        - uri:
            prefix: /
      route:
        - destination:
            host: envoy-end
            port:
              number: 1090
</code></pre>
<p>应用DestinationRule</p>
<pre><code class="language-yaml">apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: envoy-end
  namespace: kube-system
spec:
  host: envoy-end
  trafficPolicy:
    loadBalancer:
      simple: ROUND_ROBIN

</code></pre>
<p>应用ServiceEntry</p>
<pre><code class="language-yaml">apiVersion: networking.istio.io/v1alpha3
kind: ServiceEntry
metadata:
  name: envoy-end
  namespace: kube-system
spec:
  hosts:
  - &quot;envoy-end&quot;
  ports:
  - number: 90
    name: http
    protocol: HTTP
  location: MESH_EXTERNAL
  resolution: DNS
</code></pre>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed//img/1380340-20210103203519697-2052388184.png" alt="" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
]]></content:encoded>
    </item>
    
    <item>
      <title>istio安装</title>
      <link>https://www.oomkill.com/2020/08/istio-install/</link>
      <pubDate>Thu, 20 Aug 2020 00:00:00 +0000</pubDate>
      
      <guid>https://www.oomkill.com/2020/08/istio-install/</guid>
      <description></description>
      <content:encoded><![CDATA[<p>Istio用于提供统一方式来集成微服务的开放平台，管理<a href="https://istio.io/latest/docs/examples/microservices-istio/" target="_blank"
   rel="noopener nofollow noreferrer" >微服务之间的</a><a href="https://istio.io/latest/docs/concepts/traffic-management/" target="_blank"
   rel="noopener nofollow noreferrer" >流量</a>，执行策略和汇总遥测数据。Istio的控制平面在基础集群管理平台（例如Kubernetes）上提供了一个抽象层。</p>
<p>Istio组成：</p>
<p>在Istio1.8中，istio由以下组件组成：<a href="https://istio.io/latest/docs/ops/deployment/architecture/" target="_blank"
   rel="noopener nofollow noreferrer" >istio-component</a></p>
<p>istio服务网格分为数据平面和控制平面</p>
<ul>
<li>
<p>数据平面：数据平面是由一组代理组成</p>
<ul>
<li>envoy：Sidecar Proxy 每个微服务代理来处理入口/出口业务服务之间的集群中，并从外部服务的服务。代理形成一个*安全的微服务网格，*提供了丰富的功能集合</li>
</ul>
</li>
<li>
<p>控制平面：管理与配置代理的流量规则。</p>
<ul>
<li>istiod：istio的控制平面，提供了服务发现，配置和证书管理，包含如下组件：
<ul>
<li><strong>Pilot</strong> ：负责运行时配置，（服务发现，智能路由）</li>
<li><strong>Citadel</strong>：负责证书的颁发与轮替</li>
<li><strong>Galley</strong>：负责配置的管理（验证，提取，分发等功能）</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>istio卸载</p>
<p>bookinfo卸载</p>
<pre><code>kubectl delete -f samples/bookinfo/platform/kube/bookinfo.yaml
</code></pre>
<p>istio卸载</p>
<pre><code>istioctl manifest generate|kubectl delete -f -
</code></pre>
<p>addons</p>
<pre><code>kubectl delete -f samples/addons/prometheus.yaml
kubectl delete -f samples/addons/jaeger.yaml
kubectl delete -f samples/addons/kiali.yaml
kubectl delete -f samples/addons/grafana.yaml
</code></pre>
]]></content:encoded>
    </item>
    
    <item>
      <title>istio命令</title>
      <link>https://www.oomkill.com/2020/08/istio-cli/</link>
      <pubDate>Thu, 20 Aug 2020 00:00:00 +0000</pubDate>
      
      <guid>https://www.oomkill.com/2020/08/istio-cli/</guid>
      <description></description>
      <content:encoded><![CDATA[<p>显示配置文件中的差异 <code>istioctl profile diff default demo</code></p>
<p>显示对应配置的profile <code>istioctl profile dump demo</code></p>
<p>显示可用的配置 <code>istioctl profile list</code></p>
<p>安装指定配置的istio <code>istioctl install --set profile=demo</code></p>
<p>生成配置清单 <code>istioctl manifest generate</code></p>
<p>istioctl验证安装: <code>istioctl manifest generate --set profile=demo |istioctl verify-install -</code></p>
<p>istio的非侵入式流量治理</p>
<p>流量治理是一个非常宽泛的话题，例如：</p>
<p>◎ 动态修改服务间访问的负载均衡策略，比如根据某个请求特征做会话保持；</p>
<p>◎ 同一个服务有两个版本在线，将一部分流量切到某个版本上；</p>
<p>◎ 对服务进行保护，例如限制并发连接数、限制请求数、隔离故障服务实例等；</p>
<p>◎ 动态修改服务中的内容，或者模拟一个服务运行故障等。</p>
<p>在Istio中实现这些服务治理功能时无须修改任何应用的代码。较之微服务的SDK方式，Istio以一种更轻便、透明的方式向用户提供了这些功能。用户可以用自己喜欢的任意语言和框架进行开发，专注于自己的业务，完全不用嵌入任何治理逻辑。只要应用运行在Istio的基础设施上，就可以使用这些治理能力。
一句话总结 Istio 流量治理的目标：以基础设施的方式提供给用户非侵入的流量治理能力，用户只需
关注自己的业务逻辑开发，无须关注服务访问管理。</p>
<h2 id="istio服务架构">istio服务架构</h2>
<p>在istio1.8中，istio的分为 <code>envoy</code> （数据平面） 、<code>istiod</code> （控制平面） 、<code>addons</code>（管理插件） 及 <code>istioctl</code> （命令行工具，用于安装、配置、诊断分析等操作）组成。</p>
<h3 id="pilot">Pilot</h3>
<p>Pilot是Istio控制平面流量管理的核心组件，管理和配置部署在Istio服务网格中的所有Envoy代理实例。</p>
<p>pilot-discovery为envoy sidecar提供服务发现，用于路由及流量的管理。通过kubernetes CRD资源获取网格的配置信息将其转换为xDS接口的标准数据格式后，通过gRPC分发至相关的envoy sidecar</p>
<p>Pilot组件包含工作在控制平面中的 <code>pilot-discovery</code> 和工作与数据平面的<code>pilot-agent </code> 与Envoy(istio-proxy)</p>
<p>pilot-discovery主要完成如下功能：</p>
<ul>
<li>从service registry中获取服务信息</li>
<li>从apiserver中获取配置信息。</li>
<li>将服务信息与配置信息适配为xDS接口的标准数据格式，通过xDS api完成配置分发。</li>
</ul>
<p>pilot-agent 主要完成如下功能</p>
<ul>
<li>
<p>基于kubernetes apiserver为envoy初始化可用的boostrap配置文件并启动envoy。</p>
</li>
<li>
<p>管理监控envoy的云兄状态及配置重载。</p>
</li>
</ul>
<p>envoy</p>
<ul>
<li>每个sidecar中的envoy是由pilot-agent基于生产的bootstrap配置进行启动，并根据指定的pilot地址，通过xDS api动态获取配置。</li>
<li>sidecar形式的envoy通过流量拦截机制为应用程序实现入站和出站的代理功能。</li>
</ul>
<p>在istio中的管理策略都是基于Kubernetes CRD的实现，其中有关于流量管理的CRD资源包括 <code>VirtualService</code> <code>EnvoyFilter</code>  <code>Gateway</code> <code>ServiceEntry</code>  <code>Sidecar</code> <code>DestinationRule</code> <code>WorkloadEntry</code> <code>WorkloadGroup</code>。<a href="https://istio.io/latest/docs/reference/config/networking/" target="_blank"
   rel="noopener nofollow noreferrer" >reference istio-networking-crd-resouces</a></p>
<ul>
<li>
<p>VirtualServices：用于定义路由，可以理解为envoy的 <code>listener</code> =&gt; <code>filter</code> =&gt; <code>route_config</code></p>
</li>
<li>
<p>DestinationRule：用于定义集群，可以理解为envoy 的 cluster</p>
</li>
<li>
<p>Gateway：用于定义作用于<code>istio-ingress-gateway</code></p>
</li>
<li>
<p>ServiceEntry：用于定义出站的路由，作用于<code>istio-egress-gateway</code></p>
</li>
<li>
<p>EnvoyFilter：为envoy添加过滤器或过滤器链。</p>
</li>
<li>
<p>Sidecar：用于定义运行在sidecar之上的envoy配置。</p>
</li>
</ul>
<p>Virtual Services和 Destination Rules是Istio流量路由功能的核心组件</p>
<p>Istio基于ServiceEntry资源对象将外部服务注册到网格内，从而像将外部服务以类
同内部服务一样的方式进行访问治理；
 对于外部服务，网格内Sidecar方式运行的Envoy即能执行治理；
 若需要将外出流量收束于特定几个节点时则需要使用专用的Egress Gateway完成，并基
于此Egress Gateway执行相应的流量治理；</p>
<h2 id="网格流量管理">网格流量管理</h2>
<h3 id="配置istio-virtual-services">配置istio Virtual Services</h3>
<p><code>VirtualServices</code>是istio用于在其运行平台Kubernetes定义的配置，用来影响流量的路由规则；其本质就是为集群中envoy提供路由配置的。</p>
<h4 id="virtualservices名词解释">VirtualServices名词解释</h4>
<p>VirtualServices中一些流量路由定义的关键术语。</p>
<ul>
<li>
<p>Services：服务的唯一应用名称的单位，在Kubernetes之上 Services通常为Kubernetes Services资源。</p>
</li>
<li>
<p>Source：在上文中，下游发起请求的客户端服务。</p>
</li>
<li>
<p>Host：客户端请求服务时使用的地址</p>
</li>
<li>
<p>Service versions：service允许的不同版本的子集（通常为流量管理中的概念，如AB等）每个Service都有一个包含所有实例的默认版本。</p>
</li>
</ul>
<h4 id="virtualservices资源说明">VirtualServices资源说明</h4>
<p>VirtualServices中主要有这些配置用于配置流量的路由定义。 <a href="https://istio.io/latest/docs/reference/config/networking/virtual-service/" target="_blank"
   rel="noopener nofollow noreferrer" >reference virtual services</a></p>
<ul>
<li>
<p>hosts：string[] 目标主机，可以是带有统配符的DNS Name或IP</p>
</li>
<li>
<p>gateways：string[]，这些资源生效的网关和sidecar的名称。默认为名称空间级别，跨名称空间使用 <code>&lt;gateway namespace&gt;/&lt;gateway name&gt;</code></p>
<ul>
<li>
<p><code>mesh</code> 默认值，表示生效与网格内所有sidecar</p>
</li>
<li>
<p>仅应用于Gateway，该字段设置为Gateway的名称。</p>
</li>
<li>
<p>忽略此字段：将应用于网格内部所有的sidecar</p>
</li>
</ul>
</li>
<li>
<p><a href="https://istio.io/latest/docs/reference/config/networking/virtual-service/" target="_blank"
   rel="noopener nofollow noreferrer" >http</a>： HTTP协议流量的路由规则表。</p>
<ul>
<li><a href="https://istio.io/latest/docs/reference/config/networking/virtual-service/#HTTPMatchRequest" target="_blank"
   rel="noopener nofollow noreferrer" >match</a>：[] 匹配的条件。一个列表内单项内容的条件具有AND，整个列表的条件为OR。
<ul>
<li>name：</li>
<li>uri：匹配值区分大小写
<ul>
<li><code>exact:</code> 精确匹配。</li>
<li><code>prefix</code>：用于前缀匹配。</li>
<li><code>regex</code>：基于正则表达式匹配。</li>
</ul>
</li>
<li>method：HTTP方法，参数与uri相同。</li>
<li>&hellip;</li>
</ul>
</li>
<li><a href="https://istio.io/latest/docs/reference/config/networking/virtual-service/#HTTPRouteDestination" target="_blank"
   rel="noopener nofollow noreferrer" >route</a>：[] 设置的http流量的转发规则
<ul>
<li>destination：请求转发到的唯一标识符。
<ul>
<li>host：允许平台及ServiceEntry的服务名称，Kubernetes中为短名称<code>reviews.default.svc.cluster.local</code></li>
<li>subset，在DestinationRule中定义的子集</li>
<li>port：可选，公开服务的端口</li>
</ul>
</li>
<li>weight：转发流量的比例0-100 ，各目标的和应为100。</li>
<li>headers：操作头规则。</li>
</ul>
</li>
<li><a href="https://istio.io/latest/docs/reference/config/networking/virtual-service/#HTTPRedirect" target="_blank"
   rel="noopener nofollow noreferrer" >redirect</a>：重定向规则</li>
<li>delegate：只能在<code>Route</code>和<code>Redirect</code>为空时设置，委托的<code>VirtualServices</code> 名称</li>
<li>rewrite：重写HTTP URI。</li>
<li>timeout：HTTP请求超时，默认禁用。</li>
<li>retries：HTTP请求重试策略。</li>
<li>fault：故障注入</li>
<li>mirror：流量镜像</li>
<li>mirrorPercentage：对应mirror的比例</li>
<li>headers：操作http头的规则</li>
<li>&hellip;</li>
</ul>
</li>
<li>
<p>tcp：TCP流量的路由规则的有序列表</p>
</li>
<li>
<p>exportTo：允许 <code>VirtualServices</code> 其他名称空间的sidecar与gateway使用。</p>
</li>
</ul>
<h3 id="virtualservices配置实例">VirtualServices配置实例</h3>
<p>基于HTTP header的请求，将请求为<code>/ratings/v2/</code> 路径，并且请求头包含 <code>end-user</code>  值为<code>jason</code> 。</p>
<pre><code class="language-yaml">apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: ratings-route
spec:
  hosts:
  - ratings.prod.svc.cluster.local
  http:
  - match:
    - headers:
        end-user:
          exact: jason
      uri:
        prefix: &quot;/ratings/v2/&quot;
      ignoreUriCase: true # 是否区分大小写，仅exact和prefix生效。
    route:
    - destination:
        host: ratings.prod.svc.cluster.local
</code></pre>
<p>委托其他virtualServices处理</p>
<pre><code class="language-yaml">apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: bookinfo
spec:
  hosts:
  - &quot;bookinfo.com&quot;
  gateways:
  - mygateway
  http:
  - match:
    - uri:
        prefix: &quot;/productpage&quot;
    delegate:
       name: productpage
       namespace: nsA
  - match:
    - uri:
        prefix: &quot;/reviews&quot;
    delegate:
        name: reviews
        namespace: nsB
</code></pre>
<pre><code class="language-yaml">apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: productpage
  namespace: nsA
spec:
  http:
  - match:
     - uri:
        prefix: &quot;/productpage/v1/&quot;
    route:
    - destination:
        host: productpage-v1.nsA.svc.cluster.local
  - route:
    - destination:
        host: productpage.nsA.svc.cluster.local
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews
  namespace: nsB
spec:
  http:
  - route:
    - destination:
        host: reviews.nsB.svc.cluster.local
</code></pre>
<h3 id="istio目标规则配置destinationrule">Istio目标规则配置：DestinationRule</h3>
<p><a href="https://istio.io/latest/docs/reference/config/networking/destination-rule/" target="_blank"
   rel="noopener nofollow noreferrer" >DestinationRule</a>定义在完成路由配置后应用于服务流量的策略，即如何将流量调度至集群内，可以理解为DestinationRule定义的是envoy中的cluster。应用的内容也是envoy中cluster段的配置，如负载均衡配置，sidecar连接值及离群检测。</p>
<h4 id="destinationrule字段说明">DestinationRule字段说明</h4>
<ul>
<li>host: 注册表中的服务名称，kubernetes平台中使用短名称</li>
<li><a href="https://istio.io/latest/docs/reference/config/networking/destination-rule/#TrafficPolicy" target="_blank"
   rel="noopener nofollow noreferrer" >trafficPolicy</a>：应用的流量策略。
<ul>
<li>loadBalancer：使用的负载均衡算法，
<ul>
<li>simple
<ul>
<li>ROUND_ROBIN</li>
<li>LEAST_CONN</li>
<li>RANDOM</li>
<li>PASSTHROUGH</li>
</ul>
</li>
</ul>
</li>
<li>connectionPool：一致性hash</li>
<li><a href="https://istio.io/latest/docs/reference/config/networking/destination-rule/#OutlierDetection" target="_blank"
   rel="noopener nofollow noreferrer" >outlierDetection</a>：离群值检测
<ul>
<li>consecutiveGatewayErrors：满足502 503 504 错误数弹出。</li>
<li>consecutive5xxErrors： 满足5xx错误数弹出。</li>
<li>interval：探测时间间隔</li>
<li>baseEjectionTime：最小逐出时间。主机被驱逐的时间等于<code>baseEjectionTime</code> * 退出次数。</li>
<li>maxEjectionPercent：最大驱逐比例，默认10%。</li>
<li>minHealthPercent：最少健康比例，默认为0%</li>
</ul>
</li>
<li>tls</li>
<li>portLevelSettings</li>
</ul>
</li>
<li>subsets：[] 服务各个版本命名集。
<ul>
<li>name：子集的名称</li>
<li>labels：标签过滤器</li>
<li>trafficPolicy：子集流量策略，继承DestinationRule级别流量策略。</li>
</ul>
</li>
<li>exportTo：跨名称空间使用。</li>
</ul>
<h3 id="destinationrule配置实例">DestinationRule配置实例</h3>
<p>基于服务子集的配置</p>
<pre><code class="language-yaml">apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: bookinfo-ratings
spec:
  host: ratings.prod.svc.cluster.local
  trafficPolicy:
    loadBalancer:
      simple: LEAST_CONN
  subsets:
  - name: testversionv3
    labels:
      version: v3
  - name: testversionv2
    labels:
      version: v2
    trafficPolicy:
      loadBalancer:
        simple: ROUND_ROBIN
</code></pre>
<p>配置离群值</p>
<pre><code class="language-yaml">apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: reviews-cb-policy
spec:
  host: reviews.prod.svc.cluster.local
  trafficPolicy:
    connectionPool:
      tcp:
        maxConnections: 100
      http:
        http2MaxRequests: 1000
        maxRequestsPerConnection: 10
    outlierDetection:
      consecutiveErrors: 7
      interval: 5m
      baseEjectionTime: 15m
</code></pre>
<h3 id="使用istio-gateway配置服务入口">使用istio gateway配置服务入口</h3>
<p>Istio还提供了一种配置模型 <a href="https://istio.io/latest/docs/reference/config/networking/gateway/" target="_blank"
   rel="noopener nofollow noreferrer" >Istio Gateway</a>。<code>Gateway</code> 与<code> KubernetesIngress</code> 相比，Gateway有高度的定制化与灵活性，并且允许将Istio功能应用于集群流量入口。</p>
<p>Gateway中运行的程序为envoy，它从控制平面接收相应的配置，并完成相关流量的传输；Gateway资源只负责网络入口点的相关功能，具体的路由实现则由VirtualService完成。</p>
<h3 id="gateway-crd资源说明">Gateway CRD资源说明</h3>
<p>Gateway定义了一个集群入口的负载均衡器，该负载均衡为运行在网格的边缘代理，负责将外部流量引入集群的内部。</p>
<p>Gateway资源生效于<code>Ingress</code> | <code>Egress</code> Envoy Pod的标签选择器，使用selector定义：<code>selector: app=istio-ingressgateway</code>。</p>
<pre><code class="language-yaml">apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: study-gateway
  namespace: default
spec:
  selector: # 基于名称空间中匹配pod的标签从而生效的应用
    app: istio-ingressgateway # 标签可以是一个或多个
  servers: # 描述对应的envoy的lintener的配置。
  - port:  # 设置envoy lintener
      number: 90 #  端口号 (Required)
      targetPort: # 可选 (Optional)
      name: envoy_end # 分配给端口的标签。
      protocol: HTTP # 端口服务协议，HTTP|HTTPS|GRPC|HTTP2|MONGO|TCP|TLS
    hosts: [ &quot;*&quot; , &quot;text.studyenvoy.com&quot; ] # 设置dnsName 可选的名称空间，*|. 
    tls: # 与TLS相关的选项集 (Optional)
    name: # 服务器的可选名称，必须唯一 (Optional)
</code></pre>
<h3 id="gateway配置实例">Gateway配置实例</h3>
<p>基于istio Bookinfo示例的<a href="https://istio.io/latest/docs/examples/bookinfo/" target="_blank"
   rel="noopener nofollow noreferrer" >Gateway</a>资源清单。</p>
<pre><code class="language-yaml">apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: bookinfo-gateway
spec:
  selector:
    istio: ingressgateway # use istio default controller
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - &quot;*&quot;
</code></pre>
<p>这里可以看到istio-ingress-gateway的pod的标签 <code>app=istio-ingressgateway</code></p>
<pre><code>$ kubectl get pods -n istio-system --show-labels
NAME                                    READY   STATUS    RESTARTS   AGE   LABELS
istio-ingressgateway-78b47bc88b-xqqpn   1/1     Running   0          22d   app=istio-ingressgateway, 
chart=gateways, 
heritage=Tiller, install.operator.istio.io/owning-resource=unknown,
istio.io/rev=default,istio=ingressgateway,
operator.istio.io/component=IngressGateways,
pod-template-hash=78b47bc88b,
release=istio,service.istio.io/canonical-name=istio-ingressgateway,
service.istio.io/canonical-revision=latest
</code></pre>
<h2 id="istio外部服务配置serviceentry">Istio外部服务配置：ServiceEntry</h2>
<p>在Istio中提供了<a href="https://istio.io/latest/docs/reference/config/networking/service-entry/" target="_blank"
   rel="noopener nofollow noreferrer" >ServiceEntry</a>，可将网格外的服务加入网格中，像网格内的服务一样进行管理。</p>
<p>在实现上就是把外部服务加入 Istio 的服务发现，这些外部服务因为各种原因不能被直接注册到网格中。</p>
<h3 id="serviceentry字段说明">ServiceEntry字段说明</h3>
<ul>
<li>host：与ServiceEntry关联的主机</li>
<li>addresses：与服务关联的虚拟IP地址。</li>
<li>ports：
<ul>
<li>number：服务的端口。</li>
<li>protocol：服务公开的协议。HTTP|HTTPS|GRPC|HTTP2|MONGO|TCP| TLS之一。</li>
<li>targetPort：目标端口号。</li>
</ul>
</li>
<li>location：<code>MESH_EXTERNAL </code> | <code>MESH_INTERNAL</code>，决定是网格内部还是外部。</li>
<li>resolution：服务发现机制。
<ul>
<li>NONE：</li>
<li>STATIC：指定静态IP地址。</li>
<li>DNS：通过DNS发现。</li>
</ul>
</li>
<li>endpoints：服务关联的端点，<code>workloadSelector</code> 与 <code>endpoints</code> 二选一。</li>
<li>exportTo：共享其他名称空间</li>
<li>subjectAltNames：如指定，将验证服务器证书的使用者备用名称是否与指定值之一匹配。</li>
</ul>
<h2 id="使用istio-ingress-gateway-配置一个网格外部的应用">使用istio ingress gateway 配置一个网格外部的应用</h2>
<h3 id="部署应用程序">部署应用程序</h3>
<p>准备一个后端的应用</p>
<pre><code class="language-yaml">apiVersion: apps/v1
kind: Deployment
metadata:
  name: httpend-deply
  namespace: kube-system
  labels:
    app: httpend-deply
spec:
  replicas: 1
  selector:
    matchLabels:
      app: httpend-deply
  template:
    metadata:
      namespace: kube-system
      name: httpend-deply
      labels:
        app: httpend-deply
    spec:
      containers:
        - name: envoy-end
          image: sealloong/envoy-end
          imagePullPolicy: IfNotPresent
          livenessProbe:
            initialDelaySeconds: 3 # 首次探测延迟时间
            periodSeconds: 2 # 定期重试
            failureThreshold: 1 # 失败重试次数
            httpGet:
              port: 90
              path: ping
      restartPolicy: Always
---
apiVersion: v1
kind: Service
metadata:
  name: envoy-end
  labels:
    app: envoy-end
  namespace: kube-system
spec:
  type: NodePort # nodeport是为了验证服务是否正常
  ports:
    - port: 90
      name: envoy-end
      targetPort: 90
      nodePort: 30102
  selector:
    app: httpend-deply
</code></pre>
<p>应用Gateway和VirtualServices</p>
<pre><code class="language-yaml">apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: envoyend-gateway
  namespace: kube-system
spec:
  selector:
    istio: ingressgateway
  servers:
    - port:
        number: 90
        name: http
        protocol: HTTP
      hosts:
        - &quot;*&quot;
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: envoy-end
  namespace: kube-system
spec:
  hosts:
    - &quot;*&quot;
  gateways:
    - envoyend-gateway
  http:
    - match:
        - uri:
            exact: /
      route:
        - destination:
            host: envoy-end
            port:
              number: 90
</code></pre>
<p>应用DestinationRule</p>
<pre><code class="language-yaml">apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: envoyend
  namespace: kube-system
spec:
  host: envoy-end
  subsets:
    - name: end
      labels:
        app: httpend-deply
</code></pre>
]]></content:encoded>
    </item>
    
  </channel>
</rss>
