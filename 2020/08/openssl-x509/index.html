<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>常用加密算法之数字证书与TLS/SSL | Cylon&#39;s Collection</title>
<meta name="keywords" content="encryption, openssl">
<meta name="description" content="常用加密算法之数字证书与TLS/SSL - Cylon&#39;s Collection">
<meta name="author" content="cylon">
<link rel="canonical" href="https://www.oomkill.com/2020/08/openssl-x509/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.df0e7f0648f287aca44f5b657ff5602f436346895340daaa6589b3049a979f73.css" integrity="sha256-3w5/Bkjyh6ykT1tlf/VgL0NjRolTQNqqZYmzBJqXn3M=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://www.oomkill.com/favicon.ico">
<link rel="apple-touch-icon" href="https://www.oomkill.com/apple-touch-icon.png">

<meta name="twitter:title" content="常用加密算法之数字证书与TLS/SSL | Cylon&#39;s Collection" />
<meta name="twitter:description" content="" />
<meta property="og:title" content="常用加密算法之数字证书与TLS/SSL | Cylon&#39;s Collection" />
<meta property="og:description" content="" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.oomkill.com/2020/08/openssl-x509/" />
<meta property="article:section" content="posts" />
  <meta property="article:published_time" content="2020-08-02T00:00:00&#43;00:00" />
  <meta property="article:modified_time" content="2023-03-22T23:00:36&#43;08:00" />


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Posts",
      "item": "https://www.oomkill.com/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "常用加密算法之数字证书与TLS/SSL",
      "item": "https://www.oomkill.com/2020/08/openssl-x509/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "常用加密算法之数字证书与TLS/SSL | Cylon's Collection",
  "name": "常用加密算法之数字证书与TLS\/SSL",
  "description": "",
  "keywords": [
    "encryption", "openssl"
  ],
  "wordCount" : "6887",
  "inLanguage": "zh",
  "datePublished": "2020-08-02T00:00:00Z",
  "dateModified": "2023-03-22T23:00:36+08:00",
  "author":{
    "@type": "Person",
    "name": "cylon"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://www.oomkill.com/2020/08/openssl-x509/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Cylon's Collection",
    "logo": {
      "@type": "ImageObject",
      "url": "https://www.oomkill.com/favicon.ico"
    }
  }
}
</script><script type="text/javascript"
        async
        src="https://cdn.bootcss.com/mathjax/2.7.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\[\[','\]\]']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
});

MathJax.Hub.Queue(function() {
    
    
    
    var all = MathJax.Hub.getAllJax(), i;
    for(i = 0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
});
</script>

<style>
code.has-jax {
    font: inherit;
    font-size: 100%;
    background: inherit;
    border: inherit;
    color: #515151;
}
</style>
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary-bg: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list-page {
                background: var(--theme);
            }

            .list-page:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list-page:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>

</head>

<body class=" type-posts kind-page layout-" id="top"><script data-no-instant>
function switchTheme(theme) {
  switch (theme) {
    case 'light':
      document.body.classList.remove('dark');
      break;
    case 'dark':
      document.body.classList.add('dark');
      break;
    
    default:
      if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
      }
  }
}

function isDarkTheme() {
  return document.body.className.includes("dark");
}

function getPrefTheme() {
  return localStorage.getItem("pref-theme");
}

function setPrefTheme(theme) {
  switchTheme(theme)
  localStorage.setItem("pref-theme", theme);
}

const toggleThemeCallbacks = {}
toggleThemeCallbacks['main'] = (isDark) => {
  
  if (isDark) {
    setPrefTheme('light');
  } else {
    setPrefTheme('dark');
  }
}




window.addEventListener('toggle-theme', function() {
  
  const isDark = isDarkTheme()
  for (const key in toggleThemeCallbacks) {
    toggleThemeCallbacks[key](isDark)
  }
});


function toggleThemeListener() {
  
  window.dispatchEvent(new CustomEvent('toggle-theme'));
}

</script>
<script>
  
  (function() {
    const defaultTheme = 'auto';
    const prefTheme = getPrefTheme();
    const theme = prefTheme ? prefTheme : defaultTheme;

    switchTheme(theme);
  })();
</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://www.oomkill.com" accesskey="h" title="Cylon&#39;s Collection (Alt + H)">Cylon&#39;s Collection</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="https://www.oomkill.com/archives/" title="归档"
                >归档
                </a>
            </li>
            <li>
                <a href="https://www.oomkill.com/tags/" title="标签"
                >标签
                </a>
            </li>
            <li>
                <a href="https://www.oomkill.com/search/" title="搜索 (Alt &#43; /)"data-no-instant accesskey=/
                >搜索
                </a>
            </li>
            <li>
                <a href="https://www.oomkill.com/about/" title="关于"
                >关于
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main post">

<article class="post-single">
  <header class="post-header"><h1 class="post-title">常用加密算法之数字证书与TLS/SSL</h1>
    <div class="post-meta"><span class="meta-item">
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar" style="user-select: text;"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" style="user-select: text;"></rect><line x1="16" y1="2" x2="16" y2="6" style="user-select: text;"></line><line x1="8" y1="2" x2="8" y2="6" style="user-select: text;"></line><line x1="3" y1="10" x2="21" y2="10" style="user-select: text;"></line></svg>
  <span>2020-08-02</span></span><span class="meta-item">
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar" style="user-select: text;"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" style="user-select: text;"></rect><line x1="16" y1="2" x2="16" y2="6" style="user-select: text;"></line><line x1="8" y1="2" x2="8" y2="6" style="user-select: text;"></line><line x1="3" y1="10" x2="21" y2="10" style="user-select: text;"></line></svg>
  <span>Edited on 2023-03-22</span></span><span class="meta-item">
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon" style="user-select: text;"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z" style="user-select: text;"></path><line x1="7" y1="7" x2="7" y2="7" style="user-select: text;"></line></svg>
  <span class="post-tags"><a href="https://www.oomkill.com/tags/encryption/">encryption</a></span></span><span class="meta-item">
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><circle cx="12" cy="12" r="9"></circle><polyline points="12 7 12 12 15 15"></polyline></svg>
  <span>14 分钟</span></span>

      
      
    </div>
  </header> <div class="toc side right">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">目录</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e6%95%b0%e5%ad%97%e8%af%81%e4%b9%a6" aria-label="数字证书">数字证书</a><ul>
                        
                <li>
                    <a href="#%e5%85%ac%e9%92%a5%e8%af%81%e4%b9%a6%e7%9a%84%e6%a0%bc%e5%bc%8f%e6%a0%87%e5%87%86" aria-label="公钥证书的格式标准">公钥证书的格式标准</a></li>
                <li>
                    <a href="#%e8%af%81%e4%b9%a6%e8%a7%84%e8%8c%83" aria-label="证书规范">证书规范</a></li>
                <li>
                    <a href="#%e6%95%b0%e5%ad%97%e8%af%81%e4%b9%a6%e6%96%87%e4%bb%b6%e6%a0%bc%e5%bc%8f" aria-label="数字证书文件格式">数字证书文件格式</a></li>
                <li>
                    <a href="#%e5%85%ac%e9%92%a5%e5%9f%ba%e7%a1%80%e8%ae%be%e6%96%bdpki" aria-label="公钥基础设施（PKI）">公钥基础设施（PKI）</a><ul>
                        
                <li>
                    <a href="#pki%e7%9a%84%e7%bb%84%e6%88%90%e8%a6%81%e7%b4%a0" aria-label="PKI的组成要素">PKI的组成要素</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#ssltls" aria-label="SSL/TLS">SSL/TLS</a></li>
                <li>
                    <a href="#openssl" aria-label="OpenSSL">OpenSSL</a><ul>
                        
                <li>
                    <a href="#openssl%e5%91%bd%e4%bb%a4" aria-label="OpenSSL命令">OpenSSL命令</a></li>
                <li>
                    <a href="#openssl-%e5%91%bd%e4%bb%a4%e4%bd%bf%e7%94%a8" aria-label="OpenSSL 命令使用">OpenSSL 命令使用</a><ul>
                        
                <li>
                    <a href="#%e5%af%b9%e7%a7%b0%e5%8a%a0%e5%af%86" aria-label="对称加密">对称加密</a></li>
                <li>
                    <a href="#%e5%8d%95%e9%a1%b9%e5%8a%a0%e5%af%86" aria-label="单项加密">单项加密</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#reference" aria-label="Reference">Reference</a><ul>
                        <ul>
                        
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8openssl%e7%94%9f%e6%88%90%e9%9a%8f%e6%9c%ba%e6%95%b0" aria-label="使用openssl生成随机数">使用openssl生成随机数</a></li>
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8openssl%e7%94%9f%e6%88%90%e8%87%aa%e7%ad%be%e6%95%b0%e5%ad%97%e8%af%81%e4%b9%a6" aria-label="使用OpenSSL生成自签数字证书">使用OpenSSL生成自签数字证书</a><ul>
                        
                <li>
                    <a href="#1-%e5%bb%ba%e7%ab%8brootca" aria-label="1. 建立RootCA"><strong>1. 建立RootCA</strong></a></li>
                <li>
                    <a href="#2-%e8%87%aa%e7%ad%be%e5%90%8d%e8%af%81%e4%b9%a6" aria-label="2 自签名证书">2 自签名证书</a></li>
                <li>
                    <a href="#%e7%94%a8%e6%88%b7%e6%88%96%e7%bb%84%e7%bb%87%e5%90%91ca%e7%94%b3%e8%af%b7%e5%85%ac%e9%92%a5%e8%af%81%e4%b9%a6" aria-label="用户或组织向CA申请公钥（证书）">用户或组织向CA申请公钥（证书）</a></li>
                <li>
                    <a href="#ca%e9%a2%81%e5%8f%91%e8%af%81%e4%b9%a6" aria-label="CA颁发证书">CA颁发证书</a></li>
                <li>
                    <a href="#%e8%af%81%e4%b9%a6%e5%8f%91%e9%80%81%e7%bb%99%e5%ae%a2%e6%88%b7%e7%ab%af" aria-label="证书发送给客户端">证书发送给客户端</a></li></ul>
                </li>
                <li>
                    <a href="#openssl%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6%e6%b3%a8%e9%87%8a" aria-label="OpenSSL配置文件注释">OpenSSL配置文件注释</a></li></ul>
                    
                <li>
                    <a href="#openssl%e6%89%a9%e5%b1%95%e5%af%86%e9%92%a5%e7%94%a8%e6%b3%95%e7%94%9f%e6%88%90%e5%a4%9a%e5%9f%9f%e5%90%8d%e8%af%81%e4%b9%a6" aria-label="OpenSSL扩展密钥用法：生成多域名证书">OpenSSL扩展密钥用法：生成多域名证书</a><ul>
                        
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8openssl%e7%94%9f%e6%88%90%e6%a0%b9ca" aria-label="使用OpenSSL生成根CA">使用OpenSSL生成根CA</a></li>
                <li>
                    <a href="#%e5%87%86%e5%a4%87openssl%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6" aria-label="准备openssl配置文件">准备openssl配置文件</a></li>
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8-openssl-%e7%ad%be%e7%bd%b2%e5%b8%a6%e6%9c%89-san-%e6%89%a9%e5%b1%95%e7%9a%84%e8%af%81%e4%b9%a6%e8%af%b7%e6%b1%82csr" aria-label="使用 openssl 签署带有 SAN 扩展的证书请求csr">使用 openssl 签署带有 SAN 扩展的证书请求csr</a>
                </li>
            </ul>
            </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content">
    





<div class="copyrightTopBlock">
    <p>本文发布于<a href="https://www.oomkill.com/about" target="_blank">Cylon的收藏册</a>，转载请著名原文链接~</p>
    <div class="articleSuffix-bg"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 147.78 155.96"> <path d="M10.5,99.81a1.9,1.9,0,0,0-.53-.09,1.66,1.66,0,0,0-1.64,1.65A1.64,1.64,0,0,0,10,103a1.57,1.57,0,0,0,.87-.25l26.76,26.82.45-1.08L11.52,101.91A1.65,1.65,0,0,0,10.5,99.81Zm-.13,2a.57.57,0,0,1-.8,0,.58.58,0,0,1-.17-.41.58.58,0,0,1,.57-.57h0a.57.57,0,0,1,.56.58A.55.55,0,0,1,10.37,101.77Z" style="fill:#c5c9e0"></path><path d="M56.15,117.58H39.06l0-.09a1.65,1.65,0,0,0-1.36-1H37.5a1.65,1.65,0,1,0,1.56,2.19H55.7L92.92,156h41.44v-1.08h-41Zm-18.25.94a.56.56,0,0,1-.79,0,.58.58,0,0,1-.17-.41.57.57,0,0,1,.56-.57h0a.58.58,0,0,1,.57.58A.54.54,0,0,1,37.9,118.52Z" style="fill:#c5c9e0"></path><path d="M23.52,50.32a1.65,1.65,0,0,0,1.55-1.11H55.28l48-48.13h31.06V0H102.85l-48,48.13H25.07a1.64,1.64,0,0,0-2.09-1,1.64,1.64,0,0,0,.54,3.2Zm0-2.21a.57.57,0,0,1,0,1.13.57.57,0,1,1,0-1.13Z" style="fill:#c5c9e0"></path><polygon points="102.86 0 102.86 0 102.86 0 102.86 0" style="fill:#c5c9e0"></polygon><path d="M107.72,12.14h26.64V11.07H107.27L57.4,61H3.09a1.66,1.66,0,0,0-1.45-.86H1.52A1.65,1.65,0,1,0,2.81,63a1.59,1.59,0,0,0,.45-.87H57.85ZM2.05,62.23a.57.57,0,0,1-.8,0,.58.58,0,0,1-.17-.41.57.57,0,0,1,.56-.57h.09a.57.57,0,0,1,.32,1Z" style="fill:#c5c9e0"></path><path d="M134.36,43.22V42.14h-22.3l-9.62,9.63a1.64,1.64,0,0,0-2.19.77,1.61,1.61,0,0,0-.17.71,1.65,1.65,0,1,0,3.29,0,1.61,1.61,0,0,0-.16-.72l9.3-9.32Zm-32.64,10.6a.57.57,0,0,1,0-1.13.57.57,0,0,1,0,1.13Z" style="fill:#c5c9e0"></path><path d="M147,52.3l-9,9H111.48a1.64,1.64,0,0,0-1.61-1.33h-.14a1.65,1.65,0,1,0,1.6,2.41h27.19l9.26-9.29L147,52.3Zm-37.15,9.85a.56.56,0,0,1-.56-.57h0a.56.56,0,0,1,.56-.56h0a.57.57,0,1,1,0,1.13Z" style="fill:#c5c9e0"></path><path d="M66.79,75.35l11,11.06h56.53V85.33H78.27l-11-11.06H49.49L37.12,86.67a1.64,1.64,0,0,0-2.09,1,1.61,1.61,0,0,0-.09.54,1.65,1.65,0,0,0,3.29,0,1.68,1.68,0,0,0-.26-.89l12-12ZM36.58,88.79a.57.57,0,1,1,.57-.56A.57.57,0,0,1,36.58,88.79Z" style="fill:#c5c9e0"></path><path d="M110.61,95.55,92.8,113.4a1.62,1.62,0,1,0,.77.76l17.49-17.53h23.31V95.55ZM92.49,115.28a.56.56,0,0,1-.8,0,.58.58,0,0,1-.17-.41.57.57,0,0,1,.57-.57h0a.58.58,0,0,1,.56.58A.55.55,0,0,1,92.49,115.28Z" style="fill:#c5c9e0"></path><path d="M97.89,122.3H76.62L64.2,109.85a1.65,1.65,0,0,0-.77-2.2,1.77,1.77,0,0,0-.72-.17h-.14a1.65,1.65,0,0,0,.15,3.29,1.58,1.58,0,0,0,.71-.17l12.74,12.77H98.34l17.48-17.52h18.54v-1.08h-19ZM63.12,109.53a.56.56,0,0,1-.8,0,.58.58,0,0,1-.17-.41.57.57,0,0,1,1.14,0A.54.54,0,0,1,63.12,109.53Z" style="fill:#c5c9e0"></path> </svg> </div>
</div><h2 id="数字证书">数字证书<a hidden class="anchor" aria-hidden="true" href="#数字证书">¶</a></h2>
<p>互联网上任意双方之间实现通信时，证书的目的有两种，</p>
<ul>
<li>主机证书，主要实现主机与主机之间进程间通信的。</li>
<li>个人证书，主要用作个人通信的，主要用作加密的数据的发送。</li>
</ul>
<p>主机类证书所拥有的标识主要为<code>主机名</code>，主机证书名称一定要与互联网之上访问名称一致，否则此证书为不可信证书。</p>
<p>对于一个安全的通信，应该有以下特征：</p>
<ul>
<li>完整性：消息在传输过程中未被篡改</li>
<li>身份验证：确认消息发送者的身份</li>
<li>不可否认：消息的发送者无法否认自己发送了信息</li>
</ul>
<p>显然，数字签名和消息认证码是不符合要求的，这里就需要数字证书来解决其弊端。</p>
<p>数字证书（digital certificate）又称公开密钥认证 PKC（英语：Public key certificate）。是在互联网通信中，方式数字签名的秘钥被篡改，是用来证明公开密钥拥有者的身份。此文件包含了公钥信息、拥有者身份信息（主体）、以及数字证书认证机构（发行者）对这份文件的数字签名，以保证这个文件的整体内容正确无误。</p>
<p>数字证书认证机构 CA (Certificate Authority)：是负责发放和管理数字证书的权威机构。</p>
<h3 id="公钥证书的格式标准">公钥证书的格式标准<a hidden class="anchor" aria-hidden="true" href="#公钥证书的格式标准">¶</a></h3>
<p><code>X.509</code>是密码学中公钥明证PKC的格式标准，所有的证书都符合ITU-T X.509国际标准。X.509证书的结构是用<code>ASN1</code> (Abstract Syntax Notation One)进行描述数据结构，并使用<code>ASN.1</code>语法进行编码。</p>
<h3 id="证书规范">证书规范<a hidden class="anchor" aria-hidden="true" href="#证书规范">¶</a></h3>
<p>X.509指的是ITU和ISO联合制定的（RFC5280）里定义的的 <code>X.509 v3</code></p>
<p>前使用最广泛的标准为X.509的 v3版本规范 (RFC5280）, 一般遵从<code>X.509</code>格式规范的证书，会有以下的内容：</p>
<p>证书组成结构</p>
<table>
<thead>
<tr>
<th><strong>结构</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>版本  </strong></td>
<td>现行通用版本是 V3，</td>
</tr>
<tr>
<td><strong>序号</strong></td>
<td>用来识别每一张证书，用来追踪和撤销证书。只要拥有签发者信息和序列号，就可以唯一标识一个证书，最大不能过20个字节；由CA来维护</td>
</tr>
<tr>
<td><strong>主体</strong></td>
<td>拥有此证书的法人或自然人身份或机器，包括：<br><strong>国家</strong>（C，Country） <br/><strong>州/省</strong>（S，State）** <br/><strong>地域/城市</strong>（L，Location） <br/><strong>组织/单位</strong>（O，Organization） <br/><strong>通用名称</strong>（CN，Common Name）：在TLS应用上，此字段一般是域名</td>
</tr>
<tr>
<td><strong>发行者</strong></td>
<td>以数字签名形式签署此证书的数字证书认证机构</td>
</tr>
<tr>
<td><strong>有效期(Validity) </strong></td>
<td>此证书的有效开始时间，在此前该证书并未生效；此证书的有效结束时间，在此后该证书作废。</td>
</tr>
<tr>
<td><strong>公开密钥用途</strong></td>
<td>指定证书上公钥的用途，例如数字签名、服务器验证、客户端验证等</td>
</tr>
<tr>
<td><strong>公开密钥</strong></td>
<td></td>
</tr>
<tr>
<td><strong>公开密钥指纹</strong></td>
<td></td>
</tr>
<tr>
<td><strong>数字签名</strong></td>
<td>使用信任的CA对内容进行</td>
</tr>
<tr>
<td>主体别名</td>
<td>例如一个网站可能会有多个域名（www.jd.com <a href="https://www.360buy.com">www.360buy.com</a>..）<br>一个组织可能会有多个网站（*.baidu.com tieba.baidu.com），<br/>不同的网域可以一并使用同一张证书，方便实现应用及管理。</td>
</tr>
</tbody>
</table>
<p>互联网上任意双方之间实现通信时，证书的目的有两种，</p>
<ul>
<li>主机证书，主要实现主机与主机之间进程间通信的。</li>
<li>个人证书，主要用作个人通信的，主要用作加密的数据的发送。</li>
</ul>
<p>主机类证书所拥有的标识主要为<code>主机名</code>，主机证书名称一定要与互联网之上访问名称一致，否则此证书为不可信证书。</p>
<h3 id="数字证书文件格式">数字证书文件格式<a hidden class="anchor" aria-hidden="true" href="#数字证书文件格式">¶</a></h3>
<p><code>X.509</code>一般推荐使用<code>PEM</code> (Privacy Enhanced Mail）格式来存储证书相关的文件。</p>
<p><code>.crt</code> &amp; <code>.cer</code>：证书文件后缀名
<code>.key</code>: 私钥后缀名
<code>.csr</code>：证书请求文件后缀名</p>
<h3 id="公钥基础设施pki">公钥基础设施（PKI）<a hidden class="anchor" aria-hidden="true" href="#公钥基础设施pki">¶</a></h3>
<p>公钥基础设施 PKI（Public-Key infrastructure）是为了能够更有效地运用公钥而制定的一系列规范和规格的总称。</p>
<h4 id="pki的组成要素">PKI的组成要素<a hidden class="anchor" aria-hidden="true" href="#pki的组成要素">¶</a></h4>
<ul>
<li>用户：使用PKI的人
<ul>
<li>注册公钥用户。</li>
<li>使用已注册公钥用户。</li>
</ul>
</li>
<li>认证机构：
<ul>
<li>签证机构：CA Certificate Authority</li>
<li>注册机构：RA</li>
</ul>
</li>
<li>仓库
<ul>
<li>证书吊销列表：CRL；</li>
<li>证书存取库，从签发机构中获得其签发的证书，需要有存取库来提供这些证书。</li>
</ul>
</li>
</ul>
<h2 id="ssltls">SSL/TLS<a hidden class="anchor" aria-hidden="true" href="#ssltls">¶</a></h2>
<p>传输层安全协议，TLS，（Transport Layer Security），其前身为<strong>安全套接层</strong> SSL（Secure Sockets Layer）。SSL3.0为SSL最高版本，3.1 即TLS 1.0</p>
<p>SSL/TLS是世界上应用最广泛的密码通信方法。比如说，当在网上商城中输人信用卡号时，我们的Web浏览器就会使用SSL/TLS进行密码通信。使用SSL/TLS可以对通信对象进行认证，还可以确保通信内容的机密性。</p>
<table>
<thead>
<tr>
<th>协议</th>
<th>时间</th>
<th>状态</th>
</tr>
</thead>
<tbody>
<tr>
<td>SSL 1.0</td>
<td>未公布</td>
<td>未公布</td>
</tr>
<tr>
<td>SSL 2.0</td>
<td>1995年</td>
<td>已于2011年弃用</td>
</tr>
<tr>
<td>SSL 3.0</td>
<td>1996年</td>
<td>已于2015年弃用</td>
</tr>
<tr>
<td>TLS 1.0</td>
<td>1999年</td>
<td></td>
</tr>
<tr>
<td>TLS 1.1</td>
<td>2006年</td>
<td></td>
</tr>
<tr>
<td>TLS 1.2</td>
<td>2008年</td>
<td></td>
</tr>
<tr>
<td>TLS 1.3</td>
<td>2018年</td>
<td></td>
</tr>
</tbody>
</table>
<p>http协议本身为文本格式，数据发送做文本编码；https协议实现的是二进制格式，数据发送做文本编码。由于ssl的存在，双方在实现通讯时，除了tcp协议三次 握手之外，双方还需做ssl握手会话的过程（认证密钥证书、数据交换等）。ssl会话的建立只能基于IP地址，无法基于主机名识别每一个通信方。一个IP地址在某个应用协议上只能建立一个ssl会话。</p>
<p>TLS采用了分层设计，虽然在TCP/IP协议栈上，SSL增加的半层，其内部实现为多层</p>
<ul>
<li>最底层，基础算法原语的实现，aes，rsa，md5</li>
<li>向上一层，选定参数后，符合密码学标准分类的算法的实现
<ul>
<li>aes-128-abc-pkcs7 abc内部块的串联方式 pkcs7 对称加密公钥格式。</li>
</ul>
</li>
<li>再向上一层：组合算法实现的半成品。</li>
<li>用各种组件拼装而成的种种成品密码学协议/软件  tls ssh。 openssh是利用openssl工具实现的软件程序。</li>
</ul>
<h2 id="openssl">OpenSSL<a hidden class="anchor" aria-hidden="true" href="#openssl">¶</a></h2>
<p>OpenSSL是一个开放源代码的软件库，并实现了SSL与TLS协议。OpenSSL可以运行在，MS Windows、Linux、MacOS。OpenSSL已经成为linux基础公共组件，主要由三个开源组件组成：</p>
<ul>
<li><code>openssl</code>：多用途的命令行工具，能实现对称加密、非对称加密、单项加密等。各功能分别使用单独子命令来实现。</li>
<li><code>libcrypto</code>：公共加密库，实现了多种加密算法。</li>
<li><code>libssl</code>：实现了SSL及TLS的功能库</li>
</ul>
<h3 id="openssl命令">OpenSSL命令<a hidden class="anchor" aria-hidden="true" href="#openssl命令">¶</a></h3>
<p>OpenSSL命令分为 标准命令<code>Standard commands</code>、消息摘要命令<code>Message Digest commands</code>、密码命令<code>Cipher commands</code>三部分组成。</p>
<blockquote>
<ul>
<li>标准命令。完成某些功能时使用的，如生成随机数、扮演CA签发证书。
<ul>
<li>enc 对称加密</li>
<li>crl 证书吊销列表</li>
<li>ca 证书签发机构</li>
<li>dgst 消息摘要算法（单项散列函数）</li>
<li>dh 密钥交换算法</li>
<li>req 请求证书生成器</li>
</ul>
</li>
<li>消息摘要命令算法，常用散列函数。</li>
<li>加密命令，所支持的加密算法。</li>
</ul>
</blockquote>
<h3 id="openssl-命令使用">OpenSSL 命令使用<a hidden class="anchor" aria-hidden="true" href="#openssl-命令使用">¶</a></h3>
<h4 id="对称加密">对称加密<a hidden class="anchor" aria-hidden="true" href="#对称加密">¶</a></h4>
<p>加密</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">openssl enc -e -des3 -a -salt -in /etc/passwd -out ./passwd
</span></span></code></pre></td></tr></table>
</div>
</div><p>解密</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">openssl enc -d -des3 -a -salt -in passwd
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><code>-d</code> 解密</li>
<li><code>-e</code> 加密</li>
<li><code>-a</code> base64编码处理数据</li>
</ul>
<h4 id="单项加密">单项加密<a hidden class="anchor" aria-hidden="true" href="#单项加密">¶</a></h4>
<p>openssl中，单项加密即数字签名计算message的摘要信息，为 <code>openssl dgst...</code></p>
<p>单项散列函数通常应用于数字签名于消息认证码（MAC： Message Authentication Code 消息认证码，单项加密的一种延申应用，用于实现再网络通信中保证所传输的数据的完整性。）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ openssl dgst -md5 /var/log/messages
</span></span><span class="line"><span class="cl">MD5(/var/log/messages)= 4515fae68552c00646ee7e07aac25d1d
</span></span></code></pre></td></tr></table>
</div>
</div><p>也可以简写为</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ openssl md5 /var/log/messages
</span></span><span class="line"><span class="cl">MD5(/var/log/messages)= 24483320e6af7ed2cee401aa00c260e6
</span></span></code></pre></td></tr></table>
</div>
</div><p>openssl也可以生成用户密码 sslpasswd</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ openssl passwd -1 -salt 123456
</span></span><span class="line"><span class="cl">Password: 
</span></span><span class="line"><span class="cl">$1$123456$wWKtx7yY/RnLiPN.KaX.z.
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>$1$123456$wWKtx7yY/RnLiPN.KaX.z.</code>  这是扩展Unix风格的<code>crypt(3)</code> 密码哈希语法。格式为 <code>$id$salt$encrypted</code> 前<code>$id$</code>符表示加密算法 1标识md5 6标识<code>SHA-512</code>，123456是指定的salt,salt为id后的最多16位的对密码加盐。</p>
<h2 id="reference">Reference<a hidden class="anchor" aria-hidden="true" href="#reference">¶</a></h2>
<blockquote>
<p><a href="https://man7.org/linux/man-pages/man3/crypt.3.html">crypt</a>
<a href="https://unix.stackexchange.com/questions/510990/why-is-the-output-of-openssl-passwd-different-each-time">unix style encrypted</a></p>
</blockquote>
<h4 id="使用openssl生成随机数">使用openssl生成随机数<a hidden class="anchor" aria-hidden="true" href="#使用openssl生成随机数">¶</a></h4>
<p>hex基于16进制编码格式  每个字节4位，4指的是4个字节，一个字节是8位二进制数。4位二进制可以用一个16进制字节标识（一个十六进制对应四个二进制 $4<em>4=16$） 出现字符 num</em>2</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ openssl rand -hex <span class="m">16</span>
</span></span><span class="line"><span class="cl">8cd7c7a85e22b4548f6942468028fde4
</span></span><span class="line"><span class="cl">$ openssl rand -base64 <span class="m">6</span>
</span></span><span class="line"><span class="cl">c0jDwKIG
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="使用openssl生成自签数字证书">使用OpenSSL生成自签数字证书<a hidden class="anchor" aria-hidden="true" href="#使用openssl生成自签数字证书">¶</a></h4>
<p>获取证书两种方法：</p>
<ul>
<li>使用证书授权机构
<ul>
<li>生成签名请求（csr）</li>
<li>将csr发送给CA</li>
<li>从CA处接收签名</li>
</ul>
</li>
<li>自签名的证书：自已签发自己的公钥</li>
</ul>
<h5 id="1-建立rootca"><strong>1. 建立RootCA</strong><a hidden class="anchor" aria-hidden="true" href="#1-建立rootca">¶</a></h5>
<p><strong>生成私钥</strong></p>
<table>
<thead>
<tr>
<th style="text-align:center">参数</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">-new</td>
<td style="text-align:left">表示生成一个新证书签署请求</td>
</tr>
<tr>
<td style="text-align:center">-x509</td>
<td style="text-align:left">专用于CA生成自签证书，如果不是自签证书则不需要此项</td>
</tr>
<tr>
<td style="text-align:center">-key</td>
<td style="text-align:left">生成请求时用到的私钥文件</td>
</tr>
<tr>
<td style="text-align:center">-out</td>
<td style="text-align:left">证书的保存路径</td>
</tr>
<tr>
<td style="text-align:center">-days</td>
<td style="text-align:left">证书的有效期限，单位是day（天），默认是365天</td>
</tr>
</tbody>
</table>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">cd</span> /etc/pki/tls/
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">openssl genrsa -out private/cakey.pem <span class="m">2048</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 路径和名称必须为openssl配置文件中路径的名称</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="2-自签名证书">2 自签名证书<a hidden class="anchor" aria-hidden="true" href="#2-自签名证书">¶</a></h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">openssl req -new <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	-x509 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	-key private/cakey.pem <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	-out cacert.pem <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	-days <span class="m">3650</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	-subj <span class="s2">&#34;/C=HK/ST=HK/L=HK/O=chinamobile/OU=SY/CN=CHINA MOBILE&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>自签名证书是base64编码的，查看证书内容</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">openssl x509 -in cacert.pem -noout -text
</span></span></code></pre></td></tr></table>
</div>
</div><table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>x509</td>
<td>格式</td>
</tr>
<tr>
<td>-noout</td>
<td>输出时不生成新文件，只显示内容</td>
</tr>
<tr>
<td>-text</td>
<td>以文本格式输出</td>
</tr>
</tbody>
</table>
<p><strong>数字证书中主题(Subject)中字段的含义</strong></p>
<ul>
<li>一般的数字证书产品的主题通常含有如下字段：</li>
</ul>
<table>
<thead>
<tr>
<th>字段名</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>公用名称 <font color="#f8070d" size=3>CN</font> (Common Name)</td>
<td>对于 SSL 证书，<font color="#f8070d" size=2>一般为网站域名</font>；而对于代码签名证书则为申请单位名称；而对于客户端证书则为证书申请者的姓名；</td>
</tr>
<tr>
<td>单位名称 <font color="#f8070d" size=3>O</font>  (Organization Name)</td>
<td>对于 SSL 证书，一般为网站域名；而对于代码签名证书则为申请单位名称；而对于客户端单位证书则为证书申请者所在单位名称；</td>
</tr>
<tr>
<td>OU</td>
<td>可以理解为公司部门名称</td>
</tr>
<tr>
<td>所在城市 <font color="#f8070d" size=3>L</font> (Locality)</td>
<td></td>
</tr>
<tr>
<td>所在省份 <font color="#f8070d" size=3>ST</font>(State/Provice)</td>
<td></td>
</tr>
<tr>
<td>所在国家 <font color="#f8070d" size=3>C</font> (Country）</td>
<td></td>
</tr>
</tbody>
</table>
<p>可以看到生成了一个Chinamobile的自签的RootCA</p>
<p>
  <img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/1380340-20201105220215285-526813628.png" alt=""  /></p>
<h5 id="用户或组织向ca申请公钥证书">用户或组织向CA申请公钥（证书）<a hidden class="anchor" aria-hidden="true" href="#用户或组织向ca申请公钥证书">¶</a></h5>
<ol>
<li>生成私钥</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"> mkdir child
</span></span><span class="line"><span class="cl"> openssl genrsa -out child/child.pem <span class="m">2048</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>生成证书申请文件 <code>child.csr</code></li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">openssl req -new <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>-key child/child.pem <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>-out child/child.csr <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>-subj <span class="s2">&#34;/C=HK/ST=HK/L=HK/O=chinamobile/OU=SY/CN=*.10086.com&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>将证书申请文件发送给CA</li>
</ol>
<p>可以通过任意方式发送申请文件给CA</p>
<h5 id="ca颁发证书">CA颁发证书<a hidden class="anchor" aria-hidden="true" href="#ca颁发证书">¶</a></h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">touch /etc/pki/CA/index.txt
</span></span><span class="line"><span class="cl">touch /etc/pki/CA/serial # 下一个要颁发的编号 16进制
</span></span><span class="line"><span class="cl">touch /etc/pki/CA/crlnumber
</span></span><span class="line"><span class="cl">echo 01 &gt; /etc/pki/CA/serial
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">openssl ca -in child/child.csr \ # 签发请求
</span></span><span class="line"><span class="cl">	-cert cacert.pem \ # CA证书
</span></span><span class="line"><span class="cl">	-keyfile private/cakey.pem \  # CA私钥
</span></span><span class="line"><span class="cl">	-out child/a.crt -days 30
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="证书发送给客户端">证书发送给客户端<a hidden class="anchor" aria-hidden="true" href="#证书发送给客户端">¶</a></h5>
<p>在应用软件中使用证书</p>
<p>
  <img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/1380340-20201105221806859-170479134.png" alt=""  /></p>
<p>
  <img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/1380340-20201105221815048-923869731.png" alt=""  /></p>
<h4 id="openssl配置文件注释">OpenSSL配置文件注释<a hidden class="anchor" aria-hidden="true" href="#openssl配置文件注释">¶</a></h4>
<p><code>/etc/pki/tls/openssl.cnf </code> 定义了管理CA的相关信息。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># 语法
</span></span><span class="line"><span class="cl"># 变量 = 值
</span></span><span class="line"><span class="cl"># 1. 字符串值最好使用双引号界定，并且其中可以使用&#34;\n&#34;,&#34;\r&#34;,&#34;\t&#34;,&#34;\\&#34;这些转义序列。
</span></span><span class="line"><span class="cl"># 2. 可以使用 ${变量名} 的形式引用同一字段中的变量，使用 ${字段名::变量名} 的形式引用其它字段中的变量。
</span></span><span class="line"><span class="cl"># 3. 可以使用 ${ENV::环境变量} 的形式引用操作系统中定义的环境变量，若变量不存在则会导致错误。
</span></span><span class="line"><span class="cl"># 4. 可以在默认字段定义与操作系统环境变量同名的变量作为默认值来避免环境变量不存在导致的错误。
</span></span><span class="line"><span class="cl"># 5. 如果在同一字段内有多个相同名称的变量，那么后面的值将覆盖前面的值。
</span></span><span class="line"><span class="cl"># 6. 可以通过 &#34;.include = 绝对路径&#34; 语法或 OPENSSL_CONF_INCLUDE 环境变量引入其他配置文件(*.cnf)。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 定义 HOME 的默认值，防止操作系统中不存在 HOME 环境变量。
</span></span><span class="line"><span class="cl">HOME			= .
</span></span><span class="line"><span class="cl"># 默认的随机数种子文件，对应 -rand 命令行选项。
</span></span><span class="line"><span class="cl">RANDFILE		= $ENV::HOME/.rnd
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 扩展对象定义
</span></span><span class="line"><span class="cl"># 如果没有在 OpenSSL 命令行中定义X.509证书的扩展项，那么就会从下面对扩展对象的定义中获取。
</span></span><span class="line"><span class="cl"># 定义方法有两种，第一种(反对使用)是存储在外部文件中，也就是这里&#34;oid_file&#34;变量定义的文件。
</span></span><span class="line"><span class="cl">#oid_file		= $ENV::HOME/.oid
</span></span><span class="line"><span class="cl"># 第二种是存储在配置文件的一个字段中，也就是这里&#34;oid_section&#34;变量值所指定的字段。
</span></span><span class="line"><span class="cl">oid_section		= new_oids
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 要将此配置文件用于 &#34;openssl x509&#34; 命令的 &#34;-extfile&#34; 选项，
</span></span><span class="line"><span class="cl"># 请在此指定包含 X.509v3 扩展的小节名称
</span></span><span class="line"><span class="cl">#extensions =
</span></span><span class="line"><span class="cl"># 或者使用一个默认字段中仅包含 X.509v3 扩展的配置文件
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[ new_oids ]
</span></span><span class="line"><span class="cl"># 添加可以被 &#39;ca&#39;, &#39;req&#39;, &#39;ts&#39; 命令使用的扩展对象。格式如下：
</span></span><span class="line"><span class="cl"># 对象简称 = 对象数字ID
</span></span><span class="line"><span class="cl"># 下面是一些增强型密钥用法(extendedKeyUsage)的例子
</span></span><span class="line"><span class="cl"># We can add new OIDs in here for use by &#39;ca&#39;, &#39;req&#39; and &#39;ts&#39;.
</span></span><span class="line"><span class="cl"># Add a simple OID like this:
</span></span><span class="line"><span class="cl"># testoid1=1.2.3.4
</span></span><span class="line"><span class="cl"># Or use config file substitution like this:
</span></span><span class="line"><span class="cl"># testoid2=${testoid1}.5.6
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># Policies used by the TSA examples.
</span></span><span class="line"><span class="cl">tsa_policy1 = 1.2.3.4.1
</span></span><span class="line"><span class="cl">tsa_policy2 = 1.2.3.4.5.6
</span></span><span class="line"><span class="cl">tsa_policy3 = 1.2.3.4.5.7
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">########################################################################################
</span></span><span class="line"><span class="cl">###################################  证书签发配置  ######################################
</span></span><span class="line"><span class="cl">########################################################################################
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># openssl 的 ca 命令实现了证书签发的功能，其相关选项的默认值就来自于这里的设置。
</span></span><span class="line"><span class="cl"># 这个字段只是通过唯一的 default_ca 变量来指定默认CA主配置字段的入口(-name 命令行选项的默认值)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">########################################################################################
</span></span><span class="line"><span class="cl">######################## 默认CA主配置字段，(★)标记表示必需项 #############################
</span></span><span class="line"><span class="cl">########################################################################################
</span></span><span class="line"><span class="cl">[ ca ]  #
</span></span><span class="line"><span class="cl">default_ca	= CA_default		# The default ca section # 默认CA
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">########################################################################################
</span></span><span class="line"><span class="cl">######################### 默认CA主配置字段，(★)标记表示必需项 ############################
</span></span><span class="line"><span class="cl">########################################################################################
</span></span><span class="line"><span class="cl">[ CA_default ] 
</span></span><span class="line"><span class="cl"># 保存所有信息的文件夹，这个变量只是为了给后面的变量使用
</span></span><span class="line"><span class="cl">dir			= /etc/pki/CA
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># (★)存放新签发证书的默认目录，证书名就是该证书的系列号，后缀是.pem 。对应 -outdir 命令行选项。
</span></span><span class="line"><span class="cl">certs		= $dir/certs
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 存放证书吊销列表的
</span></span><span class="line"><span class="cl">crl_dir		= $dir/crl
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 数据库，颁发了那些证书，以及证书状态、编号。 数据索引。默认不存在的
</span></span><span class="line"><span class="cl">database	= $dir/index.txt
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#unique_subject	= no
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#(★)存放新签发证书的默认目录，证书名就是该证书的系列号，后缀是.pem 。对应 -outdir 命令行选项。
</span></span><span class="line"><span class="cl">new_certs_dir	= $dir/newcerts		# default place for new certs. # 新证书目录
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#(★)存放CA自身证书的文件名。对应 -cert 命令行选项。
</span></span><span class="line"><span class="cl">certificate	= $dir/cacert.pem
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#(★)签发证书时使用的序列号文本文件，里面必须包含下一个可用的16进制数字。。需手工创建 
</span></span><span class="line"><span class="cl">serial		= $dir/serial
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 存放当前(下一个吊销证书编号)CRL编号的文件，需手工创建
</span></span><span class="line"><span class="cl">crlnumber	= $dir/crlnumber
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 证书吊销列表
</span></span><span class="line"><span class="cl">crl		= $dir/crl.pem 		
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#(★)存放CA自身私钥的文件名。对应 -keyfile 命令行选项。
</span></span><span class="line"><span class="cl">private_key	= $dir/private/cakey.pem
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 私钥文件路径
</span></span><span class="line"><span class="cl">RANDFILE	= $dir/private/.rand
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 定义X.509证书扩展项的字段。对应 -extensions 命令行选项。
</span></span><span class="line"><span class="cl">x509_extensions	= usr_cert
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 当用户需要确认签发证书时可读证书DN域的显示格式。可用值与 x509 指令的 -nameopt 选项相同。
</span></span><span class="line"><span class="cl">name_opt 	= ca_default		# Subject Name options
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 可用值与 x509 指令的 -certopt 选项相同，不过 no_signame 和 no_sigdump 总被默认设置。
</span></span><span class="line"><span class="cl">cert_opt 	= ca_default		# Certificate field options
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 是否将证书请求中的扩展项信息加入到证书扩展项中去。取值范围以及解释：
</span></span><span class="line"><span class="cl">## none: 忽略所有证书请求中的扩展项
</span></span><span class="line"><span class="cl">## copy: 将证书扩展项中没有的项目复制到证书中
</span></span><span class="line"><span class="cl">## copyall: 将所有证书请求中的扩展项都复制过去，并且覆盖证书扩展项中原来已经存在的值。
</span></span><span class="line"><span class="cl">## 此选项的主要用途是允许证书请求提供例如 subjectAltName 之类扩展的值。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># copy_extensions = copy
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 定义生成CRL时需要加入的扩展项字段。对应 -crlexts 命令行选项。
</span></span><span class="line"><span class="cl"># crl_extensions	= crl_ext
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 新签发的证书默认有效期，以天为单位。依次对应 -days , -startdate , -enddate 命令行选项。
</span></span><span class="line"><span class="cl">default_days	= 365	# 颁发证书默认有效期
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># crl的有效期 30天
</span></span><span class="line"><span class="cl">default_crl_days= 30
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 默认hash算法
</span></span><span class="line"><span class="cl">default_md	= sha256
</span></span><span class="line"><span class="cl">preserve	= no	    # keep passed DN ordering
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#(★)定义用于证书请求DN域匹配策略的字段，用于决定CA要求和处理证书请求提供的DN域的各个参数值的规则。
</span></span><span class="line"><span class="cl"># 策略匹配 ，客户端与ca之间区申请证书信息是否必须匹配，对应 -policy 命令行选项。
</span></span><span class="line"><span class="cl">policy		= policy_match 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">########################################################################################
</span></span><span class="line"><span class="cl">################################ 为签发的证书设置扩展项 ##################################
</span></span><span class="line"><span class="cl">########################################################################################
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 变量名称是DN域对象的名称，变量值可以是：
</span></span><span class="line"><span class="cl"># match: 该变量在证书请求中的值必须与CA证书相应的变量值完全相同，否则拒签。
</span></span><span class="line"><span class="cl"># supplied: 该变量在证书请求中必须提供(值可以不同)，否则拒签。
</span></span><span class="line"><span class="cl"># optional: 该变量在证书请求中可以存在也可以不存在(相当于没有要求)。
</span></span><span class="line"><span class="cl"># 除非preserve=yes或者在ca命令中使用了-preserveDN，否则在签发证书时将删除匹配策略中未提及的对象。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[ policy_match ]
</span></span><span class="line"><span class="cl">countryName		= match
</span></span><span class="line"><span class="cl">stateOrProvinceName	= match
</span></span><span class="line"><span class="cl">organizationName	= match
</span></span><span class="line"><span class="cl">organizationalUnitName	= optional
</span></span><span class="line"><span class="cl">commonName		= supplied
</span></span><span class="line"><span class="cl">emailAddress		= optional
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">########################################################################################
</span></span><span class="line"><span class="cl">############## &#34;特征名称&#34;字段包含了用户的标识信息，对应 -subj 命令行选项 ###################
</span></span><span class="line"><span class="cl">########################################################################################
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[ req_distinguished_name ]
</span></span><span class="line"><span class="cl">countryName = CN  # 必须是两字母国家代码
</span></span><span class="line"><span class="cl">stateOrProvinceName = # 省份或直辖市
</span></span><span class="line"><span class="cl">localityName = # 城市
</span></span><span class="line"><span class="cl">organizationName = # 组织名或公司名
</span></span><span class="line"><span class="cl">organizationalUnitName = # 部门名称
</span></span><span class="line"><span class="cl">commonName = # 全限定域名或个人姓名
</span></span><span class="line"><span class="cl">emailAddress = # Email地址
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">########################################################################################
</span></span><span class="line"><span class="cl">################################# 为签发的证书设置扩展项 #################################
</span></span><span class="line"><span class="cl">########################################################################################
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[ extendtsion_name ]
</span></span><span class="line"><span class="cl"># 基本约束(该证书是否为CA证书)。&#34;CA:FALSE&#34;表示非CA证书(不能签发其他证书的&#34;叶子证书&#34;)。
</span></span><span class="line"><span class="cl">basicConstraints = CA:FALSE
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 颁发机构密钥标识符(&#34;always&#34;表示始终包含)
</span></span><span class="line"><span class="cl">authorityKeyIdentifier = keyid:always,issuer
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># PKIX工作组推荐将使用者与颁发机构的密钥标识符包含在证书中
</span></span><span class="line"><span class="cl">subjectKeyIdentifier=hash
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 证书用途，如省略，則可以用于签名外的任何。
</span></span><span class="line"><span class="cl"># server SSL服务器
</span></span><span class="line"><span class="cl"># objsign 签名证书
</span></span><span class="line"><span class="cl"># client 客户端
</span></span><span class="line"><span class="cl"># email 电子邮件
</span></span><span class="line"><span class="cl">nsCertType = client
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># Netscape Comment（nsComment）是包含注释的字符串扩展名，当在某些浏览器中查看证书时，该注释将显示。
</span></span><span class="line"><span class="cl">nsComment = &#34;OpenSSL Generated Client Certificate&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 密钥用法：防否认(nonRepudiation)、数字签名(digitalSignature)、密钥加密(keyEncipherment)。
</span></span><span class="line"><span class="cl"># 密钥协商(keyAgreement)、数据加密(dataEncipherment)、仅加密(encipherOnly)、仅解密(decipherOnly)
</span></span><span class="line"><span class="cl">keyUsage = nonRepudiation, digitalSignature, keyEncipherment
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 增强型密钥用法(参见&#34;new_oids&#34;字段)：服务器身份验证、客户端身份验证、时间戳。
</span></span><span class="line"><span class="cl">extendedKeyUsage = critical,serverAuth, clientAuth, timeStamping
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 使用者备用名称(email, URI, DNS, RID, IP, dirName)
</span></span><span class="line"><span class="cl"># 例如，DNS常用于实现泛域名证书、IP常用于绑定特定的IP地址、&#34;copy&#34;表示直接复制
</span></span><span class="line"><span class="cl">subjectAltName = DNS:www.example.com, DNS:*.example.net, IP:192.168.7.1, IP:13::17
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="openssl扩展密钥用法生成多域名证书">OpenSSL扩展密钥用法：生成多域名证书<a hidden class="anchor" aria-hidden="true" href="#openssl扩展密钥用法生成多域名证书">¶</a></h3>
<p>SAN(Subject Alternative Name) 是 <code>SSL/TLS</code> 标准 <code>x.509</code> 中定义的一个扩展。使用了SAN字段的 SSL 证书，可以扩展此证书支持的域名，使一个证书可支持多个不同域名的解析。<a href="https://tools.ietf.org/html/rfc5280#section-4.2.1.6">RFC 5280 4.2.1.6</a></p>
<p>
  <img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/1380340-20201112203256164-952424212.png" alt=""  /></p>
<p>
  <img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/1380340-20201112203458757-2086651260.png" alt=""  /></p>
<p>可以看到面子书与京东的证书的 <code>Subject Alternative Name</code> 段中列了大量的域名，使用这种类型的证书能够极大的简化网站证书的管理</p>
<h4 id="使用openssl生成根ca">使用OpenSSL生成根CA<a hidden class="anchor" aria-hidden="true" href="#使用openssl生成根ca">¶</a></h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">cd</span> /etc/pki/tls/
</span></span><span class="line"><span class="cl">openssl genrsa -out private/cakey.pem <span class="m">2048</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">openssl req -new <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	-x509 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	-key private/cakey.pem <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	-out cacert.pem <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	-days <span class="m">3650</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>	-subj <span class="s2">&#34;/C=HK/ST=HK/L=HK/O=chinamobile/OU=SY/CN=CHINA MOBILE&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="准备openssl配置文件">准备openssl配置文件<a hidden class="anchor" aria-hidden="true" href="#准备openssl配置文件">¶</a></h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">[ v3_req ]
</span></span><span class="line"><span class="cl">basicConstraints = CA:FALSE
</span></span><span class="line"><span class="cl">keyUsage = nonRepudiation, digitalSignature, keyEncipherment
</span></span><span class="line"><span class="cl">subjectKeyIdentifier=hash
</span></span><span class="line"><span class="cl">authorityKeyIdentifier = keyid:always,issuer
</span></span><span class="line"><span class="cl">nsComment = &#34;OpenSSL Generated Client Certificate&#34;
</span></span><span class="line"><span class="cl">subjectAltName = DNS:etcd, DNS:hk-etcd, IP:10.0.0.1
</span></span><span class="line"><span class="cl">nsCertType = client, server
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看到此证书请求文件中会包含 <code>Subject Alternative Names</code> 字段，并包含之前在配置文件中填写的域名。</p>
<h4 id="使用-openssl-签署带有-san-扩展的证书请求csr">使用 openssl 签署带有 SAN 扩展的证书请求csr<a hidden class="anchor" aria-hidden="true" href="#使用-openssl-签署带有-san-扩展的证书请求csr">¶</a></h4>
<ol>
<li>生成私钥</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">mkdir child
</span></span><span class="line"><span class="cl">openssl genrsa -out child/child.pem 2048
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>生成证书申请文件 <code>child.csr</code></li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">openssl req -new \
</span></span><span class="line"><span class="cl">	-key child/child.pem \
</span></span><span class="line"><span class="cl">	-out child/child.csr \
</span></span><span class="line"><span class="cl">	-subj &#34;/C=HK/ST=HK/L=HK/O=chinamobile/OU=SY/CN=hketcd&#34; \
</span></span><span class="line"><span class="cl">	-config ./openssl.cnf
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p><strong>单条命令实现方式</strong></p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">openssl req -new \
</span></span><span class="line"><span class="cl">	-key child/child.pem \
</span></span><span class="line"><span class="cl">	-subj &#34;/C=HK/ST=HK/L=HK/O=chinamobile/OU=SY/CN=hketcd&#34; \
</span></span><span class="line"><span class="cl">	-reqexts req_v3 \
</span></span><span class="line"><span class="cl">	-config &lt;(cat /etc/pki/tls/openssl.cnf \
</span></span><span class="line"><span class="cl"> 			&lt;(printf &#34;[aa]\nsubjectAltName=DNS:etcd, DNS:hk-etcd, IP:10.0.0.1&#34;)) \
</span></span><span class="line"><span class="cl">	-out child/child.csr
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>CA颁发证书</li>
</ol>
<p>单条命令实现</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">openssl ca \
</span></span><span class="line"><span class="cl">	-in child/child.csr \
</span></span><span class="line"><span class="cl">	-cert cacert.pem \
</span></span><span class="line"><span class="cl">	-keyfile private/cakey.pem \
</span></span><span class="line"><span class="cl">	-out child/child.crt \
</span></span><span class="line"><span class="cl">	-days 30 \
</span></span><span class="line"><span class="cl">	-extensions aa \
</span></span><span class="line"><span class="cl">	-extfile &lt;(cat /etc/pki/tls/openssl.cnf \
</span></span><span class="line"><span class="cl">             &lt;(printf &#34;[aa]\nsubjectAltName=DNS:etcd, DNS:hk-etcd, IP:10.0.0.1&#34;))
</span></span></code></pre></td></tr></table>
</div>
</div><p>
  <img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/1380340-20201112210753782-1479864379.png" alt="img"  /></p>


    
    


<div class="copyrightBlock" >
    <div class="articleSuffix-bg"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 147.78 155.96"> <path d="M10.5,99.81a1.9,1.9,0,0,0-.53-.09,1.66,1.66,0,0,0-1.64,1.65A1.64,1.64,0,0,0,10,103a1.57,1.57,0,0,0,.87-.25l26.76,26.82.45-1.08L11.52,101.91A1.65,1.65,0,0,0,10.5,99.81Zm-.13,2a.57.57,0,0,1-.8,0,.58.58,0,0,1-.17-.41.58.58,0,0,1,.57-.57h0a.57.57,0,0,1,.56.58A.55.55,0,0,1,10.37,101.77Z" style="fill:#c5c9e0"></path><path d="M56.15,117.58H39.06l0-.09a1.65,1.65,0,0,0-1.36-1H37.5a1.65,1.65,0,1,0,1.56,2.19H55.7L92.92,156h41.44v-1.08h-41Zm-18.25.94a.56.56,0,0,1-.79,0,.58.58,0,0,1-.17-.41.57.57,0,0,1,.56-.57h0a.58.58,0,0,1,.57.58A.54.54,0,0,1,37.9,118.52Z" style="fill:#c5c9e0"></path><path d="M23.52,50.32a1.65,1.65,0,0,0,1.55-1.11H55.28l48-48.13h31.06V0H102.85l-48,48.13H25.07a1.64,1.64,0,0,0-2.09-1,1.64,1.64,0,0,0,.54,3.2Zm0-2.21a.57.57,0,0,1,0,1.13.57.57,0,1,1,0-1.13Z" style="fill:#c5c9e0"></path><polygon points="102.86 0 102.86 0 102.86 0 102.86 0" style="fill:#c5c9e0"></polygon><path d="M107.72,12.14h26.64V11.07H107.27L57.4,61H3.09a1.66,1.66,0,0,0-1.45-.86H1.52A1.65,1.65,0,1,0,2.81,63a1.59,1.59,0,0,0,.45-.87H57.85ZM2.05,62.23a.57.57,0,0,1-.8,0,.58.58,0,0,1-.17-.41.57.57,0,0,1,.56-.57h.09a.57.57,0,0,1,.32,1Z" style="fill:#c5c9e0"></path><path d="M134.36,43.22V42.14h-22.3l-9.62,9.63a1.64,1.64,0,0,0-2.19.77,1.61,1.61,0,0,0-.17.71,1.65,1.65,0,1,0,3.29,0,1.61,1.61,0,0,0-.16-.72l9.3-9.32Zm-32.64,10.6a.57.57,0,0,1,0-1.13.57.57,0,0,1,0,1.13Z" style="fill:#c5c9e0"></path><path d="M147,52.3l-9,9H111.48a1.64,1.64,0,0,0-1.61-1.33h-.14a1.65,1.65,0,1,0,1.6,2.41h27.19l9.26-9.29L147,52.3Zm-37.15,9.85a.56.56,0,0,1-.56-.57h0a.56.56,0,0,1,.56-.56h0a.57.57,0,1,1,0,1.13Z" style="fill:#c5c9e0"></path><path d="M66.79,75.35l11,11.06h56.53V85.33H78.27l-11-11.06H49.49L37.12,86.67a1.64,1.64,0,0,0-2.09,1,1.61,1.61,0,0,0-.09.54,1.65,1.65,0,0,0,3.29,0,1.68,1.68,0,0,0-.26-.89l12-12ZM36.58,88.79a.57.57,0,1,1,.57-.56A.57.57,0,0,1,36.58,88.79Z" style="fill:#c5c9e0"></path><path d="M110.61,95.55,92.8,113.4a1.62,1.62,0,1,0,.77.76l17.49-17.53h23.31V95.55ZM92.49,115.28a.56.56,0,0,1-.8,0,.58.58,0,0,1-.17-.41.57.57,0,0,1,.57-.57h0a.58.58,0,0,1,.56.58A.55.55,0,0,1,92.49,115.28Z" style="fill:#c5c9e0"></path><path d="M97.89,122.3H76.62L64.2,109.85a1.65,1.65,0,0,0-.77-2.2,1.77,1.77,0,0,0-.72-.17h-.14a1.65,1.65,0,0,0,.15,3.29,1.58,1.58,0,0,0,.71-.17l12.74,12.77H98.34l17.48-17.52h18.54v-1.08h-19ZM63.12,109.53a.56.56,0,0,1-.8,0,.58.58,0,0,1-.17-.41.57.57,0,0,1,1.14,0A.54.54,0,0,1,63.12,109.53Z" style="fill:#c5c9e0"></path> </svg> </div>
    <p>本文发布于<a href="https://www.oomkill.com/about" target="_blank">Cylon的收藏册</a>，转载请著名原文链接~</p>
    <p>链接：<a href="https://www.oomkill.com/2020/08/openssl-x509/" target="_blank">https://www.oomkill.com/2020/08/openssl-x509/</a></p>
    <p style="margin-bottom: 0px;">版权：本作品采用<a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">「署名-非商业性使用-相同方式共享 4.0 国际」</a> 许可协议进行许可。</p>
    </div>
</div>
  </div>

  <footer class="post-footer">
    
<nav class="paginav">
  <a class="prev" href="https://www.oomkill.com/2020/08/istio-cli/">
    <span class="title"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left" style="user-select: text;"><line x1="19" y1="12" x2="5" y2="12" style="user-select: text;"></line><polyline points="12 19 5 12 12 5" style="user-select: text;"></polyline>
      </polyline></svg>&nbsp; </span>
    
    <span>istio命令</span>
  </a>
  <a class="next" href="https://www.oomkill.com/2020/05/ciper-script/" >
    <span class="title"> </span>
    
    <span>脚本在公网的加密执行&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right" style="user-select: text;"><line x1="5" y1="12" x2="19" y2="12" style="user-select: text;"></line><polyline points="12 5 19 12 12 19" style="user-select: text;"></polyline></svg></span>
  </a>
</nav>

  </footer>

  
  <div class="pagination__title">
    <span class="pagination__title-h"></span>
  </div>
  
  
  
  
    <div class="comments-separator"></div>
    

  

  
    
      <div class="comments-separator"></div>
<div class="comments">
    <script>
    function loadComment() {
        let theme = localStorage.getItem('pref-theme') === 'dark' ? 'dark' : 'light';
        let s = document.createElement('script');
        s.src = 'https://giscus.app/client.js';
        s.setAttribute('data-repo', 'cylonchau\/cylonchau.github.io');
        s.setAttribute('data-repo-id', 'R_kgDOIRlNSQ');
        s.setAttribute('data-category', 'Announcements');
        s.setAttribute('data-category-id', 'DIC_kwDOIRlNSc4CXy1U');
        s.setAttribute('data-mapping', 'title');
        s.setAttribute('data-reactions-enabled', '1');
        s.setAttribute('data-emit-metadata', '1');
        s.setAttribute('data-input-position', 'top');
        s.setAttribute('data-lang', 'zh-TW');
        s.setAttribute('data-theme', theme);
        s.setAttribute('crossorigin', 'anonymous');
        s.setAttribute('async', '');
        document.querySelector('div.comments').innerHTML = '';
        document.querySelector('div.comments').appendChild(s);
    }
    loadComment();
    </script>
</div>
</article>
    </main>
    
<footer class="footer">
  <p>
  Copyright
  <span>&copy; 2024 <a href="https://www.oomkill.com">Cylon&#39;s Collection</a></span></p>
  <span style="display: inline-block; margin-left: 1em;">
    Powered by
    <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> on github-page & Theme
    <a href="https://github.com/reorx/hugo-PaperModX/" rel="noopener" target="_blank">PaperModX</a>
  </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <span class="topInner">
        <svg class="topSvg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z"/>
        </svg>
        <span id="read_progress"></span>
    </span>
</a>

<script>
  (function() {
     
    const disableThemeToggle = '' == '1';
    if (disableThemeToggle) {
      return;
    }

    let button = document.getElementById("theme-toggle")
    
    button.removeEventListener('click', toggleThemeListener)
    
    button.addEventListener('click', toggleThemeListener)
  })();
</script>

<script>
  (function () {
    let menu = document.getElementById('menu')
    if (menu) {
      menu.scrollLeft = localStorage.getItem("menu-scroll-position");
      menu.onscroll = function () {
        localStorage.setItem("menu-scroll-position", menu.scrollLeft);
      }
    }

    const disableSmoothScroll = '' == '1';
    const enableInstantClick = '1' == '1';
    
    if (window.matchMedia('(prefers-reduced-motion: reduce)').matches || disableSmoothScroll || enableInstantClick) {
      return;
    }
    
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
      anchor.addEventListener("click", function (e) {
        e.preventDefault();
        var id = this.getAttribute("href").substr(1);
        document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
          behavior: "smooth"
        });
        if (id === "top") {
          history.replaceState(null, null, " ");
        } else {
          history.pushState(null, null, `#${id}`);
        }
      });
    });
  })();
</script>

<script>
  document.addEventListener('scroll', function (e) {
      const readProgress = document.getElementById("read_progress");
      const scrollHeight = document.documentElement.scrollHeight;
      const clientHeight = document.documentElement.clientHeight;
      const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
      readProgress.innerText = ((scrollTop / (scrollHeight - clientHeight)).toFixed(2) * 100).toFixed(0);
  })
</script>

<script>
  var menu = document.getElementById('menu')
  if (menu) {
      menu.scrollLeft = localStorage.getItem("menu-scroll-position");
      menu.onscroll = function () {
          localStorage.setItem("menu-scroll-position", menu.scrollLeft);
      }
  }

  document.querySelectorAll('a[href^="#"]').forEach(anchor => {
      anchor.addEventListener("click", function (e) {
          e.preventDefault();
          var id = this.getAttribute("href").substr(1);
          if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
              document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                  behavior: "smooth"
              });
          } else {
              document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
          }
          if (id === "top") {
              history.replaceState(null, null, " ");
          } else {
              history.pushState(null, null, `#${id}`);
          }
      });
  });
</script>
<script>
  var mybutton = document.getElementById("top-link");
  window.onscroll = function () {
      if (document.body.scrollTop > 200 || document.documentElement.scrollTop > 200) {
          mybutton.style.visibility = "visible";
          mybutton.style.opacity = "1";
      } else {
          mybutton.style.visibility = "hidden";
          mybutton.style.opacity = "0";
      }
  };
</script>
<script>
  if (window.scrollListeners) {
    
    for (const listener of scrollListeners) {
      window.removeEventListener('scroll', listener)
    }
  }
  window.scrollListeners = []
</script>



<script src="/js/medium-zoom.min.js" data-no-instant
></script>
<script>
  document.querySelectorAll('pre > code').forEach((codeblock) => {
    const container = codeblock.parentNode.parentNode;

    const copybutton = document.createElement('button');
    copybutton.classList.add('copy-code');
    copybutton.innerText = 'copy';

    function copyingDone() {
      copybutton.innerText = 'copied';
      setTimeout(() => {
        copybutton.innerText = 'copy';
      }, 2000);
    }

    copybutton.addEventListener('click', (cb) => {
      if ('clipboard' in navigator) {
        navigator.clipboard.writeText(codeblock.textContent);
        copyingDone();
        return;
      }

      const range = document.createRange();
      range.selectNodeContents(codeblock);
      const selection = window.getSelection();
      selection.removeAllRanges();
      selection.addRange(range);
      try {
        document.execCommand('copy');
        copyingDone();
      } catch (e) { };
      selection.removeRange(range);
    });

    if (container.classList.contains("highlight")) {
      container.appendChild(copybutton);
    } else if (container.parentNode.firstChild == container) {
      
    } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
      
      codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
    } else {
      
      codeblock.parentNode.appendChild(copybutton);
    }
  });
</script>




<script>
  
  
  (function() {
    const enableTocScroll = '1' == '1'
    if (!enableTocScroll) {
      return
    }
    if (!document.querySelector('.toc')) {
      console.log('no toc found, ignore toc scroll')
      return
    }
    

    
    const scrollListeners = window.scrollListeners
    const headings = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id]');
    const activeClass = 'active';

    
    let activeHeading = headings[0];
    getLinkByHeading(activeHeading).classList.add(activeClass);

    const onScroll = () => {
      const passedHeadings = [];
      for (const h of headings) {
        
        if (getOffsetTop(h) < 5) {
          passedHeadings.push(h)
        } else {
          break;
        }
      }
      if (passedHeadings.length > 0) {
        newActiveHeading = passedHeadings[passedHeadings.length - 1];
      } else {
        newActiveHeading = headings[0];
      }
      if (activeHeading != newActiveHeading) {
        getLinkByHeading(activeHeading).classList.remove(activeClass);
        activeHeading = newActiveHeading;
        getLinkByHeading(activeHeading).classList.add(activeClass);
      }
    }

    let timer = null;
    const scrollListener = () => {
      if (timer !== null) {
        clearTimeout(timer)
      }
      timer = setTimeout(onScroll, 50)
    }
    window.addEventListener('scroll', scrollListener, false);
    scrollListeners.push(scrollListener)

    function getLinkByHeading(heading) {
      const id = encodeURI(heading.getAttribute('id')).toLowerCase();
      return document.querySelector(`.toc ul li a[href="#${id}"]`);
    }

    function getOffsetTop(heading) {
      if (!heading.getClientRects().length) {
        return 0;
      }
      let rect = heading.getBoundingClientRect();
      return rect.top
    }
  })();
  </script>

<script src="/js/instantclick.min.js" data-no-instant
></script>
<script data-no-instant>
  
  
  
  
  
  
  InstantClick.init();
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/8.6.0/mermaid.min.js" crossorigin="anonymous"></script>
<script>
    mermaid.init(undefined, '.language-mermaid');
</script>
</body>

</html>
