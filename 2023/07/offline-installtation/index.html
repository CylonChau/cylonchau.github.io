<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>无互联网环境下安装Spinnaker - Offline Install Spinnaker | Cylon's Collection</title>
<meta name=keywords content="Spinnaker"><meta name=description content="Prerequisites 具有一个 Kubernetes 集群 以部署 Spinnaker 可运行 Docker 的环境 (1 vCPU, 3.75 GB) 或者是 Ubuntu，用以安装 Halyard (用于 spinnaker 的服务) 对象存储 (MinIO)，用于持久化 Spinnaker 的数据 对象存储的 Bucket 的访问账号 安装执行步骤 安装 Halyard 可以直接使用 Docker 方式安装，这个没什么必要性，就是管理工具而已，参考附录1 [1]
首先创建映射目录
bash 1 2 mkdir ~/.hal -pv mkdir ~/.kubeconfig -pv 然后执行 docker run 运行容器
bash 1 2 3 4 5 6 7 docker run -d -p 8084:8084 -p 9000:9000 \ --name halyard --rm \ -v ~/.hal:/home/spinnaker/.hal \ -v ~/."><meta name=author content="cylon"><link rel=canonical href=https://www.oomkill.com/2023/07/offline-installtation/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://www.oomkill.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.oomkill.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.oomkill.com/favicon-32x32.png><link rel=apple-touch-icon href=https://www.oomkill.com/favicon.ico><link rel=mask-icon href=https://www.oomkill.com/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://www.oomkill.com/2023/07/offline-installtation/><noscript><style>#theme-toggle,#top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link crossorigin=anonymous href=/assets/css/pe.min.css rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/pe.min.js></script><link rel=stylesheet href=https://cdn.staticfile.net/font-awesome/6.5.1/css/all.min.css><link rel=stylesheet href=https://cdn.staticfile.net/font-awesome/6.5.1/css/v4-shims.min.css><script defer src=https://cdn.staticfile.net/jquery/3.5.1/jquery.min.js></script><link rel=stylesheet href=https://cdn.staticfile.net/fancybox/3.5.7/jquery.fancybox.min.css><script defer src=https://cdn.staticfile.net/fancybox/3.5.7/jquery.fancybox.min.js></script><script id=MathJax-script async src=https://cdn.staticfile.net/mathjax/3.2.2/es5/tex-chtml.js></script><script>MathJax={tex:{displayMath:[["$$","$$"]],inlineMath:[["\\$","\\$"]]}}</script><meta property="og:title" content="无互联网环境下安装Spinnaker - Offline Install Spinnaker"><meta property="og:description" content="Prerequisites 具有一个 Kubernetes 集群 以部署 Spinnaker 可运行 Docker 的环境 (1 vCPU, 3.75 GB) 或者是 Ubuntu，用以安装 Halyard (用于 spinnaker 的服务) 对象存储 (MinIO)，用于持久化 Spinnaker 的数据 对象存储的 Bucket 的访问账号 安装执行步骤 安装 Halyard 可以直接使用 Docker 方式安装，这个没什么必要性，就是管理工具而已，参考附录1 [1]
首先创建映射目录
bash 1 2 mkdir ~/.hal -pv mkdir ~/.kubeconfig -pv 然后执行 docker run 运行容器
bash 1 2 3 4 5 6 7 docker run -d -p 8084:8084 -p 9000:9000 \ --name halyard --rm \ -v ~/.hal:/home/spinnaker/.hal \ -v ~/."><meta property="og:type" content="article"><meta property="og:url" content="https://www.oomkill.com/2023/07/offline-installtation/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-07-10T00:00:00+00:00"><meta property="og:site_name" content="Cylon's Collection"><meta name=twitter:card content="summary"><meta name=twitter:title content="无互联网环境下安装Spinnaker - Offline Install Spinnaker"><meta name=twitter:description content="Prerequisites 具有一个 Kubernetes 集群 以部署 Spinnaker 可运行 Docker 的环境 (1 vCPU, 3.75 GB) 或者是 Ubuntu，用以安装 Halyard (用于 spinnaker 的服务) 对象存储 (MinIO)，用于持久化 Spinnaker 的数据 对象存储的 Bucket 的访问账号 安装执行步骤 安装 Halyard 可以直接使用 Docker 方式安装，这个没什么必要性，就是管理工具而已，参考附录1 [1]
首先创建映射目录
bash 1 2 mkdir ~/.hal -pv mkdir ~/.kubeconfig -pv 然后执行 docker run 运行容器
bash 1 2 3 4 5 6 7 docker run -d -p 8084:8084 -p 9000:9000 \ --name halyard --rm \ -v ~/.hal:/home/spinnaker/.hal \ -v ~/."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://www.oomkill.com/posts/"},{"@type":"ListItem","position":2,"name":"无互联网环境下安装Spinnaker - Offline Install Spinnaker","item":"https://www.oomkill.com/2023/07/offline-installtation/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"无互联网环境下安装Spinnaker - Offline Install Spinnaker","name":"无互联网环境下安装Spinnaker - Offline Install Spinnaker","description":"Prerequisites 具有一个 Kubernetes 集群 以部署 Spinnaker 可运行 Docker 的环境 (1 vCPU, 3.75 GB) 或者是 Ubuntu，用以安装 Halyard (用于 spinnaker 的服务) 对象存储 (MinIO)，用于持久化 Spinnaker 的数据 对象存储的 Bucket 的访问账号 安装执行步骤 安装 Halyard 可以直接使用 Docker 方式安装，这个没什么必要性，就是管理工具而已，参考附录1 [1]\n首先创建映射目录\nbash 1 2 mkdir ~/.hal -pv mkdir ~/.kubeconfig -pv 然后执行 docker run 运行容器\nbash 1 2 3 4 5 6 7 docker run -d -p 8084:8084 -p 9000:9000 \\ --name halyard --rm \\ -v ~/.hal:/home/spinnaker/.hal \\ -v ~/.","keywords":["Spinnaker"],"articleBody":"Prerequisites 具有一个 Kubernetes 集群 以部署 Spinnaker 可运行 Docker 的环境 (1 vCPU, 3.75 GB) 或者是 Ubuntu，用以安装 Halyard (用于 spinnaker 的服务) 对象存储 (MinIO)，用于持久化 Spinnaker 的数据 对象存储的 Bucket 的访问账号 安装执行步骤 安装 Halyard 可以直接使用 Docker 方式安装，这个没什么必要性，就是管理工具而已，参考附录1 [1]\n首先创建映射目录\nbash 1 2 mkdir ~/.hal -pv mkdir ~/.kubeconfig -pv 然后执行 docker run 运行容器\nbash 1 2 3 4 5 6 7 docker run -d -p 8084:8084 -p 9000:9000 \\ --name halyard --rm \\ -v ~/.hal:/home/spinnaker/.hal \\ -v ~/.kubeconfig:/home/spinnaker/.kube \\ -v /usr/local/bin:/usr/local/sbin \\ -v /etc/kubernetes/auth/admin.conf:/home/spinnaker/.kube/config \\ us-docker.pkg.dev/spinnaker-community/docker/halyard:stable 因为 docker 环境不能重启服务，需要修改配置文件，这里可以在外部创建一个配置文件来映射进去，这里后面会说到 GCS 的问题\nbash 1 $ docker run -it --rm us-docker.pkg.dev/spinnaker-community/docker/halyard:stable cat /opt/halyard/config/halyard.yml \u003e /tmp/halyard.yml 修改 spinnaker 部分的配置，将 enabled: true ，改为 enabled: false\nyaml 1 2 3 4 5 6 7 8 9 10 spinnaker: artifacts: debian: https://us-apt.pkg.dev/projects/spinnaker-community docker: us-docker.pkg.dev/spinnaker-community/docker config: input: gcs: enabled: false writerEnabled: false bucket: halconfig 然后将输出的配置文件保存到宿主机，而后映射到容器内即可\nbash 1 2 3 4 5 6 7 8 docker run -d -p 8084:8084 -p 9000:9000 \\ --name halyard --rm \\ -v ~/.hal:/home/spinnaker/.hal \\ -v ~/.kubeconfig:/home/spinnaker/.kube \\ -v /usr/local/bin:/usr/local/sbin \\ -v /etc/kubernetes/auth/admin.conf:/home/spinnaker/.kube/config \\ -v /tmp/halyard.yml:/opt/halyard/config/halyard.yml \\ us-docker.pkg.dev/spinnaker-community/docker/halyard:stable 安装kubectl 这部分在上一章中注明了挂载 kubectl 的路径\n使用 Docker 运行的 Halyard 可以直接挂在 kubectl 到 容器内就可以了，halyard 默认的路径在 /usr/local/bin 只要避免和这个路径冲突就可以了。\nhalyard 中附带的 kubectl 不一定与你的集群版本一致\n最后进入容器就可以管理 spinnaker 了\nbash 1 docker exec -it halyard bash 生成一个 Halyard config [3] 离线安装时，需要生成一个 Halyard config 文件，默认在 ~/.hal/config\nbash 1 hal config version edit --version local:1.19.2 Notes:\n如果是选择离线安装或者 Local 方式安装，那么 local 关键字必须加 如果主机没有网，此时需要指定参数 --no-validate 来控制关闭验证，验证通常要联网 对于执行大部分的 hal 命令都会在 ~/.hal/config 生成配置文件 选择云供应商 这里可以指选择一个 Kubernetes 集群将其添加到 Halyard config 中\n注意，这里需要时 Kubectl 可以正常请求集群，即需要 kubectl 与 kubeconfig\n但在选择 Kubernetes 作为 Halyard 的 provider 之前，可以在 Kubernetes 中创建一个新的 service 以在 Halyard 中使用。\nbash 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 # Run in Halyard container CONTEXT=$(kubectl config current-context) kubectl apply --context $CONTEXT \\ -f https://spinnaker.io/downloads/kubernetes/service-account.yml TOKEN=$(kubectl get secret --context $CONTEXT \\ $(kubectl get serviceaccount spinnaker-service-account \\ --context $CONTEXT \\ -n spinnaker \\ -o jsonpath='{.secrets[0].name}') \\ -n spinnaker \\ -o jsonpath='{.data.token}' | base64 --decode) kubectl config set-credentials ${CONTEXT}-token-user --token $TOKEN kubectl config set-context $CONTEXT --user ${CONTEXT}-token-user 启用 kubernetes，并配置使用的 kubernetes 用户\nbash 1 2 3 4 5 6 7 # Run in Halyard container hal config provider kubernetes enable ACCOUNT=\"my-k8s-account\" hal config provider kubernetes account add ${ACCOUNT} \\ --context ${CONTEXT} Halyard 有几种部署 Spinnaker 服务的选项，例如Local, git 和 Distributed，这里使用 Distributed 模式，将 Spinnaker 以分布式方式部署到 Kubernetes内。\nbash 1 hal config deploy edit --type distributed --account-name $ACCOUNT 配置S3存储 Spinnaker 需要外部存储，例如 S3 对象存储置，为此，我使用 Minio 作为外部存储服务。这里使用 docker 进行部署，作为学习，也可以使用 minIO 官方提供的 minIO-dev [4]，可以快速在 Kubernetes 集群上部署一个单实例的 minIO\nbash 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 # System MINIO_ROOT_USER=$(\u003c /dev/urandom tr -dc a-z | head -c${1:-4}) MINIO_ROOT_PASSWORD=$(\u003c /dev/urandom tr -dc _A-Z-a-z-0-9 | head -c${1:-8}) MINIO_PORT=\"9010\" # Start the container docker run -it -d --rm -v ~/.minio-data/:/data --name minio-4-spinnaker -p ${MINIO_PORT}:${MINIO_PORT} \\ -e MINIO_ROOT_USER=${MINIO_ROOT_USER} -e MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD} \\ minio/minio server /data --address :${MINIO_PORT} # This information is used in next {.1} echo \" MINIO_ROOT_USER=${MINIO_ROOT_USER} MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD} ENDPOINT=http://$(docker inspect -f '{{range.NetworkSettings.Networks}}{{.IPAddress}}{{end}}' minio-4-spinnaker):${MINIO_PORT} \" 如果需要开启，那么需要在目录 ~/.hal/default/profiles/front50-local.yml 创建文件\nbash 1 2 3 spinnaker: s3: versioning: false 然后使用以下命令进行配置到 halyard config 文件\nbash 1 2 3 4 5 6 7 8 9 ENDPOINT=http://10.0.2.4:9000 MINIO_ACCESS_KEY=minio MINIO_SECRET_KEY=minio123 echo $MINIO_SECRET_KEY | hal config storage s3 edit --endpoint $ENDPOINT \\ --access-key-id $MINIO_ACCESS_KEY \\ --secret-access-key hal config storage edit --type s3 生成一个BOM文件 找一台有外网的主机，执行下列命令\nbash 1 hal version bom 1.19.2 -q -o yaml Note: 如果开启了 gcs.enabled: true 需要重新启动一个容器，因为这个步骤需要联网查询\nbash 1 2 3 4 5 $ DOCKERID=`docker run -d --rm \\ -v ~/.hal:/home/spinnaker/.hal \\ us-docker.pkg.dev/spinnaker-community/docker/halyard:stable` $ docker exec -it ${DOCKERID} hal version bom 1.19.2 -q -o yaml \u0026\u0026 docker stop ${DOCKERID} 将输出的文件保存在 halyard 容器内 ~/.hal/.boms/bom/{version}.yml ，将 {version} 替换为你安装的版本，例如这里为 1.19.2\n其次，要在本地执行此操作的容器内，需要在 halconfig 目录下有对应的 BOM 清单，清单格式如下：\nbash 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 $ tree ~/.hal/.boms/ /root/.hal/.boms/ ├── bom │ └── 1.19.2.yml ├── clouddriver │ └── clouddriver.yml ├── deck │ └── settings.js ├── echo │ └── echo.yml ├── fiat │ └── fiat.yml ├── front50 │ └── front50.yml ├── gate │ └── gate.yml ├── igor │ └── igor.yml ├── kayenta │ └── kayenta.yml ├── orca │ └── orca.yml └── rosco └── rosco.yml 这些文件夹需要自行创建，并且里面的配置文件也需要自行创建，如果不知道格式如何，可以参考 Spinnaker github 仓库上，每一个上面的文件夹都是一个项目仓库，而这些仓库的根目录都存在一个 halconfig 目录，此时需要你将对应的文件保存到对应目录下，例如，clouddriver 文件夹需要选择 github.com/spinnaker/clouddriver 项目，而配置文件需要选择 {service_name}.yml 为命名的，例如 clouddriver 就需要选择 clouddriver.yml，这个需要自行下载。\n可以使用下列脚本进行生成这些配置文件（需要上网）\nbash 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 #!/bin/bash #################################################################################### # Install Spinnaker scripts for CentOS # #################################################################################### set -e START_TIME=`date +%s` export PATH=/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin export ROOT=$(cd $(dirname $0); pwd) export BASE_URL=\"https://raw.githubusercontent.com/spinnaker\" export DECK_FILE_NAME=\"halconfig/settings.js\" export FILE_PREFIX=\"halconfig\" usage(){ cat \u003c","wordCount":"1920","inLanguage":"zh","datePublished":"2023-07-10T00:00:00Z","dateModified":"0001-01-01T00:00:00Z","author":{"@type":"Person","name":"cylon"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.oomkill.com/2023/07/offline-installtation/"},"publisher":{"@type":"Organization","name":"Cylon's Collection","logo":{"@type":"ImageObject","url":"https://www.oomkill.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.oomkill.com/><img src=https://www.oomkill.com/favicon.ico alt aria-label=logo height=20>Cylon's Collection</a><div class=logo-switches><button id=theme-toggle><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://www.oomkill.com/archives><span>归档</span></a></li><li><a href=https://www.oomkill.com/tags><span>标签</span></a></li><li><a href=https://www.oomkill.com/search><span>搜索</span></a></li><li><a href=https://www.oomkill.com/about accesskey=/><span>关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">无互联网环境下安装Spinnaker - Offline Install Spinnaker</h1><div class=post-meta><span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar" style="user-select:text"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" style="user-select:text"/><line x1="16" y1="2" x2="16" y2="6" style="user-select:text"/><line x1="8" y1="2" x2="8" y2="6" style="user-select:text"/><line x1="3" y1="10" x2="21" y2="10" style="user-select:text"/></svg><span>2023-07-10</span></span>&nbsp;·&nbsp;<span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text" style="user-select:text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z" style="user-select:text"/><polyline points="14 2 14 8 20 8" style="user-select:text"/><line x1="16" y1="13" x2="8" y2="13" style="user-select:text"/><line x1="16" y1="17" x2="8" y2="17" style="user-select:text"/><polyline points="10 9 9 9 8 9" style="user-select:text"/></svg><span>1920 字</span></span>&nbsp;·&nbsp;<span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><span>10 分钟</span></span>
<span class=pe-post-meta-item>&nbsp;·&nbsp;<svg t="1714036239378" fill="currentcolor" class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="6659" width="256" height="256"><path d="M690 78.2c-18.6-18.8-49-19-67.8-.4s-19 49-.4 67.8l255.4 258.6c67.8 68.6 67.8 178.8.0 247.4L653.4 878.2c-18.6 18.8-18.4 49.2.4 67.8s49.2 18.4 67.8-.4l224-226.4c104.8-106 104.8-276.4.0-382.4L690 78.2zM485.4 101.4c-24-24-56.6-37.4-90.6-37.4H96C43 64 0 107 0 160v299c0 34 13.4 66.6 37.4 90.6l336 336c50 50 131 50 181 0l267-267c50-50 50-131 0-181l-336-336zM96 160h299c8.4.0 16.6 3.4 22.6 9.4l336 336c12.4 12.4 12.4 32.8.0 45.2l-267 267c-12.4 12.4-32.8 12.4-45.2.0l-336-336c-6-6-9.4-14.2-9.4-22.6V160zm192 128a64 64 0 10-128 0 64 64 0 10128 0z" p-id="6660"/></svg></span><ul class=pe-post-meta-item><a href=https://www.oomkill.com/tags/cicd/>#Cicd</a></ul></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details><summary><span class=details>目录</span></summary><div class=inner><ul><li><a href=#prerequisites aria-label=Prerequisites>Prerequisites</a><li><a href=#%e5%ae%89%e8%a3%85%e6%89%a7%e8%a1%8c%e6%ad%a5%e9%aa%a4 aria-label=安装执行步骤>安装执行步骤</a><ul><li><a href=#%e5%ae%89%e8%a3%85-halyard aria-label="安装 Halyard">安装 Halyard</a><li><a href=#%e5%ae%89%e8%a3%85kubectl aria-label=安装kubectl>安装kubectl</a><li><a href=#%e7%94%9f%e6%88%90%e4%b8%80%e4%b8%aa-halyard-config-supa-href33asup aria-label="生成一个 Halyard config [3]">生成一个 Halyard config <sup><a href=#3>[3]</a></sup></a><li><a href=#%e9%80%89%e6%8b%a9%e4%ba%91%e4%be%9b%e5%ba%94%e5%95%86 aria-label=选择云供应商>选择云供应商</a><li><a href=#%e9%85%8d%e7%bd%aes3%e5%ad%98%e5%82%a8 aria-label=配置S3存储>配置S3存储</a><li><a href=#%e7%94%9f%e6%88%90%e4%b8%80%e4%b8%aabom%e6%96%87%e4%bb%b6 aria-label=生成一个BOM文件>生成一个BOM文件</a><li><a href=#%e9%a2%9d%e5%a4%96%e4%b8%8b%e8%bd%bd%e4%b8%80%e4%b8%aa-packertargz aria-label="额外下载一个 packer.tar.gz">额外下载一个 packer.tar.gz</a><li><a href=#%e4%b8%babom%e6%9c%8d%e5%8a%a1%e9%85%8d%e7%bd%aelocal%e5%85%b3%e9%94%ae%e5%ad%97 aria-label=为BOM服务配置local关键字>为BOM服务配置local关键字</a><li><a href=#%e9%85%8d%e7%bd%ae%e9%95%9c%e5%83%8f%e8%8e%b7%e5%8f%96%e6%ba%90 aria-label=配置镜像获取源>配置镜像获取源</a><li><a href=#%e9%83%a8%e7%bd%b2 aria-label=部署>部署</a></ul><li><a href=#troubleshooting aria-label=Troubleshooting>Troubleshooting</a><ul><li><a href=#could-not-load-versionsyml-from-config-bucket-xx-supa-href22asup aria-label="Could not load &amp;ldquo;versions.yml&amp;rdquo; from config bucket: xx [2]">Could not load &ldquo;versions.yml&rdquo; from config bucket: xx <sup><a href=#2>[2]</a></sup></a><li><a href=#unable-to-retrieve-profile-clouddriveryml aria-label="Unable to retrieve profile &amp;ldquo;clouddriver.yml&amp;rdquo;">Unable to retrieve profile &ldquo;clouddriver.yml&rdquo;</a><li><a href=#unable-to-retrieve-profile-versionsyml aria-label="Unable to retrieve profile &amp;ldquo;versions.yml&amp;rdquo;">Unable to retrieve profile &ldquo;versions.yml&rdquo;</a><li><a href=#no-persistent-storage-type-was-configured aria-label="No persistent storage type was configured">No persistent storage type was configured</a><li><a href=#error-retirveing-contentes-of-archive-packertargz aria-label="Error retirveing contentes of archive packer.tar.gz">Error retirveing contentes of archive packer.tar.gz</a><li><a href=#no-profile-reader-exists-to-read aria-label="No profile reader exists to read">No profile reader exists to read</a><li><a href=#access-to-xmlhttprequest-at-xxx-has-been-blocked-by-cors-policy aria-label="Access to XMLHttpRequest at &amp;lsquo;xxx&amp;rsquo; has been blocked by CORS policy">Access to XMLHttpRequest at &lsquo;xxx&rsquo; has been blocked by CORS policy</a></ul><li><a href=#reference aria-label=Reference>Reference</a></li></div></details></div></aside><script src=/js/pe-toc.min.445eb1bfc5e85dd13b9519fcc2a806522e9629b6224a2974052789ba00ab78af.js integrity="sha256-RF6xv8XoXdE7lRn8wqgGUi6WKbYiSil0BSeJugCreK8="></script><div class=post-content><h2 id=prerequisites>Prerequisites<a hidden class=anchor aria-hidden=true href=#prerequisites>#</a></h2><ul><li>具有一个 Kubernetes 集群 以部署 Spinnaker</li><li>可运行 Docker 的环境 (1 vCPU, 3.75 GB) 或者是 Ubuntu，用以安装 <em>Halyard</em> (用于 spinnaker 的服务)</li><li>对象存储 (MinIO)，用于持久化 Spinnaker 的数据</li><li>对象存储的 Bucket 的访问账号</li></ul><h2 id=安装执行步骤>安装执行步骤<a hidden class=anchor aria-hidden=true href=#安装执行步骤>#</a></h2><h3 id=安装-halyard>安装 Halyard<a hidden class=anchor aria-hidden=true href=#安装-halyard>#</a></h3><p>可以直接使用 Docker 方式安装，这个没什么必要性，就是管理工具而已，参考附录1 <sup><a href=#1>[1]</a></sup></p><p>首先创建映射目录</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mkdir ~/.hal -pv
</span></span><span class=line><span class=cl>mkdir ~/.kubeconfig -pv</span></span></code></pre></td></tr></table></div></div></div></div><p>然后执行 docker run 运行容器</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker run -d -p 8084:8084 -p 9000:9000 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --name halyard --rm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -v ~/.hal:/home/spinnaker/.hal <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -v ~/.kubeconfig:/home/spinnaker/.kube <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -v /usr/local/bin:/usr/local/sbin <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -v /etc/kubernetes/auth/admin.conf:/home/spinnaker/.kube/config <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    us-docker.pkg.dev/spinnaker-community/docker/halyard:stable</span></span></code></pre></td></tr></table></div></div></div></div><p>因为 docker 环境不能重启服务，需要修改配置文件，这里可以在外部创建一个配置文件来映射进去，这里后面会说到 GCS 的问题</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ docker run -it --rm us-docker.pkg.dev/spinnaker-community/docker/halyard:stable cat /opt/halyard/config/halyard.yml &gt; /tmp/halyard.yml</span></span></code></pre></td></tr></table></div></div></div></div><p>修改 spinnaker 部分的配置，将 <code>enabled: true</code> ，改为 <code>enabled: false</code></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>yaml</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spinnaker</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>artifacts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>debian</span><span class=p>:</span><span class=w> </span><span class=l>https://us-apt.pkg.dev/projects/spinnaker-community</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>docker</span><span class=p>:</span><span class=w> </span><span class=l>us-docker.pkg.dev/spinnaker-community/docker</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>input</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>gcs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>writerEnabled</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>bucket</span><span class=p>:</span><span class=w> </span><span class=l>halconfig</span></span></span></code></pre></td></tr></table></div></div></div></div><p>然后将输出的配置文件保存到宿主机，而后映射到容器内即可</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker run -d -p 8084:8084 -p 9000:9000 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --name halyard --rm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -v ~/.hal:/home/spinnaker/.hal <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -v ~/.kubeconfig:/home/spinnaker/.kube <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -v /usr/local/bin:/usr/local/sbin <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -v /etc/kubernetes/auth/admin.conf:/home/spinnaker/.kube/config <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -v /tmp/halyard.yml:/opt/halyard/config/halyard.yml <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    us-docker.pkg.dev/spinnaker-community/docker/halyard:stable</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=安装kubectl>安装kubectl<a hidden class=anchor aria-hidden=true href=#安装kubectl>#</a></h3><blockquote><p>这部分在上一章中注明了挂载 kubectl 的路径</p></blockquote><p>使用 Docker 运行的 Halyard 可以直接挂在 kubectl 到 容器内就可以了，halyard 默认的路径在 <code>/usr/local/bin</code> 只要避免和这个路径冲突就可以了。</p><blockquote><p>halyard 中附带的 kubectl 不一定与你的集群版本一致</p></blockquote><p>最后进入容器就可以管理 spinnaker 了</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker <span class=nb>exec</span> -it halyard bash</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=生成一个-halyard-config-supa-href33asup>生成一个 Halyard config <sup><a href=#3>[3]</a></sup><a hidden class=anchor aria-hidden=true href=#生成一个-halyard-config-supa-href33asup>#</a></h3><p>离线安装时，需要生成一个 Halyard config 文件，默认在 <code>~/.hal/config</code></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>hal config version edit --version local:1.19.2</span></span></code></pre></td></tr></table></div></div></div></div><blockquote><p>Notes:</p><ul><li>如果是选择离线安装或者 Local 方式安装，那么 local 关键字必须加</li><li>如果主机没有网，此时需要指定参数 <code>--no-validate</code> 来控制关闭验证，验证通常要联网</li><li>对于执行大部分的 hal 命令都会在 <code>~/.hal/config</code> 生成配置文件</li></ul></blockquote><h3 id=选择云供应商>选择云供应商<a hidden class=anchor aria-hidden=true href=#选择云供应商>#</a></h3><p>这里可以指选择一个 Kubernetes 集群将其添加到 Halyard config 中</p><blockquote><p>注意，这里需要时 Kubectl 可以正常请求集群，即需要 kubectl 与 kubeconfig</p></blockquote><p>但在选择 Kubernetes 作为 Halyard 的 provider 之前，可以在 Kubernetes 中创建一个新的 service 以在 Halyard 中使用。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Run in Halyard container</span>
</span></span><span class=line><span class=cl><span class=nv>CONTEXT</span><span class=o>=</span><span class=k>$(</span>kubectl config current-context<span class=k>)</span>
</span></span><span class=line><span class=cl>kubectl apply --context <span class=nv>$CONTEXT</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -f https://spinnaker.io/downloads/kubernetes/service-account.yml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>TOKEN</span><span class=o>=</span><span class=k>$(</span>kubectl get secret --context <span class=nv>$CONTEXT</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>   <span class=k>$(</span>kubectl get serviceaccount spinnaker-service-account <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>       --context <span class=nv>$CONTEXT</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>       -n spinnaker <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>       -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{.secrets[0].name}&#39;</span><span class=k>)</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>   -n spinnaker <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>   -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{.data.token}&#39;</span> <span class=p>|</span> base64 --decode<span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kubectl config set-credentials <span class=si>${</span><span class=nv>CONTEXT</span><span class=si>}</span>-token-user --token <span class=nv>$TOKEN</span>
</span></span><span class=line><span class=cl>kubectl config set-context <span class=nv>$CONTEXT</span> --user <span class=si>${</span><span class=nv>CONTEXT</span><span class=si>}</span>-token-user</span></span></code></pre></td></tr></table></div></div></div></div><p>启用 kubernetes，并配置使用的 kubernetes 用户</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Run in Halyard container</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>hal config provider kubernetes <span class=nb>enable</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>ACCOUNT</span><span class=o>=</span><span class=s2>&#34;my-k8s-account&#34;</span>
</span></span><span class=line><span class=cl>hal config provider kubernetes account add <span class=si>${</span><span class=nv>ACCOUNT</span><span class=si>}</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --context <span class=si>${</span><span class=nv>CONTEXT</span><span class=si>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>Halyard 有几种部署 Spinnaker 服务的选项，例如Local, git 和 Distributed，这里使用 Distributed 模式，将 Spinnaker 以分布式方式部署到 Kubernetes内。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>hal config deploy edit --type distributed --account-name <span class=nv>$ACCOUNT</span></span></span></code></pre></td></tr></table></div></div></div></div><h3 id=配置s3存储>配置S3存储<a hidden class=anchor aria-hidden=true href=#配置s3存储>#</a></h3><p>Spinnaker 需要外部存储，例如 S3 对象存储置，为此，我使用 Minio 作为外部存储服务。这里使用 docker 进行部署，作为学习，也可以使用 minIO 官方提供的 minIO-dev <sup><a href=#4>[4]</a></sup>，可以快速在 Kubernetes 集群上部署一个单实例的 minIO</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># System</span>
</span></span><span class=line><span class=cl><span class=nv>MINIO_ROOT_USER</span><span class=o>=</span><span class=k>$(</span>&lt; /dev/urandom tr -dc a-z <span class=p>|</span> head -c<span class=si>${</span><span class=nv>1</span><span class=k>:-</span><span class=nv>4</span><span class=si>}</span><span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nv>MINIO_ROOT_PASSWORD</span><span class=o>=</span><span class=k>$(</span>&lt; /dev/urandom tr -dc _A-Z-a-z-0-9 <span class=p>|</span> head -c<span class=si>${</span><span class=nv>1</span><span class=k>:-</span><span class=nv>8</span><span class=si>}</span><span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nv>MINIO_PORT</span><span class=o>=</span><span class=s2>&#34;9010&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Start the container</span>
</span></span><span class=line><span class=cl>docker run -it -d --rm -v ~/.minio-data/:/data --name minio-4-spinnaker -p <span class=si>${</span><span class=nv>MINIO_PORT</span><span class=si>}</span>:<span class=si>${</span><span class=nv>MINIO_PORT</span><span class=si>}</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-e <span class=nv>MINIO_ROOT_USER</span><span class=o>=</span><span class=si>${</span><span class=nv>MINIO_ROOT_USER</span><span class=si>}</span> -e  <span class=nv>MINIO_ROOT_PASSWORD</span><span class=o>=</span><span class=si>${</span><span class=nv>MINIO_ROOT_PASSWORD</span><span class=si>}</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span> minio/minio  server /data --address :<span class=si>${</span><span class=nv>MINIO_PORT</span><span class=si>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># This information is used in next {.1}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;
</span></span></span><span class=line><span class=cl><span class=s2>MINIO_ROOT_USER=</span><span class=si>${</span><span class=nv>MINIO_ROOT_USER</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>MINIO_ROOT_PASSWORD=</span><span class=si>${</span><span class=nv>MINIO_ROOT_PASSWORD</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>ENDPOINT=http://</span><span class=k>$(</span>docker inspect -f <span class=s1>&#39;{{range.NetworkSettings.Networks}}{{.IPAddress}}{{end}}&#39;</span> minio-4-spinnaker<span class=k>)</span><span class=s2>:</span><span class=si>${</span><span class=nv>MINIO_PORT</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>&#34;</span></span></span></code></pre></td></tr></table></div></div></div></div><p>如果需要开启，那么需要在目录 <code>~/.hal/default/profiles/front50-local.yml</code> 创建文件</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>spinnaker:
</span></span><span class=line><span class=cl>  s3:
</span></span><span class=line><span class=cl>    versioning: false</span></span></code></pre></td></tr></table></div></div></div></div><p>然后使用以下命令进行配置到 halyard config 文件</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>ENDPOINT</span><span class=o>=</span>http://10.0.2.4:9000
</span></span><span class=line><span class=cl><span class=nv>MINIO_ACCESS_KEY</span><span class=o>=</span>minio
</span></span><span class=line><span class=cl><span class=nv>MINIO_SECRET_KEY</span><span class=o>=</span>minio123
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=nv>$MINIO_SECRET_KEY</span> <span class=p>|</span> hal config storage s3 edit --endpoint <span class=nv>$ENDPOINT</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --access-key-id <span class=nv>$MINIO_ACCESS_KEY</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --secret-access-key
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>hal config storage edit --type s3</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=生成一个bom文件>生成一个BOM文件<a hidden class=anchor aria-hidden=true href=#生成一个bom文件>#</a></h3><p>找一台有外网的主机，执行下列命令</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>hal version bom 1.19.2 -q -o yaml</span></span></code></pre></td></tr></table></div></div></div></div><blockquote><p>Note: 如果开启了 <code>gcs.enabled: true</code> 需要重新启动一个容器，因为这个步骤需要联网查询</p></blockquote><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ <span class=nv>DOCKERID</span><span class=o>=</span><span class=sb>`</span>docker run -d --rm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -v ~/.hal:/home/spinnaker/.hal <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    us-docker.pkg.dev/spinnaker-community/docker/halyard:stable<span class=sb>`</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ docker <span class=nb>exec</span> -it <span class=si>${</span><span class=nv>DOCKERID</span><span class=si>}</span> hal version bom 1.19.2 -q -o yaml <span class=o>&amp;&amp;</span> docker stop <span class=si>${</span><span class=nv>DOCKERID</span><span class=si>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>将输出的文件保存在 halyard 容器内 <code>~/.hal/.boms/bom/{version}.yml</code> ，将 <code>{version}</code> 替换为你安装的版本，例如这里为 1.19.2</p><p>其次，要在本地执行此操作的容器内，需要在 <code>halconfig</code> 目录下有对应的 BOM 清单，清单格式如下：</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ tree ~/.hal/.boms/
</span></span><span class=line><span class=cl>/root/.hal/.boms/
</span></span><span class=line><span class=cl>├── bom
</span></span><span class=line><span class=cl>│   └── 1.19.2.yml
</span></span><span class=line><span class=cl>├── clouddriver
</span></span><span class=line><span class=cl>│   └── clouddriver.yml
</span></span><span class=line><span class=cl>├── deck
</span></span><span class=line><span class=cl>│   └── settings.js
</span></span><span class=line><span class=cl>├── <span class=nb>echo</span>
</span></span><span class=line><span class=cl>│   └── echo.yml
</span></span><span class=line><span class=cl>├── fiat
</span></span><span class=line><span class=cl>│   └── fiat.yml
</span></span><span class=line><span class=cl>├── front50
</span></span><span class=line><span class=cl>│   └── front50.yml
</span></span><span class=line><span class=cl>├── gate
</span></span><span class=line><span class=cl>│   └── gate.yml
</span></span><span class=line><span class=cl>├── igor
</span></span><span class=line><span class=cl>│   └── igor.yml
</span></span><span class=line><span class=cl>├── kayenta
</span></span><span class=line><span class=cl>│   └── kayenta.yml
</span></span><span class=line><span class=cl>├── orca
</span></span><span class=line><span class=cl>│   └── orca.yml
</span></span><span class=line><span class=cl>└── rosco
</span></span><span class=line><span class=cl>    └── rosco.yml</span></span></code></pre></td></tr></table></div></div></div></div><p>这些文件夹需要自行创建，并且里面的配置文件也需要自行创建，如果不知道格式如何，可以参考 Spinnaker github 仓库上，每一个上面的文件夹都是一个项目仓库，而这些仓库的根目录都存在一个 <em><strong>halconfig</strong></em> 目录，此时需要你将对应的文件保存到对应目录下，例如，clouddriver 文件夹需要选择 <a href=https://github.com/spinnaker/clouddriver/tree/master/halconfig target=_blank rel="noopener nofollow noreferrer">github.com/spinnaker/clouddriver</a> 项目，而配置文件需要选择 <code>{service_name}.yml</code> 为命名的，例如 clouddriver 就需要选择 clouddriver.yml，这个需要自行下载。</p><p>可以使用下列脚本进行生成这些配置文件（需要上网）</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=c1>####################################################################################</span>
</span></span><span class=line><span class=cl><span class=c1>#                         Install Spinnaker scripts for CentOS                     #</span>
</span></span><span class=line><span class=cl><span class=c1>####################################################################################</span>
</span></span><span class=line><span class=cl><span class=nb>set</span> -e
</span></span><span class=line><span class=cl><span class=nv>START_TIME</span><span class=o>=</span><span class=sb>`</span>date +%s<span class=sb>`</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>PATH</span><span class=o>=</span>/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>ROOT</span><span class=o>=</span><span class=k>$(</span><span class=nb>cd</span> <span class=k>$(</span>dirname <span class=nv>$0</span><span class=k>)</span><span class=p>;</span> <span class=nb>pwd</span><span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>BASE_URL</span><span class=o>=</span><span class=s2>&#34;https://raw.githubusercontent.com/spinnaker&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>DECK_FILE_NAME</span><span class=o>=</span><span class=s2>&#34;halconfig/settings.js&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>FILE_PREFIX</span><span class=o>=</span><span class=s2>&#34;halconfig&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>usage<span class=o>(){</span>
</span></span><span class=line><span class=cl>	cat <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>Usage: $CMD &lt;bom_file&gt; &lt;output_dir&gt;
</span></span></span><span class=line><span class=cl><span class=s>    $CMD ~/.hal/.boms/bom/1.20.0.yml ~/.hal/.boms
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>function</span> install_json_tools<span class=o>(){</span>
</span></span><span class=line><span class=cl>    which jq <span class=p>&amp;</span>&gt; /dev/null <span class=o>||</span> sudo yum install jq -y
</span></span><span class=line><span class=cl>    which yq <span class=o>||</span> <span class=o>(</span> wget https://github.com/mikefarah/yq/releases/download/v4.16.2/yq_linux_amd64 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=o>&amp;&amp;</span> chmod +x yq_linux_amd64 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=o>&amp;&amp;</span> mv yq_linux_amd64 /usr/local/bin/yq <span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>function</span> remove_json_tools<span class=o>(){</span>
</span></span><span class=line><span class=cl>   rm -f a/usr/local/bin/yq
</span></span><span class=line><span class=cl>   rpm -e jq --force
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>function</span> pull_packer<span class=o>(){</span>
</span></span><span class=line><span class=cl>    <span class=c1>##check paramter##</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>[[</span> <span class=si>${#}</span> -ne <span class=m>1</span> <span class=o>]]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        <span class=nb>echo</span> -e <span class=s2>&#34;\033[32m Paramter amount error. \033[0m&#34;</span> <span class=o>&amp;&amp;</span> <span class=nb>exit</span> <span class=si>${</span><span class=nv>MALFORMEDPARAMTER</span><span class=si>}</span>
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>export</span> <span class=nv>SPIN_TMP_DIR</span><span class=o>=</span><span class=si>${</span><span class=nv>ROOT</span><span class=si>}</span>/spin_installer
</span></span><span class=line><span class=cl>    <span class=o>[</span> -d <span class=si>${</span><span class=nv>SPIN_TMP_DIR</span><span class=si>}</span> <span class=o>]</span> <span class=o>||</span> mkdir -pv <span class=si>${</span><span class=nv>SPIN_TMP_DIR</span><span class=si>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>cd</span> <span class=si>${</span><span class=nv>SPIN_TMP_DIR</span><span class=si>}</span>
</span></span><span class=line><span class=cl>    git init
</span></span><span class=line><span class=cl>    <span class=c1># 配置远程仓库地址</span>
</span></span><span class=line><span class=cl>    git remote add origin https://github.com/spinnaker/rosco
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 启用 sparse checkout</span>
</span></span><span class=line><span class=cl>    git config core.sparsecheckout <span class=nb>true</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 指定要克隆的目录</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;halconfig/packer&#34;</span> &gt;&gt; .git/info/sparse-checkout
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 拉取远程仓库的内容</span>
</span></span><span class=line><span class=cl>    git pull origin <span class=si>${</span><span class=nv>1</span><span class=si>}</span>
</span></span><span class=line><span class=cl>    tar zcf packer.tar.gz -C ./halconfig packer
</span></span><span class=line><span class=cl>    mv packer.tar.gz <span class=si>${</span><span class=nv>BOM_PATH_I</span><span class=si>}</span>/
</span></span><span class=line><span class=cl>    <span class=c1># clean work dir</span>
</span></span><span class=line><span class=cl>    <span class=nb>cd</span> <span class=si>${</span><span class=nv>ROOT</span><span class=si>}</span> <span class=o>&amp;&amp;</span> rm -fr <span class=si>${</span><span class=nv>SPIN_TMP_DIR</span><span class=si>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>function</span> gererate_bom<span class=o>(){</span>
</span></span><span class=line><span class=cl>    yq <span class=nb>eval</span> -o json <span class=si>${</span><span class=nv>BOM_FILE_NAME</span><span class=si>}</span> <span class=p>|</span>
</span></span><span class=line><span class=cl>    jq <span class=s1>&#39;.services&#39;</span> <span class=p>|</span>
</span></span><span class=line><span class=cl>    jq <span class=s1>&#39;del(.defaultArtifact ,.[&#34;monitoring-third-party&#34;], .[&#34;monitoring-daemon&#34;])&#39;</span> <span class=p>|</span>
</span></span><span class=line><span class=cl>    jq -r <span class=s1>&#39;to_entries[] | &#34;\(.key)=\(.value)&#34;&#39;</span> <span class=p>|</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=nv>IFS</span><span class=o>=</span><span class=s2>&#34;=&#34;</span> <span class=nb>read</span> -r key value<span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>        <span class=nv>VERSION</span><span class=o>=</span><span class=s2>&#34;version-`echo </span><span class=nv>$value</span><span class=s2> | jq &#39;.version&#39;|awk -F &#39;=&#39; &#39;{print </span><span class=nv>$1</span><span class=s2>}&#39; | awk -F &#39;-&#39; &#39;{print </span><span class=nv>$1</span><span class=s2>}&#39;| tr -d &#39;&#34;</span><span class=s1>&#39;`&#34;
</span></span></span><span class=line><span class=cl><span class=s1>        
</span></span></span><span class=line><span class=cl><span class=s1>        export BOM_PATH_I=${BOM_PATH}/${key}
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>        [ -d ${BOM_PATH_I} ] || mkdir -pv ${BOM_PATH_I}; chmod 777 ${BOM_PATH_I}
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>        case ${key} in
</span></span></span><span class=line><span class=cl><span class=s1>            &#34;deck&#34;)
</span></span></span><span class=line><span class=cl><span class=s1>                curl &#34;${BASE_URL}/${key}/${VERSION}/${FILE_PREFIX}/settings.js&#34; -o ${BOM_PATH_I}/settings.js
</span></span></span><span class=line><span class=cl><span class=s1>                ;;
</span></span></span><span class=line><span class=cl><span class=s1>            &#34;rosco&#34;)
</span></span></span><span class=line><span class=cl><span class=s1>                curl &#34;${BASE_URL}/${key}/${VERSION}/${FILE_PREFIX}/${key}.yml&#34; -o ${BOM_PATH_I}/${key}.yml
</span></span></span><span class=line><span class=cl><span class=s1>                curl &#34;${BASE_URL}/${key}/${VERSION}/${FILE_PREFIX}/images.yml&#34; -o ${BOM_PATH_I}/images.yml
</span></span></span><span class=line><span class=cl><span class=s1>                pull_packer ${VERSION}
</span></span></span><span class=line><span class=cl><span class=s1>                ;;
</span></span></span><span class=line><span class=cl><span class=s1>            *)
</span></span></span><span class=line><span class=cl><span class=s1>                curl &#34;${BASE_URL}/${key}/${VERSION}/${FILE_PREFIX}/${key}.yml&#34;  -o ${BOM_PATH_I}/${key}.yml
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>        esac
</span></span></span><span class=line><span class=cl><span class=s1>    done
</span></span></span><span class=line><span class=cl><span class=s1>    chmod 777 ${BOM_PATH} -R
</span></span></span><span class=line><span class=cl><span class=s1>}
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>function MAIN(){
</span></span></span><span class=line><span class=cl><span class=s1>    ##check user##
</span></span></span><span class=line><span class=cl><span class=s1>    if [[ $UID != 0 ]];then
</span></span></span><span class=line><span class=cl><span class=s1>        echo -e &#34;\033[41;05m Sorry, this script must be run as root! \033[0m&#34;
</span></span></span><span class=line><span class=cl><span class=s1>        exit ${ILLEGALUSER}
</span></span></span><span class=line><span class=cl><span class=s1>    fi
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>    ##check paramter##
</span></span></span><span class=line><span class=cl><span class=s1>    if [[ ${#} -lt 2 ]]; then
</span></span></span><span class=line><span class=cl><span class=s1>        usage &amp;&amp; exit ${MALFORMEDPARAMTER}
</span></span></span><span class=line><span class=cl><span class=s1>    fi
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>    export BOM_FILE_NAME=$1; shift
</span></span></span><span class=line><span class=cl><span class=s1>    export BOM_PATH=$1; shift
</span></span></span><span class=line><span class=cl><span class=s1>    
</span></span></span><span class=line><span class=cl><span class=s1>    ##cheking command line##
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>    install_json_tools
</span></span></span><span class=line><span class=cl><span class=s1>    
</span></span></span><span class=line><span class=cl><span class=s1>    ##processing bom##
</span></span></span><span class=line><span class=cl><span class=s1>    gererate_bom
</span></span></span><span class=line><span class=cl><span class=s1>
</span></span></span><span class=line><span class=cl><span class=s1>	END_TIME=`date +%s`
</span></span></span><span class=line><span class=cl><span class=s1>	EXECUTING_TIME=`expr $END_TIME - $START_TIME`
</span></span></span><span class=line><span class=cl><span class=s1>	echo -e &#34;\033[42;30m Time had spent $EXECUTING_TIME seconds. \033[0m&#34;
</span></span></span><span class=line><span class=cl><span class=s1>	echo -e &#34;\033[40;34m ######################################################### \033[0m&#34;
</span></span></span><span class=line><span class=cl><span class=s1>	echo -e &#39;</span><span class=se>\n</span><span class=err>&#39;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>MAIN <span class=nv>$1</span> <span class=nv>$2</span></span></span></code></pre></td></tr></table></div></div></div></div><blockquote><p>在执行脚本时需要在容器运行的宿主机进行，如果这台主机没有网络，那么可以在其他机器执行</p></blockquote><h3 id=额外下载一个-packertargz>额外下载一个 packer.tar.gz<a hidden class=anchor aria-hidden=true href=#额外下载一个-packertargz>#</a></h3><p>这里 进入文件夹 <code>rosco/master </code><code>rosco</code> 有一个文件夹叫packer，这将其移至文件夹并解压缩为 <code>packer.tar.gz</code></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mv ~/.hal/.boms/rosco/master/packer.tar.gz ~/.hal/.boms/rosco
</span></span><span class=line><span class=cl><span class=nb>cd</span> ~/.hal/.boms/rosco
</span></span><span class=line><span class=cl>tar xvf packer.tar.gz</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=为bom服务配置local关键字>为BOM服务配置local关键字<a hidden class=anchor aria-hidden=true href=#为bom服务配置local关键字>#</a></h3><p>对于离线安装，我们需要为 BOM 中的每个服务使用的镜像名称都增加一个 <code>local:</code> 前缀，这是官方的固定格式 <sup><a href=#5>[5]</a></sup></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>yaml</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>dependencies</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>consul</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=m>0.7.5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>redis</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=p>:</span><span class=m>2.8.4-2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vault</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=m>0.7.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>clouddriver</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>commit</span><span class=p>:</span><span class=w> </span><span class=l>024b9220a1322f80ed732de9f58aec2768e93d1b</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=l>local:6.4.3-20191210131345</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>...</span></span></span></code></pre></td></tr></table></div></div></div></div><h3 id=配置镜像获取源>配置镜像获取源<a hidden class=anchor aria-hidden=true href=#配置镜像获取源>#</a></h3><p>这里可以选择 直接 docker 导入镜像到每个 Kubernetes worker 节点上，也可以选择配置私有镜像仓库。</p><p>如果需要使用私有镜像，那么需要修改 <code>VERSION.yml</code> 中的dockerRegistry 选项，将其修改为你自己的镜像仓库</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>yaml</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>artifactSources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>debianRepository</span><span class=p>:</span><span class=w> </span><span class=l>https://dl.bintray.com/spinnaker-releases/debians</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#dockerRegistry: gcr.io/spinnaker-marketplace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>dockerRegistry</span><span class=p>:</span><span class=w> </span><span class=l>private-docker-registry/repository-name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gitPrefix</span><span class=p>:</span><span class=w> </span><span class=l>https://github.com/spinnaker</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>googleImageProject</span><span class=p>:</span><span class=w> </span><span class=l>marketplace-spinnaker-release</span></span></span></code></pre></td></tr></table></div></div></div></div><p>或者使用 <code>docker save</code> 通过命令导出镜像为 <code>tar.gz</code> 文件，然后导入到所有的 Kubernetes 的工作节点上</p><h3 id=部署>部署<a hidden class=anchor aria-hidden=true href=#部署>#</a></h3><p>可以直接执行 <code>hal deploy</code> 命令可以进行部署，更新，删除等操作</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>hal deploy apply <span class=c1># 部署</span>
</span></span><span class=line><span class=cl>hal deploy clean <span class=c1># 一键清理已经部署的服务</span></span></span></code></pre></td></tr></table></div></div></div></div><p>在默认部署情况下，igor 与 fiat 是不开启的，如果你配置了授权与CI的配置，那么会部署上这两个服务sss</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20230723163140283.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20230723163140283.png#center alt=image-20230723163140283 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><p>这里会生成 Kubernetes 的资源，而手动创建的资源会存在 S3 对象存储中</p><h2 id=troubleshooting>Troubleshooting<a hidden class=anchor aria-hidden=true href=#troubleshooting>#</a></h2><h3 id=could-not-load-versionsyml-from-config-bucket-xx-supa-href22asup>Could not load &ldquo;versions.yml&rdquo; from config bucket: xx <sup><a href=#2>[2]</a></sup><a hidden class=anchor aria-hidden=true href=#could-not-load-versionsyml-from-config-bucket-xx-supa-href22asup>#</a></h3><p>这是因为默认情况下从GCS读取配置文件，可以通过修改配置文件 <code>/opt/spinanker/config/halyard-local.yml</code> 关闭 gcs 功能（或 <code>/opt/halyard/config/halyard.yml </code>）</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>yaml</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>server</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8064</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spinnaker</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>artifacts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>debian</span><span class=p>:</span><span class=w> </span><span class=l>https://us-apt.pkg.dev/projects/spinnaker-community</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>docker</span><span class=p>:</span><span class=w> </span><span class=l>us-docker.pkg.dev/spinnaker-community/docker</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>input</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>gcs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>writerEnabled</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>bucket</span><span class=p>:</span><span class=w> </span><span class=l>halconfig</span></span></span></code></pre></td></tr></table></div></div></div></div><blockquote><p>Notes: 修改完成后需要重启进程，并且修改时需要使用root用户进入容器内</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>text</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>docker exec -it 4f3c037d2e3c bash
</span></span><span class=line><span class=cl>hal shutdown</span></span></code></pre></td></tr></table></div></div></div></div></blockquote><h3 id=unable-to-retrieve-profile-clouddriveryml>Unable to retrieve profile &ldquo;clouddriver.yml&rdquo;<a hidden class=anchor aria-hidden=true href=#unable-to-retrieve-profile-clouddriveryml>#</a></h3><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Validation in Global:
</span></span><span class=line><span class=cl>! ERROR Unable to retrieve profile <span class=s2>&#34;clouddriver.yml&#34;</span>: connect timed out</span></span></code></pre></td></tr></table></div></div></div></div><p>解决：BOM需要按照固定格式，创建对应每个配置文件的清单</p><h3 id=unable-to-retrieve-profile-versionsyml>Unable to retrieve profile &ldquo;versions.yml&rdquo;<a hidden class=anchor aria-hidden=true href=#unable-to-retrieve-profile-versionsyml>#</a></h3><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Validation in Global:
</span></span><span class=line><span class=cl>! ERROR Unable to retrieve profile <span class=s2>&#34;versions.yml&#34;</span>: connect timed out</span></span></code></pre></td></tr></table></div></div></div></div><p>解决：关闭 GCS 即可</p><h3 id=no-persistent-storage-type-was-configured>No persistent storage type was configured<a hidden class=anchor aria-hidden=true href=#no-persistent-storage-type-was-configured>#</a></h3><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Validation in Global:
</span></span><span class=line><span class=cl>! ERROR No persistent storage <span class=nb>type</span> was configured.</span></span></code></pre></td></tr></table></div></div></div></div><p>解决：<code>hal config storage s3 edit</code></p><h3 id=error-retirveing-contentes-of-archive-packertargz>Error retirveing contentes of archive packer.tar.gz<a hidden class=anchor aria-hidden=true href=#error-retirveing-contentes-of-archive-packertargz>#</a></h3><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Validation in Global:
</span></span><span class=line><span class=cl>! ERROR Error retirveing contentes of archive packer.tar.gz</span></span></code></pre></td></tr></table></div></div></div></div><p>解决：拷贝对应服务的 github 仓库中的 packer 文件夹</p><h3 id=no-profile-reader-exists-to-read>No profile reader exists to read<a hidden class=anchor aria-hidden=true href=#no-profile-reader-exists-to-read>#</a></h3><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>! ERROR No profile reader exists to <span class=nb>read</span> <span class=s1>&#39;6.7.1-20200319123809&#39;</span>.
</span></span><span class=line><span class=cl>  Consider setting <span class=s1>&#39;spinnaker.config.input.gcs.enabled: true&#39;</span> in
</span></span><span class=line><span class=cl>  /opt/spinnaker/config/halyard.yml</span></span></code></pre></td></tr></table></div></div></div></div><p>解决：因为 bom 文件中镜像没有设置 <code>local</code></p><h3 id=access-to-xmlhttprequest-at-xxx-has-been-blocked-by-cors-policy>Access to XMLHttpRequest at &lsquo;xxx&rsquo; has been blocked by CORS policy<a hidden class=anchor aria-hidden=true href=#access-to-xmlhttprequest-at-xxx-has-been-blocked-by-cors-policy>#</a></h3><p>如下图所示：</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20230719230037546.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20230719230037546.png#center alt=image-20230719230037546 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><p>官方给出的检查方法是“排查 gate 服务的可用性” <sup><a href=#8>[8]</a></sup>，但检查 gate 日志没有问题，service ip 请求也是通的</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>2023-07-19 15:01:05.150  INFO <span class=m>1</span> --- <span class=o>[</span>applications-10<span class=o>]</span> c.n.s.g.s.internal.ClouddriverService    : ---&gt; HTTP GET http://spin-clouddriver.spinnaker:7002/applications?restricted<span class=o>=</span>false<span class=p>&amp;</span><span class=nv>expand</span><span class=o>=</span><span class=nb>true</span>
</span></span><span class=line><span class=cl>2023-07-19 15:01:05.186  INFO <span class=m>1</span> --- <span class=o>[</span>applications-10<span class=o>]</span> c.n.s.g.s.internal.ClouddriverService    : &lt;--- HTTP <span class=m>200</span> http://spin-clouddriver.spinnaker:7002/applications?restricted<span class=o>=</span>false<span class=p>&amp;</span><span class=nv>expand</span><span class=o>=</span><span class=nb>true</span> <span class=o>(</span>31ms<span class=o>)</span>
</span></span><span class=line><span class=cl>2023-07-19 15:01:05.227  INFO <span class=m>1</span> --- <span class=o>[</span>-applications-9<span class=o>]</span> c.n.s.g.s.internal.Front50Service        : &lt;--- HTTP <span class=m>200</span> http://spin-front50.spinnaker:8080/v2/applications?restricted<span class=o>=</span><span class=nb>false</span> <span class=o>(</span>83ms<span class=o>)</span>
</span></span><span class=line><span class=cl>2023-07-19 15:01:08.343  INFO <span class=m>1</span> --- <span class=o>[</span>TaskScheduler-6<span class=o>]</span> c.n.s.gate.plugins.deck.DeckPluginCache  : Refreshing plugin cache
</span></span><span class=line><span class=cl>2023-07-19 15:01:08.343  INFO <span class=m>1</span> --- <span class=o>[</span>TaskScheduler-6<span class=o>]</span> c.n.s.gate.plugins.deck.DeckPluginCache  : Cached <span class=m>0</span> deck plugins</span></span></code></pre></td></tr></table></div></div></div></div><p>请求 service ip + port</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ curl 10.111.192.125:8084 -vv
</span></span><span class=line><span class=cl>* About to connect<span class=o>()</span> to 10.111.192.125 port <span class=m>8084</span> <span class=o>(</span><span class=c1>#0)</span>
</span></span><span class=line><span class=cl>*   Trying 10.111.192.125...
</span></span><span class=line><span class=cl>* Connected to 10.111.192.125 <span class=o>(</span>10.111.192.125<span class=o>)</span> port <span class=m>8084</span> <span class=o>(</span><span class=c1>#0)</span>
</span></span><span class=line><span class=cl>&gt; GET / HTTP/1.1
</span></span><span class=line><span class=cl>&gt; User-Agent: curl/7.29.0
</span></span><span class=line><span class=cl>&gt; Host: 10.111.192.125:8084
</span></span><span class=line><span class=cl>&gt; Accept: */*
</span></span><span class=line><span class=cl>&gt; 
</span></span><span class=line><span class=cl>&lt; HTTP/1.1 <span class=m>302</span> 
</span></span><span class=line><span class=cl>&lt; Access-Control-Allow-Credentials: <span class=nb>true</span>
</span></span><span class=line><span class=cl>&lt; Access-Control-Allow-Origin: *
</span></span><span class=line><span class=cl>&lt; Access-Control-Allow-Methods: POST, GET, OPTIONS, DELETE, PUT, PATCH
</span></span><span class=line><span class=cl>&lt; Access-Control-Max-Age: <span class=m>3600</span>
</span></span><span class=line><span class=cl>&lt; Access-Control-Allow-Headers: x-requested-with, content-type, authorization, X-RateLimit-App, X-Spinnaker-Priority
</span></span><span class=line><span class=cl>&lt; Access-Control-Expose-Headers: X-AUTH-REDIRECT-URL
</span></span><span class=line><span class=cl>&lt; X-SPINNAKER-REQUEST-ID: 6b96a924-9bcb-496c-9389-12cc6834aff7
</span></span><span class=line><span class=cl>&lt; X-Content-Type-Options: nosniff
</span></span><span class=line><span class=cl>&lt; X-XSS-Protection: 1<span class=p>;</span> <span class=nv>mode</span><span class=o>=</span>block
</span></span><span class=line><span class=cl>&lt; Cache-Control: no-cache, no-store, max-age<span class=o>=</span>0, must-revalidate
</span></span><span class=line><span class=cl>&lt; Pragma: no-cache
</span></span><span class=line><span class=cl>&lt; Expires: <span class=m>0</span>
</span></span><span class=line><span class=cl>&lt; X-Frame-Options: DENY
</span></span><span class=line><span class=cl>&lt; Location: http://spin-deck.spinnaker:9000
</span></span><span class=line><span class=cl>&lt; Content-Length: <span class=m>0</span>
</span></span><span class=line><span class=cl>&lt; Date: Wed, <span class=m>19</span> Jul <span class=m>2023</span> 15:01:28 GMT
</span></span><span class=line><span class=cl>&lt; 
</span></span><span class=line><span class=cl>* Connection <span class=c1>#0 to host 10.111.192.125 left intact</span></span></span></code></pre></td></tr></table></div></div></div></div><p>浏览器访问 gate url 也是正常的</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20230719230307938.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20230719230307938.png#center alt=image-20230719230307938 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><p>访问首页提示如下错误，但是单独访问 gate 页面没有问题</p><p>报错如下：</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>text</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Access to XMLHttpRequest at &#39;http://gate.spinnaker.fuck:30080/credentials?expand=true&#39; from origin &#39;http://deck.spinnaker.fuck:30080&#39; has been blocked by CORS policy: Response to preflight request doesn&#39;t pass access control check: The value of the &#39;Access-Control-Allow-Origin&#39; header in the response must not be the wildcard &#39;*&#39; when the request&#39;s credentials mode is &#39;include&#39;. The credentials mode of requests initiated by the XMLHttpRequest is controlled by the withCredentials attribute.Access to XMLHttpRequest at &#39;http://gate.spinnaker.fuck:30080/credentials?expand=true&#39; from origin &#39;http://deck.spinnaker.fuck:30080&#39; has been blocked by CORS policy: Response to preflight request doesn&#39;t pass access control check: The value of the &#39;Access-Control-Allow-Origin&#39; header in the response must not be the wildcard &#39;*&#39; when the request&#39;s credentials mode is &#39;include&#39;. The credentials mode of requests initiated by the XMLHttpRequest is controlled by the withCredentials attribute.</span></span></code></pre></td></tr></table></div></div></div></div><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20230723162227426.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20230723162227426.png#center alt=image-20230723162227426 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><center>图：spinnaker首页报错 - 跨源资源共享问题</center><p>解决：如果使用 Halyard 部署 Spinnaker，则可以使用以下设置创建文件 <code>~/.hal/default/profiles/gate-local.yml</code></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>yaml</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>cors</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>allowedOriginsPattern</span><span class=p>:</span><span class=w> </span>{<span class=l>you gate url}</span></span></span></code></pre></td></tr></table></div></div></div></div><h2 id=reference>Reference<a hidden class=anchor aria-hidden=true href=#reference>#</a></h2><p><sup id=1>[1]</sup> <a href=https://spinnaker.io/docs/setup/install/halyard/#install-halyard-on-docker target=_blank rel="noopener nofollow noreferrer">Install Halyard on Docker</a></p><p><sup id=2>[2]</sup> <a href=https://github.com/spinnaker/spinnaker/issues/3920 target=_blank rel="noopener nofollow noreferrer">ERROR Could not load &ldquo;versions.yml&rdquo; from config bucket: 403 #3920</a></p><p><sup id=3>[3]</sup> <a href=https://stackoverflow.com/questions/54947839/spinnaker-how-to-bring-custom-boms-into-spinnaker-pod-to-be-able-to-deploy-it-w target=_blank rel="noopener nofollow noreferrer">Spinnaker: How to bring custom boms into spinnaker pod to be able to deploy it with hal?</a></p><p><sup id=4>[4]</sup> <a href=https://min.io/docs/minio/kubernetes/upstream/index.html#procedure target=_blank rel="noopener nofollow noreferrer">MinIO Object Storage for Kubernetes</a></p><p><sup id=5>[5]</sup> <a href=https://spinnaker.io/docs/guides/operator/custom-boms/#boms-and-configuration-on-your-filesystem target=_blank rel="noopener nofollow noreferrer">BOMs and Configuration on your Filesystem</a></p><p><sup id=6>[6]</sup> <a href=https://github.com/spinnaker/spinnaker/issues/5875 target=_blank rel="noopener nofollow noreferrer">! ERROR No persistent storage type was configured. #5875</a></p><p><sup id=7>[7]</sup> <a href=https://kimmj.github.io/spinnaker/installation/install-in-air-gaped-environment/ target=_blank rel="noopener nofollow noreferrer">Install in Air Gaped Environment</a></p><p><sup id=8>[8]</sup> <a href=https://spinnaker.io/docs/setup/install/faq/#i-cant-load-the-applications-screen target=_blank rel="noopener nofollow noreferrer">I can’t load the Applications screen</a></p><p><sup id=9>[9]</sup> <a href=https://github.com/spinnaker/spinnaker/issues/4689 target=_blank rel="noopener nofollow noreferrer">use k8s cluster private, how to access? not use localhost! #4689</a></p></div><div class=pe-copyright><hr><blockquote><p>本文为原创内容，版权归作者所有。如需转载，请在文章中声明本文标题及链接。</p><p>文章标题：无互联网环境下安装Spinnaker - Offline Install Spinnaker</p><p>文章链接：<a href=https://www.oomkill.com/2023/07/offline-installtation/ target=_blank>https://www.oomkill.com/2023/07/offline-installtation/</a></p><p>许可协议：<a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></p></blockquote></div><div class=comments-separator></div><h3 class=relatedContentTitle>相关阅读</h3><ul class=relatedContent><li><a href=/2019/10/jenkins-pipline-demo/><span>jenkins pipline demo</span></a></li><li><a href=/2019/10/jenkins-recode-history/><span>jenkins历史比较</span></a></li><li><a href=/2019/10/jenkens-migrant-in-macos/><span>jenkins在Mac OS下的迁移记录</span></a></li><li><a href=/2019/10/jenkins-user-authentication/><span>jenkins的用户授权与管理</span></a></li><li><a href=/2018/11/jenkins-docker/><span>jenkins pipeline docker方式</span></a></li></ul><div class=comments-separator></div><footer class=post-footer><ul class=post-tags><li><a href=https://www.oomkill.com/tags/cicd/>Cicd</a></li></ul><nav class=paginav><a class=prev href=https://www.oomkill.com/2023/07/blackbox_exporter-in-k8s/><span class=title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left" style="user-select:text"><line x1="19" y1="12" x2="5" y2="12" style="user-select:text"/><polyline points="12 19 5 12 12 5" style="user-select:text"/></polyline></svg>&nbsp;</span>
<span>在 Kubernetes 集群中使用 blackbox exporter监控外部IP</span>
</a><a class=next href=https://www.oomkill.com/2023/07/using-thanos-improve-prometheus.md/><span class=title></span>
<span>使用Thanos强化Prometheus&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right" style="user-select:text"><line x1="5" y1="12" x2="19" y2="12" style="user-select:text"/><polyline points="12 5 19 12 12 19" style="user-select:text"/></svg></span></a></nav></footer><div class=pe-comments-decoration><p class=pe-comments-title></p><p class=pe-comments-subtitle></p></div><div id=pe-comments></div><script src=/js/pe-go-comment.min.86a214102576ba5f9b7bdc29eed8d58dd56e34aef80b3c65c73ea9cc88443696.js integrity="sha256-hqIUECV2ul+be9wp7tjVjdVuNK74Czxlxz6pzIhENpY="></script><script>const getStoredTheme=()=>localStorage.getItem("pref-theme")==="dark"?"dark":"light",setGiscusTheme=()=>{const e=e=>{const t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:e},"https://giscus.app")};e({setConfig:{theme:getStoredTheme()}})};document.addEventListener("DOMContentLoaded",()=>{const s={src:"https://giscus.app/client.js","data-repo":"cylonchau/cylonchau.github.io","data-repo-id":"R_kgDOIRlNSQ","data-category":"Announcements","data-category-id":"DIC_kwDOIRlNSc4CXy1U","data-mapping":"pathname","data-term":"posts/offline-installtation","data-strict":"0","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"top","data-theme":getStoredTheme(),"data-lang":"zh-TW","data-loading":"lazy",crossorigin:"anonymous",async:""},e=document.createElement("script");Object.entries(s).forEach(([t,n])=>e.setAttribute(t,n)),document.querySelector("#pe-comments").appendChild(e);const t=document.querySelector("#theme-toggle");t&&t.addEventListener("click",setGiscusTheme);const n=document.querySelector("#theme-toggle-float");n&&n.addEventListener("click",setGiscusTheme)})</script></article></main><footer class=footer><span>&copy; 2024 <a href=https://www.oomkill.com/>Cylon's Collection</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> on
<a href=https://pages.github.com/ rel=noopener target=_blank>GitHub Pages</a> & Theme
        <a href=https://github.com/tofuwine/PaperMod-PE rel=noopener target=_blank>PaperMod-PE</a></span></footer><div class=pe-right-sidebar><a href=javascript:void(0); id=theme-toggle-float class=pe-float-btn><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</a><a href=#top class=pe-float-btn id=top-link><span id=pe-read-progress></span></a></div><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>