<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>StackStorm自动化 - Sensor | Cylon's Collection</title>
<meta name=keywords content="stackstorm,stackstorm Sensor,Action,stackstorm传感器"><meta name=description content="什么是传感器 传感器 (Sensor) 是将外部系统和事件与 StackStorm 集成的一种方式。传感器是 Python 代码片段，它们要么定期轮询某些外部系统，要么被动等待入站事件，通常示例用于每隔一段时间去轮询某一个对象，然后他们将 Trigger 注入 StackStorm，可以通过规则进行匹配，以执行潜在的 Action。
Sensor 是用 Python 编写的，并且必须遵循 StackStorm 定义的传感器接口要求。
什么是触发器 触发器 (Trigger) 是 StackStorm 中用于识别 StackStorm 的传入事件。Trigger 是类型（字符串）和可选参数（对象）的元组。编写 Rule 是为了与 Trigger 一起使用。Sensor 通常会记录 Trigger，但这并不是严格要求的。例如，有一个向 StackStorm 注册的通用Webhooks触发器，它不需要自定义传感器。
Stackstorm内置触发器 默认情况下，StackStorm 会发出一些内部 Trigger，您可以在规则中利用它们。这些触发器可以与非系统触发器区分开来，因为它们的前缀为 “st2”。
下面包含每个资源的可用 Trigger 列表：
Action
Reference Description Properties core.st2.generic.actiontrigger 封装 Action 执行完成的触发器 execution_id, status, start_timestamp, action_name, action_ref, runner_ref, parameters, result core.st2.generic.notifytrigger 通知触发器 execution_id, status, start_timestamp, end_timestamp, action_ref, runner_ref, channel, route, message, data core."><meta name=author content="cylon"><link rel=canonical href=https://www.oomkill.com/2023/12/stackstorm-sensors/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://www.oomkill.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.oomkill.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.oomkill.com/favicon-32x32.png><link rel=apple-touch-icon href=https://www.oomkill.com/favicon.ico><link rel=mask-icon href=https://www.oomkill.com/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://www.oomkill.com/2023/12/stackstorm-sensors/><noscript><style>#theme-toggle,#top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link crossorigin=anonymous href=/assets/css/pe.min.css rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/pe.min.js></script><link rel=stylesheet href=https://cdn.staticfile.net/font-awesome/6.5.1/css/all.min.css><link rel=stylesheet href=https://cdn.staticfile.net/font-awesome/6.5.1/css/v4-shims.min.css><script id=MathJax-script async src=https://cdn.staticfile.net/mathjax/3.2.2/es5/tex-chtml.js></script><script>MathJax={tex:{displayMath:[["$$","$$"]],inlineMath:[["\\$","\\$"]]}}</script><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><meta name=referrer content="no-referrer-when-downgrade"><meta property="og:title" content="StackStorm自动化 - Sensor"><meta property="og:description" content="什么是传感器 传感器 (Sensor) 是将外部系统和事件与 StackStorm 集成的一种方式。传感器是 Python 代码片段，它们要么定期轮询某些外部系统，要么被动等待入站事件，通常示例用于每隔一段时间去轮询某一个对象，然后他们将 Trigger 注入 StackStorm，可以通过规则进行匹配，以执行潜在的 Action。
Sensor 是用 Python 编写的，并且必须遵循 StackStorm 定义的传感器接口要求。
什么是触发器 触发器 (Trigger) 是 StackStorm 中用于识别 StackStorm 的传入事件。Trigger 是类型（字符串）和可选参数（对象）的元组。编写 Rule 是为了与 Trigger 一起使用。Sensor 通常会记录 Trigger，但这并不是严格要求的。例如，有一个向 StackStorm 注册的通用Webhooks触发器，它不需要自定义传感器。
Stackstorm内置触发器 默认情况下，StackStorm 会发出一些内部 Trigger，您可以在规则中利用它们。这些触发器可以与非系统触发器区分开来，因为它们的前缀为 “st2”。
下面包含每个资源的可用 Trigger 列表：
Action
Reference Description Properties core.st2.generic.actiontrigger 封装 Action 执行完成的触发器 execution_id, status, start_timestamp, action_name, action_ref, runner_ref, parameters, result core.st2.generic.notifytrigger 通知触发器 execution_id, status, start_timestamp, end_timestamp, action_ref, runner_ref, channel, route, message, data core."><meta property="og:type" content="article"><meta property="og:url" content="https://www.oomkill.com/2023/12/stackstorm-sensors/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-12-02T00:00:00+00:00"><meta property="article:modified_time" content="2024-05-17T23:00:36+08:00"><meta property="og:site_name" content="Cylon's Collection"><meta name=twitter:card content="summary"><meta name=twitter:title content="StackStorm自动化 - Sensor"><meta name=twitter:description content="什么是传感器 传感器 (Sensor) 是将外部系统和事件与 StackStorm 集成的一种方式。传感器是 Python 代码片段，它们要么定期轮询某些外部系统，要么被动等待入站事件，通常示例用于每隔一段时间去轮询某一个对象，然后他们将 Trigger 注入 StackStorm，可以通过规则进行匹配，以执行潜在的 Action。
Sensor 是用 Python 编写的，并且必须遵循 StackStorm 定义的传感器接口要求。
什么是触发器 触发器 (Trigger) 是 StackStorm 中用于识别 StackStorm 的传入事件。Trigger 是类型（字符串）和可选参数（对象）的元组。编写 Rule 是为了与 Trigger 一起使用。Sensor 通常会记录 Trigger，但这并不是严格要求的。例如，有一个向 StackStorm 注册的通用Webhooks触发器，它不需要自定义传感器。
Stackstorm内置触发器 默认情况下，StackStorm 会发出一些内部 Trigger，您可以在规则中利用它们。这些触发器可以与非系统触发器区分开来，因为它们的前缀为 “st2”。
下面包含每个资源的可用 Trigger 列表：
Action
Reference Description Properties core.st2.generic.actiontrigger 封装 Action 执行完成的触发器 execution_id, status, start_timestamp, action_name, action_ref, runner_ref, parameters, result core.st2.generic.notifytrigger 通知触发器 execution_id, status, start_timestamp, end_timestamp, action_ref, runner_ref, channel, route, message, data core."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://www.oomkill.com/posts/"},{"@type":"ListItem","position":2,"name":"StackStorm自动化 - Sensor","item":"https://www.oomkill.com/2023/12/stackstorm-sensors/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"StackStorm自动化 - Sensor","name":"StackStorm自动化 - Sensor","description":"什么是传感器 传感器 (Sensor) 是将外部系统和事件与 StackStorm 集成的一种方式。传感器是 Python 代码片段，它们要么定期轮询某些外部系统，要么被动等待入站事件，通常示例用于每隔一段时间去轮询某一个对象，然后他们将 Trigger 注入 StackStorm，可以通过规则进行匹配，以执行潜在的 Action。\nSensor 是用 Python 编写的，并且必须遵循 StackStorm 定义的传感器接口要求。\n什么是触发器 触发器 (Trigger) 是 StackStorm 中用于识别 StackStorm 的传入事件。Trigger 是类型（字符串）和可选参数（对象）的元组。编写 Rule 是为了与 Trigger 一起使用。Sensor 通常会记录 Trigger，但这并不是严格要求的。例如，有一个向 StackStorm 注册的通用Webhooks触发器，它不需要自定义传感器。\nStackstorm内置触发器 默认情况下，StackStorm 会发出一些内部 Trigger，您可以在规则中利用它们。这些触发器可以与非系统触发器区分开来，因为它们的前缀为 “st2”。\n下面包含每个资源的可用 Trigger 列表：\nAction\nReference Description Properties core.st2.generic.actiontrigger 封装 Action 执行完成的触发器 execution_id, status, start_timestamp, action_name, action_ref, runner_ref, parameters, result core.st2.generic.notifytrigger 通知触发器 execution_id, status, start_timestamp, end_timestamp, action_ref, runner_ref, channel, route, message, data core.","keywords":["stackstorm","stackstorm Sensor","Action","stackstorm传感器"],"articleBody":"什么是传感器 传感器 (Sensor) 是将外部系统和事件与 StackStorm 集成的一种方式。传感器是 Python 代码片段，它们要么定期轮询某些外部系统，要么被动等待入站事件，通常示例用于每隔一段时间去轮询某一个对象，然后他们将 Trigger 注入 StackStorm，可以通过规则进行匹配，以执行潜在的 Action。\nSensor 是用 Python 编写的，并且必须遵循 StackStorm 定义的传感器接口要求。\n什么是触发器 触发器 (Trigger) 是 StackStorm 中用于识别 StackStorm 的传入事件。Trigger 是类型（字符串）和可选参数（对象）的元组。编写 Rule 是为了与 Trigger 一起使用。Sensor 通常会记录 Trigger，但这并不是严格要求的。例如，有一个向 StackStorm 注册的通用Webhooks触发器，它不需要自定义传感器。\nStackstorm内置触发器 默认情况下，StackStorm 会发出一些内部 Trigger，您可以在规则中利用它们。这些触发器可以与非系统触发器区分开来，因为它们的前缀为 “st2”。\n下面包含每个资源的可用 Trigger 列表：\nAction\nReference Description Properties core.st2.generic.actiontrigger 封装 Action 执行完成的触发器 execution_id, status, start_timestamp, action_name, action_ref, runner_ref, parameters, result core.st2.generic.notifytrigger 通知触发器 execution_id, status, start_timestamp, end_timestamp, action_ref, runner_ref, channel, route, message, data core.st2.action.file_written 触发封装 Action，将文件写入磁盘 ref, file_path, host_info core.st2.generic.inquiry 触发器指示一个新的查询，表示已经进入 “pending” 状态 id, route Sensor\nReference Description Properties core.st2.sensor.process_spawn 触发器去指示传感器，进程开始启动 object core.st2.sensor.process_exit 触发器指示传感器，进程已经结束 object 如何创建一个 Sensor 创建传感器涉及编写 Python 脚本和定义 Sensor 的 YAML 元数据文件。以下是一个最小化 sensor 的结构示例。\n元数据文件：\nyaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 --- class_name: \"SampleSensor\" entry_point: \"sample_sensor.py\" description: \"Sample sensor that emits triggers.\" trigger_types: - name: \"event\" description: \"An example trigger.\" payload_schema: type: \"object\" properties: executed_at: type: \"string\" format: \"date-time\" default: \"2014-07-30 05:04:24.578325\" 相关 Python 脚本的结构，在脚本中，必须遵循该结构进行编写\npython 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 # Copyright 2020 The StackStorm Authors. # Copyright 2019 Extreme Networks, Inc. # # Licensed under the Apache License, Version 2.0 (the \"License\"); # you may not use this file except in compliance with the License. # You may obtain a copy of the License at # # http://www.apache.org/licenses/LICENSE-2.0 # # Unless required by applicable law or agreed to in writing, software # distributed under the License is distributed on an \"AS IS\" BASIS, # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. # See the License for the specific language governing permissions and # limitations under the License. from st2reactor.sensor.base import Sensor class SampleSensor(Sensor): \"\"\" * self.sensor_service - provides utilities like - get_logger() - returns logger instance specific to this sensor. - dispatch() for dispatching triggers into the system. * self._config - contains parsed configuration that was specified as config.yaml in the pack. \"\"\" def setup(self): # 该方法系统仅调用一次，可以设置连接外部系统的内容到这里 pass def run(self): # 该方法是 sensor 运行的方法 # 这由系统调用一次。 #（如果您想定期睡觉并保持与外部系统交互，您将从 PollingSensor 继承。） # 例如：例如，个简单的flask应用程序。您可以在此处运行 Flask 应用程序。 # 您可以使用sensor_service 调度触发器，如下所示： # 您可以将触发器称为dict # { \"name\": ${trigger_name}, \"pack\": ${trigger_pack} } # 或者只是简单地作为字符串引用。 # i.e. dispatch(${trigger_pack}.${trigger_name}, payload) # E.g.: dispatch('examples.foo_sensor', {'k1': 'stuff', 'k2': 'foo'}) # trace_tag 是想要与dispatch的 TriggerInstance 关联的标签， # 通常，trace_tag 是唯一的并且是对外部事件的引用。 pass def cleanup(self): # 当 st2 系统宕机时调用此函数。您可以执行清理操作，例如 # 在此关闭与外部系统的连接。 pass def add_trigger(self, trigger): # 当创建触发器时调用此方法 pass def update_trigger(self, trigger): # 当触发器更新时调用此方法 pass def remove_trigger(self, trigger): # 删除触发器时调用此方法 pass 上述是一个最简单的 Sensor 示例。\n您的 Sensor 应生成 Python 字典形式的Trigger：\npython 1 2 3 4 5 trigger = 'pack.name' payload = { 'executed_at': '2014-08-01T00:00:00.000000Z' } trace_tag = external_event_id Sensor 通过使用实例化时传递到 Sensor 的 sensor_service 来注入此类 Trigger。\npython 1 self.sensor_service.dispatch(trigger=trigger, payload=payload, trace_tag=trace_tag) 如果您想要一个定期轮询外部系统的传感器，您可以使用 PollingSensor 而不是 Sensor 作为基类。\npython 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 # Copyright 2020 The StackStorm Authors. # Copyright 2019 Extreme Networks, Inc. # # Licensed under the Apache License, Version 2.0 (the \"License\"); # you may not use this file except in compliance with the License. # You may obtain a copy of the License at # # http://www.apache.org/licenses/LICENSE-2.0 # # Unless required by applicable law or agreed to in writing, software # distributed under the License is distributed on an \"AS IS\" BASIS, # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. # See the License for the specific language governing permissions and # limitations under the License. # 这里引入的是 PollingSensor，而不是Sensor from st2reactor.sensor.base import PollingSensor class SamplePollingSensor(PollingSensor): \"\"\" * self.sensor_service - provides utilities like get_logger() for writing to logs. dispatch() for dispatching triggers into the system. * self._config - contains configuration that was specified as config.yaml in the pack. * self._poll_interval - indicates the interval between two successive poll() calls. \"\"\" def setup(self): # Setup stuff goes here. For example, you might establish connections # to external system once and reuse it. This is called only once by the system. pass def poll(self): # 该方法是 sensor 运行的方法 # 这由系统在每个周期与性能一次，self._poll_interval。 # 例如：假设您想要查询 ec2 并获取有关实例的运行状况信息： some_data = aws_client.get('') payload = self._to_payload(some_data) # _to_triggers 是您编写的用于将数据格式转换为标准 python 字典的东西。 # 这应该遵循为 Trigger 注册的有效负载架构。 self.sensor_service.dispatch(trigger, payload) # 您可以将触发器称为 dict dict = { \"name\": \"${trigger_name}\", \"pack\": \"${trigger_pack}\" } # 或者简单引用一个字符串，i.e. dispatch(${trigger_pack}.${trigger_name}, payload) # 再例如 dispatch('examples.foo_sensor', {'k1': 'stuff', 'k2': 'foo'}) # trace_tag 是想要与dispatch的 TriggerInstance 关联的标签， # 通常，trace_tag 是唯一的并且是对外部事件的引用。 pass def cleanup(self): # 当 st2 系统宕机时调用此函数。您可以执行清理操作，例如 # 在此关闭与外部系统的连接。 pass def add_trigger(self, trigger): # 当创建触发器时调用此方法 pass def update_trigger(self, trigger): # 当触发器更新时调用此方法 pass def remove_trigger(self, trigger): # 删除触发器时调用此方法 pass 上述是一个 Poll Sensor 代码部分是结构的，setup 是装载时执行，poll 是在每个 interval 执行探测，这里的机制是当完成了派发后是不会第二次派发，这里做法是维护了一个列表到类中。\n例如\nyaml 1 2 3 aa2233 ACG-3612 {'ACG-3612': ","wordCount":"1926","inLanguage":"zh","datePublished":"2023-12-02T00:00:00Z","dateModified":"2024-05-17T23:00:36+08:00","author":{"@type":"Person","name":"cylon"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.oomkill.com/2023/12/stackstorm-sensors/"},"publisher":{"@type":"Organization","name":"Cylon's Collection","logo":{"@type":"ImageObject","url":"https://www.oomkill.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.oomkill.com/><img src=https://www.oomkill.com/favicon.ico alt aria-label=logo height=20>Cylon's Collection</a><div class=logo-switches><button id=theme-toggle><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://www.oomkill.com/archives><span>归档</span></a></li><li><a href=https://www.oomkill.com/tags><span>标签</span></a></li><li><a href=https://www.oomkill.com/search><span>搜索</span></a></li><li><a href=https://www.oomkill.com/about accesskey=/><span>关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">StackStorm自动化 - Sensor</h1><div class=post-meta><span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar" style="user-select:text"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" style="user-select:text"/><line x1="16" y1="2" x2="16" y2="6" style="user-select:text"/><line x1="8" y1="2" x2="8" y2="6" style="user-select:text"/><line x1="3" y1="10" x2="21" y2="10" style="user-select:text"/></svg><span>2023-12-02</span></span>&nbsp;·&nbsp;<span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text" style="user-select:text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z" style="user-select:text"/><polyline points="14 2 14 8 20 8" style="user-select:text"/><line x1="16" y1="13" x2="8" y2="13" style="user-select:text"/><line x1="16" y1="17" x2="8" y2="17" style="user-select:text"/><polyline points="10 9 9 9 8 9" style="user-select:text"/></svg><span>1926 字</span></span>&nbsp;·&nbsp;<span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><span>10 分钟</span></span>
<span class=pe-post-meta-item>&nbsp;·&nbsp;<svg t="1714036239378" fill="currentcolor" class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="6659" width="256" height="256"><path d="M690 78.2c-18.6-18.8-49-19-67.8-.4s-19 49-.4 67.8l255.4 258.6c67.8 68.6 67.8 178.8.0 247.4L653.4 878.2c-18.6 18.8-18.4 49.2.4 67.8s49.2 18.4 67.8-.4l224-226.4c104.8-106 104.8-276.4.0-382.4L690 78.2zM485.4 101.4c-24-24-56.6-37.4-90.6-37.4H96C43 64 0 107 0 160v299c0 34 13.4 66.6 37.4 90.6l336 336c50 50 131 50 181 0l267-267c50-50 50-131 0-181l-336-336zM96 160h299c8.4.0 16.6 3.4 22.6 9.4l336 336c12.4 12.4 12.4 32.8.0 45.2l-267 267c-12.4 12.4-32.8 12.4-45.2.0l-336-336c-6-6-9.4-14.2-9.4-22.6V160zm192 128a64 64 0 10-128 0 64 64 0 10128 0z" p-id="6660"/></svg></span><ul class=pe-post-meta-item><a href=https://www.oomkill.com/tags/automation/>#Automation</a></ul>&nbsp;·&nbsp;<span id=busuanzi_container_page_pv>本文阅读量 <span id=busuanzi_value_page_pv></span> 次</span></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details><summary><span class=details>目录</span></summary><div class=inner><ul><li><a href=#%e4%bb%80%e4%b9%88%e6%98%af%e4%bc%a0%e6%84%9f%e5%99%a8 aria-label=什么是传感器>什么是传感器</a><li><a href=#%e4%bb%80%e4%b9%88%e6%98%af%e8%a7%a6%e5%8f%91%e5%99%a8 aria-label=什么是触发器>什么是触发器</a><li><a href=#stackstorm%e5%86%85%e7%bd%ae%e8%a7%a6%e5%8f%91%e5%99%a8 aria-label=Stackstorm内置触发器>Stackstorm内置触发器</a><li><a href=#%e5%a6%82%e4%bd%95%e5%88%9b%e5%bb%ba%e4%b8%80%e4%b8%aa-sensor aria-label="如何创建一个 Sensor">如何创建一个 Sensor</a><li><a href=#sersor%e5%a6%82%e4%bd%95%e8%bf%90%e8%a1%8c aria-label=Sersor如何运行>Sersor如何运行</a><ul><li><a href=#sensor-service aria-label="Sensor Service">Sensor Service</a><li><a href=#common-operations aria-label="Common Operations">Common Operations</a><ul><li><a href=#dispatch aria-label=dispatch>dispatch</a><li><a href=#get_logger aria-label=get_logger>get_logger</a></ul><li><a href=#datastore-management-operations aria-label="Datastore Management Operations">Datastore Management Operations</a><ul><li><a href=#list_values aria-label=list_values>list_values</a><li><a href=#get_value aria-label=get_value>get_value</a><li><a href=#set_value aria-label=set_value>set_value</a><li><a href=#delete_value aria-label=delete_value>delete_value</a></ul></ul><li><a href=#%e5%ae%9a%e4%b9%89%e4%b8%80%e4%b8%aa-sersor aria-label="定义一个 Sersor">定义一个 Sersor</a><ul><li><a href=#%e5%85%83%e6%95%b0%e6%8d%ae%e5%ae%9a%e4%b9%89 aria-label=元数据定义>元数据定义</a><li><a href=#python-%e4%bb%a3%e7%a0%81%e9%83%a8%e5%88%86 aria-label="Python 代码部分">Python 代码部分</a></ul><li><a href=#sensor%e7%9a%84%e8%bf%90%e8%a1%8c%e4%b8%8e%e8%b0%83%e8%af%95 aria-label=Sensor的运行与调试>Sensor的运行与调试</a><ul><li><a href=#%e8%bf%90%e8%a1%8c aria-label=运行>运行</a><li><a href=#%e8%b0%83%e8%af%95 aria-label=调试>调试</a></ul><li><a href=#%e7%a4%ba%e4%be%8bjira%e6%9c%8d%e5%8a%a1%e5%8f%b0 aria-label=示例：Jira服务台>示例：Jira服务台</a><li><a href=#reference aria-label=Reference>Reference</a></li></div></details></div></aside><script src=/js/pe-toc.min.445eb1bfc5e85dd13b9519fcc2a806522e9629b6224a2974052789ba00ab78af.js integrity="sha256-RF6xv8XoXdE7lRn8wqgGUi6WKbYiSil0BSeJugCreK8="></script><div class=post-content><h2 id=什么是传感器>什么是传感器<a hidden class=anchor aria-hidden=true href=#什么是传感器>#</a></h2><p>传感器 (Sensor) 是将外部系统和事件与 StackStorm 集成的一种方式。传感器是 Python 代码片段，它们要么定期轮询某些外部系统，要么被动等待入站事件，通常示例用于每隔一段时间去轮询某一个对象，然后他们将 Trigger 注入 StackStorm，可以通过规则进行匹配，以执行潜在的 Action。</p><p>Sensor 是用 Python 编写的，并且必须遵循 StackStorm 定义的传感器接口要求。</p><h2 id=什么是触发器>什么是触发器<a hidden class=anchor aria-hidden=true href=#什么是触发器>#</a></h2><p>触发器 (Trigger) 是 StackStorm 中用于识别 StackStorm 的传入事件。Trigger 是类型（字符串）和可选参数（对象）的元组。编写 Rule 是为了与 Trigger 一起使用。Sensor 通常会记录 Trigger，但这并不是严格要求的。例如，有一个向 StackStorm 注册的通用Webhooks触发器，它不需要自定义传感器。</p><h2 id=stackstorm内置触发器>Stackstorm内置触发器<a hidden class=anchor aria-hidden=true href=#stackstorm内置触发器>#</a></h2><p>默认情况下，StackStorm 会发出一些内部 Trigger，您可以在规则中利用它们。这些触发器可以与非系统触发器区分开来，因为它们的前缀为 <em><strong>“st2”</strong></em>。</p><p>下面包含每个资源的可用 Trigger 列表：</p><p>Action</p><table><thead><tr><th>Reference</th><th>Description</th><th>Properties</th></tr></thead><tbody><tr><td>core.st2.generic.actiontrigger</td><td>封装 Action 执行完成的触发器</td><td>execution_id,<br>status, start_timestamp,<br>action_name, action_ref,<br>runner_ref,<br>parameters, result</td></tr><tr><td>core.st2.generic.notifytrigger</td><td>通知触发器</td><td>execution_id,<br>status, start_timestamp,<br>end_timestamp,<br>action_ref,<br>runner_ref,<br>channel, route,<br>message, data</td></tr><tr><td>core.st2.action.file_written</td><td>触发封装 Action，将文件写入磁盘</td><td>ref,<br>file_path,<br>host_info</td></tr><tr><td>core.st2.generic.inquiry</td><td>触发器指示一个新的查询，表示已经进入 “pending” 状态</td><td>id,<br>route</td></tr></tbody></table><p>Sensor</p><table><thead><tr><th>Reference</th><th>Description</th><th>Properties</th></tr></thead><tbody><tr><td>core.st2.sensor.process_spawn</td><td>触发器去指示传感器，进程开始启动</td><td>object</td></tr><tr><td>core.st2.sensor.process_exit</td><td>触发器指示传感器，进程已经结束</td><td>object</td></tr></tbody></table><h2 id=如何创建一个-sensor>如何创建一个 Sensor<a hidden class=anchor aria-hidden=true href=#如何创建一个-sensor>#</a></h2><p>创建传感器涉及编写 Python 脚本和定义 Sensor 的 YAML 元数据文件。以下是一个最小化 sensor 的结构示例。</p><p>元数据文件：</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>yaml</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>class_name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;SampleSensor&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>entry_point</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;sample_sensor.py&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Sample sensor that emits triggers.&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>trigger_types</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>-<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;event&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;An example trigger.&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>payload_schema</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;object&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>properties</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>executed_at</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;string&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>format</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;date-time&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>default</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2014-07-30 05:04:24.578325&#34;</span></span></span></code></pre></td></tr></table></div></div></div></div><p>相关 Python 脚本的结构，在脚本中，必须遵循该结构进行编写</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>python</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># Copyright 2020 The StackStorm Authors.</span>
</span></span><span class=line><span class=cl><span class=c1># Copyright 2019 Extreme Networks, Inc.</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># Licensed under the Apache License, Version 2.0 (the &#34;License&#34;);</span>
</span></span><span class=line><span class=cl><span class=c1># you may not use this file except in compliance with the License.</span>
</span></span><span class=line><span class=cl><span class=c1># You may obtain a copy of the License at</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1>#     http://www.apache.org/licenses/LICENSE-2.0</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># Unless required by applicable law or agreed to in writing, software</span>
</span></span><span class=line><span class=cl><span class=c1># distributed under the License is distributed on an &#34;AS IS&#34; BASIS,</span>
</span></span><span class=line><span class=cl><span class=c1># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
</span></span><span class=line><span class=cl><span class=c1># See the License for the specific language governing permissions and</span>
</span></span><span class=line><span class=cl><span class=c1># limitations under the License.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>st2reactor.sensor.base</span> <span class=kn>import</span> <span class=n>Sensor</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>SampleSensor</span><span class=p>(</span><span class=n>Sensor</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    * self.sensor_service
</span></span></span><span class=line><span class=cl><span class=s2>        - provides utilities like
</span></span></span><span class=line><span class=cl><span class=s2>            - get_logger() - returns logger instance specific to this sensor.
</span></span></span><span class=line><span class=cl><span class=s2>            - dispatch() for dispatching triggers into the system.
</span></span></span><span class=line><span class=cl><span class=s2>    * self._config
</span></span></span><span class=line><span class=cl><span class=s2>        - contains parsed configuration that was specified as
</span></span></span><span class=line><span class=cl><span class=s2>          config.yaml in the pack.
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>setup</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># 该方法系统仅调用一次，可以设置连接外部系统的内容到这里</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>run</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># 该方法是 sensor 运行的方法</span>
</span></span><span class=line><span class=cl>        <span class=c1># 这由系统调用一次。</span>
</span></span><span class=line><span class=cl>        <span class=c1>#（如果您想定期睡觉并保持与外部系统交互，您将从 PollingSensor 继承。）</span>
</span></span><span class=line><span class=cl>        <span class=c1># 例如：例如，个简单的flask应用程序。您可以在此处运行 Flask 应用程序。</span>
</span></span><span class=line><span class=cl>		<span class=c1># 您可以使用sensor_service 调度触发器，如下所示：</span>
</span></span><span class=line><span class=cl>         	<span class=c1>#  您可以将触发器称为dict</span>
</span></span><span class=line><span class=cl>            <span class=c1># { &#34;name&#34;: ${trigger_name}, &#34;pack&#34;: ${trigger_pack} }</span>
</span></span><span class=line><span class=cl>            <span class=c1># 或者只是简单地作为字符串引用。</span>
</span></span><span class=line><span class=cl>            <span class=c1># i.e. dispatch(${trigger_pack}.${trigger_name}, payload)</span>
</span></span><span class=line><span class=cl>            <span class=c1># E.g.: dispatch(&#39;examples.foo_sensor&#39;, {&#39;k1&#39;: &#39;stuff&#39;, &#39;k2&#39;: &#39;foo&#39;})</span>
</span></span><span class=line><span class=cl>            <span class=c1># trace_tag 是想要与dispatch的 TriggerInstance 关联的标签，</span>
</span></span><span class=line><span class=cl>            <span class=c1># 通常，trace_tag 是唯一的并且是对外部事件的引用。</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>cleanup</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># 当 st2 系统宕机时调用此函数。您可以执行清理操作，例如</span>
</span></span><span class=line><span class=cl>        <span class=c1># 在此关闭与外部系统的连接。</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>add_trigger</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>trigger</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># 当创建触发器时调用此方法</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>update_trigger</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>trigger</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># 当触发器更新时调用此方法</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>remove_trigger</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>trigger</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># 删除触发器时调用此方法</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span></span></span></code></pre></td></tr></table></div></div></div></div><p>上述是一个最简单的 Sensor 示例。</p><p>您的 Sensor 应生成 Python 字典形式的Trigger：</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>python</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>trigger</span> <span class=o>=</span> <span class=s1>&#39;pack.name&#39;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;executed_at&#39;</span><span class=p>:</span> <span class=s1>&#39;2014-08-01T00:00:00.000000Z&#39;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=n>trace_tag</span> <span class=o>=</span> <span class=n>external_event_id</span></span></span></code></pre></td></tr></table></div></div></div></div><p>Sensor 通过使用实例化时传递到 Sensor 的 sensor_service 来注入此类 Trigger。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>python</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=bp>self</span><span class=o>.</span><span class=n>sensor_service</span><span class=o>.</span><span class=n>dispatch</span><span class=p>(</span><span class=n>trigger</span><span class=o>=</span><span class=n>trigger</span><span class=p>,</span> <span class=n>payload</span><span class=o>=</span><span class=n>payload</span><span class=p>,</span> <span class=n>trace_tag</span><span class=o>=</span><span class=n>trace_tag</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div></div></div><p>如果您想要一个定期轮询外部系统的传感器，您可以使用 PollingSensor 而不是 Sensor 作为基类。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>python</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># Copyright 2020 The StackStorm Authors.</span>
</span></span><span class=line><span class=cl><span class=c1># Copyright 2019 Extreme Networks, Inc.</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># Licensed under the Apache License, Version 2.0 (the &#34;License&#34;);</span>
</span></span><span class=line><span class=cl><span class=c1># you may not use this file except in compliance with the License.</span>
</span></span><span class=line><span class=cl><span class=c1># You may obtain a copy of the License at</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1>#     http://www.apache.org/licenses/LICENSE-2.0</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># Unless required by applicable law or agreed to in writing, software</span>
</span></span><span class=line><span class=cl><span class=c1># distributed under the License is distributed on an &#34;AS IS&#34; BASIS,</span>
</span></span><span class=line><span class=cl><span class=c1># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
</span></span><span class=line><span class=cl><span class=c1># See the License for the specific language governing permissions and</span>
</span></span><span class=line><span class=cl><span class=c1># limitations under the License.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 这里引入的是 PollingSensor，而不是Sensor</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>st2reactor.sensor.base</span> <span class=kn>import</span> <span class=n>PollingSensor</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>SamplePollingSensor</span><span class=p>(</span><span class=n>PollingSensor</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    * self.sensor_service
</span></span></span><span class=line><span class=cl><span class=s2>        - provides utilities like
</span></span></span><span class=line><span class=cl><span class=s2>            get_logger() for writing to logs.
</span></span></span><span class=line><span class=cl><span class=s2>            dispatch() for dispatching triggers into the system.
</span></span></span><span class=line><span class=cl><span class=s2>    * self._config
</span></span></span><span class=line><span class=cl><span class=s2>        - contains configuration that was specified as
</span></span></span><span class=line><span class=cl><span class=s2>          config.yaml in the pack.
</span></span></span><span class=line><span class=cl><span class=s2>    * self._poll_interval
</span></span></span><span class=line><span class=cl><span class=s2>        - indicates the interval between two successive poll() calls.
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>setup</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># Setup stuff goes here. For example, you might establish connections</span>
</span></span><span class=line><span class=cl>        <span class=c1># to external system once and reuse it. This is called only once by the system.</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>poll</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># 该方法是 sensor 运行的方法</span>
</span></span><span class=line><span class=cl>        <span class=c1># 这由系统在每个周期与性能一次，self._poll_interval。</span>
</span></span><span class=line><span class=cl>		<span class=c1># 例如：假设您想要查询 ec2 并获取有关实例的运行状况信息：</span>
</span></span><span class=line><span class=cl>        <span class=n>some_data</span> <span class=o>=</span> <span class=n>aws_client</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>payload</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_to_payload</span><span class=p>(</span><span class=n>some_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        	<span class=c1># _to_triggers 是您编写的用于将数据格式转换为标准 python 字典的东西。</span>
</span></span><span class=line><span class=cl>            <span class=c1># 这应该遵循为 Trigger 注册的有效负载架构。</span>
</span></span><span class=line><span class=cl>       		<span class=bp>self</span><span class=o>.</span><span class=n>sensor_service</span><span class=o>.</span><span class=n>dispatch</span><span class=p>(</span><span class=n>trigger</span><span class=p>,</span> <span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>       		<span class=c1># 您可以将触发器称为 dict</span>
</span></span><span class=line><span class=cl>        	<span class=nb>dict</span> <span class=o>=</span> <span class=p>{</span> <span class=s2>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;$</span><span class=si>{trigger_name}</span><span class=s2>&#34;</span><span class=p>,</span> <span class=s2>&#34;pack&#34;</span><span class=p>:</span> <span class=s2>&#34;$</span><span class=si>{trigger_pack}</span><span class=s2>&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>           	<span class=c1># 或者简单引用一个字符串，i.e. </span>
</span></span><span class=line><span class=cl>           	<span class=n>dispatch</span><span class=p>(</span><span class=err>$</span><span class=p>{</span><span class=n>trigger_pack</span><span class=p>}</span><span class=o>.</span><span class=err>$</span><span class=p>{</span><span class=n>trigger_name</span><span class=p>},</span> <span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=c1># 再例如</span>
</span></span><span class=line><span class=cl>            <span class=n>dispatch</span><span class=p>(</span><span class=s1>&#39;examples.foo_sensor&#39;</span><span class=p>,</span> <span class=p>{</span><span class=s1>&#39;k1&#39;</span><span class=p>:</span> <span class=s1>&#39;stuff&#39;</span><span class=p>,</span> <span class=s1>&#39;k2&#39;</span><span class=p>:</span> <span class=s1>&#39;foo&#39;</span><span class=p>})</span>
</span></span><span class=line><span class=cl>            <span class=c1># trace_tag 是想要与dispatch的 TriggerInstance 关联的标签，</span>
</span></span><span class=line><span class=cl>            <span class=c1># 通常，trace_tag 是唯一的并且是对外部事件的引用。</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>cleanup</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># 当 st2 系统宕机时调用此函数。您可以执行清理操作，例如</span>
</span></span><span class=line><span class=cl>        <span class=c1># 在此关闭与外部系统的连接。</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>add_trigger</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>trigger</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># 当创建触发器时调用此方法</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>update_trigger</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>trigger</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># 当触发器更新时调用此方法</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>remove_trigger</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>trigger</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># 删除触发器时调用此方法</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span></span></span></code></pre></td></tr></table></div></div></div></div><p>上述是一个 Poll Sensor 代码部分是结构的，setup 是装载时执行，poll 是在每个 interval 执行探测，这里的机制是当完成了派发后是不会第二次派发，这里做法是维护了一个列表到类中。</p><p>例如</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>yaml</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>aa2233</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>ACG-3612</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>{<span class=nt>&#39;ACG-3612&#39;: &lt;JIRA Issue</span><span class=p>:</span><span class=w> </span><span class=l>key=&#39;ACG-3612&#39;, id=&#39;212268&#39;&gt;}</span></span></span></code></pre></td></tr></table></div></div></div></div><blockquote><p>注：轮询传感器 (Polling Sensors) 还需要元数据文件中的 <em>poll_interval</em> 参数。这定义了调用 <code>poll()</code> 方法的频率（以秒为单位）。</p></blockquote><h2 id=sersor如何运行>Sersor如何运行<a hidden class=anchor aria-hidden=true href=#sersor如何运行>#</a></h2><p>每个传感器作为单独的进程运行。 <strong><code>st2sensorcontainer</code></strong> 启动 <strong><code>sensor_wrapper.py</code></strong> ，它将您的 <strong><code>Sensor</code></strong> 类（例如上面的SampleSensor 或 SamplePollingSenso r）包装在 <strong><code>st2reactor.container.sensor_wrapper.SensorWrapper</code></strong> 中。</p><h3 id=sensor-service>Sensor Service<a hidden class=anchor aria-hidden=true href=#sensor-service>#</a></h3><p>正如您在上面的示例中看到的，<strong>sensor_service</strong> 在实例化时被传递给每个传感器类构造函数。</p><p>传感器服务 (Sensor Service) 通过公共方法向 Sensor 提供不同的服务。最重要的一种 <code>dispatch</code> 方法是允许 Sensor 将 Trigger 注入系统的方法。所有公共方法描述如下：</p><ul><li>常用操作，Common Operations</li><li>数据存储管理操作 Datastore Management Operations</li></ul><h3 id=common-operations>Common Operations<a hidden class=anchor aria-hidden=true href=#common-operations>#</a></h3><h4 id=dispatch>dispatch<a hidden class=anchor aria-hidden=true href=#dispatch>#</a></h4><p>调度：此方法允许传感器将触发器注入系统</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>python</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>dispatch</span><span class=p>(</span><span class=n>trigger</span><span class=p>,</span> <span class=n>payload</span><span class=p>,</span> <span class=n>trace_tag</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div></div></div><p>例如：</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>python</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>trigger</span> <span class=o>=</span> <span class=s1>&#39;pack.name&#39;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;executed_at&#39;</span><span class=p>:</span> <span class=s1>&#39;2014-08-01T00:00:00.000000Z&#39;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=n>trace_tag</span> <span class=o>=</span> <span class=n>uuid</span><span class=o>.</span><span class=n>uuid4</span><span class=p>()</span><span class=o>.</span><span class=n>hex</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=bp>self</span><span class=o>.</span><span class=n>sensor_service</span><span class=o>.</span><span class=n>dispatch</span><span class=p>(</span><span class=n>trigger</span><span class=o>=</span><span class=n>trigger</span><span class=p>,</span> <span class=n>payload</span><span class=o>=</span><span class=n>payload</span><span class=p>,</span> <span class=n>trace_tag</span><span class=o>=</span><span class=n>trace_tag</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div></div></div><h4 id=get_logger>get_logger<a hidden class=anchor aria-hidden=true href=#get_logger>#</a></h4><p>此方法允许 Sensor 实例检索特定于该传感器的记录器实例。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>yaml</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>get_logger(name)</span></span></span></code></pre></td></tr></table></div></div></div></div><p>例如：</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>python</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=bp>self</span><span class=o>.</span><span class=n>_logger</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>sensor_service</span><span class=o>.</span><span class=n>get_logger</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=vm>__class__</span><span class=o>.</span><span class=vm>__name__</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=bp>self</span><span class=o>.</span><span class=n>_logger</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span><span class=s1>&#39;Polling 3rd party system for information&#39;</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div></div></div><h3 id=datastore-management-operations>Datastore Management Operations<a hidden class=anchor aria-hidden=true href=#datastore-management-operations>#</a></h3><p>除了触发器注入之外，传感器服务还提供读取和操作数据存储的功能。</p><p>每个传感器都有一个本地命名空间，默认情况下，所有数据存储操作都对该 Sensor “本地命名空间” 中的键进行操作。如果要对“全局命名空间”进行操作，则需要将参数传递 <em><strong><code>local=False </code></strong></em>给数据存储操作方法。</p><p>除其他原因外，如果想在传感器运行之间保留临时数据，此功能非常有用。</p><p>TwitterSensor 就是此功能的一个很好的例子。 Twitter 传感器在每次轮询后都会在数据存储中保留最后处理的推文的 ID。这样，如果 Trigger 重新启动或崩溃，传感器可以从中断处恢复，而无需向系统注入重复的 Trigger。</p><h4 id=list_values>list_values<a hidden class=anchor aria-hidden=true href=#list_values>#</a></h4><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>python</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>list_values</span><span class=p>(</span><span class=n>local</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>prefix</span><span class=o>=</span><span class=kc>None</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div></div></div><p>该方法允许列出数据存储中的值。您还可以通过将 <code>prefix</code> 参数传递给方法来按键名称前缀（键名称开头）进行过滤：</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>python</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>kvps</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>sensor_service</span><span class=o>.</span><span class=n>list_values</span><span class=p>(</span><span class=n>local</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>prefix</span><span class=o>=</span><span class=s1>&#39;cmdb.&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>kvp</span> <span class=ow>in</span> <span class=n>kvps</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>kvp</span><span class=o>.</span><span class=n>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>kvp</span><span class=o>.</span><span class=n>value</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div></div></div><h4 id=get_value>get_value<a hidden class=anchor aria-hidden=true href=#get_value>#</a></h4><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>python</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>get_value</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>local</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>decrypt</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div></div></div><p>此方法允许您从数据存储中检索单个值：</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>python</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>kvp</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>sensor_service</span><span class=o>.</span><span class=n>get_value</span><span class=p>(</span><span class=s1>&#39;cmdb.api_host&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>kvp</span><span class=o>.</span><span class=n>name</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div></div></div><h4 id=set_value>set_value<a hidden class=anchor aria-hidden=true href=#set_value>#</a></h4><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>python</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>set_value</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>value</span><span class=p>,</span> <span class=n>ttl</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>local</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>encrypt</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div></div></div><p>该方法允许在数据存储中存储设置一个值。您还可以选择指定存储值的生存时间 (TTL)：</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>python</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>last_id</span> <span class=o>=</span> <span class=mi>12345</span>
</span></span><span class=line><span class=cl><span class=bp>self</span><span class=o>.</span><span class=n>sensor_service</span><span class=o>.</span><span class=n>set_value</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s1>&#39;last_id&#39;</span><span class=p>,</span> <span class=n>value</span><span class=o>=</span><span class=nb>str</span><span class=p>(</span><span class=n>last_id</span><span class=p>))</span></span></span></code></pre></td></tr></table></div></div></div></div><p>Secret 值可以在存储中中加密：</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>python</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>ma_password</span> <span class=o>=</span> <span class=s1>&#39;Sup3rS34et&#39;</span>
</span></span><span class=line><span class=cl><span class=bp>self</span><span class=o>.</span><span class=n>sensor_service</span><span class=o>.</span><span class=n>set_value</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s1>&#39;ma_password&#39;</span><span class=p>,</span> <span class=n>value</span><span class=o>=</span><span class=n>ma_password</span><span class=p>,</span> <span class=n>encrypt</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div></div></div><h4 id=delete_value>delete_value<a hidden class=anchor aria-hidden=true href=#delete_value>#</a></h4><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>python</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>delete_value</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>local</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div></div></div><p>该方法允许从存储中删除现有值。如果未找到值，此方法将返回 False，否则返回 True。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>python</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=bp>self</span><span class=o>.</span><span class=n>sensor_service</span><span class=o>.</span><span class=n>delete_value</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s1>&#39;my_key&#39;</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div></div></div><h2 id=定义一个-sersor>定义一个 Sersor<a hidden class=anchor aria-hidden=true href=#定义一个-sersor>#</a></h2><p>例如我们需要制作一个简单 Sensor 的工作示例，每 60 秒注入一次触发器。</p><p>需要注意的部分：</p><ul><li><p>Sensor 的 Python 的类必需继承 Sensor 或 PollingSensor类，这个由需求而定，必须实现 setup, poll, dispatch等方法</p><ul><li>如有需求，例如变量声明，也可以重写 _<em>init</em>_ 类</li><li>setup方法，用于初始化示例需要的数据或状态，例如连接三方系统的配置信息，该方法只执行一次</li><li>Sensor runtime 會把实例化并保持运行，按 poll_interval 設置周期去运行 poll 方法</li></ul></li><li><p>Poll方法是真实执行任务的部分，可在 poll 方法中更新示例持有的数据或状态，判断数据是否匹配，</p></li><li><p>然后运行 disptach； 按需派发数据，dispatch方法会派发数据，把数据派发给 _trigger_ref</p><ul><li>_trigger_ref 是 Sensor 设置的 trigger type，也就是 RabbitMQ 的 Queue 名称</li></ul></li></ul><h3 id=元数据定义>元数据定义<a hidden class=anchor aria-hidden=true href=#元数据定义>#</a></h3><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>yaml</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>class_name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;HelloSensor&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>entry_point</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;sensor1.py&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Test sensor that emits triggers.&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>trigger_types</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>-<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;event1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;An example trigger.&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>payload_schema</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;object&#34;</span></span></span></code></pre></td></tr></table></div></div></div></div><h3 id=python-代码部分>Python 代码部分<a hidden class=anchor aria-hidden=true href=#python-代码部分>#</a></h3><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>python</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># Copyright 2020 The StackStorm Authors.</span>
</span></span><span class=line><span class=cl><span class=c1># Copyright 2019 Extreme Networks, Inc.</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># Licensed under the Apache License, Version 2.0 (the &#34;License&#34;);</span>
</span></span><span class=line><span class=cl><span class=c1># you may not use this file except in compliance with the License.</span>
</span></span><span class=line><span class=cl><span class=c1># You may obtain a copy of the License at</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1>#     http://www.apache.org/licenses/LICENSE-2.0</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># Unless required by applicable law or agreed to in writing, software</span>
</span></span><span class=line><span class=cl><span class=c1># distributed under the License is distributed on an &#34;AS IS&#34; BASIS,</span>
</span></span><span class=line><span class=cl><span class=c1># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
</span></span><span class=line><span class=cl><span class=c1># See the License for the specific language governing permissions and</span>
</span></span><span class=line><span class=cl><span class=c1># limitations under the License.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>eventlet</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>st2reactor.sensor.base</span> <span class=kn>import</span> <span class=n>Sensor</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>HelloSensor</span><span class=p>(</span><span class=n>Sensor</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>sensor_service</span><span class=p>,</span> <span class=n>config</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>(</span><span class=n>HelloSensor</span><span class=p>,</span> <span class=bp>self</span><span class=p>)</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=n>sensor_service</span><span class=o>=</span><span class=n>sensor_service</span><span class=p>,</span> <span class=n>config</span><span class=o>=</span><span class=n>config</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_logger</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>sensor_service</span><span class=o>.</span><span class=n>get_logger</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=vm>__class__</span><span class=o>.</span><span class=vm>__name__</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_stop</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>setup</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>run</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>_stop</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>_logger</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span><span class=s2>&#34;HelloSensor dispatching trigger...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>count</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>sensor_service</span><span class=o>.</span><span class=n>get_value</span><span class=p>(</span><span class=s2>&#34;hello_st2.count&#34;</span><span class=p>)</span> <span class=ow>or</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>            <span class=n>payload</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;greeting&#34;</span><span class=p>:</span> <span class=s2>&#34;Yo, StackStorm!&#34;</span><span class=p>,</span> <span class=s2>&#34;count&#34;</span><span class=p>:</span> <span class=nb>int</span><span class=p>(</span><span class=n>count</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>sensor_service</span><span class=o>.</span><span class=n>dispatch</span><span class=p>(</span><span class=n>trigger</span><span class=o>=</span><span class=s2>&#34;hello_st2.event1&#34;</span><span class=p>,</span> <span class=n>payload</span><span class=o>=</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>sensor_service</span><span class=o>.</span><span class=n>set_value</span><span class=p>(</span><span class=s2>&#34;hello_st2.count&#34;</span><span class=p>,</span> <span class=n>payload</span><span class=p>[</span><span class=s2>&#34;count&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=n>eventlet</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>60</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>cleanup</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_stop</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Methods required for programmable sensors.</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>add_trigger</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>trigger</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>update_trigger</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>trigger</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>remove_trigger</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>trigger</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span></span></span></code></pre></td></tr></table></div></div></div></div><h2 id=sensor的运行与调试>Sensor的运行与调试<a hidden class=anchor aria-hidden=true href=#sensor的运行与调试>#</a></h2><h3 id=运行>运行<a hidden class=anchor aria-hidden=true href=#运行>#</a></h3><p>一旦完成传感器的编写，可以使用以下步骤来首次运行传感器：</p><ol><li>将传感器 Python 文件和 元数据文件 放入 <em>default</em> 包中的 <em>/opt/stackstorm/packs/default/sensors/</em> ；或者您也可以根据包结构，创建出自定义包并将传感器元件放置在那里 ( <em>/opt/stackstorm/packs/</em> )</li><li>使用 <code>st2ctl</code> 注册传感器 。注意传感器注册中的任何错误，一旦注册时出现错误，请修复错误并使用 重新注册 。</li></ol><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>st2ctl reload --register-all</span></span></code></pre></td></tr></table></div></div></div></div><ol start=3><li>如果注册成功，传感器将自动运行。</li></ol><h3 id=调试>调试<a hidden class=anchor aria-hidden=true href=#调试>#</a></h3><p>在编写时，很多时候需要调试 Sensor 的运行，而由于环境问题，我们无法做到正常Python程序的调试步骤，必须遵循 Stackstorm 的调试方式。</p><p>如果只想运行包中的单个传感器并且该传感器已注册，则可以使用 <code>st2sensorcontainer</code> 来仅运行该单个传感器：</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo /opt/stackstorm/st2/bin/st2sensorcontainer --config-file<span class=o>=</span>/etc/st2/st2.conf --sensor-ref<span class=o>=</span>pack.SensorClassName</span></span></code></pre></td></tr></table></div></div></div></div><p>例如：</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo /opt/stackstorm/st2/bin/st2sensorcontainer --config-file<span class=o>=</span>/etc/st2/st2.conf --sensor-ref<span class=o>=</span>git.GitCommitSensor</span></span></code></pre></td></tr></table></div></div></div></div><h2 id=示例jira服务台>示例：Jira服务台<a hidden class=anchor aria-hidden=true href=#示例jira服务台>#</a></h2><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>python</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># See ./requirements.txt for requirements.</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>urllib3</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>jira.client</span> <span class=kn>import</span> <span class=n>JIRA</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>st2reactor.sensor.base</span> <span class=kn>import</span> <span class=n>PollingSensor</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>XinMangSensorForPodMapTicket</span><span class=p>(</span><span class=n>PollingSensor</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;&#39;&#39;
</span></span></span><span class=line><span class=cl><span class=s1>    Sensor will monitor for any new projects created in JIRA and
</span></span></span><span class=line><span class=cl><span class=s1>    emit trigger instance when one is created.
</span></span></span><span class=line><span class=cl><span class=s1>    &#39;&#39;&#39;</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>sensor_service</span><span class=p>,</span> <span class=n>config</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>poll_interval</span><span class=o>=</span><span class=mi>5</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>(</span><span class=n>XinMangSensorForPodMapTicket</span><span class=p>,</span> <span class=bp>self</span><span class=p>)</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=n>sensor_service</span><span class=o>=</span><span class=n>sensor_service</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                                 <span class=n>config</span><span class=o>=</span><span class=n>config</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                                 <span class=n>poll_interval</span><span class=o>=</span><span class=n>poll_interval</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_jira_url</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_config</span>  <span class=o>=</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>                <span class=s2>&#34;url&#34;</span><span class=p>:</span> <span class=s2>&#34;https://jira.ticket.com&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;auth_method&#34;</span><span class=p>:</span> <span class=s2>&#34;basic&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;username&#34;</span><span class=p>:</span> <span class=s2>&#34;jira_automation&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;password&#34;</span><span class=p>:</span> <span class=s2>&#34;jira123&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;poll_interval&#34;</span><span class=p>:</span> <span class=mi>30</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;verify&#34;</span><span class=p>:</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=c1># The Consumer Key created while setting up the &#34;Incoming Authentication&#34; in</span>
</span></span><span class=line><span class=cl>        <span class=c1># JIRA for the Application Link.</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_consumer_key</span> <span class=o>=</span> <span class=sa>u</span><span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_rsa_key</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_jira_client</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_access_token</span> <span class=o>=</span> <span class=sa>u</span><span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_access_secret</span> <span class=o>=</span> <span class=sa>u</span><span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_projects_available</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;SABP&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_poll_interval</span> <span class=o>=</span> <span class=mi>30</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_project</span> <span class=o>=</span> <span class=s2>&#34;SABP&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_issues_in_project</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_customer_request_type</span> <span class=o>=</span> <span class=s2>&#34;创建Pod映射&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_issue_status</span> <span class=o>=</span> <span class=s2>&#34;IN PROGRESS&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_jql_query</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_trigger_name</span> <span class=o>=</span> <span class=s1>&#39;issues_tracker_for_pod_map_ticket&#39;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_trigger_pack</span> <span class=o>=</span> <span class=s1>&#39;jira&#39;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_trigger_ref</span> <span class=o>=</span> <span class=s1>&#39;.&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span><span class=bp>self</span><span class=o>.</span><span class=n>_trigger_pack</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>_trigger_name</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=n>urllib3</span><span class=o>.</span><span class=n>disable_warnings</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_read_cert</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>file_path</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>file_path</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>setup</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_jira_url</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_config</span><span class=p>[</span><span class=s1>&#39;url&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>auth_method</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_config</span><span class=p>[</span><span class=s1>&#39;auth_method&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>auth_method</span> <span class=o>==</span> <span class=s1>&#39;oauth&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>rsa_cert_file</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_config</span><span class=p>[</span><span class=s1>&#39;rsa_cert_file&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>exists</span><span class=p>(</span><span class=n>rsa_cert_file</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=s1>&#39;Cert file for JIRA OAuth not found at </span><span class=si>%s</span><span class=s1>.&#39;</span> <span class=o>%</span> <span class=n>rsa_cert_file</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>_rsa_key</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_read_cert</span><span class=p>(</span><span class=n>rsa_cert_file</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>_poll_interval</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;poll_interval&#39;</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>_poll_interval</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>oauth_creds</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;access_token&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>_config</span><span class=p>[</span><span class=s1>&#39;oauth_token&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;access_token_secret&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>_config</span><span class=p>[</span><span class=s1>&#39;oauth_secret&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;consumer_key&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>_config</span><span class=p>[</span><span class=s1>&#39;consumer_key&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;key_cert&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>_rsa_key</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>_jira_client</span> <span class=o>=</span> <span class=n>JIRA</span><span class=p>(</span><span class=n>options</span><span class=o>=</span><span class=p>{</span><span class=s1>&#39;server&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>_jira_url</span><span class=p>},</span>
</span></span><span class=line><span class=cl>                                     <span class=n>oauth</span><span class=o>=</span><span class=n>oauth_creds</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>auth_method</span> <span class=o>==</span> <span class=s1>&#39;basic&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>basic_creds</span> <span class=o>=</span> <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_config</span><span class=p>[</span><span class=s1>&#39;username&#39;</span><span class=p>],</span> <span class=bp>self</span><span class=o>.</span><span class=n>_config</span><span class=p>[</span><span class=s1>&#39;password&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>_jira_client</span> <span class=o>=</span> <span class=n>JIRA</span><span class=p>(</span><span class=n>options</span><span class=o>=</span><span class=p>{</span><span class=s1>&#39;server&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>_jira_url</span><span class=p>,</span> <span class=s1>&#39;verify&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>_config</span><span class=p>[</span><span class=s1>&#39;verify&#39;</span><span class=p>]},</span><span class=n>basic_auth</span><span class=o>=</span><span class=n>basic_creds</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=c1>#self._jira_client = JIRA(options={&#39;server&#39;: self._jira_url},basic_auth=basic_creds)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>msg</span> <span class=o>=</span> <span class=p>(</span><span class=s1>&#39;You must set auth_method to either &#34;oauth&#34;&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                   <span class=s1>&#39;or &#34;basic&#34; your jira.yaml config file.&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=n>msg</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_jql_query</span> <span class=o>=</span> <span class=s1>&#39;project=&#34;</span><span class=si>%s</span><span class=s1>&#34; and &#34;Customer Request Type&#34;=&#34;</span><span class=si>%s</span><span class=s1>&#34; and status=&#34;</span><span class=si>%s</span><span class=s1>&#34;&#39;</span> <span class=o>%</span> <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_project</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>_customer_request_type</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>_issue_status</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>all_issues</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_jira_client</span><span class=o>.</span><span class=n>search_issues</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_jql_query</span><span class=p>,</span> <span class=n>maxResults</span><span class=o>=</span><span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_issues_in_project</span> <span class=o>=</span> <span class=p>{</span><span class=n>issue</span><span class=o>.</span><span class=n>key</span><span class=p>:</span> <span class=n>issue</span> <span class=k>for</span> <span class=n>issue</span> <span class=ow>in</span> <span class=n>all_issues</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>poll</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_detect_new_issues</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>cleanup</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>add_trigger</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>trigger</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>update_trigger</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>trigger</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>remove_trigger</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>trigger</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_detect_new_issues</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>new_issues</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_jira_client</span><span class=o>.</span><span class=n>search_issues</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_jql_query</span><span class=p>,</span> <span class=n>maxResults</span><span class=o>=</span><span class=mi>50</span><span class=p>,</span> <span class=n>startAt</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>issue</span> <span class=ow>in</span> <span class=n>new_issues</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># issue 满足需求的工单</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_issues_in_project</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=c1># 将服务台任务单保留到这个列表中，保证不会重复派发</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>issue</span><span class=o>.</span><span class=n>key</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_issues_in_project</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># 记录下未派发的任务，并派发</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>_dispatch_issues_trigger</span><span class=p>(</span><span class=n>issue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>_issues_in_project</span><span class=p>[</span><span class=n>issue</span><span class=o>.</span><span class=n>key</span><span class=p>]</span> <span class=o>=</span> <span class=n>issue</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_dispatch_issues_trigger</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>issue</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>trigger</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_trigger_ref</span>
</span></span><span class=line><span class=cl>        <span class=n>payload</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=n>payload</span><span class=p>[</span><span class=s1>&#39;project&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_project</span>
</span></span><span class=line><span class=cl>        <span class=n>payload</span><span class=p>[</span><span class=s1>&#39;id&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>issue</span><span class=o>.</span><span class=n>id</span>
</span></span><span class=line><span class=cl>        <span class=n>payload</span><span class=p>[</span><span class=s1>&#39;expand&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>issue</span><span class=o>.</span><span class=n>raw</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;expand&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>payload</span><span class=p>[</span><span class=s1>&#39;issue_key&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>issue</span><span class=o>.</span><span class=n>key</span>
</span></span><span class=line><span class=cl>        <span class=n>payload</span><span class=p>[</span><span class=s1>&#39;issue_url&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>issue</span><span class=o>.</span><span class=n>self</span>
</span></span><span class=line><span class=cl>        <span class=n>payload</span><span class=p>[</span><span class=s1>&#39;issue_browse_url&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_jira_url</span> <span class=o>+</span> <span class=s1>&#39;/browse/&#39;</span> <span class=o>+</span> <span class=n>issue</span><span class=o>.</span><span class=n>key</span>
</span></span><span class=line><span class=cl>        <span class=n>fields</span> <span class=o>=</span> <span class=nb>dict</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>fields</span> <span class=o>=</span> <span class=n>issue</span><span class=o>.</span><span class=n>raw</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;fields&#39;</span><span class=p>,</span> <span class=p>{})</span>
</span></span><span class=line><span class=cl>        <span class=n>fields_dict</span> <span class=o>=</span> <span class=nb>dict</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>fields</span><span class=p>[</span><span class=s1>&#39;customfield_19402&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>strip</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=n>fields_dict</span><span class=p>[</span><span class=s1>&#39;pod_name&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>fields</span><span class=p>[</span><span class=s1>&#39;customfield_19401&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>fields_dict</span><span class=p>[</span><span class=s1>&#39;start_time&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>fields</span><span class=p>[</span><span class=s1>&#39;customfield_19402&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>fields_dict</span><span class=p>[</span><span class=s1>&#39;end_time&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>fields</span><span class=p>[</span><span class=s1>&#39;customfield_19403&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>fields_dict</span><span class=p>[</span><span class=s1>&#39;k8s_cluster&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>fields</span><span class=p>[</span><span class=s1>&#39;customfield_19404&#39;</span><span class=p>][</span><span class=s1>&#39;value&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>fields_dict</span><span class=p>[</span><span class=s1>&#39;reporter&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>fields</span><span class=p>[</span><span class=s1>&#39;reporter&#39;</span><span class=p>][</span><span class=s1>&#39;key&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>payload</span><span class=p>[</span><span class=s1>&#39;fields&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>fields_dict</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>fields_dict</span><span class=p>[</span><span class=s1>&#39;reporter&#39;</span><span class=p>]</span> <span class=o>!=</span> <span class=s1>&#39;a@gmail.com&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>_sensor_service</span><span class=o>.</span><span class=n>dispatch</span><span class=p>(</span><span class=n>trigger</span><span class=p>,</span> <span class=n>payload</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div></div></div><h2 id=reference>Reference<a hidden class=anchor aria-hidden=true href=#reference>#</a></h2><p><sup id=1>[1]</sup> <a href=https://docs.stackstorm.com/sensors.html target=_blank rel="noopener nofollow noreferrer">Sensors and Triggers</a></p><p><sup id=2>[2]</sup> <a href=https://akuity.io/blog/argo-cd-architectures-explained/ target=_blank rel="noopener nofollow noreferrer">How many do you need? - Argo CD Architectures Explained</a></p></div><div class=pe-copyright><hr><blockquote><p>本文为原创内容，版权归作者所有。如需转载，请在文章中声明本文标题及链接。</p><p>文章标题：StackStorm自动化 - Sensor</p><p>文章链接：<a href=https://www.oomkill.com/2023/12/stackstorm-sensors/ target=_blank>https://www.oomkill.com/2023/12/stackstorm-sensors/</a></p><p>许可协议：<a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></p></blockquote></div><div class=comments-separator></div><h3 class=relatedContentTitle>相关阅读</h3><ul class=relatedContent><li><a href=/2023/11/stackstorm-pack/><span>StackStorm自动化 - 包</span></a></li><li><a href=/2023/11/stackstorm-rules/><span>StackStorm自动化 - Rules</span></a></li><li><a href=/2023/05/stackstorm-pack-configuaration/><span>StackStorm自动化 - 包配置</span></a></li><li><a href=/2018/06/ansible/><span>ansible介绍</span></a></li></ul><div class=comments-separator></div><footer class=post-footer><ul class=post-tags><li><a href=https://www.oomkill.com/tags/automation/>Automation</a></li></ul><nav class=paginav><a class=prev href=https://www.oomkill.com/2023/12/stackstorm-rules/><span class=title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left" style="user-select:text"><line x1="19" y1="12" x2="5" y2="12" style="user-select:text"/><polyline points="12 19 5 12 12 5" style="user-select:text"/></polyline></svg>&nbsp;</span>
<span>kubernetes上jprofiler自动映射 - 架构设计与实现</span>
</a><a class=next href=https://www.oomkill.com/2023/11/stackstorm-pack/><span class=title></span>
<span>StackStorm自动化 - 包&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right" style="user-select:text"><line x1="5" y1="12" x2="19" y2="12" style="user-select:text"/><polyline points="12 5 19 12 12 19" style="user-select:text"/></svg></span></a></nav></footer><div class=pe-comments-decoration><p class=pe-comments-title></p><p class=pe-comments-subtitle></p></div><div id=pe-comments></div><script src=/js/pe-go-comment.min.86a214102576ba5f9b7bdc29eed8d58dd56e34aef80b3c65c73ea9cc88443696.js integrity="sha256-hqIUECV2ul+be9wp7tjVjdVuNK74Czxlxz6pzIhENpY="></script><script>const getStoredTheme=()=>localStorage.getItem("pref-theme")==="dark"?"dark":"light",setGiscusTheme=()=>{const e=e=>{const t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:e},"https://giscus.app")};e({setConfig:{theme:getStoredTheme()}})};document.addEventListener("DOMContentLoaded",()=>{const s={src:"https://giscus.app/client.js","data-repo":"cylonchau/cylonchau.github.io","data-repo-id":"R_kgDOIRlNSQ","data-category":"Announcements","data-category-id":"DIC_kwDOIRlNSc4CXy1U","data-mapping":"pathname","data-term":"posts/Stackstorm-sensors","data-strict":"0","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"top","data-theme":getStoredTheme(),"data-lang":"zh-TW","data-loading":"lazy",crossorigin:"anonymous",async:""},e=document.createElement("script");Object.entries(s).forEach(([t,n])=>e.setAttribute(t,n)),document.querySelector("#pe-comments").appendChild(e);const t=document.querySelector("#theme-toggle");t&&t.addEventListener("click",setGiscusTheme);const n=document.querySelector("#theme-toggle-float");n&&n.addEventListener("click",setGiscusTheme)})</script></article></main><footer class=footer><span>&copy; 2024 <a href=https://www.oomkill.com/>Cylon's Collection</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> on
<a href=https://pages.github.com/ rel=noopener target=_blank>GitHub Pages</a> & Theme
        <a href=https://github.com/tofuwine/PaperMod-PE rel=noopener target=_blank>PaperMod-PE</a></span><div class=busuanzi-footer style="font-family:helvetica neue,Helvetica,Arial,sans-serif;text-align:center;padding:4px 0;color:#999"><span id=busuanzi_container_site_pv style=margin-right:8px;font-size:.85em>本站总访问量<span id=busuanzi_value_site_pv style=font-weight:500>0</span>次
</span><span id=busuanzi_container_site_uv style=font-size:.85em>本站访客数<span id=busuanzi_value_site_uv style=font-weight:500>0</span>人次</span></div></footer><div class=pe-right-sidebar><a href=javascript:void(0); id=theme-toggle-float class=pe-float-btn><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</a><a href=#top class=pe-float-btn id=top-link><span id=pe-read-progress></span></a></div><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>