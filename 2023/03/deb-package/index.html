<!doctype html><html lang=zh dir=auto><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Unix归档模式 Unix ar - 深入剖析与构建deb包 | Cylon's Collection</title><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NP3JNCPR" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><meta name=keywords content="Linux,debian,rpm,deb,unix"><meta name=description content="deb 概述 deb包（.deb）是 Debian 和基于 Debian衍生操作系统（如Ubuntu）中使用的一种软件包的格式。deb是一种基于 Unix ar [3] (Unix archiver) 的归档文件。其中包含二进制文件、配置文件和其他软件所需的资源。deb包可用于安装、升级和卸载软件包。通常，Debian操作系统的用户使用apt（Advanced Package Tool）等软件包管理器工具来管理deb包。通过这些工具，用户可以轻松下载、安装和管理软件包，而无需手动编译、安装和解决软件包之间的依赖关系。
deb VS rpm 包的归档格式不同：deb是基于 ar 的归档模式，而RPM是基于 cpio 的归档模式 包的结构不同：deb包要求必须包含一个 DEBIAN 目录；而RPM不需要以来额外的目录结构 包的依赖机制不同： Deb使用epoch，而RPM使用build number：在Deb中，epoch是一个可选的字段，它允许呈现基准日期之前的先前版本。而在RPM中，build number表示软件包编译的次数。因此，在Deb中，为了解决版本控制问题，epoch是非常重要的，而在RPM中，则更关注build number。 Deb使用逆向依赖关系，而RPM使用依赖关系：在Deb中，依赖项是从包本身向外扩展，在解决依赖问题时可以通过逆向依赖关系进行。而在RPM中，则更喜欢使用依赖关系直接指向其他包。 Deb允许代理软件包，而RPM则不允许代理软件包：Deb中，软件包可以使用另一种软件包的代理来提供功能。在RPM中，软件包需要直接引用相关的软件包。这意味着在Deb中，对于版本控制，可以用另一种代理软件包来解决问题，而在RPM中必须直接引用包。 Deb允许多重依赖关系，RPM则不允许：Deb允许使用多个依赖项列表，以便包与不同版本的库兼容。在RPM中，需要在每个包中定义依赖项和其版本，不能使用多重依赖。 deb包的分析 deb包的结构 deb 最重要的是 控制文件 Control ，该文件记录了deb包与其安装的程序的信息。
在deb包内部包含一组模拟 Linux 文件系统的文件夹，例如 /usr, /usr/bin, /opt等等。 放置在其中一个目录中的文件将在安装期间复制到实际文件系统中的相同位置。 因此，例如将二进制文件放入 <.deb>/usr/local/bin/binaryfile 将被安装到 /usr/local/bin/binaryfile.
对于deb 包的命名是遵循着一个特定的格式：
text 1 <name>_<version>-<revision>_<architecture>.deb <name> 构建的deb包名称，如nginx <version> 程序的版本号 ，如1.20 <revision> 当前 deb 包的版本号 <architecture> 表示构建出的包的操作系统架构，如，amd64、i386 如果你构建一个nginx-1.20的arm操作系统下的，那么deb包名格式则为 nginx_1.20-1_arm64.deb
control文件 [2] Deb软件包（."><meta name=author content="cylon"><link rel=canonical href=http://localhost:1313/2023/03/deb-package/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=http://localhost:1313/favicon.ico><link rel=icon type=image/png sizes=16x16 href=http://localhost:1313/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=http://localhost:1313/favicon-32x32.png><link rel=apple-touch-icon href=http://localhost:1313/favicon.ico><link rel=mask-icon href=http://localhost:1313/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=http://localhost:1313/2023/03/deb-package/><noscript><style>#theme-toggle,#top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link crossorigin=anonymous href=/assets/css/pe.min.css rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/pe.min.js></script><link rel=stylesheet href=https://cdn.staticfile.net/font-awesome/6.5.1/css/all.min.css><link rel=stylesheet href=https://cdn.staticfile.net/font-awesome/6.5.1/css/v4-shims.min.css><script id=MathJax-script async src=https://cdn.staticfile.net/mathjax/3.2.2/es5/tex-chtml.js></script><script>MathJax={tex:{displayMath:[["$$","$$"]],inlineMath:[["\\$","\\$"]]}}</script><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><meta name=referrer content="no-referrer-when-downgrade"><script>(function(e,t,n,s,o){e[s]=e[s]||[],e[s].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var a=t.getElementsByTagName(n)[0],i=t.createElement(n),r=s!="dataLayer"?"&l="+s:"";i.async=!0,i.src="https://www.googletagmanager.com/gtm.js?id="+o+r,a.parentNode.insertBefore(i,a)})(window,document,"script","dataLayer","GTM-NP3JNCPR")</script><meta property="og:title" content="Unix归档模式 Unix ar - 深入剖析与构建deb包"><meta property="og:description" content="deb 概述 deb包（.deb）是 Debian 和基于 Debian衍生操作系统（如Ubuntu）中使用的一种软件包的格式。deb是一种基于 Unix ar [3] (Unix archiver) 的归档文件。其中包含二进制文件、配置文件和其他软件所需的资源。deb包可用于安装、升级和卸载软件包。通常，Debian操作系统的用户使用apt（Advanced Package Tool）等软件包管理器工具来管理deb包。通过这些工具，用户可以轻松下载、安装和管理软件包，而无需手动编译、安装和解决软件包之间的依赖关系。
deb VS rpm 包的归档格式不同：deb是基于 ar 的归档模式，而RPM是基于 cpio 的归档模式 包的结构不同：deb包要求必须包含一个 DEBIAN 目录；而RPM不需要以来额外的目录结构 包的依赖机制不同： Deb使用epoch，而RPM使用build number：在Deb中，epoch是一个可选的字段，它允许呈现基准日期之前的先前版本。而在RPM中，build number表示软件包编译的次数。因此，在Deb中，为了解决版本控制问题，epoch是非常重要的，而在RPM中，则更关注build number。 Deb使用逆向依赖关系，而RPM使用依赖关系：在Deb中，依赖项是从包本身向外扩展，在解决依赖问题时可以通过逆向依赖关系进行。而在RPM中，则更喜欢使用依赖关系直接指向其他包。 Deb允许代理软件包，而RPM则不允许代理软件包：Deb中，软件包可以使用另一种软件包的代理来提供功能。在RPM中，软件包需要直接引用相关的软件包。这意味着在Deb中，对于版本控制，可以用另一种代理软件包来解决问题，而在RPM中必须直接引用包。 Deb允许多重依赖关系，RPM则不允许：Deb允许使用多个依赖项列表，以便包与不同版本的库兼容。在RPM中，需要在每个包中定义依赖项和其版本，不能使用多重依赖。 deb包的分析 deb包的结构 deb 最重要的是 控制文件 Control ，该文件记录了deb包与其安装的程序的信息。
在deb包内部包含一组模拟 Linux 文件系统的文件夹，例如 /usr, /usr/bin, /opt等等。 放置在其中一个目录中的文件将在安装期间复制到实际文件系统中的相同位置。 因此，例如将二进制文件放入 <.deb>/usr/local/bin/binaryfile 将被安装到 /usr/local/bin/binaryfile.
对于deb 包的命名是遵循着一个特定的格式：
text 1 <name>_<version>-<revision>_<architecture>.deb <name> 构建的deb包名称，如nginx <version> 程序的版本号 ，如1.20 <revision> 当前 deb 包的版本号 <architecture> 表示构建出的包的操作系统架构，如，amd64、i386 如果你构建一个nginx-1.20的arm操作系统下的，那么deb包名格式则为 nginx_1.20-1_arm64.deb
control文件 [2] Deb软件包（."><meta property="og:type" content="article"><meta property="og:url" content="http://localhost:1313/2023/03/deb-package/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-03-29T00:00:00+00:00"><meta property="article:modified_time" content="2023-03-29T23:10:36+08:00"><meta property="og:site_name" content="Cylon's Collection"><meta name=twitter:card content="summary"><meta name=twitter:title content="Unix归档模式 Unix ar - 深入剖析与构建deb包"><meta name=twitter:description content="deb 概述 deb包（.deb）是 Debian 和基于 Debian衍生操作系统（如Ubuntu）中使用的一种软件包的格式。deb是一种基于 Unix ar [3] (Unix archiver) 的归档文件。其中包含二进制文件、配置文件和其他软件所需的资源。deb包可用于安装、升级和卸载软件包。通常，Debian操作系统的用户使用apt（Advanced Package Tool）等软件包管理器工具来管理deb包。通过这些工具，用户可以轻松下载、安装和管理软件包，而无需手动编译、安装和解决软件包之间的依赖关系。
deb VS rpm 包的归档格式不同：deb是基于 ar 的归档模式，而RPM是基于 cpio 的归档模式 包的结构不同：deb包要求必须包含一个 DEBIAN 目录；而RPM不需要以来额外的目录结构 包的依赖机制不同： Deb使用epoch，而RPM使用build number：在Deb中，epoch是一个可选的字段，它允许呈现基准日期之前的先前版本。而在RPM中，build number表示软件包编译的次数。因此，在Deb中，为了解决版本控制问题，epoch是非常重要的，而在RPM中，则更关注build number。 Deb使用逆向依赖关系，而RPM使用依赖关系：在Deb中，依赖项是从包本身向外扩展，在解决依赖问题时可以通过逆向依赖关系进行。而在RPM中，则更喜欢使用依赖关系直接指向其他包。 Deb允许代理软件包，而RPM则不允许代理软件包：Deb中，软件包可以使用另一种软件包的代理来提供功能。在RPM中，软件包需要直接引用相关的软件包。这意味着在Deb中，对于版本控制，可以用另一种代理软件包来解决问题，而在RPM中必须直接引用包。 Deb允许多重依赖关系，RPM则不允许：Deb允许使用多个依赖项列表，以便包与不同版本的库兼容。在RPM中，需要在每个包中定义依赖项和其版本，不能使用多重依赖。 deb包的分析 deb包的结构 deb 最重要的是 控制文件 Control ，该文件记录了deb包与其安装的程序的信息。
在deb包内部包含一组模拟 Linux 文件系统的文件夹，例如 /usr, /usr/bin, /opt等等。 放置在其中一个目录中的文件将在安装期间复制到实际文件系统中的相同位置。 因此，例如将二进制文件放入 <.deb>/usr/local/bin/binaryfile 将被安装到 /usr/local/bin/binaryfile.
对于deb 包的命名是遵循着一个特定的格式：
text 1 <name>_<version>-<revision>_<architecture>.deb <name> 构建的deb包名称，如nginx <version> 程序的版本号 ，如1.20 <revision> 当前 deb 包的版本号 <architecture> 表示构建出的包的操作系统架构，如，amd64、i386 如果你构建一个nginx-1.20的arm操作系统下的，那么deb包名格式则为 nginx_1.20-1_arm64.deb
control文件 [2] Deb软件包（."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"http://localhost:1313/posts/"},{"@type":"ListItem","position":2,"name":"Unix归档模式 Unix ar - 深入剖析与构建deb包","item":"http://localhost:1313/2023/03/deb-package/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Unix归档模式 Unix ar - 深入剖析与构建deb包","name":"Unix归档模式 Unix ar - 深入剖析与构建deb包","description":"deb 概述 deb包（.deb）是 Debian 和基于 Debian衍生操作系统（如Ubuntu）中使用的一种软件包的格式。deb是一种基于 Unix ar [3] (Unix archiver) 的归档文件。其中包含二进制文件、配置文件和其他软件所需的资源。deb包可用于安装、升级和卸载软件包。通常，Debian操作系统的用户使用apt（Advanced Package Tool）等软件包管理器工具来管理deb包。通过这些工具，用户可以轻松下载、安装和管理软件包，而无需手动编译、安装和解决软件包之间的依赖关系。\ndeb VS rpm 包的归档格式不同：deb是基于 ar 的归档模式，而RPM是基于 cpio 的归档模式 包的结构不同：deb包要求必须包含一个 DEBIAN 目录；而RPM不需要以来额外的目录结构 包的依赖机制不同： Deb使用epoch，而RPM使用build number：在Deb中，epoch是一个可选的字段，它允许呈现基准日期之前的先前版本。而在RPM中，build number表示软件包编译的次数。因此，在Deb中，为了解决版本控制问题，epoch是非常重要的，而在RPM中，则更关注build number。 Deb使用逆向依赖关系，而RPM使用依赖关系：在Deb中，依赖项是从包本身向外扩展，在解决依赖问题时可以通过逆向依赖关系进行。而在RPM中，则更喜欢使用依赖关系直接指向其他包。 Deb允许代理软件包，而RPM则不允许代理软件包：Deb中，软件包可以使用另一种软件包的代理来提供功能。在RPM中，软件包需要直接引用相关的软件包。这意味着在Deb中，对于版本控制，可以用另一种代理软件包来解决问题，而在RPM中必须直接引用包。 Deb允许多重依赖关系，RPM则不允许：Deb允许使用多个依赖项列表，以便包与不同版本的库兼容。在RPM中，需要在每个包中定义依赖项和其版本，不能使用多重依赖。 deb包的分析 deb包的结构 deb 最重要的是 控制文件 Control ，该文件记录了deb包与其安装的程序的信息。\n在deb包内部包含一组模拟 Linux 文件系统的文件夹，例如 /usr, /usr/bin, /opt等等。 放置在其中一个目录中的文件将在安装期间复制到实际文件系统中的相同位置。 因此，例如将二进制文件放入 \u0026lt;.deb\u0026gt;/usr/local/bin/binaryfile 将被安装到 /usr/local/bin/binaryfile.\n对于deb 包的命名是遵循着一个特定的格式：\ntext 1 \u0026lt;name\u0026gt;_\u0026lt;version\u0026gt;-\u0026lt;revision\u0026gt;_\u0026lt;architecture\u0026gt;.deb \u0026lt;name\u0026gt; 构建的deb包名称，如nginx \u0026lt;version\u0026gt; 程序的版本号 ，如1.20 \u0026lt;revision\u0026gt; 当前 deb 包的版本号 \u0026lt;architecture\u0026gt; 表示构建出的包的操作系统架构，如，amd64、i386 如果你构建一个nginx-1.20的arm操作系统下的，那么deb包名格式则为 nginx_1.20-1_arm64.deb\ncontrol文件 [2] Deb软件包（.","keywords":["Linux","debian","rpm","deb","unix"],"articleBody":"deb 概述 deb包（.deb）是 Debian 和基于 Debian衍生操作系统（如Ubuntu）中使用的一种软件包的格式。deb是一种基于 Unix ar [3] (Unix archiver) 的归档文件。其中包含二进制文件、配置文件和其他软件所需的资源。deb包可用于安装、升级和卸载软件包。通常，Debian操作系统的用户使用apt（Advanced Package Tool）等软件包管理器工具来管理deb包。通过这些工具，用户可以轻松下载、安装和管理软件包，而无需手动编译、安装和解决软件包之间的依赖关系。\ndeb VS rpm 包的归档格式不同：deb是基于 ar 的归档模式，而RPM是基于 cpio 的归档模式 包的结构不同：deb包要求必须包含一个 DEBIAN 目录；而RPM不需要以来额外的目录结构 包的依赖机制不同： Deb使用epoch，而RPM使用build number：在Deb中，epoch是一个可选的字段，它允许呈现基准日期之前的先前版本。而在RPM中，build number表示软件包编译的次数。因此，在Deb中，为了解决版本控制问题，epoch是非常重要的，而在RPM中，则更关注build number。 Deb使用逆向依赖关系，而RPM使用依赖关系：在Deb中，依赖项是从包本身向外扩展，在解决依赖问题时可以通过逆向依赖关系进行。而在RPM中，则更喜欢使用依赖关系直接指向其他包。 Deb允许代理软件包，而RPM则不允许代理软件包：Deb中，软件包可以使用另一种软件包的代理来提供功能。在RPM中，软件包需要直接引用相关的软件包。这意味着在Deb中，对于版本控制，可以用另一种代理软件包来解决问题，而在RPM中必须直接引用包。 Deb允许多重依赖关系，RPM则不允许：Deb允许使用多个依赖项列表，以便包与不同版本的库兼容。在RPM中，需要在每个包中定义依赖项和其版本，不能使用多重依赖。 deb包的分析 deb包的结构 deb 最重要的是 控制文件 Control ，该文件记录了deb包与其安装的程序的信息。\n在deb包内部包含一组模拟 Linux 文件系统的文件夹，例如 /usr, /usr/bin, /opt等等。 放置在其中一个目录中的文件将在安装期间复制到实际文件系统中的相同位置。 因此，例如将二进制文件放入 \u003c.deb\u003e/usr/local/bin/binaryfile 将被安装到 /usr/local/bin/binaryfile.\n对于deb 包的命名是遵循着一个特定的格式：\ntext 1 _-_.deb 构建的deb包名称，如nginx 程序的版本号 ，如1.20 当前 deb 包的版本号 表示构建出的包的操作系统架构，如，amd64、i386 如果你构建一个nginx-1.20的arm操作系统下的，那么deb包名格式则为 nginx_1.20-1_arm64.deb\ncontrol文件 [2] Deb软件包（.deb文件）中的 控制文件 (control) 包含有关软件包的 源码元数据 和 二进制元数据 ，用于描述例如软件包的名称、版本、描述、作者、许可证和依赖关系等信息。在创建和打包Deb软件包时，必须创建和编辑control文件以包含关于软件包的所有必要信息。\n控制文件 (control) 由一个或多节组成，各节之间用空行分隔。解析器可以接受仅由空格和制表符组成的行作为节分隔符，但控制文件应该使用空行。一些控制文件只允许一个节；其他人允许多个，在这种情况下，每个节通常指的是不同的包，控制文件中节的顺序很重要。\n而 Control 文件存在两种，一种为 源代码包控制文件 (Source package control files)，这种类型的控制文件主要用于定义源代码在构建时的一些元数据信息，例如需要构建一个nginx.deb，那么源代码控制文件就是用于描述下载下来的源代码相关的数据，这种文件被放置在目录 debian/control；\n另一种为二进制包控制文件 (Binary package control files)，这部分是控制在nginx编译后制作成deb包的控制文件，这种控制文件被放置在 DEBIAN/control。\n另外还存在一种 源代码控制文件 ( Debian source control files ) ，包含完整的源代码和软件包元数据信息。它们通常存储在软件包的源代码存储库中，供开发人员和维护人员使用。包含在源代码控制文件中的信息包括软件包名称、版本、维护人员、许可证、依赖关系、构建和安装指令集等。\n例如下面为 control 文件常见的字段类型：\n字段 说明 Package \u003c软件包的名称\u003e Priority \u003c软件包的优先级\u003e Section \u003c软件包的分类\u003e Version \u003c软件包的版本\u003e Depends \u003c软件包的依赖关系\u003e Architecture \u003c软件包的体系结构\u003e Maintainer \u003c软件包的维护者\u003e Description \u003c软件包的描述\u003e Rules-Requires-Root [1] Rules-Requires-Root是Debian软件包中一个可选的控制文件，定义了软件包在安装和运行时是否需要超级用户权限；No/Yes Standards-Version: deb包 控制文件 中的一个元素，用于指定软件包所遵循的标准和规范的版本号。该字段的值应该是一个数字，例如：“3.9.8”, “2.3.0.0” 其中，上面给出的通常是必须指定的字段，如一个control 文件必须包含 Package 、Priority、Section、Version、Architecture、Maintainer 和Description 。由于等 deb软件包通常都安装在系统上，在 control 文件中指定软件包的依赖关系非常重要。这可通过Depends字段完成。\n例如下面是一个 control 文件的示例\nconf # 源代码控制文件 Source: nginx Maintainer: root Section: comm Priority: optional Homepage: https://nginx.org # 二进制控制文件 Package: nginx Version: 1.22.1 Architecture: amd64 Standards-Version: 1.0.0 Build-Depends: debhelper-compat (= 13) Description: Nginx HTTP server Nginx (\"engine x\") is a web server created by Igor Sysoev. It is known for its high performance, stability, and low resource consumption. rules文件 [5] rules文件的规范 rules文件在deb中被成为 主要构建脚本 (Main building script)，这个文件必须是一个可执行的Makefile。它包含了特定于包的源代码（如果需要）和构建一个或多个二进制包的指令。\ndebian/rules文件 必须以 #!/usr/bin/make -f 开头，这个声明是为了通过调用其名称而不是显式调用make来调用它。也就是说，调用 make -f debian/rules args... 或 ./debian/rules args... 必须产生相同的行为。\n在没有使用其他方法的充分理由的情况下，实现Debian软件包构建过程的推荐方式是使用dh工具。这包括debian/rules构建脚本的内容。dh是Debian中最常见的封装辅助工具。使用它通常可以节省遵守本文档中规则的工作，因为dh将自动实现许多规则而无需明确的指示。\nrules 文件内置了一些阶段，这标志着整个源码包构建的过程；如 debian/rules 必须由：clean、binary、binary-arch、binary-indep、build、build-arch 和 build-indep，如果通过 dpkg-buildpackage 构建时，这些阶段则是调用的阶段。\n需要注意的一点是，由于交互式 debian/rules 脚本无法自动编译该软件包，也使其他人难以复制相同的二进制软件包，因此所有必需的阶段都必须是非交互式的。它还遵循这些阶段所依赖的任何阶段也必须是非交互式的。\nrules文件的构建过程 通俗来说，rules文件是一个将源码包转换为二进制包的一个构建模式，首先，binarey二进制包写入解压后的源码包的父目录。其次，所需的目标可以写入 /tmp、/var/tmp 和 TMPDIR 环境变量指定的目录，但不得依赖于其中任何一个的内容。\n这个限制旨在防止源代码包构建创建和依赖于其外部状态，从而影响多个独立的重建过程。特别地，所需的目标不能尝试写入 HOME 目录。\nrules文件的过程，也是阶段：\nbuild (required)：该阶段应该执行软件包的所有配置和编译操作，例如 make，这个阶段执行前，会先运行 clean 阶段 build-indep 和 build-arch (required) build-arch (required)：该阶段必须执行生成所有与架构（architecture）有关的二进制包，例如 make intall 好的 x86 的二进制文件 build-indep (required)： 该阶段执行生成所有与 架构（architecture）无关的二进制包操作，所需的所有配置和编译操作。build 阶段应该依赖于这些阶段，或者采取与调用这些阶段相同的操作， build-arch 和 build-indep 不能执行任何可能需要 root 权限的操作。 通俗来讲，这两个阶段会被用于操作构建完的事情，对于rpmbuild，这里操作就是%files的操作了。 binary (required), binary-arch (required), binary-indep (required)： binary：该阶段必须是用户从此源代码包生成二进制包所需的全部内容。它分为两个部分：binary-arch用于生成特定架构的二进制包，binary-indep用于生成其他类型的二进制包 binary-* 阶段都应该依赖于 build 阶段或适当的 build-arch 或 build-indep 阶段，以便在没有构建该软件包时构建它。然后使用 dpkg-gencontrol 创建其控制文件以及dpkg-deb 构建成一个二进制包，并将它们放置在顶级目录的父目录中（即你执行构建的目录的上级），以创建相应的二进制包。 binary-arch 和 binary-indep 两个阶段必须要存在。如果其中一个阶段无事可做（如果源代码仅生成单个二进制包，无论是否架构相关，始终是如此），它仍必须存在并始终成功。 根据Rules-Requires-Root字段的值的配置，binary阶段可能需要作为root用户调用。 clean (required)：该阶段将撤消 build 和 binary 阶段可能产生的所有效果，除了它应该保留在上次运行 binary 阶段时在父目录中创建的任何输出文件。 patch (optional)：此阶段执行所需的任何其他操作，以使源代码包准备好进行编辑（解包其他上游归档文件、应用补丁等） 这些阶段执行构建的工作目录，与deb包的工作目录不同，他的工作目录为当前目录作为包的根目录来使用，有一点需要注意的是，这里的架构的觉得为 dpkg-architecture 命令决定的，在不同架构机器上构建则为不同的架构的包\n工作目录 在构建deb软件包（.deb文件）时，通常需要将软件包的文件和目录安排在特定的文件目录中，这个特定目录就是打包时的工作目录，通过上面的解释，已知，deb包分为两种 源代码包 和 二进制包，而两中类型的工作目录不相同。\n例如，我们需要构建一个源码软件包，假设为要为一个nginx制作 deb包，那么他的工作目录则为 debian，而control 文件 和 rule 文件则是必须的，封包的内容目录 则为控制文件中 Package 配置的名字，这里配置的为 nginx，那么这个deb包封包时寻找的内容则为 debian/nginx\n在例如，我们需要构建一个二进制软件包，那么他的工作目录为 DEBIAN，control文件与 changelog 则是必须的，而封包的内容目录 当前目录，也就是 DEBIAN，制作时的控制文件这些不会被封入包中\n那么完整的制作流程为：\n在源代码目录下创建一个名为nginx的子目录 mkdir debian 在nginx目录下创建名为 DEBIAN 的子目录，包含 control 文件，在DEBIAN目录中包含control文件是必须的，因为它是软件包元数据的中心存储库。 例如我们编译完的内容，nginx 的配置文件在 /etc/下，那么这个 etc 则在 nginx 子目录下 在工作目录下创建 rules 文件，这里面写明了构建的命令，例如： build：这个部分用于执行编译和构建软件的命令。 clean：这个部分用于清除编译输出，以便你可以重新构建软件包。 install：这个部分指定了如何将软件安装到目标系统中。 binary：这个部分用于在 Debian 软件包中打包二进制文件。 其中该结构中还包含一些钩子脚本文件 debian/p* 而这个 p* 文件的命名是固定的。下面是一些常见的 p* 文件名： debian/package.install：定义软件包中需要安装的文件和目录。 debian/package.manpages：将软件包中的 man 页面添加到 man 手册中。 debian/package.docs：将软件包中的文档添加到系统上的 /usr/share/doc 目录。 debian/package.preinst：在软件包安装前执行的脚本。 debian/package.postinst：在软件包安装后执行的脚本。 debian/package.prerm：在软件包卸载前执行的脚本。 debian/package.postrm：在软件包卸载后执行的脚本。 实战：从0构建一个 deb 包 准备条件 上面介绍的为deb包的一些基础，作为实战的一些理论知识，下面将以nginx为代表将其制作为deb包；通过前面知识了解到，deb包分为 源代码包 和 二进制包，那么nginx明显为源代码包，我们就需要按照 源代码包 =》二进制包 这种顺序依次定义，而 debian 提供了一系列的命令可以帮助生成这些文件，我们只需要改写具体的逻辑就可以完成包的制作，如 dh_make , dh_install 等命令。\n对于 deb 包的标准，debian 官方有一些列的教程，称为 Debian Policy Manual [4] ，可以通过这个手册，整个deb包中所需的一些理论知识，控制文件，维护脚本，包间的依赖关系，共享库等进行详细的说明\ndh工具 dh [6]（Debhelper）工具是Debian中自带的一个构建deb包的工具集。dh工具包含了一系列的脚本，用于从打包的源代码中自动化生成debian目录下的文件。这些脚本是 debian/rules 文件中的一部分，它们负责处理诸如构建、安装、打包、删除等任务。\ndh工具包括多个命令及其选项，更多的 dh 工具可以参考官方\n命令 说明 dh_make 创建一个基本的在deb包打包时的工作框架 dh_auto_configure 自动运行 configure 脚本以生成 Makefile dh_install 将文件复制到正确的deb包的构建目录中，一些常见选项：\n-s 或 --sourcedir=: 指定源代码目录；\n-X 或 --exclude: 排除在安装中不必要的文件；\n-n 或 --noscripts: 在安装软件包时不运行脚本；\n-Z: 表示安装的文件不要在规则中注册； dh_builddeb 以 .deb 文件格式构建软件包 dh_clean 清理debian目录和生成的文件，以确保它们不会在构建时对结果造成影响。 dh_gencontrol 生产和安装control文件 dh_installsystemd 安装systemd单元文件 dh_make dh_make 命令是一个用于快速创建 deb 包的命令行工具。它可以根据用户提供的基本信息和软件包源代码自动创建 deb 包的基础结构，包括 debian/ 目录和相关文件，如 control、rules 以及 changelog 等文件。DH 表示 Debian 包含 debhelper 建议的目录和文件结构。\n在默认情况下，dh_make 命令是交互式的，它会提示你输入一些必要的软件包信息，如软件包名称、版本号、作者、软件许可证等。如果你想非交互方式运行 dh_make 命令，并指定软件包信息，则可以使用 -s 选项。\nbash 1 $ dh_make -s --createorig -f ../{some_package-1.2.3}.tar.gz -p {some_package_1.2.3-1}.deb 在上述命令中，-s 选项表示以非交互方式运行 dh_make 命令，并将软件包的基本信息作为参数指定。--createorig 选项表示我们想要创建一个原始的源代码包，-f 选项指定软件包源代码的文件名和路径，-p 选项指定要创建的 Debian 软件包的名称和版本号。\n而上述命令会提示输入一些基本的详细信息，以便在 debian/control 控制文件中为软件包设置元数据。dh_make 会询问输入软件包的名称、版本、描述、组件、维护人员等信息，是否以这些参数作为构建，如果不需要这部确认可以使用 -y 默认同意\n下面是通过 dh_make 构建出的在构建deb包的工作目录，这种方式下可以很明了的理解deb包的结构\nbash 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 $ tree debian/ debian/ ├── changelog ├── control ├── copyright ├── manpage.1.ex ├── manpage.sgml.ex ├── manpage.xml.ex ├── nginx.cron.d.ex ├── nginx.doc-base.EX ├── nginx-docs.docs ├── postinst.ex ├── postrm.ex ├── preinst.ex ├── prerm.ex ├── README.Debian ├── README.source ├── rules ├── salsa-ci.yml.ex ├── source │ └── format └── watch.ex 到这里，我们就完成了一个源码包的前提条件的构建，只需要稍微修改控制文件即可，进行后续的二进制包的构建。\n这里最终的 控制文件 如下所示：\nconf # 源代码控制文件 Source: nginx Maintainer: root Section: comm Priority: optional Homepage: https://nginx.org # 二进制控制文件 Package: nginx-d Version: 1.22.1 Architecture: amd64 Standards-Version: 1.0.0 Build-Depends: debhelper-compat (= 13) Description: Nginx HTTP server Nginx (\"engine x\") is a web server created by Igor Sysoev. It is known for its high performance, stability, and low resource consumption. 准备rules文件 通过上面的rules文件部分介绍，了解到 rules 文件就是一个 Makefile，并且包含三个阶段\nclean – 删除所有build与binary阶段产生的内容\nbuild – 编译与构建的步骤\nbinary – binary阶段将创建deb包的root目录，这个目录被包含在 debian 目录下，而目录名则为 control 文件中配置的 Package 名字，即 debian/\n这些阶段都通过 dpkg-buildpackage 在构建时被执行，一个rules文件的模板如下\nmakefile 1 2 3 4 5 6 7 8 9 10 11 12 #!/usr/bin/make -f clean: @# Do nothing build: @# Do nothing binary: @# Do nothing dh_gencontrol dh_builddeb 那这个 nginx 的 rules 文件则为下述所示：\nmake 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 #!/usr/bin/make -f # 列出您要編譯的檔案和目錄 export DH_VERBOSE=1 PACKAGE=nginx UPSTREAM_VERSION=1.22.1 # 設置打包的參數 export DEB_BUILD_MAINT_OPTIONS = hardening=+all export BUILDDIR_WORK = $(CURDIR)/debian/$(PACKAGE) export BUILDDIR=$(CURDIR)/debian/tmp # 定義建立目錄，它會在${CURDIR}/debian/$PACKAGE下創建 debian/$PACKAGE:: %: # build阶段，将完成软件的编译 build: tar zxf nginx-$(UPSTREAM_VERSION).tar.gz # 配置 Nginx 以使用必要的模塊和參數 cd nginx-$(UPSTREAM_VERSION) \u0026\u0026 \\ ./configure \\ --conf-path=/etc/nginx/nginx.conf \\ --pid-path=/var/run/nginx \\ --sbin-path=/usr/sbin/nginx \\ --http-log-path=/var/log/nginx/error.log \\ --error-log-path=/var/log/nginx/access.log \\ --http-client-body-temp-path=/etc/nginx/ \\ --http-proxy-temp-path=/var/run/nginx/ \\ --http-fastcgi-temp-path=/var/run/nginx/ \\ --http-uwsgi-temp-path=/var/run/nginx/ \\ --http-scgi-temp-path=/var/run/nginx/ \\ --pid-path=/var/run/nginx/nginx.pid \\ --with-http_ssl_module \\ --without-http_gzip_module cd nginx-$(UPSTREAM_VERSION) \u0026\u0026 make # 这里存在一个问题，即 prefix 与 DESTDIR 不要同时写，make install 被安装在哪里 # 如果配置了prefix 那么则被安装在 prefix/DESTDIR 变成了双重目录 # 这里不配置 prefix 只配置DESTDIR则会被安装在 deb 包在构建时的工作目录，这里制定了$(BUILDDIR) # 将被放置在 $(BUILDDIR) cd nginx-$(UPSTREAM_VERSION) \u0026\u0026 make install DESTDIR=$(BUILDDIR) # 清理 rm -rf nginx-$(UPSTREAM_VERSION) clean: rm -rf nginx-$(UPSTREAM_VERSION) rm -rf $(BUILDDIR) rm -rf $(BUILDDIR_WORK) build-indep: # 构建前测试目录 dh_testdir build-arch: dh_testdir binary-indep: dh_testdir # 测试是否有root权限 dh_testroot # 在 binary 阶段中，执行的安装操作，创建 /etc/nginx目录 # 这些命令执行的是 install -d # 为什么使用 dh tool 而不用install，因为dh tool是rules file的一部分，也就是他默认的工作目录是 # 构建deb包的工作目录，这里必须是相对目录 # 而对于第一个的 \"/\" 与 最后一个 \"/\" 都不要写，会被自动除虫上 dh_installdirs etc/nginx dh_installdirs var/log/nginx dh_installdirs var/run/nginx dh_install etc/nginx/* etc/nginx dh_install usr/sbin/* usr/sbin # 这里创建了二进制包的目录结构 install -d $(BUILDDIR_WORK)/DEBIAN # dh_gencontrol可以根据源码包的配置来生成二进制包的control文件 # 底层封装的是 dh_gencontrol -O --file --package=nginx 为二进制包生成 dh_gencontrol -O --file --package=$(PACKAGE) # dh_installchangelogs 可以根据源码包中的changelog来生成二进制包的changelog # changelog 和 control file是二进制包必须的文件 # dh_gencontrol -O --file --package=nginx # 底层执行的为在 deb 包根目录的/usr/share/doc/nginx 中生成changelog # dh_installchangelogs # install -d debian/nginx/usr/share/doc/nginx # install -p -m0644 debian/changelog debian/nginx/usr/share/doc/nginx/changelog.Debian dh_installchangelogs # 这里将修复链接路径及压缩，如果你的一些软连接需要修复时可以使用 dh_compress binary: binary-indep # dh_builddeb命令将会构建一个二进制包 # dh_builddeb封装的时dpkg-deb命令 # dpkg-deb --build debian/nginx .. dh_builddeb .PHONY: clean binary-indep binary-arch binary install build 执行构建 通过执行 dpkg-buildpackage -b 来构建二进制源码包\nlog install -d debian/nginx/usr/sbin cp --reflink=auto -a debian/tmp/usr/sbin/nginx debian/nginx/usr/sbin/ install -d /root/nginx/debian/nginx/DEBIAN dh_gencontrol -O --file --package=nginx dpkg-gencontrol -pnginx -ldebian/changelog -Tdebian/nginx.substvars -Pdebian/nginx dpkg-gencontrol: warning: unknown information field 'Version' in input data in package's section of control info file dpkg-gencontrol: warning: unknown information field 'Standards-Version' in input data in package's section of control info file chmod 0644 -- debian/nginx/DEBIAN/control chown 0:0 -- debian/nginx/DEBIAN/control dh_installchangelogs install -d debian/nginx/usr/share/doc/nginx install -p -m0644 debian/changelog debian/nginx/usr/share/doc/nginx/changelog.Debian dh_compress cd debian/nginx chmod a-x usr/share/doc/nginx/changelog.Debian gzip -9nf usr/share/doc/nginx/changelog.Debian cd '/root/nginx' dh_builddeb dpkg-deb --build debian/nginx .. dpkg-deb: building package 'nginx' in '../nginx_1.22.1-1_amd64.deb'. dpkg-genbuildinfo --build=binary dpkg-genchanges --build=binary \u003e../nginx_1.22.1-1_amd64.changes dpkg-genchanges: warning: unknown information field 'Version' in input data in package's section of control info file dpkg-genchanges: warning: unknown information field 'Standards-Version' in input data in package's section of control info file dpkg-genchanges: warning: unknown information field 'Build-Depends' in input data in package's section of control info file dpkg-genchanges: info: binary-only upload (no source code included) dpkg-source --after-build . dpkg-source: warning: unknown information field 'Version' in input data in package's section of control info file dpkg-source: warning: unknown information field 'Standards-Version' in input data in package's section of control info file dpkg-source: warning: unknown information field 'Build-Depends' in input data in package's section of control info file dpkg-buildpackage: info: binary-only upload (no source included) 构建完成后，生成的deb包在当前执行命令的父目录中，而生成的文件名遵守了 _-_.deb 这种格式\nbash 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 $ dpkg -c ../nginx_1.22.1-1_amd64.deb ./ ./etc/ ./etc/nginx/ ./etc/nginx/fastcgi.conf ./etc/nginx/fastcgi.conf.default ./etc/nginx/fastcgi_params ./etc/nginx/fastcgi_params.default ./etc/nginx/koi-utf ./etc/nginx/koi-win ./etc/nginx/mime.types ./etc/nginx/mime.types.default ./etc/nginx/nginx.conf ./etc/nginx/nginx.conf.default ./etc/nginx/scgi_params ./etc/nginx/scgi_params.default ./etc/nginx/uwsgi_params ./etc/nginx/uwsgi_params.default ./etc/nginx/win-utf ./usr/ ./usr/sbin/ ./usr/sbin/nginx ./usr/share/ ./usr/share/doc/ ./usr/share/doc/nginx/ ./usr/share/doc/nginx/changelog.Debian.gz ./var/ ./var/log/ ./var/log/nginx/ ./var/run/ ./var/run/nginx/ Troubleshooting no upstream tarball found text 1 2 dpkg-source: error: can't build with source format '3.0 (quilt)': no upstream tarball found at ../nginx_1.22.1.orig.tar.{bz2,gz,lzma,xz} dpkg-buildpackage: error: dpkg-source -b . subprocess returned exit status 2 解决：需要和你的构建目录 为上级即 debian 的上级\nnon-native package version does not contain a revision text 1 dpkg-source: error: can't build with source format '3.0 (quilt)': non-native package version does not contain a revision 解决：在changelog中定义正确的修订号\nDebian 软件包版本号由三个部分组成：Major.Minor.Revision，它们通常定义在软件包的 debian/changelog 文件中。\n在 debian/changelog 文件中，每个软件包版本都会记录下来，包括软件包的版本号、构建日期和构建者的姓名和电子邮件等信息，形成一个时间线。每个 Debian 软件包版本号应该遵循 X.Y.Z-r (或 X.Y.Z~rN) 的格式，其中 X.Y.Z 是软件包的版本号，r (或 N) 是软件包的修订号。\n用于版本号的changelog文件通常位于软件包源代码的 debian/ 目录中。您可以打开 debian/changelog 文件，找到最近的条目，将其中的版本号中的修订号修改为所需的值，并保存文件。在对 Debian 软件包进行重新打包之前，请确保更新了 debian/changelog 文件，以便反映新版本号的修改。\n需要注意的是，当您更改 debian/changelog 文件中的版本号时，请确保更新 debian/control 文件中的软件包版本依赖信息，以便与新的软件包版本号匹配。 这是为了确保软件包依赖关系与实际的软件包版本相匹配，避免在安装和使用软件包时出现问题。\nis not a valid version text 1 dpkg-genchanges: error: is not a valid version 解决：这个问题是因为制定了 -v 重写了 version 配置，而没有指定具体的版本号\n“yes” is invalid; use “binary-targets” instead bash 1 dpkg-buildpackage: error: Rules-Requires-Root field keyword \"yes\" is invalid; use \"binary-targets\" instead 解决：control 文件的 Rules-Requires-Root 没有yes选项 [8]\nCompatibility levels before 5 are no longer supported (level 1 requested) bash 1 dh: error: Compatibility levels before 5 are no longer supported (level 1 requested) 这个错误提示是由于 Debian Policy 从 3.9.0 开始不再支持 compat level 4 以及更低级别的设置，需要使用符合 Debian Policy 3.9.0 或更高版本的规范定义包。\n如果您在 debian/control 文件中设置了 compatibility level 较低的版本（如 3, 4），则会遇到这个错误。您需要将这个 compatibility level 提升至 5 或以上版本，即在 debian/control 文件中加入以下设置：\nunwanted binary file: debian/debian.deb bash 1 2 3 dpkg-source: error: unwanted binary file: debian/debian.deb dpkg-source: error: detected 1 unwanted binary file (add it in debian/source/include-binaries to allow its inclusion). dpkg-buildpackage: error: dpkg-source -b . subprocess returned exit status 255 解决：删除上级目录中多余文件即可\ncannot represent change to .Xauthority: binary file contents changed bash 1 2 3 dpkg-source: error: cannot represent change to .Xauthority: binary file contents changed dpkg-source: error: add .Xauthority in debian/source/include-binaries if you want to store the modified binary in the debian tarball dpkg-source: error: unrepresentable changes to source 解决：这是因为我直接在家目录操作的，家目录存在一些其他文件，如家目录下的隐藏文件\nReference [1] rules-requires-root\n[2] Control files and their fields\n[3] ar (Unix)\n[4] Debian Policy Manual\n[5] Main building script\n[6] debhelper(7)\n[7] Tutorial 2: building a binary package using dpkg-buildpackage\n[8] 5.6.31. Rules-Requires-Root\n","wordCount":"1627","inLanguage":"zh","datePublished":"2023-03-29T00:00:00Z","dateModified":"2023-03-29T23:10:36+08:00","author":{"@type":"Person","name":"cylon"},"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:1313/2023/03/deb-package/"},"publisher":{"@type":"Organization","name":"Cylon's Collection","logo":{"@type":"ImageObject","url":"http://localhost:1313/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=http://localhost:1313/><img src=http://localhost:1313/favicon.ico alt aria-label=logo height=20>Cylon's Collection</a><div class=logo-switches><button id=theme-toggle><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=http://localhost:1313/archives><span>归档</span></a></li><li><a href=http://localhost:1313/tags><span>标签</span></a></li><li><a href=http://localhost:1313/search><span>搜索</span></a></li><li><a href=http://localhost:1313/about accesskey=/><span>关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Unix归档模式 Unix ar - 深入剖析与构建deb包</h1><div class=post-meta><span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar" style="user-select:text"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" style="user-select:text"/><line x1="16" y1="2" x2="16" y2="6" style="user-select:text"/><line x1="8" y1="2" x2="8" y2="6" style="user-select:text"/><line x1="3" y1="10" x2="21" y2="10" style="user-select:text"/></svg><span>2023-03-29</span></span>&nbsp;·&nbsp;<span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text" style="user-select:text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z" style="user-select:text"/><polyline points="14 2 14 8 20 8" style="user-select:text"/><line x1="16" y1="13" x2="8" y2="13" style="user-select:text"/><line x1="16" y1="17" x2="8" y2="17" style="user-select:text"/><polyline points="10 9 9 9 8 9" style="user-select:text"/></svg><span>1627 字</span></span>&nbsp;·&nbsp;<span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><span>8 分钟</span></span>
<span class=pe-post-meta-item>&nbsp;·&nbsp;<svg t="1714036239378" fill="currentcolor" class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="6659" width="256" height="256"><path d="M690 78.2c-18.6-18.8-49-19-67.8-.4s-19 49-.4 67.8l255.4 258.6c67.8 68.6 67.8 178.8.0 247.4L653.4 878.2c-18.6 18.8-18.4 49.2.4 67.8s49.2 18.4 67.8-.4l224-226.4c104.8-106 104.8-276.4.0-382.4L690 78.2zM485.4 101.4c-24-24-56.6-37.4-90.6-37.4H96C43 64 0 107 0 160v299c0 34 13.4 66.6 37.4 90.6l336 336c50 50 131 50 181 0l267-267c50-50 50-131 0-181l-336-336zM96 160h299c8.4.0 16.6 3.4 22.6 9.4l336 336c12.4 12.4 12.4 32.8.0 45.2l-267 267c-12.4 12.4-32.8 12.4-45.2.0l-336-336c-6-6-9.4-14.2-9.4-22.6V160zm192 128a64 64 0 10-128 0 64 64 0 10128 0z" p-id="6660"/></svg></span><ul class=pe-post-meta-item><a href=http://localhost:1313/tags/linux/>#Linux</a>
<a href=http://localhost:1313/tags/debian/>#Debian</a></ul></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details><summary><span class=details>目录</span></summary><div class=inner><ul><li><a href=#deb-%e6%a6%82%e8%bf%b0 aria-label="deb 概述">deb 概述</a><ul><li><a href=#deb-vs-rpm aria-label="deb VS rpm">deb VS rpm</a></ul><li><a href=#deb%e5%8c%85%e7%9a%84%e5%88%86%e6%9e%90 aria-label=deb包的分析>deb包的分析</a><ul><li><a href=#deb%e5%8c%85%e7%9a%84%e7%bb%93%e6%9e%84 aria-label=deb包的结构>deb包的结构</a><li><a href=#control%e6%96%87%e4%bb%b6-supa-id22asup aria-label="control文件 [2]">control文件 <sup><a id=2>[2]</a></sup></a><li><a href=#rules%e6%96%87%e4%bb%b6-supa-id55asup aria-label="rules文件 [5]">rules文件 <sup><a id=5>[5]</a></sup></a><ul><li><a href=#rules%e6%96%87%e4%bb%b6%e7%9a%84%e8%a7%84%e8%8c%83 aria-label=rules文件的规范>rules文件的规范</a><li><a href=#rules%e6%96%87%e4%bb%b6%e7%9a%84%e6%9e%84%e5%bb%ba%e8%bf%87%e7%a8%8b aria-label=rules文件的构建过程>rules文件的构建过程</a></ul><li><a href=#%e5%b7%a5%e4%bd%9c%e7%9b%ae%e5%bd%95 aria-label=工作目录>工作目录</a></ul><li><a href=#%e5%ae%9e%e6%88%98%e4%bb%8e0%e6%9e%84%e5%bb%ba%e4%b8%80%e4%b8%aa-deb-%e5%8c%85 aria-label="实战：从0构建一个 deb 包">实战：从0构建一个 deb 包</a><ul><li><a href=#%e5%87%86%e5%a4%87%e6%9d%a1%e4%bb%b6 aria-label=准备条件>准备条件</a><li><a href=#dh%e5%b7%a5%e5%85%b7 aria-label=dh工具>dh工具</a><ul><li><a href=#dh_make aria-label=dh_make>dh_make</a></ul><li><a href=#%e5%87%86%e5%a4%87rules%e6%96%87%e4%bb%b6 aria-label=准备rules文件>准备rules文件</a><li><a href=#%e6%89%a7%e8%a1%8c%e6%9e%84%e5%bb%ba aria-label=执行构建>执行构建</a></ul><li><a href=#troubleshooting aria-label=Troubleshooting>Troubleshooting</a><ul><li><a href=#no-upstream-tarball-found aria-label="no upstream tarball found">no upstream tarball found</a><li><a href=#non-native-package-version-does-not-contain-a-revision aria-label="non-native package version does not contain a revision">non-native package version does not contain a revision</a><li><a href=#is-not-a-valid-version aria-label="is not a valid version">is not a valid version</a><li><a href=#yes-is-invalid-use-binary-targets-instead aria-label="&amp;ldquo;yes&amp;rdquo; is invalid; use &amp;ldquo;binary-targets&amp;rdquo; instead">&ldquo;yes&rdquo; is invalid; use &ldquo;binary-targets&rdquo; instead</a><li><a href=#compatibility-levels-before-5-are-no-longer-supported-level-1-requested aria-label="Compatibility levels before 5 are no longer supported (level 1 requested)">Compatibility levels before 5 are no longer supported (level 1 requested)</a><li><a href=#unwanted-binary-file-debiandebiandeb aria-label="unwanted binary file: debian/debian.deb">unwanted binary file: debian/debian.deb</a><li><a href=#cannot-represent-change-to-xauthority-binary-file-contents-changed aria-label="cannot represent change to .Xauthority: binary file contents changed">cannot represent change to .Xauthority: binary file contents changed</a></ul><li><a href=#reference aria-label=Reference>Reference</a></li></div></details></div></aside><script src=/js/pe-toc.min.445eb1bfc5e85dd13b9519fcc2a806522e9629b6224a2974052789ba00ab78af.js integrity="sha256-RF6xv8XoXdE7lRn8wqgGUi6WKbYiSil0BSeJugCreK8="></script><div class=post-content><h2 id=deb-概述>deb 概述<a hidden class=anchor aria-hidden=true href=#deb-概述>#</a></h2><p>deb包（.deb）是 Debian 和基于 Debian衍生操作系统（如Ubuntu）中使用的一种软件包的格式。deb是一种基于 Unix ar <sup><a href=#3>[3]</a></sup> (<em><strong>Unix archiver</strong></em>) 的归档文件。其中包含二进制文件、配置文件和其他软件所需的资源。deb包可用于安装、升级和卸载软件包。通常，Debian操作系统的用户使用apt（Advanced Package Tool）等软件包管理器工具来管理deb包。通过这些工具，用户可以轻松下载、安装和管理软件包，而无需手动编译、安装和解决软件包之间的依赖关系。</p><h3 id=deb-vs-rpm>deb VS rpm<a hidden class=anchor aria-hidden=true href=#deb-vs-rpm>#</a></h3><ul><li>包的归档格式不同：deb是基于 ar 的归档模式，而RPM是基于 cpio 的归档模式</li><li>包的结构不同：deb包要求必须包含一个 <code>DEBIAN</code> 目录；而RPM不需要以来额外的目录结构</li><li>包的依赖机制不同：<ol><li>Deb使用epoch，而RPM使用build number：在Deb中，epoch是一个可选的字段，它允许呈现基准日期之前的先前版本。而在RPM中，build number表示软件包编译的次数。因此，在Deb中，为了解决版本控制问题，epoch是非常重要的，而在RPM中，则更关注build number。</li><li>Deb使用逆向依赖关系，而RPM使用依赖关系：在Deb中，依赖项是从包本身向外扩展，在解决依赖问题时可以通过逆向依赖关系进行。而在RPM中，则更喜欢使用依赖关系直接指向其他包。</li><li>Deb允许代理软件包，而RPM则不允许代理软件包：Deb中，软件包可以使用另一种软件包的代理来提供功能。在RPM中，软件包需要直接引用相关的软件包。这意味着在Deb中，对于版本控制，可以用另一种代理软件包来解决问题，而在RPM中必须直接引用包。</li><li>Deb允许多重依赖关系，RPM则不允许：Deb允许使用多个依赖项列表，以便包与不同版本的库兼容。在RPM中，需要在每个包中定义依赖项和其版本，不能使用多重依赖。</li></ol></li></ul><h2 id=deb包的分析>deb包的分析<a hidden class=anchor aria-hidden=true href=#deb包的分析>#</a></h2><h3 id=deb包的结构>deb包的结构<a hidden class=anchor aria-hidden=true href=#deb包的结构>#</a></h3><p>deb 最重要的是 <strong>控制文件</strong> <code>Control</code> ，该文件记录了deb包与其安装的程序的信息。</p><p>在deb包内部包含一组模拟 Linux 文件系统的文件夹，例如 <code>/usr</code>, <code>/usr/bin</code>, <code>/opt</code>等等。 放置在其中一个目录中的文件将在安装期间复制到实际文件系统中的相同位置。 因此，例如将二进制文件放入 <code>&lt;.deb>/usr/local/bin/binaryfile</code> 将被安装到 <code>/usr/local/bin/binaryfile</code>.</p><p>对于deb 包的命名是遵循着一个特定的格式：</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>text</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>&lt;name&gt;_&lt;version&gt;-&lt;revision&gt;_&lt;architecture&gt;.deb</span></span></code></pre></td></tr></table></div></div></div></div><ul><li><code>&lt;name></code> 构建的deb包名称，如nginx</li><li><code>&lt;version></code> 程序的版本号 ，如1.20</li><li><code>&lt;revision></code> 当前 deb 包的版本号</li><li><code>&lt;architecture></code> 表示构建出的包的操作系统架构，如，amd64、i386</li></ul><p>如果你构建一个nginx-1.20的arm操作系统下的，那么deb包名格式则为 <code>nginx_1.20-1_arm64.deb</code></p><h3 id=control文件-supa-id22asup>control文件 <sup><a id=2>[2]</a></sup><a hidden class=anchor aria-hidden=true href=#control文件-supa-id22asup>#</a></h3><p>Deb软件包（.deb文件）中的 控制文件 (<em><strong>control</strong></em>) 包含有关软件包的 <font color=#f8070d size=3>源码元数据</font> 和 <font color=#f8070d size=3>二进制元数据 </font>，用于描述例如软件包的名称、版本、描述、作者、许可证和依赖关系等信息。在创建和打包Deb软件包时，必须创建和编辑control文件以包含关于软件包的所有必要信息。</p><p>控制文件 (<em><strong>control</strong></em>) 由一个或多节组成，各节之间用空行分隔。解析器可以接受仅由空格和制表符组成的行作为节分隔符，但控制文件应该使用空行。一些控制文件只允许一个节；其他人允许多个，在这种情况下，每个节通常指的是不同的包，控制文件中节的顺序很重要。</p><p>而 Control 文件存在两种，一种为 <font color=#f8070d size=3>源代码包控制文件</font> (<em><strong>Source package control files</strong></em>)，这种类型的控制文件主要用于定义源代码在构建时的一些元数据信息，例如需要构建一个nginx.deb，那么源代码控制文件就是用于描述下载下来的源代码相关的数据，这种文件被放置在目录 <code>debian/control</code>；</p><p>另一种为<font color=#f8070d size=3>二进制包控制文件</font> (<em><strong>Binary package control files</strong></em>)，这部分是控制在nginx编译后制作成deb包的控制文件，这种控制文件被放置在 <code>DEBIAN/control</code>。</p><p>另外还存在一种 <font color=#f8070d size=3>源代码控制文件</font> ( <em><strong>Debian source control files</strong></em> ) ，包含完整的源代码和软件包元数据信息。它们通常存储在软件包的源代码存储库中，供开发人员和维护人员使用。包含在源代码控制文件中的信息包括软件包名称、版本、维护人员、许可证、依赖关系、构建和安装指令集等。</p><p>例如下面为 <code>control</code> 文件常见的字段类型：</p><table><thead><tr><th>字段</th><th>说明</th></tr></thead><tbody><tr><td>Package</td><td>&lt;软件包的名称></td></tr><tr><td>Priority</td><td>&lt;软件包的优先级></td></tr><tr><td>Section</td><td>&lt;软件包的分类></td></tr><tr><td>Version</td><td>&lt;软件包的版本></td></tr><tr><td>Depends</td><td>&lt;软件包的依赖关系></td></tr><tr><td>Architecture</td><td>&lt;软件包的体系结构></td></tr><tr><td>Maintainer</td><td>&lt;软件包的维护者></td></tr><tr><td>Description</td><td>&lt;软件包的描述></td></tr><tr><td>Rules-Requires-Root <sup><a id=1>[1]</a></sup></td><td>Rules-Requires-Root是Debian软件包中一个可选的控制文件，定义了软件包在安装和运行时是否需要超级用户权限；No/Yes</td></tr><tr><td>Standards-Version:</td><td>deb包 控制文件 中的一个元素，用于指定软件包所遵循的标准和规范的版本号。该字段的值应该是一个数字，例如：“3.9.8”, “2.3.0.0”</td></tr></tbody></table><p>其中，上面给出的通常是必须指定的字段，如一个control 文件必须包含 <code>Package</code> 、<code>Priority</code>、<code>Section</code>、<code>Version</code>、<code>Architecture</code>、<code>Maintainer</code> 和<code>Description</code> 。由于等 deb软件包通常都安装在系统上，在 control 文件中指定软件包的依赖关系非常重要。这可通过Depends字段完成。</p><p>例如下面是一个 control 文件的示例</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>conf</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><pre tabindex=0><code class=language-conf data-lang=conf># 源代码控制文件
Source: nginx
Maintainer: root &lt;root@debian-template&gt;
Section: comm
Priority: optional
Homepage: https://nginx.org

# 二进制控制文件
Package: nginx
Version: 1.22.1
Architecture: amd64
Standards-Version: 1.0.0
Build-Depends: debhelper-compat (= 13)
Description: Nginx HTTP server Nginx (&#34;engine x&#34;) is a web server created by Igor Sysoev. It is known for its high performance, stability, and low resource consumption.</code></pre></div></div><h3 id=rules文件-supa-id55asup>rules文件 <sup><a id=5>[5]</a></sup><a hidden class=anchor aria-hidden=true href=#rules文件-supa-id55asup>#</a></h3><h4 id=rules文件的规范>rules文件的规范<a hidden class=anchor aria-hidden=true href=#rules文件的规范>#</a></h4><p>rules文件在deb中被成为 主要构建脚本 (<em><strong>Main building script</strong></em>)，这个文件必须是一个可执行的Makefile。它包含了特定于包的源代码（如果需要）和构建一个或多个二进制包的指令。</p><p>debian/rules文件 必须以 <code>#!/usr/bin/make -f</code> 开头，这个声明是为了通过调用其名称而不是显式调用make来调用它。也就是说，调用 <code>make -f debian/rules args...</code> 或 <code>./debian/rules args...</code> 必须产生相同的行为。</p><p>在没有使用其他方法的充分理由的情况下，实现Debian软件包构建过程的推荐方式是使用dh工具。这包括debian/rules构建脚本的内容。dh是Debian中最常见的封装辅助工具。使用它通常可以节省遵守本文档中规则的工作，因为dh将自动实现许多规则而无需明确的指示。</p><p>rules 文件内置了一些阶段，这标志着整个源码包构建的过程；如 debian/rules 必须由：clean、binary、binary-arch、binary-indep、build、build-arch 和 build-indep，如果通过 <code>dpkg-buildpackage</code> 构建时，这些阶段则是调用的阶段。</p><p>需要注意的一点是，由于交互式 debian/rules 脚本无法自动编译该软件包，也使其他人难以复制相同的二进制软件包，因此所有必需的阶段都必须是非交互式的。它还遵循这些阶段所依赖的任何阶段也必须是非交互式的。</p><h4 id=rules文件的构建过程>rules文件的构建过程<a hidden class=anchor aria-hidden=true href=#rules文件的构建过程>#</a></h4><p>通俗来说，rules文件是一个将源码包转换为二进制包的一个构建模式，首先，binarey二进制包写入解压后的源码包的父目录。其次，所需的目标可以写入 /tmp、/var/tmp 和 TMPDIR 环境变量指定的目录，但不得依赖于其中任何一个的内容。</p><p>这个限制旨在防止源代码包构建创建和依赖于其外部状态，从而影响多个独立的重建过程。特别地，所需的目标不能尝试写入 HOME 目录。</p><p>rules文件的过程，也是阶段：</p><ul><li><em><strong>build</strong></em> (required)：该阶段应该执行软件包的所有配置和编译操作，例如 make，这个阶段执行前，会先运行 <code>clean</code> 阶段</li><li><em><strong>build-indep</strong></em> 和 <em><strong>build-arch</strong></em> (required)<ul><li>build-arch (required)：该阶段必须执行生成所有与架构（<em><strong>architecture</strong></em>）有关的二进制包，例如 make intall 好的 x86 的二进制文件</li><li>build-indep (required)： 该阶段执行生成所有与 架构（<em><strong>architecture</strong></em>）无关的二进制包操作，所需的所有配置和编译操作。build 阶段应该依赖于这些阶段，或者采取与调用这些阶段相同的操作，</li><li><code>build-arch</code> 和 <code>build-indep</code> 不能执行任何可能需要 root 权限的操作。</li><li>通俗来讲，这两个阶段会被用于操作构建完的事情，对于rpmbuild，这里操作就是%files的操作了。</li></ul></li><li><em><strong>binary</strong></em> (required), <em><strong>binary-arch</strong></em> (required), <em><strong>binary-indep</strong></em> (required)：<ul><li><em><strong>binary</strong></em>：该阶段必须是用户从此源代码包生成二进制包所需的全部内容。它分为两个部分：binary-arch用于生成特定架构的二进制包，binary-indep用于生成其他类型的二进制包</li><li><em><strong>binary-*</strong></em> 阶段都应该依赖于 build 阶段或适当的 build-arch 或 build-indep 阶段，以便在没有构建该软件包时构建它。然后使用 dpkg-gencontrol 创建其控制文件以及<code>dpkg-deb</code> 构建成一个二进制包，并将它们放置在顶级目录的父目录中（即你执行构建的目录的上级），以创建相应的二进制包。</li><li><em><strong>binary-arch</strong></em> 和 <em><strong>binary-indep</strong></em> 两个阶段必须要存在。如果其中一个阶段无事可做（如果源代码仅生成单个二进制包，无论是否架构相关，始终是如此），它仍必须存在并始终成功。</li><li>根据Rules-Requires-Root字段的值的配置，binary阶段可能需要作为root用户调用。</li></ul></li><li><em><strong>clean</strong></em> (required)：该阶段将撤消 <em><strong>build</strong></em> 和 <em><strong>binary</strong></em> 阶段可能产生的所有效果，除了它应该保留在上次运行 <em><strong>binary</strong></em> 阶段时在父目录中创建的任何输出文件。</li><li><em><strong>patch</strong></em> (optional)：此阶段执行所需的任何其他操作，以使源代码包准备好进行编辑（解包其他上游归档文件、应用补丁等）</li></ul><p>这些阶段执行构建的工作目录，与deb包的工作目录不同，他的工作目录为当前目录作为包的根目录来使用，有一点需要注意的是，这里的架构的觉得为 dpkg-architecture 命令决定的，在不同架构机器上构建则为不同的架构的包</p><h3 id=工作目录>工作目录<a hidden class=anchor aria-hidden=true href=#工作目录>#</a></h3><p>在构建deb软件包（.deb文件）时，通常需要将软件包的文件和目录安排在特定的文件目录中，这个特定目录就是打包时的工作目录，通过上面的解释，已知，deb包分为两种 <font color=#f8070d size=3>源代码包</font> 和 <font color=#f8070d size=3>二进制包</font>，而两中类型的工作目录不相同。</p><p>例如，我们需要构建一个源码软件包，假设为要为一个nginx制作 deb包，那么他的工作目录则为 debian，而control 文件 和 rule 文件则是必须的，<font color=#f8070d size=3>封包的内容目录</font> 则为控制文件中 <code>Package</code> 配置的名字，这里配置的为 nginx，那么这个deb包封包时寻找的内容则为 <code>debian/nginx</code></p><p>在例如，我们需要构建一个二进制软件包，那么他的工作目录为<code> DEBIAN</code>，control文件与 changelog 则是必须的，而<font color=#f8070d size=3>封包的内容目录</font> 当前目录，也就是 <code>DEBIAN</code>，制作时的控制文件这些不会被封入包中</p><p><strong>那么完整的制作流程为</strong>：</p><ul><li>在源代码目录下创建一个名为nginx的子目录 <code>mkdir debian</code></li><li>在nginx目录下创建名为 <code>DEBIAN</code> 的子目录，包含 <code>control</code> 文件，在<code>DEBIAN</code>目录中包含<code>control</code>文件是必须的，因为它是软件包元数据的中心存储库。</li><li>例如我们编译完的内容，nginx 的配置文件在 /etc/下，那么这个 etc 则在 nginx 子目录下</li><li>在工作目录下创建 rules 文件，这里面写明了构建的命令，例如：<ul><li><code>build</code>：这个部分用于执行编译和构建软件的命令。</li><li><code>clean</code>：这个部分用于清除编译输出，以便你可以重新构建软件包。</li><li><code>install</code>：这个部分指定了如何将软件安装到目标系统中。</li><li><code>binary</code>：这个部分用于在 Debian 软件包中打包二进制文件。</li></ul></li><li>其中该结构中还包含一些钩子脚本文件 <code>debian/p*</code> 而这个 <code>p*</code> 文件的命名是固定的。下面是一些常见的 <code>p*</code> 文件名：<ul><li><code>debian/package.install</code>：定义软件包中需要安装的文件和目录。</li><li><code>debian/package.manpages</code>：将软件包中的 man 页面添加到 man 手册中。</li><li><code>debian/package.docs</code>：将软件包中的文档添加到系统上的 <code>/usr/share/doc</code> 目录。</li><li><code>debian/package.preinst</code>：在软件包安装前执行的脚本。</li><li><code>debian/package.postinst</code>：在软件包安装后执行的脚本。</li><li><code>debian/package.prerm</code>：在软件包卸载前执行的脚本。</li><li><code>debian/package.postrm</code>：在软件包卸载后执行的脚本。</li></ul></li></ul><h2 id=实战从0构建一个-deb-包>实战：从0构建一个 deb 包<a hidden class=anchor aria-hidden=true href=#实战从0构建一个-deb-包>#</a></h2><h3 id=准备条件>准备条件<a hidden class=anchor aria-hidden=true href=#准备条件>#</a></h3><p>上面介绍的为deb包的一些基础，作为实战的一些理论知识，下面将以nginx为代表将其制作为deb包；通过前面知识了解到，deb包分为 <font color=#f8070d size=3>源代码包</font> 和 <font color=#f8070d size=3>二进制包</font>，那么nginx明显为源代码包，我们就需要按照 源代码包 =》二进制包 这种顺序依次定义，而 debian 提供了一系列的命令可以帮助生成这些文件，我们只需要改写具体的逻辑就可以完成包的制作，如 <code>dh_make</code> , <code>dh_install</code> 等命令。</p><p>对于 deb 包的标准，debian 官方有一些列的教程，称为 <em><strong>Debian Policy Manual</strong></em> <sup><a id=4>[4]</a></sup> ，可以通过这个手册，整个deb包中所需的一些理论知识，控制文件，维护脚本，包间的依赖关系，共享库等进行详细的说明</p><h3 id=dh工具>dh工具<a hidden class=anchor aria-hidden=true href=#dh工具>#</a></h3><p>dh <sup><a id=6>[6]</a></sup>（Debhelper）工具是Debian中自带的一个构建deb包的工具集。dh工具包含了一系列的脚本，用于从打包的源代码中自动化生成debian目录下的文件。这些脚本是 <code>debian/rules</code> 文件中的一部分，它们负责处理诸如构建、安装、打包、删除等任务。</p><p>dh工具包括多个命令及其选项，更多的 dh 工具可以参考官方</p><table><thead><tr><th>命令</th><th>说明</th></tr></thead><tbody><tr><td>dh_make</td><td>创建一个基本的在deb包打包时的工作框架</td></tr><tr><td>dh_auto_configure</td><td>自动运行 <code>configure</code> 脚本以生成 <code>Makefile</code></td></tr><tr><td>dh_install</td><td>将文件复制到正确的deb包的构建目录中，一些常见选项：<br><code>-s</code> 或 <code>--sourcedir=</code>: 指定源代码目录；<br><code>-X</code> 或 <code>--exclude</code>: 排除在安装中不必要的文件；<br><code>-n</code> 或 <code>--noscripts</code>: 在安装软件包时不运行脚本；<br><code>-Z</code>: 表示安装的文件不要在规则中注册；</td></tr><tr><td>dh_builddeb</td><td>以 <code>.deb</code> 文件格式构建软件包</td></tr><tr><td>dh_clean</td><td>清理debian目录和生成的文件，以确保它们不会在构建时对结果造成影响。</td></tr><tr><td>dh_gencontrol</td><td>生产和安装control文件</td></tr><tr><td>dh_installsystemd</td><td>安装systemd单元文件</td></tr></tbody></table><h4 id=dh_make>dh_make<a hidden class=anchor aria-hidden=true href=#dh_make>#</a></h4><p><code>dh_make</code> 命令是一个用于快速创建 deb 包的命令行工具。它可以根据用户提供的基本信息和软件包源代码自动创建 deb 包的基础结构，包括 <code>debian/</code> 目录和相关文件，如 <code>control</code>、<code>rules</code> 以及 <code>changelog</code> 等文件。DH 表示 Debian 包含 debhelper 建议的目录和文件结构。</p><p>在默认情况下，<code>dh_make</code> 命令是交互式的，它会提示你输入一些必要的软件包信息，如软件包名称、版本号、作者、软件许可证等。如果你想非交互方式运行 <code>dh_make</code> 命令，并指定软件包信息，则可以使用 <code>-s</code> 选项。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ dh_make -s --createorig -f ../<span class=o>{</span>some_package-1.2.3<span class=o>}</span>.tar.gz -p <span class=o>{</span>some_package_1.2.3-1<span class=o>}</span>.deb</span></span></code></pre></td></tr></table></div></div></div></div><p>在上述命令中，<code>-s</code> 选项表示以非交互方式运行 <code>dh_make</code> 命令，并将软件包的基本信息作为参数指定。<code>--createorig</code> 选项表示我们想要创建一个原始的源代码包，<code>-f</code> 选项指定软件包源代码的文件名和路径，<code>-p</code> 选项指定要创建的 Debian 软件包的名称和版本号。</p><p>而上述命令会提示输入一些基本的详细信息，以便在 <code>debian/control</code> 控制文件中为软件包设置元数据。dh_make 会询问输入软件包的名称、版本、描述、组件、维护人员等信息，是否以这些参数作为构建，如果不需要这部确认可以使用 <code>-y</code> 默认同意</p><p>下面是通过 <code>dh_make</code> 构建出的在构建deb包的工作目录，这种方式下可以很明了的理解deb包的结构</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ tree debian/
</span></span><span class=line><span class=cl>debian/
</span></span><span class=line><span class=cl>├── changelog
</span></span><span class=line><span class=cl>├── control
</span></span><span class=line><span class=cl>├── copyright
</span></span><span class=line><span class=cl>├── manpage.1.ex
</span></span><span class=line><span class=cl>├── manpage.sgml.ex
</span></span><span class=line><span class=cl>├── manpage.xml.ex
</span></span><span class=line><span class=cl>├── nginx.cron.d.ex
</span></span><span class=line><span class=cl>├── nginx.doc-base.EX
</span></span><span class=line><span class=cl>├── nginx-docs.docs
</span></span><span class=line><span class=cl>├── postinst.ex
</span></span><span class=line><span class=cl>├── postrm.ex
</span></span><span class=line><span class=cl>├── preinst.ex
</span></span><span class=line><span class=cl>├── prerm.ex
</span></span><span class=line><span class=cl>├── README.Debian
</span></span><span class=line><span class=cl>├── README.source
</span></span><span class=line><span class=cl>├── rules
</span></span><span class=line><span class=cl>├── salsa-ci.yml.ex
</span></span><span class=line><span class=cl>├── <span class=nb>source</span>
</span></span><span class=line><span class=cl>│   └── format
</span></span><span class=line><span class=cl>└── watch.ex</span></span></code></pre></td></tr></table></div></div></div></div><p>到这里，我们就完成了一个源码包的前提条件的构建，只需要稍微修改控制文件即可，进行后续的二进制包的构建。</p><p>这里最终的 控制文件 如下所示：</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>conf</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><pre tabindex=0><code class=language-conf data-lang=conf># 源代码控制文件
Source: nginx
Maintainer: root &lt;root@debian-template&gt;
Section: comm
Priority: optional
Homepage: https://nginx.org

# 二进制控制文件
Package: nginx-d
Version: 1.22.1
Architecture: amd64
Standards-Version: 1.0.0
Build-Depends: debhelper-compat (= 13)
Description: Nginx HTTP server Nginx (&#34;engine x&#34;) is a web server created by Igor Sysoev. It is known for its high performance, stability, and low resource consumption.</code></pre></div></div><h3 id=准备rules文件>准备rules文件<a hidden class=anchor aria-hidden=true href=#准备rules文件>#</a></h3><p>通过上面的rules文件部分介绍，了解到 rules 文件就是一个 Makefile，并且包含三个阶段</p><ul><li><p><strong>clean</strong> &ndash; 删除所有build与binary阶段产生的内容</p></li><li><p><strong>build</strong> &ndash; 编译与构建的步骤</p></li><li><p><strong>binary</strong> &ndash; binary阶段将创建deb包的root目录，这个目录被包含在 <code>debian</code> 目录下，而目录名则为 control 文件中配置的 <code>Package</code> 名字，即 <code>debian/&lt;source package name></code></p></li></ul><p>这些阶段都通过 <code>dpkg-buildpackage</code> 在构建时被执行，一个rules文件的模板如下</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>makefile</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=c>#!/usr/bin/make -f
</span></span></span><span class=line><span class=cl><span class=c></span>
</span></span><span class=line><span class=cl><span class=nf>clean</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	@# Do nothing
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>build</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	@# Do nothing
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>binary</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	@# Do nothing
</span></span><span class=line><span class=cl>	dh_gencontrol
</span></span><span class=line><span class=cl>	dh_builddeb
</span></span></code></pre></td></tr></table></div></div></div></div><p>那这个 nginx 的 rules 文件则为下述所示：</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>make</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-make data-lang=make><span class=line><span class=cl><span class=c>#!/usr/bin/make -f
</span></span></span><span class=line><span class=cl><span class=c></span>
</span></span><span class=line><span class=cl><span class=c># 列出您要編譯的檔案和目錄
</span></span></span><span class=line><span class=cl><span class=c></span><span class=k>export </span><span class=nv>DH_VERBOSE</span><span class=o>=</span><span class=m>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>PACKAGE</span><span class=o>=</span>nginx
</span></span><span class=line><span class=cl><span class=nv>UPSTREAM_VERSION</span><span class=o>=</span>1.22.1
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># 設置打包的參數
</span></span></span><span class=line><span class=cl><span class=c></span><span class=k>export </span><span class=nv>DEB_BUILD_MAINT_OPTIONS</span> <span class=o>=</span> <span class=nv>hardening</span><span class=o>=</span>+all
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>export </span><span class=nv>BUILDDIR_WORK</span> <span class=o>=</span> <span class=k>$(</span>CURDIR<span class=k>)</span>/debian/<span class=k>$(</span>PACKAGE<span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>export </span><span class=nv>BUILDDIR</span><span class=o>=</span><span class=k>$(</span>CURDIR<span class=k>)</span>/debian/tmp
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># 定義建立目錄，它會在${CURDIR}/debian/$PACKAGE下創建
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nf>debian/$PACKAGE</span><span class=o>::</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>%</span><span class=o>:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># build阶段，将完成软件的编译
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nf>build</span><span class=o>:</span> 
</span></span><span class=line><span class=cl>	tar zxf nginx-<span class=k>$(</span>UPSTREAM_VERSION<span class=k>)</span>.tar.gz
</span></span><span class=line><span class=cl>	<span class=c1># 配置 Nginx 以使用必要的模塊和參數</span>
</span></span><span class=line><span class=cl>	<span class=nb>cd</span> nginx-<span class=k>$(</span>UPSTREAM_VERSION<span class=k>)</span> <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	    ./configure <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	    --conf-path<span class=o>=</span>/etc/nginx/nginx.conf <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	    --pid-path<span class=o>=</span>/var/run/nginx <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	    --sbin-path<span class=o>=</span>/usr/sbin/nginx <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	    --http-log-path<span class=o>=</span>/var/log/nginx/error.log <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	    --error-log-path<span class=o>=</span>/var/log/nginx/access.log <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	    --http-client-body-temp-path<span class=o>=</span>/etc/nginx/ <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>		--http-proxy-temp-path<span class=o>=</span>/var/run/nginx/ <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>		--http-fastcgi-temp-path<span class=o>=</span>/var/run/nginx/ <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>		--http-uwsgi-temp-path<span class=o>=</span>/var/run/nginx/ <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>		--http-scgi-temp-path<span class=o>=</span>/var/run/nginx/ <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>		--pid-path<span class=o>=</span>/var/run/nginx/nginx.pid <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>        --with-http_ssl_module <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>		--without-http_gzip_module 
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=nb>cd</span> nginx-<span class=k>$(</span>UPSTREAM_VERSION<span class=k>)</span> <span class=o>&amp;&amp;</span> make
</span></span><span class=line><span class=cl>	<span class=c1># 这里存在一个问题，即 prefix 与 DESTDIR 不要同时写，make install 被安装在哪里</span>
</span></span><span class=line><span class=cl>	<span class=c1># 如果配置了prefix 那么则被安装在 prefix/DESTDIR 变成了双重目录</span>
</span></span><span class=line><span class=cl>	<span class=c1># 这里不配置 prefix 只配置DESTDIR则会被安装在 deb 包在构建时的工作目录，这里制定了$(BUILDDIR)</span>
</span></span><span class=line><span class=cl>	<span class=c1># 将被放置在 $(BUILDDIR)</span>
</span></span><span class=line><span class=cl>	<span class=nb>cd</span> nginx-<span class=k>$(</span>UPSTREAM_VERSION<span class=k>)</span> <span class=o>&amp;&amp;</span> make install <span class=nv>DESTDIR</span><span class=o>=</span><span class=k>$(</span>BUILDDIR<span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1># 清理</span>
</span></span><span class=line><span class=cl>	rm -rf nginx-<span class=k>$(</span>UPSTREAM_VERSION<span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>clean</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	rm -rf nginx-<span class=k>$(</span>UPSTREAM_VERSION<span class=k>)</span>
</span></span><span class=line><span class=cl>	rm -rf <span class=k>$(</span>BUILDDIR<span class=k>)</span>
</span></span><span class=line><span class=cl>	rm -rf <span class=k>$(</span>BUILDDIR_WORK<span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>build-indep</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	<span class=c1># 构建前测试目录</span>
</span></span><span class=line><span class=cl>	dh_testdir
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>build-arch</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	dh_testdir
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>binary-indep</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	dh_testdir
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=c1># 测试是否有root权限</span>
</span></span><span class=line><span class=cl>	dh_testroot
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=c1># 在 binary 阶段中，执行的安装操作，创建 /etc/nginx目录</span>
</span></span><span class=line><span class=cl>	<span class=c1># 这些命令执行的是 install -d</span>
</span></span><span class=line><span class=cl>	<span class=c1># 为什么使用 dh tool 而不用install，因为dh tool是rules file的一部分，也就是他默认的工作目录是</span>
</span></span><span class=line><span class=cl>	<span class=c1># 构建deb包的工作目录，这里必须是相对目录</span>
</span></span><span class=line><span class=cl>	<span class=c1># 而对于第一个的 &#34;/&#34; 与 最后一个 &#34;/&#34; 都不要写，会被自动除虫上</span>
</span></span><span class=line><span class=cl>	dh_installdirs etc/nginx
</span></span><span class=line><span class=cl>	dh_installdirs var/log/nginx
</span></span><span class=line><span class=cl>	dh_installdirs var/run/nginx
</span></span><span class=line><span class=cl>	dh_install etc/nginx/* etc/nginx
</span></span><span class=line><span class=cl>	dh_install usr/sbin/* usr/sbin
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=c1># 这里创建了二进制包的目录结构</span>
</span></span><span class=line><span class=cl>	install -d <span class=k>$(</span>BUILDDIR_WORK<span class=k>)</span>/DEBIAN
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=c1># dh_gencontrol可以根据源码包的配置来生成二进制包的control文件</span>
</span></span><span class=line><span class=cl>	<span class=c1># 底层封装的是 dh_gencontrol -O --file --package=nginx 为二进制包生成</span>
</span></span><span class=line><span class=cl>	dh_gencontrol -O --file --package<span class=o>=</span><span class=k>$(</span>PACKAGE<span class=k>)</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=c1># dh_installchangelogs 可以根据源码包中的changelog来生成二进制包的changelog</span>
</span></span><span class=line><span class=cl>	<span class=c1># changelog 和 control file是二进制包必须的文件</span>
</span></span><span class=line><span class=cl>	<span class=c1># dh_gencontrol -O --file --package=nginx</span>
</span></span><span class=line><span class=cl>	<span class=c1># 底层执行的为在 deb 包根目录的/usr/share/doc/nginx 中生成changelog</span>
</span></span><span class=line><span class=cl>	<span class=c1># dh_installchangelogs</span>
</span></span><span class=line><span class=cl>	<span class=c1>#    install -d debian/nginx/usr/share/doc/nginx</span>
</span></span><span class=line><span class=cl>	<span class=c1>#    install -p -m0644 debian/changelog debian/nginx/usr/share/doc/nginx/changelog.Debian</span>
</span></span><span class=line><span class=cl>	dh_installchangelogs
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=c1># 这里将修复链接路径及压缩，如果你的一些软连接需要修复时可以使用</span>
</span></span><span class=line><span class=cl>	dh_compress
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>binary</span><span class=o>:</span> <span class=n>binary</span>-<span class=n>indep</span>
</span></span><span class=line><span class=cl>	<span class=c1># dh_builddeb命令将会构建一个二进制包</span>
</span></span><span class=line><span class=cl>	<span class=c1># dh_builddeb封装的时dpkg-deb命令</span>
</span></span><span class=line><span class=cl>	<span class=c1>#   dpkg-deb --build debian/nginx ..</span>
</span></span><span class=line><span class=cl>	dh_builddeb
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>.PHONY</span><span class=o>:</span> <span class=n>clean</span> <span class=n>binary</span>-<span class=n>indep</span> <span class=n>binary</span>-<span class=n>arch</span> <span class=n>binary</span> <span class=n>install</span> <span class=n>build</span></span></span></code></pre></td></tr></table></div></div></div></div><h3 id=执行构建>执行构建<a hidden class=anchor aria-hidden=true href=#执行构建>#</a></h3><p>通过执行 <code>dpkg-buildpackage -b</code> 来构建二进制源码包</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>log</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><pre tabindex=0><code class=language-log data-lang=log>	install -d debian/nginx/usr/sbin
	cp --reflink=auto -a debian/tmp/usr/sbin/nginx debian/nginx/usr/sbin/
install -d /root/nginx/debian/nginx/DEBIAN
dh_gencontrol -O --file --package=nginx
	dpkg-gencontrol -pnginx -ldebian/changelog -Tdebian/nginx.substvars -Pdebian/nginx
dpkg-gencontrol: warning: unknown information field &#39;Version&#39; in input data in package&#39;s section of control info file
dpkg-gencontrol: warning: unknown information field &#39;Standards-Version&#39; in input data in package&#39;s section of control info file
	chmod 0644 -- debian/nginx/DEBIAN/control
	chown 0:0 -- debian/nginx/DEBIAN/control
dh_installchangelogs
	install -d debian/nginx/usr/share/doc/nginx
	install -p -m0644 debian/changelog debian/nginx/usr/share/doc/nginx/changelog.Debian
dh_compress
	cd debian/nginx
	chmod a-x usr/share/doc/nginx/changelog.Debian
	gzip -9nf usr/share/doc/nginx/changelog.Debian
	cd &#39;/root/nginx&#39;
dh_builddeb
	dpkg-deb --build debian/nginx ..
dpkg-deb: building package &#39;nginx&#39; in &#39;../nginx_1.22.1-1_amd64.deb&#39;.
 dpkg-genbuildinfo --build=binary
 dpkg-genchanges --build=binary &gt;../nginx_1.22.1-1_amd64.changes
dpkg-genchanges: warning: unknown information field &#39;Version&#39; in input data in package&#39;s section of control info file
dpkg-genchanges: warning: unknown information field &#39;Standards-Version&#39; in input data in package&#39;s section of control info file
dpkg-genchanges: warning: unknown information field &#39;Build-Depends&#39; in input data in package&#39;s section of control info file
dpkg-genchanges: info: binary-only upload (no source code included)
 dpkg-source --after-build .
dpkg-source: warning: unknown information field &#39;Version&#39; in input data in package&#39;s section of control info file
dpkg-source: warning: unknown information field &#39;Standards-Version&#39; in input data in package&#39;s section of control info file
dpkg-source: warning: unknown information field &#39;Build-Depends&#39; in input data in package&#39;s section of control info file
dpkg-buildpackage: info: binary-only upload (no source included)</code></pre></div></div><p>构建完成后，生成的deb包在当前执行命令的父目录中，而生成的文件名遵守了 <code>&lt;name>_&lt;version>-&lt;revision>_&lt;architecture>.deb</code> 这种格式</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ dpkg -c ../nginx_1.22.1-1_amd64.deb
</span></span><span class=line><span class=cl>./
</span></span><span class=line><span class=cl>./etc/
</span></span><span class=line><span class=cl>./etc/nginx/
</span></span><span class=line><span class=cl>./etc/nginx/fastcgi.conf
</span></span><span class=line><span class=cl>./etc/nginx/fastcgi.conf.default
</span></span><span class=line><span class=cl>./etc/nginx/fastcgi_params
</span></span><span class=line><span class=cl>./etc/nginx/fastcgi_params.default
</span></span><span class=line><span class=cl>./etc/nginx/koi-utf
</span></span><span class=line><span class=cl>./etc/nginx/koi-win
</span></span><span class=line><span class=cl>./etc/nginx/mime.types
</span></span><span class=line><span class=cl>./etc/nginx/mime.types.default
</span></span><span class=line><span class=cl>./etc/nginx/nginx.conf
</span></span><span class=line><span class=cl>./etc/nginx/nginx.conf.default
</span></span><span class=line><span class=cl>./etc/nginx/scgi_params
</span></span><span class=line><span class=cl>./etc/nginx/scgi_params.default
</span></span><span class=line><span class=cl>./etc/nginx/uwsgi_params
</span></span><span class=line><span class=cl>./etc/nginx/uwsgi_params.default
</span></span><span class=line><span class=cl>./etc/nginx/win-utf
</span></span><span class=line><span class=cl>./usr/
</span></span><span class=line><span class=cl>./usr/sbin/
</span></span><span class=line><span class=cl>./usr/sbin/nginx
</span></span><span class=line><span class=cl>./usr/share/
</span></span><span class=line><span class=cl>./usr/share/doc/
</span></span><span class=line><span class=cl>./usr/share/doc/nginx/
</span></span><span class=line><span class=cl>./usr/share/doc/nginx/changelog.Debian.gz
</span></span><span class=line><span class=cl>./var/
</span></span><span class=line><span class=cl>./var/log/
</span></span><span class=line><span class=cl>./var/log/nginx/
</span></span><span class=line><span class=cl>./var/run/
</span></span><span class=line><span class=cl>./var/run/nginx/</span></span></code></pre></td></tr></table></div></div></div></div><h2 id=troubleshooting>Troubleshooting<a hidden class=anchor aria-hidden=true href=#troubleshooting>#</a></h2><h3 id=no-upstream-tarball-found>no upstream tarball found<a hidden class=anchor aria-hidden=true href=#no-upstream-tarball-found>#</a></h3><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>text</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>dpkg-source: error: can&#39;t build with source format &#39;3.0 (quilt)&#39;: no upstream tarball found at ../nginx_1.22.1.orig.tar.{bz2,gz,lzma,xz}
</span></span><span class=line><span class=cl>dpkg-buildpackage: error: dpkg-source -b . subprocess returned exit status 2</span></span></code></pre></td></tr></table></div></div></div></div><p>解决：需要和你的构建目录 为上级即 <code>debian</code> 的上级</p><h3 id=non-native-package-version-does-not-contain-a-revision>non-native package version does not contain a revision<a hidden class=anchor aria-hidden=true href=#non-native-package-version-does-not-contain-a-revision>#</a></h3><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>text</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>dpkg-source: error: can&#39;t build with source format &#39;3.0 (quilt)&#39;: non-native package version does not contain a revision</span></span></code></pre></td></tr></table></div></div></div></div><p>解决：在changelog中定义正确的修订号</p><p>Debian 软件包版本号由三个部分组成：Major.Minor.Revision，它们通常定义在软件包的 debian/changelog 文件中。</p><p>在 debian/changelog 文件中，每个软件包版本都会记录下来，包括软件包的版本号、构建日期和构建者的姓名和电子邮件等信息，形成一个时间线。每个 Debian 软件包版本号应该遵循 X.Y.Z-r (或 X.Y.Z~rN) 的格式，其中 X.Y.Z 是软件包的版本号，r (或 N) 是软件包的修订号。</p><p>用于版本号的changelog文件通常位于软件包源代码的 debian/ 目录中。您可以打开 debian/changelog 文件，找到最近的条目，将其中的版本号中的修订号修改为所需的值，并保存文件。在对 Debian 软件包进行重新打包之前，请确保更新了 debian/changelog 文件，以便反映新版本号的修改。</p><p>需要注意的是，当您更改 debian/changelog 文件中的版本号时，请确保更新 debian/control 文件中的软件包版本依赖信息，以便与新的软件包版本号匹配。 这是为了确保软件包依赖关系与实际的软件包版本相匹配，避免在安装和使用软件包时出现问题。</p><h3 id=is-not-a-valid-version>is not a valid version<a hidden class=anchor aria-hidden=true href=#is-not-a-valid-version>#</a></h3><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>text</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>dpkg-genchanges: error:  is not a valid version</span></span></code></pre></td></tr></table></div></div></div></div><p>解决：这个问题是因为制定了 -v 重写了 version 配置，而没有指定具体的版本号</p><h3 id=yes-is-invalid-use-binary-targets-instead>&ldquo;yes&rdquo; is invalid; use &ldquo;binary-targets&rdquo; instead<a hidden class=anchor aria-hidden=true href=#yes-is-invalid-use-binary-targets-instead>#</a></h3><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>dpkg-buildpackage: error: Rules-Requires-Root field keyword <span class=s2>&#34;yes&#34;</span> is invalid<span class=p>;</span> use <span class=s2>&#34;binary-targets&#34;</span> instead</span></span></code></pre></td></tr></table></div></div></div></div><p>解决：control 文件的 <code>Rules-Requires-Root</code> 没有yes选项 <sup><a id=8>[8]</a></sup></p><h3 id=compatibility-levels-before-5-are-no-longer-supported-level-1-requested>Compatibility levels before 5 are no longer supported (level 1 requested)<a hidden class=anchor aria-hidden=true href=#compatibility-levels-before-5-are-no-longer-supported-level-1-requested>#</a></h3><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>dh: error: Compatibility levels before <span class=m>5</span> are no longer supported <span class=o>(</span>level <span class=m>1</span> requested<span class=o>)</span></span></span></code></pre></td></tr></table></div></div></div></div><p>这个错误提示是由于 Debian Policy 从 3.9.0 开始不再支持 compat level 4 以及更低级别的设置，需要使用符合 Debian Policy 3.9.0 或更高版本的规范定义包。</p><p>如果您在 <code>debian/control</code> 文件中设置了 compatibility level 较低的版本（如 3, 4），则会遇到这个错误。您需要将这个 compatibility level 提升至 5 或以上版本，即在 <code>debian/control</code> 文件中加入以下设置：</p><h3 id=unwanted-binary-file-debiandebiandeb>unwanted binary file: debian/debian.deb<a hidden class=anchor aria-hidden=true href=#unwanted-binary-file-debiandebiandeb>#</a></h3><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>dpkg-source: error: unwanted binary file: debian/debian.deb
</span></span><span class=line><span class=cl>dpkg-source: error: detected <span class=m>1</span> unwanted binary file <span class=o>(</span>add it in debian/source/include-binaries to allow its inclusion<span class=o>)</span>.
</span></span><span class=line><span class=cl>dpkg-buildpackage: error: dpkg-source -b . subprocess returned <span class=nb>exit</span> status <span class=m>255</span></span></span></code></pre></td></tr></table></div></div></div></div><p>解决：删除上级目录中多余文件即可</p><h3 id=cannot-represent-change-to-xauthority-binary-file-contents-changed>cannot represent change to .Xauthority: binary file contents changed<a hidden class=anchor aria-hidden=true href=#cannot-represent-change-to-xauthority-binary-file-contents-changed>#</a></h3><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>dpkg-source: error: cannot represent change to .Xauthority: binary file contents changed
</span></span><span class=line><span class=cl>dpkg-source: error: add .Xauthority in debian/source/include-binaries <span class=k>if</span> you want to store the modified binary in the debian tarball
</span></span><span class=line><span class=cl>dpkg-source: error: unrepresentable changes to source</span></span></code></pre></td></tr></table></div></div></div></div><p>解决：这是因为我直接在家目录操作的，家目录存在一些其他文件，如家目录下的隐藏文件</p><h2 id=reference>Reference<a hidden class=anchor aria-hidden=true href=#reference>#</a></h2><p><sup id=1>[1]</sup> <a href=https://www.debian.org/doc/debian-policy/ch-controlfields.html#rules-requires-root target=_blank rel="noopener nofollow noreferrer"><em>rules-requires-root</em></a></p><p><sup id=2>[2]</sup> <a href=https://www.debian.org/doc/debian-policy/ch-controlfields.html target=_blank rel="noopener nofollow noreferrer"><em>Control files and their fields</em></a></p><p><sup id=3>[3]</sup> <a href=https://zh.wikipedia.org/wiki/Ar_%28Unix%29 target=_blank rel="noopener nofollow noreferrer"><em>ar (Unix)</em></a></p><p><sup id=4>[4]</sup> <a href=https://www.debian.org/doc/debian-policy/index.html target=_blank rel="noopener nofollow noreferrer"><em>Debian Policy Manual</em></a></p><p><sup id=5>[5]</sup> <a href=https://www.debian.org/doc/debian-policy/ch-source.html#main-building-script-debian-rules target=_blank rel="noopener nofollow noreferrer"><em>Main building script</em></a></p><p><sup id=6>[6]</sup> <a href=https://man7.org/linux/man-pages/man7/debhelper.7.html target=_blank rel="noopener nofollow noreferrer"><em>debhelper(7)</em></a></p><p><sup id=7>[7]</sup> <a href=https://github.com/FooBarWidget/debian-packaging-for-the-modern-developer/blob/master/tutorial-2/README.md#debianrules target=_blank rel="noopener nofollow noreferrer"><em>Tutorial 2: building a binary package using dpkg-buildpackage</em></a></p><p><sup id=8>[8]</sup> <a href=https://www.debian.org/doc/debian-policy/ch-controlfields.html#rules-requires-root target=_blank rel="noopener nofollow noreferrer"><em>5.6.31. Rules-Requires-Root</em></a></p></div><div class=pe-copyright><hr><blockquote><p>本文为原创内容，版权归作者所有。如需转载，请在文章中声明本文标题及链接。</p><p>文章标题：Unix归档模式 Unix ar - 深入剖析与构建deb包</p><p>文章链接：<a href=http://localhost:1313/2023/03/deb-package/ target=_blank>http://localhost:1313/2023/03/deb-package/</a></p><p>许可协议：<a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></p></blockquote></div><div class=comments-separator></div><h3 class=relatedContentTitle>相关阅读</h3><ul class=relatedContent><li><a href=/2018/09/rpm-package/><span>Unix归档模式 cpio - 深入剖析与构建rpm包</span></a></li><li><a href=/2022/12/debian-update-kernel/><span>debian11更新内核版本</span></a></li><li><a href=/2022/05/debian11-install-tutorial/><span>安装Debian11 (bullseye) Step-by-Step</span></a></li><li><a href=/2016/12/fpm/><span>使用fpm制作rpm包与搭建本地yum源</span></a></li><li><a href=/2022/11/ipset-preformance/><span>ipset性能测试</span></a></li></ul><div class=comments-separator></div><footer class=post-footer><ul class=post-tags><li><a href=http://localhost:1313/tags/linux/>Linux</a></li><li><a href=http://localhost:1313/tags/debian/>Debian</a></li></ul><nav class=paginav><a class=prev href=http://localhost:1313/2023/04/delete-github-commit/><span class=title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left" style="user-select:text"><line x1="19" y1="12" x2="5" y2="12" style="user-select:text"/><polyline points="12 19 5 12 12 5" style="user-select:text"/></polyline></svg>&nbsp;</span>
<span>删除github上面的历史提交记录</span>
</a><a class=next href=http://localhost:1313/2023/03/alpine-network-tools/><span class=title></span>
<span>alpine安装网络工具&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right" style="user-select:text"><line x1="5" y1="12" x2="19" y2="12" style="user-select:text"/><polyline points="12 5 19 12 12 19" style="user-select:text"/></svg></span></a></nav></footer><div class=pe-comments-decoration><p class=pe-comments-title></p><p class=pe-comments-subtitle></p></div><div id=pe-comments></div><script src=/js/pe-go-comment.min.86a214102576ba5f9b7bdc29eed8d58dd56e34aef80b3c65c73ea9cc88443696.js integrity="sha256-hqIUECV2ul+be9wp7tjVjdVuNK74Czxlxz6pzIhENpY="></script><script>const getStoredTheme=()=>localStorage.getItem("pref-theme")==="dark"?"dark":"light",setGiscusTheme=()=>{const e=e=>{const t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:e},"https://giscus.app")};e({setConfig:{theme:getStoredTheme()}})};document.addEventListener("DOMContentLoaded",()=>{const s={src:"https://giscus.app/client.js","data-repo":"cylonchau/cylonchau.github.io","data-repo-id":"R_kgDOIRlNSQ","data-category":"Announcements","data-category-id":"DIC_kwDOIRlNSc4CXy1U","data-mapping":"pathname","data-term":"posts/deb package","data-strict":"0","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"top","data-theme":getStoredTheme(),"data-lang":"zh-TW","data-loading":"lazy",crossorigin:"anonymous",async:""},e=document.createElement("script");Object.entries(s).forEach(([t,n])=>e.setAttribute(t,n)),document.querySelector("#pe-comments").appendChild(e);const t=document.querySelector("#theme-toggle");t&&t.addEventListener("click",setGiscusTheme);const n=document.querySelector("#theme-toggle-float");n&&n.addEventListener("click",setGiscusTheme)})</script></article></main><footer class=footer><span>&copy; 2024 <a href=http://localhost:1313/>Cylon's Collection</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> on
<a href=https://pages.github.com/ rel=noopener target=_blank>GitHub Pages</a> & Theme
        <a href=https://github.com/tofuwine/PaperMod-PE rel=noopener target=_blank>PaperMod-PE</a></span></footer><div class=pe-right-sidebar><a href=javascript:void(0); id=theme-toggle-float class=pe-float-btn><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</a><a href=#top class=pe-float-btn id=top-link><span id=pe-read-progress></span></a></div><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>